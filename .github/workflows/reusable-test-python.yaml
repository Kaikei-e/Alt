name: Reusable Python Test Workflow

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
      python-version:
        required: false
        type: string
        default: "3.13"
      test-command:
        required: false
        type: string
        default: "pytest -v --cov=. --cov-report=xml --junit-xml=tests/results.xml"
      use-oidc:
        required: false
        type: boolean
        default: false
      use-local-persistent-cache:
        required: false
        type: boolean
        default: false
      upload-coverage:
        required: false
        type: boolean
        default: true
      coverage-flags:
        required: false
        type: string
        default: ""
      sparse-checkout:
        required: false
        type: string
        default: "tag-generator"
      job-type:
        required: false
        type: string
        default: "test"
        description: "Job type: test, lint, security, typecheck"

jobs:
  python-job:
    runs-on: self-hosted
    timeout-minutes: 30

    defaults:
      run:
        shell: bash

    env:
      UV_NO_CACHE_PRUNE: 1

    steps:
      - name: Configure logging (mask)
        if: runner.environment == 'self-hosted'
        run: |
          echo "::group::Masking Configuration"

          # Mask Runner Identity
          echo "::add-mask::$(hostname)"
          echo "::add-mask::$(whoami)"

          # Mask Absolute Paths
          [ -n "$HOME" ] && echo "::add-mask::$HOME"
          [ -n "$GITHUB_WORKSPACE" ] && echo "::add-mask::$GITHUB_WORKSPACE"
          [ -n "$RUNNER_TEMP" ] && echo "::add-mask::$RUNNER_TEMP"

          # Mask Git PII
          if command -v git >/dev/null 2>&1; then
            echo "::add-mask::$(git log -1 --pretty=format:'%an')"
            echo "::add-mask::$(git log -1 --pretty=format:'%ae')"
            echo "::add-mask::$(git log -1 --pretty=format:'%cn')"
            echo "::add-mask::$(git log -1 --pretty=format:'%ce')"
          fi

          echo "::endgroup::"

      - name: Pre-checkout cleanup
        if: runner.environment == 'self-hosted'
        uses: docker://alpine:latest
        with:
          entrypoint: /bin/sh
          args: -c "rm -rf /github/workspace/.claude && find /github/workspace -name '*.lock' -type f -delete 2>/dev/null; chown -R 1001:1001 /github/workspace 2>/dev/null || true"

      - name: Checkout (sparse)
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          clean: false
          sparse-checkout: |
            ${{ inputs.sparse-checkout }}
          sparse-checkout-cone-mode: true

      - name: Install uv (Rust-based tool)
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false

      - name: Set up Python with uv
        run: uv python install ${{ inputs.python-version }}

      # ===== キャッシュ戦略 =====
      # 1) ローカル永続キャッシュ（sudo不要でHOME配下に固定）
      # ジョブ固有のキャッシュディレクトリを使用して並行実行時の競合を回避
      - name: Configure local persistent caches (HOME)
        if: ${{ inputs.use-local-persistent-cache }}
        run: |
          CACHE_BASE="$HOME/.cache/uv-${{ inputs.job-type }}-${{ github.run_id }}"
          TOOL_BASE="$HOME/.local/share/uv-${{ inputs.job-type }}-${{ github.run_id }}"
          mkdir -p "$CACHE_BASE" "$TOOL_BASE"
          echo "UV_CACHE_DIR=$CACHE_BASE" >> "$GITHUB_ENV"
          echo "UV_TOOL_DIR=$TOOL_BASE" >> "$GITHUB_ENV"

      # 2) ランナーがエフェメラル等でHOME永続化できない場合は、GitHub Cacheを併用
      - name: Restore uv cache (GitHub Cache)
        if: ${{ !inputs.use-local-persistent-cache }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv-${{ inputs.job-type }}
            ~/.local/share/uv-${{ inputs.job-type }}
          key: uv-${{ runner.os }}-${{ inputs.job-type }}-${{ hashFiles(format('{0}/uv.lock', inputs.working-directory)) }}
          restore-keys: |
            uv-${{ runner.os }}-${{ inputs.job-type }}-

      - name: Configure uv cache (GitHub Cache mode)
        if: ${{ !inputs.use-local-persistent-cache }}
        run: |
          echo "UV_CACHE_DIR=$HOME/.cache/uv-${{ inputs.job-type }}" >> "$GITHUB_ENV"
          echo "UV_TOOL_DIR=$HOME/.local/share/uv-${{ inputs.job-type }}" >> "$GITHUB_ENV"

      - name: Sync project dependencies
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        run: |
          uv sync --all-extras --dev

      - name: Python env (diagnostics)
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        run: |
          uv python list
          echo "github.workspace=${{ github.workspace }}"
          ls -la "${{ github.workspace }}/${{ inputs.working-directory }}" || true

      # Job-specific actions based on job type
      - name: Run tests
        if: ${{ inputs.job-type == 'test' }}
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        env:
          SERVICE_NAME: ${{ inputs.coverage-flags }}-test
        run: uv run ${{ inputs.test-command }}

      - name: Run linting (ruff check)
        if: ${{ inputs.job-type == 'lint' }}
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        run: |
          uv run ruff check .
          uv run ruff format --check .

      - name: Run security scan (bandit)
        if: ${{ inputs.job-type == 'security' }}
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        run: uv run bandit -r . -f json -o bandit-report.json --exit-zero

      - name: Run type checking
        if: ${{ inputs.job-type == 'typecheck' }}
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        run: uv run pyright .

      - name: Cleanup (self-hosted)
        if: always() && runner.environment == 'self-hosted'
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        run: |
          rm -rf .venv .pytest_cache .coverage coverage.xml bandit-report.json
          # Clean job-specific uv cache directory
          if [ -n "$UV_CACHE_DIR" ] && [ -d "$UV_CACHE_DIR" ]; then
            echo "Removing job-specific uv cache: $UV_CACHE_DIR"
            rm -rf "$UV_CACHE_DIR" 2>/dev/null || true
          fi
          if [ -n "$UV_TOOL_DIR" ] && [ -d "$UV_TOOL_DIR" ]; then
            echo "Removing job-specific uv tool directory: $UV_TOOL_DIR"
            rm -rf "$UV_TOOL_DIR" 2>/dev/null || true
          fi
