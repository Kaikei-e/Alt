name: Reusable Python Test Workflow

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
      python-version:
        required: false
        type: string
        default: "3.13"
      test-command:
        required: false
        type: string
        default: "pytest -v --cov=. --cov-report=xml --junit-xml=tests/results.xml"
      use-oidc:
        required: false
        type: boolean
        default: false
      use-local-persistent-cache:
        required: false
        type: boolean
        default: false
      upload-coverage:
        required: false
        type: boolean
        default: true
      coverage-flags:
        required: false
        type: string
        default: ""
      sparse-checkout:
        required: false
        type: string
        default: "tag-generator"
      job-type:
        required: false
        type: string
        default: "test"
        description: "Job type: test, lint, security, typecheck"

jobs:
  python-job:
    runs-on: [self-hosted, linux, X64]
    timeout-minutes: 30

    defaults:
      run:
        shell: bash

    env:
      UV_NO_CACHE_PRUNE: 1

    steps:
      - name: Configure logging (mask)
        if: runner.environment == 'self-hosted'
        run: |
          echo "::group::Masking Configuration"
          # Mask HOME parts
          for part in $(echo "$HOME" | tr '/' ' '); do
            [ -n "$part" ] && echo "::add-mask::$part"
          done
          # Mask user/host (Linux用。macOSコマンドは一応エラー無視)
          echo "::add-mask::$(whoami)"
          echo "::add-mask::$(hostname)"
          echo "::add-mask::$(hostname -s || true)"
          (scutil --get ComputerName || true)    | xargs -I{} echo "::add-mask::{}"
          (scutil --get LocalHostName || true)   | xargs -I{} echo "::add-mask::{}"
          echo "::add-mask::${{ runner.temp }}"
          echo "::add-mask::${{ github.workspace }}"
          echo "::endgroup::"

      - name: Checkout (sparse)
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          sparse-checkout: |
            ${{ inputs.sparse-checkout }}
          sparse-checkout-cone-mode: true

      - name: Install uv (Rust-based tool)
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: "${{ inputs.working-directory }}/uv.lock"

      - name: Set up Python with uv
        run: uv python install ${{ inputs.python-version }}

      # ===== キャッシュ戦略 =====
      # 1) ローカル永続キャッシュ（sudo不要でHOME配下に固定）
      - name: Configure local persistent caches (HOME)
        if: ${{ inputs.use-local-persistent-cache }}
        run: |
          mkdir -p "$HOME/.cache/uv" "$HOME/.local/share/uv"
          echo "UV_CACHE_DIR=$HOME/.cache/uv" >> "$GITHUB_ENV"
          echo "UV_TOOL_DIR=$HOME/.local/share/uv" >> "$GITHUB_ENV"

      # 2) ランナーがエフェメラル等でHOME永続化できない場合は、GitHub Cacheを併用
      - name: Restore uv cache (GitHub Cache)
        if: ${{ !inputs.use-local-persistent-cache }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: uv-${{ runner.os }}-${{ hashFiles(format('{0}/uv.lock', inputs.working-directory)) }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Sync project dependencies
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        run: |
          uv sync --all-extras --dev

      - name: Python env (diagnostics)
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        run: |
          uv python list
          echo "github.workspace=${{ github.workspace }}"
          ls -la "${{ github.workspace }}/${{ inputs.working-directory }}" || true

      # Job-specific actions based on job type
      - name: Run tests
        if: ${{ inputs.job-type == 'test' }}
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        env:
          SERVICE_NAME: ${{ inputs.coverage-flags }}-test
        run: uv run ${{ inputs.test-command }}

      - name: Run linting (ruff check)
        if: ${{ inputs.job-type == 'lint' }}
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        run: |
          uv run ruff check .
          uv run ruff format --check .

      - name: Run security scan (bandit)
        if: ${{ inputs.job-type == 'security' }}
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        run: uv run bandit -r . -f json -o bandit-report.json --exit-zero

      - name: Run type checking
        if: ${{ inputs.job-type == 'typecheck' }}
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        run: uv run pyright .

      - name: Cleanup (self-hosted)
        if: always() && runner.environment == 'self-hosted'
        working-directory: ${{ github.workspace }}/${{ inputs.working-directory }}
        run: |
          rm -rf .venv .pytest_cache .coverage coverage.xml bandit-report.json
          if command -v uv >/dev/null 2>&1; then
            UV_CACHE_DIR="${UV_CACHE_DIR:-$HOME/.cache/uv}"
            # Disable automatic cache pruning to avoid "No such file or directory" errors
            export UV_NO_CACHE_PRUNE=1
            # Use safer cache cleanup method
            if [ -d "$UV_CACHE_DIR" ]; then
              echo "Cleaning uv cache directory: $UV_CACHE_DIR"
              # Remove only specific problematic subdirectories if they exist
              rm -rf "$UV_CACHE_DIR/sdists-v9" 2>/dev/null || true
              rm -rf "$UV_CACHE_DIR/wheels-v9" 2>/dev/null || true
              # Clean other cache contents safely
              find "$UV_CACHE_DIR" -type f -name "*.tmp" -delete 2>/dev/null || true
              find "$UV_CACHE_DIR" -type d -empty -delete 2>/dev/null || true
            fi
          fi
