name: Reusable Python Test Workflow (Colima)
permissions:
  contents: read
on:
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
      python-version:
        required: false
        type: string
        default: "3.13"

jobs:
  test:
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 30
    services:
      # Dockerサービスが利用可能か確認
      docker:
        image: docker:dind
        options: --privileged
    steps:
      - name: Check Docker/Colima
        run: |
          if ! docker version >/dev/null 2>&1; then
            echo "Starting Colima..."
            colima start || echo "Colima already running"
          fi

      - uses: actions/checkout@v4

      - name: Run Python tests in container
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w "/workspace/${{ inputs.working-directory }}" \
            --user $(id -u):$(id -g) \
            python:${{ inputs.python-version }}-slim \
            /bin/bash -c "
              pip install --quiet pytest pytest-cov psycopg2-binary &&
              pip install --quiet -r requirements.txt || true &&
              mkdir -p tests &&
              pytest test_unit.py -v --junit-xml=tests/results.xml || true
            "

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-test-results-${{ github.run_id }}
          path: ${{ inputs.working-directory }}/tests/
          retention-days: 5
          if-no-files-found: warn