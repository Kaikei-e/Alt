name: Reusable Go Quality Gates Workflow

permissions:
  contents: read
  security-events: write

on:
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
      go-version:
        required: false
        type: string
        default: "1.24"
      coverage-flags:
        required: false
        type: string
      run-security-audit:
        required: false
        type: boolean
        default: true
      build-artifact-name:
        required: false
        type: string
      build-artifact-path:
        required: false
        type: string

jobs:
  quality-check:
    name: Quality Gates
    runs-on: [self-hosted, linux, X64]
    timeout-minutes: 30
    env:
      # モジュール取得の安定化
      GOPROXY: "https://proxy.golang.org,direct"
      GOSUMDB: "sum.golang.org"
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Mask Configuration
        if: runner.environment == 'self-hosted'
        run: |
          echo "::group::Masking Configuration"
          for part in $(echo $HOME | tr '/' ' ' ); do
            [ -n "$part" ] && echo "::add-mask::$part"
          done
          echo "::endgroup::"

      - uses: actions/checkout@v4

      - name: Set up Go with module cache
        uses: actions/setup-go@v4
        with:
          go-version: ${{ inputs.go-version }}
          cache: "modules"

      - name: Speed up Go build & module cache
        uses: magnetikonline/action-golang-cache@v5
        with:
          go-version-file: go.mod

      - name: Lint code with golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v1.64.8
        # プリビルド済みアクションで高速実行かつGitHub注釈表示

      - name: Security scan with Gosec
        uses: securego/gosec@master
        with:
          args: '-fmt sarif -out gosec-results.sarif ./...'
        # SARIF 出力を GitHub コードスキャンに連携

      - name: Upload Gosec SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec-results.sarif

      - name: Vulnerability check with govulncheck
        uses: golang/govulncheck-action@v1
        with:
          go-version-input: ${{ inputs.go-version }}
        # 依存脆弱性の静的解析

      - name: Run tests with race detection
        run: go test -race ./...

      - name: Generate coverage report
        run: go test -coverprofile=coverage.out ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: coverage.out
          flags: ${{ inputs.coverage-flags }}
          name: ${{ inputs.coverage-flags }}-coverage
          verbose: false

      - name: Build application
        run: go build -v ./...

      - name: Upload build artifact
        if: ${{ inputs.build-artifact-name != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.build-artifact-name }}
          path: ${{ inputs.build-artifact-path }}
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          go clean -cache -modcache
          rm -rf ~/.cache/golangci* gosec-results.sarif coverage.out
