name: CodeQL (Go)

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - "alt-backend/**"
      - "pre-processor/**"
      - "pre-processor-sidecar/**"
      - "search-indexer/**"
      - "auth-hub/**"
  pull_request:
    branches: [main, master]
    paths:
      - "alt-backend/**"
      - "pre-processor/**"
      - "pre-processor-sidecar/**"
      - "search-indexer/**"
      - "auth-hub/**"
  schedule:
    - cron: "0 18 * * 5"

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  analyze-go:
    name: Analyze (Go)
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        language: ["go"]

    steps:
      - name: Get workspace parent GID
        if: runner.environment == 'self-hosted'
        id: get-gid
        run: echo "gid=$(stat -c '%g' "$GITHUB_WORKSPACE/..")" >> $GITHUB_OUTPUT

      - name: Pre-checkout cleanup
        if: runner.environment == 'self-hosted'
        uses: docker://alpine:latest
        env:
          RUNNERS_GID: ${{ steps.get-gid.outputs.gid }}
        with:
          entrypoint: /bin/sh
          # Docker runs as root to delete files and fix permissions for 'runners' group
          # chmod 2775 = setgid + rwxrwxr-x (group inherits, group writable)
          # See: https://github.com/actions/runner/issues/434
          args: -c "rm -rf /github/workspace/.git /github/workspace/* /github/workspace/.[!.]* 2>/dev/null; chgrp $RUNNERS_GID /github/workspace 2>/dev/null; chmod 2775 /github/workspace"

      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Mask sensitive paths and git information
        run: |
          echo "::group::Masking Configuration"

          # Mask Runner Identity
          echo "::add-mask::$(hostname)"
          echo "::add-mask::$(whoami)"

          # Mask Absolute Paths
          [ -n "$HOME" ] && echo "::add-mask::$HOME"
          [ -n "$GITHUB_WORKSPACE" ] && echo "::add-mask::$GITHUB_WORKSPACE"
          [ -n "$RUNNER_TEMP" ] && echo "::add-mask::$RUNNER_TEMP"

          # Mask Git PII
          if command -v git >/dev/null 2>&1; then
            echo "::add-mask::$(git log -1 --pretty=format:'%an')"
            echo "::add-mask::$(git log -1 --pretty=format:'%ae')"
            echo "::add-mask::$(git log -1 --pretty=format:'%cn')"
            echo "::add-mask::$(git log -1 --pretty=format:'%ce')"
          fi

          echo "::endgroup::"

      # CodeQL 実行前にディスクの空きを増やす
      - name: Free disk space before CodeQL
        run: |
          echo "Before cleanup:"
          df -h

          # 重いツール類があれば削除（存在チェック付き）
          if [ -d "/usr/share/dotnet" ]; then
            sudo rm -rf /usr/share/dotnet
          fi

          if [ -d "/usr/local/lib/android" ]; then
            sudo rm -rf /usr/local/lib/android
          fi

          if [ -d "/usr/local/share/boost" ]; then
            sudo rm -rf /usr/local/share/boost
          fi

          # Docker を使っている環境の場合、未使用リソースを削除
          if command -v docker >/dev/null 2>&1; then
            docker system prune -af || true
          fi

          echo "After cleanup:"
          df -h

      - name: Clear corrupted CodeQL toolcache
        if: runner.environment == 'self-hosted'
        run: |
          # Fix for libjli.so error - clear potentially corrupted CodeQL cache
          # See: https://github.com/github/codeql-action/issues/1082
          if [ -d "$RUNNER_TOOL_CACHE/CodeQL" ]; then
            echo "Clearing CodeQL toolcache at $RUNNER_TOOL_CACHE/CodeQL"
            rm -rf "$RUNNER_TOOL_CACHE/CodeQL"
          fi

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.0"
          check-latest: true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          # 解析対象をさらに絞りたい場合は、以下を調整してください
          # paths: alt-backend,pre-processor,pre-processor-sidecar,search-indexer,auth-hub
          # paths-ignore: tmp,dist,vendor

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"
