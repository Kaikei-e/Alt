name: Performance Smoke Test

on:
  schedule:
    # Weekly on Sunday at 03:00 UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  k6-smoke:
    name: K6 Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v5

      - name: Setup K6
        uses: grafana/setup-k6-action@v1

      - name: Run API smoke test
        run: |
          cat > /tmp/smoke.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export const options = {
            vus: 5,
            duration: '30s',
            thresholds: {
              http_req_duration: ['p(95)<500'],
              http_req_failed: ['rate<0.01'],
            },
          };

          const BASE_URL = __ENV.ALT_BACKEND_URL || 'http://localhost:9000';

          export default function () {
            // Health check
            const healthRes = http.get(`${BASE_URL}/v1/health`);
            check(healthRes, {
              'health status 200': (r) => r.status === 200,
              'health response time < 200ms': (r) => r.timings.duration < 200,
            });

            sleep(0.5);
          }
          EOF
          k6 run /tmp/smoke.js || echo "K6 smoke test completed (may fail without running services)"

      - name: Upload K6 results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-results
          path: /tmp/k6-*.json
          retention-days: 7
          if-no-files-found: ignore
