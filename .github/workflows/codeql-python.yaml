name: CodeQL (Python)

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - "tag-generator/**"
      - "recap-subworker/**"
      - "monitors/utilizer/**"
      - "news-creator/**"
      - "dashboard/**"
  pull_request:
    branches: [main, master]
    paths:
      - "tag-generator/**"
      - "recap-subworker/**"
      - "monitors/utilizer/**"
      - "news-creator/**"
      - "dashboard/**"

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  analyze-python:
    name: Analyze (Python)
    runs-on: self-hosted

    steps:
      - name: Pre-checkout cleanup
        run: |
          # Remove Claude Code artifacts
          sudo rm -rf "$GITHUB_WORKSPACE/.claude" 2>/dev/null || true
          # Remove stale git locks
          sudo find "$GITHUB_WORKSPACE" -name "*.lock" -type f -delete 2>/dev/null || true
          # Fix ownership for entire workspace
          sudo chown -R "$(id -u):$(id -g)" "$GITHUB_WORKSPACE" 2>/dev/null || true
        continue-on-error: true

      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Mask sensitive paths and git information
        run: |
          echo "::group::Masking Configuration"

          # Mask Runner Identity
          echo "::add-mask::$(hostname)"
          echo "::add-mask::$(whoami)"

          # Mask Absolute Paths
          [ -n "$HOME" ] && echo "::add-mask::$HOME"
          [ -n "$GITHUB_WORKSPACE" ] && echo "::add-mask::$GITHUB_WORKSPACE"
          [ -n "$RUNNER_TEMP" ] && echo "::add-mask::$RUNNER_TEMP"

          # Mask Git PII
          if command -v git >/dev/null 2>&1; then
            echo "::add-mask::$(git log -1 --pretty=format:'%an')"
            echo "::add-mask::$(git log -1 --pretty=format:'%ae')"
            echo "::add-mask::$(git log -1 --pretty=format:'%cn')"
            echo "::add-mask::$(git log -1 --pretty=format:'%ce')"
          fi

          echo "::endgroup::"

      - name: Free disk space before CodeQL
        run: |
          echo "Before cleanup:"
          df -h

          if [ -d "/usr/share/dotnet" ]; then
            sudo rm -rf /usr/share/dotnet
          fi

          if [ -d "/usr/local/lib/android" ]; then
            sudo rm -rf /usr/local/lib/android
          fi

          if [ -d "/usr/local/share/boost" ]; then
            sudo rm -rf /usr/local/share/boost
          fi

          if command -v docker >/dev/null 2>&1; then
            docker system prune -af || true
          fi

          echo "After cleanup:"
          df -h

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python
          # 解析対象をさらに絞りたい場合は、paths/paths-ignore を調整してください
          # paths: tag-generator,recap-subworker,monitors/utilizer,news-creator,dashboard
          # paths-ignore: tmp,dist,.venv

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:python"
