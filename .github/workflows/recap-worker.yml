name: Recap Worker CI

on:
  push:
    branches: [main, master]
    paths:
      - "recap-worker/**"
  pull_request:
    branches: [main, master]
    paths:
      - "recap-worker/**"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        shell: bash

    steps:
      - name: Get workspace parent GID
        if: runner.environment == 'self-hosted'
        id: get-gid
        run: echo "gid=$(stat -c '%g' "$GITHUB_WORKSPACE/..")" >> $GITHUB_OUTPUT

      - name: Pre-checkout cleanup
        if: runner.environment == 'self-hosted'
        uses: docker://alpine:latest
        env:
          RUNNERS_GID: ${{ steps.get-gid.outputs.gid }}
        with:
          entrypoint: /bin/sh
          # Docker runs as root to delete files and fix permissions for 'runners' group
          # chmod 2775 = setgid + rwxrwxr-x (group inherits, group writable)
          # See: https://github.com/actions/runner/issues/434
          args: -c "rm -rf /github/workspace/.git /github/workspace/* /github/workspace/.[!.]* 2>/dev/null; chgrp $RUNNERS_GID /github/workspace 2>/dev/null; chmod 2775 /github/workspace"

      - name: Checkout code
        uses: actions/checkout@v5

      - name: Configure logging (mask sensitive info)
        if: runner.environment == 'self-hosted'
        run: |
          echo "::group::Masking Configuration"

          # Mask Runner Identity
          echo "::add-mask::$(hostname)"
          echo "::add-mask::$(whoami)"

          # Mask Absolute Paths
          [ -n "$HOME" ] && echo "::add-mask::$HOME"
          [ -n "$GITHUB_WORKSPACE" ] && echo "::add-mask::$GITHUB_WORKSPACE"
          [ -n "$RUNNER_TEMP" ] && echo "::add-mask::$RUNNER_TEMP"

          # Mask Git PII (now available after checkout)
          if command -v git >/dev/null 2>&1; then
            echo "::add-mask::$(git log -1 --pretty=format:'%an' 2>/dev/null || echo '')"
            echo "::add-mask::$(git log -1 --pretty=format:'%ae' 2>/dev/null || echo '')"
            echo "::add-mask::$(git log -1 --pretty=format:'%cn' 2>/dev/null || echo '')"
            echo "::add-mask::$(git log -1 --pretty=format:'%ce' 2>/dev/null || echo '')"
          fi

          echo "::endgroup::"

      - name: Clean workspace and clear caches
        if: runner.environment == 'self-hosted'
        run: |
          echo "::group::Clearing caches"
          # Clean Cargo registry and git cache before restoring cache
          rm -rf ~/.cargo/registry || true
          rm -rf ~/.cargo/git || true
          # Clean workspace target directory
          rm -rf recap-worker/recap-worker/target || true
          echo "::endgroup::"

      # GitHub-hosted runner: dtolnay/rust-toolchain を使用
      - name: Install Rust toolchain (GitHub-hosted)
        if: runner.environment != 'self-hosted'
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy

      # Self-hosted runner: 既存のスクリプトでインストール
      - name: Install Rust toolchain (self-hosted)
        if: runner.environment == 'self-hosted'
        run: |
          set -e  # Exit on error
          # Clean rustup directory to avoid download/rename issues
          rm -rf ~/.rustup || true
          rm -rf ~/.cargo || true
          # Use official rustup (actions-rs is deprecated)
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain=stable --profile=minimal --no-modify-path
          # Add cargo to PATH
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          # Verify installation
          "$HOME/.cargo/bin/rustup" --version
          "$HOME/.cargo/bin/cargo" --version
          # Set default toolchain and add clippy
          "$HOME/.cargo/bin/rustup" default stable
          "$HOME/.cargo/bin/rustup" component add clippy

      # GitHub-hosted runner: Swatinem/rust-cache を使用
      - name: Cache Rust dependencies (GitHub-hosted)
        if: runner.environment != 'self-hosted'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: recap-worker/recap-worker
          shared-key: recap-worker
          cache-on-failure: true

      - name: Rust version info
        run: |
          rustc --version
          cargo --version
          cargo clippy --version

      - name: Run clippy
        working-directory: recap-worker/recap-worker
        run: |
          cargo clippy --all-targets --all-features -- -D warnings
        continue-on-error: false

      - name: Run unit tests
        working-directory: recap-worker/recap-worker
        run: |
          cargo test --all --verbose -- --nocapture
        env:
          RUST_BACKTRACE: full

      - name: Post-job cleanup
        if: always() && runner.environment == 'self-hosted'
        working-directory: recap-worker/recap-worker
        run: |
          # Clean build artifacts to reduce disk usage
          cargo clean || true
