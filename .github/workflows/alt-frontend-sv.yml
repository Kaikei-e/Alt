name: Alt Frontend SV Tests

permissions:
  contents: read

on:
  push:
    branches: [ main ]
    paths:
      - 'alt-frontend-sv/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'alt-frontend-sv/**'
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
      node-version:
        required: false
        type: string
        default: "24"
      pnpm-version:
        required: false
        type: string
        default: "10"
      test-type:
        required: false
        type: string
        default: "playwright"
  workflow_dispatch:
    inputs:
      working-directory:
        description: "Working directory for the test"
        required: true
        type: string
        default: "alt-frontend-sv"
      node-version:
        description: "Node.js version to use"
        required: false
        type: string
        default: "24"
      pnpm-version:
        description: "pnpm version to use"
        required: false
        type: string
        default: "10"
      test-type:
        description: "Type of test to run"
        required: false
        type: string
        default: "playwright"

jobs:
  test:
    timeout-minutes: 60
    runs-on: self-hosted

    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy

    env:
      CI: true
      FORCE_COLOR: "1"
      PLAYWRIGHT_SKIP_GIT_INFO: "1"

    steps:
      - name: Pre-checkout cleanup
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:${{ github.workspace }}" \
            alpine sh -c "rm -rf '${{ github.workspace }}'/* '${{ github.workspace }}'/.* 2>/dev/null || true"

      - uses: actions/checkout@v5
        with:
          clean: false

      - name: Mask sensitive paths and git information
        run: |
          echo "::group::Masking Configuration"

          # Mask Runner Identity
          echo "::add-mask::$(hostname)"
          echo "::add-mask::$(whoami)"

          # Mask Absolute Paths
          # Best Practice: Mask full paths instead of components to avoid masking common words like 'home' or 'opt'
          [ -n "$HOME" ] && echo "::add-mask::$HOME"
          [ -n "$GITHUB_WORKSPACE" ] && echo "::add-mask::$GITHUB_WORKSPACE"
          [ -n "$RUNNER_TEMP" ] && echo "::add-mask::$RUNNER_TEMP"

          # Mask Git PII (Personal Identifiable Information)
          if command -v git >/dev/null 2>&1; then
            echo "::add-mask::$(git log -1 --pretty=format:'%an')"
            echo "::add-mask::$(git log -1 --pretty=format:'%ae')"
            echo "::add-mask::$(git log -1 --pretty=format:'%cn')"
            echo "::add-mask::$(git log -1 --pretty=format:'%ce')"
          fi

          echo "::endgroup::"


      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version || '24' }}

      - name: Install unzip
        run: apt-get update && apt-get install -y unzip

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
        working-directory: ${{ inputs.working-directory || 'alt-frontend-sv' }}
      - name: Run Playwright tests
        run: npx playwright test --project=auth --project=desktop-chromium --project=mobile-chrome --reporter=list
        working-directory: ${{ inputs.working-directory || 'alt-frontend-sv' }}
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: ${{ inputs.working-directory || 'alt-frontend-sv' }}/playwright-report/
          retention-days: 30
