name: Alt Frontend SV Tests

permissions:
  contents: read

on:
  push:
    branches: [ main ]
    paths:
      - 'alt-frontend-sv/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'alt-frontend-sv/**'
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
      node-version:
        required: false
        type: string
        default: "24"
      pnpm-version:
        required: false
        type: string
        default: "10"
      test-type:
        required: false
        type: string
        default: "playwright"
  workflow_dispatch:
    inputs:
      working-directory:
        description: "Working directory for the test"
        required: true
        type: string
        default: "alt-frontend-sv"
      node-version:
        description: "Node.js version to use"
        required: false
        type: string
        default: "24"
      pnpm-version:
        description: "pnpm version to use"
        required: false
        type: string
        default: "10"
      test-type:
        description: "Type of test to run"
        required: false
        type: string
        default: "playwright"

jobs:
  test:
    timeout-minutes: 60
    runs-on: self-hosted

    env:
      CI: true
      FORCE_COLOR: "1"
      PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/playwright-browsers
      PLAYWRIGHT_SKIP_GIT_INFO: "1"

    steps:
      - uses: actions/checkout@v4

      - name: Mask sensitive paths and git information
        run: |
          echo "::group::Masking Configuration"
          # Mask HOME path parts
          for part in $(echo "$HOME" | tr '/' ' '); do
            [ -n "$part" ] && echo "::add-mask::$part"
          done
          # Mask user and hostname
          echo "::add-mask::$(whoami)"
          echo "::add-mask::$(hostname)"
          echo "::add-mask::$(hostname -s || true)"
          # Mask runner paths
          RUNNER_BASE=$(pwd | cut -d'/' -f1-5)
          echo "::add-mask::$RUNNER_BASE"
          WORKSPACE_PATH=$(pwd | sed 's|/alt-frontend||')
          echo "::add-mask::$WORKSPACE_PATH"
          echo "::add-mask::$(echo $HOME | cut -d'/' -f1-3)"
          echo "::add-mask::${{ runner.temp }}"
          echo "::add-mask::${{ github.workspace }}"
          # Mask git commit information
          if command -v git >/dev/null 2>&1; then
            GIT_HASH=$(git rev-parse HEAD 2>/dev/null || echo "")
            GIT_SHORT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "")
            GIT_SUBJECT=$(git log -1 --pretty=format:"%s" 2>/dev/null || echo "")
            GIT_BODY=$(git log -1 --pretty=format:"%b" 2>/dev/null || echo "")
            GIT_AUTHOR_NAME=$(git log -1 --pretty=format:"%an" 2>/dev/null || echo "")
            GIT_AUTHOR_EMAIL=$(git log -1 --pretty=format:"%ae" 2>/dev/null || echo "")
            GIT_COMMITTER_NAME=$(git log -1 --pretty=format:"%cn" 2>/dev/null || echo "")
            GIT_COMMITTER_EMAIL=$(git log -1 --pretty=format:"%ce" 2>/dev/null || echo "")
            [ -n "$GIT_HASH" ] && echo "::add-mask::$GIT_HASH"
            [ -n "$GIT_SHORT_HASH" ] && echo "::add-mask::$GIT_SHORT_HASH"
            [ -n "$GIT_SUBJECT" ] && echo "::add-mask::$GIT_SUBJECT"
            [ -n "$GIT_BODY" ] && echo "::add-mask::$GIT_BODY"
            [ -n "$GIT_AUTHOR_NAME" ] && echo "::add-mask::$GIT_AUTHOR_NAME"
            [ -n "$GIT_AUTHOR_EMAIL" ] && echo "::add-mask::$GIT_AUTHOR_EMAIL"
            [ -n "$GIT_COMMITTER_NAME" ] && echo "::add-mask::$GIT_COMMITTER_NAME"
            [ -n "$GIT_COMMITTER_EMAIL" ] && echo "::add-mask::$GIT_COMMITTER_EMAIL"
            # Also mask GitHub Actions context variables that might contain git info
            echo "::add-mask::${{ github.sha }}"
            echo "::add-mask::${{ github.event.head_commit.message || '' }}"
            echo "::add-mask::${{ github.event.head_commit.author.name || '' }}"
            echo "::add-mask::${{ github.event.head_commit.author.email || '' }}"
            echo "::add-mask::${{ github.event.head_commit.committer.name || '' }}"
            echo "::add-mask::${{ github.event.head_commit.committer.email || '' }}"
          fi
          echo "::endgroup::"


      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Install Playwright Browsers
        run: bunx playwright install --with-deps
      - name: Run Playwright tests
        run: bun run test:e2e
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
