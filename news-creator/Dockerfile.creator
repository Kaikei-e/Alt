# ---- Base image -----------------------------------------------------------
FROM ollama/ollama:0.9.7-rc0

# ---- Install dependencies -------------------------------------------------
USER root
RUN apt-get update \
    && apt-get install --no-install-recommends -y \
    ca-certificates \
    bash \
    curl \
    netcat-openbsd \
    libcurl4 \
    libpsl5 \
    librtmp1 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ---- Create dedicated appuser and group ----------------------------------
# Use system user/group to avoid UID/GID conflicts
RUN groupadd --system appuser \
    && useradd --system --create-home --shell /bin/bash --gid appuser appuser

# ---- Model cache persistence ---------------------------------------------
ENV OLLAMA_HOME=/home/appuser/.ollama
ENV OLLAMA_MODELS=$OLLAMA_HOME
VOLUME ["$OLLAMA_HOME"]

# ---- Copy entrypoint and set permissions --------------------------------
COPY --chown=appuser:appuser entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# ---- Switch to non-root user ---------------------------------------------
USER appuser
WORKDIR /home/appuser

EXPOSE 11434
ENTRYPOINT ["bash", "-c", "/usr/local/bin/entrypoint.sh"]