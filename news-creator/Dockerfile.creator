# ---- Base image -----------------------------------------------------------
FROM ollama/ollama:latest

# ---- Install additional dependencies --------------------------------------
USER root
RUN apt-get update \
    && apt-get install --no-install-recommends -y \
    ca-certificates \
    bash \
    curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ---- Create ollama user if it doesn't exist ------------------------------
# Use a high UID to avoid conflicts
RUN groupadd -f -g 2000 ollama-user \
    && useradd -u 2000 -g 2000 -m -s /bin/bash ollama-user || true

# ---- Model cache persistence ---------------------------------------------
ENV OLLAMA_HOME=/home/ollama-user/.ollama
ENV OLLAMA_MODELS=$OLLAMA_HOME/models
RUN mkdir -p $OLLAMA_HOME $OLLAMA_MODELS \
    && chown -R ollama-user:ollama-user $OLLAMA_HOME

VOLUME ["$OLLAMA_HOME"]

# ---- Copy entrypoint and set permissions --------------------------------
COPY --chown=ollama-user:ollama-user entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# ---- Switch to non-root user ---------------------------------------------
USER ollama-user
WORKDIR /home/ollama-user

# Health check to ensure the service is running
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:11434/api/tags || exit 1

EXPOSE 11434
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]