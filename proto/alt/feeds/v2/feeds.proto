syntax = "proto3";

package alt.feeds.v2;

option go_package = "alt/gen/proto/alt/feeds/v2;feedsv2";

// =============================================================================
// Feed Stats Messages (Phase 1)
// =============================================================================

// GetFeedStatsRequest is the request for getting basic feed statistics
message GetFeedStatsRequest {}

// GetFeedStatsResponse contains basic feed statistics
message GetFeedStatsResponse {
  // Total number of feeds
  int64 feed_amount = 1;
  // Number of feeds with summaries
  int64 summarized_feed_amount = 2;
}

// GetDetailedFeedStatsRequest is the request for getting detailed feed statistics
message GetDetailedFeedStatsRequest {}

// GetDetailedFeedStatsResponse contains detailed feed statistics
message GetDetailedFeedStatsResponse {
  // Total number of feeds
  int64 feed_amount = 1;
  // Total number of articles
  int64 article_amount = 2;
  // Number of unsummarized feeds
  int64 unsummarized_feed_amount = 3;
}

// GetUnreadCountRequest is the request for getting unread article count
message GetUnreadCountRequest {}

// GetUnreadCountResponse contains the unread article count
message GetUnreadCountResponse {
  // Number of unread articles (today)
  int64 count = 1;
}

// =============================================================================
// Feed Stats Streaming Messages (Phase 2 - Server Streaming RPC)
// =============================================================================

// StreamFeedStatsRequest is the request for streaming feed statistics
message StreamFeedStatsRequest {
  // Empty for now - future: could add interval configuration
}

// StreamFeedStatsResponse contains feed statistics for streaming updates
message StreamFeedStatsResponse {
  // Total number of feeds
  int64 feed_amount = 1;
  // Number of unsummarized articles
  int64 unsummarized_feed_amount = 2;
  // Total number of articles
  int64 total_articles = 3;
  // Metadata about this response
  ResponseMetadata metadata = 4;
}

// ResponseMetadata contains metadata about the streaming response
message ResponseMetadata {
  // Server timestamp (Unix seconds)
  int64 timestamp = 1;
  // Whether this is a heartbeat message (no data update)
  bool is_heartbeat = 2;
}

// =============================================================================
// Feed Item Messages (Phase 2-3)
// =============================================================================

// FeedItem represents a single feed/article item
message FeedItem {
  // Unique identifier (typically the link URL)
  string id = 1;
  // Article title
  string title = 2;
  // Article description/excerpt (sanitized, truncated)
  string description = 3;
  // Article URL
  string link = 4;
  // Human-readable published date (e.g., "2 hours ago")
  string published = 5;
  // RFC3339 timestamp for precise ordering
  string created_at = 6;
  // Author name (formatted from author/authors)
  string author = 7;
  // Article ID in the articles table (empty if article doesn't exist)
  // When empty, mark as read functionality should be disabled
  optional string article_id = 8;
  // Whether this feed has been read by the current user
  bool is_read = 9;
}

// =============================================================================
// Feed List Messages (Phase 2)
// =============================================================================

// GetUnreadFeedsRequest is the request for fetching unread feeds with cursor
message GetUnreadFeedsRequest {
  // Cursor for pagination (RFC3339 timestamp)
  optional string cursor = 1;
  // Maximum number of items to return (default: 20, max: 100)
  int32 limit = 2;
  // View mode: "swipe" for single-card response (optional)
  optional string view = 3;
}

// GetUnreadFeedsResponse contains unread feeds with pagination
message GetUnreadFeedsResponse {
  // Feed items
  repeated FeedItem data = 1;
  // Cursor for the next page (null if no more)
  optional string next_cursor = 2;
  // Whether there are more items
  bool has_more = 3;
}

// GetAllFeedsRequest is the request for fetching all feeds (read + unread) with cursor
message GetAllFeedsRequest {
  // Cursor for pagination (RFC3339 timestamp)
  optional string cursor = 1;
  // Maximum number of items to return (default: 20, max: 100)
  int32 limit = 2;
}

// GetAllFeedsResponse contains all feeds with pagination
message GetAllFeedsResponse {
  // Feed items
  repeated FeedItem data = 1;
  // Cursor for the next page
  optional string next_cursor = 2;
  // Whether there are more items
  bool has_more = 3;
}

// GetReadFeedsRequest is the request for fetching read/viewed feeds with cursor
message GetReadFeedsRequest {
  // Cursor for pagination (RFC3339 timestamp)
  optional string cursor = 1;
  // Maximum number of items to return (default: 32, max: 100)
  int32 limit = 2;
}

// GetReadFeedsResponse contains read feeds with pagination
message GetReadFeedsResponse {
  // Feed items
  repeated FeedItem data = 1;
  // Cursor for the next page
  optional string next_cursor = 2;
  // Whether there are more items
  bool has_more = 3;
}

// GetFavoriteFeedsRequest is the request for fetching favorite feeds with cursor
message GetFavoriteFeedsRequest {
  // Cursor for pagination (RFC3339 timestamp)
  optional string cursor = 1;
  // Maximum number of items to return (default: 20, max: 100)
  int32 limit = 2;
}

// GetFavoriteFeedsResponse contains favorite feeds with pagination
message GetFavoriteFeedsResponse {
  // Feed items
  repeated FeedItem data = 1;
  // Cursor for the next page
  optional string next_cursor = 2;
  // Whether there are more items
  bool has_more = 3;
}

// =============================================================================
// Feed Search Messages (Phase 3)
// =============================================================================

// SearchFeedsRequest is the request for searching feeds
message SearchFeedsRequest {
  // Search query (required, non-empty)
  string query = 1;
  // Offset for pagination (integer-based, not cursor)
  optional int32 cursor = 2;
  // Maximum number of items to return (default: 20, max: 100)
  optional int32 limit = 3;
}

// SearchFeedsResponse contains search results with pagination
message SearchFeedsResponse {
  // Search result items
  repeated FeedItem data = 1;
  // Next offset cursor (null if no more)
  optional int32 next_cursor = 2;
  // Whether there are more results
  bool has_more = 3;
}

// =============================================================================
// Streaming Summarize Messages (Phase 6)
// =============================================================================

// StreamSummarizeRequest is the request for streaming article summarization
message StreamSummarizeRequest {
  // Feed/article URL (required if article_id not provided)
  optional string feed_url = 1;
  // Existing article ID (required if feed_url not provided)
  optional string article_id = 2;
  // Pre-fetched content (optional, skips fetch if provided)
  optional string content = 3;
  // Article title (optional)
  optional string title = 4;
}

// StreamSummarizeResponse contains a chunk of the summarization stream
message StreamSummarizeResponse {
  // Text chunk from summarization
  string chunk = 1;
  // Whether this is the final chunk
  bool is_final = 2;
  // Article ID (populated after first chunk or from cache)
  string article_id = 3;
  // Whether this response is from cache
  bool is_cached = 4;
  // Full summary (only populated if is_cached=true or is_final=true)
  optional string full_summary = 5;
}

// =============================================================================
// Mark As Read Messages (Phase 7)
// =============================================================================

// MarkAsReadRequest is the request for marking an article as read
message MarkAsReadRequest {
  // Article URL to mark as read (required)
  string article_url = 1;
}

// MarkAsReadResponse is the response after marking an article as read
message MarkAsReadResponse {
  // Success message
  string message = 1;
}

// =============================================================================
// Subscription Messages
// =============================================================================

// FeedSource represents an RSS source with its subscription status
message FeedSource {
  // Feed link ID (UUID)
  string id = 1;
  // Feed URL
  string url = 2;
  // Feed title (derived from URL or empty)
  string title = 3;
  // Whether the current user is subscribed to this source
  bool is_subscribed = 4;
  // When the feed link was created (RFC3339)
  string created_at = 5;
}

// ListSubscriptionsRequest is the request for listing feed sources with subscription status
message ListSubscriptionsRequest {}

// ListSubscriptionsResponse contains all feed sources with subscription status
message ListSubscriptionsResponse {
  // All feed sources with subscription status
  repeated FeedSource sources = 1;
}

// SubscribeRequest is the request for subscribing to a feed source
message SubscribeRequest {
  // Feed link ID to subscribe to (UUID)
  string feed_link_id = 1;
}

// SubscribeResponse is the response after subscribing
message SubscribeResponse {
  // Success message
  string message = 1;
}

// UnsubscribeRequest is the request for unsubscribing from a feed source
message UnsubscribeRequest {
  // Feed link ID to unsubscribe from (UUID)
  string feed_link_id = 1;
}

// UnsubscribeResponse is the response after unsubscribing
message UnsubscribeResponse {
  // Success message
  string message = 1;
}

// =============================================================================
// FeedService Definition
// =============================================================================

// FeedService provides feed-related operations
service FeedService {
  // Unary RPCs (Phase 1)

  // GetFeedStats returns basic feed statistics (feed count, summarized count)
  rpc GetFeedStats(GetFeedStatsRequest) returns (GetFeedStatsResponse);

  // GetDetailedFeedStats returns detailed feed statistics
  rpc GetDetailedFeedStats(GetDetailedFeedStatsRequest) returns (GetDetailedFeedStatsResponse);

  // GetUnreadCount returns the count of unread articles for today
  rpc GetUnreadCount(GetUnreadCountRequest) returns (GetUnreadCountResponse);

  // Server Streaming RPCs

  // StreamFeedStats streams real-time feed statistics updates
  // Replaces SSE endpoint /v1/sse/feeds/stats
  rpc StreamFeedStats(StreamFeedStatsRequest) returns (stream StreamFeedStatsResponse);

  // Feed List RPCs (Phase 2)

  // GetUnreadFeeds returns unread feeds with cursor-based pagination
  // Replaces GET /v1/feeds/fetch/cursor
  rpc GetUnreadFeeds(GetUnreadFeedsRequest) returns (GetUnreadFeedsResponse);

  // GetAllFeeds returns all feeds (read + unread) with cursor-based pagination
  rpc GetAllFeeds(GetAllFeedsRequest) returns (GetAllFeedsResponse);

  // GetReadFeeds returns read/viewed feeds with cursor-based pagination
  // Replaces GET /v1/feeds/fetch/viewed/cursor
  rpc GetReadFeeds(GetReadFeedsRequest) returns (GetReadFeedsResponse);

  // GetFavoriteFeeds returns favorite feeds with cursor-based pagination
  // Replaces GET /v1/feeds/fetch/favorites/cursor
  rpc GetFavoriteFeeds(GetFavoriteFeedsRequest) returns (GetFavoriteFeedsResponse);

  // Feed Search RPC (Phase 3)

  // SearchFeeds searches for feeds by query with offset-based pagination
  // Replaces POST /v1/feeds/search
  rpc SearchFeeds(SearchFeedsRequest) returns (SearchFeedsResponse);

  // Streaming Summarize RPC (Phase 6)

  // StreamSummarize streams article summarization in real-time
  // Replaces POST /v1/feeds/summarize/stream (SSE)
  rpc StreamSummarize(StreamSummarizeRequest) returns (stream StreamSummarizeResponse);

  // Mark As Read RPC (Phase 7)

  // MarkAsRead marks an article as read by its URL
  // Replaces POST /v1/feeds/read
  rpc MarkAsRead(MarkAsReadRequest) returns (MarkAsReadResponse);

  // Subscription RPCs

  // ListSubscriptions returns all feed sources with subscription status for the current user
  rpc ListSubscriptions(ListSubscriptionsRequest) returns (ListSubscriptionsResponse);

  // Subscribe subscribes the current user to a feed source
  rpc Subscribe(SubscribeRequest) returns (SubscribeResponse);

  // Unsubscribe unsubscribes the current user from a feed source
  rpc Unsubscribe(UnsubscribeRequest) returns (UnsubscribeResponse);
}
