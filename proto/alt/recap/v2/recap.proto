syntax = "proto3";

package alt.recap.v2;

option go_package = "alt/gen/proto/alt/recap/v2;recapv2";

// =============================================================================
// RecapService Definition
// =============================================================================

// RecapService provides recap-related operations
service RecapService {
  // GetSevenDayRecap returns 7-day recap summary (authentication required)
  // Replaces GET /api/v1/recap/7days
  rpc GetSevenDayRecap(GetSevenDayRecapRequest) returns (GetSevenDayRecapResponse);

  // GetEveningPulse returns Evening Pulse data (authentication required)
  // Evening Pulse provides 3 key topics for quick daily catch-up
  rpc GetEveningPulse(GetEveningPulseRequest) returns (GetEveningPulseResponse);
}

// =============================================================================
// Request/Response Messages
// =============================================================================

// GetSevenDayRecapRequest is the request for getting 7-day recap
message GetSevenDayRecapRequest {
  // Optional draft ID for cluster draft attachment (replaces X-Genre-Draft-Id header)
  optional string genre_draft_id = 1;
}

// GetSevenDayRecapResponse contains the 7-day recap summary
message GetSevenDayRecapResponse {
  // Recap job ID
  string job_id = 1;
  // Execution timestamp (RFC3339)
  string executed_at = 2;
  // Window start timestamp (RFC3339)
  string window_start = 3;
  // Window end timestamp (RFC3339)
  string window_end = 4;
  // Total number of articles in the recap
  int32 total_articles = 5;
  // Recap by genre
  repeated RecapGenre genres = 6;
  // Optional cluster draft (populated if genre_draft_id provided)
  optional ClusterDraft cluster_draft = 7;
}

// =============================================================================
// Recap Genre Messages
// =============================================================================

// RecapGenre represents a summary for a specific genre
message RecapGenre {
  // Genre name
  string genre = 1;
  // Summary text for this genre
  string summary = 2;
  // Top terms/keywords for this genre
  repeated string top_terms = 3;
  // Number of articles in this genre
  int32 article_count = 4;
  // Number of clusters in this genre
  int32 cluster_count = 5;
  // Evidence links to source articles
  repeated EvidenceLink evidence_links = 6;
  // Bullet points extracted from the summary
  repeated string bullets = 7;
  // References with URLs
  repeated Reference references = 8;
}

// EvidenceLink represents a link to a source article
message EvidenceLink {
  // Article ID
  string article_id = 1;
  // Article title
  string title = 2;
  // Source URL
  string source_url = 3;
  // Published timestamp (RFC3339)
  string published_at = 4;
  // Language code
  string lang = 5;
}

// Reference represents a URL reference in the summary
message Reference {
  // Reference ID (1-indexed)
  int32 id = 1;
  // Full URL
  string url = 2;
  // Domain extracted from URL
  string domain = 3;
  // Optional article ID if linked to an article
  optional string article_id = 4;
}

// =============================================================================
// Cluster Draft Messages
// =============================================================================

// ClusterDraft contains clustering metadata for recap analysis
message ClusterDraft {
  // Draft ID
  string draft_id = 1;
  // Description of the draft
  string description = 2;
  // Source identifier
  string source = 3;
  // Generation timestamp (RFC3339)
  string generated_at = 4;
  // Total number of entries
  int32 total_entries = 5;
  // Genres with cluster data
  repeated ClusterGenre genres = 6;
}

// ClusterGenre contains clustering data for a genre
message ClusterGenre {
  // Genre name
  string genre = 1;
  // Sample size used for clustering
  int32 sample_size = 2;
  // Number of clusters
  int32 cluster_count = 3;
  // Individual clusters
  repeated ClusterSegment clusters = 4;
}

// ClusterSegment represents a single cluster
message ClusterSegment {
  // Cluster ID
  string cluster_id = 1;
  // Human-readable label
  string label = 2;
  // Number of items in cluster
  int32 count = 3;
  // Average margin score
  double margin_mean = 4;
  // Margin standard deviation
  double margin_std = 5;
  // Average top boost score
  double top_boost_mean = 6;
  // Ratio of articles with graph boost available
  double graph_boost_available_ratio = 7;
  // Average tag count
  double tag_count_mean = 8;
  // Average tag entropy
  double tag_entropy_mean = 9;
  // Top tags for this cluster
  repeated string top_tags = 10;
  // Representative articles
  repeated ClusterArticle representative_articles = 11;
}

// ClusterArticle represents an article in a cluster
message ClusterArticle {
  // Article ID
  string article_id = 1;
  // Margin score
  double margin = 2;
  // Top boost score
  double top_boost = 3;
  // Strategy used
  string strategy = 4;
  // Number of tags
  int32 tag_count = 5;
  // Number of candidates
  int32 candidate_count = 6;
  // Top tags for this article
  repeated string top_tags = 7;
}

// =============================================================================
// Evening Pulse Messages
// =============================================================================

// GetEveningPulseRequest is the request for getting Evening Pulse
message GetEveningPulseRequest {
  // Optional target date in YYYY-MM-DD format. Defaults to today.
  optional string date = 1;
}

// GetEveningPulseResponse contains the Evening Pulse data
message GetEveningPulseResponse {
  // Job ID
  string job_id = 1;
  // Target date (YYYY-MM-DD)
  string date = 2;
  // Generation timestamp (RFC3339)
  string generated_at = 3;
  // Pulse status
  PulseStatus status = 4;
  // Selected topics (0-3)
  repeated PulseTopic topics = 5;
  // Quiet day info (only present when status is QUIET_DAY)
  optional QuietDayInfo quiet_day = 6;
}

// PulseStatus represents the status of Evening Pulse generation
enum PulseStatus {
  // Unspecified status
  PULSE_STATUS_UNSPECIFIED = 0;
  // Normal: 3 topics selected
  PULSE_STATUS_NORMAL = 1;
  // Partial: 1-2 topics selected
  PULSE_STATUS_PARTIAL = 2;
  // Quiet day: 0 topics, showing weekly highlights instead
  PULSE_STATUS_QUIET_DAY = 3;
  // Error: generation failed
  PULSE_STATUS_ERROR = 4;
}

// PulseTopic represents a selected topic for Evening Pulse
message PulseTopic {
  // Cluster ID
  int64 cluster_id = 1;
  // Topic role
  TopicRole role = 2;
  // Topic title (cluster label)
  string title = 3;
  // Selection rationale
  PulseRationale rationale = 4;
  // Number of articles in the cluster
  int32 article_count = 5;
  // Number of unique sources
  int32 source_count = 6;
  // Number of Tier1 sources (optional)
  optional int32 tier1_count = 7;
  // Human-readable time ago string (e.g., "3時間前")
  string time_ago = 8;
  // Trend multiplier for trending topics (optional)
  optional double trend_multiplier = 9;
  // Genre name (optional)
  optional string genre = 10;
  // Article IDs for this topic
  repeated string article_ids = 11;
}

// TopicRole represents the role of a topic in Evening Pulse
enum TopicRole {
  // Unspecified role
  TOPIC_ROLE_UNSPECIFIED = 0;
  // Need to know: High-impact news from authoritative sources
  TOPIC_ROLE_NEED_TO_KNOW = 1;
  // Trend: Rapidly growing topic
  TOPIC_ROLE_TREND = 2;
  // Serendipity: Interesting topic from unexpected genre
  TOPIC_ROLE_SERENDIPITY = 3;
}

// PulseRationale explains why a topic was selected
message PulseRationale {
  // Human-readable explanation text
  string text = 1;
  // Confidence level of the selection
  Confidence confidence = 2;
}

// Confidence represents the confidence level of a selection
enum Confidence {
  // Unspecified confidence
  CONFIDENCE_UNSPECIFIED = 0;
  // High confidence
  CONFIDENCE_HIGH = 1;
  // Medium confidence
  CONFIDENCE_MEDIUM = 2;
  // Low confidence
  CONFIDENCE_LOW = 3;
}

// QuietDayInfo provides fallback content when no topics are available
message QuietDayInfo {
  // Message explaining the quiet day
  string message = 1;
  // Weekly highlights as fallback content
  repeated WeeklyHighlight weekly_highlights = 2;
}

// WeeklyHighlight represents a notable topic from the past week
message WeeklyHighlight {
  // Highlight ID
  string id = 1;
  // Topic title
  string title = 2;
  // Date of the highlight (YYYY-MM-DD)
  string date = 3;
  // Original role of the topic
  string role = 4;
}
