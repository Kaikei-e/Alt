syntax = "proto3";

package alt.articles.v2;

option go_package = "alt/gen/proto/alt/articles/v2;articlesv2";

// =============================================================================
// Fetch Article Content Messages
// =============================================================================

// FetchArticleContentRequest is the request for fetching article content
message FetchArticleContentRequest {
  // Article URL (required)
  string url = 1;
}

// FetchArticleContentResponse contains the fetched article content
message FetchArticleContentResponse {
  // Original URL
  string url = 1;
  // Extracted article content (HTML tags stripped)
  string content = 2;
  // Generated article ID
  string article_id = 3;
  // OGP image URL (HTTPS only, empty if not found)
  string og_image_url = 4;
  // HMAC-signed proxy URL for the OGP image (empty if image proxy disabled or no OGP image)
  string og_image_proxy_url = 5;
}

// =============================================================================
// Archive Article Messages
// =============================================================================

// ArchiveArticleRequest is the request for archiving an article
message ArchiveArticleRequest {
  // Article URL to archive (required)
  string feed_url = 1;
  // Optional title override
  optional string title = 2;
}

// ArchiveArticleResponse contains the result of archiving
message ArchiveArticleResponse {
  // Success message
  string message = 1;
}

// =============================================================================
// Fetch Articles with Cursor Messages
// =============================================================================

// FetchArticlesCursorRequest is the request for fetching articles with pagination
message FetchArticlesCursorRequest {
  // Maximum number of items to return (default: 20, max: 100)
  int32 limit = 1;
  // Cursor for pagination (RFC3339 timestamp)
  optional string cursor = 2;
}

// ArticleItem represents a single article
message ArticleItem {
  // Article UUID
  string id = 1;
  // Article title
  string title = 2;
  // Article URL
  string url = 3;
  // Article content
  string content = 4;
  // Published timestamp (RFC3339)
  string published_at = 5;
  // Tags associated with the article
  repeated string tags = 6;
}

// FetchArticlesCursorResponse contains articles with pagination info
message FetchArticlesCursorResponse {
  // Article items
  repeated ArticleItem data = 1;
  // Next cursor for pagination (RFC3339 timestamp)
  optional string next_cursor = 2;
  // Whether there are more items
  bool has_more = 3;
}

// =============================================================================
// Fetch Article Summary Messages
// =============================================================================

// FetchArticleSummaryRequest is the request for fetching article summaries
message FetchArticleSummaryRequest {
  // List of feed URLs to fetch summaries for (max 50 URLs)
  repeated string feed_urls = 1;
}

// ArticleSummaryItem represents a single article summary
message ArticleSummaryItem {
  // Article title
  string title = 1;
  // Article content
  string content = 2;
  // Article author
  string author = 3;
  // Published timestamp
  string published_at = 4;
  // Fetched timestamp
  string fetched_at = 5;
  // Source ID
  string source_id = 6;
}

// FetchArticleSummaryResponse contains article summaries
message FetchArticleSummaryResponse {
  // Matched articles
  repeated ArticleSummaryItem matched_articles = 1;
  // Total number of matched articles
  int32 total_matched = 2;
  // Number of requested URLs
  int32 requested_count = 3;
}

// =============================================================================
// Image Proxy Messages
// =============================================================================

// BatchPrefetchImagesRequest requests proxy URLs for multiple articles' OGP images.
message BatchPrefetchImagesRequest {
  // Article IDs to prefetch images for (max 10)
  repeated string article_ids = 1;
}

// ImageProxyInfo contains the proxy URL info for a single article's OGP image.
message ImageProxyInfo {
  // Article ID
  string article_id = 1;
  // HMAC-signed proxy URL path
  string proxy_url = 2;
  // Whether the image is already cached on the server
  bool is_cached = 3;
}

// BatchPrefetchImagesResponse contains proxy URLs for the requested articles.
message BatchPrefetchImagesResponse {
  // Proxy URL info for each article
  repeated ImageProxyInfo images = 1;
}

// =============================================================================
// Tag Trail Messages (ADR-167, ADR-168, ADR-169)
// =============================================================================

// FetchArticlesByTagRequest is the request for fetching articles by tag
message FetchArticlesByTagRequest {
  // Tag ID for backward compatibility (optional)
  optional string tag_id = 1;
  // Tag name for cross-feed discovery (preferred, ADR-169)
  optional string tag_name = 2;
  // Cursor for pagination (RFC3339 timestamp)
  optional string cursor = 3;
  // Maximum number of items to return (default: 20, max: 100)
  int32 limit = 4;
}

// TagTrailArticleItem represents an article in Tag Trail
message TagTrailArticleItem {
  // Article UUID
  string id = 1;
  // Article title
  string title = 2;
  // Article URL (link)
  string link = 3;
  // Published timestamp (RFC3339)
  string published_at = 4;
  // Feed title (source)
  string feed_title = 5;
}

// FetchArticlesByTagResponse contains articles matching the tag
message FetchArticlesByTagResponse {
  // Matching articles
  repeated TagTrailArticleItem articles = 1;
  // Next cursor for pagination
  optional string next_cursor = 2;
  // Whether there are more items
  bool has_more = 3;
}

// FetchArticleTagsRequest is the request for fetching tags of an article
message FetchArticleTagsRequest {
  // Article ID (required)
  string article_id = 1;
}

// ArticleTagItem represents a tag on an article
message ArticleTagItem {
  // Tag ID
  string id = 1;
  // Tag name
  string name = 2;
  // Created timestamp (RFC3339)
  string created_at = 3;
}

// FetchArticleTagsResponse contains tags for an article
message FetchArticleTagsResponse {
  // Article ID
  string article_id = 1;
  // Article tags
  repeated ArticleTagItem tags = 2;
}

// FetchRandomFeedRequest is the request for getting a random feed
message FetchRandomFeedRequest {}

// FetchRandomFeedResponse contains a random feed
message FetchRandomFeedResponse {
  // Feed ID
  string id = 1;
  // Site URL (feeds.link)
  string url = 2;
  // Feed title
  string title = 3;
  // Feed description
  string description = 4;
  // Tags for the feed (generated on-the-fly if not in DB, ADR-173)
  repeated ArticleTagItem tags = 5;
}

// =============================================================================
// Tag Trail Streaming Messages (Real-time tag generation)
// =============================================================================

// StreamArticleTagsRequest is the request for streaming tag updates
message StreamArticleTagsRequest {
  // Article ID (required)
  string article_id = 1;
  // Article title (optional, for on-the-fly generation)
  optional string title = 2;
  // Article content (optional, for on-the-fly generation)
  optional string content = 3;
  // Feed ID (optional, for on-the-fly generation)
  optional string feed_id = 4;
}

// StreamArticleTagsResponse represents a streaming event for tag updates
message StreamArticleTagsResponse {
  // Article ID
  string article_id = 1;
  // Current tags (empty during generation)
  repeated ArticleTagItem tags = 2;
  // Event type
  EventType event_type = 3;
  // Status message (optional)
  optional string message = 4;

  // EventType indicates the type of tag event
  enum EventType {
    EVENT_TYPE_UNSPECIFIED = 0;
    // Tags retrieved from cache/DB (immediate completion)
    EVENT_TYPE_CACHED = 1;
    // Tags are being generated (heartbeat)
    EVENT_TYPE_GENERATING = 2;
    // Tag generation completed
    EVENT_TYPE_COMPLETED = 3;
    // Error occurred during generation
    EVENT_TYPE_ERROR = 4;
  }
}

// =============================================================================
// ArticleService Definition
// =============================================================================

// ArticleService provides article-related operations
service ArticleService {
  // FetchArticleContent fetches and extracts compliant article content
  // Replaces GET /v1/articles/fetch/content
  rpc FetchArticleContent(FetchArticleContentRequest) returns (FetchArticleContentResponse);

  // ArchiveArticle archives an article for later reading
  // Replaces POST /v1/articles/archive
  rpc ArchiveArticle(ArchiveArticleRequest) returns (ArchiveArticleResponse);

  // FetchArticlesCursor fetches articles with cursor-based pagination
  // Replaces GET /v1/articles/fetch/cursor
  rpc FetchArticlesCursor(FetchArticlesCursorRequest) returns (FetchArticlesCursorResponse);

  // FetchArticleSummary fetches article summaries for multiple URLs
  // Replaces POST /v1/articles/summary
  rpc FetchArticleSummary(FetchArticleSummaryRequest) returns (FetchArticleSummaryResponse);

  // FetchArticlesByTag fetches articles by tag (ID or name)
  // Replaces GET /v1/articles/by-tag
  rpc FetchArticlesByTag(FetchArticlesByTagRequest) returns (FetchArticlesByTagResponse);

  // FetchArticleTags fetches tags for an article
  // Replaces GET /v1/articles/:id/tags
  rpc FetchArticleTags(FetchArticleTagsRequest) returns (FetchArticleTagsResponse);

  // FetchRandomFeed fetches a random feed for Tag Trail
  // Replaces GET /v1/rss-feed-link/random
  rpc FetchRandomFeed(FetchRandomFeedRequest) returns (FetchRandomFeedResponse);

  // StreamArticleTags streams real-time tag updates for an article
  // Returns cached tags immediately if available, otherwise streams generation progress
  rpc StreamArticleTags(StreamArticleTagsRequest) returns (stream StreamArticleTagsResponse);

  // BatchPrefetchImages generates proxy URLs and optionally warms cache for OGP images
  rpc BatchPrefetchImages(BatchPrefetchImagesRequest) returns (BatchPrefetchImagesResponse);
}
