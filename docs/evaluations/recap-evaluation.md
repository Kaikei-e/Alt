# 7日間Recapジョブ評価レポート

本ドキュメントは、Alt RSSリーダープラットフォームにおける7日間振り返り (Recap) 機能の評価結果をまとめたものです。

## 概要

Recapジョブは、過去7日間の記事をジャンル別にクラスタリングし、各クラスターから要約を生成する機能です。本評価では、生成された要約がクラスター内容をどの程度カバーしているかを「カバレッジスコア」として計測しています。

### 評価指標

- **カバレッジスコア**: 生成された要約（箇条書き）が、元のクラスターの代表的な文章（セントロイド）の内容をどの程度カバーしているかを示す指標。埋め込みモデルを使用した意味的類似度に基づいて計算。
- **成功率**: サブワーカーの実行成功数 / 総実行数

---

## 時系列推移サマリ

| フェーズ | 平均カバレッジ | 成功率 | 主な課題 |
|---------|---------------|--------|----------|
| Phase 1 | 0.5905 | 87.5% | DB重複キーエラー、専門用語ジャンルの低スコア |
| Phase 2 | 0.6651 | - | 大規模クラスターでの要約欠落 |
| Phase 3 | 0.0000 | - | 全ジャンルで要約生成失敗（重大障害） |

### Phase 1: 初期評価

**平均カバレッジスコア**: **0.5905**

#### ジャンル別パフォーマンス

**高スコアのジャンル**:
- `other.3`: 0.6697
- `other.31`: 0.6440

**低スコアのジャンル**:
- `consumer_tech`: 0.4127
- `other.21`: 0.4186
- `pro_it_media`: 0.5004

#### 実行統計
- サブワーカー成功実行数: 48件
- 保存された要約数: 42件
- 実質成功率: 87.5%

#### 検出された課題

1. **DB書き込みエラー**: `duplicate key value violates unique constraint` が13回発生
   - 原因: 並列処理におけるレースコンディション
   - 対応: `ON CONFLICT DO NOTHING` の追加（実装済み）

2. **低スコアジャンルの傾向**: 専門用語が多いジャンルでスコアが低い

---

### Phase 2: 改善後評価

**平均カバレッジスコア**: **0.6651** (+12.6%)

#### ジャンル別パフォーマンス

**高スコアのジャンル (0.8以上)**:
- `home_living`: 0.8361
- `other.3`: 0.8165
- `culture_arts`: 0.8065

**低スコアのジャンル (0.5以下)**:
- `product`: 0.4568
- `cybersecurity`: 0.4825
- `society_demographics`: 0.5376

#### 全体統計
| 指標 | 数値 |
|------|------|
| 対象ジャンル数 | 21 |
| 総処理記事数（推定） | 2,874 |
| 形成されたクラスター総数 | 70 |
| 生成された要約文総数 | 49 |

#### 要約欠落が発生したジャンル

以下のジャンルではクラスター生成は成功したが、要約が保存されなかった:

| ジャンル | クラスタ数 | 記事数 | 最大クラスタサイズ | 推定原因 |
|----------|-----------|--------|-------------------|----------|
| software_dev | 3 | 241 | 181 | コンテキスト超過 |
| ai_data | 3 | 204 | 113 | コンテキスト超過 |
| other.1 | 4 | 63 | - | - |

**分析**: 大規模クラスター（100記事以上）で要約生成のタイムアウトまたはコンテキスト超過が発生。

---

### Phase 3: 重大障害発生

**平均カバレッジスコア**: **0.0000**（全ジャンルで要約なし）

#### 障害の概要

クラスター生成は正常に完了（108クラスター形成）したが、全てのジャンルで要約が生成・保存されなかった。

#### 障害の傾向

特に `tech` ジャンルの `snmp` クラスターは:
- サイズ: 282記事
- 推定トークン数: 4,462

これが後続の要約プロセスでタイムアウトを引き起こした可能性が高い。

---

## 提言

### 短期対応

1. **大規模クラスターの再分割**
   - 最大クラスターサイズ制限の厳格化
   - 再帰的クラスタリング（サブクラスタリング）の導入

2. **トークン数監視**
   - クラスタリング段階でのトークン数監視
   - 閾値超過時の自動分割

### 中期対応

1. **エラーハンドリングの強化**
   - Reduceフェーズでの失敗検知と監視
   - `recap_outputs` テーブルへの保存失敗ログの追跡

2. **低スコアジャンルの改善**
   - プロンプト調整
   - クラスタリングパラメータの最適化

---

## 詳細データ（Phase 2）

| ジャンル | 要約数 | クラスタ数 | カバレッジ |
|----------|--------|-----------|-----------|
| other.4 | 2 | 3 | 0.7452 |
| home_living | 2 | 3 | 0.8361 |
| life_science | 2 | 3 | 0.6415 |
| other | 5 | 10 | 0.7161 |
| cybersecurity | 3 | 2 | 0.4825 |
| tech | 5 | 8 | 0.7150 |
| product | 5 | 3 | 0.4568 |
| consumer_tech | 3 | 4 | 0.6998 |
| markets_finance | 3 | 3 | 0.6652 |
| pro_it_media | 5 | 2 | 0.5739 |
| other.3 | 2 | 3 | 0.8165 |
| culture_arts | 2 | 3 | 0.8065 |
| society_demographics | 3 | 3 | 0.5376 |
| ai | 3 | 3 | 0.7210 |
| film_tv | 2 | 3 | 0.5624 |
