# ADR-000253: 検索結果のフィード詳細フッターが機能しない問題の修正

## ステータス

承認済み

## コンテキスト

### 背景

SvelteKit フロントエンドで検索結果からフィード詳細を開いた際、フッターのボタン（「Full Article」「Summarize By AI」）が機能しない不具合が報告された。ボタンがクリックできないか、クリックしても何も起こらない状態であった。

### 問題の根本原因

`alt-backend` の `GetFeedURLsByArticleIDs`（`app/driver/alt_db/feed_url_link_driver.go`）で使用されている SQL クエリに 2 つの重大な問題があった。

**問題 1: 誤った JOIN 条件**

```sql
INNER JOIN feeds f ON a.url = f.link
```

`articles.url`（記事の Web ページ URL、例: `https://example.com/blog/post-123`）と `feeds.link`（フィードのサイト URL、例: `https://example.com`）を結合しており、ほぼ一致しないため INNER JOIN の結果が空になっていた。

**問題 2: 誤ったカラム返却**

```sql
SELECT ... f.link as url ...
```

`f.link`（フィードのトップページ URL）を返しており、フロントエンドが必要とする `a.url`（記事の実際の URL）ではなかった。

### フロントエンドへの影響経路

1. バックエンド: `urlMap[hit.ID]` → 空文字列（JOIN が結果を返さない）
2. Connect-RPC: `FeedItem.Link = ""`
3. フロントエンド: `normalizeUrl("")` → `""`
4. `FeedDetailModal` の自動フェッチガード: `feed?.normalizedUrl` → falsy → **スキップ**
5. 「Full Article」ボタン: `if (!feed?.normalizedUrl) return` → **即座にリターン**
6. 「Summarize By AI」ボタン: `disabled={!articleContent}` → **永続的に無効**

## 意思決定

### SQL クエリの修正

変更前:
```sql
SELECT f.id as feed_id, a.id as article_id, f.link as url,
       f.title as feed_title, a.title as article_title
FROM articles a
INNER JOIN feeds f ON a.url = f.link
WHERE a.id = ANY($1)
```

変更後:
```sql
SELECT COALESCE(f.id::text, '') as feed_id, a.id as article_id, a.url as url,
       COALESCE(f.title, '') as feed_title, a.title as article_title
FROM articles a
LEFT JOIN feeds f ON a.feed_id = f.id
WHERE a.id = ANY($1)
```

**変更点:**

| 変更箇所 | 変更前 | 変更後 | 理由 |
|----------|--------|--------|------|
| JOIN 種別 | `INNER JOIN` | `LEFT JOIN` | フィード関連付けのない記事も結果に含める |
| JOIN 条件 | `a.url = f.link` | `a.feed_id = f.id` | 正規の FK リレーション（`articles.feed_id` → `feeds.id`）を使用 |
| URL カラム | `f.link as url` | `a.url as url` | 記事の実際の Web ページ URL を返す |
| NULL 安全性 | なし | `COALESCE` | LEFT JOIN で feed 側が NULL になるケースに対応 |

### 検討した代替案

| 案 | 不採用理由 |
|---|---|
| フロントエンド側で空 URL をフォールバック処理 | 根本原因はバックエンドの SQL であり、フロントエンドでの回避策は不適切 |
| INNER JOIN のまま ON 条件のみ修正 | feed_id が NULL の記事が検索結果に含まれる可能性があり、LEFT JOIN で安全にカバーすべき |
| 別途 URL 取得エンドポイントを追加 | 既存クエリの修正で十分であり、新規エンドポイントは過剰 |

## 結果・影響

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/driver/alt_db/feed_url_link_driver.go` | SQL クエリ修正（JOIN 種別・条件・返却カラム・COALESCE） |
| `alt-backend/app/driver/alt_db/feed_url_link_driver_test.go` | 新規：ドライバ層の単体テスト 3 件追加 |

### テスト結果

- `alt-backend`: `go test ./...` — 全パッケージ PASS
- ドライバテスト 3 件: 正常系・フィード未関連付け記事・空入力
- ゲートウェイテスト: 既存 4 件 PASS（変更なし）
- 検索ユースケーステスト: 既存テスト PASS（変更なし）
- コンテナ再ビルド・再起動後、ヘルスチェック正常

### PROS

- 検索結果から開いたフィード詳細の「Full Article」「Summarize By AI」ボタンが正常に機能する
- `feed_id` が NULL の記事でも検索結果に含まれる（LEFT JOIN による安全性向上）
- フロントエンド側の変更が不要（バックエンドの SQL 修正のみで完結）
- ドライバ層にテストが追加され、回帰検出が可能になった

### CONS, TRADEOFF

- LEFT JOIN により、INNER JOIN 時と比較してクエリのパフォーマンスがわずかに低下する可能性がある（ただし `articles.feed_id` にインデックスがあれば影響は軽微）
- `feed_id` が NULL の記事では `feed_id` と `feed_title` が空文字列で返る（フロントエンドの表示上は問題なし）

### 影響範囲

- **検索結果のフィード詳細表示**: 修正対象。記事 URL が正しく返却される
- **通常のフィード一覧からの詳細表示**: このクエリを使用しないため影響なし
- **Connect-RPC レスポンス**: `FeedItem.Link` に正しい URL が設定される
- **Meilisearch インデクシング**: 影響なし（検索インデックスは独立）

## 関連 ADR

- ADR-000252: フィード収集のレートリミット二重待機修正と pre-processor デッドコード削除
