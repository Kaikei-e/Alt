# Atlas マイグレータのサイレント失敗修正と起動順序の保証

## ADR's STATUS

Accepted (実装完了・コンテナ起動確認済み)

## CONTEXT

### 問題点

`altctl up` で全コンテナを起動した際、`alt-backend` が unhealthy となりパニックする事象が発生していた。Outbox ワーカー (5秒間隔ポーリング) が `ERROR: relation "outbox_events" does not exist` を出力し、バックエンドが正常動作しなかった。

### 根本原因

2つの独立したバグが原因だった。

**バグ 1: `DATABASE_URL` が未設定で migrate サービスがサイレントに失敗**

`compose/core.yaml` の `migrate` サービスは個別の環境変数 (`DB_HOST`, `DB_PORT`, `DB_USER`, `DB_NAME`, `DB_PASSWORD_FILE`) を渡していたが、`migrate.sh` スクリプトは `DATABASE_URL` 環境変数のみを期待していた。`DATABASE_URL` が空のため、スクリプトは "DATABASE_URL environment variable is required" で即座に終了し、`outbox_events` テーブル (および他のマイグレーション) が作成されなかった。

**バグ 2: `alt-backend` がマイグレーション完了を待たない**

`migrate` サービスには `db` への `depends_on` がなく、`alt-backend` には `migrate` への `depends_on` がなかった。マイグレータが正常動作したとしても、バックエンドがマイグレーション完了前に起動する競合状態が存在していた。

### 既存の修正パターン

RAG 用マイグレータ (`rag-migration-atlas/docker/scripts/migrate.sh`) には既に個別環境変数から `DATABASE_URL` を構築するロジックが実装済みだった。本修正はこのパターンをメインおよび Recap マイグレータに展開するものである。

## DECISION MAKING

### 方針

RAG マイグレータに既存の修正パターンを他の2つのマイグレータスクリプトに適用し、Compose ファイルでサービス間の依存関係を明示する。

### 修正内容

#### 1. メインマイグレータスクリプトに DATABASE_URL 構築ロジックを追加

`migrations-atlas/docker/scripts/migrate.sh` の `check_requirements()` 関数に、`DATABASE_URL` が未設定かつ `DB_HOST` が設定されている場合に個別環境変数から `DATABASE_URL` を自動構築するロジックを追加した。`DB_PASSWORD_FILE` (Docker Secrets) からのパスワード読み取りにも対応。

#### 2. Recap マイグレータスクリプトに同等ロジックを追加

`recap-migration-atlas/docker/scripts/migrate.sh` に同等のロジックを追加した。こちらは Recap DB 固有のプレフィックス (`RECAP_DB_HOST`, `RECAP_DB_PORT` 等) を使用し、`local` 変数で既存変数を汚染しない実装とした。

#### 3. Compose ファイルでサービス依存関係を追加

`compose/core.yaml` に以下の依存関係を追加した:

- `migrate` サービスに `depends_on: db: condition: service_healthy` を追加し、DB の準備完了後にマイグレーション実行を保証
- `alt-backend` サービスの `depends_on` に `migrate: condition: service_completed_successfully` を追加し、マイグレーション成功後にバックエンドが起動することを保証

## RESULTS, EFFECTS

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `migrations-atlas/docker/scripts/migrate.sh` | `check_requirements()` に `DATABASE_URL` 自動構築ロジックを追加 |
| `recap-migration-atlas/docker/scripts/migrate.sh` | `check_requirements()` に `RECAP_DB_*` からの `DATABASE_URL` 自動構築ロジックを追加 |
| `compose/core.yaml` | `migrate` に `depends_on: db`、`alt-backend` に `depends_on: migrate` を追加 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| Compose config 構文チェック | PASS (エラーなし) |
| `altctl` Go テスト (`go test ./...`) | PASS (4パッケージ) |
| `migrate` コンテナ: `DATABASE_URL` 構築ログ | 出力確認 ("Constructing DATABASE_URL from environment variables...") |
| `migrate` コンテナ: マイグレーション実行 | 成功 (exit 0) |
| `alt-backend` ヘルスチェック | `{"database":"connected","status":"healthy"}` |
| `alt-backend` ログ: outbox_events エラー | なし |
| 起動順序: db → migrate → alt-backend | Compose ログで確認済み |

### 起動シーケンス (修正後)

```
db (service_healthy)
  └── migrate (service_completed_successfully)
        └── alt-backend
```

### PROS

- **サイレント失敗の解消**: `DATABASE_URL` が自動構築されるため、個別環境変数での設定でもマイグレーションが正しく実行される
- **起動順序の保証**: `depends_on` と `condition` により、DB 準備完了 → マイグレーション成功 → バックエンド起動の順序が確実に守られる
- **3つのマイグレータスクリプトの一貫性**: RAG・メイン・Recap の全マイグレータが同じ `DATABASE_URL` 構築パターンを持つようになった
- **後方互換性**: `DATABASE_URL` を直接設定する既存の方法 (`compose/dev.yaml` 等) も引き続き動作する

### CONS, TRADEOFF

- **`alt-backend` の起動がマイグレーション完了に依存**: マイグレーション実行中はバックエンドが起動しないため、初回起動やマイグレーション追加時に起動時間が若干増加する。ただし、これはデータ整合性のために必要なトレードオフである

## APPENDIX

### DATABASE_URL 構築ロジック (メインマイグレータ)

```sh
if [ -z "$DATABASE_URL" ] && [ -n "${DB_HOST:-}" ]; then
    DB_USER="${DB_USER:-postgres}"
    DB_NAME="${DB_NAME:-postgres}"
    DB_PORT="${DB_PORT:-5432}"
    if [ -n "${DB_PASSWORD_FILE:-}" ] && [ -f "$DB_PASSWORD_FILE" ]; then
        DB_PASSWORD=$(cat "$DB_PASSWORD_FILE")
    fi
    DATABASE_URL="postgres://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_NAME?sslmode=disable&search_path=public"
    export DATABASE_URL
fi
```

### 関連ファイル

| リソース | パス | 役割 |
|---------|------|------|
| RAG マイグレータ (参考実装) | `rag-migration-atlas/docker/scripts/migrate.sh` | 既存の `DATABASE_URL` 構築パターン |
| outbox_events マイグレーション | `migrations-atlas/migrations/20251225100000_create_outbox_events_table.sql` | 問題のトリガーとなったテーブル定義 |
| dev 用 Compose | `compose/dev.yaml` | `DATABASE_URL` を直接設定する既存パターン |
