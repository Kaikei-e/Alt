# ADR-000234: FeedDetailModal の用途別分離（Svelte 5 Snippet パターン）

## STATUS

Accepted（実装完了・`svelte-check` エラー 0 件）

## CONTEXT

`FeedDetailModal.svelte` は記事詳細の表示（タイトル、メタデータ、全文、AI 要約）と「Mark as Read」操作の両方の責務を持っていた。この結合により、既読履歴ページ（`/sv/feeds/viewed`）やお気に入りページ（`/sv/feeds/favorites`）など、既読操作が不要なページでも「Mark as Read」ボタンが表示されるという不具合が発生していた。

### 問題

1. **UI の不整合**: 既読履歴ページで「Mark as Read」ボタンが表示される（既読済みの記事に対して無意味）
2. **責務の混在**: 表示用コンポーネントがドメイン固有の API クライアント（`updateFeedReadStatusClient`）に直接依存
3. **再利用性の低下**: 新しいページで `FeedDetailModal` を使う場合、不要な `onMarkAsRead` / `disableMarkAsRead` props を渡す必要がある

### アプローチの選択肢

| 方式 | 利点 | 欠点 |
|------|------|------|
| A. ページ側で条件分岐（`showMarkAsRead` フラグ） | 変更が小さい | Props が増え続ける。責務分離にならない |
| B. Svelte 5 Snippet でフッターアクションを注入 | 責務が明確に分離。既存パターン（`PageHeader.svelte` の `actions?: Snippet`）と一貫性あり | 呼び出し側にスニペット定義が必要 |
| C. 別コンポーネントに分割（`FeedDetailModal` / `UnreadFeedDetailModal`） | 完全分離 | コード重複が大きい |

## DECISION MAKING

**方式 B（Svelte 5 Snippet による注入）** を採用した。

**理由:**

1. **既存パターンとの一貫性**: `PageHeader.svelte` が `actions?: Snippet` で同じアプローチを採用済み。プロジェクト内の慣習に従う
2. **Open-Closed 原則**: モーダル本体を変更せずにフッターのアクションを拡張可能。将来的に「お気に入り追加」等のアクションが必要になっても同じパターンで対応できる
3. **型安全**: Svelte 5 の `Snippet` 型により、テンプレートレベルでの型チェックが機能する

### 設計

```
Before:
  FeedDetailModal
    ├── 表示ロジック（タイトル、メタデータ、全文、AI 要約）
    ├── Mark as Read ロジック（API 呼び出し + 状態管理）
    └── フッター: [Full Article] [Summarize] [Mark as Read] [Close]

After:
  FeedDetailModal
    ├── 表示ロジック（タイトル、メタデータ、全文、AI 要約）
    ├── footerActions?: Snippet  ← 呼び出し側が注入
    └── フッター: [Full Article] [Summarize] [{footerActions}] [Close]

  未読フィードページ（呼び出し側）
    └── {#snippet footerActions()}
          <Button>Mark as Read</Button>
        {/snippet}
```

## RESULTS

### 変更ファイル

| ファイル | 操作 | 変更内容 |
|---------|------|---------|
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedDetailModal.svelte` | 修正 | `onMarkAsRead`, `disableMarkAsRead` props 削除。`isMarkingAsRead` 状態・`handleMarkAsRead()` 関数・`updateFeedReadStatusClient` import 削除。`footerActions?: Snippet` prop 追加。ハードコードされた「Mark as Read」ボタンを `{@render footerActions()}` に置換 |
| `alt-frontend-sv/src/routes/(app)/feeds/+page.svelte` | 修正 | `updateFeedReadStatusClient` import 追加。`isMarkingAsRead` 状態・`handleMarkAsReadInModal()` 関数追加。`FeedDetailModal` に `footerActions` スニペットとして「Mark as Read」ボタンを渡す |
| `alt-frontend-sv/src/routes/desktop/feeds/+page.svelte` | 修正 | 同上 |

### 変更不要だったファイル

以下のページは `footerActions` を渡さないため、フッターに「Mark as Read」ボタンが表示されなくなる（意図通り）。

| ファイル | ページ |
|---------|--------|
| `(app)/feeds/viewed/+page.svelte` | 既読履歴 |
| `desktop/feeds/viewed/+page.svelte` | 既読履歴（デスクトップ専用） |
| `(app)/feeds/search/+page.svelte` | 検索結果 |
| `desktop/feeds/search/+page.svelte` | 検索結果（デスクトップ専用） |
| `(app)/feeds/favorites/+page.svelte` | お気に入り |
| `desktop/feeds/favorites/+page.svelte` | お気に入り（デスクトップ専用） |

### 検証結果

```
svelte-check found 0 errors and 0 warnings
```

## PROS

1. **UI の不整合を解消**: 既読履歴・検索・お気に入りページで「Mark as Read」ボタンが非表示になる
2. **責務の明確な分離**: `FeedDetailModal` は表示に専念し、ドメイン固有の操作は呼び出し側が制御する
3. **既存パターンとの一貫性**: `PageHeader` の `actions?: Snippet` と同じアプローチ
4. **拡張性**: `footerActions` スニペットに任意のアクションを注入可能（将来の要件に対応しやすい）
5. **後方互換性**: `footerActions` は optional であるため、既存の呼び出し箇所に影響なし

## CONS, TRADEOFF

1. **呼び出し側の記述量が増加**: 未読フィードページ 2 ファイルにスニペット定義と API 呼び出しロジックを追加する必要がある（各 15 行程度）
2. **ロジックの重複**: 2 つの未読フィードページ（`(app)/feeds` と `desktop/feeds`）に同様の `handleMarkAsReadInModal` 実装が存在する。共通化するには別途ユーティリティの抽出が必要だが、現時点では 2 箇所のみのため許容
