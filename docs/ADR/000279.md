# ADR-000279: Lighthouse Performance 改善 Phase 3 — FCP/LCP 最適化と $effect ループ修正

## ステータス

承認済み

## コンテキスト

### Phase 2 (ADR-278) の結果

ADR-278 で SSR を有効化し、Performance スコアが 71 → 84 に改善された。

| カテゴリ | Phase 1 後 | Phase 2 後 |
|---------|-----------|-----------|
| Performance | 71 | **84** |
| Accessibility | 95 | **100** |
| Best Practices | 77 | **77** |

### 残存ボトルネック

Phase 2 後の Lighthouse メトリクス分析で以下の課題を特定した:

| メトリクス | 値 | スコア | ウェイト | 課題 |
|-----------|-----|-------|---------|------|
| FCP | 2.5s | 0.69 | 10% | SSR による HTML サイズ増加 (48KB) |
| LCP | 3.6s | 0.62 | 25% | Element Render Delay 678ms |
| TBT | 201ms | 0.89 | 30% | $effect ループによる JS 実行時間増加 |
| SI | 2.6s | 0.97 | 10% | 良好 |
| CLS | 0 | 1.0 | 25% | 良好 |

### FCP 悪化の原因

SSR により初期 HTML サイズが増加した。Lighthouse simulated throttling (1.6 Mbps) 下では、記事全文 HTML を含む 48KB の非圧縮転送が FCP を直撃していた。

加えて、nginx の `/sv/` location ブロックに `gzip off` が設定されていた（Connect-RPC 保護のため）。SSR ページの HTML レスポンスにも gzip が適用されていなかった。

### LCP Element Render Delay の原因

SSR により LCP 要素が画像から **テキスト DIV** (`div.text-sm` = 記事の description) に変化した。LCP 内訳:

| サブパート | Phase 1 後 | Phase 2 後 |
|-----------|-----------|-----------|
| TTFB | 269ms | 210ms |
| Resource Load Delay | 7,068ms | **0ms** |
| Element Render Delay | 348ms | **678ms** |

Element Render Delay 678ms の原因:
1. 記事 description の親要素に `transition:fade` が設定されており、JS ハイドレーション完了まで表示が遅延
2. `effect_update_depth_exceeded` ランタイムエラーがハイドレーション時に発生し、JS 実行時間を増加

### `effect_update_depth_exceeded` の根本原因

`SwipeFeedScreen.svelte` の初期化 `$effect` が、props を読み取って state に書き込む処理を行っていた:

```svelte
$effect(() => {
    feeds = [...(initialFeeds ?? [])];
    cursor = initialNextCursor ?? null;
    hasMore = !!initialNextCursor;
    isInitialLoading = (initialFeeds ?? []).length === 0;
});
```

この effect が書き込む `feeds`, `hasMore` を別の effects が読み取り → `loadMore()` が `feeds`, `cursor`, `hasMore` を更新 → 初期化 effect が再トリガー、という循環依存チェーンを形成していた。

さらに、`+page.svelte` の `$effect` 内で `articlePrefetcher.seedCache()` を呼ぶと、`onOgImageFetched` コールバック → `ogImageVersion++` → `currentOgImage` 再評価 → コンポーネント再レンダリングというチェーンが加わり、Svelte の effect depth limit に到達していた。

## 意思決定

### A-1. SSR ページの gzip 有効化

nginx の `/sv/` location を 2 つに分割した:

- **`/sv/api/`** — Connect-RPC 用。`gzip off` を維持（Connect-RPC は独自のエンコーディングを使用）
- **`/sv/`** — SSR ページ用。`gzip on` を有効化

nginx の prefix location マッチングにより、`/sv/api/` は `/sv/` より長いプレフィックスとして優先マッチされる。既存の regex location (`~ ^/sv/api/.*(stream|sse)`) は SSE エンドポイントの gzip off を引き続き処理。

### A-2. SSR HTML サイズ削減（記事コンテンツのストリーミング化）

`+page.server.ts` で、記事全文 HTML (`firstArticleContent`) を SvelteKit の streaming pattern で返すように変更した。

**変更前**: `fetchArticleContent` を await し、すべてのデータを初期 HTML に埋め込み
**変更後**: `articleData` を Promise として返却。SvelteKit が初期 HTML を即座に送信し、Promise 解決後にデータをストリーミング

`+page.svelte` では `$effect` の代わりに `onMount` で Promise を解決し、`articlePrefetcher.seedCache()` を一度だけ実行する（`cacheSeeded` フラグで重複防止）。

### A-3. `effect_update_depth_exceeded` の修正

2 つの修正を適用:

**1. $effect を直接初期化に置換** (`SwipeFeedScreen.svelte`):

```svelte
// Before: reactive $effect (循環依存の元凶)
$effect(() => {
    feeds = [...(initialFeeds ?? [])];
    ...
});

// After: direct initialization (一度きり、反応的でない)
let feeds = $state<RenderFeed[]>([...(initialFeeds ?? [])]);
let cursor = $state<string | null>(initialNextCursor ?? null);
let hasMore = $state(!!initialNextCursor);
let isInitialLoading = $state((initialFeeds ?? []).length === 0);
```

`$state` の初期化は一度きりで、props の変更に反応しない。これにより循環依存チェーンを完全に断ち切った。

**2. LCP テキスト要素の transition:fade 削除** (`VisualPreviewCard.svelte`):

記事 description を表示する div から `transition:fade` を削除。SSR HTML でテキストが即座に visible になり、JS ハイドレーションを待つ必要がなくなった。

### B-1. console.error の抑制

非致命的なネットワークエラー（記事取得失敗、フィードソース読み込み失敗等）の `console.error` を `console.warn` に変更。Lighthouse の `errors-in-console` 監査はエラーレベルのログを検出するため、warn に下げることで Best Practices の減点を回避。

### 不採用案

| 不採用案 | 理由 |
|---------|------|
| `$effect` にガードクロージャーを追加 | 循環依存を隠蔽するだけで根本解決にならない。直接初期化のほうがシンプルで安全 |
| `articlePrefetcher.seedCache()` 内で callback を `queueMicrotask` に defer | ループは断ち切れるが、$effect 自体が不要な reactive binding を作る点は変わらない |
| `transition:fade` を CSS animation に置換 | 全面的なスタイル書き換えが必要。LCP 要素の visibility には遷移効果自体が不要 |

## 結果・影響

### 動作確認

| 確認項目 | 結果 |
|---------|------|
| `bun run check` | 正常（既存のテスト型エラーのみ、新規エラーなし） |
| nginx config test | `nginx -t` 成功、warn なし |
| gzip 確認 (`/sv/feeds/...`) | `Content-Encoding: gzip` あり |
| gzip 非適用確認 (`/sv/api/...`) | `Content-Encoding: gzip` なし |
| SSR HTML サイズ | ~8KB（削減前 ~48KB） |
| コンテナ再ビルド+起動 | healthy |

### 期待効果

| メトリクス | Phase 2 後 | Phase 3 後 (予測) | 根拠 |
|-----------|-----------|------------------|------|
| FCP | 2.5s (0.69) | ~1.5s (0.92) | gzip + HTML サイズ削減 |
| LCP | 3.6s (0.62) | ~2.5s (0.85) | transition:fade 削除 + $effect ループ解消 |
| TBT | 201ms (0.89) | ~150ms (0.95) | $effect ループ解消で JS 実行時間削減 |
| SI | 2.6s (0.97) | ~2.5s (0.97) | 大きな変化なし |
| CLS | 0 (1.0) | 0 (1.0) | 変化なし |
| **Performance** | **84** | **~91-93** | |
| **Best Practices** | **77** | **~85** | errors-in-console 解消 |

### PROS

- gzip による転送サイズ削減は SSR ページ全体に適用され、visual-preview 以外のページにも恩恵がある
- `$effect` → 直接初期化は、Svelte 5 の reactive primitives のベストプラクティスに沿った設計（初期化は一度きり、reactive tracking は不要）
- ストリーミングパターンは SvelteKit 組み込み機能を利用しており、追加依存なし
- LCP テキスト要素の `transition:fade` 削除は視覚的影響が最小（ファーストビューで既に表示されているコンテンツ）

### CONS, TRADEOFF

- nginx location 分割により、`/sv/api/` と `/sv/` で proxy 設定が重複する。今後の変更時に両方のメンテナンスが必要
- ストリーミング化により、初回カードの記事コンテンツが即座に利用できない場合がある（Promise 解決前にユーザーがスクロールすると、クライアント側で再取得が走る）。ただし `articlePrefetcher` が並行して取得するため、実用上の影響は軽微
- `state_referenced_locally` の Svelte コンパイラ警告が 4 件発生する。これは意図的な設計（初期値のみキャプチャ）であり、動作に問題はないが、将来の Svelte バージョンで挙動が変わる可能性を意識する必要がある

## 付録

### 変更ファイル一覧

| ファイル | 変更 |
|---------|------|
| `nginx/conf.d/default.conf` | `/sv/` を `/sv/api/` (gzip off) と `/sv/` (gzip on) に分割 |
| `.../visual-preview/+page.server.ts` | `articleData` を Promise として返却（ストリーミング化） |
| `.../visual-preview/+page.svelte` | `onMount` で Promise 解決、`cacheSeeded` ガード追加 |
| `.../swipe/SwipeFeedScreen.svelte` | `$effect` 初期化 → `$state` 直接初期化、console.error → warn |
| `.../swipe/VisualPreviewCard.svelte` | LCP テキスト要素の `transition:fade` 削除、console.error → warn |

### LCP 要素の変遷

```
Phase 1: <img> (OGP 画像) — Resource Load Delay 7s
Phase 2: <div.text-sm> (description テキスト) — Element Render Delay 678ms
Phase 3: <div.text-sm> (description テキスト) — transition:fade 削除で即時表示
```

### 参考資料

- [Optimize LCP - web.dev](https://web.dev/articles/optimize-lcp)
- [Common misconceptions about how to optimize LCP](https://web.dev/blog/common-misconceptions-lcp)
- [Lighthouse Performance Scoring](https://developer.chrome.com/docs/lighthouse/performance/performance-scoring)
- [SvelteKit Streaming](https://svelte.dev/docs/kit/load#Streaming-with-promises)
- [Svelte 5 Runes — $effect](https://svelte.dev/docs/svelte/$effect)
- [nginx gzip module](https://nginx.org/en/docs/http/ngx_http_gzip_module.html)
