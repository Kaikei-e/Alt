# Augur ChatフロントエンドをREST/SSEからConnect-RPCへ移行

## ステータス

承認済み（2026-01-29）

## 背景

モバイルフロントエンドのAugur Chat機能（RAGを活用した対話型検索）で、ユーザーが利用しようとすると403エラーが返されていた。調査の結果、以下が判明した：

1. `ChatWindow.svelte`がレガシーREST APIエンドポイント（`/api/v1/augur/chat`）を呼び出していた
2. このエンドポイントはバックエンドのSSEエンドポイント（`/sse/v1/rag/answer`）にリクエストをプロキシしていた
3. バックエンドのSSEエンドポイントにはCSRF保護があり、ブラウザからのリクエストを拒否していた
4. 一方、AugurServiceは既にConnect-RPC（`alt.augur.v2.AugurService`）に移行済みだった

既存のConnect-RPCインフラは完全に機能していたが、ChatWindowコンポーネントがそれを使用するように更新されていなかった。

## 決定事項

### 移行戦略

レガシーSSEエンドポイントのCSRF問題を修正するのではなく、Connect-RPCへの移行を完了させることを決定した：

1. **既存インフラの活用**: `$lib/connect/augur.ts`の`streamAugurChat`関数は既に実装・テスト済み
2. **一貫性**: 他のフロントエンド機能（フィード、記事、要約）は既にConnect-RPCを使用
3. **デッドコードの削除**: レガシーRESTプロキシエンドポイントが不要に

### 実装アプローチ

1. **ChatWindow.svelteの更新**: fetchベースのSSE消費を`streamAugurChat`に置き換え
2. **型定義の整合**: Citation型をPascalCase（`URL`, `Title`）からcamelCase（`url`, `title`）に変更し、Connect-RPCレスポンスに合わせる
3. **レガシーエンドポイントの削除**: 未使用の`/api/v1/augur/chat`プロキシを削除

## 結果・影響

### 変更内容

| コンポーネント | ファイル | 変更内容 |
|-----------|------|--------|
| alt-frontend-sv | `ChatWindow.svelte` | REST/SSE fetchをConnect-RPCクライアント`streamAugurChat`に置き換え |
| alt-frontend-sv | `ChatWindow.svelte` | Citation型のフィールド名をcamelCaseに更新 |
| alt-frontend-sv | `routes/api/v1/augur/chat/+server.ts` | **削除** - レガシーSSEプロキシは不要に |

### リクエストフローの比較

**移行前（動作せず）**:
```
Browser → /sv/api/v1/augur/chat → alt-backend:/sse/v1/rag/answer → CSRFエラー (403)
```

**移行後（動作）**:
```
Browser → /sv/api/v2/alt.augur.v2.AugurService/StreamChat → alt-butterfly-facade → rag-orchestrator (Connect-RPC)
```

### メリット

- **Augur Chatが動作**: ユーザーがRAGを活用したチャット機能を利用可能に
- **プロトコルの統一**: フロントエンド・バックエンド間の通信がすべてConnect-RPCに
- **コード削減**: レガシーRESTプロキシエンドポイントを削除
- **ストリーミング改善**: Connect-RPCが構造化されたイベントタイプ（delta、meta、done、fallback、error）を提供
- **型安全性**: 生成されたprotobuf型による完全なTypeScript型チェック

### デメリット・トレードオフ

- **レガシークライアントへの破壊的変更**: `/api/v1/augur/chat`を使用する外部ツールは更新が必要（現時点で該当なし）

## 付録

### 動作確認コマンド

```bash
# フロントエンドを再ビルドして再起動
docker compose -f compose/compose.yaml -p alt build alt-frontend-sv
docker compose -f compose/compose.yaml -p alt up -d alt-frontend-sv

# フロントエンドのログでConnect-RPCリクエストを確認
docker compose -f compose/compose.yaml -p alt logs -f alt-frontend-sv
# 期待される出力: [Connect-RPC Proxy] Request received: { path: 'alt.augur.v2.AugurService/StreamChat' }

# rag-orchestratorのログでチャット処理を確認
docker compose -f compose/compose.yaml -p alt logs -f rag-orchestrator | grep augur
# 期待される出力: starting augur stream chat → augur stream chat completed
```

### 主要なコード変更

```typescript
// 変更前: REST/SSE
const response = await fetch(`${base}/api/v1/augur/chat`, {
  method: "POST",
  body: JSON.stringify({ messages }),
});
await processAugurStreamingText(response.body.getReader(), onText, options);

// 変更後: Connect-RPC
const transport = createClientTransport();
streamAugurChat(
  transport,
  { messages },
  onDelta,    // テキストチャンク
  onThinking, // 推論（オプション）
  onMeta,     // 引用
  onComplete, // 最終結果
  onFallback, // 証拠不十分
  onError,    // エラーハンドリング
);
```

### 関連ADR

- ADR-155: RAG用LLMをgpt-oss:20bからqwen3:14bへ移行（rag-orchestratorのモデル変更）
