# otelslogブリッジのTrace Context属性フォールバック対応

## ADR's STATUS

Accepted

## CONTEXT

### 背景

ADR-122で実装したTraceContextHandlerにより、stdout出力のJSONログにはtrace_id/span_idが含まれるようになった。しかし、OTLPエクスポート経路でも依然としてGrafanaでTraceId/SpanIdがゼロ表示される問題が残っていた。

### 問題の原因

公式の`go.opentelemetry.io/contrib/bridges/otelslog`ブリッジには以下の制約がある：

- trace contextを**ログ属性(attributes)**として追加する
- **OTLPプロトコルレベルの`trace_id`/`span_id`フィールドには設定しない**

```
現在のフロー:
┌────────────────────────────────────────────────────────────────┐
│ Go Application (with valid trace context)                      │
│ └─→ otelslog bridge                                            │
│     └─→ Adds trace_id/span_id as ATTRIBUTES only:              │
│         • log_attributes["trace_id"] = "abc123..."             │
│     └─→ DOES NOT populate:                                     │
│         • record.trace_id (protocol field) = [] (empty!)       │
│                                                                │
│ ↓ OTLP Export                                                  │
│                                                                │
│ rask-log-aggregator/converter.rs                               │
│ └─→ trace_id: encode_trace_id(&record.trace_id)  ← empty!      │
│     └─→ Returns "00000000000000000000000000000000"             │
│                                                                │
│ ↓ ClickHouse → Grafana shows all zeros                         │
└────────────────────────────────────────────────────────────────┘
```

### 検討した選択肢

| 選択肢 | 説明 | 評価 |
|-------|------|------|
| A. Go SDKでカスタムLogProcessor実装 | LoggerProviderにプロトコルフィールド設定用のプロセッサを追加 | 複雑、全サービスに変更必要 |
| B. rask-log-aggregatorで属性フォールバック | 属性からtrace_id/span_idを取得 | シンプル、1箇所の変更で完結 |

## DECISION MAKING

**選択肢B**を採用。rask-log-aggregatorのconverter.rsで、プロトコルフィールドが空の場合に属性からフォールバック取得する。

### 実装

```rust
fn convert_single_log(...) -> OTelLog {
    let log_attrs = convert_attributes(&record.attributes);

    // Protocol fields first, then fallback to attributes (for otelslog bridge compatibility)
    let trace_id = if record.trace_id.is_empty() || record.trace_id.iter().all(|&b| b == 0) {
        log_attrs
            .get("trace_id")
            .cloned()
            .unwrap_or_else(|| "0".repeat(32))
    } else {
        encode_trace_id(&record.trace_id)
    };

    let span_id = if record.span_id.is_empty() || record.span_id.iter().all(|&b| b == 0) {
        log_attrs
            .get("span_id")
            .cloned()
            .unwrap_or_else(|| "0".repeat(16))
    } else {
        encode_span_id(&record.span_id)
    };

    // ...
}
```

### 優先順位

1. **プロトコルフィールド優先**: 正規のOTLPプロトコルフィールドに値があれば使用
2. **属性フォールバック**: プロトコルフィールドが空/ゼロの場合のみ属性から取得
3. **デフォルト値**: どちらにも値がない場合はゼロ文字列

## RESULTS, EFFECTS

### 変更ファイル

| サービス | ファイル | 変更内容 |
|---------|---------|---------|
| rask-log-aggregator | `otlp/converter.rs` | 属性フォールバックロジック追加 |

### 追加テスト

| テスト名 | 検証内容 |
|---------|---------|
| `test_convert_single_log_fallback_to_attributes` | 空のプロトコルフィールドで属性から取得 |
| `test_convert_single_log_prefers_protocol_fields` | プロトコルフィールド優先を確認 |
| `test_convert_single_log_zero_protocol_fields_fallback` | ゼロ埋めフィールドで属性フォールバック |
| `test_convert_single_log_no_trace_context` | どちらもない場合のデフォルト値 |

### PROS

1. **最小限の変更**: rask-log-aggregatorの1ファイルのみ
2. **全Goサービス対応**: 個別サービスの変更不要
3. **後方互換性**: プロトコルフィールド優先で既存動作を維持
4. **テスト完備**: 4つのテストケースで網羅

### CONS, TRADEOFF

1. **otelslog依存**: otelslogが属性名を変更した場合は追従が必要
2. **軽微なオーバーヘッド**: 属性マップの検索処理（フォールバック時のみ）

## APPENDIX

### 検証方法

```bash
# 1. テスト実行
cd rask-log-aggregator/app && cargo test

# 2. コンテナ再ビルド・デプロイ
docker compose -f compose/compose.yaml -p alt build rask-log-aggregator
docker compose -f compose/compose.yaml -p alt up -d rask-log-aggregator

# 3. ログ生成
curl http://localhost:9000/v1/health

# 4. ClickHouseで確認
docker compose exec clickhouse clickhouse-client \
  --query "SELECT trace_id, span_id, body FROM otel_logs ORDER BY timestamp DESC LIMIT 10"
```

### 関連リソース

- [otelslog package - Go Packages](https://pkg.go.dev/go.opentelemetry.io/contrib/bridges/otelslog)
- [OpenTelemetry Log Data Model](https://opentelemetry.io/docs/specs/otel/logs/data-model/)
- ADR-122: Grafana Trace/Log表示問題の修正
