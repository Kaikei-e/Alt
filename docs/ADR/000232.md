# ADR-000232: TTS サーバーストリーミング化・ボイス変更・速度変更

## STATUS

Accepted（実装完了・17 件の TTS 関連ユニットテスト全件 PASS・lint/type-check 全 PASS・コンテナ再ビルド完了）

## CONTEXT

ADR-231 で Recap ページの TTS 音読機能を unary RPC (`Synthesize`) で実装した。運用で以下の課題が判明した。

1. **初回応答の遅延**: unary RPC はテキスト全体を合成し終えてから応答を返すため、長文の場合にユーザーが最初の音声を聞くまでの待ち時間が長い
2. **クライアント側チャンク分割の冗長性**: `splitTextForTts()` でフロントエンドがテキストを 5000 文字ごとに分割し、チャンクごとに unary RPC を呼び出していた。文の途中で分割されるリスクがあり、分割ロジックの保守負担もあった
3. **ボイスと速度の最適化**: デフォルトボイス `jf_alpha` およびデフォルト速度 `1.0` を、ユーザーフィードバックに基づき `jf_gongitsune` / `1.25` に変更したい

### 技術的前提

- proto に `rpc SynthesizeStream(SynthesizeRequest) returns (stream SynthesizeResponse)` が定義済み
- tts-speaker は `synthesize_stream` を実装済み（文ごとに完全な WAV チャンクを yield）
- フロントエンドの生成コード `tts_pb.ts` には `synthesizeStream` が未反映
- BFF の `streamingProcedures` マップに TTS パスが未登録

## DECISION MAKING

### サーバーストリーミングへの切り替え

クライアント側チャンク分割（`splitTextForTts`）を廃止し、サーバー側で文単位にチャンクする `SynthesizeStream` RPC に一本化した。

**理由:**

1. **Time-to-first-audio の短縮**: サーバーが最初の文を合成し終えた時点で即座にクライアントに WAV を返す。残りの文は並行して合成・送信される
2. **分割品質の向上**: サーバー（tts-speaker）は自然言語処理で文境界を検出するため、文字数ベースのハードカットが不要
3. **フロントエンドの簡素化**: `splitTextForTts()` の依存と分割ロジックが不要になり、`useTtsPlayback` フックがシンプルになった

### デフォルト値の変更

| 設定 | 変更前 | 変更後 | 理由 |
|------|--------|--------|------|
| voice | `jf_alpha` | `jf_gongitsune` | 自然さとイントネーションの改善 |
| speed | `1.0` | `1.25` | ニュースサマリーの聴取に適したテンポ |

### 変更方針

4 箇所の変更で完結する小規模な改修とした。

1. **Proto 再生成**: `buf generate` で `synthesizeStream` をフロントエンドの型定義に反映
2. **BFF**: `streamingProcedures` に TTS ストリーミングパスを登録
3. **Connect クライアント**: `synthesizeSpeechStream()` async generator を追加、デフォルト値を変更
4. **再生フック**: `for await` ループで WAV チャンクを逐次受信・再生

## RESULTS

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/src/lib/gen/alt/tts/v1/tts_pb.ts` | `buf generate` で再生成。`synthesizeStream` (methodKind: `server_streaming`) が追加 |
| `alt-butterfly-facade/internal/handler/proxy_handler.go` | `streamingProcedures` に `/alt.tts.v1.TTSService/SynthesizeStream` を追加 |
| `alt-frontend-sv/src/lib/connect/tts.ts` | `DEFAULT_VOICE` / `DEFAULT_SPEED` 変更、`synthesizeSpeechStream()` 追加 |
| `alt-frontend-sv/src/lib/connect/index.ts` | `synthesizeSpeechStream` エクスポート追加 |
| `alt-frontend-sv/src/lib/hooks/useTtsPlayback.svelte.ts` | unary → streaming に書き替え、`splitTextForTts` 依存を除去 |
| `alt-frontend-sv/src/lib/connect/tts.test.ts` | デフォルト値の期待値更新、ストリーミングテスト 3 件追加 |
| `alt-frontend-sv/src/lib/hooks/useTtsPlayback.test.ts` | ストリーミングモックに書き替え |

### アーキテクチャ

```
RecapDetail.svelte (UI)
  └── useTtsPlayback.svelte.ts (状態管理・再生制御)
        └── tts.ts → synthesizeSpeechStream()
              └── Connect-RPC (server_streaming)
                    └── BFF (streamingProcedures)
                          └── tts-speaker (synthesize_stream)
```

### 再生フローの変化

**Before (ADR-231: unary)**
```
フロント: splitTextForTts(text) → [chunk1, chunk2, ...]
  for each chunk:
    Synthesize(chunk) → 完全WAV → 再生
```

**After (ADR-232: streaming)**
```
フロント: synthesizeSpeechStream(text)
  for await (chunk of stream):
    WAVチャンク受信 → 即座に再生
```

### テスト結果

```
17 TTS-related tests passed (365 total across 28 files)
```

| テストファイル | 件数 | カバー範囲 |
|-------------|------|-----------|
| `tts.test.ts` | 9 | unary / stream のデフォルト値・カスタム値・エラー伝播 |
| `useTtsPlayback.test.ts` | 8 | 初期状態、ストリーミング再生、空テキスト、エラー状態、マルチチャンク、停止 |

## PROS

1. **Time-to-first-audio の短縮**: サーバーが最初の文を合成した時点で再生が始まる。長文でも体感待ち時間が大幅に減少
2. **分割品質の向上**: サーバー側の自然言語処理による文境界検出に一本化。文字数ハードカットが不要に
3. **フロントエンドの簡素化**: `splitTextForTts()` の依存を除去。`useTtsPlayback` のコード量が減少し保守性が向上
4. **後方互換性**: unary `synthesizeSpeech()` と `splitTextForTts()` はそのまま残存しており、他の呼び出し元があれば引き続き利用可能

## CONS, TRADEOFF

1. **ストリーミング接続の維持**: 長文再生中は HTTP/2 ストリームが維持される。ネットワーク断が発生した場合、途中から再開する仕組みは未実装
2. **サーバー依存の分割**: チャンク粒度がサーバー実装に依存する。フロントエンドからチャンクサイズを制御する手段がない
3. **デフォルト値のハードコード**: voice / speed は定数で埋め込み。UI からの選択機能は将来課題として残る
