# ADR-000217: auth-token-manager トークン API 応答バグの修正 - サービス間トークン連携の復旧

## STATUS

Accepted（実装完了・テスト全通・コンテナ再ビルド・動作確認済み）

## CONTEXT

### 背景

pre-processor-sidecar が Inoreader API からの記事取得に失敗していた。エラーメッセージ:

```
remote token fetch failed: OAuth2 token not found in storage
```

auth-token-manager 自体は正常に動作し、トークンのリフレッシュも成功していた。しかし pre-processor-sidecar の `RemoteTokenRepository`（Go）が auth-token-manager の `/api/token` エンドポイントから取得したレスポンスに `access_token` フィールドが含まれず、空文字列として解釈され `ErrTokenNotFound` が発生していた。

### 根本原因分析

3 つの問題を特定:

| # | 問題 | 影響度 |
|---|------|--------|
| 1 | `/api/token` が `INTERNAL_AUTH_TOKEN` 環境変数未設定時にメタデータのみ返す | **Critical** — サービス間トークン連携が完全に機能しない |
| 2 | `.env` ファイルパーサーが値に含まれる `=` 文字を切り捨てる | **Latent** — Base64 パディング付きトークンで発生しうる |
| 3 | トークンファイルのパーミッションが `0o600`（所有者のみ） | **Secondary** — UID が異なるコンテナ間でのファイルベースアクセスに影響 |

### 問題 1 の詳細

`/api/token` ハンドラに 2 つの応答分岐が存在:

- `INTERNAL_AUTH_TOKEN` 設定時: フルトークンデータを返す（正常）
- `INTERNAL_AUTH_TOKEN` 未設定時: `has_access_token`, `has_refresh_token` 等のメタデータのみ返す（バグ）

Docker Compose 内部ネットワーク上では `INTERNAL_AUTH_TOKEN` を設定せずに運用しており、常にメタデータのみの応答となっていた。

### 問題 2 の詳細

JavaScript の `String.split("=", 2)` は Go の `strings.SplitN("=", 2)` と異なる挙動をする:

```javascript
// JavaScript: limit は結果配列の最大長。2番目の = 以降が切り捨てられる
"KEY=val=ue".split("=", 2)  // → ["KEY", "val"]

// Go: N は分割数。2番目以降の = は最後の要素に含まれる
strings.SplitN("KEY=val=ue", "=", 2)  // → ["KEY", "val=ue"]
```

## DECISION MAKING

### 方針

TDD ワークフローに従い、3 つの修正それぞれに対してテストを先に書く（RED → GREEN → REFACTOR）。

### 修正 1: `/api/token` 応答の統一

`INTERNAL_AUTH_TOKEN` の有無による応答分岐を削除し、常にフルトークンデータを返す。

- Docker Compose 内部ネットワーク上のサービス間通信であり、セキュリティリスクは限定的
- `INTERNAL_AUTH_TOKEN` 設定時の認証チェック（401 応答）は維持

### 修正 2: `.env` パーサーの `=` 文字処理

`split("=", 2)` を `indexOf("=")` + `substring()` に置き換え、値に含まれる `=` を保持する。

### 修正 3: ファイルパーミッション

`chmod 0o600` を `chmod 0o644` に変更。異なる UID で動作するコンテナからの読み取りを許可する。

## RESULTS

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `auth-token-manager/src/handler/oauth_server.ts` | `handleTokenApi()` の `if (!expectedToken)` 分岐を削除。常にフルトークンデータを返す |
| `auth-token-manager/src/gateway/env_file_secret_manager.ts` | `.env` パーサーを `indexOf` ベースに変更。`chmod` を `0o644` に変更 |
| `auth-token-manager/tests/unit/handler/oauth_server_test.ts` | 新規作成。4 テストケース |
| `auth-token-manager/tests/unit/gateway/env_file_secret_manager_test.ts` | 3 テストケース追加 |

### テスト結果

| テスト | 結果 |
|--------|------|
| `deno test --allow-all` | 12 passed (45 steps), 0 failed |

### 新規テストケース

| テストファイル | テストケース |
|--------------|-------------|
| `oauth_server_test.ts` | `INTERNAL_AUTH_TOKEN` 未設定時にフルトークンデータを返す |
| `oauth_server_test.ts` | トークンデータ不在時に 404 を返す |
| `oauth_server_test.ts` | `INTERNAL_AUTH_TOKEN` 設定時に誤ったヘッダで 401 を返す |
| `oauth_server_test.ts` | `INTERNAL_AUTH_TOKEN` 設定時に正しいヘッダでフルトークンデータを返す |
| `env_file_secret_manager_test.ts` | `=` を含むトークン値を正しく読み取る |
| `env_file_secret_manager_test.ts` | `=` を含むトークン値の書き込み・読み取りラウンドトリップ |
| `env_file_secret_manager_test.ts` | ファイルパーミッションが `0o644` であることを検証 |

### コンテナ検証

| 検証 | 結果 |
|------|------|
| `docker compose build auth-token-manager` | 成功 |
| コンテナ起動 | Up（正常起動・トークンモニタリング開始） |
| `curl http://localhost:9201/api/token` | `access_token` フィールドを含むフルトークンデータを返却（200 OK） |
| pre-processor-sidecar 再起動後 | `OAuth2 token not found in storage` エラー解消 |

## PROS

1. **サービス間トークン連携の復旧**: pre-processor-sidecar が auth-token-manager から正常にトークンを取得できるようになり、Inoreader API からの記事取得が復旧
2. **API 応答の一貫性**: `INTERNAL_AUTH_TOKEN` の設定有無に関わらず同一の応答形式となり、クライアント側の実装が簡素化
3. **Base64 トークン互換性**: `.env` パーサーが `=` パディングを含むトークン値を正しく処理するようになり、潜在的なトークン破損を防止
4. **クロスコンテナ互換性**: ファイルパーミッション `0o644` により、異なる UID で動作するコンテナ間でのトークンファイル共有が可能
5. **テストカバレッジ向上**: `/api/token` エンドポイントに対する初のユニットテストを追加し、回帰を防止

## CONS, TRADEOFF

1. **認証なしでのトークン応答**: `INTERNAL_AUTH_TOKEN` 未設定時、ネットワークアクセス可能な全クライアントにフルトークンを返す。Docker Compose 内部ネットワーク前提の設計であり、外部公開環境では `INTERNAL_AUTH_TOKEN` の設定が必須
2. **ファイルパーミッション緩和**: `0o600` → `0o644` により、同一ホスト上の全ユーザーがトークンファイルを読み取り可能になる。コンテナ環境では実質的なリスクは低いが、ベアメタル環境では考慮が必要

## APPENDIX

### `/api/token` 応答の変更

```
変更前（INTERNAL_AUTH_TOKEN 未設定時）:
  {"has_access_token": true, "has_refresh_token": true, "expires_at": "...", "token_type": "Bearer"}

変更後（常に）:
  {"access_token": "...", "refresh_token": "...", "expires_at": "...", "token_type": "Bearer", "scope": "...", "updated_at": "..."}
```

### `.env` パーサーの変更

```
変更前: String.split("=", 2)   → "KEY=val=ue" → ["KEY", "val"]（値が切り詰め）
変更後: String.indexOf("=")    → "KEY=val=ue" → key="KEY", value="val=ue"（完全な値を保持）
```
