# ADR-000247: 要約パイプライン修正 — APIモードにおける `ListUnsummarizedArticles` RPC の追加

## ステータス

承認済み

## コンテキスト

### 問題

pre-processor を APIモード（ADR-000246）に移行した後、要約パイプラインが機能しなくなった。データベースに未要約記事が82件存在するにもかかわらず、pre-processor の10秒ポーリングループは常に `processed:0` を返し、news-creator サービスへのリクエストが一切送信されていなかった。

### 根本原因

pre-processor は環境変数 `BACKEND_API_URL` の有無によって2つのモードで動作する：

- **DBモード**（レガシー）: `pgxpool` 経由で `articles` / `article_summaries` テーブルを直接クエリ
- **APIモード**: Connect-RPC 経由で alt-backend と通信

APIモードでは、2つの重要なメソッドが空の結果を返すようハードコードされていた：

```go
// article_driver.go (APIモード)
func (r *ArticleRepository) FindForSummarization(...) ([]*domain.Article, *domain.Cursor, error) {
    return nil, nil, nil  // 常に空を返す
}

func (r *ArticleRepository) HasUnsummarizedArticles(...) (bool, error) {
    return false, nil  // 常にfalseを返す
}
```

元の設計では、Redis Stream イベント（`ArticleCreated` / `SummarizeRequested`）により要約がトリガーされる想定だったが、これらのイベントは一度もパブリッシュされていなかった。これにより、3つの要約パスすべてが機能しない状態となった：

| パス | 状態 | 原因 |
|------|------|------|
| ポーリング（`FindForSummarization`） | 機能停止 | ハードコードされた空の戻り値 |
| イベント駆動（Redis Streams） | 機能停止 | イベント未パブリッシュ |
| ジョブキュー（`GetPendingJobs`） | 機能停止 | ジョブ未登録 |

### 影響

- APIモードでの新規記事要約の生成がゼロ
- ダッシュボードの未要約カウントが単調増加
- news-creator へのリクエストがヘルスチェックのみ

## 意思決定

### 採用アプローチ: `ListUnsummarizedArticles` RPC の追加

イベント駆動パスの実装（複数サービスの変更と Redis Stream インフラの構築が必要）ではなく、新しい Connect-RPC エンドポイントを通じて既存のポーリングパターンを公開する方式を選択した。理由は以下の通り：

1. **既存の移行パターンに準拠** — `ListUntaggedArticles`（tag-generator）および `FindArticlesWithSummaries`（quality checker）と同じアプローチ
2. **新規インフラ不要** — Redis Stream の変更や新しいイベント型が不要
3. **即時検証可能** — ログ出力とダッシュボードメトリクスで確認可能
4. **同じバッチポーリングセマンティクスを維持** — DBモードの pre-processor が既に使用しているものと同一

### 検討した代替案: イベント駆動型要約

以下の理由で今回の修正では不採用：
- `CreateArticle` RPC での `ArticleCreated` イベントパブリッシュが必要
- pre-processor に新たな Redis Stream コンシューマーの追加が必要
- 既存の未処理82件の記事に対しては効果がない
- 後日最適化として追加可能（ブロッカーではない）

## 結果・影響

### 変更概要

**Proto 層**（2ファイル）：
- `UnsummarizedArticle` メッセージ、`ListUnsummarizedArticles` RPC（キーセットページネーション）、`HasUnsummarizedArticles` RPC を `BackendInternalService` に追加
- `services/backend/v1` と `clients/preprocessor-backend/v1` の両方の proto 定義に反映

**alt-backend**（7ファイル）：
- **Driver**: `ListUnsummarizedArticles()` — `NOT EXISTS (SELECT 1 FROM article_summaries)` + キーセットページネーション、`HasUnsummarizedArticles()` — `SELECT EXISTS`
- **Port**: `ListUnsummarizedArticlesPort` および `HasUnsummarizedArticlesPort` インターフェース
- **Gateway**: Driver から Port への型変換
- **Handler**: `WithSummarizationPorts()` ハンドラーオプション（追加的変更、既存コンストラクタへの破壊的変更なし）
- **Server 配線**: ハンドラー初期化に `WithSummarizationPorts(gw, gw)` を追加

**pre-processor**（1ファイル変更）：
- `return nil, nil, nil` スタブを `ListUnsummarizedArticles` および `HasUnsummarizedArticles` への Connect-RPC 呼び出しに置換

### アーキテクチャ

```
pre-processor (APIモード)
  FindForSummarization()
    → Connect-RPC: ListUnsummarizedArticles
      → alt-backend Handler
        → Gateway
          → Driver (SQL: articles LEFT JOIN article_summaries)
    → []*domain.Article (キーセットカーソル付き)
    → news-creator /api/v1/summarize
    → Connect-RPC: SaveArticleSummary
```

### テストカバレッジ

| パッケージ | 新規テスト数 | 対象 |
|-----------|-------------|------|
| `alt-backend/connect/v2/internal` | 8テスト | Handler: 成功、カーソル、エラー、未実装（両RPC） |
| `pre-processor/driver/backend_api` | 6テスト | RPC呼び出し: 成功、カーソル転送、エラー伝播 |

### メリット

- 即時修正：デプロイ後数秒で要約パイプラインが復旧
- ゼロダウンタイム：Proto/Handler の追加的変更のみ、マイグレーション不要
- パターンの一貫性：`ListUntaggedArticles` や `FindArticlesWithSummaries` と同じアプローチ
- 後方互換性：`WithSummarizationPorts` はオプショナル。省略時は `CodeUnimplemented` を返す

### デメリット・トレードオフ

- ポーリング方式：記事の到着頻度に関わらず pre-processor が10秒ごとにポーリング（現在のスケールでは許容範囲）
- イベント駆動パス未実装：新規記事は次のポーリングサイクルまで要約が開始されない
- ポーリングサイクルごとに2クエリ（`ListUnsummarizedArticles` + `HasUnsummarizedArticles`）が発生。イベントトリガーなら1回で済む可能性がある

## 付録

### 検証

コンテナの再ビルド・再起動後：

```
pre-processor: "summarizing article", "article_id":"e099f075-..."
pre-processor: "Making request to news-creator API", "api_url":"http://news-creator:11434/api/v1/summarize"
news-creator:  "Received summarize request", "article_id":"e099f075-..."
news-creator:  "Ollama generation completed", "eval_count":7, "duration":56.96s"
```

### SQL クエリ（Driver）

```sql
-- ListUnsummarizedArticles（初回ページ）
SELECT a.id, a.title, a.content, a.url, a.created_at, a.user_id
FROM articles a
WHERE NOT EXISTS (SELECT 1 FROM article_summaries s WHERE s.article_id = a.id)
ORDER BY a.created_at DESC, a.id DESC
LIMIT $1

-- ListUnsummarizedArticles（2ページ目以降、キーセットページネーション）
SELECT a.id, a.title, a.content, a.url, a.created_at, a.user_id
FROM articles a
WHERE NOT EXISTS (SELECT 1 FROM article_summaries s WHERE s.article_id = a.id)
  AND (a.created_at, a.id) < ($1, $2)
ORDER BY a.created_at DESC, a.id DESC
LIMIT $3
```

### 関連ADR

- ADR-000241: 共有データベース・アンチパターンの解消戦略
- ADR-000244: article-sync パイプライン概要とデータソース分類
- ADR-000245: 未登録フィードに対する `UpsertArticles` の耐障害性向上
- ADR-000246: pre-processor-db 分離 — alt-db 依存の完全排除
