# ADR-124/125実装完了: Trace Context伝搬問題の修正

## ADR's STATUS

Implemented

## CONTEXT

### 背景

ADR-124/125で「Accepted」となっていたtrace context伝搬対応について、実装調査を行った結果、複数の未実装箇所が発見された。GrafanaダッシュボードでTraceId/SpanIdが全てゼロ表示される問題の根本原因として、以下の3つが特定された。

### 問題1: OTLPエンドポイント設定のポート誤り

```
# 誤った設定
OTEL_EXPORTER_OTLP_ENDPOINT=http://rask-log-aggregator:9600

# 正しい設定
OTEL_EXPORTER_OTLP_ENDPOINT=http://rask-log-aggregator:4318
```

ポート9600はrask-log-forwarder向けの内部API用であり、GoサービスのOTLP HTTP Exporterは4318を使用する必要があった。

### 問題2: mq-hubでlogger.Init()が未使用

mq-hubのmain.goで、TraceContextHandlerをラップするlogger.Init()が呼ばれておらず、直接slog.NewJSONHandler()を使用していた。

### 問題3: slog呼び出しでContextが渡されていない

多くのGoサービスで`slog.Info()`が使用されており、`slog.InfoContext(ctx, ...)`形式になっていなかった。context.Contextが渡されないと、TraceContextHandlerがspan contextを取得できない。

## DECISION MAKING

### Phase 1: OTLPポート修正

compose/.envのOTLPエンドポイントを9600から4318に修正。

### Phase 2: mq-hub logger修正

```go
// Before
logger := slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
    Level: slog.LevelInfo,
}))

// After
logger.Init()  // TraceContextHandlerでラップ
```

### Phase 3: slog呼び出しのContext対応

全Goサービスで`slog.Xxx()`を`slog.XxxContext(ctx, ...)`に置換。

対象サービス:
- mq-hub
- alt-butterfly-facade
- auth-hub
- rag-orchestrator
- search-indexer
- alt-backend
- pre-processor

### Phase 4: ClickHouseマイグレーション適用

migration 011（TraceId/SpanIdカラム追加）を本番環境に適用。

## RESULTS, EFFECTS

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| compose/.env | OTLPポート 9600→4318 |
| mq-hub/app/main.go | logger.Init()使用、slog.XxxContext()に変更 |
| alt-butterfly-facade/main.go | slog.XxxContext()に変更 |
| auth-hub/main.go | slog.XxxContext()に変更 |
| rag-orchestrator/cmd/server/main.go | slog.XxxContext()に変更 |
| rag-orchestrator/internal/usecase/rag_answer_stream.go | slog.InfoContext()に変更 |
| search-indexer/app/server/indexer_server.go | slog.ErrorContext()に変更 |
| search-indexer/app/config/config.go | slog.XxxContext()に変更 |
| alt-backend/app/utils/secure_http_client.go | slog.InfoContext()に変更 |
| pre-processor/app/driver/ssl_config.go | slog.XxxContext()に変更 |

### 修正後のデータフロー

```
Go Service
  ↓ slog.InfoContext(ctx, ...) でログ出力
TraceContextHandler
  ↓ span contextからtrace_id/span_idを抽出してログに付与
  ↓ JSON stdout: {"trace_id":"abc...", "span_id":"def...", ...}
Docker logs
  ↓
rask-log-forwarder
  ↓ fieldsからtrace_id/span_idを抽出→専用フィールドに格納
rask-log-aggregator
  ↓ string_to_fixed_bytes変換でClickHouse形式に
ClickHouse logs.TraceId / logs.SpanId
  ↓
Grafana
  → 有効なtrace_id/span_id表示
```

### PROS

1. **OTLPエンドポイント修正**: GoサービスのOTLP ExporterがraskLog-aggregatorに正しく接続
2. **trace context完全伝搬**: stdout経路でもtrace_id/span_idが保持される
3. **コード統一**: 全Goサービスでslog.XxxContext()パターンを採用
4. **ビルド検証済み**: 全サービスでビルド成功を確認

### CONS, TRADEOFF

1. **コード変更量**: 9ファイル、約40箇所のslog呼び出し変更
2. **context.Background()使用**: main()内の初期化ログでは有効なspan contextがないため、起動時ログにはtrace_idが含まれない（期待動作）

## APPENDIX

### 検証手順

```bash
# 1. サービスビルド
docker compose -f compose/compose.yaml -p alt build \
  mq-hub rag-orchestrator alt-butterfly-facade auth-hub \
  search-indexer alt-backend pre-processor

# 2. サービス起動
docker compose -f compose/compose.yaml -p alt up -d

# 3. ログ確認（リクエスト時にtrace_idが出力されることを確認）
docker compose logs mq-hub --tail=20 | grep trace_id

# 4. ClickHouseデータ確認
docker compose exec clickhouse clickhouse-client \
  --user rask_db_user --password <password> --database rask_logs \
  --query "SELECT TraceId, SpanId, service_name FROM logs WHERE TraceId != '' ORDER BY timestamp DESC LIMIT 10"
```

### 関連ADR

- ADR-122: Grafana Trace/Log表示問題の修正
- ADR-123: otelslogブリッジのTrace Context属性フォールバック対応
- ADR-124: ログパイプラインのTrace Context伝搬完全対応
- ADR-125: Grafana/ClickHouse連携のためのtrace_id/span_id伝搬対応
