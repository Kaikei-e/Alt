# ADR-000257: FeedSourceExcludeFilter の listSubscriptions リクエスト未送信バグ修正

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000256 で導入したフィードソース除外フィルタ (`FeedSourceExcludeFilter`) において、ドメイン名を入力してもオートコンプリート候補がマッチしない不具合が発生した。ブラウザの Network タブで確認したところ、`ListSubscriptions` RPC リクエスト自体が送信されていなかった。

### 原因分析

`src/lib/api/client/feeds.ts` の `listSubscriptionsClient()` が `listSubscriptions` を動的 import (`await import(...)`) で取得していたが、同モジュール (`$lib/connect/feeds`) は別の箇所で静的 import されており、Vite のプロダクションビルド時にツリーシェイクが発生していた。

静的 import に含まれていない `listSubscriptions` がバンドルから除去され、動的 import が同一チャンクを参照した結果 `undefined` が返却されていた。

**失敗の流れ:**

1. Vite が `$lib/connect/feeds` バレルをツリーシェイク（静的 import に含まれない `listSubscriptions` を除去）
2. 動的 import が同チャンクを参照 → `listSubscriptions` が `undefined`
3. `undefined(transport)` → TypeError
4. `onMount` の `try/catch` で無音に失敗、`feedSources` は空配列のまま
5. 入力しても候補がマッチしない

### 影響

- フィードソース除外フィルタが完全に機能しない状態
- ユーザーへのエラー表示がなく、UI 上は単にマッチしないように見える

## 意思決定

### 修正方針: 静的 import への統一

`listSubscriptions` を静的 import に追加し、動的 import を除去する。同ファイル内の他の関数（`getUnreadFeeds`, `getAllFeeds` 等）と同じパターンに統一。

```typescript
// Before:
import {
    getUnreadFeeds, getAllFeeds, getReadFeeds, getFavoriteFeeds,
    searchFeeds as searchFeedsConnect,
    type ConnectFeedItem, type ConnectFeedSource,
} from "$lib/connect/feeds";

// After:
import {
    getUnreadFeeds, getAllFeeds, getReadFeeds, getFavoriteFeeds,
    searchFeeds as searchFeedsConnect,
    listSubscriptions,                    // 追加
    type ConnectFeedItem, type ConnectFeedSource,
} from "$lib/connect/feeds";
```

```typescript
// Before:
export async function listSubscriptionsClient(): Promise<ConnectFeedSource[]> {
    const transport = createClientTransport();
    const { listSubscriptions } = await import("$lib/connect/feeds");
    return listSubscriptions(transport);
}

// After:
export async function listSubscriptionsClient(): Promise<ConnectFeedSource[]> {
    const transport = createClientTransport();
    return listSubscriptions(transport);
}
```

### 検討した代替案

| 案 | 不採用理由 |
|---|-----------|
| 動的 import のパスを別チャンクに分離 | Vite の内部挙動に依存し、ビルド設定変更で再発リスクがある |
| `listSubscriptions` を別ファイルに切り出して単独 import | ファイル分割が不要な複雑さを追加する。他の関数と同じパターンが最もシンプル |
| `/* @vite-ignore */` や `sideEffects` 設定で除去を抑制 | バンドラ固有のワークアラウンドであり、根本解決にならない |

### 同ファイル内の他の動的 import について

`markAsRead`, `getFeedStats`, `getDetailedFeedStats`, `getUnreadCount`, `subscribe`, `unsubscribe` も同じ動的 import パターンを使用しているが、これらは静的 import に含まれていないため独立したチャンクとして生成される。`listSubscriptions` のみ、静的 import 済みバレルとの衝突が問題だった。今後これらの関数も静的 import に統一することを推奨するが、本 ADR のスコープでは影響範囲を最小限にするため `listSubscriptions` のみ修正した。

## 結果・影響

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/src/lib/api/client/feeds.ts` | `listSubscriptions` を静的 import に追加、動的 import を除去 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `bun run check` (TypeScript/Svelte 型検査) | 0 errors, 0 warnings |
| `bun test -- FeedSourceExcludeFilter.spec.ts` | 10/10 パス |
| コンテナ再ビルド (`alt-frontend-sv`) | healthy |

### PROS

- 1 ファイル 2 行の最小変更で根本原因を修正
- 他の関数と同じ静的 import パターンに統一され、一貫性が向上
- ツリーシェイクによる再発リスクを排除

### CONS, TRADEOFF

- `listSubscriptions` が初期バンドルに含まれるようになるが、関数サイズが小さく影響は無視できる
- 同ファイル内の他の動的 import（`markAsRead` 等）は今回修正していない（現時点で問題は発生していないが、将来的に同様の衝突が起きる可能性がある）

### 影響範囲

- **alt-frontend-sv**: `feeds.ts` のみ。他のページ・コンポーネントへの影響なし
- **バックエンド**: 変更なし
- **他サービス**: 変更なし

## 関連 ADR

- ADR-000256: フィードソース除外フィルタ (Feeds ページ)
