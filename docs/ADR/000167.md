# Tag Trail機能の追加

## ADR's STATUS

Accepted

## CONTEXT

RSSフィードから記事を購読するユーザーにとって、興味のあるトピックを効率的に探索する手段が必要だった：

1. **記事発見の課題**: フィード単位での購読では、特定のトピックに関連する記事を横断的に探すことが困難
2. **タグ活用の不足**: tag-generatorで自動生成されたタグがあるにもかかわらず、タグベースのナビゲーション機能がなかった
3. **モバイルUXの改善**: モバイルユーザー向けに、直感的なタグ探索インターフェースが求められていた

### 既存アーキテクチャ

- tag-generator: KeyBERT/sentence-transformersによる記事タグ自動生成（バッチ処理）
- alt-backend: Clean Architecture (Go/Echo)
- alt-frontend-sv: SvelteKit + TailwindCSS

## DECISION MAKING

### 方針

**Tag Trail（タグトレイル）**機能を新規追加。ユーザーがタグを選択すると、そのタグに関連する記事一覧を表示し、タグからタグへと「トレイル」を辿れるナビゲーション体験を提供。

### 実装範囲

#### Phase 1: ドメインモデル追加 (alt-backend)

```go
// domain/tag_trail.go
type TagTrail struct {
    Tag      *FeedTag
    Articles []*Article
}
```

#### Phase 2: データアクセス層 (alt-backend)

- `FetchArticleTags`: 記事IDからタグ一覧を取得
- `FetchArticlesByTag`: タグIDから関連記事一覧を取得
- `FetchRandomFeed`: `feeds`テーブルからランダムフィード取得（探索起点用、title/description/link含む）

#### Phase 3: Clean Architectureレイヤー (alt-backend)

各機能について以下のレイヤーを実装：

| レイヤー | ディレクトリ | 役割 |
|---------|-------------|------|
| Port | `port/<feature>_port/` | インターフェース定義 |
| Gateway | `gateway/<feature>_gateway/` | ビジネスロジック実装 |
| Driver | `driver/alt_db/` | データベースアクセス |
| Usecase | `usecase/<feature>_usecase/` | ユースケース実装 |
| Handler | `rest/rest_feeds/` | HTTPハンドラ |

#### Phase 4: RESTエンドポイント (alt-backend)

```go
// rest/article_handlers.go
articles.GET("/by-tag", handleFetchArticlesByTag)      // ?tag_id=xxx
articles.GET("/:id/tags", handleFetchArticleTags)

// rest/rest_feeds/routes.go
rss.GET("/random", RestHandleFetchRandomSubscription)
```

#### Phase 5: フロントエンド (alt-frontend-sv)

- APIクライアント: `src/lib/api/client/tagTrail.ts`
- スキーマ定義: `src/lib/schema/tagTrail.ts`
- BFFエンドポイント: `src/routes/api/feeds/random/+server.ts`
- モバイルページ: `src/routes/mobile/feeds/tag-trail/`
- ナビゲーション: `FloatingMenu.svelte`に"Explore"セクション追加（Tag Trailへのリンク）

## RESULTS, EFFECTS

### 変更ファイル一覧

| コンポーネント | ファイル | 変更内容 |
|--------------|---------|---------|
| alt-backend | `domain/tag_trail.go` | TagTrailドメインモデル新規作成 |
| alt-backend | `driver/alt_db/fetch_article_tags_driver.go` | タグ取得Driver新規作成 |
| alt-backend | `driver/alt_db/fetch_articles_by_tag_driver.go` | タグ別記事取得Driver新規作成 |
| alt-backend | `driver/alt_db/fetch_random_feed_link_driver.go` | `FetchRandomFeed()`追加 - `feeds`テーブルからtitle/description/link取得 |
| alt-backend | `port/fetch_article_tags_port/` | ポート定義新規作成 |
| alt-backend | `port/fetch_articles_by_tag_port/` | ポート定義新規作成 |
| alt-backend | `port/fetch_random_subscription_port/` | ポート定義 - `*domain.Feed`を返す |
| alt-backend | `gateway/fetch_article_tags_gateway/` | ゲートウェイ新規作成 |
| alt-backend | `gateway/fetch_articles_by_tag_gateway/` | ゲートウェイ新規作成 |
| alt-backend | `gateway/fetch_random_subscription_gateway/` | ゲートウェイ - `FetchRandomFeed()`を呼び出し |
| alt-backend | `usecase/fetch_article_tags_usecase/` | ユースケース新規作成 |
| alt-backend | `usecase/fetch_articles_by_tag_usecase/` | ユースケース新規作成 |
| alt-backend | `usecase/fetch_random_subscription_usecase/` | ユースケース - `*domain.Feed`を返す |
| alt-backend | `rest/rest_feeds/routes.go` | ルーティング追加 |
| alt-backend | `rest/rest_feeds/random_subscription.go` | ハンドラ - title/descriptionを含むレスポンス |
| alt-backend | `rest/article_handlers.go` | 記事タグ関連ハンドラ追加 |
| alt-backend | `di/container.go` | DI設定追加 |
| alt-frontend-sv | `src/lib/api/client/tagTrail.ts` | APIクライアント新規作成 |
| alt-frontend-sv | `src/lib/schema/tagTrail.ts` | スキーマ定義新規作成 |
| alt-frontend-sv | `src/routes/api/feeds/random/+server.ts` | BFFエンドポイント新規作成 |
| alt-frontend-sv | `src/routes/mobile/feeds/tag-trail/` | モバイルページ新規作成 |
| alt-frontend-sv | `src/lib/components/mobile/tag-trail/` | コンポーネント新規作成 |
| alt-frontend-sv | `src/lib/components/mobile/feeds/swipe/FloatingMenu.svelte` | "Explore"セクション追加 |

### 新規APIエンドポイント

| サービス | パス | メソッド | 用途 |
|---------|------|---------|------|
| alt-backend | `/v1/articles/:id/tags` | GET | 記事のタグ一覧取得 |
| alt-backend | `/v1/articles/by-tag?tag_id=xxx` | GET | タグに関連する記事一覧取得 |
| alt-backend | `/v1/rss-feed-link/random` | GET | ランダムフィード取得（title/description含む） |
| alt-frontend-sv | `/api/feeds/random` | GET | BFF: ランダムフィード取得 |

### レスポンス形式

```json
// GET /v1/rss-feed-link/random
{
  "feed": {
    "id": "uuid",
    "url": "https://example.com",        // feeds.link (サイトURL)
    "title": "Feed Title",               // feeds.title
    "description": "Feed description"    // feeds.description
  }
}
```

### PROS

1. **トピック横断探索**: フィードを超えてトピックベースで記事を探索可能
2. **タグ資産活用**: 既存のtag-generator出力を活用
3. **直感的なUI**: タグをタップして関連記事を辿る自然なUX
4. **Clean Architecture準拠**: 既存パターンに従った実装で保守性を維持
5. **モバイル最適化**: スワイプ/タップ中心の操作性

### CONS, TRADEOFF

1. **初回ロード**: タグが未生成の記事では機能が制限される
2. **タグ品質依存**: ML生成タグの品質がUXに直結
3. **追加クエリ**: 記事表示時にタグ取得の追加クエリが発生

## APPENDIX

### 検証コマンド

```bash
# 記事タグ取得
curl http://localhost:9000/v1/articles/{article-id}/tags

# タグ別記事一覧
curl "http://localhost:9000/v1/articles/by-tag?tag_id={tag-id}"

# ランダムフィード（title/description含む）
curl http://localhost:9000/v1/rss-feed-link/random
# 期待: {"feed":{"id":"...", "url":"...", "title":"...", "description":"..."}}

# テスト実行
cd alt-backend/app && go test ./...
cd alt-frontend-sv && bun run check && bun run build
```

### アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                    Frontend (SvelteKit)                          │
│  ┌────────────────────────────────────────────────────────┐     │
│  │ FloatingMenu (Explore → Tag Trail)                     │     │
│  │ /mobile/feeds/tag-trail                                │     │
│  │  ┌──────────────────────────────────────────────────┐  │     │
│  │  │ [Random Feed Card]                               │  │     │
│  │  │   Title: "Tech News"                             │  │     │
│  │  │   Description: "Latest tech updates"             │  │     │
│  │  │   Tags: [tech] [ai] [ml]  ← tap to explore       │  │     │
│  │  └──────────────────────────────────────────────────┘  │     │
│  └────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      alt-backend (Echo REST)                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Handler → Usecase → Gateway → Driver                     │   │
│  │                                                          │   │
│  │ GET /v1/articles/:id/tags          → FetchArticleTags    │   │
│  │ GET /v1/articles/by-tag?tag_id=xxx → FetchArticlesByTag  │   │
│  │ GET /v1/rss-feed-link/random       → FetchRandomFeed     │   │
│  │     (returns: id, title, description, link from feeds)   │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      alt-db (PostgreSQL)                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ feeds (id, title, description, link)                     │   │
│  │ article_tags, feed_tags, articles                        │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 関連ADR

- ADR-168: オンザフライタグ生成実装
- ADR-169: Tag Trail記事検索の改善（タグ名検索への変更）
