# BFF (Backend For Frontend) 機能拡充

## ADR's STATUS

Accepted

## CONTEXT

### 背景

alt-butterfly-facadeはフロントエンド（alt-frontend-sv）とバックエンド（alt-backend）間のBFFレイヤーとして機能する。従来は単純なプロキシとして動作していたが、以下の課題に対応するためBFF機能を拡充した。

### 解決すべき課題

| 課題 | 影響 |
|------|------|
| 同一リクエストの重複実行 | バックエンドへの不要な負荷 |
| バックエンド障害時の連鎖障害 | フロントエンドのUX低下 |
| 頻繁にアクセスされるデータの再取得 | レイテンシ増加 |
| エラーレスポンスの形式不統一 | フロントエンドのエラーハンドリング複雑化 |
| ダッシュボード表示時の複数API呼び出し | ラウンドトリップ増加 |

## DECISION MAKING

### 実装機能

5つのBFF機能を実装:

#### 1. レスポンスキャッシュ

ユーザー単位のLRUキャッシュでバックエンドへのリクエストを削減。

```
キャッシュキー = userID:endpoint:sha256(body)[:16]
```

| 設定 | デフォルト値 |
|------|-------------|
| 最大エントリ数 | 1000 |
| TTL | エンドポイント別（15-30秒） |

キャッシュ対象:
- `GetDetailedFeedStats` (30s)
- `GetUnreadCount` (15s)
- `GetFeedStats` (30s)

キャッシュ除外:
- ストリーミングエンドポイント
- ミューテーション（Create/Update/Delete/Mark）

#### 2. サーキットブレーカー

バックエンド障害時にリクエストを遮断し、連鎖障害を防止。

```
状態遷移: CLOSED → (5連続失敗) → OPEN → (30秒) → HALF_OPEN → (2連続成功) → CLOSED
```

| 設定 | デフォルト値 |
|------|-------------|
| 失敗閾値 | 5回 |
| 成功閾値 | 2回 |
| オープンタイムアウト | 30秒 |

#### 3. リクエスト重複排除 (Dedup)

同一ユーザーからの同一リクエストを集約し、バックエンドへは1回のみ送信。

```
重複判定キー = userID:method:path:sha256(body)[:16]
```

| 設定 | デフォルト値 |
|------|-------------|
| 重複判定ウィンドウ | 100ms |

#### 4. エラー正規化

バックエンドエラーを統一フォーマットに変換し、フロントエンドのエラーハンドリングを簡素化。

```json
{
  "code": "BACKEND_UNAVAILABLE",
  "message": "Backend service is temporarily unavailable",
  "is_retryable": true,
  "retry_after": 5,
  "request_id": "20260205120000.123456"
}
```

エラーコード:
- `BACKEND_UNAVAILABLE` - 502
- `SERVICE_UNAVAILABLE` - 503
- `RATE_LIMIT_EXCEEDED` - 429
- `INVALID_TOKEN` - 401
- `GATEWAY_TIMEOUT` - 504

#### 5. リクエストアグリゲーション

複数のクエリを1リクエストで並列実行。

```json
// Request
POST /bff/aggregate
{
  "queries": ["feed_stats", "unread_count", "detailed_feed_stats"]
}

// Response
{
  "results": {
    "feed_stats": { "data": {...}, "status_code": 200 },
    "unread_count": { "data": {...}, "status_code": 200 },
    "detailed_feed_stats": { "data": {...}, "status_code": 200 }
  }
}
```

## RESULTS, EFFECTS

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                   alt-butterfly-facade                  │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌────────────┐  │
│  │ Circuit │→ │ Dedup   │→ │ Cache   │→ │ Backend    │  │
│  │ Breaker │  │ Handler │  │ Check   │  │ Forward    │  │
│  └─────────┘  └─────────┘  └─────────┘  └────────────┘  │
│                      │                         │        │
│                      ▼                         ▼        │
│               ┌────────────┐           ┌────────────┐   │
│               │ Error      │           │ Response   │   │
│               │ Normalizer │           │ Cache      │   │
│               └────────────┘           └────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 変更ファイル

| ファイル | 内容 |
|---------|------|
| `internal/cache/response_cache.go` | LRUキャッシュ実装 |
| `internal/resilience/circuit_breaker.go` | サーキットブレーカー実装 |
| `internal/handler/dedup_handler.go` | リクエスト重複排除 |
| `internal/handler/error_normalizer.go` | エラー正規化 |
| `internal/handler/aggregation_handler.go` | リクエストアグリゲーション |
| `internal/handler/bff_handler.go` | BFFハンドラー統合 |
| `config/config.go` | 設定管理 |

### PROS

1. **レイテンシ削減**: キャッシュヒット時はバックエンド呼び出しをスキップ
2. **負荷軽減**: 重複排除によりバックエンドへのリクエスト数を削減
3. **耐障害性向上**: サーキットブレーカーで連鎖障害を防止
4. **UX向上**: エラー正規化でリトライ可否が明確に
5. **ラウンドトリップ削減**: アグリゲーションで複数クエリを1リクエストに

### CONS, TRADEOFF

1. **キャッシュ整合性**: TTL期間中は古いデータが返される可能性
2. **メモリ使用量増加**: キャッシュと重複排除用のメモリが必要
3. **複雑性増加**: BFFレイヤーの責務が増加

## APPENDIX

### 設定値

全機能はデフォルトで有効化。設定値はハードコード。

```go
// BFF Feature Flags (all enabled by default)
EnableCache:              true,
EnableCircuitBreaker:     true,
EnableDedup:              true,
EnableErrorNormalization: true,

// Hardcoded configuration values
CacheMaxSize:       1000,
CacheDefaultTTL:    30 * time.Second,
CBFailureThreshold: 5,
CBSuccessThreshold: 2,
CBOpenTimeout:      30 * time.Second,
DedupWindow:        100 * time.Millisecond,
```

### テストカバレッジ

各コンポーネントに対してユニットテストを実装:

- `response_cache_test.go` - キャッシュ操作、LRU eviction、TTL
- `circuit_breaker_test.go` - 状態遷移、閾値
- `dedup_handler_test.go` - 重複排除、並行処理
- `error_normalizer_test.go` - エラーマッピング
- `aggregation_handler_test.go` - 並列フェッチ
- `bff_handler_test.go` - 統合テスト

### ヘルスチェック

```bash
curl http://localhost:9250/health
# {"status":"healthy","service":"alt-butterfly-facade"}
```

### レスポンスヘッダー

キャッシュ状態はレスポンスヘッダーで確認可能:

- `X-Cache: HIT` - キャッシュから応答
- `X-Cache: MISS` - バックエンドから取得
