# Feed Search: 無限スクロール Pagination 修正

## ADR's STATUS

Accepted

## CONTEXT

### 背景

Feed Search の無限スクロールが動作しない問題の根本原因を特定・修正した。
ADR-143 で追加したデバッグログにより、以下の状態が判明:

```
resultsCount: 20, nextCursor: null, hasMore: false
```

20件取得しているのに `hasMore: false` となっていた。

### 根本原因分析

| レイヤー | 問題 | 詳細 |
|----------|------|------|
| search-indexer | LIMIT ハードコード | `const LIMIT = 20` で固定、offset/limit パラメータ未使用 |
| Proto | total_count 欠如 | `SearchArticlesResponse` に `estimated_total_hits` フィールドなし |
| alt-backend driver | pagination 未対応 | offset/limit を渡していない |
| alt-backend gateway | totalCount 計算誤り | `totalCount := len(hits)` で返却件数を使用 |

### 結果

- Meilisearch は `estimatedTotalHits: 100` を返しても、それが伝播しない
- Gateway は `totalCount = 20` (返却件数) を使用
- `hasMore = 0 + 20 < 20` = `false` となり、追加読み込み不可

## DECISION MAKING

### 検討したアプローチ

| Option | 内容 | 評価 |
|--------|------|------|
| A: End-to-End Pagination | Proto から Gateway まで全レイヤーで pagination 対応 | **採用** |
| B: Frontend-only workaround | 常に `hasMore: true` として空応答で終了判定 | 不採用 (無駄なリクエスト) |
| C: 大きな LIMIT 設定 | LIMIT を 1000 に増加 | 不採用 (スケーラビリティ問題) |

**採用理由**: Meilisearch の `estimatedTotalHits` を正しく伝播させることで、正確な pagination が可能になる。

## RESULTS, EFFECTS

### 修正ファイル

#### Proto

| ファイル | 変更内容 |
|----------|----------|
| `proto/clients/search/v2/search.proto` | `estimated_total_hits` フィールド追加 |
| `proto/services/search/v2/search.proto` | `estimated_total_hits` フィールド追加 |

#### search-indexer

| ファイル | 変更内容 |
|----------|----------|
| `app/search_engine/meilisearch.go` | `SearchArticlesWithPagination()` 関数追加 |
| `app/connect/v2/search/handler.go` | offset/limit パラメータ使用、`EstimatedTotalHits` 返却 |

#### alt-backend

| ファイル | 変更内容 |
|----------|----------|
| `app/port/search_indexer_port/search_indexer_port.go` | `SearchArticlesWithPagination()` メソッド追加 |
| `app/driver/search_indexer_connect/client.go` | pagination 対応メソッド実装 |
| `app/driver/search_indexer/search_indexer_driver.go` | HTTP ドライバーのフォールバック実装 |
| `app/gateway/feed_search_gateway/search_feed_meilisearch_gateway.go` | `estimatedTotalHits` を `totalCount` として使用 |

### データフロー (修正後)

```
Frontend
    │ offset=0, limit=20
    ▼
alt-backend Gateway
    │ SearchArticlesWithPagination(offset, limit)
    ▼
search-indexer Handler
    │ SearchArticlesWithPagination(offset, limit)
    ▼
Meilisearch
    │ Search(offset=0, limit=20)
    │ Returns: hits[20], estimatedTotalHits=100
    ▼
search-indexer
    │ Response: hits[20], estimated_total_hits=100
    ▼
alt-backend
    │ totalCount = 100 (estimatedTotalHits)
    │ hasMore = 0 + 20 < 100 = true
    ▼
Frontend
    resultsCount: 20, nextCursor: 20, hasMore: true
```

### PROS

1. **正確な Pagination**: Meilisearch の `estimatedTotalHits` を正しく使用
2. **効率的なクエリ**: 必要な件数のみ取得 (全件取得してスライスしない)
3. **後方互換性**: 既存の非 pagination API は維持
4. **テスト追加**: pagination 動作を検証するユニットテスト追加

### CONS, TRADEOFF

1. **Proto 再生成必要**: `buf generate` の実行が必要
2. **複数サービス変更**: search-indexer と alt-backend の両方を更新・デプロイ必要

## APPENDIX

### デプロイ手順

```bash
# Proto 再生成
cd proto && buf generate --template buf.gen.search-indexer.yaml
cd proto && buf generate --template buf.gen.alt-backend-clients.yaml

# ビルド・デプロイ
docker compose -f compose/compose.yaml -p alt build search-indexer alt-backend
docker compose -f compose/compose.yaml -p alt up -d search-indexer alt-backend
```

### 検証方法

1. ブラウザ DevTools でコンソールを開く
2. 20件以上ヒットするクエリで検索
3. コンソールで以下を確認:

```
# 期待されるログ (修正後)
[SearchWindow:handleSearch] API response {resultsCount: 20, nextCursor: 20, hasMore: true}
```

4. スクロールまたは「Load More」ボタンで追加読み込みを確認

### テスト実行

```bash
# search-indexer
cd search-indexer/app
go test ./...

# alt-backend
cd alt-backend/app
go test ./gateway/feed_search_gateway/... -v
```
