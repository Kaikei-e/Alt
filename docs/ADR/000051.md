# Dockerダングリングイメージ削減対策

## ADR's STATUS

**承認済み（Accepted）** - 2026年1月3日

## CONTEXT

### 背景

Dockerのダングリングイメージが大量に生成される問題が発生していた。
既に定期的な清掃の仕組み（docker-cleanup.sh）は存在するが、
そもそも大量に無駄なイメージが生成される根本原因を調査・修正する必要があった。

### 調査で判明した原因

| 原因 | 深刻度 | 影響 |
|------|--------|------|
| 複数の未使用Dockerfileバリアント | 高 | tag-generatorに4つのバリアント存在 |
| news-creator-volume-initの二重ビルド | 中 | 同じDockerfileを2回ビルド |
| tag-generatorのモデル毎回ダウンロード | 中 | キャッシュが効かずビルド時間延長 |
| `--force-rm`フラグの誤用 | - | BuildKitでは無効（調査で判明） |

### BuildKitと--force-rmフラグについて

当初、`altctl build`に`--force-rm`フラグを追加しようとしたが、
調査の結果、**BuildKitでは`--force-rm`と`--rm`フラグは無効**であることが判明。

| ビルダー | `--force-rm`の効果 |
|---------|---------------------|
| レガシービルダー | 有効（中間コンテナを削除） |
| **BuildKit（Docker 23.0+デフォルト）** | **効果なし** |

BuildKitはLLB（Low-Level Build）を使用し、レガシービルダーのような
中間コンテナを作成しないアーキテクチャのため、これらのフラグは不要。

ダングリングイメージは**中間コンテナ**からではなく、
**同じタグでイメージを再ビルド**した際に古いイメージがタグを失うことで発生する。

## DECISION

以下の対策を実施する。

### 1. 未使用Dockerfileバリアントの削除

**削除対象:**
- `tag-generator/Dockerfile.tag-generator-v2`
- `tag-generator/Dockerfile.tag-generator-balanced`
- `tag-generator/Dockerfile.tag-generator-ultra-minimal`

**残すもの:**
- `tag-generator/Dockerfile.tag-generator`（本番使用）

### 2. news-creator-volume-initの二重ビルド解消

`compose/ai.yaml`を修正し、chown専用の軽量イメージを使用。

```yaml
# Before: 同じDockerfileを2回ビルド
news-creator-volume-init:
  build:
    context: ../news-creator
    dockerfile: Dockerfile.creator

# After: 軽量alpineイメージを使用
news-creator-volume-init:
  image: alpine:3.21
```

### 3. tag-generatorのモデルダウンロードにBuildKitキャッシュ導入

`tag-generator/Dockerfile.tag-generator`を修正し、
NLTK/HuggingFaceモデルのダウンロードにBuildKitキャッシュマウントを使用。

```dockerfile
# Before: キャッシュなし
RUN python - <<'PY'
import nltk
...
PY

# After: BuildKitキャッシュマウント使用
RUN --mount=type=cache,target=/tmp/hf_cache \
    --mount=type=cache,target=/tmp/nltk_cache \
    HF_HOME=/tmp/hf_cache NLTK_DATA=/tmp/nltk_cache python - <<'PY' && \
    cp -r /tmp/hf_cache /root/.cache/huggingface && \
    cp -r /tmp/nltk_cache /root/nltk_data
import nltk
...
PY
```

### 4. docker-cleanup.timerの実行頻度向上

`scripts/docker-cleanup.timer`の実行頻度を1時間から30分に変更。

```ini
# Before
OnUnitActiveSec=1h

# After
OnUnitActiveSec=30min
```

### 5. recap-subworkerのDockerfile修正

`uv pip install`の前に仮想環境が存在しない問題を修正。

```dockerfile
# 追加
RUN uv venv

# 既存（仮想環境が必要）
RUN --mount=type=cache,id=uv-recap-subworker,target=/root/.cache/uv \
    uv pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
```

## RESULTS

### 期待される改善

| 指標 | Before | After |
|------|--------|-------|
| 未使用Dockerfileバリアント | 3ファイル | 0ファイル |
| news-creatorビルド回数/起動 | 2回 | 1回 |
| モデルダウンロード | 毎回 | キャッシュ再利用 |
| クリーンアップ頻度 | 1時間 | 30分 |

### ベストプラクティス

ダングリングイメージ対策として推奨されるアプローチ:

1. **事後的なクリーンアップ**: `docker image prune`の定期実行
2. **不要なDockerfileの削除**: 使用されないバリアントは削除
3. **ビルドの重複排除**: 同じイメージの複数回ビルドを回避
4. **BuildKitキャッシュ活用**: 大きなダウンロードにはキャッシュマウントを使用

**非推奨:**
- `--force-rm`/`--rm`フラグの追加（BuildKitでは無効）

## 変更ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `tag-generator/Dockerfile.tag-generator-v2` | 削除 |
| `tag-generator/Dockerfile.tag-generator-balanced` | 削除 |
| `tag-generator/Dockerfile.tag-generator-ultra-minimal` | 削除 |
| `compose/ai.yaml` | news-creator-volume-initをalpineに変更 |
| `tag-generator/Dockerfile.tag-generator` | BuildKitキャッシュマウント追加 |
| `scripts/docker-cleanup.timer` | 実行頻度を30分に変更 |
| `recap-subworker/Dockerfile.recap-subworker` | `uv venv`追加 |

## RELATED

- [BuildKit | Docker Docs](https://docs.docker.com/build/buildkit/)
- [Prune unused Docker objects | Docker Docs](https://docs.docker.com/config/pruning/)
- [docker build (legacy builder) | Docker Docs](https://docs.docker.com/reference/cli/docker/build-legacy/)
- [BuildKit Issue #1470 - --rm flag behavior](https://github.com/moby/buildkit/issues/1470)
