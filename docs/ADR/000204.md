# 3-day Recap バッチタイムアウト修正

## ADR's STATUS

Accepted (実装完了・デプロイ済み)

## CONTEXT

### 問題点

3-day Recap タスクが頻繁に失敗。バッチ HTTP タイムアウト (1800s) に対し、10 ジャンル × 階層 Map-Reduce (各 3-12 LLM 呼び出し) の推定処理時間が 2250s を超過していた。

```
recap-worker (Rust)
  ├── バッチ: 10 genres/chunk
  │     └── 各 genre: 階層 Map-Reduce (3-12 LLM calls)
  │           └── 推定処理時間: ~225s/genre × 10 = 2250s
  └── バッチ HTTP タイムアウト: summary_timeout × 3 = 1800s (固定)
      → 2250s > 1800s → タイムアウト
```

| # | 原因 | 影響 |
|---|------|------|
| 1 | バッチチャンクサイズ 10 genres が大きすぎる | 処理時間がタイムアウトを超過 |
| 2 | バッチタイムアウトが固定 3 倍 (ジャンル数非考慮) | ジャンル数に対してタイムアウトが不十分 |
| 3 | トークン予算 60K が過大 | news-creator 側で 12K chars に切り捨てられ大部分が無駄 |
| 4 | クラスタ上限 40 が過大 | 階層 Map-Reduce 発動率が高く処理時間増大 |

### ADR-000203 との関係

ADR-000203 では news-creator 側のキュー管理を改善した。本 ADR はその上流にあたる recap-worker 側のバッチ送信パラメータを最適化し、タイムアウト超過の根本原因に対処する。

## DECISION MAKING

### 方針

3 段階 (P0/P1/P2) で段階的に修正。P0 で即座にタイムアウト超過を解消し、P1 で耐障害性を向上、P2 で不要なリソース消費を削減する。

### P0: バッチチャンクサイズ削減とタイムアウト延長

#### チャンクサイズ 10 → 3

`RECAP_BATCH_SUMMARY_CHUNK_SIZE` のデフォルトを `10` → `3` に変更。

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| デフォルト値 | 10 | 3 |
| 推定処理時間/チャンク | ~2250s | ~675s |
| 根拠 | — | 3 genres/chunk で 1800s タイムアウトを十分下回る |

#### LLM タイムアウト 600s → 900s

`LLM_SUMMARY_TIMEOUT_SECS` のデフォルトを `600` → `900` に変更。

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| デフォルト値 | 600s | 900s |
| 根拠 | — | 階層 Map-Reduce (3-12 LLM 呼び出し) に対する余裕を確保 |

コード側 (`config.rs`) と Compose 設定 (`compose/recap.yaml`) の両方でデフォルトを同期。

### P1: 動的バッチタイムアウト計算

**課題**: バッチタイムアウトが `summary_timeout * 3` の固定倍率で、ジャンル数に関係なく一定だった。チャンクサイズを変更してもタイムアウトが追従しない。

**対策**: ジャンル数に基づく動的計算に変更。

```rust
// Before
let batch_timeout = self.summary_timeout * 3;

// After
let per_genre_timeout = self.summary_timeout;
let batch_timeout = per_genre_timeout * std::cmp::max(3, request_count as u32);
```

最小倍率 3 を設け、少数ジャンルでも十分なタイムアウトを確保。チャンクサイズ 3 + タイムアウト 900s の場合、バッチタイムアウトは `900 × 3 = 2700s` となり、推定処理時間 675s に対して十分な余裕がある。

### P2: トークン予算・クラスタ上限削減

**課題**: recap-worker が 1 ジャンルあたり最大 60,000 トークン・40 クラスタを送信していたが、news-creator 側は `MAX_CLUSTER_SECTION_LENGTH=12,000 chars` (~3K tokens) で切り捨てるため、送信データの大部分が無駄に破棄されていた。クラスタ数が多いと階層 Map-Reduce が発動し、処理時間がさらに増大。

**対策**:

| パラメータ | 変更前 | 変更後 | 根拠 |
|-----------|--------|--------|------|
| `TOTAL_TOKEN_BUDGET` | 60,000 | 12,000 | news-creator の切り捨て上限に合わせて事前削減 |
| `MAX_CLUSTERS` | 40 | 15 | 階層 Map-Reduce 発動率を下げてタイムアウトリスク軽減 |

`MIN_CLUSTER_BUDGET` (200) は変更なし。

## RESULTS, EFFECTS

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `compose/recap.yaml` | `RECAP_BATCH_SUMMARY_CHUNK_SIZE` 10→3, `LLM_SUMMARY_TIMEOUT_SECS` 追加 (900s) |
| `recap-worker/recap-worker/src/config.rs` | デフォルト 10→3 |
| `recap-worker/recap-worker/src/clients/news_creator/client.rs` | 動的タイムアウト計算, テスト追加 |
| `recap-worker/recap-worker/src/clients/news_creator/builder.rs` | `TOTAL_TOKEN_BUDGET` 60K→12K, `MAX_CLUSTERS` 40→15 |
| `recap-worker/ENVIRONMENT.md` | ドキュメント更新 |

### 期待される効果

| 指標 | 修正前 | 修正後 |
|------|--------|--------|
| バッチチャンクサイズ | 10 genres/chunk | 3 genres/chunk |
| バッチ HTTP タイムアウト | 1800s (固定) | 2700s (動的, 3 genres × 900s) |
| 推定処理時間/チャンク | ~2250s | ~675s |
| タイムアウト超過リスク | 高 (2250 > 1800) | 低 (675 < 2700) |
| トークン送信量/genre | 60K tokens | 12K tokens |
| クラスタ上限/genre | 40 | 15 |

### PROS

- **テスト全パス**: 278 テスト (recap-worker) が全パス。新規テスト `batch_timeout_scales_with_request_count` を追加
- **設定反映確認**: コンテナ内で `RECAP_BATCH_SUMMARY_CHUNK_SIZE=3`, `LLM_SUMMARY_TIMEOUT_SECS=900` を確認
- **ヘルスチェック**: リビルド後に recap-worker が healthy 状態で起動
- **タイムアウト安全マージン**: 推定処理時間 675s に対してタイムアウト 2700s (約 4 倍の余裕)
- **リソース効率**: 不要なトークン送信 (48K tokens/genre) を削減し、ネットワーク・LLM 処理の負荷を軽減

### CONS, TRADEOFF

- **API 呼び出し回数の増加**: チャンクサイズ 10→3 により、30 ジャンルの場合のバッチ API 呼び出しが 3 回→10 回に増加。ただし各呼び出しの信頼性は大幅に向上
- **クラスタ削減による情報損失**: 40→15 クラスタに制限することで、小規模クラスタの情報が要約に含まれなくなる可能性がある。ただし、size 降順でソート後の上位 15 件を選択するため、重要度の高いクラスタは保持される
- **トークン予算削減の影響**: 60K→12K で各クラスタに割り当てられるトークン数が減少。代表文の選択がより厳しくなるが、news-creator 側の切り捨てと整合するため実質的な情報損失はない

### 検証方法

```bash
# テスト実行
cd recap-worker/recap-worker && cargo test

# 設定値確認 (コンテナ内)
docker compose -f compose/compose.yaml -p alt exec recap-worker env | \
  grep -E 'RECAP_BATCH_SUMMARY_CHUNK_SIZE|LLM_SUMMARY_TIMEOUT_SECS'

# ログ監視 (デプロイ後)
docker compose -f compose/compose.yaml -p alt logs recap-worker -f | \
  grep -E 'batch.*summary|chunk|timeout|failed|error'
```
