# FeedDetailModal 外部リンク・Prefetcher 空 URL 不具合の修正

## ADR's STATUS

Accepted

## CONTEXT

### 問題

フロントエンド (`alt-frontend-sv`) のコンソールに以下のエラーが断続的に発生:

```
[ArticlePrefetcher] Failed to prefetch content: ConnectError: [invalid_argument] url is required
POST /alt.articles.v2.ArticlesService/FetchArticleContent 400 (Bad Request)
```

**根本原因**: バックエンドから返されるフィードの一部に `link` が空文字列のものが存在する。URL サニタイズ処理 (`sanitizeUrl()` → `normalizeUrl()`) を経ても空文字のまま `RenderFeed.normalizedUrl` と `RenderFeed.link` に伝播し、2 つの不具合を引き起こしていた。

| # | 不具合 | 症状 |
|---|--------|------|
| 1 | Prefetcher エラー | `ArticlePrefetcher.prefetchContent()` が空 URL で API を呼び出し → 400 エラー |
| 2 | 外部リンク遷移不可 | `<a href="" target="_blank">` が現在ページを新タブで開くだけで外部サイトに遷移しない |

### 影響範囲

- ユーザー体験: 外部リンクをクリックしても意図した記事ページに遷移しない
- コンソールノイズ: 不要な 400 エラーが繰り返し発生し、デバッグを阻害
- ネットワーク: 無意味な API リクエストが送信される

## DECISION MAKING

### 方針

入力データ (空 URL) の完全な排除はバックエンド側の別課題として扱い、フロントエンドでは **防御的ガード** を追加する。修正は最小限に留め、既存の動作に影響を与えない。

### 変更内容

#### 1. `src/lib/utils/articlePrefetcher.ts` — 空 URL ガード追加

`prefetchContent()` の冒頭で `normalizedUrl` が空の場合に早期リターン。これにより空 URL でのAPI 呼び出しを防止:

```ts
private async prefetchContent(feed: RenderFeed) {
    const cacheKey = feed.normalizedUrl;

    // Skip feeds with empty URL
    if (!cacheKey) return;

    // ... existing code
}
```

#### 2. `src/lib/components/desktop/feeds/FeedDetailModal.svelte` — 条件付きリンクレンダリング

タイトル部分の `<a>` タグを `{#if feed.link}` で条件分岐。`feed.link` が空の場合はリンクなしのプレーン `<h2>` を表示し、ExternalLink アイコンも非表示にする:

```svelte
{#if feed.link}
    <a href={feed.link} target="_blank" rel="noopener noreferrer" ...>
        <h2>...</h2>
        <ExternalLink />
    </a>
{:else}
    <h2>...</h2>
{/if}
```

### 修正しないもの

- バックエンドの空 URL フィード配信: データ品質の問題は別途対応
- `sanitizeUrl()` / `normalizeUrl()` のロジック変更: 他の呼び出し箇所への影響を避ける

## RESULTS, EFFECTS

### PROS

- **400 エラー解消**: 空 URL フィードに対する不要な `FetchArticleContent` API 呼び出しが発生しなくなる
- **UX 改善**: 空 URL フィードではクリッカブルリンクの代わりにプレーンテキストが表示され、ユーザーの混乱を防止
- **最小変更**: 2 ファイル、計 6 行の追加のみ。既存のロジックやテストへの影響なし
- **型チェック通過**: `svelte-check` で 0 errors, 0 warnings を確認

### CONS, TRADEOFF

- **根本対処ではない**: バックエンド側で空 URL のフィードが配信される問題は残存。データ品質の改善は別途必要
- **空 URL フィードの記事取得不可**: `feed.link` が空のフィードは Full Article / Summarize 機能が利用できない (元々 400 エラーで機能していなかったため実質的なデグレはなし)

## APPENDIX

### 変更ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `alt-frontend-sv/src/lib/utils/articlePrefetcher.ts` | `prefetchContent()` に空 URL 早期リターンを追加 |
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedDetailModal.svelte` | タイトルリンクを `{#if feed.link}` で条件付きレンダリングに変更 |

### 検証結果

```
bun run check            # svelte-check: 0 errors, 0 warnings
docker compose build alt-frontend-sv   # sha256:8f29ff9a
docker compose up -d alt-frontend-sv   # Recreated + Started
curl http://localhost:3000/api/health  # 200 OK
```
