# プロンプト生成とRAGオーケストレータ最適化に関するADR

## ステータス

採択（Accepted）

## コンテキスト

Alt の rag-orchestrator では、LLM を用いた検索拡張生成（RAG）のために複数のユースケースが実装されている。現在のプロンプト生成 (XMLPromptBuilder) は <context>、<instructions>、<query>、<format> の4セクションから構成され、defaultInstructions では「300〜500語で書く」「全文を日本語化する」など多くのルールが記述されている[[1]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/prompt_builder.go#:~:text=sb.WriteString%28fmt.Sprintf%28%22%3Ccontext%20version%3D%5C%22)[[2]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/prompt_builder.go#:~:text=defaultInstructions%20%3A%3D%20%5B%5Dstring)。

コンテキスト取得 (retrieve\_context\_usecase.go) は日本語クエリを英訳してからベクトル化し、chunkRepo.Search で上位5件のチャンクを取得している[[3]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/retrieve_context_usecase.go#:~:text=func%20%28u%20,RetrieveContextOutput%2C%20error%29)[[4]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/retrieve_context_usecase.go#:~:text=%2F%2F%202)。取得した ContextItem のテキスト全体をプロンプトに挿入するため、プロンプトが冗長になりやすい。また、searchLimit が固定値であり、同義語や不要語の除去は行っていない。

answer\_with\_rag\_usecase.go の buildPrompt は取得したコンテキストを PromptBuilder.Build に渡してプロンプト文字列を生成し、LLM に問い合わせている[[5]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/answer_with_rag_usecase.go#:~:text=context.Context%2C%20input%20AnswerWithRAGInput%29%20%28,answerWithRAGUsecase)。output\_validator.go は LLM から返された JSON を厳密に解析し、必要に応じて修復する[[6]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/output_validator.go)。

ユーザからは以下の課題が報告されている： - ソースが決定した後、LLM の最初のトークンが返るまでの TTFT が長い。 - トークン列受信後も謎の待ち時間が生じることがある。 - 基礎的な概念に関する質問でも「ナレッジベースに情報がない」と返される。記事を取り込んでいるにもかかわらず、適切な文脈が取得できていない可能性がある。

改善のためには、プロンプト生成の冗長性削減、コンテキストの質向上、検索アルゴリズムの精度向上、LLM 呼び出しの構造化、キャッシュ利用など多面的な対策が必要である。

## 決定

1. **システムプロンプトの導入とプロンプト構造の簡素化**
2. defaultInstructions の恒常的なルールを systemPrompt 定数として切り出し、LLM の system メッセージとして渡す。これにより命令文の重複を避け、プロンプトサイズを削減する。
3. XMLPromptBuilder.Build は <context> と <query> のみを出力し、<instructions> と <format> セクションを削除する[[1]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/prompt_builder.go#:~:text=sb.WriteString%28fmt.Sprintf%28%22%3Ccontext%20version%3D%5C%22)。JSON 出力形式や引用規則は systemPrompt で定義する。
4. answer\_with\_rag\_usecase.go では systemPrompt とユーザープロンプトを結合した messages 配列を構築し、LLM の ChatCompletion API に渡すようリファクタリングする。
5. ~~**コンテキスト要約の導入**~~ (今回見送り)
6. ~~retrieve\_context\_usecase.go に summarizeContext 関数を追加し〜~~ 実装コストとレイテンシの観点から今回はスキップする。原文のままコンテキストとして使用する。
8. **クエリ前処理と検索精度の向上**
9. `rag-orchestrator` から `search-indexer` (Meilisearch) をクエリし、上位ヒット記事のタグやタイトルから関連語・同義語を抽出する。これらをベクトル検索のクエリに追加することで、キーワード検索の利点を取り込み検索漏れを防ぐ。
10. searchLimit を固定値5から設定ファイルで変更可能な値にし、初回は最大10〜15件を取得した上でスコア閾値によりフィルタリングする[[4]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/retrieve_context_usecase.go#:~:text=%2F%2F%202)。
11. **簡易キャッシュの導入**
12. answer\_with\_rag\_usecase.go にオンメモリキャッシュ（`sync.Map`等）を追加し、クエリハッシュをキーにプロンプト生成結果を保持する。TTLは1時間とし、運用開始後のアクセスパターンを見てRedis等の導入を検討する。
13. **LLM 呼び出しの二段階化とストリーミングの強化**
14. 引用句抽出と回答生成を分割する。第1フェーズでは <context> と <query> だけを渡し、引用句リストを JSON で返すよう LLM に指示する。第2フェーズでは引用句と要約済み文脈（今回は原文）を基に本回答を生成させる。
15. 両フェーズで stream: true を使用し、最初のチャンクが届いた時点でユーザへストリームイベントを返す。
16. **出力バリデータの挙動改善とメトリクス収集**
17. output\_validator.go で Quotes や Citations が欠落していても回答本文が存在すれば処理を継続し、Reason に理由を設定してログ出力する[[6]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/output_validator.go)。
18. TTFT や処理時間をメトリクスとしてログに出力する。

## 結果・影響

### 利点

* プロンプトサイズが削減され、LLM への入力トークン数が減る。
* `search-indexer` を活用することで、ベクトル検索だけでは拾えない同義語や関連語を補完できる。
* オンメモリキャッシュにより、短期間の繰り返しリクエストへの応答が即座になる。
* 二段階 LLM 呼び出しにより、回答の根拠（引用）を明確にしつつ、ストリーミング体験を維持できる。

### 注意点・トレードオフ

* `search-indexer` への依存が増える（HTTP呼び出し）。
* 二段階呼び出しによるレイテンシ増加（TTFTはプロンプト削減で相殺期待）。
* オンメモリキャッシュはプロセス再起動で消失するが、初期フェーズでは許容する。

このADRは、RAGオーケストレータの性能と応答品質を向上させるための具体的なアーキテクチャ変更を提示している。提案された改善策を段階的に実施し、効果測定とユーザフィードバックを基にさらなる調整を行うことが推奨される。

[[1]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/prompt_builder.go#:~:text=sb.WriteString%28fmt.Sprintf%28%22%3Ccontext%20version%3D%5C%22) [[2]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/prompt_builder.go#:~:text=defaultInstructions%20%3A%3D%20%5B%5Dstring) Alt/rag-orchestrator/internal/usecase/prompt\_builder.go at main · Kaikei-e/Alt · GitHub

<https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/prompt_builder.go>

[[3]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/retrieve_context_usecase.go#:~:text=func%20%28u%20,RetrieveContextOutput%2C%20error%29) [[4]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/retrieve_context_usecase.go#:~:text=%2F%2F%202) Alt/rag-orchestrator/internal/usecase/retrieve\_context\_usecase.go at main · Kaikei-e/Alt · GitHub

<https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/retrieve_context_usecase.go>

[[5]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/answer_with_rag_usecase.go#:~:text=context.Context%2C%20input%20AnswerWithRAGInput%29%20%28,answerWithRAGUsecase) Alt/rag-orchestrator/internal/usecase/answer\_with\_rag\_usecase.go at main · Kaikei-e/Alt · GitHub

<https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/answer_with_rag_usecase.go>

[[6]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/output_validator.go) Alt/rag-orchestrator/internal/usecase/output\_validator.go at main · Kaikei-e/Alt · GitHub

<https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/output_validator.go>