# rask-log-forwarder アーキテクチャリファクタリング

## ADR's STATUS

Accepted (Phase 1-8 実装完了)

## CONTEXT

### 問題点

rask-log-forwarder は Docker コンテナログを収集・解析・転送する高性能サイドカーサービス (Rust 2024 edition)。運用の中で以下の構造的課題が顕在化:

| # | 分類 | 問題 |
|---|------|------|
| 1 | パフォーマンス | `service.rs` でバッチサイズが 1 にハードコードされ、設定値が無視されていた |
| 2 | パフォーマンス | 送信ごとに `reqwest::Client::new()` を生成し、コネクションプーリングが無効化 |
| 3 | パフォーマンス | `EnrichedLogEntry -> ParsedLogEntry -> EnrichedLogEntry` の二重変換が発生 |
| 4 | アーキテクチャ | `service.rs` (843 行) にプロセスループ・シャットダウン・プロトコル処理が混在 |
| 5 | アーキテクチャ | `config.rs` (572 行) がモノリシック。バリデーションロジックが複数箇所に分散 |
| 6 | アーキテクチャ | ドメイン層が存在せず、型定義がモジュール間で重複 (LogLevel が 3 箇所、ContainerInfo が 2 箇所) |
| 7 | コレクター | `ServiceDiscoveryTrait` が `Pin<Box<dyn Future>>` パターンで Rust 2024 edition と不整合 |
| 8 | コレクター | Docker クライアントが三重生成 (LogCollector, DockerCollector, streaming 関数内) |
| 9 | コレクター | `LogEntry.raw_bytes` が `Vec<u8>` でゼロコピーパイプラインが途切れていた |
| 10 | テスト | テストファイル・関数名に `TASK2/TASK3/TASK4/TASK5` のレガシー命名が残存 |

### 方針

8 フェーズに分けて段階的に実施。各フェーズ完了時に `cargo test` (全テスト通過) + `cargo clippy --all-targets --all-features -- -D warnings` (lint クリーン) をゲーティング条件とする。

## DECISION MAKING

### Phase 1: パフォーマンス致命的バグの修正

`service.rs` のメインプロセスループを修正:

- `batch_size = 1` を設定値 (`self.config.batch_size`) に変更
- 毎回の `reqwest::Client::new()` を削除し、初期化済み `LogSender` のコネクションプールを再利用
- `mpsc::unbounded_channel()` を `mpsc::channel(capacity)` に変更しバックプレッシャーを有効化
- `recv()` 単一受信を `recv_many()` バッチ収集に置換
- `EnrichedLogEntry -> ParsedLogEntry -> EnrichedLogEntry` の往復変換を除去

### Phase 2: ドメイン層の導入

`src/domain/` モジュールを新設:

```
src/domain/
  mod.rs           - re-exports
  log_entry.rs     - EnrichedLogEntry (parser/universal.rs から移動)
  log_level.rs     - 統一 LogLevel
  batch.rs         - Batch, BatchConfig
  error.rs         - ForwarderError (トップレベルエラー型)
```

- 3 箇所に重複していた `LogLevel` を統合
- 旧パスからの `pub use` re-export で後方互換を維持

### Phase 3: service.rs の分割

843 行のモノリスを責務ごとに分割:

| 新モジュール | 責務 | 抽出元 |
|-------------|------|--------|
| `pipeline.rs` | メインプロセスループ (parse + batch + send) | service.rs lines 290-595 |
| `protocol.rs` | `LogTransport` trait + NDJSON/OTLP 実装 | service.rs lines 426-595 |
| `shutdown.rs` | `ShutdownHandle` + シグナルハンドリング | service.rs lines 647-775 |

`service.rs` は ~300 行に削減。`ServiceManager` はコンポーネントのワイヤリングと `start()` のみに集中。

### Phase 4: config.rs の分割

572 行のモノリシック設定をディレクトリ構造に再編:

```
src/app/config/
  mod.rs           - ConfigError, LogLevel, Protocol + re-exports
  cli.rs           - Config struct (clap derives)
  groups.rs        - RetryConfig, DiskFallbackConfig, MetricsConfig
  validation.rs    - 統一バリデーションロジック
  serde_helpers.rs - Duration serde, 環境変数ヘルパー
```

- `application_initializer.rs` と `config.rs` に分散していたバリデーションを `validation.rs` に一本化
- 既存の `crate::app::config::*` パスは re-export で維持し、後方互換を保証

### Phase 5: Collector のトレイト抽象化

- `ServiceDiscoveryTrait` を `Pin<Box<dyn Future>>` から Rust 2024 ネイティブ async trait に変換
- `DockerCollector` に `pub fn docker()` アクセサを追加し、`start_docker_api_streaming` で Docker クライアントを再利用
- `LogEntry.raw_bytes` を `Vec<u8>` から `bytes::Bytes` に変更 (ゼロコピーパイプライン)

### Phase 6: Feature Flag の整理

- OTLP コードの feature gate (`#[cfg(feature = "otlp")]`) が Phase 3 の分割で適切に配置されていることを確認
- 追加変更不要と判断

### Phase 7: Rust 2024 モダナイゼーション

lint 設定を刷新。blanket `clippy::pedantic` ではなく、ターゲット指定方式を採用:

```rust
#![deny(warnings, rust_2024_compatibility)]
#![deny(
    clippy::explicit_iter_loop,
    clippy::manual_let_else,
    clippy::semicolon_if_nothing_returned,
    clippy::inconsistent_struct_constructor
)]
```

実際に価値のある 4 つの pedantic lint を `deny` で強制し、キャスト系やドキュメント系の 10 項目のみ `allow` で除外。

### Phase 8: テスト改善とレガシー命名の除去

- `TASK2/TASK3/TASK4/TASK5` プレフィックスをソースファイル・テストファイル・関数名からすべて除去
- テストファイルのリネーム:

| 旧名 | 新名 |
|------|------|
| `task4_integration_test.rs` | `initialization_integration_test.rs` |
| `task5_lockfree_buffer_test.rs` | `lockfree_buffer_test.rs` |
| `test_task3_integration.rs` | `test_buffer_integration.rs` |
| `test_docker_json_task2.rs` | `test_docker_json_extended.rs` |

- テスト関数名: `test_task4_*` / `test_task5_*` を `test_*` にリネーム

## RESULTS, EFFECTS

### PROS

- **パフォーマンス回復**: バッチサイズ 1 → 1000 (設定値) で送信頻度が約 1000 分の 1 に削減。コネクションプール再利用で TCP handshake を排除。実測で 1000 件バッチが ~6ms で送信完了
- **モジュール境界の明確化**: `service.rs` 843 行 → ~300 行。`config.rs` 572 行 → 5 ファイルに分割。各モジュールの責務が単一に
- **型の統一**: LogLevel を 3 箇所から 1 箇所に集約。`domain/` 層でデータモデルを一元管理
- **ゼロコピーパイプライン**: `Vec<u8>` → `bytes::Bytes` で Docker API からシリアライザまでコピーなし
- **Rust 2024 準拠**: ネイティブ async trait、`deny(rust_2024_compatibility)` でエディション互換を保証
- **テスト健全性**: 316 テスト全パス、clippy クリーン。レガシー命名を完全除去
- **コンテナ動作確認済み**: リビルド後の Docker Compose 環境で正常動作を確認

### CONS, TRADEOFF

- **`initialization.rs` と `application_initializer.rs` の統合を見送り**: マージすると 700+ 行になるため、現状の 2 ファイル構成を維持。将来的に責務が明確になった段階で再検討
- **blanket `clippy::pedantic` の不採用**: 既存コードの修正範囲が大きくなりすぎるため、価値の高い 4 lint のみ `deny` とする段階的アプローチを選択
- **`JoinSet` 移行の見送り**: `tokio::spawn` fire-and-forget パターンから `JoinSet` への移行は Phase 7 で検討したが、影響範囲が大きいため本リファクタリングのスコープ外とした

## APPENDIX

### 実行順序と依存関係

```
Phase 1 (パフォーマンスバグ修正) ← 依存なし、最優先
  ↓
Phase 2 (ドメイン層) ← 依存なし
  ↓
Phase 3 (service.rs 分割) ← Phase 1, 2 に依存
Phase 4 (config.rs 分割) ← Phase 2 に依存 (Phase 3 と並行可能)
  ↓
Phase 5 (Collector トレイト) ← Phase 2 に依存
Phase 6 (Feature Flag) ← Phase 3 に依存
  ↓
Phase 7 (Rust 2024 モダナイゼーション) ← 全フェーズ後
Phase 8 (テスト改善) ← 各フェーズと並行
```

### 変更ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `src/app/service.rs` | Phase 1: バグ修正、Phase 3: 分割 (~300 行に削減) |
| `src/app/config.rs` → `src/app/config/` | Phase 4: 5 ファイルに分割 |
| `src/app/pipeline.rs` (新規) | Phase 3: メインプロセスループ |
| `src/app/protocol.rs` (新規) | Phase 3: LogTransport trait + 実装 |
| `src/app/shutdown.rs` (新規) | Phase 3: シャットダウンハンドリング |
| `src/domain/` (新規) | Phase 2: ドメイン層 |
| `src/collector/mod.rs` | Phase 5: `Bytes` 化、Docker クライアント再利用 |
| `src/collector/discovery.rs` | Phase 5: ネイティブ async trait |
| `src/collector/docker.rs` | Phase 5: `docker()` アクセサ追加 |
| `src/lib.rs` | Phase 2: domain module 追加、Phase 7: lint 強化 |
| `build.rs` | Phase 8: TASK コメント除去 |
| `tests/` (複数) | Phase 8: ファイル・関数リネーム、TASK コメント除去 |

### 検証結果

```
cargo test                                                     # 316 テスト全パス (3 ignored)
cargo clippy --all-targets --all-features -- -D warnings       # lint クリーン
docker compose -f compose/compose.yaml -p alt build nginx-logs # ビルド成功
docker compose -f compose/compose.yaml -p alt up -d nginx-logs # 正常起動・バッチ送信確認
```
