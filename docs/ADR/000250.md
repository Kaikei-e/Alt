# ADR-000250: バッチ要約ジョブのカーソルページネーション固着バグの修正

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000249 でイベント駆動化を導入し、ポーリング間隔を 10 秒から 5 分に緩和した。ポーリングはフォールバックのセーフティネットとして維持されている。

バッチ要約ジョブ（`processSummarizationBatch`）はカーソルベースのページネーションで未要約記事を `created_at DESC` 順にスキャンする。1 バッチ完了ごとにカーソルを進め、末尾到達時にカーソルをリセットして先頭から再スキャンする設計である。

### 問題

バッチスキャンの末尾到達後、カーソルがリセットされずに固着し、フォールバックポーリングが永久に未要約記事を発見できなくなるケースが発生した。

#### 発生シーケンス

1. バッチジョブが未要約記事を新しい順にスキャン、カーソルが最古の記事付近まで進む
2. 外部要因（Quality Checker によるサマリー削除など）でカーソルより**新しい**位置の記事が「未要約」に戻る
3. カーソルより古い未要約記事がなくなり、バッチが `ProcessedCount=0, HasMore=false` を返す
4. カーソルリセット条件 `!HasMore && ProcessedCount > 0` が **false** と評価される（`ProcessedCount == 0` のため）
5. カーソルがリセットされず、以降のスキャンはカーソルの古い側のみを探索し続ける
6. 未要約記事はカーソルより新しい位置にあるため永久に発見されない

```
カーソル位置（固着）     未要約記事（新しい側に戻った）
       ↓                    ↓↓↓
[最古] -------- [cursor] -------- [最新]
       ← クエリ範囲 →
       （ここにはもう記事がない）
```

#### 根本原因

カーソルリセット条件が `ProcessedCount > 0` を要求していたため、「カーソル末尾に到達したが処理対象がなかった」ケースでリセットが発動しなかった。

```go
// 修正前
if !result.HasMore && result.ProcessedCount > 0 {
    h.articleSummarizer.ResetPagination()
}
```

統計カウントクエリはカーソルなしで全件をカウントするため、未要約記事の存在を正しく報告する。一方、バッチジョブはカーソル条件付きクエリを使うため、カーソルが固着すると0件を返し続ける。この不整合が問題の根本原因である。

## 意思決定

### 採用: カーソルリセット条件から `ProcessedCount > 0` ガードを除去

カーソルリセットの条件を `!result.HasMore` のみに変更する。

```go
// 修正後
if !result.HasMore {
    h.articleSummarizer.ResetPagination()
}
```

**理由**: `HasMore == false` はカーソルがスキャン範囲の末尾に到達したことを示す。この時点でカーソルをリセットすれば、次回スキャンで最新の記事から再走査が始まる。`ProcessedCount` の値はリセット判断に無関係であり、条件に含めるべきではない。

### 検討した代替案

| 案 | 不採用理由 |
|---|---|
| ProcessedCount=0 の場合のみ別途リセット | 既存の `ProcessedCount > 0` 分岐と冗長。条件を統合した方がシンプル |
| カーソルに TTL を設定して自動リセット | 追加の状態管理が必要になり、リセットタイミングが不確定 |
| 双方向スキャン（DESC + ASC） | クエリの複雑化に見合う効果がない |

## 結果・影響

### 変更概要

| ファイル | 変更内容 |
|---|---|
| `pre-processor/app/handler/job_handler.go:153` | `processSummarizationBatch` のカーソルリセット条件から `&& result.ProcessedCount > 0` を除去 |
| `pre-processor/app/handler/job_handler.go:178` | `processQualityCheckBatch` の同一条件を同様に修正 |
| `pre-processor/app/handler/job_handler_test.go` | カーソルリセット動作の検証テスト 5 件を追加 |

### テストカバレッジ

| テスト | 検証内容 |
|-------|---------|
| `TestProcessSummarizationBatch_CursorReset/HasMore=false_ProcessedCount>0` | 処理あり・末尾到達時にカーソルがリセットされること |
| `TestProcessSummarizationBatch_CursorReset/HasMore=false_ProcessedCount=0` | 処理なし・末尾到達時にもカーソルがリセットされること（**今回の修正対象**） |
| `TestProcessSummarizationBatch_CursorReset/HasMore=true` | スキャン途中ではカーソルがリセットされないこと |
| `TestProcessQualityCheckBatch_CursorReset/HasMore=false_ProcessedCount=0` | Quality Check の同一バグが修正されていること |
| `TestProcessQualityCheckBatch_CursorReset/HasMore=true` | Quality Check のスキャン途中でリセットされないこと |

### 影響範囲

- **バッチ要約ジョブ**: カーソル固着が解消され、フォールバックポーリングが正常に全記事をスキャンできるようになる
- **Quality Check ジョブ**: 同一のカーソルリセットバグを同時に修正
- **イベント駆動パス**: 影響なし（カーソルページネーションを使用しない）
- **パフォーマンス**: `ProcessedCount=0` でもリセットが発生するが、リセット自体はインメモリ操作のみであり追加コストは無視できる

## 関連 ADR

- ADR-000247: 要約パイプライン修正（`ListUnsummarizedArticles` RPC、カーソルページネーション導入）
- ADR-000249: 要約パイプラインのイベント駆動化（ポーリング間隔 5 分化）
