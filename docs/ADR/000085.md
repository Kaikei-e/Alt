# Connect-RPC Proto パッケージ名の不一致による検索エラーの修正

## ステータス

採択（Accepted）

## コンテキスト

### 問題の発生

検索機能の実行時に以下のエラーが発生していた：

```
Error searching: [internal] An unexpected error occurred. Please try again later.
```

alt-backend のログには以下が記録されていた：

```
{"level":"ERROR","msg":"failed to search articles","error":"unimplemented: 404 Not Found"}
```

### アーキテクチャ

```
alt-frontend-sv -> alt-butterfly-facade -> alt-backend -> search-indexer
                                           (Connect-RPC client)  (Connect-RPC server)
```

### 原因調査

Connect-RPC は proto ファイルの `package` 名からエンドポイントパスを生成する。

**alt-backend (クライアント側)**
- proto: `proto/clients/search/v2/search.proto`
- package: `clients.search.v2`
- 生成されるエンドポイント: `/clients.search.v2.SearchService/SearchArticles`

**search-indexer (サーバー側)**
- proto: `proto/services/search/v2/search.proto`
- package: `services.search.v2`
- 登録されるエンドポイント: `/services.search.v2.SearchService/SearchArticles`

パスが一致しないため、Connect-RPC サーバーは 404 Not Found を返却していた。

## 決定

クライアント側の proto パッケージ名をサーバー側に合わせて統一する。

### 変更前

```protobuf
// proto/clients/search/v2/search.proto
syntax = "proto3";

package clients.search.v2;

option go_package = "alt/gen/proto/clients/search/v2;searchv2";
```

### 変更後

```protobuf
// proto/clients/search/v2/search.proto
syntax = "proto3";

package services.search.v2;

option go_package = "alt/gen/proto/clients/search/v2;searchv2";
```

`go_package` はそのまま維持し、生成先のディレクトリ構造は変更しない。Connect-RPC のエンドポイントパスのみを統一する。

## 結果

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `proto/clients/search/v2/search.proto` | `package` を `services.search.v2` に変更 |
| `alt-backend/app/gen/proto/clients/search/v2/*.go` | 再生成（自動） |
| `alt-backend/app/gen/proto/clients/search/v2/searchv2connect/*.go` | 再生成（自動） |

### 再生成コマンド

```bash
cd proto && buf generate --template buf.gen.alt-backend-clients.yaml
```

### 生成結果の確認

```go
// alt-backend/app/gen/proto/clients/search/v2/searchv2connect/search.connect.go
const (
    SearchServiceName = "services.search.v2.SearchService"
)

const (
    SearchServiceSearchArticlesProcedure = "/services.search.v2.SearchService/SearchArticles"
)
```

### メリット

1. **問題解決**: 検索エンドポイントが正しく呼び出せるようになった
2. **最小限の変更**: `package` 名のみの変更で対応
3. **ディレクトリ構造維持**: `go_package` は変更なし

### 設計の教訓

Connect-RPC（および gRPC）では、proto の `package` 名がエンドポイントパスに直接影響する。クライアントとサーバーで異なる proto ファイルを使用する場合、`package` 名の一致を確認する必要がある。

## デプロイ

```bash
# alt-backend の再ビルド・再起動
docker compose build alt-backend
docker compose up -d alt-backend
```

## 実装日

2026-01-13

## 関連

- [Connect-RPC: Protocol specification](https://connectrpc.com/docs/protocol/)
- [Protobuf: Package naming](https://protobuf.dev/programming-guides/style/#packages)
