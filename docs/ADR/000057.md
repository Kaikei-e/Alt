# 検索機能のエラーハンドリング改善とスタック依存関係の明確化

## ステータス

採択（Accepted）

## コンテキスト

### 問題

検索ページで「Error searching: [internal] An unexpected error occurred. Please try again later. (Error ID: xxxxxxxx)」というエラーが発生していた。

### 背景

- Alt プラットフォームは Docker Compose でマイクロサービスを管理
- `altctl` CLI ツールでスタック単位（core, workers, ai など）の起動・停止を行う
- 検索機能は `search-indexer` サービス（Meilisearch ラッパー）に依存

### 調査結果

Docker Compose のサービス状態を確認したところ、`search-indexer` サービスが起動していなかった。

```bash
$ docker compose ps
NAME                   IMAGE                STATUS
alt-backend-1          alt-alt-backend      Up (healthy)
alt-frontend-1         alt-alt-frontend     Up (healthy)
# search-indexer は一覧にない
```

### 根本原因

**スタック定義の問題**:

```
core stack:    nginx, alt-frontend, alt-backend, migrate
workers stack: search-indexer, tag-generator, pre-processor-sidecar
```

`altctl up --build core` は `core` スタックのみを起動するため、`workers` スタックに含まれる `search-indexer` は起動されない。

**エラーフロー**:

```
Frontend (検索リクエスト)
  → alt-backend (Connect-RPC handler)
    → search-indexer:9300 への HTTP リクエスト
      → サービス未起動 → 接続失敗
        → "failed to send request" エラー
          → UNKNOWN_ERROR として処理
            → "[internal] An unexpected error occurred..."
```

**エラーハンドリングの問題**:

`alt-backend` では接続失敗を汎用的な "failed to send request" エラーとして処理し、`UNKNOWN_ERROR` にマッピングしていた。これにより、ユーザーには原因が分かりにくいエラーメッセージが表示されていた。

## 決定

### 1. search-indexer サービスを起動

```bash
docker compose up -d search-indexer
# または
altctl up workers
```

### 2. 具体的なエラータイプを導入（TDD）

**新規エラータイプ**:

```go
// alt-backend/app/driver/search_indexer/api.go
var (
    ErrSearchServiceUnavailable = errors.New("search service unavailable")
    ErrSearchTimeout            = errors.New("search request timed out")
)
```

**エラー分類ロジック**:

```go
// alt-backend/app/connect/errorhandler/error_handler.go
func classifyDriverError(err error, operation string) *errors.AppContextError {
    if errors.Is(err, search_indexer.ErrSearchServiceUnavailable) {
        return errors.NewExternalAPIContextError(
            "Search service is temporarily unavailable",
            // ...
        )
    }
    if errors.Is(err, search_indexer.ErrSearchTimeout) {
        return errors.NewTimeoutContextError(
            "Search request timed out",
            // ...
        )
    }
    return errors.NewUnknownContextError(...)
}
```

### 3. ユーザーフレンドリーなメッセージ

| エラータイプ | ユーザー向けメッセージ |
|------------|---------------------|
| `ErrSearchServiceUnavailable` | "Unable to connect to external service. Please try again." |
| `ErrSearchTimeout` | "The request took too long. Please try again." |

### 4. E2E テストの追加

```typescript
// alt-frontend-sv/tests/e2e/desktop/feeds/search.spec.ts
test("shows error message when search API returns error", async ({ page }) => {
    await page.route("**/SearchFeeds", (route) =>
        route.fulfill({
            status: 500,
            body: JSON.stringify({
                code: "internal",
                message: "Unable to connect to external service. (Error ID: test123)",
            }),
        }),
    );

    await page.getByPlaceholder(/search by title/i).fill("test");
    await page.getByRole("button", { name: "Search" }).click();

    await expect(page.getByText(/error searching/i)).toBeVisible();
});
```

## 結果

### メリット

1. **原因の明確化**: 検索サービス障害時に具体的なエラーメッセージを表示
2. **デバッグ容易性**: Error ID でサーバーログと紐付けて調査可能
3. **セキュリティ**: 内部エラー詳細をユーザーに漏らさない
4. **テストカバレッジ**: E2E テストで検索エラーのケースをカバー

### トレードオフ

1. **スタック依存関係**: `core` と `workers` は独立しているが、検索機能は両方必要
   - 将来的に `altctl up core` で `workers` も起動する検討が必要
2. **エラータイプの拡張**: 他のサービス障害にも同様のパターンを適用する必要がある

## 実装

### 実装日: 2026-01-07

### 修正ファイル一覧

| カテゴリ | ファイル | 変更内容 |
|---------|---------|---------|
| Driver | `alt-backend/app/driver/search_indexer/api.go` | `ErrSearchServiceUnavailable`, `ErrSearchTimeout` 追加 |
| Driver Test | `alt-backend/app/driver/search_indexer/api_test.go` | 新規: Unit tests |
| Error Handler | `alt-backend/app/connect/errorhandler/error_handler.go` | `classifyDriverError()` 追加 |
| Error Handler Test | `alt-backend/app/connect/errorhandler/error_handler_test.go` | 検索エラーのテスト追加 |
| E2E Test | `alt-frontend-sv/tests/e2e/desktop/feeds/search.spec.ts` | 新規: 検索エラー表示テスト |

### テスト結果

**バックエンド Unit Tests**:
```
ok  alt/driver/search_indexer      0.003s
ok  alt/connect/errorhandler       0.003s
```

**フロントエンド E2E Tests**:
```
✓ displays search input and button
✓ shows initial state with search prompt
✓ disables search button when input is empty
✓ shows error message when search API returns error
✓ error message contains Error ID for debugging

5 passed (15.0s)
```

## スタック依存関係

```
base
  └── db (PostgreSQL, Meilisearch, ClickHouse)
        └── auth (Kratos, auth-hub)
              └── core (nginx, frontend, backend)
                    └── workers (search-indexer, tag-generator)
```

**注意**: `core` スタックは `workers` に依存しないが、検索機能を使うには `workers` スタックも必要。

## 関連ADR

なし

## 参考

- スタック定義: `altctl/internal/stack/registry.go`
- 検索ハンドラー: `alt-backend/app/connect/v2/feeds/handler.go` (SearchFeeds)
- エラーハンドリング: `alt-backend/app/utils/errors/app_context_error.go`
