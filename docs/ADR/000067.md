# 内部サービス間通信の Connect-RPC 移行

## ステータス

採択（Accepted）

## コンテキスト

### 背景

Alt プラットフォームでは、フロントエンド（alt-frontend-sv）とバックエンド（alt-backend）間の通信に Connect-RPC を採用し、型安全性とストリーミングサポートの恩恵を受けている。

一方、内部サービス間通信（alt-backend ↔ search-indexer、alt-backend ↔ pre-processor）は従来の REST API を使用していた。

### 課題

1. **型安全性の欠如**: REST クライアントは手動での構造体マッピングが必要
2. **ストリーミングの複雑さ**: pre-processor の要約ストリーミングは SSE ベースで実装が複雑
3. **一貫性の欠如**: フロントエンド通信と内部通信で異なるプロトコルを使用
4. **スキーマ管理**: OpenAPI と protobuf の二重管理

### 技術的要件

- HTTP/2 over cleartext（h2c）: 内部 Docker ネットワークでは TLS 不要
- サーバーストリーミング RPC: 要約のリアルタイム配信
- 後方互換性: REST エンドポイントを維持した段階的移行

## 決定

### アーキテクチャ

内部サービス間通信を Connect-RPC に移行する。

```
alt-frontend-sv ──Connect-RPC──> alt-backend
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
            search-indexer                   pre-processor
            (REST: 9300)                     (REST: 9200)
            (Connect: 9301)                  (Connect: 9202)
```

### バージョニング戦略

- Package naming: `clients.{service}.v2`
- URL pattern: `/clients.{service}.v2.{ServiceName}/{MethodName}`
- Go package: `{module}/gen/proto/clients/{service}/v2;{service}v2`

### Proto スキーマ

#### search-indexer (`clients/search/v2/search.proto`)

```protobuf
syntax = "proto3";
package clients.search.v2;

message SearchArticlesRequest {
  string query = 1;
  string user_id = 2;
  int32 limit = 3;
}

message SearchHit {
  string id = 1;
  string title = 2;
  string content = 3;
  repeated string tags = 4;
}

message SearchArticlesResponse {
  repeated SearchHit hits = 1;
}

service SearchService {
  rpc SearchArticles(SearchArticlesRequest) returns (SearchArticlesResponse);
}
```

#### pre-processor (`clients/preprocessor/v2/preprocessor.proto`)

```protobuf
syntax = "proto3";
package clients.preprocessor.v2;

// 同期要約
message SummarizeRequest {
  string article_id = 1;
  string title = 2;
  string content = 3;
}

message SummarizeResponse {
  bool success = 1;
  string summary = 2;
  string article_id = 3;
}

// ストリーミング要約（Server Streaming RPC）
message StreamSummarizeRequest {
  string article_id = 1;
  string title = 2;
  string content = 3;
}

message StreamSummarizeResponse {
  string chunk = 1;
  bool is_final = 2;
}

// 非同期キュー
message SummarizeQueueRequest {
  string article_id = 1;
  string title = 2;
}

message SummarizeQueueResponse {
  string job_id = 1;
  string status = 2;
  string message = 3;
}

// ジョブステータス
message SummarizeStatusRequest {
  string job_id = 1;
}

message SummarizeStatusResponse {
  string job_id = 1;
  string status = 2;
  string summary = 3;
  string error_message = 4;
  string article_id = 5;
}

service PreProcessorService {
  rpc Summarize(SummarizeRequest) returns (SummarizeResponse);
  rpc StreamSummarize(StreamSummarizeRequest) returns (stream StreamSummarizeResponse);
  rpc QueueSummarize(SummarizeQueueRequest) returns (SummarizeQueueResponse);
  rpc GetSummarizeStatus(SummarizeStatusRequest) returns (SummarizeStatusResponse);
}
```

### ポート割り当て

| サービス | REST | Connect-RPC | 備考 |
|---------|------|-------------|------|
| search-indexer | 9300 | 9301 | - |
| pre-processor | 9200 | 9202 | 9201 は auth-token-manager が使用 |

### コード生成戦略

マルチモジュール構成のため、サーバー用とクライアント用で別々の proto ファイルを用意：

```
proto/
├── services/           # サーバー側（各サービスの gen/proto へ出力）
│   ├── search/v2/
│   └── preprocessor/v2/
├── clients/            # クライアント側（alt-backend の gen/proto へ出力）
│   ├── search/v2/
│   └── preprocessor/v2/
├── buf.gen.search-indexer.yaml
├── buf.gen.pre-processor.yaml
└── buf.gen.alt-backend-clients.yaml
```

## 結果

### 実装ファイル

#### サーバー側

| サービス | ファイル | 説明 |
|---------|---------|------|
| search-indexer | `connect/v2/server.go` | h2c サーバーセットアップ |
| search-indexer | `connect/v2/search/handler.go` | SearchService 実装 |
| pre-processor | `connect/v2/server.go` | h2c サーバーセットアップ |
| pre-processor | `connect/v2/preprocessor/handler.go` | PreProcessorService 実装 |

#### クライアント側

| サービス | ファイル | 説明 |
|---------|---------|------|
| alt-backend | `driver/search_indexer_connect/client.go` | SearchIndexerPort 実装 |
| alt-backend | `driver/preprocessor_connect/client.go` | ストリーミング対応クライアント |

### ストリーミング実装

Connect-RPC の Server Stream を `io.ReadCloser` に適応する streamAdapter を実装：

```go
type streamAdapter struct {
    stream *connect.ServerStreamForClient[ppv2.StreamSummarizeResponse]
    buf    []byte
}

func (a *streamAdapter) Read(p []byte) (n int, err error) {
    if len(a.buf) > 0 {
        n = copy(p, a.buf)
        a.buf = a.buf[n:]
        return n, nil
    }
    if !a.stream.Receive() {
        if err := a.stream.Err(); err != nil {
            return 0, err
        }
        return 0, io.EOF
    }
    msg := a.stream.Msg()
    if msg.IsFinal {
        return 0, io.EOF
    }
    chunk := []byte(msg.Chunk)
    n = copy(p, chunk)
    if n < len(chunk) {
        a.buf = chunk[n:]
    }
    return n, nil
}
```

### Docker Compose 更新

```yaml
# compose/workers.yaml
search-indexer:
  ports:
    - "9300:9300"   # REST API
    - "9301:9301"   # Connect-RPC

# compose/ai.yaml
pre-processor:
  ports:
    - "9200:9200"   # REST API
    - "9202:9202"   # Connect-RPC
```

### メリット

1. **型安全性**: protobuf スキーマによるコンパイル時型チェック
2. **ストリーミング**: gRPC-style Server Streaming で要約のリアルタイム配信
3. **一貫性**: フロントエンド・内部通信で同一プロトコル
4. **スキーマ駆動**: proto ファイルが Single Source of Truth
5. **ツーリング**: buf による lint、breaking change 検出

### トレードオフ

1. **複雑性増加**: マルチモジュール構成での proto 管理
2. **デバッグ**: バイナリプロトコルは curl での直接テストが困難
3. **学習コスト**: Connect-RPC/protobuf の理解が必要
4. **二重管理（一時的）**: 移行期間中は REST と Connect-RPC が共存

### 移行戦略

段階的移行を採用：

1. **Phase 1**: Connect-RPC サーバーを REST と並行稼働（完了）
2. **Phase 2**: alt-backend に Connect-RPC クライアント追加（完了）
3. **Phase 3**: フィーチャーフラグで切り替え（未実装）
4. **Phase 4**: Connect-RPC をデフォルト化
5. **Phase 5**: REST エンドポイント廃止

## 検証

### テスト実行

```bash
# search-indexer
cd search-indexer/app && go test ./...

# pre-processor
cd pre-processor/app && go test ./...

# alt-backend
cd alt-backend/app && go test ./driver/...
```

すべてのテストがパス。

### 手動検証（将来）

```bash
# grpcurl でテスト
grpcurl -plaintext localhost:9301 clients.search.v2.SearchService/SearchArticles
grpcurl -plaintext localhost:9202 clients.preprocessor.v2.PreProcessorService/Summarize
```

## 実装

### 実装日

2026-01-10

### 関連 ADR

- ADR-001: Docker Compose によるマイクロサービス基盤
- ADR-023: Connect-RPC 採用（フロントエンド ↔ バックエンド）

## 関連リソース

- [Connect-RPC Documentation](https://connectrpc.com/docs/introduction)
- [buf Documentation](https://buf.build/docs/introduction)
- [h2c - HTTP/2 over cleartext](https://pkg.go.dev/golang.org/x/net/http2/h2c)
