# ADR-000291: Rust ビルドアーティファクト肥大化の対策

## ADR's STATUS

Accepted

## CONTEXT

Rust 系サービス（rask-log-aggregator, rask-log-forwarder, recap-worker）のローカル `target/` ディレクトリが無制限に肥大化し、開発環境のディスクを圧迫していた。

主な問題:

- **rask-log-aggregator の `target/` が 20GB に膨張** — `debug/deps/`（13GB）、`debug/incremental/`（4.3GB）、`release/`（1.8GB）で構成。Cargo は 1.88 以前に自動 GC を持たず、依存バージョン更新やフィーチャーフラグ変更のたびに古いアーティファクトが蓄積し続けた。
- **rask-log-aggregator に `.dockerignore` が未設定** — Docker ビルド時に 20GB の `target/` がビルドコンテキストとして転送され、ビルドが極端に遅くなる可能性があった。
- **recap-worker の Dockerfile が非効率** — cargo-chef 未使用・BuildKit cache mount 未使用のため、ソースコード変更のたびに全依存を再コンパイルしていた。

## DECISION MAKING

### 1. rask-log-aggregator の `target/` を `cargo clean` で削除

即時に 20.2 GiB（41,396 ファイル）を回復。`target/` は完全に再生成可能なビルドキャッシュであり、削除のリスクはない。

### 2. rask-log-aggregator に `.dockerignore` を追加

`target/`、`.cargo/`、IDE ファイル、ドキュメント等をビルドコンテキストから除外する `.dockerignore` を新規作成。recap-worker の既存 `.dockerignore` と同等のカバレッジ。

### 3. recap-worker Dockerfile に cargo-chef + BuildKit cache mount を導入

既に rask-log-aggregator で採用済みの cargo-chef パターンに統一した:

- **cargo-chef**: `recipe.json` による依存グラフのスナップショットを用い、`Cargo.toml` / `Cargo.lock` が変わらない限り依存ビルドをスキップ。
- **BuildKit cache mount**: `cargo registry`、`cargo git`、`target/` を BuildKit キャッシュとしてビルド間で保持。
- **cache ID の分離**: rask-log-aggregator と recap-worker で異なるベースイメージ（slim vs bookworm）を使うため、`id=recap-worker-*` で cache mount を分離し、GLIBC 不一致によるキャッシュ汚染を防止。

### 4. Makefile に `rust-clean` ターゲットを追加

全 Rust サービスの `target/` を一括クリーンする `make rust-clean` を追加。定期的なディスク回復を容易にした。

## RESULTS, EFFECTS

### PROS

- **即時 20GB のディスク回復** — `cargo clean` による即効性。
- **Docker ビルドコンテキストの最小化** — `.dockerignore` により `target/` がビルドコンテキストに含まれなくなり、ビルド開始までの転送時間が大幅短縮。
- **recap-worker の再ビルド高速化** — cargo-chef + cache mount により、ソース変更のみの再ビルドでは依存コンパイルをスキップ。初回以降のビルドが大幅に高速化。
- **Rust サービス間で Dockerfile パターンを統一** — rask-log-aggregator と recap-worker が同じ cargo-chef + BuildKit cache mount パターンを採用。保守性が向上。
- **運用コマンドの標準化** — `make rust-clean` で定期的なディスク回復が可能。

### CONS, TRADEOFF

- **`cargo clean` 後の初回ビルドは遅くなる** — ローカルキャッシュが消えるため、次のローカルビルド時に全依存の再コンパイルが必要。Docker ビルドは BuildKit cache があるため影響なし。
- **cargo-chef の追加レイヤー** — Dockerfile のステージ数が増え、構造がやや複雑になる。ただし rask-log-aggregator で実績のあるパターンなので学習コストは低い。
- **BuildKit cache の手動管理** — cache mount は `docker builder prune` で明示的に削除しない限り蓄積する。ただし既存の `make docker-cleanup-memory` ターゲットで対応可能。

## APPENDIX

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `rask-log-aggregator/.dockerignore` | 新規作成 |
| `recap-worker/Dockerfile.recap-worker` | cargo-chef + BuildKit cache mount 導入 |
| `Makefile` | `rust-clean` ターゲット追加 |

### 対象サービスの依存規模

| サービス | クレート数 |
|---------|-----------|
| rask-log-aggregator | 13 |
| rask-log-forwarder | 24 |
| recap-worker | 44 |

### 検証結果

- `cargo clean` で 20.2 GiB / 41,396 ファイル削除を確認
- rask-log-aggregator: Docker ビルド成功、コンテナ healthy
- recap-worker: Docker ビルド成功、コンテナ healthy
- `make rust-clean` が全 3 サービスで正常動作
