# ADR-000242: alt-frontend-sv ロジック層 SOLID リファクタリング

## STATUS

Accepted（実装完了）

## CONTEXT

`alt-frontend-sv` のロジック層（UI以外の TypeScript コード）に以下の SOLID 原則違反が蓄積していた。

### 問題の一覧

| ファイル | 行数 | 違反 | 問題 |
|---------|------|------|------|
| `src/lib/api.ts` | 553 | SRP, DRY | 6つの責務（認証・REST通信・フィード操作・Tag Trail等）が混在。POST/DELETE の同一パターンが3回コピペ |
| `src/lib/connect/feeds.ts` | 848 | SRP, DRY | 6つの責務（クライアント生成・統計・一覧・ストリーミング・検索・購読管理）が混在。ストリーミング応答処理ロジック約30行が重複 |
| `src/lib/utils/streamingRenderer.ts` | 441 | SRP | 4つの責務（レンダラー・SSEパーサー・Augur処理・要約処理）が混在 |
| `src/lib/connect/streamingAdapter.ts` | 258 | DRY | チャンク処理コールバック約25行が2関数でほぼ同一 |
| `src/lib/api/sse.ts` | 202 | DRY | `setupSSE` が `setupSSEWithReconnect(maxRetries=0)` と機能的に同等 |

### 方針

Clean Architecture のような重量級パターンではなく、フロントエンドに適した実用的な SOLID 適用を行う。具体的には：

- **SRP**: God Module を責務別のファイルに分割
- **DRY**: コピペされたパターンを共通ヘルパーに抽出
- **後方互換性**: 元ファイルを barrel re-export として残し、既存の28箇所以上のインポートを変更不要にする

## DECISION MAKING

### 構造: 分割 + barrel パターン

ファイル分割にあたり、以下のパターンを採用した。

```
src/lib/api.ts  (553行 → barrel re-export 37行)
  ├── src/lib/server/auth.ts
  ├── src/lib/server/backend-rest-client.ts
  ├── src/lib/server/feed-api.ts
  └── src/lib/server/tag-trail-api.ts

src/lib/connect/feeds.ts  (848行 → barrel re-export 54行)
  ├── src/lib/connect/feeds/client.ts
  ├── src/lib/connect/feeds/stats.ts
  ├── src/lib/connect/feeds/listing.ts
  ├── src/lib/connect/feeds/streaming.ts
  └── src/lib/connect/feeds/actions.ts

src/lib/utils/streamingRenderer.ts  (441行 → core 225行 + re-export)
  ├── src/lib/utils/sse-parser.ts
  └── src/lib/utils/sse-processors.ts
```

元ファイルが barrel re-export として残るため、消費側のインポートパスは一切変更不要。TypeScript のモジュール解決により、ファイル (`feeds.ts`) がディレクトリ (`feeds/`) より優先される。

### 代替案と却下理由

| 選択肢 | 却下理由 |
|--------|---------|
| インポート元を全て新パスに一括置換 | 28箇所以上の変更で回帰リスクが高く、差分が大きい |
| index.ts でディレクトリ化 | 既存 `feeds.ts` と `feeds/index.ts` の共存時にモジュール解決の曖昧さが生じる |
| 機能変更と同時にリファクタリング | 変更の切り分けができず、問題発生時の原因特定が困難 |

### 実行順序

4つの独立チェーンに分割し、各チェーン内は依存順で実行した。

```
Chain A: api.ts DRY改善 → 責務別分割
Chain B: streamingRenderer 分割 → streamingAdapter DRY改善
Chain C: feeds.ts DRY改善 → 責務別分割
Chain D: sse.ts DRY改善
```

## RESULTS

### Step 1: `api.ts` の REST 呼び出しパターン重複排除

`updateFeedReadStatus`, `registerRssFeed`, `deleteFeedLink` が共有する「トークン取得→ヘッダー設定→fetch→エラー処理」パターンを `callBackendAPIWithBody(endpoint, cookie, method, body?)` に集約。

```typescript
// Before: 3関数 × 約40行 = ~120行の重複
export async function updateFeedReadStatus(cookie, feedUrl) {
  const token = await getBackendToken(cookie);
  const headers = { "Content-Type": "application/json" };
  if (token) headers["X-Alt-Backend-Token"] = token;
  const response = await fetch(url, { method: "POST", headers, body: ... });
  // ...同一のエラー処理
}

// After: 3関数 × 1行のラッパー
export async function updateFeedReadStatus(cookie, feedUrl) {
  return callBackendAPIWithBody("/v1/feeds/read", cookie, "POST", { feed_url: feedUrl });
}
```

**削減**: ~100行

### Step 2: `api.ts` を責務別サーバーサイドモジュールに分割

| 新規ファイル | 責務 | 主要エクスポート |
|-------------|------|---------------|
| `server/auth.ts` | 認証トークン取得 | `getBackendToken`, `getCSRFToken` |
| `server/backend-rest-client.ts` | 汎用 REST 呼び出し | `callBackendAPI<T>`, `callBackendAPIWithBody` |
| `server/feed-api.ts` | フィード関連 REST/RPC | `getFeedStats`, `updateFeedReadStatus`, `getFeedsWithCursor` 等 |
| `server/tag-trail-api.ts` | Tag Trail REST | `getRandomSubscription`, `getArticlesByTag` 等 |

`api.ts` は37行の barrel re-export に縮小。

### Step 3: `streamingRenderer.ts` を責務別に分割

| 新規ファイル | 責務 |
|-------------|------|
| `utils/sse-parser.ts` | SSE ストリーム解析 (`parseSSEStream`, `SSEEvent` 型) |
| `utils/sse-processors.ts` | ドメイン別 SSE 処理 (`processAugurStreamingText`, `processSummarizeStreamingText`, `processGenericStreamingText`) |

`streamingRenderer.ts` はコアレンダラー (`createStreamingRenderer`, `simulateTypewriterEffect`) のみを保持し、SSE 関連を re-export。既存テスト (`streamingRenderer.test.ts`, `streamingRenderer_sse.test.ts`) は変更不要。

### Step 4: `streamingAdapter.ts` のチャンク処理重複排除

`streamSummarizeWithRenderer` と `streamSummarizeWithAbortAdapter` で同一だったチャンク処理コールバック (~25行) を `createChunkProcessor(renderer, rendererOptions)` に抽出。

```typescript
function createChunkProcessor(renderer, rendererOptions) {
  let articleId = "", wasCached = false, hasReceivedData = false, isFirstChunk = true;
  const processChunk = async (chunk) => { /* 共通ロジック */ };
  const getState = () => ({ articleId, wasCached, hasReceivedData });
  return { processChunk, getState };
}
```

**削減**: 258行 → 198行 (60行削減)

### Step 5: `feeds.ts` のストリーミング応答処理重複排除

`streamSummarize` と `streamSummarizeWithAbort` が共有する応答蓄積ロジックを2つのヘルパーに抽出。

```typescript
function processStreamResponse(response, acc) { /* 共通の蓄積ロジック */ }
function toSummarizeChunk(response) { /* 共通の型変換 */ }
```

**削減**: ~30行

### Step 6: `feeds.ts` を責務別に分割

| 新規ファイル | 責務 | 主要エクスポート |
|-------------|------|---------------|
| `feeds/client.ts` | クライアント生成・共通ヘルパー | `createFeedClient`, `convertProtoFeed`, `normalizeUrl`, 型定義 |
| `feeds/stats.ts` | 統計取得 | `getFeedStats`, `getDetailedFeedStats`, `getUnreadCount` |
| `feeds/listing.ts` | フィード一覧・検索 | `getUnreadFeeds`, `getAllFeeds`, `getReadFeeds`, `getFavoriteFeeds`, `searchFeeds` |
| `feeds/streaming.ts` | ストリーミング | `streamFeedStats`, `streamSummarize`, `streamSummarizeWithAbort` + リトライロジック |
| `feeds/actions.ts` | 操作系 | `markAsRead`, `listSubscriptions`, `subscribe`, `unsubscribe` |

`feeds.ts` は54行の barrel re-export に縮小。`connect/index.ts` は変更不要。

### Step 7: `sse.ts` の重複排除

`setupSSE` を `setupSSEWithReconnect(endpoint, onData, onError, 0)` への委譲に書き換え。

```typescript
// Before: 47行の独立実装
export function setupSSE(endpoint, onData, onError) { /* ... */ }

// After: 5行の委譲
export function setupSSE(endpoint, onData, onError) {
  const { eventSource } = setupSSEWithReconnect(endpoint, onData, onError, 0);
  return eventSource;
}
```

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `npx vitest run` | 370 tests passed (29 files) |
| `bun run build` | ビルド成功 |
| `bun run check` | 0 errors, 0 warnings |
| コンテナ再ビルド・起動 | healthy |
| ヘルスチェック (`/api/health`) | 200 OK |

### 変更しなかったもの（既に良いパターン）

- `src/lib/api/client/` — ドメイン別に整理済み
- `src/lib/connect/augur.ts`, `rss.ts`, `articles.ts`, `morning_letter.ts`, `recap.ts`, `tts.ts` — 単一責務
- `src/lib/hooks/`, `src/lib/stores/`, `src/lib/domain/` — 問題なし
- `src/lib/connect/transport-*.ts` — 良い構造

## PROS

1. **責務の明確化** — 各ファイルが単一の責務を持ち、変更理由が1つになった
2. **テスタビリティ向上** — 小さなモジュールは個別にテスト可能（例: `auth.ts` のみ、`sse-parser.ts` のみ）
3. **コードナビゲーション改善** — ファイル名から内容が推測可能（`feeds/streaming.ts` はストリーミング関連）
4. **DRY 改善** — 約190行の重複コードを排除
5. **後方互換性** — barrel re-export により既存コードの変更ゼロ
6. **段階的な依存移行** — 新規コードは直接サブモジュールをインポート可能。barrel 経由も引き続き動作

## CONS, TRADEOFF

1. **ファイル数の増加** — 5ファイルが18ファイルに増加。ただし各ファイルは100-300行で読みやすい
2. **barrel re-export のオーバーヘッド** — 間接層が1つ増えるが、Tree shaking により本番バンドルへの影響はない
3. **ファイルとディレクトリの共存** — `feeds.ts` (barrel) と `feeds/` (ディレクトリ) が共存する構造は一般的でないが、TypeScript のモジュール解決規則で一意に解決される

## APPENDIX

### ファイル構造の変更一覧

```
src/lib/
├── api.ts                           (553行 → 37行 barrel)
├── api/sse.ts                       (202行 → 180行, setupSSE を委譲化)
├── server/
│   ├── auth.ts                      (NEW: 認証)
│   ├── backend-rest-client.ts       (NEW: REST 基盤 + callBackendAPIWithBody)
│   ├── feed-api.ts                  (NEW: フィード REST)
│   └── tag-trail-api.ts             (NEW: Tag Trail REST)
├── utils/
│   ├── streamingRenderer.ts         (441行 → 225行 core + re-export)
│   ├── sse-parser.ts                (NEW: SSE 解析)
│   └── sse-processors.ts            (NEW: ドメイン別 SSE 処理)
└── connect/
    ├── feeds.ts                     (848行 → 54行 barrel)
    ├── feeds/
    │   ├── client.ts                (NEW: クライアント・型・ヘルパー)
    │   ├── stats.ts                 (NEW: 統計)
    │   ├── listing.ts               (NEW: 一覧・検索)
    │   ├── streaming.ts             (NEW: ストリーミング + リトライ)
    │   └── actions.ts               (NEW: 既読・購読管理)
    ├── streamingAdapter.ts          (258行 → 198行, createChunkProcessor 抽出)
    └── index.ts                     (変更なし)
```

### 行数の変化

| 指標 | Before | After |
|------|--------|-------|
| 対象ファイル総行数 | 2,302 | 2,107 |
| 重複コード行数 (推定) | ~190 | 0 |
| 最大ファイル行数 | 848 (`feeds.ts`) | 310 (`feeds/streaming.ts`) |
| ファイル数 | 5 | 18 (うち3つは barrel) |
