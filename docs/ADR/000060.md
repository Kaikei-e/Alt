# SvelteKit開発環境の最小構成スタック（altctl up dev）

## ステータス

採択（Accepted）

## コンテキスト

### 問題

SvelteKitフロントエンド（alt-frontend-sv）の開発時に、フルスタック（db, auth, core, workers）を起動する必要があり、起動時間とリソース消費が大きい。

### 背景

- Alt プラットフォームは Docker Compose でマイクロサービスを管理
- `altctl` CLI ツールでスタック単位の起動・停止を行う
- 現行の `core` スタックは nginx, alt-frontend（Next.js）, alt-frontend-sv, alt-backend, migrate を含む
- Next.js版（alt-frontend）は今後廃止予定
- 認証には Kratos + auth-hub が必要で、JWT トークンでバックエンド認証を行う

### 要件

1. SvelteKit フロントエンドを HMR（Hot Module Replacement）対応で起動
2. 実際のバックエンドと DB を使用（モックデータではなく実データ）
3. 認証サービス（Kratos, auth-hub）は不要
4. 最小のリソース消費
5. 本番コードに認証バイパスロジックを入れない（セキュリティ）

## 決定

### アーキテクチャ: モックサーバーで正規JWT生成方式

既存の E2E テスト用モックサーバー（`mock-server.ts`）を拡張し、共有シークレットで正規の JWT トークンを生成する方式を採用。

```
┌─────────────────────────────────────────────────────────────┐
│                    altctl up dev                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐    JWT Token    ┌──────────────────┐     │
│  │  mock-auth   │ ──────────────→ │  alt-frontend-sv │     │
│  │  (4001/4002) │                 │     (4173)       │     │
│  └──────────────┘                 └────────┬─────────┘     │
│         │                                  │               │
│         │ 同じシークレット                   │ API Request   │
│         │                                  │ + JWT Token   │
│         ▼                                  ▼               │
│  ┌──────────────────────────────────────────────┐          │
│  │              alt-backend (9000)              │          │
│  │         JWT検証OK（シークレット一致）           │          │
│  └──────────────────────┬───────────────────────┘          │
│                         │                                  │
│                         ▼                                  │
│                  ┌──────────────┐                          │
│                  │   db (5432)  │                          │
│                  │  PostgreSQL  │                          │
│                  └──────────────┘                          │
└─────────────────────────────────────────────────────────────┘
```

### 1. dev スタックを altctl に追加

```go
// altctl/internal/stack/registry.go
{
    Name:        "dev",
    Description: "Development stack (SvelteKit + mock-auth + backend + db)",
    ComposeFile: "dev.yaml",
    Services:    []string{"mock-auth", "alt-frontend-sv", "alt-backend", "db", "migrate"},
    DependsOn:   []string{"base"},  // auth スタックに依存しない
    Profile:     "dev",
    Optional:    true,
}
```

### 2. mock-server.ts に JWT 生成機能を追加

```typescript
// alt-frontend-sv/tests/e2e/infra/mock-server.ts
import jwt from "jsonwebtoken";

const DEV_JWT_SECRET = process.env.BACKEND_TOKEN_SECRET || "dev-secret-for-local";

function generateBackendToken(): string {
    return jwt.sign(
        { email: "dev@localhost", role: "admin", sid: "dev-session" },
        DEV_JWT_SECRET,
        {
            subject: "00000000-0000-0000-0000-000000000001",
            issuer: "auth-hub",
            audience: "alt-backend",
            expiresIn: "24h",
        },
    );
}
```

### 3. compose/dev.yaml を作成

| サービス | ポート | 説明 |
|----------|--------|------|
| mock-auth | 4001, 4002 | モック Kratos/AuthHub（JWT生成） |
| alt-frontend-sv | 4173, 24678 | SvelteKit（HMR対応） |
| alt-backend | 9000, 9101 | 実際のバックエンド |
| db | 5432 | PostgreSQL |
| migrate | - | DBマイグレーション |

### 使用方法

```bash
# 開発環境を起動
altctl up dev

# または直接
docker compose -f compose/base.yaml -f compose/dev.yaml up -d

# 停止
altctl down dev
```

## 結果

### メリット

1. **セキュリティ**: 本番コードに認証バイパスロジックが入らない
2. **最小構成**: 5サービスのみ（フルスタックは10+サービス）
3. **高速起動**: auth スタック不要で起動時間短縮
4. **HMR対応**: フロントエンド開発の即座の反映
5. **実データ**: 実際のバックエンドとDBを使用
6. **E2Eインフラ再利用**: 既存のモックサーバーを活用

### トレードオフ

1. **モックサーバーの依存追加**: jsonwebtoken パッケージを devDependencies に追加
2. **シークレット共有**: DEV_JWT_SECRET を mock-auth と alt-backend で共有
   - 本番では使用されない値なのでリスクは低い
3. **一部機能制限**: workers スタックのサービス（search-indexer等）は使用不可
   - 検索機能をテストする場合は `altctl up dev workers` で追加起動

### 検討した代替案

| 方式 | 採用 | 理由 |
|------|------|------|
| AUTH_DISABLED環境変数 | 不採用 | 本番コードに認証バイパスが入る |
| ビルドタグ方式（-tags dev） | 不採用 | ビルドが複雑化 |
| 環境変数+二重チェック | 不採用 | それでも誤設定リスクあり |
| **モックサーバーJWT生成** | **採用** | 本番コード変更なし、最もセキュア |

## 実装

### 実装日: 2026-01-08

### 修正ファイル一覧

| カテゴリ | ファイル | 変更内容 |
|---------|---------|---------|
| Stack Registry | `altctl/internal/stack/registry.go` | dev スタック追加 |
| Stack Test | `altctl/internal/stack/registry_test.go` | 新規: dev スタックのテスト |
| Compose | `compose/dev.yaml` | 新規: 開発環境定義 |
| Mock Server | `alt-frontend-sv/tests/e2e/infra/mock-server.ts` | JWT生成機能追加 |
| Dockerfile | `alt-frontend-sv/tests/e2e/infra/Dockerfile.mock-auth` | 新規: mock-auth コンテナ |
| Dependencies | `alt-frontend-sv/package.json` | jsonwebtoken 追加 |

### テスト結果

**altctl Unit Tests**:
```
ok  github.com/alt-project/altctl/internal/stack  0.002s
```

**Dry Run**:
```bash
$ ./altctl up dev --dry-run
Starting Stacks
───────────────
  • base: Shared resources (secrets, networks, volumes)
  • dev: Development stack (SvelteKit + mock-auth + backend + db)

[dry-run] docker compose -f .../compose/base.yaml -f .../compose/dev.yaml up -d
✓ Stacks started successfully
```

## スタック依存関係

```
base
  └── dev (mock-auth, alt-frontend-sv, alt-backend, db, migrate)
        ↑ auth スタックに依存しない（モックで代替）
```

## 関連ADR

- ADR-057: 検索機能のエラーハンドリング改善とスタック依存関係の明確化

## 参考

- スタック定義: `altctl/internal/stack/registry.go`
- モックサーバー: `alt-frontend-sv/tests/e2e/infra/mock-server.ts`
- 開発用Compose: `compose/dev.yaml`
- SvelteKit Docker Best Practices: https://medium.com/@balazs.csaba.diy/optimized-dockerfile-for-sveltekit-applications-from-experience-and-best-practices-99603d8d1303
