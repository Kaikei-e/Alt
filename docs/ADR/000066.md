# Augur レスポンスの literal `\n` 問題と Markdown レンダリング修正

## ステータス

採択（Accepted）

## コンテキスト

### 問題

Augur（AI Q&A 機能）のレスポンスにおいて、改行が正しく表示されず `\n` という2文字（バックスラッシュと n）がそのまま画面に表示されていた。これにより Markdown も正しくレンダリングされなかった。

### 再現条件

- Augur UI で質問を送信
- レスポンスに `## 見出し \n ### サブ見出し \n - リスト項目` のように literal `\n` が表示される
- Markdown ヘッダー（`##`, `###`）が HTML として変換されない

### 技術的背景

Augur のデータフロー：

```
alt-frontend-sv (Svelte, port 4173)
  ↓ Connect-RPC
alt-backend (Go, port 9000)
  ↓ HTTP/SSE
rag-orchestrator (Go, port 9010)
  ↓ Ollama API
LLM (gpt-oss:20b)
```

GPT-OSS:20B モデルには以下の既知の問題がある：
- Structured Output の不安定性
- JSON エスケープの二重化（`\\n` を出力）
- Harmony Format による予期しない出力

参考: [Ollama GPT-OSS Structured Output Issues](https://www.glukhov.org/post/2025/10/ollama-gpt-oss-structured-output-issues/)

## 決定

### 根本原因

2つの問題が重複していた：

#### 1. `extractAnswerOnly()` のエスケープ処理バグ

**ファイル**: `rag-orchestrator/internal/usecase/output_validator.go:128-144`

```go
// Before (BUG)
if escaped {
    sb.WriteByte(c)  // 'n' をそのまま書き込む
    escaped = false
    continue
}
```

JSON エスケープ `\n` を見つけた時、`n` という文字をそのまま書き込んでいた。正しくは `'\n'`（改行文字）に変換すべき。

#### 2. モデルが literal `\n` を出力

GPT-OSS:20B が JSON の `"answer"` フィールドに `\\n`（二重エスケープ）を出力することがあり、JSON パース後に literal `\n`（2文字）が残る。

### 修正方針

**多層防御アプローチ**を採用：

| レイヤー | 修正内容 | 役割 |
|---------|---------|------|
| rag-orchestrator | `extractAnswerOnly()` 修正 | JSON エスケープの正しい変換 |
| rag-orchestrator | `convertLiteralEscapes()` 追加 | モデル出力の後処理 |
| alt-frontend-sv | `simpleMarkdown.ts` 修正 | フロントエンドの Safety Net |
| rag-orchestrator | プロンプト改善 | モデルへの明示的指示 |

## 結果

### 修正ファイル

| ファイル | 変更内容 |
|---------|---------|
| `rag-orchestrator/internal/usecase/output_validator.go` | `extractAnswerOnly()` に switch 文追加、`convertLiteralEscapes()` 関数追加 |
| `rag-orchestrator/internal/usecase/output_validator_test.go` | 新規テスト追加 |
| `rag-orchestrator/internal/usecase/prompt_builder.go` | JSON エスケープの明示的指示追加 |
| `alt-frontend-sv/src/lib/utils/simpleMarkdown.ts` | `text.replace(/\\n/g, "\n")` 追加 |
| `alt-frontend-sv/src/lib/utils/simpleMarkdown.test.ts` | テスト追加 |

### 実装詳細

#### Fix 1: `extractAnswerOnly()` 修正

```go
if escaped {
    switch c {
    case 'n':
        sb.WriteByte('\n')
    case 'r':
        sb.WriteByte('\r')
    case 't':
        sb.WriteByte('\t')
    case '"':
        sb.WriteByte('"')
    case '\\':
        sb.WriteByte('\\')
    default:
        sb.WriteByte(c)
    }
    escaped = false
    continue
}
```

#### Fix 2: Post-processing

```go
func convertLiteralEscapes(s string) string {
    return strings.ReplaceAll(s, "\\n", "\n")
}
```

**注意**: `\t` は変換しない。`C:\temp` のようなパスで誤変換を起こすため。

#### Fix 3: フロントエンド Safety Net

```typescript
export function parseMarkdown(text: string): string {
    if (!text) return "";

    // Safety net: convert literal \n to actual newlines
    text = text.replace(/\\n/g, "\n");

    const lines = text.split("\n");
    // ...
}
```

#### Fix 4: プロンプト改善

```go
sysSb.WriteString("11. CRITICAL: In the JSON answer field, use proper JSON escape sequences for newlines (\\n), not literal backslash-n characters.\n")
sysSb.WriteString("    For example: \"Line 1\\nLine 2\" is correct. \"Line 1\\\\nLine 2\" is WRONG.\n")
```

### メリット

1. **多層防御**: バックエンド・フロントエンド両方で対応し、どこかで漏れても補完
2. **後方互換性**: 既存の正常なレスポンスに影響なし
3. **テスト完備**: ユニットテストで回帰を防止

### トレードオフ

1. **`\t` 非対応**: パス文字列の誤変換を避けるため、タブは literal のまま残る可能性
2. **パフォーマンス**: `strings.ReplaceAll` の追加処理（影響は軽微）

### 検討した代替案

| 代替案 | 却下理由 |
|--------|----------|
| モデル変更（GPT-OSS 以外） | インフラ変更のコストが高い |
| フロントエンドのみで対応 | バックエンドのバグが残る |
| 正規表現で複雑なパース | 保守性が低下 |

## 実装

### 実装日: 2026-01-09

### テスト

#### rag-orchestrator

```bash
cd rag-orchestrator && go test ./internal/usecase/...
```

テストケース：
- `TestOutputValidator_Validate_EscapeSequences`
- `TestExtractAnswerOnly_EscapeSequences`
- `TestOutputValidator_Validate_LiteralBackslashN`
- `TestOutputValidator_ConvertLiteralEscapes_OnlyNewlines`

#### alt-frontend-sv

```bash
cd alt-frontend-sv && pnpm test
```

テストケース：
- `literal escape sequences` describe block

### 検証

```bash
# 型チェック
cd rag-orchestrator && go vet ./...
cd alt-frontend-sv && pnpm check

# ユニットテスト
cd rag-orchestrator && go test ./...
cd alt-frontend-sv && pnpm test
```

- rag-orchestrator: go test PASS
- alt-frontend-sv: 108 テストすべてパス

### デプロイ

```bash
docker compose -f compose/compose.yaml build rag-orchestrator alt-frontend-sv
docker compose -f compose/compose.yaml up -d rag-orchestrator alt-frontend-sv
```

### 手動検証項目

1. Augur UI（http://localhost:4173）で質問を送信
2. レスポンスに `\n` が literal として表示されないこと
3. Markdown ヘッダー（`##`, `###`）が正しくレンダリングされること
4. リスト（`-`, `1.`）が正しく表示されること

## 関連

- [LocalAI Issue #6412: Response mangled with gpt-oss-20b](https://github.com/mudler/LocalAI/issues/6412)
- [Ollama GPT-OSS Structured Output Issues](https://www.glukhov.org/post/2025/10/ollama-gpt-oss-structured-output-issues/)
- [Solving Markdown Newline Issues in LLM Stream Responses](https://yingjiezhao.com/en/articles/Solving-Markdown-Newline-Issues-in-LLM-Stream-Responses/)
- [LangChain JSON Parser - Newline Handling](https://datastax.github.io/ragstack-ai/api_reference/0.5.0/langchain/_modules/langchain_core/output_parsers/json.html)
