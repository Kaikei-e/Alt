# pre-processor の GetSystemUserID にリトライロジックを追加

## ステータス

採択（Accepted）

## コンテキスト

### 背景

pre-processor のパフォーマンス分析において、`failed to get system user id` エラーが多発していることが判明した。このエラーは依存サービスの一時的な障害時に発生し、リトライなしで即座に失敗していた。

### 問題

1. `GetSystemUserID` にリトライロジックがない
2. 依存サービスチェーン（pre-processor → alt-backend → auth-hub → Kratos）のいずれかが一時的に利用不可になるとエラー
3. サービス起動順序やネットワーク一時障害で頻繁にエラーが記録される
4. 一度失敗するとキャッシュされず、1時間後の再試行まで同じエラーが継続

### 依存チェーン

```
pre-processor (GetSystemUserID)
    ↓ HTTP GET /v1/internal/system-user
alt-backend (internal_handlers.go)
    ↓
auth-hub (KratosClient)
    ↓ GET /admin/identities
Kratos Admin API
```

## 決定

`GetSystemUserID` に exponential backoff リトライロジックを追加する。

### リトライ設計

| パラメータ | 値 | 根拠 |
|-----------|-----|------|
| 最大試行回数 | 3 | 一時的障害に対応しつつ、永続的障害は早期に検出 |
| 初期待機時間 | 2秒 | 依存サービスの再起動に対応 |
| バックオフ係数 | 2倍 | 2秒 → 4秒 の指数増加 |
| 最大待機時間 | 約6秒 | 3回の試行で最大14秒（2+4+8秒） |

### 実装内容

#### 1. リトライラッパー追加

```go
// repository/external_api_repository.go
func (r *externalAPIRepository) GetSystemUserID(ctx context.Context) (string, error) {
    const maxRetries = 3
    baseDelay := 2 * time.Second

    var lastErr error
    for attempt := 0; attempt < maxRetries; attempt++ {
        userID, err := r.getSystemUserIDOnce(ctx)
        if err == nil {
            return userID, nil
        }
        lastErr = err

        if ctx.Err() != nil {
            return "", ctx.Err()
        }

        if attempt < maxRetries-1 {
            delay := baseDelay * time.Duration(1<<attempt)
            r.logger.Warn("GetSystemUserID failed, retrying",
                "attempt", attempt+1,
                "delay", delay,
                "error", err)

            select {
            case <-ctx.Done():
                return "", ctx.Err()
            case <-time.After(delay):
            }
        }
    }
    return "", fmt.Errorf("GetSystemUserID failed after %d attempts: %w", maxRetries, lastErr)
}
```

#### 2. 単一試行ロジック分離

```go
// getSystemUserIDOnce performs a single attempt
func (r *externalAPIRepository) getSystemUserIDOnce(ctx context.Context) (string, error) {
    // 既存のHTTPリクエストロジック
}
```

## 結果

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `pre-processor/app/repository/external_api_repository.go` | リトライロジック追加 |
| `pre-processor/app/repository/external_api_repository_test.go` | リトライテスト追加 |

### テストケース

| テスト | 内容 |
|-------|------|
| should_retry_on_transient_failure_and_succeed | 2回失敗→3回目成功 |
| should_fail_after_max_retries_exceeded | 3回失敗でエラー |
| should_respect_context_cancellation_during_retry | キャンセル時即座に終了 |

### 効果

- 一時的なネットワーク障害や依存サービスの再起動時、最大14秒のリトライで復旧可能
- ログに `GetSystemUserID failed, retrying` が出力され、問題の追跡が容易
- サービス起動順序に依存しにくくなり、耐障害性が向上

### トレードオフ

| PROS | CONS |
|------|------|
| 一時障害への耐性向上 | 永続的障害時に最大14秒の遅延 |
| 起動順序依存の軽減 | リトライ中はgoroutineがブロック |
| デバッグ容易性向上 | テスト実行時間増加（待機時間のため） |

## 実装日

2026-01-15

## 関連

- [Go slog Package](https://pkg.go.dev/log/slog) - 構造化ログ
- [Exponential Backoff](https://en.wikipedia.org/wiki/Exponential_backoff) - リトライ戦略
