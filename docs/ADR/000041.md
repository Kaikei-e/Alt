# Dockerfile セキュリティ・効率・ビルド速度の最適化

## ステータス

**承認済み（Accepted）** - 2026年1月

## コンテキスト

### 背景

Alt プロジェクトには 33 個の Dockerfile が存在し、Go、Rust、Python、Deno、Bun/Node.js など複数の言語・ランタイムで構成されている。これらの Dockerfile には以下の問題があった：

1. **セキュリティリスク**
   - root ユーザーでコンテナ実行
   - `alpine:latest` など不特定バージョンのベースイメージ使用
   - Deno の `--allow-all` による過剰な権限付与

2. **イメージサイズの肥大化**
   - Alpine/Debian ベースイメージ使用（シェル・パッケージマネージャ含む）
   - ビルドツールがランタイムイメージに残存

3. **ビルド速度の低下**
   - 依存関係キャッシュの非効率なレイヤー順序
   - Python で `pip install uv` を毎回実行

### 対象サービス

| 言語 | サービス数 | 主なサービス |
|------|-----------|-------------|
| Go | 8 | alt-backend, pre-processor, auth-hub, search-indexer |
| Rust | 3 | rask-log-aggregator, rask-log-forwarder, recap-worker |
| Python | 8 | tag-generator, recap-subworker, dashboard |
| Deno | 2 | auth-token-manager, alt-perf |
| Bun/Node.js | 3 | alt-frontend, alt-frontend-sv |

## 意思決定

### 決定 1: Go/Rust/Deno サービスに distroless イメージを採用

**変更前:**
```dockerfile
FROM alpine:latest
CMD ["/usr/local/bin/app"]
```

**変更後:**
```dockerfile
FROM gcr.io/distroless/static-debian12:nonroot
USER nonroot:nonroot
ENTRYPOINT ["/server"]
```

**理由:**
- distroless はシェル・パッケージマネージャを含まず、攻撃対象領域を最小化
- `:nonroot` タグで非 root ユーザー（UID 65532）がプリセット
- Google が CVE 対応を継続的に実施

**ベースイメージ選択基準:**

| イメージ | 用途 | サイズ |
|---------|------|--------|
| `gcr.io/distroless/static-debian12` | CGO_ENABLED=0 の Go バイナリ | ~2MB |
| `gcr.io/distroless/cc-debian12` | libc 依存の Rust バイナリ | ~20MB |
| `gcr.io/distroless/cc` | Deno ランタイム | ~20MB |

### 決定 2: Go ビルドフラグの最適化

**変更前:**
```dockerfile
RUN CGO_ENABLED=0 GOOS=linux go build -o app .
```

**変更後:**
```dockerfile
RUN CGO_ENABLED=0 GOOS=linux go build \
    -ldflags="-s -w" \
    -o server .
```

**理由:**
- `-s`: シンボルテーブル除去
- `-w`: DWARF デバッグ情報除去
- バイナリサイズ 20-30% 削減

### 決定 3: Python で uv を公式イメージからコピー

**変更前:**
```dockerfile
RUN pip install --no-cache-dir uv
```

**変更後:**
```dockerfile
COPY --from=ghcr.io/astral-sh/uv:0.5.14 /uv /uvx /bin/
ENV UV_COMPILE_BYTECODE=1 UV_LINK_MODE=copy
RUN --mount=type=cache,target=/root/.cache/uv uv sync --frozen --no-dev
```

**理由:**
- pip インストールを省略しビルド時間短縮
- バージョン固定で再現性確保
- キャッシュマウントでダウンロード時間削減

### 決定 4: Rust で依存関係キャッシュレイヤーを最適化

**変更前:**
```dockerfile
COPY . .
RUN cargo build --release
```

**変更後:**
```dockerfile
COPY Cargo.toml Cargo.lock ./
RUN mkdir src && echo "fn main() {}" > src/main.rs && \
    cargo build --release && \
    rm -rf src target/release/deps/rask*

COPY . .
RUN cargo build --release
```

**理由:**
- 依存関係のみを先にビルドしてキャッシュ
- ソースコード変更時も依存関係レイヤーを再利用

### 決定 5: Deno の権限を最小化

**変更前:**
```dockerfile
CMD ["run", "--allow-all", "main.ts", "daemon"]
```

**変更後:**
```dockerfile
ENTRYPOINT ["/bin/deno", "run", \
    "--allow-net", \
    "--allow-read=/app,/run/secrets", \
    "--allow-write=/app/secrets", \
    "--allow-env", \
    "main.ts", "daemon"]
```

**理由:**
- 最小権限の原則に従い、必要な権限のみ付与
- ファイルシステムアクセスを特定パスに制限
- `/run/secrets`: Docker secrets へのアクセスを許可

## 結果

### 修正ファイル一覧

**Go (8ファイル):**
- `alt-backend/Dockerfile.backend`
- `pre-processor/Dockerfile.preprocess`
- `pre-processor/Dockerfile`
- `search-indexer/Dockerfile.search-indexer`
- `auth-hub/Dockerfile`
- `pre-processor-sidecar/Dockerfile.pre-processor-sidecar`
- `rag-orchestrator/Dockerfile`
- `alt-backend/sidecar-proxy/Dockerfile` - 既に最適化済み

**Rust (3ファイル):**
- `rask-log-aggregator/Dockerfile.rask-log-aggregator`
- `rask-log-forwarder/app/Dockerfile.rask-log-forwarder`
- `recap-worker/Dockerfile.recap-worker`

**Python (4ファイル):**
- `tag-generator/Dockerfile.tag-generator`
- `recap-subworker/Dockerfile.recap-subworker`
- `dashboard/Dockerfile`
- `recap-evaluator/Dockerfile`

**Deno (2ファイル):**
- `auth-token-manager/Dockerfile`
- `alt-perf/Dockerfile`

**Bun (1ファイル):**
- `alt-frontend-sv/Dockerfile`

### PROS

1. **セキュリティ向上**
   - 全サービスで非 root ユーザー実行
   - distroless 採用で CVE 60%+ 削減（Google 報告値）
   - シェル/パッケージマネージャ除去でリモートコード実行リスク低減

2. **イメージサイズ削減**
   - Go: ~200MB → ~20MB (90% 削減)
   - Rust: ~100MB → ~30MB (70% 削減)
   - Python: ビルドツール除去で 30-40% 削減

3. **ビルド速度向上**
   - キャッシュマウント活用で依存関係ダウンロード省略
   - 依存関係先行コピーでレイヤーキャッシュ効率化

4. **保守性向上**
   - バージョン固定による再現性確保
   - コメント追加によるドキュメント化

### CONS, TRADEOFF

1. **デバッグ困難化**
   - distroless にはシェルがないため `kubectl exec` 不可
   - 対策: `kubectl debug` でエフェメラルコンテナを使用

2. **一部サービスで distroless 使用不可**
   - `recap-worker`: PyTorch ライブラリ依存で debian-slim 継続
   - `alt-perf`: Chrome 必要で debian 継続
   - `news-creator`: Ollama ベースイメージ固定

3. **初回ビルド時間増加の可能性**
   - キャッシュマウントは 2 回目以降で効果発揮
   - CI 環境でキャッシュ永続化が必要

## 付録

### ベストプラクティス参照元

- [Docker Best Practices](https://docs.docker.com/build/building/best-practices/)
- [Go: distroless vs scratch](https://medium.com/google-cloud/alpine-distroless-or-scratch-caac35250e0b)
- [Python with uv](https://docs.astral.sh/uv/guides/integration/docker/)
- [Rust musl builds](https://github.com/clux/muslrust)
- [Deno Distroless](https://github.com/denoland/deno_docker)

### distroless デバッグ方法

```bash
# kubectl debug でエフェメラルコンテナをアタッチ
kubectl debug -it <pod-name> --image=busybox:1.36 --target=<container-name>

# Docker の場合
docker run --rm -it --pid=container:<container-id> busybox
```

### 今後の改善

1. **Trivy/Docker Scout によるイメージスキャン CI 統合**
2. **Renovate/Dependabot によるベースイメージ自動更新**
3. **残存サービス（news-creator 等）の段階的最適化**
