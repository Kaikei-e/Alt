# プロンプト生成とRAGオーケストレータ最適化に関するADR

## ステータス

提案（Proposed）

## コンテキスト

Alt の rag-orchestrator では、LLM を用いた検索拡張生成（RAG）のために複数のユースケースが実装されている。現在のプロンプト生成 (XMLPromptBuilder) は <context>、<instructions>、<query>、<format> の4セクションから構成され、defaultInstructions では「300〜500語で書く」「全文を日本語化する」など多くのルールが記述されている[[1]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/prompt_builder.go#:~:text=sb.WriteString%28fmt.Sprintf%28%22%3Ccontext%20version%3D%5C%22)[[2]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/prompt_builder.go#:~:text=defaultInstructions%20%3A%3D%20%5B%5Dstring)。

コンテキスト取得 (retrieve\_context\_usecase.go) は日本語クエリを英訳してからベクトル化し、chunkRepo.Search で上位5件のチャンクを取得している[[3]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/retrieve_context_usecase.go#:~:text=func%20%28u%20,RetrieveContextOutput%2C%20error%29)[[4]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/retrieve_context_usecase.go#:~:text=%2F%2F%202)。取得した ContextItem のテキスト全体をプロンプトに挿入するため、プロンプトが冗長になりやすい。また、searchLimit が固定値であり、同義語や不要語の除去は行っていない。

answer\_with\_rag\_usecase.go の buildPrompt は取得したコンテキストを PromptBuilder.Build に渡してプロンプト文字列を生成し、LLM に問い合わせている[[5]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/answer_with_rag_usecase.go#:~:text=context.Context%2C%20input%20AnswerWithRAGInput%29%20%28,answerWithRAGUsecase)。output\_validator.go は LLM から返された JSON を厳密に解析し、必要に応じて修復する[[6]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/output_validator.go)。

ユーザからは以下の課題が報告されている： - ソースが決定した後、LLM の最初のトークンが返るまでの TTFT が長い。 - トークン列受信後も謎の待ち時間が生じることがある。 - 基礎的な概念に関する質問でも「ナレッジベースに情報がない」と返される。記事を取り込んでいるにもかかわらず、適切な文脈が取得できていない可能性がある。

改善のためには、プロンプト生成の冗長性削減、コンテキストの質向上、検索アルゴリズムの精度向上、LLM 呼び出しの構造化、キャッシュ利用など多面的な対策が必要である。

## 決定

1. **システムプロンプトの導入とプロンプト構造の簡素化**
2. defaultInstructions の恒常的なルールを systemPrompt 定数として切り出し、LLM の system メッセージとして渡す。これにより命令文の重複を避け、プロンプトサイズを削減する。
3. XMLPromptBuilder.Build は <context> と <query> のみを出力し、<instructions> と <format> セクションを削除する[[1]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/prompt_builder.go#:~:text=sb.WriteString%28fmt.Sprintf%28%22%3Ccontext%20version%3D%5C%22)。JSON 出力形式や引用規則は systemPrompt で定義する。
4. answer\_with\_rag\_usecase.go では systemPrompt とユーザープロンプトを結合した messages 配列を構築し、LLM の ChatCompletion API に渡すようリファクタリングする。
5. **コンテキスト要約の導入**
6. retrieve\_context\_usecase.go に summarizeContext 関数を追加し、ChunkText を 200〜300字程度の要約に圧縮する。要約には既存の llmClient を使い、要約に失敗した場合は原文を使用する。
7. PromptContext には要約済みテキストを渡し、プロンプトの長さを大幅に減らすことで TTFT を短縮する。
8. **クエリ前処理と検索精度の向上**
9. retrieve\_context\_usecase.go に normalizeQuery 関数を追加し、日本語と英語双方でストップワード除去と簡易形態素解析を行う。同義語展開テーブルを定義し、関連する語を複数追加検索語として使用する。
10. searchLimit を固定値5から設定ファイルで変更可能な値にし、初回は最大10〜15件を取得した上でスコア閾値によりフィルタリングする[[4]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/retrieve_context_usecase.go#:~:text=%2F%2F%202)。
11. **キャッシュと再利用の導入**
12. answer\_with\_rag\_usecase.go にキャッシュ構造（例：sync.Map）を追加し、クエリと候補記事IDをキーに promptData と contexts を保存する。短期間の繰り返しクエリに対してベクトル計算・プロンプト生成を再利用することで応答時間を削減する。
13. **LLM 呼び出しの二段階化とストリーミングの強化**
14. 引用句抽出と回答生成を分割する。第1フェーズでは <context> と <query> だけを渡し、3〜5個の引用句を JSON で返すよう LLM に指示する。第2フェーズでは引用句と要約済み文脈を基に本回答を生成させる。
15. 両フェーズで stream: true を使用し、最初のチャンクが届いた時点でユーザへストリームイベントを返す。sendStreamEvent の呼び出しはこの構造に合わせて調整する[[5]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/answer_with_rag_usecase.go#:~:text=context.Context%2C%20input%20AnswerWithRAGInput%29%20%28,answerWithRAGUsecase)。
16. **出力バリデータの挙動改善とメトリクス収集**
17. output\_validator.go で Quotes や Citations が欠落していても回答本文が存在すれば処理を継続し、Reason に理由を設定してログ出力する[[6]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/output_validator.go)。
18. answer\_with\_rag\_usecase.go でプロンプト生成開始・LLM 呼び出し開始・最初のストリームチャンク受信時刻を記録し、TTFT や処理時間をメトリクスとしてログに出力する。

## 結果・影響

### 利点

* プロンプトサイズが削減され、LLM への入力トークン数が減ることで TTFT が短縮される。
* コンテキストが要約されるため、重要なポイントに集中した回答が期待でき、ナレッジベースに情報が存在するにも関わらず回答できないケースを減らせる。
* クエリ前処理と検索範囲拡大により、関連する記事やチャンクがより多く取得され、精度が向上する。
* キャッシュ利用により同一質問への繰り返し応答が高速化される。
* 二段階 LLM 呼び出しとストリーミングの改善により、初動レスポンスが早くなりユーザ体験が向上する。
* 出力バリデータが柔軟になり、部分的に不完全な JSON 出力でも回答本文を活かせるようになる。

### 注意点・トレードオフ

* プロンプト構造の変更は既存モデルのチューニングに影響する可能性があるため、A/B テストを実施して品質を確認する必要がある。
* コンテキスト要約処理は追加の LLM 呼び出しが必要であり、リソース消費が増える。そのため要約対象のチャンク数や要約長を慎重に調整する必要がある。
* クエリ前処理や同義語展開には自然言語処理ツールや辞書が必要であり、実装コストと運用負荷が増える。
* キャッシュの導入はメモリ使用量を増加させ、クエリパラメータの違いによるキャッシュミスや失効タイミングの設計が必要になる。
* 二段階呼び出しは LLM 呼び出し回数を増やすため、コストが上昇する。また引用句抽出の精度が低い場合、最終回答の品質が下がる可能性がある。
* バリデータの緩和により誤った引用や文脈のない回答が許容されるリスクがあるため、ログによる追跡と継続的な改善が必要。

このADRは、RAGオーケストレータの性能と応答品質を向上させるための具体的なアーキテクチャ変更を提示している。提案された改善策を段階的に実施し、効果測定とユーザフィードバックを基にさらなる調整を行うことが推奨される。

[[1]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/prompt_builder.go#:~:text=sb.WriteString%28fmt.Sprintf%28%22%3Ccontext%20version%3D%5C%22) [[2]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/prompt_builder.go#:~:text=defaultInstructions%20%3A%3D%20%5B%5Dstring) Alt/rag-orchestrator/internal/usecase/prompt\_builder.go at main · Kaikei-e/Alt · GitHub

<https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/prompt_builder.go>

[[3]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/retrieve_context_usecase.go#:~:text=func%20%28u%20,RetrieveContextOutput%2C%20error%29) [[4]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/retrieve_context_usecase.go#:~:text=%2F%2F%202) Alt/rag-orchestrator/internal/usecase/retrieve\_context\_usecase.go at main · Kaikei-e/Alt · GitHub

<https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/retrieve_context_usecase.go>

[[5]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/answer_with_rag_usecase.go#:~:text=context.Context%2C%20input%20AnswerWithRAGInput%29%20%28,answerWithRAGUsecase) Alt/rag-orchestrator/internal/usecase/answer\_with\_rag\_usecase.go at main · Kaikei-e/Alt · GitHub

<https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/answer_with_rag_usecase.go>

[[6]](https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/output_validator.go) Alt/rag-orchestrator/internal/usecase/output\_validator.go at main · Kaikei-e/Alt · GitHub

<https://github.com/Kaikei-e/Alt/blob/main/rag-orchestrator/internal/usecase/output_validator.go>