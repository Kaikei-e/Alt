# search-indexer Clean Architecture リファクタリング

## ADR's STATUS

Accepted (実装完了)

## CONTEXT

### 問題点

search-indexer は Go 1.24+ で構築された検索インデックスサービスだが、以下の技術的負債が蓄積していた:

| # | 問題 | 詳細 |
|---|------|------|
| 1 | デッドコード | `service/`, `indexer/`, `server/`, `internal/auth/` が main.go から未使用のまま残存 |
| 2 | God Object | main.go (345行) に DI配線・インデックスループ・ヘルスチェック・定数が集中 |
| 3 | アーキテクチャ違反 | `rest/handler.go` と `connect/v2/` が Meilisearch を直接呼び出し、usecase/port/gateway レイヤーをバイパス |
| 4 | 固定リトライ | 1分固定の `time.Sleep` でリトライ。指数バックオフ未実装 |
| 5 | Graceful Shutdown 不備 | タイムアウトなしの `srv.Shutdown(context.Background())` |
| 6 | メトリクスなし | OTel traces/logs はあるが、Metrics API 未導入 |
| 7 | テスト不足 | consumer/、Connect-RPC ハンドラ、DB driver のテストなし |

### 方針

4フェーズの段階的リファクタリング:

1. **Phase 1**: デッドコード削除 & search_engine パッケージ解消
2. **Phase 2**: main.go 分割 & DI 整理 (bootstrap/ パッケージ導入)
3. **Phase 3**: パフォーマンス改善 (指数バックオフ、バッチ集約、メトリクス)
4. **Phase 4**: テスト品質改善 (新規テスト、fuzz テスト、linter 設定)

## DECISION MAKING

### Phase 1: デッドコード削除 & search_engine パッケージ解消

#### 1.1 デッドコード削除

以下の未使用パッケージを削除:

- `service/index_service.go` - テナント分離型の旧実装
- `indexer/indexer.go` - Clean Architecture 以前の旧 indexer
- `server/server.go`, `server/indexer_server.go` - 旧サーバーラッパー
- `internal/auth/client.go`, `internal/auth/middleware/auth.go` - service/ からのみ参照

#### 1.2 search_engine パッケージ解消

`search_engine/meilisearch.go` が REST/Connect-RPC ハンドラから直接呼ばれ、CA レイヤーをバイパスしていた問題を解消:

- フィルタヘルパー (`escapeMeilisearchValue`, `makeSecureSearchFilter`, `BuildUserFilter`) → `driver/filter.go` にプライベート関数として移動
- `ValidateFilterTags` → `domain/filter_validation.go` に移動
- `SearchArticles()` 等の検索関数 → 廃止。`SearchByUserUsecase` を新設し、REST/Connect-RPC ハンドラはこの usecase 経由で検索

**修正後のデータフロー**:
```
REST/Connect-RPC Handler → SearchByUserUsecase → SearchEngine port → Gateway → MeilisearchDriver
```

### Phase 2: main.go 分割 & DI 整理

#### 2.1 bootstrap/ パッケージ導入

main.go (345行) を以下の構造に分割:

```
main.go            (45行) - エントリポイント: healthcheck サブコマンド + bootstrap.Run()
bootstrap/
├── app.go         - App struct: 全コンポーネントの初期化、index loop、shutdown
├── drivers.go     - DB/Meilisearch ドライバの初期化 (retry 付き)
└── servers.go     - HTTP/Connect-RPC サーバー構築
```

HTTP サーバーは `http.DefaultServeMux` への依存を排除し、専用の `http.NewServeMux()` を使用。

#### 2.2 エラー型の domain 層集約

`port/article_repository.go` と `port/search_engine.go` に散在していたエラー型を `domain/errors.go` に集約:

```go
// domain/errors.go
type RepositoryError struct { Op, Err string }
type SearchEngineError struct { Op, Err string }
type DriverError struct { Op, Err string }
```

#### 2.3 定数の config 層集約

main.go にハードコードされていた定数を `config/constants.go` に移動し、環境変数でオーバーライド可能に:

| 定数名 | デフォルト | 環境変数 |
|--------|-----------|----------|
| `IndexInterval` | 5m | `INDEX_INTERVAL` |
| `IndexBatchSize` | 200 | `INDEX_BATCH_SIZE` |
| `IndexRetryInterval` | 1m | `INDEX_RETRY_INTERVAL` |
| `HTTPAddr` | :9300 | `HTTP_ADDR` |
| `ConnectAddr` | :9301 | `CONNECT_ADDR` |
| `DBTimeout` | 10s | `DB_TIMEOUT` |
| `MeiliTimeout` | 15s | `MEILI_TIMEOUT` |

### Phase 3: パフォーマンス改善

#### 3.1 指数バックオフ

固定 1 分リトライを `cenkalti/backoff/v5` による指数バックオフに置換:

```
InitialInterval: 5s
MaxInterval:     5m
Multiplier:      2x
Jitter:          built-in (RandomizationFactor)
```

`time.Sleep` を `select` ベースの待機に変更し、context キャンセル時の即座の停止を実現。

#### 3.2 Redis イベントのバッチ集約

Redis Streams からのイベントを 1 件ずつ `ExecuteSingleArticle()` する代わりに、バッファリングしてバッチ送信:

- バッファサイズ閾値: 10 件
- フラッシュタイマー: 2 秒
- バッチ内 ID 重複排除あり
- 新 usecase メソッド: `ExecuteBatchArticles(ctx, articleIDs []string)`

#### 3.3 Graceful Shutdown

`context.Background()` (タイムアウトなし) を 30 秒タイムアウト付きに改善:

```go
shutdownCtx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
```

HTTP サーバー、Connect-RPC サーバー、Redis consumer、DB ドライバの順次クリーンアップ。

#### 3.4 OTel Metrics 導入

OTel Metrics API を使用し OTLP で送信 (Prometheus exporter 不要):

| メトリクス名 | 種別 | 説明 |
|-------------|------|------|
| `search_indexer_indexed_total` | Counter | インデックス済み記事数 |
| `search_indexer_deleted_total` | Counter | 削除済み記事数 |
| `search_indexer_errors_total` | Counter | エラー数 (label: operation) |
| `search_indexer_batch_duration_seconds` | Histogram | バッチ処理時間 |
| `search_indexer_search_duration_seconds` | Histogram | 検索レイテンシ |

計装箇所: bootstrap/app.go (index loop)、rest/handler.go (search endpoint)。メトリクスは nil-safe で OTel 無効時もクラッシュしない。

#### 3.5 トレースサンプリング

`AlwaysSample()` (100%) を `ParentBased(TraceIDRatioBased)` に変更:

| 環境変数 | デフォルト | 説明 |
|----------|-----------|------|
| `OTEL_TRACE_SAMPLE_RATIO` | 0.1 | サンプリング比率 (0.0-1.0) |

### Phase 4: テスト品質改善

#### 4.1 テスト追加

| 対象 | ファイル | テスト数 |
|------|---------|---------|
| consumer/event_handler.go | `consumer/event_handler_test.go` | 6 |
| connect/v2/search/handler.go | `connect/v2/search/handler_test.go` | 5 |
| usecase (fuzz) | `usecase/search_articles_fuzz_test.go` | 1 (fuzz) |

consumer テストではバッチフラッシュ、重複排除、無効ペイロード処理を検証。Connect-RPC テストでは正常検索、バリデーションエラー、検索エンジンエラー、nil タグ処理を検証。

#### 4.2 .golangci.yml 追加

```yaml
linters:
  enable:
    - errcheck, govet, staticcheck, ineffassign, unused, gosec
```

## RESULTS, EFFECTS

### 変更ファイル一覧

| 操作 | パッケージ/ファイル | 変更内容 |
|------|---------------------|----------|
| 削除 | `service/`, `indexer/`, `server/`, `internal/auth/` | デッドコード削除 |
| 削除 | `search_engine/` | CA バイパスヘルパー削除 |
| 新規 | `bootstrap/app.go` | App struct、Run()、runIndexLoop()、shutdown() |
| 新規 | `bootstrap/drivers.go` | initDatabaseDriver()、initMeilisearchClient() |
| 新規 | `bootstrap/servers.go` | newHTTPServer()、newConnectServer() |
| 新規 | `domain/errors.go` | RepositoryError、SearchEngineError、DriverError |
| 新規 | `domain/filter_validation.go` | ValidateFilterTags() |
| 新規 | `config/constants.go` | 環境変数オーバーライド可能な定数 |
| 新規 | `driver/filter.go` | Meilisearch フィルタヘルパー (パッケージプライベート) |
| 新規 | `usecase/search_by_user.go` | SearchByUserUsecase |
| 新規 | `utils/otel/metrics.go` | OTel メトリクスインストルメント |
| 修正 | `main.go` | 345行 → 45行 (bootstrap.Run() 呼び出しのみ) |
| 修正 | `rest/handler.go` | usecase 経由に変更 + メトリクス計装 |
| 修正 | `connect/v2/search/handler.go` | usecase 経由に変更 |
| 修正 | `connect/v2/server.go` | SearchByUserUsecase を受け取るように変更 |
| 修正 | `port/search_engine.go` | SearchByUserID, SearchByUserIDWithPagination 追加 |
| 修正 | `driver/meilisearch_driver.go` | SearchByUserID, SearchByUserIDWithPagination 追加 |
| 修正 | `gateway/search_engine_gateway.go` | 新メソッド対応 |
| 修正 | `consumer/event_handler.go` | バッチ集約 (バッファ + タイマー + 重複排除) |
| 修正 | `usecase/index_articles.go` | ExecuteBatchArticles() 追加 |
| 修正 | `utils/otel/provider.go` | MeterProvider 初期化、TraceIDRatioBased サンプラー |
| 修正 | `go.mod` | `cenkalti/backoff/v5` を direct dep に昇格、OTel metrics 追加 |

### テスト

| ファイル | テスト数 |
|---------|---------|
| `consumer/event_handler_test.go` | 6 (新規) |
| `connect/v2/search/handler_test.go` | 5 (新規) |
| `usecase/search_articles_fuzz_test.go` | 1 fuzz (新規) |
| 既存テスト (全パッケージ) | 全通過 |

### 動作確認

- `go build ./...`: 成功
- `go test ./... -count=1`: 全パッケージ通過
- `go test -fuzz=FuzzSearchArticlesValidation -fuzztime=5s ./usecase/`: 182,226 実行、パニックなし
- Docker コンテナ再ビルド・起動後:
  - `GET /health` → `{"status":"ok"}`
  - `GET /v1/search?q=test&user_id=tenant-1` → 正常レスポンス
  - バックフィルが 200 件バッチで正常進行をログで確認
  - ヘルスチェック healthy 状態

### PROS

1. **CA 準拠**: REST/Connect-RPC ハンドラが usecase 経由で検索。レイヤーバイパス解消
2. **保守性向上**: main.go 345行 → 45行。bootstrap/ パッケージで責務分離
3. **回復力**: 指数バックオフ (5s-5m) + ジッターにより、障害時のリトライストームを回避
4. **スループット向上**: Redis イベントのバッチ集約により、Meilisearch API 呼び出し回数を最大 1/10 に削減
5. **可観測性**: OTel Metrics 5 種で indexed/deleted/errors/batch_duration/search_duration を計測
6. **コスト最適化**: トレースサンプリング (デフォルト 10%) で OTel バックエンドへのデータ量を削減
7. **安全なシャットダウン**: 30 秒タイムアウト付き graceful shutdown
8. **テスト品質**: consumer/connect テスト追加、fuzz テストでセキュリティバリデーション検証

### CONS, TRADEOFF

1. **バッチ集約によるレイテンシ**: Redis イベントの即時インデックスから最大 2 秒のバッファリング遅延が発生
2. **サンプリングによるトレース欠損**: デフォルト 10% サンプリングにより、90% のトレースが記録されない (本番での問題調査時は環境変数で 1.0 に変更可能)
3. **OTel メトリクス依存の増加**: `otlpmetrichttp` パッケージの追加。OTel Collector が未稼働の環境ではメトリクスが送信されない (動作には影響なし)

## APPENDIX

### 環境変数 (新規追加分)

| 変数名 | デフォルト | 説明 |
|--------|-----------|------|
| `INDEX_INTERVAL` | 5m | インクリメンタルインデックスのポーリング間隔 |
| `INDEX_BATCH_SIZE` | 200 | 1 バッチあたりの記事数 |
| `INDEX_RETRY_INTERVAL` | 1m | (後方互換用、実際は指数バックオフに置換) |
| `HTTP_ADDR` | :9300 | REST HTTP サーバーアドレス |
| `CONNECT_ADDR` | :9301 | Connect-RPC サーバーアドレス |
| `DB_TIMEOUT` | 10s | DB 接続タイムアウト |
| `MEILI_TIMEOUT` | 15s | Meilisearch タイムアウト |
| `OTEL_TRACE_SAMPLE_RATIO` | 0.1 | トレースサンプリング比率 (0.0-1.0) |

### 指数バックオフ系列

```
正常時:    バッチ成功後にリセット
エラー初回: 5s (±ジッター)
連続エラー: 10s → 20s → 40s → ... → 300s (上限 5分)
成功復帰:  即座にリセット
```

### 関連 ADR

- ADR-000185: news-creator / pre-processor キュー飽和問題の解決（指数バックオフパターンの参考）
