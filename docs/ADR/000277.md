# ADR-000277: Lighthouse パフォーマンス改善 (visual-preview ページ)

## ステータス

承認済み

## コンテキスト

### 背景

`curionoah.com/sv/feeds/swipe/visual-preview` の Lighthouse スコアが以下の状態だった:

| カテゴリ | スコア |
|---------|-------|
| Performance | 75 |
| Accessibility | 95 |
| Best Practices | 77 |

主要なボトルネックとして以下を特定:

1. **LCP 4.5s** — LCP 画像に `loading="lazy"` が設定され、`fetchpriority=high` が未設定
2. **JS/CSS 未圧縮** — `/sv/` location で `gzip off` のため、immutable アセットも未圧縮で転送
3. **favicon.svg キャッシュなし** — 28 KiB が毎回再取得
4. **カラーコントラスト不足** — フッターボタンの `bg-[slate-200]` が有効な CSS 値ではなく、白文字のコントラスト比 1.83（WCAG AA 基準 4.5:1 未満）
5. **aria-label と visible text の不一致** — `<a aria-label="Open article in new tab">` 内に記事タイトル `<h2>` が存在し、accessible name が一致しない

### スコープ外

| 項目 | 理由 |
|------|------|
| Deprecated APIs (score 0) | Cloudflare challenge-platform スクリプト由来。制御不可 |
| ERR_BLOCKED_BY_CLIENT | 広告ブロッカーによる Cloudflare beacon 阻止。制御不可 |
| 502 エラー (FetchArticleContent) | バックエンド側の安定性問題。別途調査が必要 |

## 意思決定

### 1. LCP 画像の遅延読み込み除去（最大インパクト）

`VisualPreviewCard` に `isLcp` prop を追加。初回表示カード（`activeIndex === 0`）のみ `loading="eager"` + `fetchpriority="high"` を適用し、ブラウザが LCP 画像を即座に発見・優先取得できるようにした。

```
loading={isLcp ? "eager" : "lazy"}
fetchpriority={isLcp ? "high" : undefined}
```

非 LCP カードは `loading="lazy"` を維持し、不要なリソース取得を防止。

### 2. nginx: immutable アセットの gzip 有効化 + 長期キャッシュ

`/sv/` の `gzip off` は Connect-RPC 通信保護のために維持しつつ、`/sv/_app/immutable/` 専用の location ブロックを追加。nginx の prefix match 優先順位により、immutable アセットへのリクエストはこの新しいブロックにマッチする。

- `gzip on` — JS/CSS を圧縮転送
- `expires 1y` + `Cache-Control: public, immutable` — content hash 付きアセットを永続キャッシュ

Connect-RPC への影響はない。Connect-RPC リクエストは `/sv/api/v2/[...path]` パスを通り、`/sv/_app/immutable/` にはマッチしない。

### 3. favicon.svg のキャッシュ

`location = /sv/favicon.svg` を追加し、`expires 7d` + `Cache-Control: public` を設定。exact match (`=`) により他のルートに影響しない。

### 4. フッターボタンのカラーコントラスト修正

`bg-[slate-200]` は Tailwind v4 の `[]` 記法で CSS 値 `slate-200` と解釈されるが、有効な CSS 色ではない。ブラウザの fallback により実質透明になり、暗い glassmorphism 背景上で白文字が読めない状態だった。

`bg-[rgba(255,255,255,0.15)]` に置換。半透明白背景 + backdrop-blur の暗い下地により、白文字とのコントラストが WCAG AA 基準を満たす。

### 5. aria-label 削除

`<a aria-label="Open article in new tab">` 内に `<h2>{feed.title}</h2>` が存在するため、aria-label と visible text が不一致だった。`aria-label` を削除し、`<h2>` の記事タイトルをそのまま accessible name として使用。外部リンクであることはアイコンで視覚的に示されている。

### 不採用案

| 不採用案 | 理由 |
|---------|------|
| `/sv/` 全体で gzip on | Connect-RPC の binary encoding と干渉する可能性がある |
| LCP 画像に `<link rel="preload">` を追加 | SSR=false のため、画像 URL はクライアント側でのみ確定する。preload タグを静的に埋め込めない |
| `bg-slate-200` (括弧なし) に修正 | Tailwind v4 のユーティリティクラスとしては正しいが、glassmorphism デザインの半透明スタイルと合わない |

## 結果・影響

### 動作確認

| 確認項目 | 結果 |
|---------|------|
| `bun run build` | 正常完了 |
| alt-frontend-sv コンテナ再ビルド+再起動 | healthy |
| nginx reload | 正常 |
| `/sv/feeds/swipe/visual-preview` | HTTP 200 |
| `/sv/favicon.svg` レスポンスヘッダ | `Cache-Control: public`, `Expires: 7d` |
| `/sv/_app/immutable/*.js` レスポンスヘッダ | `Content-Encoding: gzip`, `Cache-Control: public, immutable`, `Expires: 1y` |

### 期待効果

| 指標 | 修正前 | 修正後（期待値） |
|-----|-------|----------------|
| LCP | 4.5s | < 2.5s |
| Accessibility スコア | 95 | 向上（color-contrast, label 修正） |
| Best Practices スコア | 77 | 向上（キャッシュ改善） |
| JS transfer size | 未圧縮 | gzip 圧縮（60-70% 削減） |

### PROS

- LCP 改善は `isLcp` prop の追加のみで、既存の非 LCP カードの動作に影響しない
- nginx の location 分離により、Connect-RPC の `gzip off` を維持したまま静的アセットのみ圧縮
- カラーコントラスト修正は glassmorphism デザインを維持しつつ WCAG AA 準拠

### CONS, TRADEOFF

- `isLcp` の判定は `activeIndex === 0` 固定。将来カードの表示ロジックが変わった場合、LCP 対象の判定も見直しが必要
- `bg-[rgba(255,255,255,0.15)]` のコントラスト比は背景画像に依存する。極端に明るい OGP 画像の場合、backdrop-blur があってもコントラストが不足する可能性がある

## 付録

### 変更ファイル一覧

| ファイル | 変更 |
|---------|------|
| `alt-frontend-sv/src/lib/components/mobile/feeds/swipe/VisualPreviewCard.svelte` | `isLcp` prop 追加、LCP 画像に `loading="eager"` + `fetchpriority="high"`、`bg-[slate-200]` → `bg-[rgba(255,255,255,0.15)]`、`aria-label` 削除 |
| `alt-frontend-sv/src/lib/components/mobile/feeds/swipe/SwipeFeedScreen.svelte` | `isLcp={activeIndex === 0}` を VisualPreviewCard に渡す |
| `nginx/conf.d/default.conf` | `/sv/_app/immutable/` location（gzip + 1y キャッシュ）、`/sv/favicon.svg` location（7d キャッシュ）追加 |
