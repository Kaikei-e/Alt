# alt-frontend-sv インクリメンタルリファクタリング

## ADR's STATUS

Accepted (Wave 1-4 実装完了 / Wave 3.2 延期)

## CONTEXT

### 問題点

alt-frontend-sv は SvelteKit 2.50 / Svelte 5.48 / TypeScript 5.9 / Tailwind CSS v4 で構築されたフロントエンド。Svelte 5 Runes は採用済みだが、成長に伴い以下の構造的課題が顕在化:

| # | 分類 | 問題 |
|---|------|------|
| 1 | SSR 安全性 | Auth/Loading store がモジュールレベルのシングルトン。SSR でリクエスト間の状態リーク可能性 |
| 2 | 責務集中 | `hooks.server.ts` (229 行) が認証・エラー分類・レスポンス構築・ログを一手に担い、テスト不能 |
| 3 | セキュリティ | デバッグログが全リクエストで環境変数を出力 |
| 4 | ハードコード | API クライアントのベースパス `/sv` がリテラル |
| 5 | コード重複 | Desktop/Mobile で Evening Pulse 等のロジックが 80% 重複 |
| 6 | 層分離なし | `lib/schema/` が型定義と変換ロジックを混在。依存方向が未定義 |
| 7 | デッドコード | Connect-RPC 移行完了後も REST フォールバック用 Feature Flag が残存 |
| 8 | 認証パフォーマンス | 全リクエストで Kratos API + auth-hub の 2 回シーケンシャル HTTP 呼び出し |

### 方針

5 段階の Wave に分けてインクリメンタルに実施。各 Wave 完了時に `bun run check` (型チェック 0 エラー) + `vitest run --project=server` (全テスト通過) + `bun run build` (本番ビルド成功) をゲーティング条件とする。

## DECISION MAKING

### Wave 1: 基盤整備

#### 1.1 Auth/Loading Store の SSR 安全化

シングルトン export を廃止し、Svelte の `setContext()` / `getContext()` パターンに移行:

```typescript
// lib/stores/auth.svelte.ts
export const AUTH_STORE_KEY = Symbol("auth-store");
export function createAuthStore(): AuthStore { /* factory */ }
export function getAuthStore(): AuthStore {
  return getContext<AuthStore>(AUTH_STORE_KEY);
}
```

Root `+layout.svelte` で `setContext()` により store をコンポーネントツリーに注入。各消費ファイル (6 箇所) を `getAuthStore()` / `getLoadingStore()` に切替。

#### 1.2 hooks.server.ts の分解

229 行の単一ファイルを 4 モジュールに分解。TDD でテストを先行:

| 新規モジュール | 責務 | 行数 |
|---------------|------|------|
| `lib/server/route-guard.ts` | ルート分類 (`isPublicRoute`, `isApiRoute`, `isStreamEndpoint`) | 31 行 |
| `lib/server/error-classifier.ts` | Ory SDK エラーのステータス分類 | 66 行 |
| `lib/server/auth-middleware.ts` | セッション検証 + トークン取得 | 93 行 |
| `lib/server/response-builder.ts` | API/ページのレスポンス構築 | 38 行 |

`hooks.server.ts` は 68 行の組み立てコードに簡素化。環境変数出力のデバッグログを削除。

`lib/ory.ts` を `lib/server/ory.ts` に移動 (元ファイルは re-export)。

テスト新規追加: route-guard 24 件、error-classifier 8 件、response-builder 7 件 (計 39 件)。

#### 1.3 ハードコードされたベースパスの修正

`lib/api/client/core.ts` の `const base = "/sv"` を `import { base } from "$app/paths"` に変更。

### Wave 2: コード共通化

#### 2.1 Headless Composable の抽出

Desktop/Mobile Evening Pulse ページの共通ロジックを `lib/hooks/usePulse.svelte.ts` (86 行) に抽出:

```typescript
export function usePulse() {
  let data = $state<EveningPulse | null>(null);
  let isLoading = $state(true);
  let error = $state<Error | null>(null);
  // fetchData, retry, selectTopic, clearSelectedTopic
  return { get data() { return data; }, /* ... */ };
}
```

Desktop/Mobile 各ページは 30-40 行の薄いシェルに簡素化。

#### 2.2 TanStack Query ラッパーの拡充

既存の `lib/queries/feeds.ts` に倣い、Connect-RPC 呼び出しを TanStack Query でラップ:

| 新規モジュール | 内容 |
|---------------|------|
| `lib/queries/recap.ts` | 3 日・7 日 Recap 取得 |
| `lib/queries/pulse.ts` | Evening Pulse 取得 |
| `lib/queries/tag-trail.ts` | タグ別記事・記事タグ・ランダムフィード |
| `lib/queries/keys.ts` | 全 Query Key を一元管理 (`recapKeys`, `pulseKeys`, `tagTrailKeys` 追加) |

#### 2.3 デッドコードの削除

Connect-RPC 移行完了済みのため、消費者ゼロの Feature Flag を削除:

- `lib/features/flags.ts` (159 行) — 削除
- `lib/features/index.ts` — 削除

### Wave 3: レイヤー再構成

#### 3.1 domain/ レイヤーの抽出

フレームワーク依存なしの純粋な型定義・ビジネスロジック層を `lib/domain/` に作成 (8 ファイル、474 行):

| ドメイン | ファイル | 内容 |
|---------|---------|------|
| feed | `types.ts`, `sanitize.ts` | Feed 型定義、サニタイズ・変換関数 |
| stats | `types.ts` | FeedStatsSummary, TrendDataPoint |
| recap | `types.ts` | RecapGenre, RecapSummary |
| pulse | `types.ts` | EveningPulse, PulseTopic |
| tag-trail | `types.ts` | TagTrailTag, TagTrailArticle |
| dashboard | `types.ts`, `format.ts` | ジョブ進捗型、フォーマット関数 |

元の `lib/schema/*.ts` は `domain/` からの re-export に変更し後方互換性を維持。

Biome `noRestrictedImports` ルールで `domain/` からの上位層 import を error レベルで禁止:

```json
{
  "includes": ["src/lib/domain/**"],
  "linter": {
    "rules": {
      "style": {
        "noRestrictedImports": {
          "level": "error",
          "options": {
            "patterns": [{
              "group": ["$lib/hooks/*", "$lib/stores/*", "$lib/api/*",
                        "$lib/connect/*", "$lib/queries/*",
                        "$lib/components/*", "$lib/server/*"]
            }]
          }
        }
      }
    }
  }
}
```

#### 3.2 data/ レイヤーの抽出 — 延期

`lib/api.ts` (549 行、25+ ファイルから参照) の分解は影響範囲が大きく、Wave 3.1 の domain/ 定着後に実施予定。

### Wave 4: パフォーマンス最適化

#### 4.1 認証フローの最適化

2 つの改善を `auth-middleware.ts` に実装:

1. **セッションキャッシュ**: Cookie ベースの 30 秒 TTL Map キャッシュ。キャッシュヒット時は Kratos API + auth-hub 呼び出しをスキップ
2. **並列化**: `Promise.all()` で Kratos セッション検証と auth-hub トークン取得を並列実行
3. **公開ルート高速パス**: Cookie なしの公開ルートリクエストは認証処理を完全スキップ

#### 4.2 重いコンポーネントの遅延読み込み

Stats ページの `TrendChart` (chart.js 依存) を動的 import に変更:

```svelte
const TrendChartPromise = import("$lib/components/desktop/stats/TrendChart.svelte");

{#await TrendChartPromise then TrendChart}
  <TrendChart.default title="Articles" ... />
{/await}
```

chart.js (約 200KB) が初期バンドルから除外され、Stats ページ訪問時のみロード。

#### 4.3 バンドルサイズの監視

`rollup-plugin-visualizer` を導入。ビルド時に `stats.html` (gzip/brotli サイズ付き) を自動生成:

```bash
bun run build:analyze  # ビルド + レポート生成
```

## RESULTS, EFFECTS

### 変更ファイル一覧

| 操作 | ファイル | Wave | 変更内容 |
|------|---------|------|---------|
| 修正 | `src/lib/stores/auth.svelte.ts` | 1.1 | factory + getContext ヘルパー追加、シングルトン削除 |
| 修正 | `src/lib/stores/loading.svelte.ts` | 1.1 | 同上 |
| 修正 | `src/routes/+layout.svelte` | 1.1 | setContext() で store 注入 |
| 修正 | `src/routes/+page.svelte` | 1.1 | getAuthStore() に切替 |
| 修正 | `src/routes/desktop/+layout.svelte` | 1.1 | getLoadingStore() に切替 |
| 修正 | `src/routes/desktop/recap/+page.svelte` | 1.1 | getLoadingStore() に切替 |
| 修正 | `src/routes/desktop/recap/job-status/+page.svelte` | 1.1 | getLoadingStore() に切替 |
| 修正 | `src/routes/mobile/recap/job-status/+page.svelte` | 1.1 | getLoadingStore() に切替 |
| 修正 | `src/hooks.server.ts` | 1.2,4.1 | 229 行 → 68 行に簡素化 |
| 新規 | `src/lib/server/route-guard.ts` | 1.2 | ルート分類 |
| 新規 | `src/lib/server/route-guard.test.ts` | 1.2 | 24 テスト |
| 新規 | `src/lib/server/error-classifier.ts` | 1.2 | エラーステータス抽出 |
| 新規 | `src/lib/server/error-classifier.test.ts` | 1.2 | 8 テスト |
| 新規 | `src/lib/server/auth-middleware.ts` | 1.2,4.1 | セッション検証 + キャッシュ + 並列化 |
| 新規 | `src/lib/server/response-builder.ts` | 1.2 | レスポンス構築 |
| 新規 | `src/lib/server/response-builder.test.ts` | 1.2 | 7 テスト |
| 新規 | `src/lib/server/ory.ts` | 1.2 | Ory クライアント (lib/ory.ts から移動) |
| 修正 | `src/lib/ory.ts` | 1.2 | re-export ファサード化 |
| 修正 | `src/lib/api/client/core.ts` | 1.3 | ベースパス `$app/paths` 化 |
| 新規 | `src/lib/hooks/usePulse.svelte.ts` | 2.1 | 共通 Pulse composable |
| 修正 | `src/routes/desktop/recap/evening-pulse/+page.svelte` | 2.1 | usePulse() に切替 |
| 修正 | `src/routes/mobile/recap/evening-pulse/+page.svelte` | 2.1 | usePulse() に切替 |
| 新規 | `src/lib/queries/recap.ts` | 2.2 | TanStack Query ラッパー |
| 新規 | `src/lib/queries/pulse.ts` | 2.2 | TanStack Query ラッパー |
| 新規 | `src/lib/queries/tag-trail.ts` | 2.2 | TanStack Query ラッパー |
| 修正 | `src/lib/queries/keys.ts` | 2.2 | Query Key 追加 |
| 削除 | `src/lib/features/flags.ts` | 2.3 | デッドコード削除 |
| 削除 | `src/lib/features/index.ts` | 2.3 | デッドコード削除 |
| 新規 | `src/lib/domain/feed/types.ts` | 3.1 | Feed 型定義 |
| 新規 | `src/lib/domain/feed/sanitize.ts` | 3.1 | サニタイズ関数 |
| 新規 | `src/lib/domain/stats/types.ts` | 3.1 | Stats 型定義 |
| 新規 | `src/lib/domain/recap/types.ts` | 3.1 | Recap 型定義 |
| 新規 | `src/lib/domain/pulse/types.ts` | 3.1 | Pulse 型定義 |
| 新規 | `src/lib/domain/tag-trail/types.ts` | 3.1 | TagTrail 型定義 |
| 新規 | `src/lib/domain/dashboard/types.ts` | 3.1 | Dashboard 型定義 |
| 新規 | `src/lib/domain/dashboard/format.ts` | 3.1 | フォーマット関数 |
| 修正 | `src/lib/schema/*.ts` (6 ファイル) | 3.1 | domain/ からの re-export 化 |
| 修正 | `src/routes/desktop/stats/+page.svelte` | 4.2 | TrendChart 動的 import |
| 修正 | `vite.config.ts` | 4.3 | rollup-plugin-visualizer 追加 |
| 修正 | `biome.json` | 5 | domain/ 層の import 制約ルール追加 |

### テスト結果

| チェック | 結果 |
|---------|------|
| `svelte-check` | PASS (0 errors, 0 warnings) |
| `vitest run --project=server` | PASS (22 ファイル, 297 テスト, 0 失敗) |
| `bun run build` | PASS |
| `biome lint` (domain/ のみ) | PASS (import 制約違反 0 件) |

### 動作確認

- Docker ビルド: `docker compose build alt-frontend-sv` → 成功
- コンテナ起動: `docker compose up -d alt-frontend-sv` → 成功
- ヘルスチェック: コンテナステータス `healthy`
- ページ応答: `/sv/login` → 200

### PROS

1. **SSR 安全性**: Auth/Loading store が `setContext` ベースに。リクエスト間の状態リークを構造的に防止
2. **テスト可能性**: hooks.server.ts の 5 つの責務が独立モジュールに。39 件のユニットテスト追加
3. **セキュリティ改善**: 全リクエストでの環境変数ログ出力を削除
4. **コード重複削減**: Evening Pulse の Desktop/Mobile 共通ロジックを headless composable に集約
5. **層分離の強制**: Biome ルールで `domain/` の依存方向違反をビルド時にエラー検出
6. **認証パフォーマンス**: セッションキャッシュ (30 秒 TTL) + 並列化で hooks.server.ts の認証処理を高速化
7. **初期バンドル軽量化**: chart.js が Stats ページ訪問時のみロード
8. **デッドコード除去**: 未使用の Feature Flag 159 行を削除

### CONS, TRADEOFF

1. **`lib/api.ts` 未分解**: 549 行の巨大モジュール (25+ 参照) は影響範囲の大きさから延期。段階的に `data/` レイヤーに移行予定
2. **re-export ファサードの残存**: `lib/schema/*.ts` と `lib/ory.ts` が re-export として残る。全消費者の移行完了後に削除可能
3. **セッションキャッシュの制限**: インメモリ Map のため、マルチプロセス構成ではプロセス間でキャッシュが共有されない。現状のシングルプロセス構成では問題なし
4. **テストカバレッジの偏り**: server プロジェクトのテストは充実したが、browser プロジェクト (Svelte コンポーネント) のテストは今回のスコープ外

## APPENDIX

### 依存追加

```json
{
  "devDependencies": {
    "rollup-plugin-visualizer": "^6.0.5"
  }
}
```

### 残りタスク

| タスク | 前提条件 |
|-------|---------|
| `lib/api.ts` の `data/` レイヤー分解 (Wave 3.2) | domain/ 定着後 |
| MSW ベースの data/ テスト | Wave 3.2 |
| Biome import 制約の hooks/ 層への拡大 | data/ レイヤー確立後 |

### 関連 ADR

- ADR-000191: pre-processor 段階的リファクタリング (Go サービスにおける同様の構造改善)
- ADR-000193: rask-log-aggregator Clean Architecture リファクタリング (Rust サービスにおける段階的改善)
