# pre-processorエラーハンドリング包括的見直し：alt-backendパターン踏襲

## ステータス

採択（Accepted）

## コンテキスト

pre-processorサービスのエラーハンドリングに以下の問題があった：

### 問題点

1. **並列するエラー分類システム**
   - `service/error_classifier.go` と `utils/errors/operation_error.go` に同様のロジックが分散
   - `IsRetryable()` 関数が2箇所に存在し、どちらを使うべきか不明確

2. **echo.HTTPErrorの乱用**
   - ハンドラー層で直接 `echo.NewHTTPError()` を使用
   - エラーコンテキスト（レイヤー、コンポーネント、操作名）が欠落
   - ログとレスポンスの相関が困難

3. **sentinel errorの分散**
   - `driver/summarizer_api.go` に `ErrContentTooShort` が定義
   - ドメインエラーが driver 層に存在する設計上の問題

4. **中央集権的エラーハンドリングの欠如**
   - 各ハンドラーが個別にエラー処理
   - エラーレスポンス形式が不統一

### 問題のあったコードパターン

**ハンドラー層**:
```go
// Before: コンテキスト情報なし
return echo.NewHTTPError(http.StatusBadRequest, "Article ID cannot be empty")
```

**エラー分類の重複**:
```go
// service/error_classifier.go
func IsRetryableError(err error) bool { ... }

// utils/errors/operation_error.go
func IsRetryable(err error) bool { ... }
```

## 決定

### 1. alt-backendパターンを踏襲

ADR 54で確立した `AppContextError` パターンをpre-processorに適用：

```go
type AppContextError struct {
    Code      string                 // エラーコード（VALIDATION_ERROR等）
    Message   string                 // 内部エラーメッセージ
    Layer     string                 // アーキテクチャ層
    Component string                 // コンポーネント名
    Operation string                 // 操作名
    Cause     error                  // 原因エラー
    Context   map[string]interface{} // 追加コンテキスト
    ErrorID   string                 // ログ相関用ID
}
```

### 2. sentinel errorsの集約

`domain/errors.go` に全てのドメインエラーを集約：

```go
package domain

import "errors"

var (
    // Article errors
    ErrArticleNotFound     = errors.New("article not found")
    ErrArticleContentEmpty = errors.New("article content is empty")
    ErrContentTooShort     = errors.New("content too short for summarization")

    // Job errors
    ErrJobNotFound = errors.New("job not found")

    // Validation errors
    ErrInvalidRequest   = errors.New("invalid request format")
    ErrMissingArticleID = errors.New("article ID is required")
    ErrEmptyContent     = errors.New("content cannot be empty")

    // External API errors
    ErrNewsCreatorUnavailable = errors.New("news-creator service unavailable")
)
```

### 3. エラー分類の統合

`utils/errors/classifier.go` に統一：

```go
// IsRetryable determines if an error should be retried
func IsRetryable(err error) bool {
    // 1. context.Canceled/DeadlineExceeded
    // 2. AppContextError.IsRetryable()
    // 3. OperationError.IsRetryable
    // 4. net.OpError, net.Error
    // 5. syscall.Errno
}

// IsRetryableHTTPStatus checks if HTTP status code is retryable
func IsRetryableHTTPStatus(status int) bool {
    // 5xx, 408, 429 are retryable
}
```

### 4. 中央集権的エラーミドルウェア

`middleware/error_middleware.go`:

```go
func CustomHTTPErrorHandler(logger *slog.Logger) echo.HTTPErrorHandler {
    return func(err error, c echo.Context) {
        var appErr *apperrors.AppContextError
        if errors.As(err, &appErr) {
            // AppContextError: 安全なレスポンスを返す
            logger.Error("API error", "error_id", appErr.ErrorID, ...)
            _ = c.JSON(appErr.HTTPStatusCode(), appErr.ToSecureHTTPResponse())
            return
        }
        // echo.HTTPError, unknown error も適切に処理
    }
}
```

### 5. ハンドラーリファクタリング

```go
// Before
return echo.NewHTTPError(http.StatusBadRequest, "Article ID cannot be empty")

// After
return apperrors.NewValidationContextError(
    domain.ErrMissingArticleID.Error(),
    "handler", "SummarizeHandler", "HandleSummarize",
    nil,
)
```

## 結果

### クライアントレスポンスの変化

**Before**:
```json
{"message": "Article ID cannot be empty"}
```

**After**:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "article ID is required",
    "error_id": "a1b2c3d4",
    "retryable": false
  }
}
```

### メリット

1. **一貫性**: alt-backendと同一のエラーパターン
2. **トレーサビリティ**: error_idでログとレスポンスを紐付け
3. **保守性**: エラー処理ロジックの一元化
4. **セキュリティ**: 5xxエラーの内部詳細を隠蔽
5. **クリーンアーキテクチャ**: ドメインエラーが domain 層に集約

### トレードオフ

1. **後方互換性**: driver.ErrContentTooShortをaliasとして維持（非推奨マーク）
2. **移行コスト**: 19箇所のecho.NewHTTPErrorを変更

## 実装

### 実装日: 2026-01-06

### 修正ファイル一覧

| カテゴリ | ファイル | 変更内容 |
|---------|---------|---------|
| ドメイン | `domain/errors.go` | 新規作成：sentinel errors定義 |
| ドメイン | `domain/errors_test.go` | 新規作成：テスト |
| エラー基盤 | `utils/errors/app_context_error.go` | 新規作成：AppContextError型 |
| エラー基盤 | `utils/errors/app_context_error_test.go` | 新規作成：テスト |
| エラー基盤 | `utils/errors/classifier.go` | 新規作成：統合エラー分類器 |
| エラー基盤 | `utils/errors/classifier_test.go` | 新規作成：テスト |
| ミドルウェア | `middleware/error_middleware.go` | 新規作成：Echoエラーハンドラ |
| ミドルウェア | `middleware/error_middleware_test.go` | 新規作成：テスト |
| ハンドラー | `handler/summarize_handler.go` | 19箇所のecho.HTTPError → AppContextError |
| ドライバー | `driver/summarizer_api.go` | ErrContentTooShort → domain参照（alias維持） |
| リポジトリ | `repository/external_api_repository.go` | domain.ErrContentTooShort参照 |
| サービス | `service/article_summarizer.go` | domain.ErrContentTooShort参照 |
| サービス | `service/article_fetcher.go` | IsRetryableError → apperrors.IsRetryable |
| サービス | `utils/errors/operation_error.go` | 古いIsRetryable削除、ClassifyError非推奨化 |
| エントリ | `main.go` | CustomHTTPErrorHandler統合 |
| 削除 | `service/error_classifier.go` | utils/errorsに統合 |
| 削除 | `service/error_classifier_test.go` | 削除 |

### ヘルパー関数

```go
// Validation errors (400)
NewValidationContextError(message, layer, component, operation string, context map[string]interface{})

// Not found errors (404)
NewNotFoundContextError(message, layer, component, operation string, context map[string]interface{})

// Internal errors (500)
NewInternalContextError(message, layer, component, operation string, cause error, context map[string]interface{})

// Database errors (500)
NewDatabaseContextError(message, layer, component, operation string, cause error, context map[string]interface{})

// External API errors (502)
NewExternalAPIContextError(message, layer, component, operation string, cause error, context map[string]interface{})

// Timeout errors (504)
NewTimeoutContextError(message, layer, component, operation string, cause error, context map[string]interface{})

// Rate limit errors (429)
NewRateLimitContextError(message, layer, component, operation string, context map[string]interface{})
```

## 関連ADR

- [ADR 54: alt-backendエラーハンドリング包括的見直し](./000054.md)

## 参考

- [Go Error Handling Best Practices 2025](https://www.djamware.com/post/6926eda9eca0e67f5e7d5d34/)
- [Error Handling in Go HTTP Applications](https://www.joeshaw.org/error-handling-in-go-http-applications/)
- [REST API Error Handling in Go](https://medium.com/@ozdemir.zynl/rest-api-error-handling-in-go/)
