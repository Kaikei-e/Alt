# チャッティマイクロサービス改善: バッチAPI・キャッシュ・並列化

## ステータス

採択（Accepted）

## コンテキスト

recap-workerとnews-creator間の通信が「チャッティマイクロサービス」アンチパターンに該当していた。

### 問題の構造

```
recap-worker ──(HTTP)──→ news-creator ──(LLM)──→ Ollama
     │                        │
     │                        └── Map-Reduceで順次LLM呼び出し
     │                              (チャンクごとにループ)
     │
     └── 各ジャンルごとに個別HTTPリクエスト
```

### 具体的な問題点

| 問題 | 影響 |
|------|------|
| ジャンル単位の単発リクエスト | N個のHTTP往復オーバーヘッド |
| Map-Reduceの順次実行 | LLM呼び出しがシリアル化 |
| キャッシュ不在 | 同一入力の再計算 |
| ネットワークレイテンシ累積 | HTTP RTT × クラスタ数 × ジャンル数 |

### 参考: チャッティマイクロサービスとは

マイクロサービス間で多数の細粒度なリクエストが発生し、ネットワークオーバーヘッドが累積するアンチパターン。ベストプラクティスでは、バッチ処理やアグリゲーションによるリクエスト集約が推奨される。

## 決定

3つの改善策を段階的に実装する。

### 1. バッチ処理API

複数ジャンルの要約リクエストを1回のHTTP呼び出しで処理する。

```
変更前:
recap-worker ─→ POST /v1/summary/generate (tech)
recap-worker ─→ POST /v1/summary/generate (politics)
recap-worker ─→ POST /v1/summary/generate (economy)
...

変更後:
recap-worker ─→ POST /v1/summary/generate/batch
               {requests: [{genre: "tech"}, {genre: "politics"}, ...]}
```

**新規エンドポイント**: `POST /v1/summary/generate/batch`

```python
# リクエスト
class BatchRecapSummaryRequest(BaseModel):
    requests: List[RecapSummaryRequest]

# レスポンス
class BatchRecapSummaryResponse(BaseModel):
    responses: List[RecapSummaryResponse]
    errors: List[BatchRecapSummaryError]
```

### 2. Redisキャッシュ

同一入力に対する再計算を回避する。

| 項目 | 設計 |
|------|------|
| キー生成 | `recap:summary:{SHA256(job_id + genre + clusters)}` |
| TTL | 24時間（設定可能） |
| 無効化 | コンテンツベース（clustersが異なれば別キャッシュ） |
| メモリポリシー | allkeys-lru（256MB上限） |

**抽象化**: Port/Gatewayパターンでキャッシュ実装を分離

```python
class CachePort(ABC):
    async def get(self, key: str) -> Optional[str]: ...
    async def set(self, key: str, value: str, ttl_seconds: int) -> bool: ...
```

### 3. Mapフェーズ並列化

Map-Reduceの Map フェーズを`asyncio.gather`で並列実行する。

```python
# 変更前
for chunk_idx, chunk in enumerate(chunks):
    result = await llm_provider.generate(...)

# 変更後
tasks = [
    self._generate_chunk_summary(chunk_idx, chunk, ...)
    for chunk_idx, chunk in enumerate(chunks)
]
results = await asyncio.gather(*tasks, return_exceptions=True)
```

同時実行数はLLMプロバイダー層のセマフォで制御されているため、リソース枯渇の懸念はない。

### 検討した代替案

| 選択肢 | 概要 | 採否 |
|--------|------|------|
| A案: バッチAPI + キャッシュ + 並列化 | 3施策の組み合わせ | **採用** |
| B案: gRPCストリーミング | 双方向ストリームで逐次処理 | 不採用 |
| C案: メッセージキュー | RabbitMQ/Kafkaで非同期化 | 不採用 |

### A案採用の理由

1. **段階的導入**: 各施策が独立しており、段階的にロールアウト可能
2. **既存互換性**: 単発APIを維持したまま、バッチAPIを追加
3. **低複雑度**: 新たなインフラ依存（メッセージキュー等）不要

### B案・C案不採用の理由

- recap-workerとnews-creatorの双方に大規模な変更が必要
- 現状のスループット要件に対して過剰な複雑性

## 結果

### news-creator 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `domain/models.py` | BatchRecapSummaryRequest/Response モデル追加 |
| `usecase/recap_summary_usecase.py` | generate_batch_summary()、キャッシュ統合、並列Map |
| `handler/recap_summary_handler.py` | `/v1/summary/generate/batch` エンドポイント |
| `port/cache_port.py` | CachePort ABC（新規） |
| `gateway/redis_cache_gateway.py` | RedisCacheGateway、NullCacheGateway（新規） |
| `config/config.py` | cache_enabled、cache_redis_url、cache_ttl_seconds |

### recap-worker 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `clients/news_creator/models.rs` | BatchSummaryRequest/Response 構造体 |
| `clients/news_creator/client.rs` | generate_batch_summary() メソッド |

### インフラ変更

| ファイル | 変更内容 |
|---------|---------|
| `compose/ai.yaml` | redis-cache サービス追加 |
| `compose/ai.yaml` | news-creator に CACHE_* 環境変数追加 |

### 期待効果

| メトリクス | 変更前 | 変更後 |
|-----------|--------|--------|
| N ジャンル処理の HTTP 数 | N | 1 |
| ネットワークレイテンシ | N × RTT | 1 × RTT |
| 同一入力の処理 | 毎回計算 | キャッシュヒット時スキップ |
| Map フェーズ | 順次実行 | 並列実行 |

### メリット

1. **レイテンシ削減**: HTTP往復オーバーヘッドを最小化
2. **リソース効率**: キャッシュにより重複計算を回避
3. **スループット向上**: 並列Mapで処理時間短縮
4. **後方互換性**: 既存の単発APIはそのまま動作

### トレードオフ

1. **Redis依存**: キャッシュ機能にはRedisが必要（無効化可能）
2. **バッチタイムアウト**: 大量リクエスト時はタイムアウト調整が必要
3. **部分失敗処理**: バッチ内の一部失敗をクライアントが適切に処理する必要

## テスト

### 単体テスト結果

```bash
# news-creator (Python)
SERVICE_SECRET=test-secret uv run pytest tests/ -v
# 14 passed

# recap-worker (Rust)
cargo test --lib clients::news_creator
# 10 passed
```

### 統合テスト

```bash
# バッチAPI動作確認
curl -X POST http://localhost:11434/v1/summary/generate/batch \
  -H "Content-Type: application/json" \
  -d '{"requests": [...]}'

# キャッシュ確認
docker exec redis-cache redis-cli KEYS "recap:summary:*"
```

## 実装日

2026-01-13

## 関連

- [Microservices Anti-Patterns - GeeksforGeeks](https://www.geeksforgeeks.org/blogs/microservice-anti-patterns/)
- [10 Common Microservices Anti-Patterns - Design Gurus](https://www.designgurus.io/blog/10-common-microservices-anti-patterns)
- [API Gateway Aggregation Pattern - Microsoft Learn](https://learn.microsoft.com/en-us/azure/architecture/patterns/gateway-aggregation)
- [FastAPI Concurrency and async/await](https://fastapi.tiangolo.com/async/)
