# Tag Trail フィード表示時の記事オンデマンド取得

## ADR's STATUS

Accepted

## CONTEXT

Tag Trail機能において、ランダムフィード取得時に約59%のフィードで記事が存在せず、タグが表示されない問題が発生していた。

### データ状態分析

```
総フィード数: 51,271
├─ 記事があるフィード: 21,185 (41.3%)
└─ 記事がないフィード: 30,086 (58.68%)
```

### 根本原因

`FetchRandomFeed`でランダムフィード取得後、そのフィードに紐づく記事がない場合、タグ生成がスキップされていた。

```go
// Before: 記事がない場合は何もしない
} else {
    h.logger.InfoContext(ctx, "no articles found for feed", "feedID", feed.ID)
    // ← ここで終了、タグは空のまま
}
```

### 設計意図の不整合

フィード表示時に記事がなければ、その場でコンテンツを取得してタグを生成すべきであった。既存の`ArticleUsecase.FetchCompliantArticle`がこの用途に適合していた。

## DECISION MAKING

### 方針: オンデマンド記事取得

記事がない場合、`feed.Link`（記事URL）からコンテンツを取得し、DBに保存してからタグ生成する。

### 既存リソースの再利用

| リソース | 用途 |
|---------|------|
| `ArticleUsecase.FetchCompliantArticle` | URL→コンテンツ取得→DB保存 |
| `FetchArticleTagsGateway.FetchArticleTags` | タグ取得/オンザフライ生成 |
| `rest.IsAllowedURL` | SSRF保護 |

### 実装フロー

```
FetchRandomFeed
    │
    ├─→ FetchLatestArticleByFeedID
    │       │
    │       ├─→ article found → タグ取得
    │       │
    │       └─→ NO article found
    │               │
    │               ├─→ URL検証（SSRF保護）
    │               ├─→ ArticleUsecase.FetchCompliantArticle(feed.Link)
    │               │       ├─→ コンテンツ取得
    │               │       ├─→ SaveArticle（feed_id自動設定）
    │               │       └─→ articleID返却
    │               │
    │               └─→ FetchArticleTagsGateway.FetchArticleTags
    │
    └─→ Response with tags
```

### フェイルオープン設計

各ステップで問題が発生しても、フィード情報は正常に返却し、タグは空配列とする。

| 失敗シナリオ | 対応 |
|------------|------|
| URL解析失敗 | 警告ログ、タグ空 |
| SSRF検証失敗 | 警告ログ、タグ空 |
| コンテンツ取得失敗 | 警告ログ、タグ空 |
| タグ生成失敗 | 警告ログ、タグ空 |

## RESULTS, EFFECTS

### Backend変更

**Handler (`handler.go:387-420`)**

記事がない場合の処理を追加:

```go
} else {
    h.logger.InfoContext(ctx, "no articles found for feed, fetching content", ...)

    // 1. URL解析
    parsedURL, err := url.Parse(feed.Link)
    if err != nil { /* 警告ログ */ }

    // 2. SSRF保護
    else if err := rest.IsAllowedURL(parsedURL); err != nil { /* 警告ログ */ }

    // 3. コンテンツ取得・保存
    else if h.container.ArticleUsecase != nil {
        content, newArticleID, fetchErr := h.container.ArticleUsecase.FetchCompliantArticle(ctx, parsedURL, *user)
        if fetchErr != nil { /* 警告ログ */ }
        else if newArticleID != "" {
            // 4. タグ生成
            if h.container.FetchArticleTagsGateway != nil {
                tags, tagErr := h.container.FetchArticleTagsGateway.FetchArticleTags(ctx, newArticleID)
                if tagErr == nil {
                    protoTags = convertTagsToProto(tags)
                }
            }
        }
    }
}
```

**テスト (`handler_test.go`)**
- `TestFetchRandomFeed_NoArticles_FetchesContentAndGeneratesTags_Documented`
- `TestFetchRandomFeed_NoArticles_FlowCorrectness`

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `handler.go` | 記事オンデマンド取得ロジック追加 |
| `handler_test.go` | 新規テスト追加 |

### PROS

1. **カバレッジ向上**: 59%のフィードでもタグ表示可能に
2. **既存資産活用**: 新規コンポーネント不要
3. **セキュリティ維持**: SSRF保護を適用
4. **データ充実**: 記事コンテンツがDBに蓄積

### CONS, TRADEOFF

1. **初回レイテンシ**: 記事取得+タグ生成で数秒の遅延
2. **外部依存**: 対象サイトの応答に依存
3. **robots.txt制約**: 一部サイトでコンテンツ取得不可

## APPENDIX

### 処理シーケンス（記事なしの場合）

```
Frontend                    Backend                     External/DB
    │                           │                           │
    ├─→ FetchRandomFeed ───────→│                           │
    │                           ├─→ FetchRandomSubscription─→│
    │                           │←───────── feed ───────────┤
    │                           │                           │
    │                           ├─→ FetchLatestArticle ────→│
    │                           │←───────── nil ────────────┤
    │                           │                           │
    │                           ├─→ FetchCompliantArticle ─→│ (External)
    │                           │   (robots.txt check)      │
    │                           │   (content fetch)         │
    │                           │←───────── content ────────┤
    │                           │                           │
    │                           ├─→ SaveArticle ───────────→│ (DB)
    │                           │←───────── articleID ──────┤
    │                           │                           │
    │                           ├─→ FetchArticleTags ──────→│ (mq-hub)
    │                           │←───────── tags ───────────┤
    │                           │                           │
    │←── feed + tags ──────────┤                           │
```

### 関連ADR

- ADR-168: オンザフライタグ生成（Gateway実装）
- ADR-173: StreamArticleTagsオンザフライ生成
- ADR-174: FetchRandomFeedレスポンスへのタグ統合

### 検証コマンド

```bash
# テスト実行
cd alt-backend/app && go test ./connect/v2/articles/... -v

# コンテナ再ビルド
docker compose -f compose/compose.yaml -p alt up -d --build alt-backend

# ログ確認
docker compose -f compose/compose.yaml -p alt logs alt-backend --since 5m | \
  grep -iE "no articles found|fetching content|fetched and saved|generated tags"
```
