# recap-worker Rust 2024 モダナイゼーション

## ADR's STATUS

Accepted (Phase 1-B, 1-C, 6-A 実装完了 / Phase 1-A 延期決定)

## CONTEXT

### 問題点

recap-worker は Rust 製のバッチ処理サービス (約 15,000 行 / 149 ファイル) で、日本語ニュース Recap 生成パイプラインを統括する。Rust 2024 edition を採用済みだが、以下の技術的負債が存在:

| # | 分類 | 問題 |
|---|------|------|
| 1 | 依存クレート | `once_cell` を使用しているが、同等機能が `std::sync::LazyLock` / `OnceLock` として標準ライブラリに安定化済み |
| 2 | 依存クレート | `thiserror` 1.x を使用。2.x で derive マクロ改善あり |
| 3 | テスト安全性 | テストコードで `unsafe { std::env::set_var() }` を使用。Rust 2024 では `env::set_var` が unsafe 関数化されており、テスト並行実行時のデータ競合リスクあり |
| 4 | 依存クレート | `async-trait` を 21 ファイル・68 箇所で使用。Rust 2024 ではネイティブ async fn in traits が利用可能 |

### 方針

リスクの低い変更から段階的に実施し、各ステップ後にテストが全件通過することを保証する。

## DECISION MAKING

### Phase 1-B: `once_cell` → `std::sync::LazyLock` / `Once`

8 ソースファイルで `once_cell` クレートを標準ライブラリの型に置換:

| 変更前 | 変更後 | 対象ファイル |
|--------|--------|-------------|
| `once_cell::sync::Lazy<T>` | `std::sync::LazyLock<T>` | 7 ファイル |
| `once_cell::sync::OnceCell<()>` | `std::sync::Once` | 1 ファイル |

`OnceCell::get_or_try_init` は `std::sync::OnceLock` では未安定 (`once_cell_try`, issue #109737) のため、`observability/tracing.rs` では `std::sync::Once` + `call_once` パターンに書き換え:

```rust
// Before
static TRACING_INIT: OnceCell<()> = OnceCell::new();
pub fn init() -> Result<()> {
    TRACING_INIT.get_or_try_init(|| { /* ... */ })?;
    Ok(())
}

// After
static TRACING_INIT: Once = Once::new();
pub fn init() -> Result<()> {
    let mut result = Ok(());
    TRACING_INIT.call_once(|| {
        if let Err(e) = do_init() {
            result = Err(e);
        }
    });
    result
}
```

`Cargo.toml` から `once_cell = "1.21"` を削除。

### Phase 1-C: `thiserror` 1.x → 2.x

`Cargo.toml` で `thiserror = "1.0"` → `thiserror = "2.0"` に更新。API 互換性が高く、ソースコード変更なし。

### Phase 6-A: `unsafe env::set_var` → `temp_env`

5 テストファイルで `unsafe { std::env::set_var() }` / `unsafe { std::env::remove_var() }` を `temp_env` クレートのスコープベース環境変数管理に置換:

```rust
// Before
unsafe { std::env::set_var("RECAP_DB_DSN", "..."); }
let config = Config::from_env().unwrap();
// ... テスト後に手動クリーンアップが必要

// After
temp_env::with_vars(
    [("RECAP_DB_DSN", Some("..."))],
    || {
        let config = Config::from_env().unwrap();
        // スコープ終了時に自動で環境変数を復元
    },
);
```

`Cargo.toml` の `[dev-dependencies]` に `temp-env = "0.3"` を追加。

### Phase 1-A: `async-trait` 除去 → 延期

全 46 箇所の `#[async_trait]` 使用を分析した結果、対象トレイト全てが `Arc<dyn Trait>` としてオブジェクトセーフティを要求していることが判明:

- `RecapDao` (スーパートレイト + 12 サブトレイト)
- `FetchStage`, `PreprocessStage`, `DedupStage`, `GenreStage`, `SelectStage`, `DispatchStage`, `PersistStage`
- `Embedder`, `RefineEngine`, `TagLabelGraphSource`, `PulseStage`

ネイティブ async fn in traits は `dyn Trait` と非互換 (オブジェクトセーフティ違反) のため、`async-trait` の除去は以下の前提条件が必要:

1. `trait_variant::make` マクロの導入、または
2. DAO 層リファクタリング (Phase 2) による `dyn RecapDao` 依存の解消

現時点では影響範囲が大きすぎるため延期とした。

## RESULTS, EFFECTS

### 変更ファイル一覧

| 操作 | ファイル | Phase | 変更内容 |
|------|---------|-------|---------|
| 修正 | `Cargo.toml` | 1-B,1-C,6-A | `once_cell` 削除, `thiserror` 2.x 更新, `temp-env` 追加 |
| 修正 | `src/config.rs` | 1-B,6-A | `LazyLock` 移行 + テスト全面書き換え |
| 修正 | `src/language_detection.rs` | 1-B | `Lazy` → `LazyLock` |
| 修正 | `src/observability/tracing.rs` | 1-B | `OnceCell` → `Once` + `call_once` パターン |
| 修正 | `src/schema/news_creator.rs` | 1-B | `Lazy` → `LazyLock` |
| 修正 | `src/schema/subworker.rs` | 1-B | `Lazy` → `LazyLock` |
| 修正 | `src/pipeline/genre_canonical.rs` | 1-B | `Lazy` → `LazyLock` |
| 修正 | `src/pipeline/preprocess.rs` | 1-B | `Lazy` → `LazyLock` |
| 修正 | `src/classification/keywords.rs` | 1-B | `Lazy` → `LazyLock` |
| 修正 | `src/app.rs` | 6-A | テストで `temp_env::with_vars` に移行 |
| 修正 | `src/pipeline.rs` | 6-A | テストで `temp_env::with_vars` に移行 |
| 修正 | `src/api/generate.rs` | 6-A | テストで `temp_env::with_vars` に移行 |
| 修正 | `src/pipeline/graph_override.rs` | 6-A | テストで `temp_env::with_var` に移行 |

### テスト結果

| チェック | 結果 |
|---------|------|
| `cargo check` | PASS |
| `cargo clippy --all-targets -- -D warnings` | PASS (0 warnings) |
| `cargo test` | PASS (290 テスト, 0 失敗) |

### 動作確認

- Docker ビルド: `docker compose build recap-worker` → 成功
- コンテナ起動: `docker compose up -d recap-worker` → 成功
- ヘルスチェック (liveness): `/health/live` → 200
- ヘルスチェック (readiness): `/health/ready` → 200

### PROS

1. **外部依存の削減**: `once_cell` クレートを完全除去し、標準ライブラリのみに依存
2. **テスト安全性向上**: `unsafe` ブロックを 5 ファイルから排除。`temp_env` のスコープベース管理でテスト間の環境変数リークを防止
3. **手動クリーンアップ不要**: 従来はテスト後に `env::remove_var` を手動で呼ぶ必要があったが、`temp_env` によりスコープ終了時に自動復元
4. **thiserror 最新化**: 2.x の derive マクロ改善を活用可能に
5. **段階的移行の維持**: 各フェーズ間でテスト全件通過を保証し、リスクを最小化

### CONS, TRADEOFF

1. **`async-trait` 残存**: dyn Trait のオブジェクトセーフティ制約により、最もインパクトの大きい `async-trait` 除去は延期。DAO 層リファクタリング (Phase 2) 完了後に再検討
2. **`temp_env` 新規依存**: テスト専用 (`dev-dependencies`) とはいえ新しい外部クレートを追加。ただし広く使われており、`unsafe env::set_var` のリスク排除メリットが上回る
3. **tracing 初期化パターン変更**: `OnceCell::get_or_try_init` から `Once::call_once` + mutable result キャプチャへの書き換えにより、初期化エラーの伝播が若干冗長に

## APPENDIX

### 残りフェーズ (未実施)

本 ADR で実施した Phase 1-B, 1-C, 6-A は全体リファクタリング計画の初期ステップ。残りのフェーズは以下の通り:

| Phase | 内容 | 前提条件 |
|-------|------|---------|
| 1-A | `async-trait` 除去 | Phase 2 (DAO リファクタリング) |
| 2-A | DAO 層リファクタリング (compat.rs 廃止) | Phase 2-B |
| 2-B | `mockall` 導入 (手動 MockRecapDao 廃止) | なし |
| 3-A | Config 分解 (40+ フィールド → ドメイン別サブ構造体) | なし |
| 4-A | ステージ実行のタイプセーフ化 (enum 化) | なし |
| 4-B | パイプラインエラー型の整備 | なし |
| 5-A/B | パフォーマンス最適化 (メモリ / DB 接続) | なし |
| 6-B | パイプライン統合テスト整備 | Phase 2-B |

### 関連 ADR

- ADR-000191: pre-processor 7 フェーズ段階的リファクタリング (同一プロジェクト内の Go サービスにおける同様の段階的改善)
