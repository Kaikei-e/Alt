# Feed Search: 要約取得ロジック改善 & 無限スクロールデバッグ

## ADR's STATUS

Accepted

## CONTEXT

### 背景

Feed Search 機能において、以下の2つの問題が報告されていた:

1. **"Show summary" で常に "No summary available"**: AI生成要約が存在するにもかかわらず表示されない
2. **無限スクロールが動作しない**: IntersectionObserver は設定済みだが、追加読み込みが発生しない

### 根本原因分析

#### 問題1: 要約取得ロジック

| テーブル | 用途 | 参照状況 |
|----------|------|----------|
| `article_summaries` | AI生成要約 (pre-processor で生成) | **参照されていなかった** |
| `inoreader_summaries` | Inoreader フィード抜粋 | 参照されていた |

`FetchArticleSummary` ハンドラが `FetchInoreaderSummaryUsecase` のみを使用し、`article_summaries` テーブルを参照していなかった。

#### 問題2: 無限スクロール

状態管理の可視性が低く、`hasMore` や `cursor` の値が正しく伝播しているか確認困難だった。

## DECISION MAKING

### 検討したアプローチ

#### 要約取得ロジック

| Option | 内容 | 評価 |
|--------|------|------|
| A: 優先度付き検索 | AI要約を先に検索、なければ Inoreader フォールバック | **採用** |
| B: 並列検索 | 両テーブルを同時検索してマージ | 不採用 (複雑、AI要約優先のUX意図に反する) |
| C: 新規エンドポイント | AI要約専用のエンドポイント追加 | 不採用 (フロントエンド変更が大きい) |

**採用理由**: 既存の `AltDBRepository.FetchFeedSummary()` を活用でき、変更が局所的。AI生成要約を優先するUXに適合。

#### 無限スクロール

| Option | 内容 | 評価 |
|--------|------|------|
| A: デバッグログ追加 | コンソールログで状態を可視化 | **採用** |
| B: DevTools 拡張 | Svelte DevTools で状態確認 | 補助的に使用 |

**採用理由**: 本番環境でも一時的に有効化でき、問題の切り分けが容易。

### 参考資料

- Clean Architecture のレイヤー分離 - 既存の Repository パターンを活用
- Svelte 5 Runes - `$state`, `$derived` の反応性デバッグ

## RESULTS, EFFECTS

### 修正ファイル

#### alt-backend

| ファイル | 変更内容 |
|----------|----------|
| `app/connect/v2/articles/handler.go` | `FetchArticleSummary` で `article_summaries` を優先検索 |

**変更詳細**:
1. `AltDBRepository.FetchFeedSummary()` で AI要約を先に検索
2. AI要約が見つかれば即座に返却
3. 見つからなければ既存の `FetchInoreaderSummaryUsecase` にフォールバック
4. `AltDBRepository` が nil の場合のガード追加 (テスト互換性)

#### alt-frontend-sv

| ファイル | 変更内容 |
|----------|----------|
| `src/lib/components/mobile/search/SearchResults.svelte` | `loadMore` にデバッグログ追加 |
| `src/lib/components/mobile/search/SearchWindow.svelte` | 初回検索時のデバッグログ追加、`hasMore` 計算修正 |

### 要約取得フロー (修正後)

```
FetchArticleSummary Request
    │
    ▼
┌─────────────────────────────────────┐
│ 1. article_summaries テーブル検索   │
│    (AltDBRepository.FetchFeedSummary)│
└─────────────────────────────────────┘
    │
    ├── 見つかった → AI Summary を返却
    │
    ▼
┌─────────────────────────────────────┐
│ 2. inoreader_summaries テーブル検索 │
│    (FetchInoreaderSummaryUsecase)   │
└─────────────────────────────────────┘
    │
    └── 結果を返却 (空の場合もあり)
```

### PROS

1. **AI要約の優先表示**: pre-processor で生成した高品質な要約が表示される
2. **後方互換性維持**: Inoreader 要約へのフォールバックで既存機能を維持
3. **テスト互換性**: nil チェックにより既存テストが変更なしで通過
4. **デバッグ容易性**: コンソールログで無限スクロールの状態を追跡可能

### CONS, TRADEOFF

1. **パフォーマンス**: AI要約検索が追加されるため、レイテンシが若干増加 (通常 1-5ms)
2. **デバッグログ**: 本番環境でコンソールにログが出力される (必要に応じて削除)

## APPENDIX

### デプロイ手順

```bash
docker compose -f compose/compose.yaml -p alt build alt-backend alt-frontend-sv
docker compose -f compose/compose.yaml -p alt up -d alt-backend alt-frontend-sv
```

### 検証方法

#### 要約表示テスト

1. Feed Search で記事を検索
2. "Show summary" をクリック
3. AI要約がDBにある場合は表示される
4. ない場合は "Summarize Immediately" ボタンが表示される

#### 無限スクロールテスト

1. ブラウザ DevTools でコンソールを開く
2. "AI" などで検索 (20件以上ヒットするクエリ)
3. コンソールで以下を確認:
   - `[SearchWindow:handleSearch]` - 初回検索結果
   - `[SearchResults:loadMore]` - スクロール/ボタンクリック時

```
# 期待されるログ例
[SearchWindow:handleSearch] API response {resultsCount: 20, nextCursor: 20, hasMore: true}
[SearchWindow:handleSearch] State updated {cursor: "20", hasMore: true}
[SearchResults:loadMore] called {isLoading: false, hasMore: true, cursor: "20", resultsCount: 20}
```

### テスト実行

```bash
# alt-backend
cd alt-backend/app
go test ./connect/v2/articles/... -v

# alt-frontend-sv
cd alt-frontend-sv
bun run check
```
