# Morning Letter: 時間限定RAGチャット機能

## ステータス

**採択・実装完了（Accepted & Implemented）** - 2025年12月

## コンテキスト

### 背景

ユーザーは日々大量のRSSフィードを購読しているが、すべての記事を読む時間がない。特に朝の時間帯に「昨日何が起きたか」を素早く把握したいというニーズがある。

### 既存の課題

1. **情報過多**: 購読フィードが多いユーザーほど、未読記事が溜まりやすい
2. **時間制約**: 朝の限られた時間で重要なニュースを把握したい
3. **コンテキスト不足**: 単なる記事リストでは、トピック間の関連性が見えにくい

### 要件

- 過去24時間（最大7日間）のニュースについて自然言語で質問できる
- 回答には出典（Citation）を含める
- ストリーミングレスポンスでリアルタイムに回答を表示
- モバイル・デスクトップ両対応

## 意思決定

### 決定1: Connect-RPC によるストリーミングAPI

RESTではなくConnect-RPC（gRPC-Web互換）を採用し、サーバーストリーミングを実現。

**Protocol Buffer定義** (`proto/alt/morning_letter/v2/morning_letter.proto`):

```protobuf
service MorningLetterService {
  rpc StreamChat(StreamChatRequest) returns (stream StreamChatEvent);
}

message StreamChatRequest {
  repeated ChatMessage messages = 1;  // 会話履歴
  int32 within_hours = 2;             // 時間窓（デフォルト: 24, 最大: 168）
}

message StreamChatEvent {
  string kind = 1;  // "delta", "meta", "done", "fallback", "error"
  oneof payload {
    string delta = 2;           // テキストチャンク
    MetaPayload meta = 3;       // Citation情報
    DonePayload done = 4;       // 完了
    string fallback_code = 5;   // フォールバック理由
    string error_message = 6;   // エラー
  }
}
```

**設計判断:**
- `delta`: LLMからのテキストチャンクをリアルタイム配信
- `meta`: 検索した記事数、時間窓、Citation情報をレスポンス中盤で送信
- `done`: 完了時に全文と最終Citationを送信
- `fallback`: コンテキスト不足時のフォールバック通知

### 決定2: Temporal Boost によるスコア調整

ベクトル検索結果に対して、記事の新しさに応じたブースト係数を適用。

```go
// rag-orchestrator/internal/usecase/morning_letter_usecase.go
func (u *morningLetterUsecase) applyTemporalBoost(contexts []ContextItem, now time.Time) []ContextItem {
    for i := range contexts {
        hoursSince := now.Sub(publishedAt).Hours()
        var boost float32 = 1.0
        switch {
        case hoursSince <= 6:
            boost = 1.3   // 直近6時間: 30%ブースト
        case hoursSince <= 12:
            boost = 1.15  // 6-12時間: 15%ブースト
        case hoursSince <= 18:
            boost = 1.05  // 12-18時間: 5%ブースト
        }
        contexts[i].Score *= boost
    }
    return contexts
}
```

**設計判断:**
- 最新ニュースを優先しつつ、過去の重要記事も検索結果に含める
- ブースト係数は段階的に減衰させ、急激な優先度変化を避ける

### 決定3: デュアルアーキテクチャ（Legacy + RAG）

既存のMorning Updates（記事グループ表示）とRAGベースのチャット機能を併存。

**Legacy API** (`alt-backend`):
```
GET /v1/morning-letter/updates
  → ユーザー購読フィードの記事グループを返却
  → recap-worker → alt-backend → Frontend
```

**RAG Chat API** (`rag-orchestrator`):
```
StreamChat (Connect-RPC)
  → 自然言語質問に対してRAG回答を生成
  → alt-backend (記事取得) → rag-orchestrator → LLM → Frontend
```

**設計判断:**
- 既存機能を壊さずに新機能を追加
- 将来的にはRAGベースに統一することを想定
- Legacy APIは `MORNING_GROUPS_LEGACY_ENABLED` フラグで制御可能

### 決定4: Svelte 5 Runes によるリアクティブUI

フロントエンドはSvelte 5のRunes記法を採用し、ストリーミングレスポンスを効率的に処理。

**状態管理** (`alt-frontend-sv/src/lib/components/*/morning-letter/MorningLetterChat.svelte`):

```typescript
let messages = $state<Message[]>([...]);
let isLoading = $state(false);

// Throttled delta updates
let bufferedContent = "";
let lastUpdateTime = 0;
const THROTTLE_MS = 50;

currentAbortController = streamMorningLetterChat(
    transport,
    { messages: chatHistory, withinHours },
    (text) => {  // onDelta
        bufferedContent += text;
        const now = Date.now();
        if (now - lastUpdateTime > THROTTLE_MS) {
            messages[currentAssistantMessageIndex].message = bufferedContent;
            lastUpdateTime = now;
        }
    },
    (meta) => { ... },  // onMeta
    (result) => { ... }, // onComplete
);
```

**設計判断:**
- 50msのスロットリングで高頻度更新を抑制（パフォーマンス最適化）
- AbortControllerによるキャンセル対応
- モバイル/デスクトップで共通ロジック、UIのみ分離

## アーキテクチャ

### システム構成図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           alt-frontend-sv                                │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  MorningLetterChat.svelte (Desktop / Mobile)                     │    │
│  │  - Svelte 5 Runes ($state, $props)                              │    │
│  │  - streamMorningLetterChat() via Connect-RPC                    │    │
│  │  - Markdown rendering with parseMarkdown()                       │    │
│  └──────────────────────────────┬──────────────────────────────────┘    │
└─────────────────────────────────┼───────────────────────────────────────┘
                                  │ Connect-RPC (HTTP/2 streaming)
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           rag-orchestrator                               │
│  ┌───────────────────┐  ┌────────────────────┐  ┌──────────────────┐   │
│  │ Connect Handler   │→ │ MorningLetterUC    │→ │ PromptBuilder    │   │
│  │ (StreamChat)      │  │ - Temporal boost   │  │ - XML formatting │   │
│  └───────────────────┘  │ - Parse JSON resp  │  └──────────────────┘   │
│                         └─────────┬──────────┘                          │
│                                   │                                      │
│  ┌───────────────────────────────┼────────────────────────────────┐    │
│  │                               ▼                                 │    │
│  │  RetrieveContextUsecase ←── ArticleClient ←── alt-backend       │    │
│  │  (Vector search)             (HTTP)          GET /v1/articles   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                   │                                      │
│                                   ▼                                      │
│                          LLMClient (knowledge-augur)                     │
└─────────────────────────────────────────────────────────────────────────┘
```

### データベーススキーマ

```sql
-- recap-db (recap-migration-atlas)

-- 日次サマリー（将来のキャッシュ用）
CREATE TABLE morning_daily_summaries (
    id UUID PRIMARY KEY,
    target_date DATE NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- サマリーのエビデンス記事
CREATE TABLE morning_daily_evidence (
    summary_id UUID REFERENCES morning_daily_summaries(id),
    article_id UUID NOT NULL,
    score FLOAT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (summary_id, article_id)
);

-- Legacy: 記事グループ（recap-worker生成）
CREATE TABLE morning_article_groups (
    group_id UUID NOT NULL,
    article_id UUID NOT NULL,
    is_primary BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (group_id, article_id)
);
```

## 結果・効果

### PROS

1. **ユーザー体験の向上**
   - 自然言語で最新ニュースを質問可能
   - ストリーミングによるリアルタイム応答でUX向上
   - Citationにより信頼性を担保

2. **柔軟な時間窓**
   - デフォルト24時間、最大168時間（7日間）
   - ユーザーのニーズに応じて調整可能

3. **既存資産の活用**
   - rag-orchestratorのRAGパイプラインを再利用
   - Temporal boostによる時間認識検索

4. **段階的移行**
   - Legacy APIとRAG APIの併存
   - フィーチャーフラグによる制御

### CONS / TRADEOFF

1. **複雑性の増加**
   - Connect-RPC + REST の二重API構成
   - Legacy/RAGの状態管理が複雑

2. **LLM依存**
   - LLMサービス障害時のフォールバック必要
   - コスト（トークン消費）の考慮

3. **未実装機能**
   - `morning_daily_summaries` のキャッシュ機構は未実装
   - パーソナライゼーション（ユーザー嗜好）は今後の課題

## 付録

### ファイル構成

| カテゴリ | ファイル | 説明 |
|---------|---------|------|
| **Proto** | `proto/alt/morning_letter/v2/morning_letter.proto` | サービス定義 |
| **Frontend** | `alt-frontend-sv/src/lib/connect/morning_letter.ts` | Connect-RPCクライアント |
| | `alt-frontend-sv/src/lib/components/desktop/morning-letter/MorningLetterChat.svelte` | デスクトップUI |
| | `alt-frontend-sv/src/lib/components/mobile/morning-letter/MorningLetterChat.svelte` | モバイルUI |
| **rag-orchestrator** | `internal/domain/morning_letter.go` | ドメインモデル |
| | `internal/usecase/morning_letter_usecase.go` | ユースケース |
| | `internal/usecase/morning_letter_prompt_builder.go` | プロンプト構築 |
| **alt-backend** | `app/domain/morning.go` | ドメインモデル（Legacy） |
| | `app/usecase/morning_usecase/morning_usecase.go` | ユースケース（Legacy） |
| | `app/rest/morning_handlers.go` | RESTハンドラ（Legacy） |
| | `app/gateway/morning_gateway/morning_gateway.go` | ゲートウェイ（Legacy） |
| **Migration** | `recap-migration-atlas/.../20251120000100_morning_letter.sql` | DBスキーマ |

### 環境変数

```bash
# rag-orchestrator
ALT_BACKEND_URL=http://alt-backend:9000
MORNING_DEFAULT_HOURS=24
MORNING_MAX_HOURS=168
MORNING_TOPIC_LIMIT=10

# alt-backend (Legacy)
RECAP_WORKER_URL=http://recap-worker:9005
MORNING_GROUPS_LEGACY_ENABLED=true
```

### 関連ADR

- ADR-000025: RAG Pipeline初期設計
- ADR-000028: pgvector導入とHNSWインデックス
- ADR-000036: RAG Orchestratorパフォーマンス最適化

### 参考資料

- [2025's Ultimate Guide to RAG Retrieval](https://medium.com/@mehulpratapsingh/2025s-ultimate-guide-to-rag-retrieval)
- [Enhancing RAG: A Study of Best Practices (arXiv 2501.07391)](https://arxiv.org/abs/2501.07391)
- [Google Research: Sufficient Context in RAG](https://research.google/blog/deeper-insights-into-retrieval-augmented-generation-the-role-of-sufficient-context/)
- [Connect-RPC Documentation](https://connectrpc.com/docs/)
