# ADR-000292: Augurストリーミング30秒タイムアウト修正（ハートビート導入）

## ADR's STATUS

Accepted

## CONTEXT

Augur（RAGチャット）のストリーミング応答が、文生成途中で `Error: [unknown] missing EndStreamResponse` となり切断される問題が発生していた。

### 調査結果

- nginxアクセスログで `rt=30.002`, `rt=30.014` — リクエストが**ちょうど30秒**で切断
- rag-orchestratorログ: "stream chat cancelled by client" — チャンク送信中（94/176受信済）にクライアント側から切断
- アプリケーションコード内のタイムアウト値は全て300s〜600sで、30sに設定された箇所は存在しない

### 根本原因

CDN/TunnelのProxy Write Timeout（30秒、変更不可）が原因。Tunnelはストリーミングレスポンスをバッファリングする性質があり、`buildPrompt`（検索+リランキング）の11秒間やLLMセットアップの待機中にデータが流れないと、Edge側がアイドルと判断して接続を切断する。

ADR-000289で `proxy_buffering off` と progress イベントを導入済みだったが、`buildPrompt` の実行中は依然としてデータが流れない区間が残っていた。

## DECISION MAKING

アプリケーションレベルのハートビートイベントを5秒間隔で送信し、全レイヤーのタイムアウトを回避する方針を採用。加えて、nginx/SvelteKit/alt-backendの各レイヤーでストリーミング最適化を実施。

### 1. rag-orchestrator: ハートビートイベント（主対策）

- `StreamEventKindHeartbeat` を新規追加
- `buildPrompt`（検索+リランキング）をgoroutineで非同期実行し、5秒間隔の `time.Ticker` でハートビートを送信
- ハートビート間隔は `WithHeartbeatInterval` オプションで設定可能（テスト時に短縮可能）
- Connect-RPCハンドラに `heartbeat` イベントの変換処理を追加

### 2. フロントエンド: ハートビート受信処理

- `augur.ts` の `for await` ループでハートビートイベントを `continue` でスキップ（UIへの影響なし）

### 3. nginx: ストリーミングlocationヘッダー修正

- Connect-RPCストリーミング用locationの `Connection: "upgrade"`（WebSocket用）を `Connection: ''`（keep-alive）に変更
- `X-Accel-Buffering: no` ヘッダーを追加し、上位プロキシのバッファリングも明示的に無効化

### 4. SvelteKitプロキシ: ストリーミングヘッダー追加

- Connect-RPCストリーミングレスポンス（`application/connect+proto`, `application/grpc`）に `X-Accel-Buffering: no` と `Cache-Control: no-cache, no-transform` を付与

### 5. alt-backend: Connect-RPCサーバー設定

- `http.ListenAndServe()` を `http.Server` 構造体に置換し、ストリーミング用のタイムアウト設定を明示化
  - `WriteTimeout: 0`（ストリーミングのため無制限）
  - `ReadHeaderTimeout: 10s`（Slowloris対策）
  - `IdleTimeout: 120s`
- graceful shutdownも追加

## RESULTS, EFFECTS

### PROS

- **30秒タイムアウト回避**: 5秒間隔のデータフローにより、Tunnel/CDNのアイドル検出を防止
- **全レイヤーでの一貫性**: nginx → SvelteKit → alt-backend → rag-orchestrator の全段でストリーミング最適化
- **テスト容易性**: `WithHeartbeatInterval` オプションにより、テスト時はミリ秒単位のインターバルで検証可能
- **後方互換性**: フロントエンドはハートビートを単純にスキップするため、既存のイベント処理に影響なし
- **TDDで品質担保**: ハートビート発行テスト・不要時の非発行テスト・イベント変換テストを追加

### CONS, TRADEOFF

- **ネットワーク帯域の微増**: 5秒ごとの空イベント送信（数十バイト程度のため影響は軽微）
- **goroutineの追加**: `buildPrompt` を goroutine で実行するため、コードの複雑性がわずかに増加
- **`WriteTimeout: 0`**: Go標準の `http.Server` で書き込みタイムアウトを無制限に設定。ストリーミングに必須だが、スロークライアント攻撃のリスクをコンテキストキャンセルで緩和

## APPENDIX

### 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `rag-orchestrator/internal/usecase/rag_answer_types.go` | `StreamEventKindHeartbeat` 追加 |
| `rag-orchestrator/internal/usecase/rag_answer_stream.go` | buildPrompt非同期化 + ハートビートticker |
| `rag-orchestrator/internal/usecase/answer_with_rag_usecase.go` | `heartbeatInterval` フィールド + `WithHeartbeatInterval` オプション |
| `rag-orchestrator/internal/adapter/connect/augur/handler.go` | heartbeat → proto変換case追加 |
| `alt-frontend-sv/src/lib/connect/augur.ts` | heartbeatイベントスキップ |
| `nginx/conf.d/default.conf` | Connection header修正 + X-Accel-Buffering |
| `alt-frontend-sv/src/routes/api/v2/[...path]/+server.ts` | ストリーミングレスポンスヘッダー追加 |
| `alt-backend/app/main.go` | http.Server設定 + graceful shutdown |

### テスト

- `TestStream_HeartbeatDuringSlowBuildPrompt`: 350ms遅延のmockで100ms間隔ハートビートが2回以上発行されることを確認
- `TestStream_NoHeartbeatWhenBuildPromptFast`: 高速完了時にハートビートが発行されないことを確認
- `TestConvertStreamEvent_Heartbeat`: ハートビートイベントのproto変換を確認

### 関連ADR

- ADR-000289: nginx proxy_buffering off + progress event（本ADRの前段対策）
