# ADR-000251: 要約バッチと品質チェッカーの無限ループ解消

## ステータス

承認済み

## コンテキスト

### 背景

pre-processor は 5 分間隔で以下の 2 つのバッチジョブを実行する。

1. **要約バッチ**: 未要約記事を取得し、news-creator API で日本語要約を生成して `article_summaries` に保存
2. **品質チェッカー**: 保存済みの要約を LLM で品質評価し、スコアが閾値（7）未満のサマリーを `article_summaries` から削除

### 問題

`unsummarized articles count` が 117 → 70 → 72 と変動し続け収束しない。品質チェッカーが毎バッチ `removed: 40, retained: 0` と 100% 削除を繰り返しており、要約 → 削除 → 再要約の無限ループが発生していた。

#### 発生メカニズム

```
[要約バッチ 5分ごと]                  [品質チェッカー 5分ごと]
  ↓                                      ↓
content < 100文字?                    summary を LLM で品質評価
  → Yes: プレースホルダー保存          score=1 (プレースホルダーは当然低品質)
  ↓                                      ↓
article_summaries に追加               article_summaries から削除
  ↓                                      ↓
記事は「要約済み」に                    記事は「未要約」に戻る
                    ← 無限ループ →
```

#### なぜコンテンツが短いのか

RSS フィードの `summary.content` は全文ではなく概要のみを提供する。pre-processor は受信したコンテンツをそのまま保存するため、大半の記事が 100 文字未満となる。コンテンツ長の分布は以下の通り:

- 35 文字: 54 件（最多）
- 12 文字: 12 件
- 41 文字: 9 件
- 100 文字以上: ごく少数

#### 副次的問題

`RemoveLowScoreSummary` 関数内で、削除後に記事 URL への HTTP GET を行っていたが、レスポンスボディを何にも使用せずクローズしていた。無意味なネットワーク呼び出しが毎回発生していた。

## 意思決定

### Fix 1: 品質チェッカーでプレースホルダーサマリーをスキップ（無限ループの直接修正）

`JudgeArticleQuality` の冒頭で、サマリーが既知のプレースホルダーメッセージと一致するかを判定し、一致する場合は品質評価をスキップして `nil` を返す。

```go
var knownPlaceholders = []string{
    "本文が短すぎるため要約できませんでした。",
    "本文が長すぎるため要約できませんでした。",
}

func isPlaceholderSummary(summary string) bool {
    for _, placeholder := range knownPlaceholders {
        if summary == placeholder {
            return true
        }
    }
    return false
}
```

**理由**: プレースホルダーは要約ではなくメタデータである。品質評価の対象外とすることで、削除 → 再要約の無限ループを根本的に断ち切る。プレースホルダーの一覧は `article_summarizer.go` の `placeholderMessages` と一致させている。

### Fix 2: 短いコンテンツに対するタイトルベースフォールバック

`ArticleSummarizerAPIClient` および `StreamArticleSummarizerAPIClient` で、抽出コンテンツが 100 文字未満の場合に記事タイトルの文字数を確認し、タイトルが 100 文字以上であればタイトルをコンテンツとして使用する。

```go
if extractedRuneCount < minContentLength {
    titleRuneCount := utf8.RuneCountInString(article.Title)
    if titleRuneCount >= minContentLength {
        extractedContent = article.Title
        // タイトルベースの要約を生成
    } else {
        return nil, ErrContentTooShort
    }
}
```

**理由**: RSS フィードのタイトルが十分に長い場合、タイトルからでも有用な要約を生成できる。大半のケース（短いタイトル + 短いコンテンツ）ではプレースホルダーのまま残るが、Fix 1 で無限ループは防がれる。

### Fix 3: `RemoveLowScoreSummary` の無意味な再フェッチを削除

サマリー削除後の記事 URL への HTTP GET リクエスト（旧 L328-L374）を完全に削除した。レスポンスボディを使用していないため、ネットワーク帯域とレイテンシの無駄遣いであった。

### 検討した代替案

| 案 | 不採用理由 |
|---|---|
| 品質チェッカーでスコア閾値を下げる | プレースホルダーは意味のある要約ではないため、閾値調整では根本解決しない |
| プレースホルダーを `article_summaries` に保存しない | 未要約記事として毎バッチ再処理されるコストが高い。プレースホルダーで「処理済み」をマークする設計は妥当 |
| 全文スクレイピングで RSS コンテンツを補完する | スケーラビリティ・倫理・法律上の課題が大きい。別途検討すべき施策 |

## 結果・影響

### 変更概要

| ファイル | 変更内容 |
|---|---|
| `pre-processor/app/quality-checker/quality_judger.go` | `isPlaceholderSummary` ヘルパー追加、`JudgeArticleQuality` 冒頭にプレースホルダースキップ判定追加、`RemoveLowScoreSummary` から不要な HTTP GET を削除 |
| `pre-processor/app/quality-checker/quality_judger_test.go` | `TestIsPlaceholderSummary`（6 ケース）、`TestJudgeArticleQualitySkipsPlaceholder`（2 ケース）追加 |
| `pre-processor/app/driver/summarizer_api.go` | `ArticleSummarizerAPIClient`、`StreamArticleSummarizerAPIClient` にタイトルフォールバック追加 |
| `pre-processor/app/driver/summarizer_api_test.go` | `TestTitleFallback`（2 ケース）追加 |

### テストカバレッジ

| テスト | 検証内容 |
|---|---|
| `TestIsPlaceholderSummary/placeholder_too_short` | 短すぎるプレースホルダーを正しく検出 |
| `TestIsPlaceholderSummary/placeholder_too_long` | 長すぎるプレースホルダーを正しく検出 |
| `TestIsPlaceholderSummary/normal_summary` | 通常の要約をプレースホルダーと誤判定しない |
| `TestIsPlaceholderSummary/empty_summary` | 空文字列をプレースホルダーと誤判定しない |
| `TestIsPlaceholderSummary/partial_match` | 部分一致を誤判定しない |
| `TestIsPlaceholderSummary/placeholder_with_extra_text` | 末尾に追加テキストがある場合を誤判定しない |
| `TestJudgeArticleQualitySkipsPlaceholder/too_short_placeholder` | プレースホルダーで LLM 呼び出しが発生しないことを検証 |
| `TestJudgeArticleQualitySkipsPlaceholder/too_long_placeholder` | 同上（長すぎるパターン） |
| `TestTitleFallback/short_content_with_long_title_uses_title` | 短いコンテンツ + 長いタイトルで要約が生成されること |
| `TestTitleFallback/short_content_with_short_title_returns_ErrContentTooShort` | 両方短い場合に `ErrContentTooShort` が返ること |

### 期待される動作変化

- `Skipping quality check: placeholder summary` ログが出力される
- 品質チェッカーの `removed` 数が大幅に減少する（プレースホルダーが削除されなくなるため）
- `unsummarized articles count` が安定し、バッチ間の振動が収まる
- 不要な外部 HTTP リクエストが排除される

### 影響範囲

- **要約バッチ**: タイトルフォールバックにより、一部の記事でプレースホルダーではなく実要約が生成される可能性がある
- **品質チェッカー**: プレースホルダーをスキップすることで LLM 呼び出し回数が減少し、処理時間が短縮される
- **イベント駆動パス**: 同じ `ArticleSummarizerAPIClient` を使用するため、タイトルフォールバックの恩恵を受ける
- **パフォーマンス**: 不要な HTTP GET の削除と LLM 呼び出し削減により、CPU・ネットワーク負荷が軽減される

## 関連 ADR

- ADR-000247: 要約パイプライン修正（カーソルページネーション導入）
- ADR-000249: 要約パイプラインのイベント駆動化
- ADR-000250: カーソルページネーション固着バグの修正
