# ADR-000312: RegisterFeedsUsecase から mq-hub への ArticleCreated イベント発行

## ADR's STATUS

完了

## CONTEXT

alt-backend のフィード登録フローには、記事が `feeds` テーブルに INSERT された後、下流サービス（pre-processor, search-indexer, tag-generator）へイベントを伝播するパスが 2 つ存在していた。

1. **Outbox パターン（既存）**: `outbox` テーブルへの INSERT → 5 秒間隔ポーリング → rag-orchestrator 経由で配信
2. **mq-hub 経由（部分導入済）**: `EventPublisherPort` を介した Redis Streams への直接発行

Outbox パターンはトランザクショナル保証がある一方、ポーリング遅延（最大 5 秒）が存在する。mq-hub は即時配信が可能だが、`RegisterFeedsUsecase`（ユーザー操作起点のフィード登録）からは未接続であった。

ドメインイベント設計のベストプラクティスに従い、`RegisterFeedsUsecase` から `ArticleCreated` イベントを fire-and-forget で発行する。

### 設計原則

- **Fine-grained domain events**: 各集約が自身のドメインイベントを発行する
- **Thin events**: ID + タイムスタンプ + URL のみで coupling を最小化
- **Fire-and-forget**: イベント発行失敗はメイン操作を止めない
- **Idempotent consumers**: 下流は重複イベントに対して冪等に処理する

## DECISION MAKING

### 変更方針

`RegisterMultipleFeeds` に `RETURNING id` を追加し、INSERT/UPDATE 双方で生成された記事 ID を取得する。これを Usecase 層まで伝搬し、`EventPublisherPort` 経由で `ArticleCreated` イベントを発行する。

### レイヤーごとの変更

#### 1. Driver 層

`RegisterMultipleFeeds` の戻り値を `error` → `([]string, error)` に変更。PostgreSQL の `ON CONFLICT DO UPDATE ... RETURNING id` は INSERT/UPDATE 両方で `id` を返す。

```sql
INSERT INTO feeds (...) VALUES (...)
ON CONFLICT (link) DO UPDATE SET ...
RETURNING id
```

pgx Batch API の `br.Exec()` を `br.QueryRow().Scan(&id)` に置き換え、各行の ID を収集する。

#### 2. Port 層

`RegisterFeedsPort` インターフェースの `RegisterFeeds` 戻り値を `([]string, error)` に変更。

#### 3. Gateway 層

`RegisterFeedsGateway` は Driver から受け取った `ids` をそのまま返す（パススルー）。

#### 4. Usecase 層

- `eventPublisher event_publisher_port.EventPublisherPort` フィールドを追加
- `SetEventPublisher(port)` setter を追加
- `publishFeedEvents()` ヘルパーメソッドを追加（fire-and-forget パターン）

```
Execute()
  ├── RegisterRSSFeedLink
  ├── FetchFeedLinkIDByURL
  ├── FetchFeeds
  ├── RegisterFeeds → ids を取得
  ├── publishFeedEvents(ids, feedItems)  ← NEW
  └── autoSubscribeUser
```

`publishFeedEvents` は `IsEnabled()` で有効性を確認後、各 ID に対して `PublishArticleCreated` を呼ぶ。失敗時は WARN ログのみで、`Execute` の戻り値には影響しない。

#### 5. DI Container

`registerFeedsUsecase.SetEventPublisher(eventPublisherGatewayImpl)` を配線に追加。

#### 6. 呼び出し元

`job_runner.go` の `CollectFeedsJob` は `RegisterMultipleFeeds` の戻り値 `ids` を `_` で無視（定期収集ジョブではイベント発行不要）。

### 既存の `ArticleCreatedEvent` を再利用

新しいイベント型は導入せず、`event_publisher_port.ArticleCreatedEvent` をそのまま使用する。

## RESULTS, EFFECTS

### テスト

新規 4 件 + 既存テスト更新:

| テスト名 | 検証内容 |
|---------|---------|
| `EventPublishing_Success` | `IsEnabled=true` で `PublishArticleCreated` が各 ID に対して呼ばれる |
| `EventPublishing_Disabled` | `IsEnabled=false` で `Publish` が呼ばれない |
| `EventPublishing_NotSet` | `EventPublisher=nil` でも正常動作する |
| `EventPublishing_FailureNonFatal` | `Publish` 失敗でも `Execute` は成功する |

既存テストは `RegisterFeeds` の mock 戻り値を `([]string{...}, nil)` に更新。

### 修正対象ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `driver/alt_db/register_feeds_driver.go` | `RETURNING id` 追加、戻り値変更 |
| `job/job_runner.go` | `_, err :=` に変更 |
| `port/register_feed_port/register_port.go` | インターフェース戻り値変更 |
| `mocks/mock_register_feed_port.go` | mockgen 再生成 |
| `gateway/register_feed_gateway/feeds_gateway.go` | 戻り値パススルー |
| `usecase/register_feed_usecase/feeds_usecase.go` | `EventPublisher` 追加 |
| `di/container.go` | `SetEventPublisher` 配線 |
| `usecase/register_feed_usecase/feeds_usecase_test.go` | 既存テスト更新 + 新規 4 件 |
| `usecase/register_feed_usecase/feeds_integration_test.go` | 戻り値更新 |
| `gateway/register_feed_gateway/feeds_gateway_test.go` | 戻り値更新 |
| `gateway/register_feed_gateway/feeds_db_integration_test.go` | 戻り値更新 |

### PROS

- **即時通知**: ユーザー操作起点のフィード登録で、下流サービスへの通知遅延がゼロになる
- **既存パターンの再利用**: `EventPublisherPort` と `ArticleCreatedEvent` を再利用し、新しい抽象化を導入しない
- **障害隔離**: fire-and-forget により、mq-hub の障害がフィード登録フローに波及しない
- **後方互換性**: `SetEventPublisher` は optional setter であり、呼ばなければ従来どおり動作する
- **テスタビリティ**: 4 つの新規テストで fire-and-forget のすべてのパス（成功・無効・nil・失敗）を網羅

### CONS, TRADEOFF

- **at-most-once**: fire-and-forget のため、イベント欠損の可能性がある。Outbox パターン（at-least-once）との併用で補完する
- **二重イベント**: Outbox パターンと mq-hub の両方からイベントが発行されうる。下流コンシューマーの冪等性が前提
- **RETURNING id のオーバーヘッド**: `Exec` → `QueryRow().Scan()` への変更で、pgx Batch 処理に微小なオーバーヘッドが発生するが、ネットワーク I/O に比べ無視できる

## APPENDIX

### 検証コマンド

```bash
cd alt-backend/app

# Usecase テスト（イベント発行含む）
go test ./usecase/register_feed_usecase/ -v -run TestRegisterFeedUsecase

# Gateway テスト
go test ./gateway/register_feed_gateway/ -v

# 全体テスト
go test ./...
```

### 関連 ADR

- ADR-000083: Redis Streams イベント駆動化（mq-hub 導入）
- ADR-000303: フィード登録時のユーザー自動購読（`autoSubscribeUser` パターンの前例）
