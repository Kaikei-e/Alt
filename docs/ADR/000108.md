# HDBSCAN クラスタリング性能改善とMiniBatchKMeansフォールバック

## ADR'S STATUS

Accepted

## CONTEXT

### 背景

サブジャンル分割のクラスタリング処理において、大規模ジャンル（数百記事以上）でタイムアウトが頻発していた。recap-workerのスタック検知閾値（600秒）を超えると処理が中断され、成功率が低下する問題があった。

### 問題

1. **成功率の低下**: 大規模ジャンルでクラスタリングがタイムアウト
2. **Optuna最適化のオーバーヘッド**: 50トライアルのハイパーパラメータ探索が時間を消費
3. **UMAP次元数**: 20次元への削減でも計算量が大きい
4. **バッチサイズ**: 小さいバッチサイズによるオーバーヘッド

### 根本原因分析

| 原因 | 影響 |
|------|------|
| スタック検知 600秒 | 大規模ジャンルがタイムアウト |
| Optuna 50トライアル | TPEの収束に必要以上の試行 |
| UMAP 20次元 | HDBSCAN計算量が増大 |
| バッチサイズ 8 | GPU利用効率が低い |

## DECISION MAKING

### 決定

クラスタリング性能を改善するため、以下の設定変更とフォールバック機構を導入する。

### 1. 設定値の最適化

| 環境変数 | 変更前 | 変更後 | 根拠 |
|----------|--------|--------|------|
| `RECAP_CLUSTERING_STUCK_THRESHOLD_SECS` | 600 | 1200 | 大規模ジャンルに余裕を持たせる |
| `RECAP_SUBWORKER_BAYES_OPT_TRIALS` | 50 | 15 | TPEは15-20トライアルで収束 |
| `RECAP_SUBWORKER_UMAP_N_COMPONENTS` | 20 | 8 | 8次元でも品質維持可能 |
| `RECAP_SUBWORKER_BATCH_SIZE` | 8 | 32 | GPU利用効率の向上 |
| `RECAP_SUBWORKER_HDBSCAN_TIMEOUT_SECS` | - | 300 | フォールバック用タイムアウト |

### 2. MiniBatchKMeansフォールバック機構

HDBSCANが指定時間内に完了しない場合、MiniBatchKMeansにフォールバックする。

```
1. HDBSCANを別スレッドで実行（タイムアウト付き）
2. タイムアウト発生時 → MiniBatchKMeansで代替クラスタリング
3. クラスタ数の自動推定: k = sqrt(N/2), 2 ≤ k ≤ 50
4. ClusterResultにused_fallbackフラグを追加
```

### 設計根拠

1. **スタック検知 1200秒**: 600秒では大規模ジャンルが頻繁にタイムアウト。20分（1200秒）で余裕を確保
2. **Optuna 15トライアル**: TPEサンプラーは15-20トライアルで収束することが多い
3. **UMAP 8次元**: クラスタリング品質を維持しつつ計算量を削減
4. **バッチサイズ 32**: GPUメモリに収まる範囲で最大化
5. **フォールバック 300秒**: 5分以内に完了しない場合は高速なMiniBatchKMeansを使用

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 種別 | 内容 |
|----------|------|------|
| `compose/recap.yaml` | 設定追加 | 環境変数の追加・変更 |
| `recap-subworker/recap_subworker/infra/config.py` | 設定追加 | `hdbscan_timeout_seconds`フィールド追加 |
| `recap-subworker/recap_subworker/services/clusterer.py` | 機能追加 | MiniBatchKMeansフォールバック実装 |
| `recap-subworker/tests/services/test_clusterer.py` | テスト追加 | フォールバック機能のテスト |

### 新規追加メソッド（clusterer.py）

| メソッド | 説明 |
|----------|------|
| `_run_with_timeout()` | タイムアウト付き関数実行 |
| `_fallback_minibatch_kmeans()` | MiniBatchKMeansによる代替クラスタリング |
| `_estimate_optimal_clusters()` | クラスタ数の自動推定 |

### PROS

1. **成功率向上**: タイムアウトによる失敗を削減
2. **処理時間短縮**: Optunaトライアル削減で30-40%高速化
3. **堅牢性**: HDBSCANが遅い場合もMiniBatchKMeansで処理継続
4. **可観測性**: `used_fallback`フラグでフォールバック発生を追跡可能

### CONS, TRADEOFF

1. **MiniBatchKMeansの品質**: HDBSCANより密度ベースのクラスタリング品質が劣る可能性
2. **固定クラスタ数**: MiniBatchKMeansはk個のクラスタを強制（ノイズポイントなし）
3. **設定の複雑化**: タイムアウト値の調整が必要

## APPENDIX

### 関連コード

| ファイル | 関数/クラス |
|----------|-------------|
| `recap-subworker/recap_subworker/services/clusterer.py` | `Clusterer.cluster()` |
| `recap-subworker/recap_subworker/infra/config.py` | `Settings.hdbscan_timeout_seconds` |
| `recap-worker/recap-worker/src/config.rs` | `clustering_stuck_threshold` |

### 参考

- [Optuna TPE Sampler](https://optuna.readthedocs.io/en/stable/reference/samplers/generated/optuna.samplers.TPESampler.html)
- [scikit-learn MiniBatchKMeans](https://scikit-learn.org/stable/modules/clustering.html#mini-batch-kmeans)
- [UMAP Dimensionality Reduction](https://umap-learn.readthedocs.io/)
