# OpenTelemetry HTTP Span Status 設定の実装

## ADR's STATUS

Accepted

## CONTEXT

### 背景

Go系マイクロサービス（alt-backend, pre-processor, auth-hub, search-indexer）において、OpenTelemetry トレーシングが導入されているが、HTTP レスポンスステータスに基づく Span の StatusCode 設定が行われていなかった。

### 問題点

1. **StatusCode が常に UNSET**: HTTP 5xx エラー時でも Span の StatusCode が UNSET のまま
2. **HTTP Semantic Conventions 属性の不足**: `http.response.status_code` が Span に設定されていない
3. **エラー検出の困難**: トレース分析時に 5xx エラーを容易に識別できない
4. **ヘルスチェックのノイズ**: ヘルスチェックエンドポイントがログに大量出力される

### OTel 仕様

[OpenTelemetry HTTP Semantic Conventions](https://opentelemetry.io/docs/specs/semconv/http/http-spans/) に基づく正しい動作:

| HTTP Status | StatusCode | 備考 |
|-------------|------------|------|
| 1xx, 2xx, 3xx | UNSET | 正常動作 |
| 4xx (サーバー側) | UNSET | クライアントエラー |
| 5xx | **ERROR** | サーバーエラー |

## DECISION MAKING

### アプローチ選定

| 選択肢 | 評価 |
|--------|------|
| 各サービスに個別修正 | × 重複コード、保守性低下 |
| 共通ライブラリ作成 | × Go モジュール管理が複雑化 |
| **同一パターンのミドルウェアを各サービスに配置** | ○ 独立性維持、TDD で品質担保 |

### 実装方針

1. **TDD アプローチ**: テストを先に書き、実装を後から追加
2. **OTel 仕様準拠**: HTTP Semantic Conventions v1.26.0 を使用
3. **ミドルウェア順序**: `otelecho.Middleware` → `OTelStatusMiddleware` → `LoggingMiddleware`
4. **フレームワーク対応**: Echo 用と net/http 用の2種類を実装

### 代替案

1. **otelecho の Fork/PR**: 上流への貢献 → 却下。プロジェクト固有の要件に迅速に対応する必要があった
2. **ClickHouse 側で StatusCode を推論**: クエリで 5xx を検出 → 却下。トレースデータの正規化が複雑化

## RESULTS, EFFECTS

### 新規作成ファイル

```
alt-backend/app/middleware/
├── otel_status_middleware.go
└── otel_status_middleware_test.go

pre-processor/app/middleware/
├── otel_status_middleware.go
└── otel_status_middleware_test.go

auth-hub/middleware/
├── otel_status_middleware.go
└── otel_status_middleware_test.go

search-indexer/app/middleware/
├── otel_status_middleware.go
└── otel_status_middleware_test.go
```

### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `alt-backend/app/main.go` | `OTelStatusMiddleware()` 追加 |
| `pre-processor/app/main.go` | `OTelStatusMiddleware()` 追加 |
| `pre-processor/app/middleware/logging_middleware.go` | ヘルスチェック除外追加 |
| `auth-hub/main.go` | `OTelStatusMiddleware()` + Skipper 追加 |
| `search-indexer/app/main.go` | `OTelStatusHandlerFunc()` でハンドラをラップ |

### ミドルウェア機能

```go
// Echo 用ミドルウェア
func OTelStatusMiddleware() echo.MiddlewareFunc {
    return func(next echo.HandlerFunc) echo.HandlerFunc {
        return func(c echo.Context) error {
            err := next(c)

            span := trace.SpanFromContext(c.Request().Context())
            if !span.SpanContext().IsValid() {
                return err
            }

            status := c.Response().Status
            span.SetAttributes(semconv.HTTPResponseStatusCode(status))

            if status >= 500 {
                span.SetStatus(codes.Error, http.StatusText(status))
                if err != nil {
                    span.RecordError(err)
                }
            }

            return err
        }
    }
}
```

### ヘルスチェック除外

| サービス | 除外パス |
|----------|----------|
| alt-backend | `/v1/health` (既存) |
| pre-processor | `/health`, `/api/v1/health` |
| auth-hub | `/health` |
| search-indexer | N/A（必要に応じて追加可能） |

### テスト結果

| サービス | テスト数 | 結果 |
|----------|---------|------|
| alt-backend | 6 | Pass |
| pre-processor | 5 | Pass |
| auth-hub | 5 | Pass |
| search-indexer | 5 | Pass |

### 期待される Span 属性

```
SpanAttributes:
  http.response.status_code: 500

StatusCode: ERROR (5xx の場合)
StatusMessage: "Internal Server Error"

Events:
  - Name: "exception"
    Attributes:
      exception.type: "*errors.errorString"
      exception.message: "database connection failed"
```

### PROS

1. **OTel 仕様準拠**: HTTP Semantic Conventions に完全準拠
2. **エラー可視性向上**: 5xx エラーがトレースで即座に識別可能
3. **ログノイズ削減**: ヘルスチェックがログから除外
4. **TDD 品質担保**: 全サービスで21テストがパス
5. **独立性維持**: 各サービスが独自にミドルウェアを所有

### CONS, TRADEOFF

1. **コード重複**: 同一パターンが4サービスに存在（Go のモジュール構造上の制約）
2. **保守コスト**: 仕様変更時に4箇所の修正が必要
3. **net/http 用の追加実装**: search-indexer は Echo を使用していないため別実装が必要

## APPENDIX

### 検証方法

```bash
# ビルド
docker compose -f compose/compose.yaml -p alt build alt-backend pre-processor auth-hub search-indexer

# 再起動
docker compose -f compose/compose.yaml -p alt up -d alt-backend pre-processor auth-hub search-indexer

# ヘルスチェック
curl http://localhost:9000/v1/health
curl http://localhost:9200/api/v1/health
curl http://localhost:8888/health
curl http://localhost:9300/health
```

### ClickHouse でのトレース確認

```sql
SELECT
    ServiceName,
    SpanName,
    StatusCode,
    StatusMessage,
    SpanAttributes['http.response.status_code'] as http_status
FROM otel_traces
WHERE Timestamp > now() - INTERVAL 10 MINUTE
  AND StatusCode = 'STATUS_CODE_ERROR'
ORDER BY Timestamp DESC
LIMIT 20;
```

### 参考資料

- [OpenTelemetry HTTP Semantic Conventions](https://opentelemetry.io/docs/specs/semconv/http/http-spans/)
- [OTel Go SDK - Span Status](https://pkg.go.dev/go.opentelemetry.io/otel/codes)
- [otelecho Middleware](https://pkg.go.dev/go.opentelemetry.io/contrib/instrumentation/github.com/labstack/echo/otelecho)
