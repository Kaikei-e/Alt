# SSRFバリデータのURLエンコーディングチェック改善

## ステータス

採択（Accepted）

## コンテキスト

SSRFバリデータがリダイレクト先URLを検証する際、クエリパラメータ内の正当なURLエンコーディングを攻撃として誤検知していた。

### 問題の症状

```
redirect blocked by SSRF policy: URL_ENCODING_BLOCKED: URL encoding attacks not allowed
```

リダイレクトURLのクエリパラメータに含まれる`%3A`（`:`）や`%2F`（`/`）が攻撃パターンとして検出されていた。

### 根本原因

`validatePath`関数がURL文字列全体に対してエンコーディングパターンをチェックしていた：

```go
// 変更前
rawURL := u.String()  // クエリパラメータを含むURL全体
for _, pattern := range suspiciousPatterns {
    if strings.Contains(rawURL, pattern) {  // 全体をチェック
        return &ValidationError{...}
    }
}
```

クエリパラメータ内のURLエンコーディングは正当な用途（リダイレクトURL等）で頻繁に使用されるため、これは過剰な検出であった。

## 決定

### 1. SSRFバリデータ: パス部分のみをチェック

クエリパラメータを除外し、パス部分のみをエンコーディングチェック対象とする。

```go
// 変更後
pathToCheck := u.Path
if u.RawPath != "" {
    pathToCheck = u.RawPath
}
for _, pattern := range suspiciousPatterns {
    if strings.Contains(pathToCheck, pattern) {  // パスのみをチェック
        return &ValidationError{...}
    }
}
```

### 2. URL正規化: 全クエリパラメータを削除

フィードURLの保存時に全クエリパラメータを削除することで、ノイズを排除し一貫性を確保する。

```go
// 変更前: トラッキングパラメータのみ削除
for _, param := range trackingParams {
    query.Del(param)
}
parsedURL.RawQuery = query.Encode()

// 変更後: 全パラメータを削除
parsedURL.RawQuery = ""
```

### 検討した代替案

| 選択肢 | 概要 | 採否 |
|--------|------|------|
| A案: クエリパラメータを除外してチェック | パス部分のみをチェック対象とする | **採用** |
| B案: エンコーディングをデコードしてからチェック | デコード後のパターンを検出 | 不採用（二重エンコーディング攻撃に脆弱） |
| C案: ホワイトリスト方式 | 許可されたドメインのみリダイレクト許可 | 不採用（運用コスト高） |

### A案採用の理由

- OWASPのSSRF防御ガイドラインに沿った実装
- クエリパラメータ内のエンコーディングは正当な用途が多い
- パス部分のみのチェックで攻撃を十分に検出可能
- 最小限の変更でFalse Positiveを解消

## 結果

### 変更されたファイル

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/utils/url_normalizer.go` | 全クエリパラメータを削除 |
| `alt-backend/app/utils/url_normalizer_test.go` | テスト期待値を更新 |
| `alt-backend/app/utils/security/ssrf_validator.go` | パス部分のみエンコーディングチェック |
| `alt-backend/app/utils/security/ssrf_validator_test.go` | クエリパラメータ許可テストを追加 |

### 追加されたエンコーディングパターン

パス部分のチェックで以下のパターンも検出対象に追加：

- `%00` - Null byte injection
- `%0a`, `%0A` - Newline injection
- `%0d`, `%0D` - Carriage return injection

### メリット

1. **誤検知解消**: リダイレクトURLのクエリパラメータが正常に処理される
2. **セキュリティ維持**: パストラバーサル等の攻撃は引き続き検出
3. **URL一貫性**: 全クエリパラメータ削除によりURL重複を防止

### トレードオフ

1. **クエリパラメータ依存フィードへの影響**: 一部のフィードがクエリパラメータに依存している場合、正しく取得できない可能性がある（稀なケース）

## 検証計画

1. **単体テスト**: クエリパラメータ内エンコーディングが許可されることを確認
2. **統合テスト**: リダイレクトを含むrobots.txt取得が成功することを確認

## 実装日

2026-01-10

## 関連

- [OWASP SSRF Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html)
- [Go net/url Package](https://pkg.go.dev/net/url)
