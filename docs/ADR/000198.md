# FeedDetailModal 二重ポータル構造によるリンク遷移不具合の修正

## ADR's STATUS

Accepted

## CONTEXT

`FeedDetailModal` コンポーネントで、記事タイトルの外部リンク (`<a target="_blank">`) をクリックしても新しいタブでページが開かない不具合が発生していた。

### 原因

shadcn-svelte の `Dialog` ラッパーコンポーネントを使用すると、内部で bits-ui の `Dialog.Portal` が自動的に挿入される。モーダルの制御のために外側にもう一つ `Dialog.Portal` を配置する構成にすると、DOM 上にポータルが二重にネストされる状態になる。

```
<Dialog.Root>
  <Dialog.Portal>        ← shadcn wrapper が暗黙的に生成
    <Dialog.Portal>      ← 開発者が明示的に配置
      <Dialog.Overlay />
      <Dialog.Content>
        <a href="..." target="_blank">  ← クリックイベントが到達しない
      </Dialog.Content>
    </Dialog.Portal>
  </Dialog.Portal>
</Dialog.Root>
```

二重ポータル構造により、内側のポータルコンテナに対するイベントバブリングが外側のポータルのイベントハンドラに吸収され、`<a>` タグの `click` イベントがブラウザのデフォルト動作（新しいタブを開く）に到達しない。`pointer-events` の伝搬も二重のオーバーレイ層によって阻害されていた。

## DECISION MAKING

shadcn-svelte の `Dialog` ラッパー (`$lib/components/ui/dialog`) を廃止し、bits-ui の Dialog プリミティブ (`bits-ui` の `Dialog as DialogPrimitive`) を直接使用する構成に変更した。

### 変更方針

1. **単一ポータル構造**: `DialogPrimitive.Root` > `DialogPrimitive.Portal` > `DialogPrimitive.Overlay` + `DialogPrimitive.Content` のフラットな構成に統一
2. **条件付きレンダリング**: `{#if open}` ブロックで `DialogPrimitive.Root` を囲み、`open={true}` を固定値で渡すことで Svelte 側とビュー状態を同期
3. **閉じる操作**: `onOpenChange` コールバックで `open = false` を親コンポーネントに伝搬

### 変更後の構造

```
{#if open}
<DialogPrimitive.Root open={true} onOpenChange={...}>
  <DialogPrimitive.Portal>
    <DialogPrimitive.Overlay />
    <DialogPrimitive.Content>
      <a href="..." target="_blank">  ← 正常にイベントが到達
    </DialogPrimitive.Content>
  </DialogPrimitive.Portal>
</DialogPrimitive.Root>
{/if}
```

## RESULTS, EFFECTS

### PROS

- **外部リンク動作の復旧**: モーダル内の `<a target="_blank">` クリックで新しいタブが正常に開くようになった
- **DOM 構造の簡素化**: ポータルノードが 1 つに削減され、イベントバブリングのパスが明確化
- **bits-ui API の直接利用**: shadcn wrapper を介さないことで、`onOpenChange` や `open` プロパティの挙動を直接制御可能に
- **デバッグ容易性**: DOM インスペクターで確認するポータルノードが 1 つのみになり、問題の切り分けが容易に

### CONS, TRADEOFF

- **shadcn-svelte wrapper との統一性からの逸脱**: プロジェクト内の他のダイアログコンポーネントは shadcn-svelte の `Dialog` を使用しており、`FeedDetailModal` のみ bits-ui プリミティブを直接使用する形になる
- **スタイルの自己管理**: shadcn wrapper が提供するデフォルトスタイル（オーバーレイのアニメーション、コンテンツの配置等）を Tailwind CSS クラスで自前管理する必要がある

## APPENDIX

### 影響ファイル

| ファイル | 変更内容 |
|----------|----------|
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedDetailModal.svelte` | shadcn `Dialog` → bits-ui `DialogPrimitive` への移行。単一ポータル構造に変更 |

### 関連技術

- [bits-ui Dialog](https://www.bits-ui.com/docs/components/dialog) - プリミティブ UI コンポーネント
- [shadcn-svelte Dialog](https://www.shadcn-svelte.com/docs/components/dialog) - bits-ui をラップした上位コンポーネント
