# Trend Stats API のマルチテナント分離漏れの修正

## ステータス

採択（Accepted）

## コンテキスト

### 問題の発生

Trend Charts 画面で以下のエラーが発生していた：

```
GET /sv/api/v1/feeds/stats/trends?window=24h 500 (Internal Server Error)
```

### アーキテクチャ

```
alt-frontend -> alt-butterfly-facade -> alt-backend -> PostgreSQL
                                        (FetchTrendStats)
```

### 原因調査

`fetch_trend_stats_driver.go` においてユーザーコンテキストを取得しているが、SQLクエリで `user_id` フィルターを使用していなかった。

```go
// 修正前: ユーザーIDを取得しているが無視している
_, err := domain.GetUserFromContext(ctx)
```

他のドライバー（`fetch_articles_cursor_driver.go` 等）では正しく `user_id` でフィルタリングしていた：

```sql
WHERE a.user_id = $1
```

マルチテナント対応時にこのドライバーの修正が漏れていたことが原因。

## 決定

`FetchTrendStats` 関数で取得したユーザーIDをSQLクエリに渡し、articles テーブルに対して `user_id` フィルターを追加する。

### 変更内容

1. ユーザーIDの取得と使用

```go
// 修正後: ユーザーIDを取得して使用
user, err := domain.GetUserFromContext(ctx)
// ...
rows, err := r.pool.Query(ctx, query, since, user.UserID)
```

2. SQLクエリへのフィルター追加

```sql
WITH time_buckets AS (
    SELECT date_trunc('%s', a.created_at) AS bucket,
           COUNT(DISTINCT a.id) AS articles,
           COUNT(DISTINCT CASE WHEN a.summarized = true THEN a.id END) AS summarized
    FROM articles a
    WHERE a.created_at >= $1
      AND a.deleted_at IS NULL
      AND a.user_id = $2  -- 追加
    GROUP BY bucket
)
```

## 結果

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/driver/alt_db/fetch_trend_stats_driver.go` | `user_id` フィルターを追加 |
| `alt-backend/app/driver/alt_db/fetch_trend_stats_driver_test.go` | テストを更新 |

### メリット

1. **データ分離**: 各ユーザーは自身の articles のみの統計を取得
2. **一貫性**: 他のドライバーと同様のマルチテナント分離パターンを適用
3. **後方互換**: API のインターフェースに変更なし

### 設計の教訓

マルチテナント対応を行う際は、全てのデータアクセス層を網羅的にレビューする必要がある。特に統計・集計系のクエリは見落としやすい。

## 実装日

2026-01-13

## 関連

- ADR 000085: Connect-RPC Proto パッケージ名の不一致による検索エラーの修正
