# ADR-000266: tag-generator API モード移行に伴うトランザクション管理コードの修正

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000241 Phase 3 で Shared Database アンチパターン解消のため、tag-generator を直接 DB 接続から Connect-RPC API モードに移行した。API モードでは `ConnectArticleFetcher` / `ConnectTagInserter` ドライバが alt-backend 経由でデータアクセスを行い、DB コネクションは不要となる。

`_NullDatabaseManager` が `yield None` を返す設計で、ドライバ層は `conn` パラメータを受け取るが未使用という形で正しく動作していた。

### 問題

しかし、バッチ処理のトランザクション管理コードが API モード未対応のまま残されていた。`conn` を実オブジェクトとして扱う箇所で `AttributeError` が発生し、**7日間タグ生成が完全停止**していた。

```
AttributeError: 'NoneType' object has no attribute 'autocommit'
```

60秒間隔のリトライにより Cycle 12274+ まで到達していたが、毎回同一箇所でクラッシュしていた。

### 最初のクラッシュポイント

```python
# service.py - run_processing_cycle()
with self.database_manager.get_connection() as conn:
    if not conn.autocommit:  # AttributeError: 'NoneType' has no attribute 'autocommit'
        conn.autocommit = True
```

### 影響箇所の分類

| カテゴリ | 箇所数 | 影響 |
|---------|--------|------|
| トランザクション管理（autocommit/commit/rollback） | 19 箇所 | 即時クラッシュ |
| DB 直接クエリ（cursor 操作） | 4 箇所 | try/except でフォールバック済み（機能的には問題なし） |

## 意思決定

### 方針: `conn is None` 時のトランザクション管理スキップ

API モードではトランザクション管理は alt-backend 側の RPC ハンドラが担当するため、クライアント側（tag-generator）での commit/rollback は不要。`conn is not None` ガードを追加し、API モードでは全トランザクション操作をスキップする。

| 選択 | 不採用案 | 理由 |
|------|---------|------|
| `conn is not None` ガード追加 | `_NullDatabaseManager` に stub メソッド追加 | stub はトランザクション管理の意図を隠蔽し、将来の保守性を下げる |
| `conn is not None` ガード追加 | トランザクション管理コード全体を削除 | レガシー DB モードとの互換性を維持する必要がある |

### 修正パターン

3 種類の操作にガードを適用:

```python
# autocommit 設定
if conn is not None and not conn.autocommit:
    conn.autocommit = True

# commit
if conn is not None:
    conn.commit()

# rollback
if conn is not None:
    conn.rollback()
```

## 結果・影響

### 変更ファイル一覧

| ファイル | 変更箇所数 | 変更内容 |
|---------|-----------|---------|
| `tag-generator/app/tag_generator/service.py` | 1 | `run_processing_cycle()` の autocommit チェック |
| `tag-generator/app/tag_generator/batch_processor.py` | 14 | `process_article_batch_forward()`, `process_article_batch_backfill()`, `process_regeneration_batch()` の autocommit/commit/rollback |
| `tag-generator/app/tag_generator/usecase/regenerate_tags.py` | 4 | `RegenerateTagsUsecase.execute()` の autocommit/commit/rollback |

### テスト結果

| テストスイート | 結果 |
|--------------|------|
| `tag-generator/app` 全テスト (`uv run pytest`) | 396 件 全件 PASS |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| コンテナ再ビルド (`--build tag-generator`) | ビルド成功 |
| コンテナ起動 | Started |
| API モード初期化 (`Using backend API mode`) | 確認済み |
| DB connection acquired | `AttributeError` なし |
| 記事取得 (`Fetched articles article_count=75`) | Connect-RPC 経由で正常動作 |
| バッチ処理開始 (`Processing batch article_count=75`) | 正常開始 |
| cursor_manager フォールバック | 想定通り現在時刻にフォールバック（warning ログのみ） |

### PROS

- 7日間停止していたタグ生成パイプラインが復旧
- レガシー DB モードとの後方互換性を維持（DB 接続時は従来通りトランザクション管理が動作）
- 修正が最小限（ガード追加のみ）でロジック変更なし
- cursor_manager の DB 直接クエリは既存の try/except フォールバックで対応済みのため修正不要

### CONS, TRADEOFF

- `conn is not None` ガードが 19 箇所に分散しており、将来的にトランザクション管理コードを追加する際に同じガードを忘れるリスクがある
- レガシー DB モードのコードパスがそのまま残るため、完全な API モード移行後にはデッドコードとなる。ADR-000241 の最終フェーズでの削除を推奨

### 影響範囲

- **tag-generator**: バッチ処理・トランザクション管理の 3 ファイルのみ
- **alt-backend**: 変更なし（RPC ハンドラ側のトランザクション管理はそのまま）
- **他サービス**: 変更なし

## 付録

### API モードのデータフロー

```
tag-generator                          alt-backend
┌────────────────────┐                ┌─────────────────────┐
│ BatchProcessor     │                │ Connect-RPC Handler │
│                    │                │                     │
│ conn = None        │                │ DB Transaction      │
│ (NullDBManager)    │                │ ┌─────────────────┐ │
│                    │  Connect-RPC   │ │ BEGIN            │ │
│ article_fetcher ───┼───────────────→│ │ SELECT articles  │ │
│ .fetch_articles()  │                │ │ COMMIT           │ │
│                    │                │ └─────────────────┘ │
│                    │  Connect-RPC   │ ┌─────────────────┐ │
│ tag_inserter ──────┼───────────────→│ │ BEGIN            │ │
│ .batch_upsert()    │                │ │ UPSERT tags      │ │
│                    │                │ │ COMMIT           │ │
│ conn.commit() ──X  │  (skipped)    │ └─────────────────┘ │
│ conn.rollback()─X  │  (skipped)    │                     │
└────────────────────┘                └─────────────────────┘
```

## 関連 ADR

- ADR-000241: Shared Database アンチパターン解消（Connect-RPC API モード移行）
