# TraceID/SpanID ログ出力問題の包括的修正（Phase 2）

## ADR's STATUS

Accepted

## CONTEXT

### 背景

ADR-134 で pre-processor/main.go と search-indexer/rest/handler.go の TraceID/SpanID 問題を修正したが、調査の結果、他のレイヤーにも同様の問題が多数存在することが判明した。

### 調査結果

| サービス | レイヤー | 問題箇所数 |
|----------|----------|-----------|
| alt-backend | Connect-RPC handlers | ~45 |
| pre-processor | Handler Layer | ~82 |
| pre-processor | Service Layer | ~88 |
| pre-processor | Repository Layer | ~90 |
| pre-processor | Connect-RPC Layer | ~17 |
| **合計** | - | **~322** |

### 根本原因

Go の `log/slog` パッケージにおいて、`logger.Info()` は内部で `context.Background()` を使用するため、OpenTelemetry のスパン情報（TraceID/SpanID）を取得できない。HTTP ハンドラや RPC ハンドラ内では、リクエストコンテキストを含む `logger.InfoContext(ctx, ...)` を使用する必要がある。

## DECISION MAKING

### 修正方針

1. HTTP/Connect-RPC ハンドラ内のすべてのログ呼び出しを context-aware バージョンに変更
2. Service/Repository レイヤーでも `ctx context.Context` パラメータがあるメソッドは context-aware ログを使用
3. バックグラウンドジョブなど HTTP コンテキスト外のログは対象外（TraceID がないのは正常な動作）

### 変更パターン

```go
// Before
h.logger.Info("message", "key", value)
h.logger.Error("error occurred", "error", err)
h.logger.Warn("warning", "detail", detail)
h.logger.Debug("debug info", "data", data)

// After
h.logger.InfoContext(ctx, "message", "key", value)
h.logger.ErrorContext(ctx, "error occurred", "error", err)
h.logger.WarnContext(ctx, "warning", "detail", detail)
h.logger.DebugContext(ctx, "debug info", "data", data)
```

### Error Handler の変更

Connect-RPC の共通エラーハンドラは関数シグネチャも変更が必要だった:

```go
// Before
func HandleInternalError(logger *slog.Logger, err error, operation string) *connect.Error

// After
func HandleInternalError(ctx context.Context, logger *slog.Logger, err error, operation string) *connect.Error
```

## RESULTS, EFFECTS

### 変更ファイル一覧

#### alt-backend

| ファイル | 変更内容 |
|----------|----------|
| `connect/errorhandler/error_handler.go` | 全関数に `ctx` パラメータ追加 |
| `connect/v2/feeds/handler.go` | ~22 箇所の logging 修正 |
| `connect/v2/morning_letter/handler.go` | 5 箇所の logging 修正 |
| `connect/v2/augur/handler.go` | 10 箇所の logging 修正 |
| `connect/v2/recap/handler.go` | 2 箇所の logging 修正 |
| `connect/v2/rss/handler.go` | 4 箇所の logging 修正 |
| `connect/v2/articles/handler.go` | 4 箇所の logging 修正 |

#### pre-processor

| レイヤー | ファイル | 変更箇所数 |
|----------|----------|-----------|
| Handler | `handler/summarize_handler.go` | 24 |
| Handler | `handler/health_handler.go` | 14 |
| Handler | `handler/job_handler.go` | 30 |
| Handler | `handler/job_scheduler.go` | 11 |
| Handler | `handlers/pagination.go` | 3 |
| Service | `service/article_summarizer.go` | 15 |
| Service | `service/summarize_queue_worker.go` | 21 |
| Service | `service/article_fetcher.go` | 1 |
| Service | `service/article_sync_service.go` | 10 |
| Service | `service/quality_checker.go` | 16 |
| Service | `service/health_checker.go` | 11 |
| Service | `service/user_sync_service.go` | 12 |
| Service | `service/feed_processor.go` | 4 |
| Service | `service/feed_processor_enhanced.go` | 10 |
| Repository | `repository/article_repository.go` | 22 |
| Repository | `repository/summarize_job_repository.go` | 24 |
| Repository | `repository/feed_repository.go` | 6 |
| Repository | `repository/summary_repository.go` | 16 |
| Repository | `repository/external_api_repository.go` | 22 |
| Connect-RPC | `connect/v2/preprocessor/handler.go` | 17 |

### 検証結果

修正後のログ出力例（pre-processor）:

```json
{
  "time": "2026-01-21T05:00:08.054Z",
  "level": "info",
  "msg": "HTTP request completed",
  "method": "GET",
  "uri": "/api/v1/health",
  "status": 200,
  "trace_id": "44b1b185851cd7155ef8e0188575fd45",
  "span_id": "cbcdc3b145969d6f"
}
```

### PROS

1. **包括的な修正**: 全レイヤーで一貫した TraceID/SpanID 出力
2. **デバッグ効率向上**: 分散システム全体でリクエストを追跡可能
3. **Grafana 可視性**: TraceID でのログフィルタリングがより効果的に

### CONS, TRADEOFF

1. **コード変更量**: 約 322 箇所の変更が必要だった
2. **バックグラウンドジョブ**: HTTP コンテキスト外では引き続き TraceID なし（正常な動作）
3. **関数シグネチャ変更**: Error Handler の変更により呼び出し元も修正が必要

## APPENDIX

### 検証コマンド

```bash
# コンテナ再ビルド・再起動
docker compose -f compose/compose.yaml -p alt up -d --build alt-backend pre-processor

# リクエスト発行
curl http://localhost:9000/v1/health
curl http://localhost:9200/api/v1/health

# ログ確認
docker compose -f compose/compose.yaml -p alt logs alt-backend --tail=30 | grep trace_id
docker compose -f compose/compose.yaml -p alt logs pre-processor --tail=30 | grep trace_id
```

### 参考資料

- [ADR-134: TraceID/SpanID がログに出力されない問題の修正](./000134.md)
- [GitHub Issue #6114 - TraceID and SpanID are both "00000...." in otel log export](https://github.com/open-telemetry/opentelemetry-go/issues/6114)
- [Go slog Package - InfoContext](https://pkg.go.dev/log/slog#Logger.InfoContext)
- [OpenTelemetry Go - trace package](https://pkg.go.dev/go.opentelemetry.io/otel/trace)
