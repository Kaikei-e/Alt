# ADR-000306: GetArticleContentResponse に user_id フィールドを追加し要約保存パイプラインを復旧

## ADR's STATUS

Accepted

## CONTEXT

要約保存パイプラインのキューワーカーパスが完全に停止していた。直近6時間で 287件の `SaveArticleSummary: invalid_argument: user_id is required` エラーが発生し、成功した要約保存は 0件。LLM トークンを消費して要約を生成しているにもかかわらず、全て破棄されていた。

### 根本原因

`GetArticleContentResponse` proto メッセージに `user_id` フィールドが存在しなかった。キューワーカーが `GetArticleContent` RPC で記事を取得した際、`user_id` が空文字列のまま `ArticleSummary` を構築し、`SaveArticleSummary` が `user_id is required` バリデーションで拒否していた。

```
SummarizeQueueWorker.processJob()
  → articleRepo.FindByID(articleID)
    → GetArticleContent RPC (proto に user_id なし)
      → domain.Article{UserID: ""} (空)
  → ArticleSummary{UserID: ""} を生成
  → SaveArticleSummary → "user_id is required" エラー
  → ログに記録して continue → ジョブは "completed" 扱い
```

一方、`ListUnsummarizedArticles` のバッチパスには `UnsummarizedArticle` proto に `user_id` (field 6) が最初から定義されていたため正常動作していた。問題はキューワーカーパスのみに限定されていた。

## DECISION MAKING

### 方針: proto メッセージに `user_id` フィールドを追加し、全レイヤーで伝搬させる

Clean Architecture の各レイヤー (Driver → Port → Gateway → Handler) に `user_id` を追加する。

| 項目 | 決定 | 理由 |
|------|------|------|
| proto フィールド番号 | field 5 | 既存の field 1-4 (article_id, title, content, url) に続く自然な番号 |
| 変更範囲 | alt-backend (サーバー) + pre-processor (クライアント) | エンドツーエンドで `user_id` を伝搬させる必要がある |
| SQL 変更 | `SELECT` に `user_id` カラムを追加 | `articles` テーブルには `user_id` が既に存在する |
| 後方互換性 | protobuf の additive change | 既存クライアントは新フィールドを無視するだけで破壊的変更なし |

### 他の選択肢を採用しなかった理由

- **キューワーカー側で別途 `user_id` を取得**: 追加の RPC 呼び出しが必要になり、レイテンシとコードの複雑性が増加する
- **`SaveArticleSummary` のバリデーション緩和**: `user_id` は記事と要約の所有者紐づけに必須であり、バリデーション除去はデータ整合性を損なう

## RESULTS, EFFECTS

### PROS

- `user_id is required` エラーが解消され、キューワーカーパスの要約保存が正常に動作する
- 既に `ListUnsummarizedArticles` で使用されている `UnsummarizedArticle.user_id` と一貫したデータモデルになる
- protobuf の additive change であり、後方互換性が維持される
- LLM トークンの無駄な消費が解消される

### CONS, TRADEOFF

- proto の重複定義（`services/backend/v1` と `clients/*/v1` で同じメッセージを3箇所管理）が存在するため、変更箇所が多い。proto の構成見直しは別途検討が必要

## APPENDIX

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `proto/services/backend/v1/internal.proto` | `GetArticleContentResponse` に `string user_id = 5` 追加 |
| 2 | `proto/clients/preprocessor-backend/v1/internal.proto` | 同上 |
| 3 | `proto/clients/backend/v1/internal.proto` | 同上 |
| 4 | `alt-backend/app/driver/alt_db/get_article_content_driver.go` | struct + SQL + Scan に `UserID` 追加 |
| 5 | `alt-backend/app/port/internal_article_port/port.go` | `ArticleContent` に `UserID` 追加 |
| 6 | `alt-backend/app/gateway/internal_article_gateway/gateway.go` | Driver → Port の mapping に `UserID` 追加 |
| 7 | `alt-backend/app/connect/v2/internal/handler.go` | レスポンスに `UserId` 追加 |
| 8 | `pre-processor/app/driver/backend_api/article_driver.go` | Proto → Domain の mapping に `UserID` 追加 |

### テスト

| # | テスト | 結果 |
|---|--------|------|
| 1 | `alt-backend/app/connect/v2/internal/handler_test.go` に `UserId` アサーション追加 | PASS |
| 2 | `alt-backend`: `go test ./...` | 全テスト PASS |
| 3 | `pre-processor`: `go test ./...` | 関連テスト全て PASS |

### 検証結果

- コンテナ再ビルド・起動: 正常
- ヘルスチェック: `{"database":"connected","status":"healthy"}`
- `user_id is required` エラー: 0件
- 要約キューワーカー: 正常にジョブをキューイング・処理中
