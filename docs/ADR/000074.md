# Grafana ダッシュボード "No Data" 問題の調査と修正

## ステータス

採択（Accepted）

## コンテキスト

Grafana の以下4つのダッシュボードでデータが表示されない問題が発生した：

- Nginx Logs
- Nginx Metrics
- OTel Logs Overview
- OTel Trace Explorer

### データフローアーキテクチャ

```
[Nginx Metrics]
  nginx → nginx-exporter:9113 → Prometheus:9090 → Grafana (DS_PROMETHEUS)

[Nginx Logs]
  nginx → rask-log-forwarder → rask-log-aggregator:9600 → ClickHouse (http_logs) → Grafana (DS_CLICKHOUSE)

[OTel Logs/Traces]
  Services → OTEL SDK → rask-log-aggregator:9600 → ClickHouse (otel_logs/otel_traces) → Grafana (DS_CLICKHOUSE)
```

## 決定

### 発見された問題と修正

調査の結果、複数の問題が連鎖していることが判明した。

#### 問題1: ClickHouse マイグレーション未適用

**症状**: `otel_logs`, `otel_traces`, `http_logs` テーブルが存在しない

**原因**: ClickHouse コンテナが初回起動後にマイグレーションを実行していなかった

**修正**: コンテナ再起動によりマイグレーションを適用

```bash
docker compose restart clickhouse
```

#### 問題2: Grafana データソースのプロビジョニング失敗

**症状**: ClickHouse データソースの UID が期待値と異なり、Prometheus データソースが欠落

**原因**: Grafana 初回起動時のプロビジョニングが不完全

**修正**: Grafana コンテナ再起動

```bash
docker compose restart grafana
```

#### 問題3: OTEL 環境変数の欠落

**症状**: サービスが OTEL データを送信していない

**原因**: `.env` に `OTEL_EXPORTER_OTLP_ENDPOINT` が設定されていなかった

**修正**: `.env` に以下を追加

```bash
OTEL_EXPORTER_OTLP_ENDPOINT=http://rask-log-aggregator:9600
OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
DEPLOYMENT_ENV=development
```

#### 問題4: ClickHouse スキーマと Rust 型の不整合（重要）

**症状**: `Code: 33. DB::Exception: Cannot read all data. Bytes read: 1. Bytes expected: 109`

**原因**: rask-log-aggregator の Rust 構造体がClickHouse スキーマと一致していなかった

| カラム | ClickHouse 型 | 修正前の Rust 型 | 修正後の Rust 型 |
|--------|--------------|----------------|----------------|
| TraceId | FixedString(32) | String | [u8; 32] |
| SpanId | FixedString(16) | String | [u8; 16] |
| ParentSpanId | FixedString(16) | String | [u8; 16] |
| Timestamp | DateTime64(9) | u64 | i64 |
| SpanKind | Enum8 | String | i8 |
| StatusCode | Enum8 | String | i8 |

**技術的詳細**:

ClickHouse の `clickhouse-rs` クレートは RowBinary フォーマットを使用する。このフォーマットでは：

- `String` 型: 可変長プレフィックス付きでシリアライズされる
- `FixedString(N)`: 固定 N バイトとしてシリアライズされる

Rust の `String` を `FixedString(32)` カラムに挿入すると、長さプレフィックスが余分に書き込まれ、バイト数不一致でエラーになる。

**修正**: `clickhouse_exporter.rs` の型定義を変更

```rust
#[derive(clickhouse::Row, Serialize, Deserialize, Clone, Debug)]
pub struct OTelLogRow {
    #[serde(rename = "Timestamp")]
    pub timestamp: i64,  // DateTime64(9) - nanoseconds since epoch
    #[serde(rename = "TraceId")]
    pub trace_id: [u8; 32],  // FixedString(32)
    #[serde(rename = "SpanId")]
    pub span_id: [u8; 16],   // FixedString(16)
    // ...
}

#[derive(clickhouse::Row, Serialize, Deserialize, Clone, Debug)]
pub struct OTelTraceRow {
    #[serde(rename = "SpanKind")]
    pub span_kind: i8,  // Enum8 as numeric value
    #[serde(rename = "StatusCode")]
    pub status_code: i8,  // Enum8 as numeric value
    // ...
}

/// Convert string to fixed-size byte array for FixedString columns
fn string_to_fixed_bytes<const N: usize>(s: &str) -> [u8; N] {
    let mut result = [0u8; N];
    let bytes = s.as_bytes();
    let len = bytes.len().min(N);
    result[..len].copy_from_slice(&bytes[..len]);
    result
}
```

## 結果

### 変更されたファイル

| カテゴリ | ファイル | 変更内容 |
|---------|---------|---------|
| **rask-log-aggregator** | | |
| | `src/log_exporter/clickhouse_exporter.rs` | OTelLogRow, OTelTraceRow の型修正、`string_to_fixed_bytes` 追加 |
| **環境設定** | | |
| | `.env` | OTEL_EXPORTER_OTLP_ENDPOINT 追加 |

### 修正後のデータ確認

```sql
SELECT 'otel_logs' as tbl, count() FROM otel_logs
UNION ALL
SELECT 'otel_traces', count() FROM otel_traces
UNION ALL
SELECT 'http_logs', count() FROM http_logs;

-- 結果:
-- otel_logs   950
-- otel_traces 9
-- http_logs   26
```

### メリット

1. **Grafana ダッシュボード正常化**: 4つのダッシュボードすべてでデータ表示が可能に
2. **OpenTelemetry 対応完了**: alt-backend からのトレース・ログが ClickHouse に格納される
3. **型安全性向上**: Rust 構造体と ClickHouse スキーマの整合性を確保

### トレードオフ

1. **手動変換が必要**: TraceId/SpanId を表示用に hex 文字列に戻す処理が必要な場合がある
2. **マイグレーション依存**: ClickHouse コンテナ再起動でマイグレーションが実行される設計への依存

## 学んだこと

1. **ClickHouse RowBinary の型厳密性**: Rust 型と ClickHouse 型は 1:1 で対応させる必要がある
2. **FixedString vs String**: 固定長カラムには固定長バイト配列を使用する
3. **Enum8 のシリアライズ**: 文字列ではなく数値としてシリアライズされる
4. **エラーメッセージの読み方**: `Bytes read: X. Bytes expected: Y` は型不整合を示唆する

## 実装日

2026-01-10

## 関連

- [ClickHouse RowBinary Format](https://clickhouse.com/docs/en/interfaces/formats#rowbinary)
- [clickhouse-rs crate](https://crates.io/crates/clickhouse)
- [OpenTelemetry Rust SDK](https://opentelemetry.io/docs/languages/rust/)
