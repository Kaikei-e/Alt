# ADR-000256: フィードソース除外フィルタ (Feeds ページ)

## ステータス

承認済み

## コンテキスト

### 背景

Feeds ページ (`/desktop/feeds`) には Unread Only トグルとソート機能があるが、特定のフィードソースを除外する手段がなかった。購読ソースが多い場合、特定ドメインの記事が大量に表示され、他のソースの記事が埋もれてしまう問題があった。

### 要件

- ユーザーがフィードソース URL の部分一致でオートコンプリート検索し、1 つのソースを除外できる
- 除外中はチップ表示で視覚的にフィードバック、ワンクリックで解除可能
- 既存の Unread Only / Sort フィルタとの組み合わせが正しく動作する
- v1 では単一ソース除外のみ（将来的に複数除外への拡張を妨げない設計）

### パフォーマンス検証

除外フィルタの SQL 実装方式を `EXPLAIN ANALYZE` で比較検証した。

| アプローチ | 実行時間 | 備考 |
|---|---|---|
| ベースライン（除外なし） | 1.9ms | |
| `NOT IN` (サブクエリ) | 131.5ms | 全行フルスキャン — 不採用 |
| `NOT EXISTS` (Anti Join) | 0.5ms | 最速だがクエリ結合が複雑 |
| UUID 直接指定 (`!= $N`) | 1.6ms | クリーンで十分高速 |

## 意思決定

### SQL 方式: UUID 直接指定

`NOT EXISTS` が最速だが、既存のカーソルベースクエリとの結合が複雑になる。UUID 直接指定（`AND f.feed_link_id != $N`）は 1.6ms と十分高速で、既存クエリ構造を維持しやすいため採用した。

ドライバ層で `excludeFeedLinkID` が非 nil の場合のみ条件を追加する動的クエリ構築とした。

```go
excludeClause := ""
if excludeFeedLinkID != nil {
    excludeClause = fmt.Sprintf("AND f.feed_link_id != $%d", len(args)+1)
    args = append(args, *excludeFeedLinkID)
}
```

### Proto Schema 拡張

`GetUnreadFeedsRequest` と `GetAllFeedsRequest` に `optional string exclude_feed_link_id` フィールドを追加。optional フィールドのため後方互換性を維持。

```protobuf
message GetUnreadFeedsRequest {
  optional string cursor = 1;
  int32 limit = 2;
  optional string view = 3;
  optional string exclude_feed_link_id = 4;  // NEW
}

message GetAllFeedsRequest {
  optional string cursor = 1;
  int32 limit = 2;
  optional string exclude_feed_link_id = 3;  // NEW
}
```

### バックエンド: Clean Architecture 各層の変更

Handler 層で UUID パースとバリデーションを行い、各層には `*uuid.UUID` として透過的に渡す。

```
Handler (UUID パース) → Usecase → Port → Gateway → Driver (SQL 条件追加)
```

REST ハンドラには `nil` を渡し、既存 REST API の後方互換性を維持。

### フロントエンド: オートコンプリートコンポーネント

`FeedSourceExcludeFilter.svelte` を新規作成。

- `feed_links` テーブルは約 75 件のため、サーバーサイド検索不要。`listSubscriptionsClient()` で全件取得し、クライアントサイドで URL 部分一致フィルタリング
- ARIA combobox パターン（`role="combobox"`, `aria-expanded`, `aria-activedescendant`）
- キーボードナビゲーション: ArrowDown/Up, Enter, Escape
- 選択後はドメイン名チップ表示 + X ボタンで解除
- Alt Design Language 準拠（0 border-radius, CSS variables）

### フロントエンド: フィルタ連携

FeedGrid の `filterKey` に `excludedFeedLinkId` を含め、変更時にサーバーからリロード。ソート変更はクライアントサイドのみで処理する既存パターンを踏襲。

```typescript
const filterKey = `${unreadOnly}:${sortBy}:${excludedFeedLinkId ?? ''}`;
```

### 検討した代替案

| 案 | 不採用理由 |
|---|-----------|
| `NOT IN` サブクエリ | 131ms — パフォーマンス不可 |
| `NOT EXISTS` Anti Join | 最速だが既存カーソルクエリとの結合が複雑、可読性低下 |
| クライアントサイドのみで除外 | ページネーション（カーソル）と併用不可。除外対象が含まれるページ分だけ表示件数が減る |
| サーバーサイドオートコンプリート API | feed_links は 75 件程度で API 追加のオーバーヘッドに見合わない |

## 結果・影響

### 変更ファイル一覧

**Proto:**

| ファイル | 変更内容 |
|---------|---------|
| `proto/alt/feeds/v2/feeds.proto` | `exclude_feed_link_id` optional フィールド追加 |

**バックエンド (Go):**

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/driver/alt_db/fetch_feed_driver.go` | SQL に除外条件を動的追加 |
| `alt-backend/app/port/fetch_feed_port/fetch_port.go` | インターフェースに `excludeFeedLinkID *uuid.UUID` 追加 |
| `alt-backend/app/gateway/fetch_feed_gateway/feeds_gateway.go` | パラメータ透過 |
| `alt-backend/app/usecase/fetch_feed_usecase/feeds_list_cursor_usecase.go` | パラメータ透過 |
| `alt-backend/app/usecase/fetch_feed_usecase/fetch_unread_feeds_cursor_usecase.go` | パラメータ透過 |
| `alt-backend/app/connect/v2/feeds/handler.go` | UUID パース・バリデーション |
| `alt-backend/app/rest/rest_feeds/fetch.go` | 既存呼び出しに `nil` 追加（後方互換） |

**フロントエンド (SvelteKit):**

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/src/lib/connect/feeds/listing.ts` | Connect-RPC クライアントにパラメータ追加 |
| `alt-frontend-sv/src/lib/api/client/feeds.ts` | API クライアントにパラメータ追加 |
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedFilters.svelte` | Props 拡張、除外 UI 組み込み |
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedGrid.svelte` | `excludedFeedLinkId` prop、リロード制御 |
| `alt-frontend-sv/src/routes/desktop/feeds/+page.svelte` | feed sources ロード、フィルタ state 拡張 |

**新規作成:**

| ファイル | 目的 |
|---------|------|
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedSourceExcludeFilter.svelte` | オートコンプリート除外コンポーネント |
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedSourceExcludeFilter.spec.ts` | フィルタロジックテスト (10 cases) |

**自動生成 (`make buf-generate` / `make generate-mocks`):**

| ファイル |
|---------|
| `alt-backend/app/gen/proto/alt/feeds/v2/feeds.pb.go` |
| `alt-frontend-sv/src/lib/gen/alt/feeds/v2/feeds_pb.ts` |
| `alt-backend/app/mocks/mock_fetch_feed_port.go` |

**テスト更新:**

| ファイル |
|---------|
| `alt-backend/app/gateway/fetch_feed_gateway/feeds_cursor_gateway_test.go` |
| `alt-backend/app/usecase/fetch_feed_usecase/feeds_list_cursor_usecase_test.go` |
| `alt-backend/app/usecase/fetch_feed_usecase/fetch_unread_feeds_cursor_usecase_test.go` |

### テスト結果

- バックエンド: `go test ./usecase/fetch_feed_usecase/... ./gateway/fetch_feed_gateway/... ./connect/v2/feeds/...` — 全パス
- フロントエンド: `FeedSourceExcludeFilter.spec.ts` — 10/10 パス
- コンテナビルド・起動: alt-backend, alt-frontend-sv, alt-butterfly-facade 全て healthy

### PROS

- 特定ソースの記事を一時的に除外でき、多ソース購読時のブラウジング体験が向上
- サーバーサイド除外のため、カーソルベースページネーションと正しく連携（表示件数が安定）
- UUID 直接指定方式により、ベースラインから +0.3ms 以内の追加コスト
- ARIA combobox パターンによるアクセシビリティ対応
- optional proto フィールドにより完全な後方互換性を維持

### CONS, TRADEOFF

- v1 は単一ソース除外のみ（複数除外は `repeated string` への拡張が必要）
- フィードソース一覧をページ読み込み時に全件取得（75 件程度のため問題なし、ソース数が大幅に増加した場合は再検討）
- REST API は除外パラメータ未対応（`nil` 固定）。Connect-RPC 経由のみサポート

### 影響範囲

- **alt-backend**: Connect-RPC の `GetUnreadFeeds` / `GetAllFeeds` に optional パラメータ追加。REST API は変更なし
- **alt-frontend-sv**: Feeds ページのフィルタバーに UI 追加。他ページへの影響なし
- **alt-butterfly-facade**: proto 変更に伴い再ビルドが必要（透過プロキシのため実装変更なし）
- **データベース**: スキーマ変更なし。既存インデックスで対応可能

## 関連 ADR

- ADR-000255: K6 ロードテスト導入 (alt-perf)
