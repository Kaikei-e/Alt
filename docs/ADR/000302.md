# ADR-000302: articles テーブルへの published_at カラム追加

## ADR's STATUS

Accepted

## CONTEXT

Connect-RPC の `CreateArticle` ハンドラ（pre-processor → alt-backend）が以下のエラーで失敗していた。

```
column "published_at" of relation "articles" does not exist (SQLSTATE 42703)
```

### 原因

`create_article_driver.go` の INSERT 文が `published_at` カラムを参照しているが、対応する DB マイグレーションが存在しなかった。アプリケーションコードは handler → port → gateway → driver の全レイヤーで `PublishedAt` フィールドを実装済みであり、DB スキーマだけが追いついていない状態だった。

### 背景

RSS フィードから取得した記事の**元の公開日時**を保存するために `PublishedAt` フィールドがコードに追加されたが、スキーマ変更が漏れていた。`created_at`（DB 保存日時）とは意味が異なり、記事の時系列表示やフィルタリングに必要なカラムである。

## DECISION MAKING

`articles` テーブルに `published_at TIMESTAMPTZ` カラムを追加するマイグレーションを作成する。

```sql
ALTER TABLE articles ADD COLUMN published_at TIMESTAMPTZ;
COMMENT ON COLUMN articles.published_at IS 'Original publication timestamp from RSS feed source';
```

### 設計判断

| 項目 | 決定 | 理由 |
|------|------|------|
| データ型 | `TIMESTAMPTZ` | `inoreader_articles.published_at` と同じ型で統一 |
| NULL 許容 | NULL 可 | 既存行に値がなく、`SaveArticle` パスは `published_at` を使わない |
| デフォルト値 | なし | `created_at`（DB 保存日時）とは意味が異なるため、暗黙のフォールバックは不適切 |
| NOT NULL 制約 | なし | 後方互換性の維持。既存の `SaveArticle` ドライバーはこのカラムを INSERT しない |

### 他の選択肢を採用しなかった理由

- **`DEFAULT NOW()` を設定**: `published_at` は記事の公開日であり、DB 挿入時刻ではない。デフォルト値を設定すると誤ったデータが入る
- **`NOT NULL` 制約を追加**: 既存行と `SaveArticle` パスで NULL が必要。将来的にデータが充足した段階で制約追加を検討可能
- **`TIMESTAMP`（タイムゾーンなし）**: RSS フィードは複数タイムゾーンのソースを含むため、`TIMESTAMPTZ` が適切

## RESULTS, EFFECTS

### PROS

- **CreateArticle エラーの解消**: pre-processor → alt-backend の記事同期パイプラインが正常に動作するようになった
- **既存データへの影響なし**: NULL 許容のため、既存行はそのまま保持される
- **型の一貫性**: `inoreader_articles.published_at` と同じ `TIMESTAMPTZ` 型で統一
- **将来の機能基盤**: 記事の時系列ソート・フィルタリング機能の基盤となる

### CONS, TRADEOFF

- NULL 許容のため、クエリ時に `COALESCE` や `IS NOT NULL` フィルタが必要になる場合がある
- インデックスは未追加。クエリパターンが確定した段階で別途検討する

## APPENDIX

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `migrations-atlas/migrations/20260228000000_add_published_at_to_articles.sql` | 新規作成: `ALTER TABLE articles ADD COLUMN published_at TIMESTAMPTZ` |
| 2 | `migrations-atlas/migrations/atlas.sum` | `atlas migrate hash` で自動更新 |

### 検証結果

- マイグレーション適用: Atlas により 1 migration / 2 SQL statements が正常適用（所要 1.7ms）
- カラム確認: `information_schema.columns` で `published_at` (`timestamp with time zone`) の存在を確認
- alt-backend ヘルスチェック: `healthy` 状態

### 関連 ADR

- ADR-000299: `GetFeedIDByURL` のクエリ対象変更
- ADR-000300: `feed_links.id` と `feeds.id` の混同修正
- ADR-000301: `GetFeedIDByURL` の二重用途バグ修正
