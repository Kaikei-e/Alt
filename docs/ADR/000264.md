# ADR-000264: Summary Request FIFO→LIFO — Swipe Feed 体感レイテンシ最適化

## ステータス

承認済み

## コンテキスト

### 背景

モバイルの Swipe Feed UI では、ユーザーが記事 A→B→C とスワイプしながら各記事の「Summary」ボタンを押す操作が頻繁に発生する。従来の FIFO（First-In-First-Out）処理では、最初にリクエストされた A の要約が先に生成され、ユーザーが現在閲覧中の C の要約は最後に処理される。

これにより、ユーザーが最も関心のある「今見ている記事」の要約が最も遅く返る逆転現象が起きていた。

### 問題の構造

```
ユーザー操作:  A で Summary → B にスワイプ → B で Summary → C にスワイプ → C で Summary
FIFO 処理順:  A → B → C  （ユーザーは C を見ているのに A から処理）
理想の処理順:  C → B → A  （ユーザーが今見ている C を最優先）
```

### 影響範囲

| レイヤー | コンポーネント | 役割 |
|---------|--------------|------|
| Frontend | `SwipeFeedCard.svelte` | ストリーミング要約の AbortController |
| Backend (Python) | `HybridPrioritySemaphore` | RT キューの LIFO スケジューリング |
| Backend (Go) | `summarize_job_repository` | 非同期ジョブキューの LIFO 取得 |
| Deploy | `compose/ai.yaml` | 環境変数によるモード切替 |

## 意思決定

2 つの補完的アプローチを同時に適用する。

### アプローチ 1: Frontend — スワイプ離脱時の即時キャンセル

| 選択 | 不採用案 | 理由 |
|------|---------|------|
| `AbortController` + `$effect` cleanup | タイムアウトベースのキャンセル | スワイプ即離脱を検知できない。無駄な LLM スロット消費が残る |
| `AbortController` + `$effect` cleanup | キャンセルなし（LIFO のみ） | LLM スロットが無駄に占有され、後続リクエストの待ち時間が増加 |

`SwipeFeedCard` は `{#key activeFeed.id}` により毎スワイプで destroy/recreate される。Svelte 5 の `$effect` cleanup はコンポーネント破棄時に実行されるため、`AbortController.abort()` を cleanup に配置するだけで「スワイプ離脱 = 即キャンセル」が自然に実現できる。

既存の `streamSummarizeWithAbortAdapter()` が `AbortController` を返す API を提供しており、新規 API の追加は不要。

### アプローチ 2: Backend — キューの LIFO 化

| 選択 | 不採用案 | 理由 |
|------|---------|------|
| `heapq` の enqueue_time 符号反転 | 専用の LIFO データ構造 | 既存の min-heap を流用でき、変更が最小限 |
| 環境変数 `SCHEDULING_RT_MODE` で切替 | ハードコード | FIFO へのロールバックが即座に可能 |

**仕組み**: Python の `heapq` は min-heap。enqueue_time を負数にすることで、最新のリクエスト（最大のタイムスタンプ → 最小の負数）が最初に pop される。BE キューには影響しない（RT キューのみ LIFO 化）。

pre-processor 側の非同期ジョブキューも `ORDER BY created_at DESC` に変更し、DB キューレベルでも LIFO を適用。

## 結果・影響

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `news-creator/app/news_creator/config/config.py` | `scheduling_rt_mode` 設定追加（env: `SCHEDULING_RT_MODE`、default: `"fifo"`） |
| `news-creator/app/news_creator/gateway/hybrid_priority_semaphore.py` | `rt_scheduling_mode` パラメータ追加、LIFO 時に enqueue_time を負数化 |
| `news-creator/app/news_creator/gateway/ollama_gateway.py` | セマフォコンストラクタに `rt_scheduling_mode` を渡す |
| `news-creator/app/tests/gateway/test_hybrid_priority_semaphore.py` | LIFO テスト 6 件追加 |
| `pre-processor/app/repository/summarize_job_repository.go` | `ORDER BY created_at ASC` → `DESC` |
| `pre-processor/app/repository/summarize_job_repository_test.go` | LIFO 順序のドキュメントコメント追加 |
| `alt-frontend-sv/.../swipe/SwipeFeedCard.svelte` | `streamSummarizeWithAbortAdapter` に切替、`$effect` cleanup で abort |
| `alt-frontend-sv/.../swipe/SwipeFeedCard.svelte.spec.ts` | abort-on-destroy テスト 2 件追加 |
| `compose/ai.yaml` | `SCHEDULING_RT_MODE=lifo` 環境変数追加 |

### テスト結果

| テストスイート | 結果 |
|--------------|------|
| `test_hybrid_priority_semaphore.py` (56 件) | 全件 PASS（新規 6 件含む） |
| `pre-processor/repository` | 全件 PASS |
| `svelte-check` (型検査) | 0 errors, 0 warnings |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| コンテナ再ビルド (news-creator, pre-processor, alt-frontend-sv) | ビルド成功 |
| コンテナ起動 | 3 コンテナとも Started |
| ヘルスチェック (Frontend `/api/health`) | HTTP 200 |
| ヘルスチェック (Backend `/v1/health`) | HTTP 200 |
| ヘルスチェック (news-creator `/health`) | HTTP 200 |
| 起動ログ `scheduling_rt_mode` | `"lifo"` 確認済み |
| 起動ログ `rt_scheduling_mode` | `"lifo"` 確認済み |

### PROS

- ユーザーが今見ている記事の要約が最優先で処理され、体感レイテンシが大幅に改善
- Frontend のキャンセルにより、離脱済みの LLM スロットが即座に解放される
- `SCHEDULING_RT_MODE=fifo` で即座にロールバック可能
- BE キューには影響せず、バッチ処理の順序は FIFO のまま
- 既存 API（`streamSummarizeWithAbortAdapter`）を活用し、新規インタフェース追加なし
- 既存テスト 50 件に回帰なし

### CONS, TRADEOFF

- LIFO の性質上、短時間に大量のリクエストが来た場合、最も古いリクエストが飢餓状態になる可能性がある。ただし、既存の Priority Promotion（BE→RT 昇格）と Guaranteed Bandwidth が飢餓防止として機能する
- pre-processor の `ORDER BY created_at DESC` はグローバル変更であり、環境変数による切替はできない。ロールバックにはコード変更が必要

### 影響範囲

- **alt-frontend-sv**: `SwipeFeedCard` のみ。デスクトップの Summary ボタンは変更なし（単一リクエストのためキュー競合が発生しない）
- **news-creator**: `HybridPrioritySemaphore` の RT キューのみ。BE キュー・aging・preemption・guaranteed bandwidth は影響なし
- **pre-processor**: `GetPendingJobs` の取得順のみ。ジョブの作成・更新・ステータス遷移は影響なし
- **alt-backend**: 変更なし
- **他サービス**: 変更なし

## 付録

### LIFO の原理（min-heap + 符号反転）

```python
# FIFO: enqueue_time = start_time (正数)
#   A(t=100), B(t=101), C(t=102) → pop順: A, B, C

# LIFO: enqueue_time = -start_time (負数)
#   A(t=-100), B(t=-101), C(t=-102) → pop順: C, B, A
```

### Frontend AbortController のライフサイクル

```
SwipeFeedCard mount → Summary click → AbortController 生成
                                       ↓
                    スワイプ離脱 → $effect cleanup → abort() 実行
                                       ↓
                    news-creator 側で接続切断を検知 → LLM スロット解放
```

## 関連 ADR

- ADR-000261: モバイル向けフィードソース除外フィルタ
- ADR-000262: Swipe モード向け Filter & Sort Bottom Sheet
