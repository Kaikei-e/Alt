# alt-butterfly-facade: Accept-Encoding ヘッダー転送の廃止

## ステータス

採択（Accepted）

## コンテキスト

### 問題の発生

Connect-RPC API（`/sv/api/v2/`）へのリクエストで、フロントエンドが以下のエラーを受信していた：

```
Error: [unknown] Unexpected token '\u001f', "\u001f\x8b\b..."... is not valid JSON
```

`\u001f\x8b\x08` は gzip のマジックナンバーであり、gzip 圧縮されたバイナリデータが JSON としてパースされていた。

### アーキテクチャ

```
Browser -> nginx -> alt-frontend-sv -> alt-butterfly-facade -> alt-backend
                                       (BFF)
```

### 原因調査

1. **alt-butterfly-facade** が `Accept-Encoding: gzip` をバックエンドに転送していた
2. alt-backend が gzip 圧縮レスポンスを返却
3. Go の `http2.Transport` はユーザーが手動で `Accept-Encoding` を設定した場合、**自動解凍しない**
4. BFF は `Content-Encoding` ヘッダーを転送していなかった
5. alt-frontend-sv（Node.js）は `Content-Encoding` がないためデータを解凍せず
6. gzip 圧縮されたバイトがそのままクライアントに返却

### Go http2.Transport の動作

Go Issue [#13298](https://github.com/golang/go/issues/13298) に記載の通り：

> Transport の `DisableCompression` が false（デフォルト）かつ `Accept-Encoding` が未設定の場合のみ、自動で gzip を要求し、レスポンスを透過的に解凍する。ユーザーが明示的に `Accept-Encoding` を設定した場合は自動解凍されない。

## 決定

**alt-butterfly-facade** のヘッダー転送リストから `Accept-Encoding` を削除する。

### 変更前

```go
headersToForward := []string{
    "Content-Type",
    "Accept",
    "Accept-Encoding",  // 問題の原因
    "Connect-Protocol-Version",
    "Connect-Timeout-Ms",
    "Grpc-Timeout",
}
```

### 変更後

```go
// Note: Accept-Encoding is intentionally excluded.
// Go's http2.Transport does not auto-decompress when Accept-Encoding is set manually,
// which causes gzip-compressed responses to be forwarded without decompression.
// See: https://github.com/golang/go/issues/13298
headersToForward := []string{
    "Content-Type",
    "Accept",
    "Connect-Protocol-Version",
    "Connect-Timeout-Ms",
    "Grpc-Timeout",
}
```

## 結果

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `alt-butterfly-facade/internal/client/backend_client.go` | `Accept-Encoding` を転送リストから削除 |
| `alt-butterfly-facade/internal/client/backend_client_test.go` | テスト追加 |

### 新規テスト

| テスト名 | 検証内容 |
|---------|---------|
| `TestCopyHeaders_ExcludesAcceptEncoding` | Accept-Encoding が転送されないことを検証 |
| `TestCopyHeaders_ForwardsRequiredHeaders` | 必要なヘッダーが転送されることを検証 |

### メリット

1. **問題解決**: gzip パースエラーが解消
2. **シンプル**: BFF とバックエンド間で圧縮不要（同一ネットワーク内）
3. **明確な意図**: コメントで理由を記載

### トレードオフ

1. **帯域幅**: BFF-バックエンド間のデータは非圧縮（Docker 内部ネットワークのため影響軽微）

## テスト

```bash
# 単体テスト
cd alt-butterfly-facade && go test ./internal/client/... -v

# 全テスト
cd alt-butterfly-facade && go test ./... -v

# 再ビルド・デプロイ
docker compose build alt-butterfly-facade
docker compose up -d alt-butterfly-facade
```

## 実装日

2026-01-13

## 関連

- [Go Issue #13298: http2.Transport should do transparent gzip](https://github.com/golang/go/issues/13298)
- [SvelteKit Issue #12197: fetch proxy gzip decoding](https://github.com/sveltejs/kit/issues/12197)
