# news-creator: Hybrid RT/BE スケジューリングによる TTFT 最適化

## ADR's STATUS

Accepted

## CONTEXT

### 背景

フロントエンドからのストリーミングリクエスト（要約表示）で TTFT（Time To First Token）が異常に遅延していた。

| 指標 | 値 |
|------|-----|
| TTFT 平均 | 211秒 (3.5分) |
| TTFT 最大 | 667秒 (11分) |
| キュー待ち平均 | 210秒 |

### 根本原因

1. **非プリエンプティブ優先度キュー**: 実行中のリクエストを中断できない
2. **低いセマフォ値**: OLLAMA_NUM_PARALLEL=2 で、バッチ処理がスロットを占有
3. **バッチ処理の圧倒的ボリューム**: LOW優先度が98%、HIGH優先度が2%

## DECISION MAKING

### 検討したアプローチ

| Option | 内容 | 評価 |
|--------|------|------|
| A: Hybrid RT/BE + Reserved Slot | RT用スロットを予約し、BE用と分離 | 採用 |
| B: セマフォ値を増加 | OLLAMA_NUM_PARALLEL を増やす | 不採用 (VRAM制約) |
| C: プリエンプティブスケジューリング | 実行中リクエストを中断 | 不採用 (複雑すぎる) |

### 採用理由

**Option A（Hybrid RT/BE + Reserved Slot + Aging）を採用**:

1. RT（ストリーミング）用に専用スロットを予約
2. BE（バッチ）はそれ以外のスロットを使用
3. Aging機構でBEの飢餓状態を防止
4. RTX 4060 8GB の VRAM 制約内で実現可能

参考資料:
- [Efficient LLM Serving on Hybrid RT/BE Requests](https://arxiv.org/html/2504.09590v1)
- [Efficient Request Queueing - HuggingFace](https://huggingface.co/blog/tngtech/llm-performance-request-queueing)

## RESULTS, EFFECTS

### 新規ファイル

| ファイル | 内容 |
|----------|------|
| `news_creator/gateway/hybrid_priority_semaphore.py` | Hybrid RT/BE セマフォ実装 |
| `tests/gateway/test_hybrid_priority_semaphore.py` | 単体テスト (22件) |

### 修正ファイル

| ファイル | 変更内容 |
|----------|----------|
| `news_creator/config/config.py` | スケジューリング設定追加 |
| `news_creator/gateway/ollama_gateway.py` | HybridPrioritySemaphore に切替 |
| `compose/ai.yaml` | 環境変数追加 |

### 設定パラメータ

| 環境変数 | デフォルト | 説明 |
|----------|-----------|------|
| `SCHEDULING_RT_RESERVED_SLOTS` | 1 | RT用予約スロット数 |
| `SCHEDULING_AGING_THRESHOLD_SECONDS` | 60 | Aging開始までの待機時間 |
| `SCHEDULING_AGING_BOOST` | 0.5 | Aging時の優先度ブースト係数 |

### スロット構成

```
OLLAMA_NUM_PARALLEL=2 の場合:
├── RT専用スロット: 1 (ストリーミング用)
└── BE共有スロット: 1 (バッチ処理用)
```

### 期待される改善

| 指標 | Before | After (期待値) |
|------|--------|---------------|
| RT TTFT平均 | 210秒 | < 5秒 |
| RT TTFT最大 | 666秒 | < 30秒 |
| BEスループット | 維持 | 維持 |

### PROS

1. **TTFT大幅改善**: ストリーミングリクエストの待機時間を劇的に短縮
2. **飢餓防止**: Aging機構によりバッチ処理も進行を保証
3. **VRAM効率維持**: 既存のOLLAMA_NUM_PARALLEL設定を維持

### CONS, TRADEOFF

1. **BE スループット微減**: RTスロット予約分、バッチ処理の並列度が低下
2. **設定の複雑化**: 3つの新しいパラメータが追加

## APPENDIX

### デプロイ手順

```bash
docker compose -f compose/compose.yaml -p alt build news-creator
docker compose -f compose/compose.yaml -p alt up -d news-creator
```

### 検証方法

```bash
# ログでキュー待ち時間を確認
docker compose -f compose/compose.yaml -p alt logs news-creator --since 1h 2>&1 | \
  grep "TTFT breakdown" | \
  grep -oP '"queue_wait_time_seconds": [0-9.]+' | \
  cut -d' ' -f2 | \
  awk '{sum+=$1; count++} END {print "Avg queue wait:", sum/count, "seconds"}'
```

### テスト実行

```bash
cd news-creator/app
SERVICE_SECRET=test-secret uv run pytest tests/gateway/test_hybrid_priority_semaphore.py -v
```
