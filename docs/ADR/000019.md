# RAG OrchestratorのChat API JSON Schema統一 (ADR 000003)

## ステータス

採択（Accepted）

## コンテキスト

RAG Orchestratorの `/v1/rag/answer` エンドポイントにおいて、以下の問題が発生していた。

### 問題の発見

1. **Fallbackの多発**: クエリに対して常に `fallback: true` が返却され、回答が生成されない
2. **Ollamaエラー**: `"invalid JSON schema in format"` という500エラーがAugur（Ollamaプロキシ）から返却

### 調査結果

ログ分析により、以下のタイムラインが判明した：

| フェーズ | 所要時間 | ステータス |
|---------|---------|-----------|
| Query Translation (Ollama Generate) | ~7.5s | OK |
| Tag Search | 6ms | OK |
| Vector Search | ~3.5s | OK |
| Retrieval Total | ~11s | OK |
| **LLM Chat Generation** | ~31s | **FAILED (500)** |

### 根本原因

`ollama_generator.go` において、`Generate` メソッドと `Chat` メソッドで異なる JSON Schema フォーマットが使用されていた。

**Generate メソッド（正常動作）**:
```go
Format: generationFormat,  // 完全なJSON Schema
```

**Chat メソッド（エラー発生）**:
```go
Format: map[string]interface{}{"type": "json"},  // 簡易フォーマット
```

Augur（Ollamaプロキシ）は完全なJSON Schemaを期待していたが、`Chat` メソッドは簡易フォーマット `{"type": "json"}` を送信していたため、スキーマバリデーションエラーが発生していた。

## 決定

### 1. Chat/ChatStream メソッドのフォーマット統一

`Chat` および `ChatStream` メソッドにおいて、`Format` フィールドを `generationFormat` に統一する。

**変更前**:
```go
// Chat メソッド (line 411)
Format: map[string]interface{}{"type": "json"},

// ChatStream メソッド (line 491)
Format: map[string]interface{}{"type": "json"},
```

**変更後**:
```go
// Chat メソッド
Format: generationFormat,

// ChatStream メソッド
Format: generationFormat,
```

### 2. generationFormat の定義（既存）

```go
var generationFormat = map[string]interface{}{
    "type": "object",
    "properties": map[string]interface{}{
        "answer": map[string]interface{}{
            "type": "string",
        },
        "citations": map[string]interface{}{
            "type": "array",
            "items": map[string]interface{}{
                "type": "object",
                "properties": map[string]interface{}{
                    "chunk_id": map[string]interface{}{"type": "string"},
                    "reason":   map[string]interface{}{"type": "string"},
                },
                "required": []string{"chunk_id"},
            },
        },
        "fallback": map[string]interface{}{
            "type": "boolean",
        },
        "reason": map[string]interface{}{
            "type": "string",
        },
    },
    "required": []string{"answer", "citations", "fallback", "reason"},
}
```

## 結果・影響

### 利点

1. **Fallback問題の解消**: 正しいJSON Schemaが送信されることで、Augurが正常に回答を生成
2. **一貫性**: `Generate`、`GenerateStream`、`Chat`、`ChatStream` の全メソッドで同一のスキーマを使用
3. **保守性向上**: スキーマ変更時に1箇所 (`generationFormat`) の修正で対応可能

### 検証結果

修正後のテストクエリ `{"query": "NPUについて教えて", "locale": "ja", "max_chunks": 10}` に対して：

- **修正前**: `fallback: true`, `reason: "generation failed: chat endpoint returned 500: {\"error\":\"invalid JSON schema in format\"}"`
- **修正後**: `fallback: false`, 正常な回答とcitationsが返却

### 残存課題

LLM生成に ~59秒かかっており、これは別途パフォーマンス最適化が必要である。主な要因：
- モデルサイズ（`gpt-oss20b-cpu`: 20Bパラメータ、CPU推論）
- コンテキストサイズ（~6300文字、10チャンク）

## 変更ファイル

- `rag-orchestrator/internal/adapter/rag_augur/ollama_generator.go`
  - Line 411: `Chat` メソッドの `Format` フィールド
  - Line 491: `ChatStream` メソッドの `Format` フィールド

## 補足: 調査に使用したログ分析コマンド

```bash
# リクエストライフサイクル
docker logs alt-rag-orchestrator-1 2>&1 | grep -E "answer_request_started|answer_request_completed"

# 生成パフォーマンス
docker logs alt-rag-orchestrator-1 2>&1 | grep "llm_generation_completed" | jq '{request_id, generation_ms}'

# Fallbackイベント
docker logs alt-rag-orchestrator-1 2>&1 | grep "answer_fallback_triggered" | jq '{request_id, reason}'

# Ollamaエラー
docker logs alt-rag-orchestrator-1 2>&1 | grep "ollama_chat_failed"
```
