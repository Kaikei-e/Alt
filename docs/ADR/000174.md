# Tag Trail FetchRandomFeed レスポンスへのタグ統合

## ADR's STATUS

Accepted

## CONTEXT

Tag Trail機能において、初期フィードカードのタグが表示されない問題が発生していた。

### 問題の根本原因

調査の結果、フロントエンドがConnect-RPCの`StreamArticleTags`（オンザフライ生成対応）ではなく、REST APIを使用してタグを取得していたことが判明。

```
Before:
1. fetchRandomFeed(transport) → Connect-RPC ✓
2. getFeedTagsByIdClient(feedId) → REST API
3. REST APIはDBのみ参照（オンザフライ生成なし）
4. count=0 → タグ表示されない
```

### API分析

| API | Proto定義 | オンザフライ生成 | フロントエンド使用 |
|-----|----------|----------------|------------------|
| `FetchArticleTags` | ✓ | ✓ | ✓ |
| `StreamArticleTags` | ✓ | ✓ | ✓（記事タグ用） |
| REST `/v1/feeds/{id}/tags` | - | ✗ | ✓（問題箇所） |

フィードレベルのタグ取得はConnect-RPCに移行されておらず、REST APIのみが存在していた。

## DECISION MAKING

### 方針: FetchRandomFeedレスポンスにタグを統合

別途Connect-RPCエンドポイントを追加するのではなく、既存の`FetchRandomFeed`レスポンスにタグを含める方式を選択。

#### 選択肢の比較

| 案 | 概要 | 工数 | 効率性 |
|----|------|------|--------|
| A | `StreamFeedTags` Connect-RPC追加 | 大 | 中 |
| **B** | `FetchRandomFeed`にタグを含める | 中 | **高** |
| C | フロントエンドで記事取得→`streamArticleTags` | 小 | 低 |

**選択: 案B**

#### 理由

1. 単一API呼び出しでフィード情報とタグを取得
2. 追加のConnect-RPCエンドポイント不要
3. フロントエンド変更が最小限
4. ネットワークラウンドトリップ削減

### 実装フロー

```
After:
1. fetchRandomFeed(transport) → Connect-RPC
   - Backend: ランダムフィード取得
   - Backend: フィードの最新記事取得
   - Backend: FetchArticleTagsGateway経由でタグ取得/生成
   - Response: フィード + タグ
2. フロントエンド: タグをレスポンスから直接使用
```

### フェイルオープン設計

タグ取得・生成で問題が発生した場合も、フィード情報は正常に返却し、タグは空配列とする。

## RESULTS, EFFECTS

### Proto変更

```protobuf
message FetchRandomFeedResponse {
  string id = 1;
  string url = 2;
  string title = 3;
  string description = 4;
  // NEW: Tags for the feed (generated on-the-fly if not in DB)
  repeated ArticleTagItem tags = 5;
}
```

### Backend変更

**Handler (`FetchRandomFeed`)**
1. `FetchRandomSubscriptionUsecase`でランダムフィード取得
2. `AltDBRepository.FetchLatestArticleByFeedID`で最新記事取得
3. `FetchArticleTagsGateway.FetchArticleTags`でタグ取得/生成
4. レスポンスにタグを含めて返却

**新規Driver**
- `FetchLatestArticleByFeedID`: フィードの最新記事を取得するクエリ

### Frontend変更

**articles.ts**
- `RandomFeed`型に`tags`フィールド追加
- `fetchRandomFeed`でタグをマッピング

**TagTrailScreen.svelte**
- REST APIインポート削除
- `FeedData`インターフェースに`tags`追加
- タグを`fetchRandomFeed`レスポンスから直接使用
- 不要な`loadFeedTags`関数削除

### 変更ファイル一覧

| レイヤー | ファイル | 変更内容 |
|---------|---------|---------|
| Proto | `articles.proto` | `FetchRandomFeedResponse`にtagsフィールド追加 |
| Backend Handler | `handler.go` | タグ取得ロジック追加 |
| Backend Driver | `fetch_latest_article_by_feed_driver.go` | 新規作成 |
| Backend Tests | `handler_test.go` | FetchRandomFeed関連テスト追加 |
| Frontend Type | `articles.ts` | RandomFeed型更新 |
| Frontend Component | `TagTrailScreen.svelte` | REST API削除、Connect-RPC統合 |
| Frontend SSR | `+page.server.ts` | REST APIからConnect-RPCに変更 |

### PROS

1. **API呼び出し削減**: 2回→1回（フィード取得とタグ取得を統合）
2. **オンザフライ生成統合**: 初期フィードカードでもタグが生成される
3. **コード簡素化**: フロントエンドからREST API依存を削除
4. **一貫性向上**: Tag Trail全体でConnect-RPCを使用
5. **レイテンシ改善**: ネットワークラウンドトリップ削減

### CONS, TRADEOFF

1. **レスポンスサイズ増加**: タグデータ分のペイロード増加（微小）
2. **結合度増加**: FetchRandomFeedがタグ取得も担当
3. **初回レイテンシ**: オンザフライ生成時は数秒の遅延が発生
4. **データ依存**: フィードと記事の関連付け（`feed_id`）がない場合、タグは空配列となる

## APPENDIX

### 処理シーケンス

```
Frontend                    Backend                     DB/mq-hub
    │                           │                           │
    ├─→ FetchRandomFeed ───────→│                           │
    │                           ├─→ FetchRandomSubscription─→│
    │                           │←───────── feed ───────────┤
    │                           │                           │
    │                           ├─→ FetchLatestArticle ────→│
    │                           │←───────── article ────────┤
    │                           │                           │
    │                           ├─→ FetchArticleTags ──────→│
    │                           │   (via Gateway)           │
    │                           │←───────── tags ───────────┤
    │                           │                           │
    │←── feed + tags ──────────┤                           │
    │                           │                           │
```

### 関連ADR

- ADR-167: Tag Trail基本設計
- ADR-168: オンザフライタグ生成（Gateway実装）
- ADR-169: タグ名による横断検索
- ADR-170: Tag Trail Connect-RPC移行
- ADR-171: リアルタイムタグ反映 (Server Streaming)
- ADR-172: CJKテキスト対応とフィード解決ロジック改善
- ADR-173: StreamArticleTagsオンザフライ生成

### 検証コマンド

```bash
# Proto生成
make buf-generate

# Backendテスト
cd alt-backend/app && go test ./connect/v2/articles/... -v

# Frontend型チェック
cd alt-frontend-sv && bun run check

# コンテナ再ビルド
docker compose -f compose/compose.yaml -p alt up -d --build alt-backend alt-frontend-sv
```
