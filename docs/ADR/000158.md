# pre-processorの記事upsert時UUID空文字列エラーの修正

## ステータス

承認済み（2026-01-29）

## 背景

pre-processorサービスにおいて、記事をデータベースに保存する際に以下のエラーが発生していた：

```
ERROR: invalid input syntax for type uuid: ""
```

### 原因分析

記事挿入には2つのコードパスが存在した：

1. **Article Sync Service** (正常動作)
   - `articleRepo.UpsertArticles()` → `driver.UpsertArticlesBatch()`
   - `UserID` を `GetSystemUserID()` から取得
   - 空のUUIDバリデーションあり

2. **Feed Processor Service** (問題あり)
   - `articleRepo.Create()` → `driver.CreateArticle()`
   - `UserID` の設定なし
   - `CreateArticle` に `user_id` カラムがない

DBスキーマでは `user_id UUID NOT NULL` が必須であるため、空文字列が渡されるとPostgreSQLがエラーを返していた。

## 決定事項

### アプローチ

TDDに基づき、以下の修正を実施した：

| 対象 | 変更内容 |
|-----|---------|
| driver層 | `CreateArticle`に`user_id`カラムとバリデーション追加 |
| service層 | Feed ProcessorにExternalAPIRepository依存を追加 |
| main.go | コンストラクタ引数の更新 |

### 実装内容

1. **`driver/db_articles.go`**
   - `CreateArticle`に`FeedID`と`UserID`の空文字列チェックを追加
   - INSERTクエリに`user_id`カラムを追加

2. **`service/feed_processor.go`**
   - `externalAPIRepo`依存を追加
   - `cachedUserID`フィールドでシステムユーザーIDをキャッシュ

3. **`service/feed_processor_enhanced.go`**
   - 同様に`externalAPIRepo`依存を追加
   - `processSingleFeedWithRetry`内で`GetSystemUserID()`を呼び出し、記事保存前に`UserID`を設定

### バリデーション戦略

```go
// driver層で早期検証
if article.FeedID == "" {
    return fmt.Errorf("article FeedID is required")
}
if article.UserID == "" {
    return fmt.Errorf("article UserID is required")
}
```

DBクエリを実行する前に必須フィールドを検証することで、明確なエラーメッセージを返しデバッグを容易にする。

## 結果・影響

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `driver/db_articles.go` | `CreateArticle`にバリデーションと`user_id`追加 |
| `service/feed_processor.go` | `externalAPIRepo`依存追加 |
| `service/feed_processor_enhanced.go` | `externalAPIRepo`依存追加、UserID設定ロジック |
| `main.go` | コンストラクタ呼び出し更新 |
| `driver/db_articles_test.go` | バリデーションテスト追加 |
| `service/feed_processor_test.go` | テスト更新 |
| `service_test/feed_processor_enhanced_test.go` | テスト更新 |

### メリット

- **明確なエラー**: DB層のPostgreSQLエラーではなく、アプリケーション層で具体的なエラーメッセージを返す
- **一貫性**: 両方の記事挿入パスで同じバリデーションロジックを適用
- **キャッシュ効率**: システムユーザーIDをキャッシュし、外部API呼び出しを最小化

### デメリット・トレードオフ

- **依存関係の増加**: Feed ProcessorがExternalAPIRepositoryに依存
- **初回オーバーヘッド**: 最初の記事保存時にシステムユーザーID取得のためのAPI呼び出しが発生

## 付録

### 動作確認

```bash
# コンテナ再ビルド・起動
docker compose -f compose/compose.yaml -p alt up -d --build pre-processor

# ログでUUIDエラーが発生しないことを確認
docker compose -f compose/compose.yaml -p alt logs pre-processor | grep -i "invalid input syntax for type uuid"
```

### テスト実行

```bash
cd pre-processor/app && go test ./...
```

### 関連ADR

- なし
