# Start Job ボタン無効化が動作しない問題の修正

## ADR'S STATUS

Accepted

## CONTEXT

### 背景

Recap Job Status ページ (`/sv/desktop/recap/job-status`) において、ジョブ実行中でも Start Job ボタンが無効化されず、押せてしまう問題が発生していた。

コード上は以下のように実装されていた:
```typescript
const hasRunningJob = $derived(!!jobProgress.data?.active_job);
// ...
disabled={triggering || hasRunningJob}
```

### 原因分析

1. **Svelte 5 リアクティビティの問題**: `useJobProgress` フックがゲッターで `$state` 値を返す設計。`$derived(expression)` がゲッター経由の状態変更を正しく追跡しない可能性があった
2. **コンテナのキャッシュ**: 修正後もコンテナが古いコードで動作していた可能性

## DECISION MAKING

### 決定

1. `$derived(expression)` を `$derived.by(() => expression)` に変更し、明示的な追跡を行う
2. コンテナを `--no-cache` オプションで再ビルド

### 技術的詳細

**Svelte 5 の `$derived` vs `$derived.by`**:

- `$derived(value)`: 単純な式の派生値
- `$derived.by(fn)`: 関数による明示的な派生値計算

ゲッター経由で `$state` を参照する場合、`$derived.by` を使用することでリアクティビティの追跡が確実になる。

**修正前**:
```typescript
const hasRunningJob = $derived(!!jobProgress.data?.active_job);
const runningJobTooltip = $derived(() => { /* ... */ });
```

**修正後**:
```typescript
const hasRunningJob = $derived.by(() => {
  const d = jobProgress.data;
  return d?.active_job != null;
});
const runningJobTooltip = $derived.by(() => { /* ... */ });
```

テンプレートの関数呼び出しも値参照に修正:
```svelte
<!-- 修正前 -->
title={runningJobTooltip()}

<!-- 修正後 -->
title={runningJobTooltip}
```

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 種別 | 内容 |
|----------|------|------|
| `alt-frontend-sv/src/routes/desktop/recap/job-status/+page.svelte` | 変更 | `$derived` → `$derived.by` への変更、テンプレートの関数呼び出し修正 |

### 修正内容

1. `hasRunningJob`: `$derived.by` で明示的追跡
2. `avgDuration`: 同上
3. `runningJobTooltip`: 同上
4. テンプレート: 関数呼び出し `()` を削除（`$derived.by` は値を返すため）

### PROS

1. **確実なリアクティビティ**: ゲッター経由の状態変更を確実に追跡
2. **一貫性**: 全ての派生値で同じパターンを使用
3. **Svelte 5 ベストプラクティス**: フック内の `$state` を参照する場合の推奨パターン

### CONS, TRADEOFF

1. **コード量の微増**: `$derived.by(() => ...)` は `$derived(...)` より若干冗長

## APPENDIX

### 検証手順

```bash
# 型チェック
cd alt-frontend-sv && bun run check
# svelte-check found 0 errors

# コンテナ再ビルド（キャッシュなし）
docker compose -f compose/compose.yaml -p alt build --no-cache alt-frontend-sv
docker compose -f compose/compose.yaml -p alt up -d alt-frontend-sv
```

### Svelte 5 Runes リファレンス

- `$state`: リアクティブな状態
- `$derived`: 派生値（短縮形）
- `$derived.by`: 派生値（関数形式）
- `$effect`: 副作用

### 関連ADR

- ADR-115: Recap Job Status ページのトリガーソース表示強化
- ADR-109: Recap Job Status Dashboard 実装
