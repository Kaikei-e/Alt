# ADR-000239: SwipeFeedCard Favorite ボタンのモバイル動作不良修正

## STATUS

Accepted（実装完了）

## CONTEXT

ADR-000235/000236 で SwipeFeedCard に追加した Favorite ボタンが、モバイル環境で正常に動作しなかった。症状は「スピナー表示後に元の状態に戻る」。

### 根本原因

調査の結果、3 つの問題が重なっていた：

1. **不要な SSRF チェック** — `RegisterFavoriteFeed` ハンドラーが `rest.IsAllowedURL` を呼んでおり、毎回 `net.LookupIP` で DNS 解決を行っていた。このハンドラーは外部リクエストを行わず、`feeds` テーブルへの `SELECT id FROM feeds WHERE link = $1` で URL を参照するだけであるため、SSRF 保護は不要。Docker コンテナ内の DNS 環境差異で解決が失敗し、リクエストが拒否されていた。

2. **エラーの握りつぶし** — フロントエンドの `handleFavorite()` が catch ブロックで `console.error` のみ実行し、ユーザーへのフィードバックが一切なかった。そのため「スピナー → 元に戻る」という無反応な UX になっていた。

3. **DB 制約の欠損** — `favorite_feeds` テーブルの複合主キー `(user_id, feed_id)` が実際には存在しなかった。マイグレーション `20250812001401` で `ADD PRIMARY KEY` を意図していたが、既存の重複データにより適用が失敗し、マイグレーションランナーは適用済みとして記録していた。ドライバーの `ON CONFLICT (user_id, feed_id) DO NOTHING` が制約不在により SQL エラーとなっていた。

### 問題の構造

```
モバイルからの Favorite リクエスト
  → ハンドラー: SSRF チェック (net.LookupIP) → DNS 解決失敗 → 400 エラー
  → フロントエンド: catch → console.error のみ → UI フィードバックなし
  → ユーザー体験: スピナー → 元に戻る（何も起きていないように見える）
```

SSRF チェックを通過した場合でも、DB 制約欠損により SQL エラーが発生する二重障害構造だった。

## DECISION MAKING

### 方針

3 層にまたがる問題をそれぞれ修正する。

| 層 | 問題 | 対応 |
|---|---|---|
| バックエンド ハンドラー | 不要な SSRF チェック | `url.Parse` / `IsAllowedURL` を除去 |
| フロントエンド | エラーの握りつぶし | `favoriteError` state + UI フィードバック + リトライ可能化 |
| DB スキーマ | 複合主キー欠損 | Atlas マイグレーションで重複排除 + PK 追加 |

### SSRF チェック除去の根拠

`RegisterRSSFeed`（新規フィード登録）は URL 先への外部リクエストを行うため、SSRF チェックが必要。一方 `RegisterFavoriteFeed` は自身の `feeds` テーブルで URL を照合するのみであり、外部通信は発生しない。

```
RegisterRSSFeed:       URL → SSRF チェック ✅ → 外部フェッチ → DB 保存
RegisterFavoriteFeed:  URL → DB 照合のみ → SSRF チェック不要
```

### エラーフィードバックの設計

- `favoriteError` state を追加し、catch ブロックでエラーメッセージを設定
- ボタンの背景を赤系に変更、Star アイコンの stroke を `red` に
- `aria-label` に `"Favorite failed, tap to retry"` を設定
- 3 秒後にエラー表示を自動クリア
- `isFavorited` が `false` のままなのでボタンは `disabled` にならず、リトライ可能

### DB マイグレーションの設計

冪等性を担保した修正マイグレーション：

```sql
-- 重複排除
DELETE FROM favorite_feeds a
USING favorite_feeds b
WHERE a.ctid < b.ctid
  AND a.user_id = b.user_id
  AND a.feed_id = b.feed_id;

-- PK 追加（存在しない場合のみ）
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint
        WHERE conrelid = 'favorite_feeds'::regclass
          AND contype = 'p'
    ) THEN
        ALTER TABLE favorite_feeds ADD PRIMARY KEY (user_id, feed_id);
    END IF;
END
$$;
```

## RESULTS

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/connect/v2/rss/handler.go` | `RegisterFavoriteFeed` から `url.Parse` / `rest.IsAllowedURL` を除去 |
| `alt-backend/app/connect/v2/rss/handler_test.go` | ハンドラーレベルのテスト 5 件追加（空 URL, 空白 URL, 未認証, 正常系, usecase エラー） |
| `alt-frontend-sv/src/lib/components/mobile/feeds/swipe/SwipeFeedCard.svelte` | `favoriteError` state 追加、エラー UI 表示、リトライ対応 |
| `alt-frontend-sv/src/lib/components/mobile/feeds/swipe/SwipeFeedCard.svelte.spec.ts` | API エラー時リトライ可能テスト、エラー後復旧テスト追加 |
| `migrations-atlas/migrations/20260213000001_fix_favorite_feeds_composite_pk.sql` | 重複排除 + 複合主キー追加マイグレーション |

### テスト結果

- バックエンド: `go test ./connect/v2/rss/...` — 全 16 テスト PASS
- フロントエンド: `svelte-check` — 0 errors, 0 warnings

## PROS

1. **根本原因の解消** — SSRF チェック除去により DNS 依存がなくなり、全環境で安定動作
2. **UX 改善** — エラー時に視覚フィードバック + リトライ可能で、ユーザーが状況を把握できる
3. **データ整合性** — 複合主キーにより `ON CONFLICT` が正しく動作し、重複登録を防止
4. **セキュリティ維持** — 外部リクエストを行う `RegisterRSSFeed` の SSRF チェックは維持

## CONS, TRADEOFF

1. **マイグレーション `20250812001401` の二重適用** — 元のマイグレーションは「適用済み」だがスキーマには反映されていなかったため、修正マイグレーションで補完。冪等性により既に PK が存在する環境では no-op となる
2. **重複データの削除** — `ctid` ベースで古い行を保持し新しい重複行を削除。52 件の重複が除去された

## APPENDIX

- 関連 ADR: [ADR-000235](./000235.md) — SwipeFeedCard Favorite ボタン実装
- 関連 ADR: [ADR-000236](./000236.md) — SwipeFeedCard Favorite ボタン UI 設計
- 関連 ADR: [ADR-000237](./000237.md) — Favorites フィード一覧の重複キー修正
