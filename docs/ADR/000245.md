# ADR-000245: UpsertArticles の未登録フィード耐性改善 (article-sync Phase 3)

## STATUS

Accepted

## CONTEXT

### 問題

ADR-000244 (Phase 1: 内部認証、Phase 2: Inoreader 記事取得) の修正により article-sync パイプラインは Inoreader 記事の取得まで到達するようになった。しかし `UpsertArticles` の段階で、一部フィードが alt-backend に未登録であるため Connect-RPC `CodeNotFound` エラーが発生し、**バッチ全体が即座に失敗**していた。

```
"failed to upsert articles: upsert article https://example.com/article:
 failed to get feed ID: not_found: feed not found"
```

### 根本原因

API モードの `UpsertArticles` は各記事に対して `Create` を逐次呼び出し、**最初のエラーで即 return してバッチ全体を中断**する設計だった。一方 Legacy DB モードの `UpsertArticles` は feed 解決を事前に行い、**未登録フィードの記事をスキップして残りを処理**する設計。

この非対称性により、API モードへの移行でレジリエンスが低下していた。

### 因果チェーン (Phase 1〜3 通し)

```
article-sync ジョブ (毎時実行)
  → GetSystemUserID
      Phase 1: ❌ X-Internal-Auth ヘッダー欠落 → auth-hub 401
      修正後:  ✅ 認証成功
  → FetchInoreaderArticles
      Phase 2: ❌ スタブ実装 → "category B" エラー
      修正後:  ✅ DB 直接クエリで記事取得
  → UpsertArticles
      Phase 3: ❌ 未登録フィードで即 return → バッチ全滅
      修正後:  ✅ 未登録フィードをスキップし残りを処理
  → summarize_job_queue にジョブ追加
  → summarization ポーリングで処理
```

## DECISION MAKING

API モードの `UpsertArticles` を Legacy DB モードと同じセマンティクスに合わせる:

1. `FeedURL` と `FeedID` が両方空の記事をスキップ (warn ログ)
2. `getFeedID` で feed 解決を試み、エラーまたは空 ID の場合はスキップ (warn ログ)
3. FeedID が解決できた記事のみ `Create` を呼ぶ
4. `Create` 自体のエラー (ネットワーク障害等) は引き続きバッチを即時中断

| 代替案 | 却下理由 |
|--------|---------|
| 未登録フィードを自動登録する | フィード登録はユーザー操作で行うべき。暗黙的な副作用を避ける |
| エラーを収集して最後にまとめて返す | 部分的成功の扱いが複雑になる。Legacy DB モードとのセマンティクス差異が残る |
| フィード解決を事前にバッチ化する | 最適化としては有効だが、現時点で個別呼び出しのレイテンシは問題になっておらず過度な最適化 |

## RESULTS, EFFECTS

### 変更内容

#### 1. `pre-processor/app/driver/backend_api/article_driver.go`

- `"log/slog"` を import に追加
- `UpsertArticles` メソッドを書き換え:
  - 空スライスの早期リターンを追加
  - `FeedURL` / `FeedID` 両方空の記事をスキップ (warn ログ)
  - `getFeedID` による feed 解決を `Create` の前に実行し、失敗時はスキップ (warn ログ)
  - `Create` のエラーのみバッチを中断
  - 処理結果サマリのログ (`created` / `total`) を出力

```go
func (r *ArticleRepository) UpsertArticles(ctx context.Context, articles []*domain.Article) error {
    if len(articles) == 0 {
        return nil
    }
    var created int
    for _, article := range articles {
        if article.FeedURL == "" && article.FeedID == "" {
            slog.WarnContext(ctx, "skipping article with empty FeedURL", ...)
            continue
        }
        if article.FeedID == "" {
            id, err := r.getFeedID(ctx, article.FeedURL)
            if err != nil || id == "" {
                slog.WarnContext(ctx, "feed not found, skipping article", ...)
                continue
            }
            article.FeedID = id
        }
        if err := r.Create(ctx, article); err != nil {
            return fmt.Errorf("upsert article %s: %w", article.URL, err)
        }
        created++
    }
    slog.InfoContext(ctx, "articles upserted via API", "created", created, "total", len(articles))
    return nil
}
```

#### 2. `pre-processor/app/driver/backend_api/article_driver_test.go`

mock `BackendInternalServiceClient` を追加し、以下 5 テストケースを新規追加:

| テスト名 | 検証内容 |
|---------|---------|
| `TestUpsertArticles_EmptySlice` | 空スライスで即 return |
| `TestUpsertArticles_SkipsEmptyFeedURL` | FeedURL/FeedID 空の記事がスキップされる |
| `TestUpsertArticles_SkipsFeedNotFound` | 未登録フィードの記事がスキップされる |
| `TestUpsertArticles_CreateErrorAbortsBatch` | `Create` エラーでバッチが中断される |
| `TestUpsertArticles_WithPresetFeedID` | FeedID 設定済みなら `getFeedID` をスキップ |

### 変更ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `pre-processor/app/driver/backend_api/article_driver.go` | `UpsertArticles` 書き換え、`slog` import 追加 |
| `pre-processor/app/driver/backend_api/article_driver_test.go` | mock 追加、5 テスト追加 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `go test ./driver/backend_api/...` | 7 tests passed (既存 2 + 新規 5) |
| `go test ./...` (pre-processor 全体) | all passed |
| コンテナ再ビルド・起動 | healthy |

### ランタイム検証結果

| 検証項目 | 結果 |
|---------|------|
| `"feed not found, skipping article"` (warn) | 未登録フィード記事がスキップされている |
| `"articles upserted via API"` (info) | バッチ完走 (`created=0, total=4365`) |
| `"successfully synced articles"` (info) | sync 全体が成功 |
| バッチ即時失敗 | 解消 |

`created=0` は現時点で全対象記事のフィードが alt-backend に未登録であることを示す。フィード登録が進めば `created > 0` となる。

### PROS

1. **Legacy DB モードとのセマンティクス統一**: 未登録フィードの記事がバッチ全体を破壊しない
2. **可観測性の向上**: スキップされた記事が warn ログに記録され、フィード登録漏れの検知が容易
3. **最小限の変更**: 1 メソッドの書き換えと import 追加のみ
4. **エラー種別の適切な分離**: feed 未登録 (データ不整合) と Create 失敗 (インフラ障害) を区別

### CONS, TRADEOFF

1. **サイレントスキップのリスク**: 大量の warn ログが出力されるが、記事が永続化されないことに気づきにくい可能性がある。将来的にメトリクス (skipped count) のエクスポートを検討
2. **getFeedID の N+1 呼び出し**: 記事ごとに個別の RPC を発行する。バッチ化は今後の最適化候補

## APPENDIX

### 関連 ADR

| ADR | 内容 | 関連 |
|-----|------|------|
| 244 | article-sync Phase 1 (内部認証) + Phase 2 (Inoreader 記事取得) | 直接の前提修正 |

### API モードにおけるリポジトリのデータソース分類 (更新)

| メソッド | データソース | エラー時の挙動 |
|---------|-------------|--------------|
| Create | Connect-RPC (alt-backend) | エラーを返す |
| CheckExists | Connect-RPC (alt-backend) | エラーを返す |
| FindByID | Connect-RPC (alt-backend) | エラーを返す |
| FetchInoreaderArticles | DB 直接クエリ (pre-processor DB) | エラーを返す |
| **UpsertArticles** | **Connect-RPC (alt-backend)** | **feed 未登録はスキップ、Create エラーは即時中断** |
| FindForSummarization | 未使用 (イベント駆動) | nil を返す |
