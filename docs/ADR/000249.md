# ADR-000249: 要約パイプラインのイベント駆動化

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000247 で要約パイプラインの緊急修正としてポーリング方式（`ListUnsummarizedArticles` RPC）を導入した。pre-processor が10秒ごとに alt-backend をポーリングし、未要約記事を発見・処理する方式である。

### 問題

- **無駄な DB 負荷**: ポーリングサイクルごとに2クエリ発生（新記事の有無にかかわらず）
- **レイテンシ**: 記事作成から要約開始まで最大10秒の遅延
- **非効率**: 大半のポーリングサイクルが空の結果を返却

### 驚くべき発見

Redis Streams のインフラ（mq-hub、Consumer、EventPublisher）は**既に全て実装済み**であった。唯一の欠損は `CreateArticle` RPC ハンドラーがイベントをパブリッシュしていない点のみ。

## 意思決定

### 採用: イベント駆動をプライマリパスに、ポーリングをフォールバックに

1. **プライマリパス（イベント駆動）**: `CreateArticle` RPC が記事の DB INSERT 成功後、`ArticleCreated` イベントを Redis Streams へパブリッシュする。pre-processor の Consumer がイベントを受信し、即座にジョブキューに登録して要約を開始する。

2. **フォールバックパス（ポーリング）**: `ListUnsummarizedArticles` ポーリングを維持するが、間隔を10秒から5分に低減する。以下のケースのセーフティネットとして機能:
   - イベント駆動パスのデプロイ前に作成された記事
   - イベント配信失敗（Redis ダウン、mq-hub 不可用）
   - 手動バックフィルシナリオ

3. **Fire-and-forget セマンティクス**: イベントパブリッシュの失敗は `CreateArticle` RPC をエラーにしない。記事はイベント配信の成否にかかわらず必ず永続化される。失敗したイベントは WARNING ログに記録され、ポーリングフォールバックで補完される。

### 再利用した既存コンポーネント

| コンポーネント | ファイル |
|---|---|
| `EventPublisherPort` | `alt-backend/app/port/event_publisher_port/event_publisher.go` |
| `EventPublisherGateway` | `alt-backend/app/gateway/event_publisher_gateway/` |
| `mqhub_connect.Client` | `alt-backend/app/driver/mqhub_connect/client.go` |
| DI 配線 (`container.EventPublisher`) | `alt-backend/app/di/container.go` |
| `consumer.Consumer` (XREADGROUP) | `pre-processor/app/consumer/redis_consumer.go` |
| `PreProcessorEventHandler` | `pre-processor/app/consumer/event_handler.go` |
| `SummarizeServiceAdapter` | `pre-processor/app/consumer/summarize_adapter.go` |
| `SummarizeQueueWorker` | `pre-processor/app/service/summarize_queue_worker.go` |

## 結果・影響

### 変更概要

| ファイル | 変更内容 |
|---|---|
| `alt-backend/app/connect/v2/internal/handler.go` | `eventPublisher` フィールド追加、`WithEventPublisher` オプション追加、`CreateArticle` にイベント発行追加 |
| `alt-backend/app/connect/v2/internal/handler_test.go` | イベント発行の4テスト追加 |
| `alt-backend/app/connect/v2/server.go` | `WithEventPublisher` の DI 配線追加 |
| `alt-backend/app/mocks/mock_event_publisher_port.go` | `EventPublisherPort` のモック新規作成 |
| `pre-processor/app/handler/job_handler.go` | ポーリング間隔を 10s → 5min に変更 |

### アーキテクチャ（変更後）

```
[プライマリパス: イベント駆動]
pre-processor → Connect-RPC: CreateArticle → alt-backend Handler
  → DB INSERT (articles)
  → EventPublisher.PublishArticleCreated()
    → mq-hub → Redis Streams (alt:events:articles)
      → pre-processor Consumer (XREADGROUP)
        → SummarizeServiceAdapter.SummarizeArticle()
          → JobRepo.CreateJob() (pre-processor-db)
            → SummarizeQueueWorker.ProcessQueue()
              → news-creator /api/v1/summarize
              → Connect-RPC: SaveArticleSummary

[フォールバックパス: ポーリング（5分間隔）]
pre-processor → 5min JobRunner
  → FindForSummarization() → Connect-RPC: ListUnsummarizedArticles
    → バッチ処理 → news-creator → SaveArticleSummary
```

### テストカバレッジ

| テスト | 検証内容 |
|-------|---------|
| `TestCreateArticle_PublishesArticleCreatedEvent` | 記事作成成功時にイベントが正しくパブリッシュされること |
| `TestCreateArticle_NilEventPublisher` | EventPublisher が nil の場合もエラーにならないこと |
| `TestCreateArticle_EventPublishFailureDoesNotFailRPC` | イベントパブリッシュ失敗時も RPC は成功すること |
| `TestCreateArticle_EventPublisherDisabled` | EventPublisher が無効の場合パブリッシュが呼ばれないこと |

### メリット

- 記事作成から要約開始までほぼゼロレイテンシ
- 1日あたり約8,640回の不要なポーリングクエリを削減（10秒間隔の場合）
- 既存インフラの活用により最小限のコード変更で実現

### デメリット・トレードオフ

- デュアルパスの複雑性: イベント駆動とポーリングの両パスを維持する必要がある
- イベント配信は at-most-once（明示的なリトライなし、ポーリングフォールバックで緩和）

### リスク

- mq-hub または Redis がダウンした場合、5分間のポーリングフォールバックに依存
- 長時間の障害時に Consumer Group のラグが蓄積する可能性

## 実装後の補足: Quality Checker / Sidecar の修正

### 発覚した問題

イベント駆動化のデプロイ後、要約パイプライン自体は正常に動作していたが、要約の蓄積を妨げる2つの問題が発覚した。

#### 問題 1: Quality Checker の全件スコア 1 問題

Quality Checker が Ollama `/api/generate` へリクエストする際、`JudgeTemplate` 内に Gemma のチャットテンプレートトークン（`<start_of_turn>user` / `<end_of_turn>` / `<start_of_turn>model`）を手動で含んでいた。しかし Ollama はデフォルトでモデルのチャットテンプレートを自動適用するため、テンプレートが二重ラップ（double-templating）される。

```
# 実際にモデルが受け取る構造:
<start_of_turn>user        ← Ollama が自動追加
<start_of_turn>user        ← JudgeTemplate が含む（重複）
You are an expert Japanese news editor...
<end_of_turn>
<start_of_turn>model
<end_of_turn>               ← Ollama が自動追加
<start_of_turn>model        ← Ollama が自動追加
```

この二重テンプレートによりモデルの出力が不安定になり、全記事にスコア 1 を返していた。作成直後のサマリーが全て品質閾値（7）未満として削除されるため、要約が蓄積しなかった。

**修正**: `/api/generate` リクエストに `raw: true` を追加。Ollama がテンプレートの自動適用をスキップし、`JudgeTemplate` のトークンがそのまま使用される。

| ファイル | 変更内容 |
|---|---|
| `pre-processor/app/quality-checker/quality_judger.go` | `judgePrompt` 構造体に `Raw bool` フィールド追加、`scoreSummary` で `Raw: true` を設定 |
| `pre-processor/app/quality-checker/quality_judger_test.go` | `TestScoreSummaryRequestIncludesRawTrue` テスト追加（リクエストボディの `raw` フィールドを検証） |

#### 問題 2: Sidecar の DB 認証エラー

pre-processor のイメージは再ビルド済みだったが、pre-processor-sidecar は別サービスのため古いイメージのままだった。DB 認証情報の更新が反映されておらず、起動時にクラッシュループが発生。

**修正**: コード変更なし。Docker イメージの再ビルドのみで解消。

### テストカバレッジ（追加分）

| テスト | 検証内容 |
|-------|---------|
| `TestScoreSummaryRequestIncludesRawTrue` | Ollama へのリクエストに `raw: true` が含まれ、モデル名・ストリーム設定が正しいこと |

## 関連 ADR

- ADR-000246: pre-processor-db 分離 — alt-db 依存の完全排除
- ADR-000247: 要約パイプライン修正（`ListUnsummarizedArticles` RPC）
- ADR-000248: SaveArticleSummary UUID エラー修正 — `user_id` パススルー
