# ADR-000244: article-sync パイプライン障害の段階的修正

## STATUS

Accepted

## CONTEXT

### 問題

ダッシュボードで Summarized トレンドが長時間ほぼ 0 で推移。Total Articles に対し Summarized の差分が埋まらない状態が継続した。alt-backend は unsummarized articles を認識しているが、pre-processor 側では pending summarization jobs が常に 0 を報告していた。

### 根本原因

`alt-backend` の `KratosClient.GetFirstIdentityID()` が auth-hub の `/internal/system-user` エンドポイントを呼び出す際に、`X-Internal-Auth` ヘッダーを付与していなかった。

### 因果チェーン

```
1. pre-processor の article-sync ジョブ (毎時実行)
   → alt-backend GET /v1/internal/system-user を呼び出し

2. alt-backend の内部ハンドラ
   → KratosClient.GetFirstIdentityID()
   → auth-hub GET /internal/system-user  ← X-Internal-Auth ヘッダーなし

3. auth-hub の InternalAuth ミドルウェア
   → 401 "missing internal auth header" を返却

4. alt-backend → 500 を pre-processor に返却

5. pre-processor の article-sync が 3 回リトライ後に失敗
   → 新規記事が summarize_job_queue に追加されない
   → summarization ポーリングが count:0 で空回り
   → news-creator にリクエストが到達しない
```

### 影響範囲

- article-sync ジョブの毎時実行が全て失敗
- 新規記事の要約処理が完全に停止
- ダッシュボードの Summarized カウントが増加しない

## DECISION MAKING

### アプローチ: KratosClient に共有シークレットを注入

auth-hub の `InternalAuth` ミドルウェアは `X-Internal-Auth` ヘッダーに共有シークレットを要求する (constant-time comparison)。`KratosClient` がこのヘッダーを送信するように修正する。

シークレットは既存の設定基盤 (`AuthConfig.SharedSecret`) から取得し、DI コンテナ経由でクライアントに注入する。

### 代替案と却下理由

| 選択肢 | 却下理由 |
|--------|---------|
| auth-hub 側で `/internal/system-user` の認証を外す | セキュリティの後退。内部エンドポイントにも認証は必要 |
| 環境変数を直接クライアント内で読む | DI パターンに反する。テスタビリティが低下 |
| ミドルウェアで IP ベースの許可リストに変更 | コンテナ IP は動的。共有シークレット方式がシンプルで確実 |

## RESULTS, EFFECTS

### 変更内容

#### 1. `alt-backend/app/driver/kratos_client/client.go`

- `authHubClientImpl` 構造体に `sharedSecret` フィールドを追加
- `NewKratosClient` のシグネチャに `sharedSecret` パラメータを追加
- `GetFirstIdentityID` 内で `req.Header.Set("X-Internal-Auth", c.sharedSecret)` を設定

```go
type authHubClientImpl struct {
    authHubURL   string
    sharedSecret string
    httpClient   *http.Client
}

func NewKratosClient(authHubURL string, sharedSecret string) KratosClient { ... }
```

#### 2. `alt-backend/app/di/container.go`

DI コンテナで既存の `cfg.Auth.SharedSecret` を `NewKratosClient` に渡すように変更。

```go
kratosClientImpl := kratos_client.NewKratosClient(cfg.AuthHub.URL, cfg.Auth.SharedSecret)
```

#### 3. `alt-backend/app/driver/kratos_client/client_test.go`

- 全テストケースに `sharedSecret` フィールドを追加
- テストサーバーで `X-Internal-Auth` ヘッダーの値を検証するアサーションを追加
- `NewKratosClient` の呼び出しを新しいシグネチャに合わせて更新

### 変更ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `alt-backend/app/driver/kratos_client/client.go` | `sharedSecret` フィールド追加、ヘッダー設定 |
| `alt-backend/app/driver/kratos_client/client_test.go` | ヘッダー検証テスト追加 |
| `alt-backend/app/di/container.go` | DI でシークレットを注入 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `go test ./driver/kratos_client/...` | 3 tests passed |
| `go test ./...` (alt-backend 全体) | all passed |
| `go build ./...` | OK |
| コンテナ再ビルド・起動 | healthy |

### 本番検証手順

次回の article-sync 実行 (毎時 :56 分) 後に以下を確認:

1. auth-hub ログに `/internal/system-user` の 401 が出ないこと
2. pre-processor ログに article-sync の成功ログが出ること
3. pre-processor の pending summarization count > 0 になること
4. ダッシュボードの Summarized トレンドが上昇すること

### PROS

1. **最小限の変更**: 3 ファイル、実質的な変更はヘッダー設定の 1 行のみ
2. **既存パターンの活用**: 設定基盤とDIの仕組みをそのまま利用
3. **テスト可能**: テストサーバーでヘッダー値を検証
4. **Clean Architecture 準拠**: Driver レイヤーへの変更が上位レイヤーに影響しない

### CONS, TRADEOFF

1. **`NewKratosClient` のシグネチャ変更**: 呼び出し元の更新が必要 (DI コンテナ 1 箇所のみ)

## APPENDIX

### 関連 ADR

| ADR | 内容 | 関連 |
|-----|------|------|
| 196 | auth-hub InternalAuth ミドルウェア導入 | `X-Internal-Auth` ヘッダー検証の定義元 |
| 197 | alt-backend 内部 API エンドポイント | `/v1/internal/system-user` ルーティング |

### auth-hub InternalAuth ミドルウェアの検証フロー

```
リクエスト受信
  → X-Internal-Auth ヘッダー取得
  → len == 0 → 401 "missing internal auth header"
  → subtle.ConstantTimeCompare(provided, expected) != 1 → 403 "invalid internal auth"
  → 認証成功 → next handler
```
