# ADR-000244: article-sync パイプライン障害の段階的修正

## STATUS

Accepted

## CONTEXT

### 問題

ダッシュボードで Summarized トレンドが長時間ほぼ 0 で推移。Total Articles に対し Summarized の差分が埋まらない状態が継続した。alt-backend は unsummarized articles を認識しているが、pre-processor 側では pending summarization jobs が常に 0 を報告していた。

### 根本原因

2 つの独立した障害が直列に存在し、article-sync パイプラインを完全にブロックしていた。

**障害 1 (Phase 1):** `alt-backend` の `KratosClient.GetFirstIdentityID()` が auth-hub の `/internal/system-user` エンドポイントを呼び出す際に、`X-Internal-Auth` ヘッダーを付与していなかった。

**障害 2 (Phase 2):** Phase 1 修正後に顕在化。pre-processor が API モード (`BACKEND_API_URL` 設定済み) で起動しているが、`backend_api.ArticleRepository.FetchInoreaderArticles()` が未実装のスタブで `"requires direct database access (category B)"` エラーを返していた。

### 因果チェーン

```
article-sync ジョブ (毎時実行)
  → GetSystemUserID
      Phase 1: ❌ X-Internal-Auth ヘッダー欠落 → auth-hub 401
      修正後:  ✅ 認証成功
  → FetchInoreaderArticles
      Phase 2: ❌ スタブ実装 → "category B" エラー
      修正後:  ✅ DB 直接クエリで記事取得
  → UpsertArticles → summarize_job_queue にジョブ追加
  → summarization ポーリングで処理
```

### 影響範囲

- article-sync ジョブの毎時実行が全て失敗
- 新規記事の要約処理が完全に停止
- ダッシュボードの Summarized カウントが増加しない

## DECISION MAKING

### Phase 1: KratosClient に共有シークレットを注入

auth-hub の `InternalAuth` ミドルウェアは `X-Internal-Auth` ヘッダーに共有シークレットを要求する (constant-time comparison)。`KratosClient` がこのヘッダーを送信するように修正する。

シークレットは既存の設定基盤から取得し、DI コンテナ経由でクライアントに注入する。

| 代替案 | 却下理由 |
|--------|---------|
| auth-hub 側で認証を外す | セキュリティの後退 |
| 環境変数を直接クライアント内で読む | DI パターンに反する |
| IP ベースの許可リスト | コンテナ IP は動的 |

### Phase 2: FetchInoreaderArticles に DB 直接アクセスを追加

`bootstrap/wire.go` の分岐ロジック上、API モードでも `dbPool` は初期化済み (`wire.go:46`)。`inoreader_articles` テーブルは pre-processor 自身の DB に存在し、alt-backend の API では提供されていない。

`backend_api.ArticleRepository` に `dbPool` を渡し、既存の `driver.GetInoreaderArticles()` 関数を再利用する。

| 代替案 | 却下理由 |
|--------|---------|
| alt-backend に Inoreader 記事取得 API を追加 | 別サービスの DB を直接参照する設計になり、マイクロサービス境界が曖昧になる |
| API モード判定を外して Legacy DB モードに戻す | Connect-RPC 移行方針に反する |
| FetchInoreaderArticles を別のリポジトリに分離 | 過度な設計。1 メソッドのために新しいインターフェースを追加する価値がない |

## RESULTS, EFFECTS

### Phase 1 変更内容 (alt-backend)

#### 1. `alt-backend/app/driver/kratos_client/client.go`

- `authHubClientImpl` 構造体に `sharedSecret` フィールドを追加
- `NewKratosClient` のシグネチャに `sharedSecret` パラメータを追加
- `GetFirstIdentityID` 内で `X-Internal-Auth` ヘッダーを設定

#### 2. `alt-backend/app/di/container.go`

DI コンテナで既存の設定値を `NewKratosClient` に渡すように変更。

#### 3. `alt-backend/app/driver/kratos_client/client_test.go`

- 全テストケースに `sharedSecret` フィールドを追加
- テストサーバーでヘッダー値を検証するアサーションを追加

### Phase 2 変更内容 (pre-processor)

#### 4. `pre-processor/app/driver/backend_api/article_driver.go`

- `ArticleRepository` 構造体に `dbPool *pgxpool.Pool` フィールドを追加
- `NewArticleRepository` のシグネチャに `dbPool` パラメータを追加
- `FetchInoreaderArticles` のスタブ実装を `driver.GetInoreaderArticles(ctx, r.dbPool, since)` に置換

```go
type ArticleRepository struct {
    client *Client
    dbPool *pgxpool.Pool
}

func NewArticleRepository(client *Client, dbPool *pgxpool.Pool) *ArticleRepository { ... }

func (r *ArticleRepository) FetchInoreaderArticles(ctx context.Context, since time.Time) ([]*domain.Article, error) {
    return driver.GetInoreaderArticles(ctx, r.dbPool, since)
}
```

#### 5. `pre-processor/app/bootstrap/wire.go`

DI で既に初期化済みの `dbPool` を `NewArticleRepository` に渡すように変更。

```go
articleRepo = backend_api.NewArticleRepository(client, dbPool)
```

#### 6. `pre-processor/app/driver/backend_api/article_driver_test.go` (新規)

- `dbPool == nil` の場合にエラーを返すことを検証
- 構造体にフィールドが正しく保持されることを検証

### 変更ファイル一覧

| Phase | ファイル | 変更内容 |
|-------|----------|----------|
| 1 | `alt-backend/app/driver/kratos_client/client.go` | 内部認証ヘッダー設定 |
| 1 | `alt-backend/app/driver/kratos_client/client_test.go` | ヘッダー検証テスト追加 |
| 1 | `alt-backend/app/di/container.go` | DI でシークレットを注入 |
| 2 | `pre-processor/app/driver/backend_api/article_driver.go` | `dbPool` 追加、DB クエリ実装 |
| 2 | `pre-processor/app/bootstrap/wire.go` | DI で `dbPool` を渡す |
| 2 | `pre-processor/app/driver/backend_api/article_driver_test.go` | nil ガードテスト (新規) |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `go test ./driver/kratos_client/...` (alt-backend) | 3 tests passed |
| `go test ./...` (alt-backend 全体) | all passed |
| `go test ./driver/backend_api/...` (pre-processor) | 2 tests passed |
| `go test ./...` (pre-processor 全体) | all passed |
| コンテナ再ビルド・起動 | healthy |

### ランタイム検証結果

Phase 1 + Phase 2 修正後のログ確認:

| 検証項目 | 結果 |
|---------|------|
| auth-hub `/internal/system-user` 401 | 解消 |
| `"retrieved system user id"` | 成功 |
| `"FetchInoreaderArticles requires direct database access"` | 解消 |
| Inoreader 記事取得 | 成功 (記事のフィルタリング・サニタイゼーションまで到達) |

### 設計上のポイント

API モードの `ArticleRepository` は原則として Connect-RPC 経由で alt-backend と通信するが、`FetchInoreaderArticles` は例外的に DB 直接アクセスを行う。これは `inoreader_articles` テーブルが pre-processor 自身の DB にのみ存在し、alt-backend の管轄外であるため。`dbPool` は API モードでも初期化済み (ジョブキュー等で使用) であり、新たな依存は追加していない。

### PROS

1. **段階的修正**: 2 つの独立した障害を別々に特定・修正し、各段階でテスト検証
2. **既存コードの再利用**: `driver.GetInoreaderArticles()` をそのまま呼び出し、重複実装なし
3. **最小限の変更**: 各 Phase とも構造体フィールド追加 + DI 更新のみ
4. **Clean Architecture 準拠**: Driver レイヤー内の変更が上位レイヤーに影響しない

### CONS, TRADEOFF

1. **API モードの `ArticleRepository` が DB に依存**: 純粋な API クライアントではなくなるが、データの所在を考慮すると合理的
2. **コンストラクタのシグネチャ変更**: 呼び出し元の更新が必要 (各 Phase とも DI コンテナ 1 箇所のみ)

## APPENDIX

### 関連 ADR

| ADR | 内容 | 関連 |
|-----|------|------|
| 196 | auth-hub InternalAuth ミドルウェア導入 | `X-Internal-Auth` ヘッダー検証の定義元 |
| 197 | alt-backend 内部 API エンドポイント | `/v1/internal/system-user` ルーティング |

### auth-hub InternalAuth ミドルウェアの検証フロー

```
リクエスト受信
  → X-Internal-Auth ヘッダー取得
  → len == 0 → 401 "missing internal auth header"
  → subtle.ConstantTimeCompare(provided, expected) != 1 → 403 "invalid internal auth"
  → 認証成功 → next handler
```
