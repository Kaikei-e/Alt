# rask-log サイドカーのネットワークアーキテクチャ再設計

## ステータス

採択（Accepted）

## コンテキスト

`altctl up` コマンド実行時にログサイドカーコンテナが "Recreate" 状態でハングする問題が発生していた。

### 問題の症状

- `alt-meilisearch-logs-1` が "Recreate" で停止
- `alt-db-logs-1` が "Recreate" で停止
- `alt-rask-log-aggregator-1` が "Recreate" で停止
- 40秒以上経過しても完了しない

### 根本原因

1. **`network_mode: service:X` アーキテクチャの問題**
   - サイドカーがターゲットサービスのネットワーク名前空間を共有
   - ターゲット再作成時にサイドカーのネットワークが破棄される
   - `depends_on` との組み合わせに Docker Compose のバグ ([docker/compose#6329](https://github.com/docker/compose/issues/6329)) がある

2. **Grace Period 不整合**
   - Rust コードのシャットダウンタイムアウト: 10秒
   - Docker Compose の `stop_grace_period`: 5秒
   - Docker が SIGKILL を送信する前にグレースフルシャットダウンが完了しない

3. **重要な発見**
   - rask-log-forwarder は Docker API (Docker ソケット経由) でログ収集を行っている
   - ターゲットサービスとのネットワーク共有は**不要**
   - 必要なネットワーク接続は aggregator への HTTP 通信のみ

## 決定

### 1. `network_mode: service:X` を廃止し専用ネットワークに移行

```yaml
# 変更前
meilisearch-logs:
  network_mode: "service:meilisearch"

# 変更後
meilisearch-logs:
  networks:
    - alt-network
  depends_on:
    rask-log-aggregator:
      condition: service_healthy
```

### 2. rask-log-aggregator に healthcheck サブコマンドを追加

distroless イメージには curl がないため、バイナリ自体に healthcheck 機能を実装：

```rust
if std::env::args().nth(1).as_deref() == Some("healthcheck") {
    match healthcheck().await {
        Ok(()) => std::process::exit(0),
        Err(_) => std::process::exit(1),
    }
}
```

Docker Compose 設定：

```yaml
rask-log-aggregator:
  healthcheck:
    test: ["CMD", "/rask-log-aggregator", "healthcheck"]
    interval: 5s
    timeout: 3s
    retries: 3
    start_period: 10s
```

### 3. Grace Period を整合

- `stop_grace_period`: 5s → 12s
- Rust シャットダウンタイムアウト: 10s → 4s

### 検討した代替案

| 選択肢 | 概要 | 採否 |
|--------|------|------|
| A案: 専用ネットワークへの移行 | network_mode を廃止し alt-network を使用 | **採用** |
| B案: Grace Period のみ調整 | stop_grace_period を延長 | 不採用（根本原因が解決しない） |
| C案: 中央ログコレクター | Fluentd/Vector で一元収集 | 不採用（大規模な変更が必要） |

### A案採用の理由

- Docker API によるログ収集はネットワーク共有を必要としない
- サイドカーのライフサイクルがターゲットサービスから独立
- Docker Compose のバグを回避できる
- 変更が最小限で済む

## 結果

### 変更されたファイル

| ファイル | 変更内容 |
|---------|---------|
| `compose/logging.yaml` | network_mode 削除、networks/depends_on/healthcheck/stop_grace_period 追加 |
| `compose/auth.yaml` | auth-hub healthcheck を wget から binary subcommand に変更 |
| `rask-log-aggregator/app/src/main.rs` | healthcheck サブコマンド追加 |
| `rask-log-aggregator/app/src/healthcheck.rs` | healthcheck モジュール新規作成 |
| `rask-log-aggregator/app/src/lib.rs` | healthcheck エクスポート追加 |
| `rask-log-aggregator/app/Cargo.toml` | reqwest 依存追加 |
| `rask-log-forwarder/app/src/app/service.rs` | シャットダウンタイムアウト 10s → 4s |
| `auth-hub/main.go` | healthcheck サブコマンド追加 (distroless 対応) |

### 影響を受けるサイドカー (8つ)

- nginx-logs
- alt-backend-logs
- tag-generator-logs
- pre-processor-logs
- search-indexer-logs
- news-creator-logs
- meilisearch-logs
- db-logs

### メリット

1. **ハング問題の解消**: サービス再作成時のデッドロックが発生しない
2. **ライフサイクル分離**: サイドカーがターゲットサービスに依存しない
3. **堅牢な依存関係**: healthcheck による正確なサービス準備状態の確認
4. **デバッグ容易性**: サイドカーが独自のネットワーク識別子を持つ

### トレードオフ

1. **localhost アクセス不可**: ターゲットサービスの localhost ポートにアクセスできなくなる（現在は未使用）

## 検証計画

```bash
# 1. スタックを完全停止
make down-volumes

# 2. スタックを起動
altctl up core base ai auth db logging rag recap workers observability

# 3. Recreate がハングしないことを確認

# 4. healthcheck 動作確認
docker inspect --format='{{.State.Health.Status}}' alt-rask-log-aggregator-1

# 5. 再起動テスト
docker compose restart meilisearch
# meilisearch-logs は影響を受けず継続稼働
```

## 実装日

2026-01-10

## 関連

- [Docker Compose network_mode + depends_on バグ](https://github.com/docker/compose/issues/6329)
- [Docker Compose healthcheck ドキュメント](https://docs.docker.com/reference/compose-file/services/#healthcheck)
