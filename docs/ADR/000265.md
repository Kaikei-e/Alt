# ADR-000265: Quality Check バッチジョブによる BE スロット独占の解消

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000264 で LIFO スケジューリングを導入し、スワイプフィードの体感レイテンシを改善した。しかし、依然として非同期要約リクエストが「詰まる」現象が発生していた。

ログ調査の結果、根本原因は Quality Check バッチジョブが BE（Best-Effort）セマフォスロットを長時間独占し、Queue Worker（非同期要約処理）がスロットを取得できないことだと判明した。

### 問題の構造

リソース構成として、LLM 推論エンジンの並列数は GPU メモリ制約により 2 に制限されている。セマフォは RT（Real-Time）用に 1 スロット、BE（Best-Effort）用に 1 スロットを割り当てている。

```
Quality Check バッチ処理:  40 記事 × ~4s/記事 = ~160s (2.7 分) 連続で BE スロットを占有
ジョブ間隔:                5 分
→ 5 分のうち約 2.7 分間、BE スロットが Quality Check に独占
→ Queue Worker は BE スロットを取得できず待機
→ ErrServiceOverloaded → バックオフ発動 (30s → 60s → ...) → 回復がさらに遅延
```

### 処理フロー

```
pre-processor (Go)                     news-creator (Python)                  LLM Engine
┌──────────────────┐                   ┌──────────────────────┐              ┌─────────┐
│ Quality Checker   │──POST /generate──→│ generate_handler     │              │         │
│ (40 articles      │   priority: low   │ → semaphore acquire  │──BE slot────→│ Inference│
│  sequential loop) │                   │                      │              │         │
│                   │                   │                      │              │         │
│ Queue Worker      │──POST /summarize─→│ summarize_handler    │              │         │
│ (pending jobs)    │   priority: low   │ → semaphore acquire  │──(BLOCKED)──→│         │
└──────────────────┘                   └──────────────────────┘              └─────────┘
```

### ログ証拠

news-creator 側で `queue_wait` が TTFT を支配していた:

```
TTFT breakdown: total=28.2s, queue_wait=27.6s, prompt_eval=0.6s
Acquired semaphore (LOW PRIORITY), queue_wait_time_seconds=10.2
Acquired semaphore (LOW PRIORITY), queue_wait_time_seconds=15.8
```

## 意思決定

3 つの補完的な変更を同時に適用する。

### 変更 1: Quality Check バッチサイズ削減 (40 → 10)

| 選択 | 不採用案 | 理由 |
|------|---------|------|
| バッチサイズ 10 | バッチサイズ 40（現状維持） | BE スロット独占時間が ~160s → ~40s に短縮 |
| バッチサイズ 10 | バッチサイズ 1 | 品質チェックのスループットが過度に低下する |

### 変更 2: Quality Check ループに inter-item delay (3s) を追加

| 選択 | 不採用案 | 理由 |
|------|---------|------|
| `time.After(3s)` + `ctx.Done()` | delay なし | 連続的なスロット占有を防ぎ、Queue Worker がスロットを取得できる隙間を作る |
| `time.After(3s)` + `ctx.Done()` | 別 goroutine で並列化 | Quality Check は低優先度の補助処理であり、並列化は過剰 |

各 Quality Check LLM リクエスト間に 3 秒のインターバルを挿入する。`select` で `ctx.Done()` も監視し、コンテキストキャンセルに即座に応答する。

### 変更 3: Queue Worker バックオフ初期値を短縮 (30s → 15s)

| 選択 | 不採用案 | 理由 |
|------|---------|------|
| InitialBackoff 15s | 30s（現状維持） | Quality Check バッチ完了後、より早く要約処理を再開できる |
| InitialBackoff 15s | 5s | 過度に短いとリトライノイズが増加する |

## 結果・影響

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `pre-processor/app/bootstrap/wire.go` | `batchSize` 40 → 10 |
| `pre-processor/app/service/quality_checker.go` | for ループ内に 3s inter-item delay を追加（`ctx.Done()` 対応） |
| `pre-processor/app/handler/job_handler.go` | Queue Worker `InitialBackoff` 30s → 15s |

### 改善効果の推定

| 指標 | 変更前 | 変更後 |
|------|--------|--------|
| Quality Check バッチ処理時間 | ~160s (40 × 4s) | ~70s (10 × 4s + 9 × 3s delay) |
| BE スロット連続占有時間 | ~4s × 40 = 連続 160s | 最大 ~4s（1 記事分、間に 3s の空き） |
| Queue Worker 回復時間 | 30s（初回バックオフ） | 15s |
| 5 分サイクル中の空き時間 | ~2.3 分 | ~4.8 分 |

### テスト結果

| テストスイート | 結果 |
|--------------|------|
| `pre-processor/app` 全パッケージ (`go test ./...`) | 全件 PASS |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| コンテナ再ビルド (`--build pre-processor`) | ビルド成功 |
| コンテナ起動 | Started |
| 全ジョブ起動ログ (article-sync, summarization, quality-check, queue-worker) | 確認済み |
| Queue Worker 動作 (`retrieved pending summarization jobs`) | 10s 間隔で正常動作 |

### PROS

- Quality Check によるスロット独占が解消され、Queue Worker が安定してスロットを取得可能に
- 3s の inter-item delay により、バッチ処理中でも他の BE リクエストが割り込める
- バックオフ初期値短縮により、一時的なスロット不足からの回復が高速化
- コンテキストキャンセル対応により、シャットダウン時に delay でブロックされない
- Quality Check の 5 分間隔・品質チェックロジック自体は変更なし

### CONS, TRADEOFF

- Quality Check のスループットが低下する（40 記事/5 分 → 10 記事/5 分）。ただし品質チェックは補助的なバッチ処理であり、リアルタイム性は不要
- inter-item delay は固定値（3s）であり、負荷状況に応じた動的調整は行わない。将来的に adaptive な制御が必要になる可能性がある

### 影響範囲

- **pre-processor**: Quality Check バッチサイズ、inter-item delay、Queue Worker バックオフの 3 箇所のみ
- **news-creator**: 変更なし（セマフォのスロット取得頻度が改善されるのみ）
- **alt-frontend-sv**: 変更なし
- **alt-backend**: 変更なし
- **他サービス**: 変更なし

## 付録

### BE スロットのタイムライン比較

```
変更前 (batch=40, delay=0):
|===QC===QC===QC===...===QC| (40件連続, ~160s)  |----空き----|  (5分サイクル)
                                                   ↑ Queue Worker はここでしか処理できない

変更後 (batch=10, delay=3s):
|=QC=|..3s..|=QC=|..3s..|=QC=| ... (10件, ~70s)  |------空き------|
      ↑            ↑
      Queue Worker がスロットを取得できるタイミング
```

## 関連 ADR

- ADR-000264: Summary Request FIFO→LIFO — Swipe Feed 体感レイテンシ最適化
