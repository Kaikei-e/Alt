# Desktop Settings/Feeds ページの実装

## ステータス

採択（Accepted）

## コンテキスト

デスクトップ版の Settings/Feeds ページ（フィードリンク管理画面）が未実装であった。モバイル版（`/sv/mobile/feeds/manage`）は既に完全な実装が存在していたため、これを参考にデスクトップ版を実装する必要があった。

### 既存のモバイル版機能

- RSS フィードURL の追加（バリデーション付き）
- 登録済みフィードリンクの一覧表示
- フィードリンクの削除（確認ダイアログ付き）
- 成功/エラーメッセージの表示
- リフレッシュ機能

### デスクトップ版の要件

- モバイル版と同等の機能を提供
- デスクトップ向けのレイアウトとUIパターンに適応
- 既存のデスクトップコンポーネント（`PageHeader`, `Dialog`）を活用

## 決定

### アーキテクチャ

モバイル版をベースに、以下の変更を加えてデスクトップ版を実装した。

| 項目 | モバイル版 | デスクトップ版 |
|------|-----------|---------------|
| ヘッダー | カスタム（ArrowLeft, Home） | `PageHeader` コンポーネント |
| ナビゲーション | `FloatingMenu` | Sidebar（既存） |
| 削除ダイアログ | カスタムオーバーレイ | `Dialog` UIコンポーネント |
| レイアウト | 1カラム（max-w-xl） | 2カラムグリッド |
| フィード件数 | なし | バッジ表示 |

### ファイル構成

```
src/routes/desktop/settings/feeds/
├── +page.server.ts  # SSR データ取得
└── +page.svelte     # ページコンポーネント
```

### SSR とクライアントサイドのハイブリッド

- **初期ロード**: `+page.server.ts` で SSR 時にフィードリンク一覧を取得
- **操作時**: Connect-RPC 経由でクライアントサイドから API を呼び出し
- **リフレッシュ**: クライアントサイドで再取得

```typescript
// +page.server.ts
export const load: ServerLoad = async ({ request }) => {
  const cookieHeader = request.headers.get("cookie") || "";
  const feedLinks = await getFeedLinks(cookieHeader);
  return { feedLinks };
};
```

### UIレイアウト

```
+--------------------------------------------------+
| PageHeader: Manage Feed Links                    |
| Description: Add, edit, or remove RSS sources    |
+--------------------------------------------------+
|                                                  |
| +--------------------+  +----------------------+ |
| | Add New Feed       |  | Registered Feeds [3] | |
| |                    |  |                      | |
| | URL: [__________]  |  | - feed1.xml    [X]   | |
| | [Add Feed]         |  | - feed2.xml    [X]   | |
| |                    |  | - feed3.xml    [X]   | |
| +--------------------+  +----------------------+ |
|                                                  |
+--------------------------------------------------+
```

### テスト戦略（TDD）

E2E テストを Playwright で実装し、以下のシナリオをカバー：

1. **表示系テスト**
   - ページタイトルと説明文の表示
   - 登録済みフィードリンクの一覧表示
   - 空状態の表示

2. **バリデーションテスト**
   - 空URLでのエラー
   - 無効なURL形式でのエラー
   - フィードらしくないURLでのエラー

3. **操作系テスト**
   - フィード登録成功/失敗
   - 削除確認ダイアログの表示
   - 削除キャンセル
   - 削除成功
   - リフレッシュボタンの動作

### モックデータ

E2E テスト用のモックデータを `tests/e2e/fixtures/mockData.ts` に追加：

```typescript
export const RSS_FEED_LINKS_LIST_RESPONSE = {
  links: [
    { id: "feed-link-1", url: "https://example.com/feed.xml" },
    { id: "feed-link-2", url: "https://blog.example.org/rss" },
    { id: "feed-link-3", url: "https://news.site.com/atom.xml" },
  ],
};

export const CONNECT_RSS_PATHS = {
  listRSSFeedLinks: "**/api/v2/alt.rss.v2.RSSService/ListRSSFeedLinks",
  registerRSSFeed: "**/api/v2/alt.rss.v2.RSSService/RegisterRSSFeed",
  deleteRSSFeedLink: "**/api/v2/alt.rss.v2.RSSService/DeleteRSSFeedLink",
};
```

## 結果

### 変更されたファイル

| カテゴリ | ファイル | 変更内容 |
|---------|---------|---------|
| **ページ実装** | | |
| | `src/routes/desktop/settings/feeds/+page.server.ts` | 新規作成：SSR データ取得 |
| | `src/routes/desktop/settings/feeds/+page.svelte` | 更新：完全な機能実装 |
| **テスト** | | |
| | `tests/e2e/desktop/settings/feeds.spec.ts` | 新規作成：E2E テスト（13ケース） |
| | `tests/e2e/fixtures/mockData.ts` | 追加：RSS 関連モックデータ |

### テスト結果

```
E2E テスト: 26 passed (desktop-chromium + desktop-webkit)
ユニットテスト: 108 passed
型チェック: 0 errors
```

### メリット

1. **コード再利用**: モバイル版のロジック（バリデーション、API呼び出し）を流用
2. **一貫したUX**: デスクトップ版の他のページと同じパターン（`PageHeader`, `Dialog`）を使用
3. **テストカバレッジ**: 主要なユーザーフローをE2Eテストでカバー
4. **SSR対応**: 初期ロードでサーバーサイドレンダリングを活用

### トレードオフ

1. **SSR テストの制約**: `page.route` は SSR リクエストをモックできないため、リフレッシュボタンでクライアントサイド取得をトリガーする必要がある
2. **重複コード**: モバイル版と一部のロジックが重複（将来的に共通化の余地あり）

## 技術的な学び

1. **SvelteKit SSR と E2E テスト**: Playwright の `page.route` はブラウザリクエストのみをインターセプトし、SSR 時のサーバーサイドリクエストはモックサーバーで対応する必要がある

2. **Dialog コンポーネントの活用**: shadcn/ui の Dialog コンポーネントは `open` と `onOpenChange` で制御する

3. **ボタンセレクタの精度**: 複数のボタンがある場合、`{ exact: true }` オプションで厳密マッチングが必要

## 実装日

2026-01-10

## 関連

- [SvelteKit Server-Side Rendering](https://svelte.dev/docs/kit/page-options#ssr)
- [Playwright Route Interception](https://playwright.dev/docs/network#handle-requests)
- [shadcn-svelte Dialog](https://www.shadcn-svelte.com/docs/components/dialog)
