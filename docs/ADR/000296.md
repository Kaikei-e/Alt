# ADR-000296: 403エラーに対する指数バックオフリトライと自動無効化

## ADR's STATUS

Accepted（ADR-000290の後続改善）

## CONTEXT

ADR-000290 で HEAD リクエストを廃止し、GET リクエストのみでフィード収集を行うように変更した。その際、403 を `isPersistentError` から除外した（HEAD 特有の誤検知を回避するため）。

しかし HEAD 廃止後、GET で返る 403 は本物のアクセス拒否である可能性が高い。現状の実装では以下の問題があった:

- 403 を返すフィードに対して無限にリクエストを送り続ける
- 手動でしか無効化できない
- WAF やレートリミットによる一時的な 403 と、恒久的なアクセス拒否を区別できない

## DECISION MAKING

### 方針: リトライで一時的/恒久的を判別し、既存メカニズムで自動無効化

403 受信時に指数バックオフで最大3回リトライし、それでも 403 なら persistent エラーとして扱う。これにより既存の `maxConsecutiveFailures=5` メカニズムによって自動無効化される。

### 1. `fetchWithRetryOn403` 関数の追加

フェッチ関数を引数に取るラッパーとして設計し、テスト容易性を確保した。

```go
func fetchWithRetryOn403(ctx context.Context, fetchFn func() (*rssFeed.Feed, error), feedURL string) (*rssFeed.Feed, error)
```

- 初回フェッチが 403 以外（成功含む）ならそのまま返す
- 403 の場合、指数バックオフ（1秒, 2秒, 4秒）で最大3回リトライ
- リトライ中に成功すれば即座に返す
- context キャンセルを尊重し、即座に中断可能

### 2. `isPersistentError` に 403 を再追加

`fetchWithRetryOn403` がリトライを使い切った後にのみ `handleFeedError` に到達するため、この時点で 403 を persistent として安全に扱える。

### 3. `is403Error` ヘルパー関数の追加

エラーメッセージに "403" を含むかで判定する。`is429Error` と同じパターンに従う。

## RESULTS, EFFECTS

### 変更後のフロー

```
GET リクエスト
  ├─ 200 OK → 成功、consecutive_failures リセット
  ├─ 403 Forbidden → 指数バックオフリトライ (1s, 2s, 4s)
  │     ├─ リトライ中に成功 → 成功、consecutive_failures リセット
  │     └─ 3回リトライ全失敗 → isPersistentError=true
  │           → consecutive_failures++
  │           → 5回連続で is_active=false（自動無効化）
  ├─ 429 → rate limiter バックオフ（既存）
  ├─ 400/404 → isPersistentError=true（既存）
  └─ 5xx/timeout → 一時エラー、カウント対象外（既存）
```

### PROS

- **一時的な403の救済**: WAF やレートリミットによる一時的な 403 をリトライで回復可能
- **恒久的な403の自動無効化**: 真のアクセス拒否を検出し、手動介入なしで無効化
- **無駄なリクエストの削減**: 403 を返し続けるフィードへのリクエストが自動停止
- **既存メカニズムの活用**: `maxConsecutiveFailures` の仕組みをそのまま利用し、新たな状態管理を追加しない
- **TDDで品質担保**: 12件のテストを追加（`TestIs403Error` 4件、`TestFetchWithRetryOn403` 6件、`TestIsPersistentError` 修正2件）

### CONS, TRADEOFF

- **リトライによる遅延**: 403 の場合、最大7秒（1+2+4）の追加遅延が発生する。ただし収集は順次処理のため、他フィードの処理を大幅にブロックすることはない
- **リトライによる追加リクエスト**: 1フィードあたり最大4回（初回+3リトライ）のリクエストが発生する。ただし指数バックオフにより対象サーバーへの負荷は制限される

## APPENDIX

### 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/job/feed_collector.go` | `is403Error`, `fetchWithRetryOn403` 追加、`isPersistentError` に 403 再追加、`CollectMultipleFeeds` のフェッチ呼び出しをラップ |
| `alt-backend/app/job/feed_collector_test.go` | `TestIs403Error`, `TestFetchWithRetryOn403` 追加、`TestIsPersistentError` の 403 ケース修正 |

### テスト

| テスト名 | 検証内容 |
|---------|---------|
| `TestIs403Error/nil_error_returns_false` | nil に対して false を返すこと |
| `TestIs403Error/403_Forbidden_returns_true` | 403 エラーを正しく検出すること |
| `TestIs403Error/404_Not_Found_returns_false` | 403 以外のエラーに反応しないこと |
| `TestFetchWithRetryOn403/first_attempt_succeeds_without_retry` | 初回成功時にリトライしないこと |
| `TestFetchWithRetryOn403/403_on_first_attempt_then_succeeds_on_retry` | 1回のリトライで回復すること |
| `TestFetchWithRetryOn403/403_three_times_then_succeeds_on_fourth_attempt` | 3回リトライ後に成功すること |
| `TestFetchWithRetryOn403/403_on_all_attempts_returns_error` | 全リトライ失敗時に 403 エラーを返すこと |
| `TestFetchWithRetryOn403/non-403_error_does_not_retry` | 403 以外のエラーでリトライしないこと |
| `TestFetchWithRetryOn403/context_cancellation_stops_retry` | context キャンセルで即座に中断すること |

### 関連ADR

- ADR-000290: HEAD リクエスト廃止とフィード収集の改善
