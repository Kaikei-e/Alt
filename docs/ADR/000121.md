# バッチサマリーチャンクサイズの環境変数化

## ADR's STATUS

Accepted

## CONTEXT

### 背景

recap-workerのDispatchステージでは、news-creatorへのバッチサマリーAPI呼び出し時にリクエストをチャンク分割して処理している。このチャンクサイズが50件でハードコードされていた。

### 問題

バッチ処理のタイムアウト設定は `summary_timeout * 3`（デフォルト1800秒 = 30分）だが、50件のバッチ処理が30分でタイムアウトするケースが発生していた。

**処理時間の見積もり:**

| チャンクサイズ | 1件あたり処理時間 | 合計処理時間 |
|---------------|------------------|-------------|
| 50件 | 8-16秒 | 400-800秒（最低ライン） |
| 50件（リトライ含む） | 12-24秒 | 600-1200秒 |

LLMのrepetition detection + retryにより実際の処理時間は見積もりの1.5-2倍になることがあり、30分のタイムアウトに収まらないケースがあった。

## DECISION MAKING

### 解決策

`BATCH_SUMMARY_CHUNK_SIZE` をハードコードから環境変数 `RECAP_BATCH_SUMMARY_CHUNK_SIZE` に変更し、運用環境に応じて調整可能にする。

### 実装

#### 1. config.rs

```rust
// BasicConfig に追加
batch_summary_chunk_size: usize,

// 環境変数パース
let batch_summary_chunk_size = parse_usize("RECAP_BATCH_SUMMARY_CHUNK_SIZE", 25)?;

// getter
pub fn batch_summary_chunk_size(&self) -> usize {
    self.batch_summary_chunk_size
}
```

#### 2. dispatch.rs

```rust
// Before:
const BATCH_SUMMARY_CHUNK_SIZE: usize = 50;

// After:
let batch_summary_chunk_size = self.config.batch_summary_chunk_size();
```

### デフォルト値の選定

| 値 | 処理時間（12秒/件） | タイムアウト（30分）との余裕 |
|----|-------------------|--------------------------|
| 50 | 600秒（10分） | 余裕なし（リトライで超過リスク） |
| 25 | 300秒（5分） | 25分の余裕（推奨） |
| 20 | 240秒（4分） | 26分の余裕 |

**デフォルト値: 25** を採用。リトライを考慮しても30分のタイムアウト内に十分収まる。

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `recap-worker/src/config.rs` | `batch_summary_chunk_size` フィールド・getter追加 |
| `recap-worker/src/pipeline/dispatch.rs` | ハードコード定数を削除、config参照に変更 |
| `recap-worker/ENVIRONMENT.md` | 環境変数ドキュメント追加 |

### 環境変数

| 変数名 | デフォルト値 | 説明 |
|--------|-------------|------|
| `RECAP_BATCH_SUMMARY_CHUNK_SIZE` | `25` | バッチAPI呼び出しあたりのサマリーリクエスト数 |

### PROS

1. **タイムアウト回避**: デフォルト25件で処理時間に余裕が生まれる
2. **運用調整可能**: 環境変数で調整できるため、LLMの処理速度に応じて最適化可能
3. **後方互換性**: 環境変数未設定時はデフォルト25件で動作

### CONS, TRADEOFF

1. **API呼び出し回数増加**: チャンクサイズを小さくするとAPI呼び出し回数が増える（50件→25件で2倍）
2. **オーバーヘッド**: 各チャンク間のオーバーヘッドが増加する可能性

## APPENDIX

### 検証方法

```bash
# 環境変数を設定して再起動
export RECAP_BATCH_SUMMARY_CHUNK_SIZE=25
docker compose -f compose/compose.yaml -p alt up -d recap-worker

# ログでチャンクサイズ確認
docker compose -f compose/compose.yaml -p alt logs recap-worker -f | grep "chunk_size"
```

### 関連ADR

- ADR-91: Dispatch Stage Result Types
