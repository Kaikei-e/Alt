# RAG Streaming API - LLM使用ソースのみを返却する修正

## ADR's STATUS

Accepted

## CONTEXT

RAG Streaming APIのレスポンスで、Sourcesセクションに重複したソースが表示される問題が発生していた。

例：
- Sources [2]-[5] が同じ記事
- Sources [8]-[10] が同じ記事

期待される動作は、LLMが回答生成時に**実際に参照したソースのみ**を表示すること。

## DECISION MAKING

### 問題の原因

Connect-RPCハンドラの`StreamEventKindDone`処理で、`output.Citations`（LLMが実際に使用した引用）ではなく`output.Contexts`（検索結果全体）をUIに送信していた。

```go
// 修正前（問題のコード）
citations := h.convertContextsToCitations(output.Contexts)  // 検索結果全体を返却
```

RAGパイプラインでは、検索フェーズで取得した全コンテキスト（`Contexts`）と、LLMが実際に回答で参照したソース（`Citations`）を区別して保持している。しかし、最終レスポンス構築時に誤って前者を使用していた。

### 解決策

1. `convertCitationsToProtoCitations`メソッドを追加し、`usecase.Citation`から`morningletterv2.Citation`への変換を実装
2. `StreamEventKindDone`の処理で`output.Citations`を使用するように変更

```go
// 修正後
citations := h.convertCitationsToProtoCitations(output.Citations)  // LLM使用分のみ返却
```

## RESULTS, EFFECTS

### PROS

- **重複解消**: 同じ記事が複数回表示される問題が解消
- **精度向上**: LLMが実際に参照したソースのみが表示され、ユーザーにとって有用な情報に絞られる
- **帯域削減**: 不要なソース情報を送信しないためレスポンスサイズが削減

### CONS, TRADEOFF

- **検索結果の可視性低下**: 検索で取得したが回答に使用されなかったソースはUIに表示されない
  - ただし、これは意図された動作であり、ユーザー体験の観点からは改善

## APPENDIX

### 変更ファイル

- `rag-orchestrator/internal/adapter/connect/morning_letter/handler.go`

### 関連する型定義

- `usecase.Citation`: LLMが参照したソース情報（ChunkID, URL, Title等）
- `usecase.ContextItem`: 検索で取得した全コンテキスト情報
- `AnswerWithRAGOutput.Citations`: LLMが参照したソースのリスト
- `AnswerWithRAGOutput.Contexts`: 検索結果の全コンテキストリスト
