# ADR-000308: 画像プロキシのドメイン許可リストにサブドメインマッチングを導入

## ADR's STATUS

Accepted

## CONTEXT

ADR-000307 で導入した OGP 画像プリフェッチ機構により、フィード収集時に RSS XML から画像 URL を抽出し `feeds.og_image_url` に保存、バックグラウンドジョブで画像をキャッシュする仕組みが稼働した。しかし、画像プロキシ経由での表示時にドメイン許可チェックで拒否されるケースが多発していた。

### 根本原因

画像プロキシの `DynamicDomainGateway.IsAllowedImageDomain` は、フィード購読ドメインとの**完全一致**のみで許可判定を行っていた。RSS フィードの画像 URL は、フィード配信ドメインとは異なる CDN サブドメインでホストされることが一般的であり、これらが許可リストに含まれなかった。

### 具体例

| 購読フィードのドメイン | 画像ホスト（ブロックされていた） | 関係 |
|----------------------|-------------------------------|------|
| `dev.to` | `media2.dev.to` | サブドメイン |
| `hackernoon.com` | `cdn.hackernoon.com` | サブドメイン |
| `www.wired.com` | `media.wired.com` | 兄弟サブドメイン |
| `feeds.bbci.co.uk` | `ichef.bbci.co.uk` | 兄弟サブドメイン |

DB 上の画像ドメイン分布を調査した結果、上位に位置するドメインの多くがこのパターンに該当していた。

## DECISION MAKING

### 方針: 購読ドメインの親ドメインインデックス + ホスト名のサブドメインウォーキングによる許可判定

2つの仕組みを `DynamicDomainGateway` に追加した。

#### 1. 親ドメインインデックス（キャッシュ構築時）

購読ドメインセットの構築時に、各ドメインの親ドメインもインデックスに追加する。これにより兄弟サブドメインの照合が可能になる。

```
www.wired.com → wired.com も追加
feeds.bbci.co.uk → bbci.co.uk も追加
```

2ラベル以上のドメインのみ追加し、`co.uk` や `com` のような過度に広いエントリは生成しない。

#### 2. サブドメインウォーキング（照合時）

画像ホスト名を検証する際に、ラベルを1つずつ剥がして親ドメインを順に照合する。

```
media2.dev.to → dev.to（マッチ）
cdn.hackernoon.com → hackernoon.com（マッチ）
media.wired.com → wired.com（親ドメインインデックスでマッチ）
ichef.bbci.co.uk → bbci.co.uk（親ドメインインデックスでマッチ）
```

### 他の選択肢を採用しなかった理由

- **ワイルドカード登録（`*.dev.to`）**: 購読ドメインが動的に変化するため、ワイルドカードパターンの管理が煩雑
- **Public Suffix List を用いた eTLD+1 マッチング**: 外部データセットへの依存が増え、`co.uk` 等の特殊ケースの更新が必要。親ドメインインデックスで十分カバーできる
- **画像 URL のドメインを個別に許可リストへ追加**: 画像ドメインは事前に網羅できず、新しい CDN サブドメインが出現するたびに対応が必要

## RESULTS, EFFECTS

### PROS

- 購読フィードに関連する画像 CDN サブドメインが自動的に許可される
- 既存の静的 CDN リスト（`cloudfront.net`、`imgix.net` 等）との併用で高いカバレッジ
- 2ラベル制限により `com`、`co.uk` のような過度に広い許可を防止
- TDD で 9 ケースのサブドメインマッチングテストを追加済み

### CONS, TRADEOFF

- 親ドメインインデックスにより、購読ドメインの兄弟サブドメインが暗黙的に許可される（例: `www.wired.com` を購読すると `evil.wired.com` も許可）。ただし、画像プロキシは HMAC 署名付き URL でアクセス制御されており、任意のドメインの画像を直接リクエストすることはできない
- キャッシュされるドメインセットのサイズが約2倍に増加する（親ドメインの追加分）。購読フィード数（数十〜数百）を考慮すると実用上問題ない

## APPENDIX

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `alt-backend/app/gateway/image_proxy_gateway/dynamic_domain_gateway.go` | `getSubscriptionDomains` に親ドメインインデックス追加、`IsAllowedImageDomain` にサブドメインウォーキング追加 |
| 2 | `alt-backend/app/gateway/image_proxy_gateway/dynamic_domain_gateway_test.go` | `TestDynamicDomainGateway_SubdomainMatching`（9ケース）追加、既存テストの期待値更新 |

### テスト

| # | テスト | 結果 |
|---|--------|------|
| 1 | `TestDynamicDomainGateway_SubdomainMatching`（9ケース） | PASS |
| 2 | `TestDynamicDomainGateway_SubscriptionDomains`（更新済み） | PASS |
| 3 | `TestDynamicDomainGateway_StaticCDNDomains` | PASS |
| 4 | `TestDynamicDomainGateway_OGPImageDomains` | PASS |
| 5 | `TestDynamicDomainGateway_CachesResult` | PASS |
| 6 | `alt-backend`: `go test ./...` | 全テスト PASS |

### 検証結果

- コンテナ再ビルド・起動後、ドメイン拒否エラー: **0件**
- `image_proxy_cache` にキャッシュされたドメイン: `i.guim.co.uk`、`www.androidauthority.com`、`internet.watch.impress.co.jp` 等、以前ブロックされていたサブドメインが正常にキャッシュ済み
