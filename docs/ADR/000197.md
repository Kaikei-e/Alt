# auth-hub Clean Architecture リファクタリングとセキュリティ強化

## ADR's STATUS

Accepted (Phase 0-1, Phase 5 実装完了)

## CONTEXT

### 問題点

auth-hub は Nginx `auth_request` と Ory Kratos を橋渡しする Identity-Aware Proxy (Go 1.25, Echo v4)。運用の中で以下の構造的・セキュリティ課題が顕在化:

| # | 分類 | 問題 |
|---|------|------|
| 1 | アーキテクチャ | フラットな構造 (`handler/`, `client/`, `cache/`, `token/`) で Clean Architecture 未適用。ハンドラーにビジネスロジックが混在 |
| 2 | セキュリティ | `BackendTokenSecret` のバリデーション不在。`/internal/system-user` に認証なし。レート制限なし。セキュリティヘッダー未設定 |
| 3 | エラーハンドリング | `strings.Contains(err.Error(), ...)` による脆弱なエラー判定。ドメインエラー型の不在 |
| 4 | テスト | JWT トークン生成・検証のテスト不在。CSRF ハンドラーの HTTP レベルテスト不在。ミドルウェアテスト不在 |
| 5 | コード品質 | 日本語コメントの混在。ログフィールド名の不正確さ (`session_id_hash` が実際にはプレフィックス) |
| 6 | 起動・停止 | 手動 `chan os.Signal` + goroutine によるシャットダウン。OTel 初期化失敗時のサイレント無視 |

### 方針

Phase 0 (セキュリティ緊急修正) と Phase 1 (Clean Architecture 移行) を優先実施。各ステップで `go test ./... -race` 全パスをゲーティング条件とする。旧コードは後方互換性のため保持し、新アーキテクチャを `internal/` + `cmd/auth-hub/` に構築。

## DECISION MAKING

### Phase 0: セキュリティ緊急修正

#### 0-1. BackendTokenSecret バリデーション追加

`config.Validate()` に最低 32 文字の必須チェックを追加。空値・短い値でアプリケーション起動を拒否する。

#### 0-2. IP ベースレート制限

`golang.org/x/time/rate` の Token Bucket でエンドポイント別のレート制限を実装:

| エンドポイント | 制限 | バースト |
|---------------|------|---------|
| `/validate` | 100 req/min | 10 |
| `/session` | 30 req/min | 5 |
| `/csrf` | 10 req/min | 3 |
| `/internal/*` | 10 req/min | 3 |

429 応答時に `Retry-After` ヘッダーを返却。IP 別の limiter は 5 分間のアイドルで自動クリーンアップ。

#### 0-3. セキュリティヘッダーミドルウェア

全レスポンスに以下のヘッダーを付与:

```
Strict-Transport-Security: max-age=63072000; includeSubDomains; preload
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
Content-Security-Policy: default-src 'none'; frame-ancestors 'none'
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: camera=(), microphone=(), geolocation=()
Cache-Control: no-store, no-cache, must-revalidate, private
```

#### 0-4. 内部エンドポイントのアクセス制御

`/internal/*` ルートグループに `X-Internal-Auth` ヘッダーによる共有シークレット認証を追加。`crypto/subtle.ConstantTimeCompare` でタイミング攻撃を防止。

#### 0-5. タイミング攻撃対策

内部認証ミドルウェアでの秘密値比較に定数時間比較を適用（0-4 に統合）。

### Phase 1: Clean Architecture 移行

#### ディレクトリ構造

```
auth-hub/
├── cmd/auth-hub/main.go          # エントリポイント + DI 配線
├── internal/
│   ├── domain/                    # エンティティ・エラー・ポート (依存ゼロ)
│   │   ├── session.go             # Identity, CachedSession
│   │   ├── errors.go              # ドメインセンチネルエラー
│   │   └── port.go                # SessionValidator, SessionCache, TokenIssuer 等
│   ├── usecase/                   # ビジネスロジック
│   │   ├── validate_session.go    # セッション検証 (キャッシュスルー)
│   │   ├── get_session.go         # セッション情報取得 + JWT 生成
│   │   ├── generate_csrf.go       # CSRF トークン生成
│   │   └── get_system_user.go     # システムユーザー取得
│   ├── adapter/
│   │   ├── handler/               # HTTP ハンドラー (Echo)
│   │   │   ├── validate.go, session.go, csrf.go, health.go, internal.go
│   │   │   └── error_mapper.go    # ドメインエラー → HTTP ステータス変換
│   │   └── gateway/
│   │       └── kratos.go          # Kratos クライアント (SessionValidator + IdentityProvider 実装)
│   └── infrastructure/
│       ├── cache/session_cache.go  # domain.SessionCache 実装
│       └── token/
│           ├── jwt.go             # domain.TokenIssuer 実装
│           └── csrf.go            # domain.CSRFTokenGenerator 実装
├── middleware/                    # セキュリティ・レート制限・OTel ミドルウェア
├── config/                        # 設定管理
├── handler/                       # 旧ハンドラー (後方互換)
├── main.go                        # 旧エントリポイント (後方互換)
└── Dockerfile                     # cmd/auth-hub からビルド
```

#### レイヤー間の依存方向

```
cmd/auth-hub/main.go (DI container)
  ├── adapter/handler/ → usecase/ → domain/port (interface only)
  ├── adapter/gateway/ implements domain/port
  └── infrastructure/ implements domain/port
```

#### ドメインエラー戦略

`strings.Contains(err.Error(), "authentication failed")` を `errors.Is(err, domain.ErrAuthFailed)` に置換。エラーマッパーで HTTP ステータスに変換:

| ドメインエラー | HTTP ステータス |
|---------------|----------------|
| `ErrSessionNotFound`, `ErrAuthFailed`, `ErrSessionExpired` | 401 |
| `ErrKratosUnavailable` | 502 |
| `ErrTokenGeneration`, `ErrCSRFSecretMissing` | 500 |
| `ErrRateLimited` | 429 |

#### DI 配線と Graceful Shutdown

`cmd/auth-hub/main.go` で `signal.NotifyContext` + `errgroup` パターンを採用:

```
g.Go(server.Start)      # Echo HTTP サーバー
g.Go(server.Shutdown)    # SIGTERM/SIGINT 時のシャットダウン
g.Go(otel.Shutdown)      # OTel プロバイダーのシャットダウン
```

旧 `main.go` の手動 `chan os.Signal` + goroutine パターンを置換。OTel 初期化失敗時は `slog.Warn` でログ出力後にトレーシングなしで継続。

#### Kratos クライアントの最適化

Gateway 層の新規 Kratos クライアントに HTTP トランスポートチューニングを適用:

| パラメータ | 旧値 | 新値 |
|-----------|------|------|
| `MaxIdleConns` | デフォルト (2) | 100 |
| `MaxIdleConnsPerHost` | デフォルト (2) | 20 |
| `IdleConnTimeout` | デフォルト (90s) | 90s (明示) |
| リクエストタイムアウト | なし | 3 秒 (`context.WithTimeout`) |

### Phase 5: コード品質

- 日本語コメントを英語に翻訳 (`session_handler.go`, `kratos_client.go`)
- ログフィールド `session_id_hash` → `session_prefix` に修正 (`csrf_handler.go`)
- Dockerfile のコメントを英語に統一
- `CLAUDE.md` を新アーキテクチャに更新

## RESULTS, EFFECTS

### PROS

- **テスト数 51 → 85**: 新規 34 テスト追加。全テスト `go test ./... -race` パス
  - ユースケース層: 14 テスト (validate, session, csrf, system-user)
  - アダプター層: 20 テスト (error mapper 15, gateway 5)
  - インフラ層: 10 テスト (cache 3, JWT 3, CSRF 4)
  - ミドルウェア: 9 テスト (rate limit 4, security headers 2, internal auth 3)
- **Clean Architecture 準拠**: プロジェクト標準の `Handler → Usecase → Port → Gateway` パターンを適用。ドメイン層は外部依存ゼロ
- **セキュリティ強化**: レート制限 (IP ベース, エンドポイント別)、セキュリティヘッダー (HSTS, CSP 等 7 種)、内部エンドポイント認証 (定数時間比較)、設定バリデーション (最低 32 文字)
- **エラーハンドリング改善**: ドメインセンチネルエラー + `errors.Is()` で型安全なエラー判定。`error_mapper.go` で HTTP ステータスに一元変換
- **Graceful Shutdown**: `signal.NotifyContext` + `errgroup` で HTTP サーバー・OTel プロバイダーの協調的シャットダウン
- **後方互換性**: 旧 `handler/` + `main.go` を保持。段階的移行が可能
- **コンテナ動作確認済み**: Docker Compose リビルド後に healthy 状態で稼働確認

### CONS, TRADEOFF

- **旧コードの残存**: `handler/`, `client/`, `cache/`, `token/`, `main.go` が新旧並存。完全移行後に削除が必要
- **ポートマッピング未公開**: auth-hub は内部ネットワークのみで公開しており、ホストからの直接 curl テストは不可。Docker exec または nginx 経由でのみアクセス可能
- **OTel コレクター依存**: トレース・ログエクスポートは OTel コレクター起動時のみ有効。未起動時は接続拒否ログが出力される（機能上は影響なし）
- **キャッシュ実装**: 自作 `sync.RWMutex + map` を維持。セッション数が大規模になった場合は Ristretto 等の LRU ライブラリへの移行を検討

## APPENDIX

### 変更ファイル一覧

#### 新規ファイル

| ファイル | 内容 |
|----------|------|
| `cmd/auth-hub/main.go` | DI 配線 + errgroup graceful shutdown |
| `internal/domain/session.go` | Identity, CachedSession エンティティ |
| `internal/domain/errors.go` | ドメインセンチネルエラー |
| `internal/domain/port.go` | SessionValidator, SessionCache, TokenIssuer, CSRFTokenGenerator, IdentityProvider |
| `internal/usecase/validate_session.go` + test | セッション検証ユースケース |
| `internal/usecase/get_session.go` + test | セッション情報取得 + JWT 生成 |
| `internal/usecase/generate_csrf.go` + test | CSRF トークン生成 |
| `internal/usecase/get_system_user.go` + test | システムユーザー取得 |
| `internal/adapter/handler/validate.go` | /validate ハンドラー |
| `internal/adapter/handler/session.go` | /session ハンドラー |
| `internal/adapter/handler/csrf.go` | /csrf ハンドラー |
| `internal/adapter/handler/health.go` | /health ハンドラー |
| `internal/adapter/handler/internal.go` | /internal/* ハンドラー |
| `internal/adapter/handler/error_mapper.go` + test | ドメインエラー → HTTP ステータス変換 |
| `internal/adapter/gateway/kratos.go` + test | Kratos クライアント (SessionValidator + IdentityProvider) |
| `internal/infrastructure/cache/session_cache.go` + test | domain.SessionCache 実装 |
| `internal/infrastructure/token/jwt.go` + test | domain.TokenIssuer 実装 |
| `internal/infrastructure/token/csrf.go` + test | domain.CSRFTokenGenerator 実装 |
| `middleware/rate_limit.go` + test | IP ベースレート制限 |
| `middleware/security_headers.go` + test | セキュリティヘッダー |
| `middleware/internal_auth.go` + test | 内部エンドポイント認証 |

#### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `config/config.go` | `BackendTokenSecret` バリデーション追加 (必須, 最低 32 文字) |
| `config/config_test.go` | バリデーションテスト追加 |
| `handler/session_handler.go` | 日本語コメント → 英語 |
| `handler/session_handler_test.go` | session ID アサーション修正 |
| `handler/csrf_handler.go` | ログフィールド名修正 |
| `client/kratos_client.go` | 日本語コメント → 英語 |
| `Dockerfile` | ビルドパスを `./cmd/auth-hub` に変更、コメント英語化 |
| `CLAUDE.md` | 新アーキテクチャドキュメント |
| `go.mod` | `golang.org/x/time/rate`, `golang.org/x/sync/errgroup` 追加 |

### 検証結果

```
go test ./... -race -count=1    # 14 パッケージ, 85 テスト全パス, 0 失敗
go build ./cmd/auth-hub          # 新エントリポイント ビルド成功
go build .                       # 旧エントリポイント ビルド成功 (後方互換)
docker compose build auth-hub    # イメージビルド成功
docker compose up -d auth-hub    # healthy 状態で起動確認
/auth-hub healthcheck            # コンテナ内ヘルスチェック成功
```
