# alt-backendエラーハンドリング包括的見直し：内部エラー露出防止

## ステータス

採択（Accepted）

## コンテキスト

alt-backendのREST APIおよびconnect-rPCハンドラーにおいて、内部エラー詳細がクライアントに露出するセキュリティ上の問題が発見された。

### 問題の発生状況

フロントエンドのエラー表示で以下のような内部情報が見えていた：

```
[internal] pre-processor returned status 500: {"message":"Failed to generate summary stream:
failed to start streaming summary: API request failed with status: 400 Bad Request,
body: {\"detail\":\"Content is too short for summarization. Content length: 91, Minimum required: 100 characters.\"}"}
```

### 問題のあったコードパターン

**REST API（18箇所）**:
```go
// Before: err.Error()がそのまま返される
return c.JSON(http.StatusInternalServerError, map[string]string{"error": err.Error()})
```

**connect-rPC（40箇所以上）**:
```go
// Before: errの内容がクライアントに見える
return connect.NewError(connect.CodeInternal, err)
```

### セキュリティリスク

露出する可能性があった情報：
- データベース接続文字列（`postgres://user:pass@db:5432`）
- 内部APIエンドポイント
- ファイルシステムパス（`/var/lib/app/internal/...`）
- スタックトレース

## 決定

### 1. エラー型の拡張

`AppContextError`に以下を追加：

```go
type AppContextError struct {
    // 既存フィールド
    Code      string
    Message   string
    Layer     string
    Component string
    Operation string
    Cause     error
    Context   map[string]interface{}

    // 追加：ログ相関用ユニークID
    ErrorID   string `json:"-"`
}
```

### 2. 安全メッセージマッピング

エラーコードごとにクライアント向け安全メッセージを定義：

```go
var safeMessages = map[string]string{
    "DATABASE_ERROR":        "A temporary service error occurred. Please try again later.",
    "EXTERNAL_API_ERROR":    "Unable to connect to external service. Please try again.",
    "VALIDATION_ERROR":      "", // 元メッセージを使用（設計上安全）
    "RATE_LIMIT_ERROR":      "Too many requests. Please wait before trying again.",
    "TIMEOUT_ERROR":         "The request took too long. Please try again.",
    "TLS_CERTIFICATE_ERROR": "Unable to establish secure connection.",
    "UNKNOWN_ERROR":         "An unexpected error occurred. Please try again later.",
}
```

### 3. 安全なHTTPレスポンス型

```go
type SecureHTTPResponse struct {
    Error SecureErrorDetail `json:"error"`
}

type SecureErrorDetail struct {
    Code      string `json:"code"`
    Message   string `json:"message"`      // SafeMessage()の結果
    ErrorID   string `json:"error_id,omitempty"`
    Retryable bool   `json:"retryable,omitempty"`
}
```

### 4. HandleError関数の改善

```go
func HandleError(c echo.Context, err error, operation string) error {
    // エラーをAppContextErrorに変換・エンリッチ
    enrichedErr := convertToAppContextError(err, operation, c)

    // ログには全詳細を記録（内部専用）
    logger.Logger.Error("REST API Error",
        "error_id", enrichedErr.ErrorID,
        "error", enrichedErr.Error(),  // 全詳細
        "code", enrichedErr.Code,
        "operation", operation,
    )

    // クライアントには安全なレスポンスのみ
    return c.JSON(enrichedErr.HTTPStatusCode(), enrichedErr.ToSecureHTTPResponse())
}
```

### 5. connect-rPCエラーハンドリング

```go
// Before
return connect.NewError(connect.CodeInternal, err)

// After: errを渡さない（nilまたは安全なメッセージのみ）
return connect.NewError(connect.CodeInternal, nil)
```

## 結果

### クライアントレスポンスの変化

**Before**:
```json
{"error": "connection to postgres://user:pass@db:5432 failed"}
```

**After**:
```json
{
  "error": {
    "code": "DATABASE_ERROR",
    "message": "A temporary service error occurred. Please try again later.",
    "error_id": "a1b2c3d4",
    "retryable": false
  }
}
```

### メリット

1. **セキュリティ向上**: 内部情報が外部に露出しない
2. **トレーサビリティ**: error_idでログとレスポンスを紐付け可能
3. **ユーザー体験改善**: 分かりやすいエラーメッセージ
4. **クリーンアーキテクチャ準拠**: レイヤー境界で適切にエラー変換

### トレードオフ

1. **デバッグ時の手間**: error_idを使ってログを検索する必要がある
2. **VALIDATION_ERRORの扱い**: 元メッセージを返すため、バリデーションメッセージの設計に注意が必要

### 修正対象ファイル

| カテゴリ | ファイル | 修正数 |
|---------|---------|-------|
| エラー基盤 | `utils/errors/app_context_error.go` | 新機能追加 |
| REST API | `rest/utils.go` | 1 |
| REST API | `rest/rest_feeds/utils.go` | 1 |
| REST API | `rest/dashboard_handlers.go` | 5 |
| REST API | `rest/augur_handler.go` | 2 |
| REST API | `rest_feeds/details.go` | 4 |
| REST API | `rest_feeds/search.go` | 3 |
| REST API | `rest_feeds/operations.go` | 3 |
| connect-rPC | `connect/v2/augur/handler.go` | 6 |
| connect-rPC | `connect/v2/feeds/handler.go` | 20+ |
| connect-rPC | `connect/v2/articles/handler.go` | 8 |
| connect-rPC | `connect/v2/rss/handler.go` | 8 |
| connect-rPC | `connect/v2/morning_letter/handler.go` | 4 |

## 実装

### 実装日: 2026-01-04

### Connect-RPC エラーハンドラーパッケージ

import cycle を回避するため、`connect/errorhandler` パッケージを新規作成：

```
alt-backend/app/connect/errorhandler/
├── error_handler.go      # HandleInternalError等の実装
└── error_handler_test.go # テスト
```

### 5. connect-rPCエラーハンドリング（更新）

当初の設計では `connect.NewError(connect.CodeInternal, nil)` としていたが、
ユーザーフレンドリーなメッセージを返すため `HandleInternalError()` を使用：

```go
// Before: nilを渡すとメッセージなし
return nil, connect.NewError(connect.CodeInternal, nil)

// After: SafeMessage() + ErrorID を含むメッセージを返す
return nil, errorhandler.HandleInternalError(h.logger, err, "OperationName")
```

### Connect-RPC レスポンスの変化

**Before**:
```json
{"error":{"code":"internal"}}
```

**After**:
```json
{"error":{"code":"internal","message":"An unexpected error occurred. Please try again later. (Error ID: a1b2c3d4)"}}
```

### 修正ファイル一覧（Connect-RPC）

| ファイル | 修正箇所数 |
|---------|-----------|
| `connect/errorhandler/error_handler.go` | 新規作成 |
| `connect/errorhandler/error_handler_test.go` | 新規作成 |
| `connect/v2/articles/handler.go` | 4箇所 |
| `connect/v2/augur/handler.go` | 3箇所 |
| `connect/v2/feeds/handler.go` | 14箇所 |
| `connect/v2/rss/handler.go` | 4箇所 |
| `connect/v2/morning_letter/handler.go` | 3箇所 |
| `connect/v2/feeds/handler_test.go` | テスト期待値修正 |

### 認証エラーについて

`CodeUnauthenticated` エラーはセキュリティ上の理由から、メッセージなしの現状を維持：

```go
// 変更なし - 認証エラーは詳細を出さない
return nil, connect.NewError(connect.CodeUnauthenticated, nil)
```

## 参考

- [Go Error Handling Best Practices - JetBrains](https://www.jetbrains.com/guide/go/tutorials/handle_errors_in_go/best_practices/)
- [Domain-Centric Error Handling in Go](https://medium.com/@oberonus/domain-centric-approach-to-error-handling-using-go-golang-e8340147959d)
- [API Security Best Practices with Go](https://dev.to/lovestaco/api-security-best-practices-with-go-393)
- [RFC 9457 Problem Details](https://www.rfc-editor.org/rfc/rfc9457.html)
- [Clean Architecture Error Handling](https://gist.github.com/navinpd/efe14b49f4a638a7316ead2176d73d87)
