# GitHub Actions: Self-Hosted から GitHub-Hosted Runner への移行

## ADR's STATUS

Accepted

## CONTEXT

### 背景

GitHub Actions のコスト構造が変化し、GitHub-hosted runner への移行が経済的に有利になった:

- **2026年1月**: GitHub-hosted runner の価格が最大39%値下げ
- **2026年3月**: Self-hosted runner への課金開始（$0.002/分）
- **2025年12月**: GitHub Cache の10GB制限が撤廃

### 現状の課題

Self-hosted runner 固有の処理が多数存在:

1. **Pre-checkout cleanup**: Docker-in-Docker でのワークスペースクリーンアップ
2. **GID検出**: ファイル権限問題の回避
3. **Local persistent cache**: `$HOME/.cache` ベースのキャッシュ
4. **Docker buildx local cache**: `/tmp/.buildx-cache` でのレイヤーキャッシュ
5. **Post-job cleanup**: テストキャッシュ・ビルド成果物の削除

これらは ephemeral な GitHub-hosted runner では不要。

## DECISION MAKING

### 移行方針

1. **Reusable workflow に `runner` input を追加**: デフォルト値を `ubuntu-latest` に設定し、必要に応じて `self-hosted` にオーバーライド可能
2. **条件分岐の活用**: 既存の `runner.environment == 'self-hosted'` 条件を維持し、後方互換性を確保
3. **Docker キャッシュ戦略の変更**: Local cache から Registry cache へ移行
4. **デプロイワークフローは対象外**: SSH アクセスが必要なため self-hosted を維持

### 代替案

1. **Repository variable による切り替え** (`MIGRATION_RUNNER_TYPE`): 検討したが、reusable workflow の input による制御の方が柔軟
2. **GitHub Actions Cache (`type=gha`)**: 検討したが、15サービスのマルチステージビルドには Registry cache の方が適切（サイズ制限なし）

## RESULTS, EFFECTS

### 変更ファイル一覧

#### Phase 1: Reusable Workflows

| ファイル | 変更内容 |
|---------|---------|
| `reusable-test-go.yaml` | `runner` input追加、`runs-on: ${{ inputs.runner }}` |
| `reusable-test-python.yaml` | `runner` input追加 |
| `reusable-test-rust.yaml` | `runner` input追加、`dtolnay/rust-toolchain@stable`、`Swatinem/rust-cache@v2` |
| `reusable-go-quality-gates.yaml` | `runner` input追加 |

#### Phase 2: Docker Build

| ファイル | 変更内容 |
|---------|---------|
| `docker-build.yaml` | `ubuntu-latest`、Registry cache (`type=registry`) への移行 |

#### Phase 3: Frontend Workflows

| ファイル | 変更内容 |
|---------|---------|
| `vitest.yaml` | `runner` input追加 |
| `playwright.yml` | `runner` input追加、`--user root` を self-hosted のみに |

#### Phase 4: CodeQL Workflows

| ファイル | 変更内容 |
|---------|---------|
| `codeql-go.yaml` | `ubuntu-latest` |
| `codeql-ts.yaml` | `ubuntu-latest` |
| `codeql-python.yaml` | `ubuntu-latest` |
| `codeql.yml` | `ubuntu-latest` |

#### Phase 5: その他

| ファイル | 変更内容 |
|---------|---------|
| `claude.yml` | `ubuntu-latest` |
| `helm-validation.yml` | `ubuntu-latest` |
| `recap-worker.yml` | `ubuntu-latest`、Rust toolchain/cache 追加 |
| `alt-frontend-sv.yml` | `ubuntu-latest` |
| `alt-frontend-sv-unit-test.yaml` | `ubuntu-latest` |
| `frontend-tests.yml` | `ubuntu-latest` |

#### Caller Workflows

| ファイル | 変更内容 |
|---------|---------|
| `backend-go.yaml` | `use-local-persistent-cache: false` |
| `tag-generator.yaml` | `use-local-persistent-cache: false` (4箇所) |

#### 対象外

| ファイル | 理由 |
|---------|------|
| `deploy.yaml` | 本番サーバーへの SSH アクセスが必要 |

### キャッシュ戦略の変更

| 言語/ツール | Before | After |
|------------|--------|-------|
| Go | Local persistent (`$HOME/.cache/go-build`) | `actions/cache@v4` |
| Python/uv | Local persistent (`$HOME/.cache/uv-*`) | `actions/cache@v4` |
| Rust | `actions/cache@v3` + manual install | `Swatinem/rust-cache@v2` + `dtolnay/rust-toolchain` |
| Docker | `type=local` | `type=registry` |

### PROS

1. **コスト削減**: Self-hosted runner 課金回避、GitHub-hosted 値下げの恩恵
2. **メンテナンス削減**: Runner のパッチ適用・監視が不要
3. **セキュリティ向上**: Ephemeral 環境で前回実行の影響を受けない
4. **キャッシュ効率**: Registry cache は有効期限・サイズ制限なし
5. **簡潔なワークフロー**: Self-hosted 固有のクリーンアップ処理が条件分岐でスキップ

### CONS, TRADEOFF

1. **初回ビルド時間**: キャッシュが空の状態では時間がかかる
2. **Registry cache のウォームアップ**: 移行直後は Docker ビルドが遅くなる可能性
3. **ロールバック対応**: 問題発生時は caller workflow で `runner: "self-hosted"` を明示的に指定する必要あり

## APPENDIX

### Rust Workflow の変更詳細

GitHub-hosted runner では公式の Action を使用:

```yaml
# GitHub-hosted
- uses: dtolnay/rust-toolchain@stable
  with:
    toolchain: ${{ inputs.toolchain }}
    components: clippy

- uses: Swatinem/rust-cache@v2
  with:
    workspaces: ${{ inputs.working-directory }}

# Self-hosted (既存のスクリプトを条件付きで維持)
- name: Install Rust toolchain (self-hosted)
  if: runner.environment == 'self-hosted'
  run: |
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- ...
```

### Docker Registry Cache の設定

```yaml
- uses: docker/build-push-action@v6
  with:
    cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/alt-${{ matrix.service }}:buildcache
    cache-to: ${{ github.event_name != 'pull_request' && format('type=registry,ref=ghcr.io/{0}/alt-{1}:buildcache,mode=max', github.repository_owner, matrix.service) || '' }}
```

**ポイント:**
- PR では cache-to を無効化（書き込み権限の問題回避）
- `mode=max` で全レイヤーをキャッシュ

### ロールバック方法

問題が発生した場合、caller workflow で runner を明示的に指定:

```yaml
jobs:
  test:
    uses: ./.github/workflows/reusable-test-go.yaml
    with:
      working-directory: 'service/app'
      runner: 'self-hosted'  # ロールバック
```

### 参考資料

- [Docker Build Cache with GitHub Actions](https://docs.docker.com/build/ci/github-actions/cache/)
- [GitHub Actions Runner Types](https://docs.github.com/en/actions/using-github-hosted-runners)
- [Swatinem/rust-cache](https://github.com/Swatinem/rust-cache)
- [dtolnay/rust-toolchain](https://github.com/dtolnay/rust-toolchain)
