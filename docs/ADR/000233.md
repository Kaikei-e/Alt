# ADR-000233: TTS 英単語→カタカナ前処理パイプライン

## STATUS

Accepted（実装完了・56 件のユニットテスト全件 PASS）

## CONTEXT

ADR-231/232 で実装した TTS 音読機能において、日本語と英語が混在するニュース記事で英語部分が無音になる問題が発生していた。

### 原因

TTS エンジン (Kokoro-82M) の日本語 G2P（misaki[ja] / pyopenjtalk + MeCab + unidic）は、unidic 辞書に登録されていない英単語を音素に変換できず、無音で読み飛ばす。ニュースサマリーには "RSSフィードのAPI" や "Machine Learningの最新トレンド" のような混在テキストが頻出するため、実用上の影響が大きかった。

### アプローチの選択肢

| 方式 | 利点 | 欠点 |
|------|------|------|
| A. unidic にユーザー辞書を追加 | G2P レベルで解決 | 語彙の網羅性に限界、辞書メンテナンスコスト大 |
| B. TTS 前処理で英語→カタカナ変換 | 約 11 万語の辞書で高カバー率、実装が軽量 | 変換精度は辞書依存、外来語のカタカナ表記ゆれ |
| C. 多言語対応 TTS エンジンへ移行 | 根本解決 | モデル入れ替えコスト大、日本語品質のリグレッションリスク |

## DECISION MAKING

**方式 B（TTS 前処理）** を採用した。

**理由:**

1. **高カバー率**: alkana ライブラリ（bep-eng.dic ベース、約 11 万語）で一般的な英単語の大半をカタカナに変換可能
2. **非破壊的**: TTS エンジン本体には変更を加えず、前処理レイヤーとして挿入するだけのため、リグレッションリスクが低い
3. **段階的対応**: 略語（acronym）→辞書変換→孤立1文字の 3 段階パイプラインにより、カバー範囲を最大化

### 前処理パイプラインの設計

3 つの関数を処理順序に従って直列で適用する。

```
入力テキスト
  │
  ▼
expand_acronyms()      ── 大文字2〜6文字の略語をカタカナに展開
  │                       例: "API" → "エーピーアイ"
  ▼
english_to_katakana()  ── 残った英単語を alkana 辞書で変換
  │                       例: "Machine" → "マシン"（辞書にない語はそのまま保持）
  ▼
孤立1文字展開           ── 前後に英字がない1文字を展開
  │                       例: "カテゴリ A" → "カテゴリ エー"
  ▼
出力テキスト → TTS エンジンへ
```

**略語を先に処理する理由**: alkana に "API" 等を渡すと誤変換または未変換になるため、大文字略語は辞書を経由せず文字単位でカタカナ展開する。

### テキスト長バリデーションの変更

前処理でテキストが伸長する（例: "API" 3 文字 → "エーピーアイ" 6 文字）ため、5000 文字制限のバリデーションを前処理の**後**に移動した。TTS エンジンに渡る実効テキスト長を正確に制限する。

```
Before: text → 空チェック+長さチェック → TTS
After:  text → 空チェック → 前処理 → 長さチェック → TTS
```

## RESULTS

### 変更ファイル

| ファイル | 操作 | 変更内容 |
|---------|------|---------|
| `tts-speaker/pyproject.toml` | 修正 | `alkana>=0.0.2` 依存追加 |
| `tts-speaker/tts_speaker/core/preprocess.py` | 新規 | 前処理モジュール（`expand_acronyms`, `english_to_katakana`, `preprocess_for_tts`） |
| `tts-speaker/tests/unit/test_preprocess.py` | 新規 | 前処理ユニットテスト 25 件 |
| `tts-speaker/tts_speaker/app/connect_service.py` | 修正 | `synthesize()` / `synthesize_stream()` に前処理統合、バリデーション順序変更 |
| `tts-speaker/tests/unit/test_connect_service.py` | 修正 | 前処理統合テスト 3 件追加 |

### 正規表現の設計

| パターン | 用途 | 補足 |
|----------|------|------|
| `(?<![A-Za-z])[A-Z]{2,6}(?![A-Za-z])` | 略語検出 | `\b` は日本語↔ASCII 境界で機能しないため lookaround を使用 |
| `[A-Za-z]{2,}` | 英単語検出 | 2 文字以上の連続英字 |
| `(?<![A-Za-z])[A-Za-z](?![A-Za-z])` | 孤立1文字検出 | 単語内の文字を誤展開しないよう lookaround で保護 |

### テスト結果

```
56 passed in 0.28s (25 new + 31 existing)
```

| テストクラス/ファイル | 件数 | カバー範囲 |
|---------------------|------|-----------|
| `TestExpandAcronyms` | 11 | 単一/複数略語、日本語のみ、混合ケース除外、1文字除外、2〜6文字範囲、7文字以上除外、空文字 |
| `TestEnglishToKatakana` | 6 | 既知語変換、未知語保持、複数語、1文字除外、日本語のみ、空文字 |
| `TestPreprocessForTts` | 8 | 略語+英単語混在、孤立1文字、純日本語不変、現実的ニュース文、略語の alkana 非通過、LETTER_MAP 完全性、単語内文字非展開 |
| `test_connect_service.py` (追加分) | 3 | synthesize 前処理適用、stream 前処理適用、前処理後の長さバリデーション |

### 変換例

| 入力 | 出力 |
|------|------|
| `RSSフィードのAPI` | `アールエスエスフィードのエーピーアイ` |
| `Machine Learningの最新トレンド` | `マシン ラーニングの最新トレンド` |
| `カテゴリ A のニュース` | `カテゴリ エー のニュース` |

## PROS

1. **英語混在テキストの無音問題を解消**: 略語・一般英単語・孤立1文字の 3 パターンをカバー
2. **非破壊的な変更**: TTS エンジン本体に手を加えず、前処理レイヤーの挿入のみ
3. **テスト容易性**: alkana をモックに差し替え可能な設計で、外部辞書に依存しないユニットテストを実現
4. **既存テストの互換性**: 既存 31 件のテストが全件 PASS、後方互換性を維持

## CONS, TRADEOFF

1. **辞書にない英単語はそのまま残る**: alkana の辞書（約 11 万語）にない新語・固有名詞はカタカナ変換されず、TTS で無音のままとなる
2. **カタカナ表記ゆれ**: alkana の辞書に依存するため、期待と異なるカタカナ表記になる可能性がある（例: "data" → "データ" vs "ダタ"）
3. **テキスト伸長**: 略語展開によりテキストが伸長する。5000 文字制限に対して実効的に入力可能な文字数が減少する
4. **正規表現の限界**: 大文字 7 文字以上の略語（例: "ABCDEFG"）は変換対象外。閾値はヒューリスティック
