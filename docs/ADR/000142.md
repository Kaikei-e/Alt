# TTFT 最適化: ADR 140 後の残課題対応

## ADR's STATUS

Accepted

## CONTEXT

### 背景

ADR 140 で Hybrid RT/BE Priority Semaphore を導入したが、TTFT が依然として遅い問題が残っていた。調査により、フロントエンドとバックエンド両方に複数のボトルネックを特定した。

### 特定された問題

| 優先度 | 問題 | 影響 |
|--------|------|------|
| P0 | 認証トークン毎回取得 | 各リクエストで auth-hub 往復 (+50-200ms) |
| P0 | ジェネレータ遅延評価 | セマフォ取得がイテレート開始まで遅延 |
| P1 | 500ms デバウンス | ストリーミング前の固定遅延 |
| P1 | Transport 毎回生成 | HTTP 接続セットアップ毎回発生 |
| P2 | HTTP クライアント再利用なし | コネクションプーリング無効 |
| P2 | バッファサイズ小 (128B) | syscall オーバーヘッド |

## DECISION MAKING

### 検討したアプローチ

#### P0: 認証トークンキャッシング

| Option | 内容 | 評価 |
|--------|------|------|
| A: event.locals キャッシュ | SvelteKit hooks でリクエストスコープキャッシュ | 採用 |
| B: メモリキャッシュ (TTL) | サーバーレベルでキャッシュ | 不採用 (セッション無効化の複雑化) |

**採用理由**: SvelteKit の `event.locals` はリクエストスコープでベストプラクティスに沿った実装。

#### P0: ジェネレータ遅延評価

| Option | 内容 | 評価 |
|--------|------|------|
| A: Eager Semaphore Acquisition | ジェネレータ返却前にセマフォ取得 | 採用 |
| B: Wrapper パターン | セマフォ取得後にジェネレータを wrap | 不採用 (複雑) |

**採用理由**: Eager Acquisition は ADR 140 の設計意図に最も適合し、RT 優先度が正しく機能する。

### 参考資料

- [SvelteKit Hooks](https://svelte.dev/docs/kit/hooks) - `event.locals` でのリクエストスコープキャッシング
- [gRPC Performance Best Practices](https://grpc.io/docs/guides/performance/) - ストリーミング RPC のベストプラクティス

## RESULTS, EFFECTS

### 修正ファイル

#### alt-frontend-sv

| ファイル | 変更内容 |
|----------|----------|
| `src/app.d.ts` | `App.Locals` に `backendToken` 追加 |
| `src/hooks.server.ts` | トークンをリクエストスコープでキャッシュ |
| `src/routes/api/v2/[...path]/+server.ts` | キャッシュ済みトークンを使用 |
| `src/lib/connect/transport-client.ts` | Transport シングルトンパターン |
| `src/lib/components/mobile/FeedDetails.svelte` | 500ms デバウンス削除 |

#### news-creator

| ファイル | 変更内容 |
|----------|----------|
| `news_creator/gateway/ollama_gateway.py` | Eager Semaphore Acquisition 実装 |
| `tests/gateway/test_ollama_gateway.py` | 新規テスト 3 件追加 |

#### alt-backend

| ファイル | 変更内容 |
|----------|----------|
| `app/rest/rest_feeds/summarization/client.go` | 共有 HTTP クライアント (新規) |
| `app/rest/rest_feeds/summarization/helpers.go` | 共有クライアント使用 |
| `app/rest/rest_feeds/summarization/stream_handlers.go` | バッファサイズ 128B → 4KB |

### 期待される改善

| 問題 | Before | After |
|------|--------|-------|
| 認証トークン取得 | +50-200ms/req | ~0ms |
| 500ms デバウンス | +500ms | 0ms |
| ジェネレータ遅延評価 | 優先度無効 | 即時取得 |
| Transport 生成 | +10-50ms | ~0ms |
| HTTP クライアント生成 | +100-300ms | ~0ms |

**合計**: 最大 1 秒以上の TTFT 改善

### PROS

1. **TTFT 大幅改善**: 複数レイヤーでの遅延を削減
2. **ADR 140 の効果発揮**: Eager Acquisition により RT 優先度が正しく機能
3. **コネクションプーリング**: HTTP/TCP 接続の再利用でオーバーヘッド削減

### CONS, TRADEOFF

1. **hooks.server.ts の複雑化**: トークン取得ロジックが追加
2. **シングルトンの制約**: Transport キャッシュは設定変更時に再起動が必要

## APPENDIX

### デプロイ手順

```bash
docker compose -f compose/compose.yaml -p alt build alt-frontend-sv news-creator alt-backend
docker compose -f compose/compose.yaml -p alt up -d alt-frontend-sv news-creator alt-backend
```

### 検証方法

```bash
# news-creator ログで TTFT 確認
docker compose -f compose/compose.yaml -p alt logs news-creator --since 10m 2>&1 | \
  grep "TTFT breakdown"

# セマフォ取得ログ確認 (streaming generator が表示されれば Eager Acquisition 有効)
docker compose -f compose/compose.yaml -p alt logs news-creator --since 10m 2>&1 | \
  grep "streaming generator"
```

### テスト実行

```bash
# news-creator (Eager Semaphore Acquisition テスト含む)
cd news-creator/app
SERVICE_SECRET=test-secret uv run pytest tests/gateway/test_ollama_gateway.py -v

# alt-backend
cd alt-backend/app
go build ./...

# alt-frontend-sv
cd alt-frontend-sv
bun run check
```
