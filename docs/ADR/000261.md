# ADR-000261: モバイル向けフィードソース除外フィルタ (Filter Chip + Bottom Sheet)

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000256 で導入したフィードソース除外フィルタはデスクトップ UI (`/sv/feeds`) のみに展開されていた。デスクトップではオートコンプリート入力 + チップ表示のパターンを使用している。

モバイルユーザーも購読ソースが多い場合に特定ドメインの記事を一時除外したいニーズがある。しかし、デスクトップのオートコンプリートパターンはモバイルのタッチ操作には適さない。

### 前提条件

- Connect-RPC API の `excludeFeedLinkId` パラメータは ADR-000256 で実装済み
- `getFeedsWithCursorClient()` は既に `excludeFeedLinkId` を受け付ける
- バックエンド変更は不要。フロントエンドのモバイル UI 追加のみ

## 意思決定

### UX パターン: Filter Chip + Bottom Sheet

モバイル UX ベストプラクティスに基づき、**Filter Chip + Bottom Sheet** パターンを採用した。

| 選択 | 不採用案 | 理由 |
|------|---------|------|
| Bottom Sheet | Dropdown | モバイルで自然なインタラクション。既存パターン (FeedDetails, FloatingMenu) と一致 |
| Filter Chip | Filter Bar | 省スペース。単一フィルタに最適 |
| 即時適用 | バッチ適用 | 単一選択のため即時適用が直感的 |
| 独立コンポーネント | MobileFeedsHero 統合 | SRP。MobileFeedsHero の責務を増やさない |

#### 非アクティブ状態

コンパクトなボタン: `Ban` アイコン + "Exclude source" テキスト。タップで Bottom Sheet を開く。

#### アクティブ状態

チップ: `Ban` アイコン + ドメイン名 + `X` ボタン。タップでフィルタ解除。

#### Bottom Sheet

- "Exclude a Source" タイトル
- Full-width 検索入力 (URL 部分一致フィルタリング)
- タップ可能なソースリスト (44px+ タッチターゲット)
- ソース選択時に自動クローズ + `onExclude` コールバック

### 共有ロジックの抽出

デスクトップ版 `FeedSourceExcludeFilter.svelte` 内にインラインで定義されていた `filterSources()` と `extractDomain()` を共有ユーティリティ (`feed-source-filter.ts`) に抽出した。

```typescript
// URL 部分一致フィルタリング (max 10 結果)
export function filterSources<T extends { url: string }>(
  sources: T[],
  query: string,
): T[]

// URL からホスト名抽出 (パース失敗時は入力をそのまま返却)
export function extractDomain(url: string): string
```

デスクトップ・モバイル両コンポーネントがこの共有ユーティリティをインポートする。

### FeedsClient の拡張

`FeedsClient.svelte` に `excludeFeedLinkId` prop を追加。`$effect` でフィルタ値の変更を検知し、フィードリストをリセット + リロードする。

```typescript
$effect(() => {
  const currentExclude = excludeFeedLinkId;
  if (prevExcludeFeedLinkId !== currentExclude) {
    prevExcludeFeedLinkId = currentExclude;
    feeds = [];
    cursor = null;
    hasMore = true;
    void loadInitial();
  }
});
```

`loadInitial()` / `loadMore()` の `getFeedsWithCursorClient()` 呼び出しに `excludeFeedLinkId` を透過的に渡す。API クライアントは既にこのパラメータを受け付けるため、追加の API 変更は不要。

### ページ統合

`+page.svelte` のモバイルブランチに `MobileFeedExcludeFilter` を `MobileFeedsHero` と `FeedsClient` の間に配置。`feedSources` のロードは desktop/mobile 共通の `onMount` で行われているためそのまま利用。

## 結果・影響

### 変更ファイル一覧

**新規作成:**

| ファイル | 目的 |
|---------|------|
| `alt-frontend-sv/src/lib/utils/feed-source-filter.ts` | 共有フィルタロジック (`filterSources`, `extractDomain`) |
| `alt-frontend-sv/src/lib/utils/feed-source-filter.spec.ts` | 共有ロジックテスト (9 cases) |
| `alt-frontend-sv/src/lib/components/mobile/feeds/MobileFeedExcludeFilter.svelte` | モバイル除外 UI コンポーネント |
| `alt-frontend-sv/src/lib/components/mobile/feeds/MobileFeedExcludeFilter.spec.ts` | モバイルコンポーネントロジックテスト (10 cases) |

**変更:**

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedSourceExcludeFilter.svelte` | インライン `filterSources` / `extractDomain` を共有ユーティリティからのインポートに置換 |
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedSourceExcludeFilter.spec.ts` | 共有ユーティリティからのインポートに更新 (10 cases 維持) |
| `alt-frontend-sv/src/lib/components/mobile/FeedsClient.svelte` | `excludeFeedLinkId` prop 追加、API 呼び出しにパラメータ透過、`$effect` でフィルタ変更検知 |
| `alt-frontend-sv/src/routes/(app)/feeds/+page.svelte` | `MobileFeedExcludeFilter` 統合、`mobileExcludedFeedLinkId` state 追加 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `bun test` (関連 3 ファイル) | 29 テスト全パス |
| `bun run check` (svelte-check) | 0 エラー、0 警告 |
| Biome lint (変更 8 ファイル) | 0 エラー |
| コンテナ再ビルド (`alt-frontend-sv`) | ビルド成功 |
| コンテナ起動 | `healthy` ステータス確認 |
| ヘルスチェック (`/api/health`) | HTTP 200 |

### PROS

- モバイルユーザーが特定ソースの記事を一時除外でき、多ソース購読時のブラウジング体験が向上
- Filter Chip + Bottom Sheet パターンにより、モバイルネイティブな操作感を実現
- 44px+ タッチターゲットによるアクセシビリティ対応
- `filterSources` / `extractDomain` の共有化により、desktop/mobile 間の重複コードを解消
- 既存の Connect-RPC API をそのまま利用。バックエンド変更ゼロ
- 無限スクロールが除外状態でも正常動作（サーバーサイドフィルタリング）

### CONS, TRADEOFF

- Bottom Sheet に `$lib/components/ui/sheet` (bits-ui Dialog) を利用しているため、bits-ui への依存が増加（既存依存のため実質的な追加コストは軽微）
- モバイルもデスクトップ同様に v1 は単一ソース除外のみ
- フィードソース一覧は `onMount` で全件取得。ソース数が大幅に増加した場合は遅延ロードの検討が必要
- デスクトップの `FeedSourceExcludeFilter` はキーボードナビゲーション (ArrowDown/Up, Enter, Escape) 対応だが、モバイル版は Bottom Sheet 内のタップ操作に特化しているため、キーボードナビゲーションは未実装

### 影響範囲

- **alt-frontend-sv**: モバイルビューポート (< 768px) の Feeds ページに UI 追加。デスクトップの既存除外フィルタは引き続き正常動作
- **alt-backend**: 変更なし
- **他サービス**: 変更なし

## 関連 ADR

- ADR-000256: フィードソース除外フィルタ (Feeds ページ)
- ADR-000258: フィードソース除外フィルタの (app)/feeds ページへの移植
- ADR-000260: フィード除外フィルタ — excludeClause ヘルパー関数への DRY リファクタリング
