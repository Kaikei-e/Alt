
# Grafana Trace/Log表示問題の修正

## ADR's STATUS

Accepted

## CONTEXT

### 背景

Grafanaでログとトレースの関連付けに2つの問題が発生していた：

1. **TraceId/SpanIdがすべてゼロ**: ログビューでTraceId/SpanIdが`00000000000000000000000000000000`と表示される
2. **Events.Nameエラー**: トレース詳細表示で`Unknown expression or function identifier 'Events.Name'`エラー

### 問題1の原因分析

ログ収集フロー：
```
サービス → stdout(JSON) → Docker → rask-log-forwarder → ClickHouse → Grafana
```

`MultiHandler`がJSONHandlerとOTelHandlerの両方にログを送信しているが、JSONHandler（stdout出力）にはトレースコンテキストが追加されていなかった。

```go
// Before: JSONHandlerにトレースコンテキストなし
handlers: []slog.Handler{
    slog.NewJSONHandler(os.Stdout, ...),  // ← trace_id/span_idなし
    NewOTelHandler(...),                   // ← trace_id/span_idあり
}
```

### 問題2の原因分析

ClickHouseの`otel_traces`テーブルで`Events`と`Links`がString型（JSON文字列）として定義されていた：

```sql
Events String DEFAULT '[]',
Links String DEFAULT '[]',
```

Grafana ClickHouseプラグイン（`otelEnabled: true`）はネストされた配列構造を期待：
- `Events.Name` (Array型)
- `Events.Timestamp` (Array型)
- `Links.TraceId` (Array型)

## DECISION MAKING

### 解決策1: TraceContextHandler

JSONHandler出力にトレースコンテキストを自動追加する`TraceContextHandler`を実装。

```go
type TraceContextHandler struct {
    inner slog.Handler
}

func (h *TraceContextHandler) Handle(ctx context.Context, r slog.Record) error {
    if span := trace.SpanFromContext(ctx); span.SpanContext().IsValid() {
        sc := span.SpanContext()
        r.AddAttrs(
            slog.String("trace_id", sc.TraceID().String()),
            slog.String("span_id", sc.SpanID().String()),
        )
    }
    return h.inner.Handle(ctx, r)
}
```

### 解決策2: ClickHouseネストカラム追加

既存のString型カラムを維持しつつ、Grafana互換のネストされた配列カラムを追加：

```sql
ALTER TABLE otel_traces
    ADD COLUMN IF NOT EXISTS `Events.Timestamp` Array(DateTime64(9, 'UTC')) DEFAULT [],
    ADD COLUMN IF NOT EXISTS `Events.Name` Array(LowCardinality(String)) DEFAULT [],
    ADD COLUMN IF NOT EXISTS `Events.Attributes` Array(Map(LowCardinality(String), String)) DEFAULT [],
    ADD COLUMN IF NOT EXISTS `Links.TraceId` Array(String) DEFAULT [],
    ADD COLUMN IF NOT EXISTS `Links.SpanId` Array(String) DEFAULT [],
    ADD COLUMN IF NOT EXISTS `Links.TraceState` Array(String) DEFAULT [],
    ADD COLUMN IF NOT EXISTS `Links.Attributes` Array(Map(LowCardinality(String), String)) DEFAULT [];
```

## RESULTS, EFFECTS

### 変更ファイル

| サービス | ファイル | 変更内容 |
|---------|---------|---------|
| alt-backend | `utils/logger/trace_context_handler.go` | 新規作成 |
| alt-backend | `utils/logger/multi_handler.go` | TraceContextHandler適用 |
| alt-backend | `utils/logger/trace_context_handler_test.go` | テスト追加 |
| pre-processor | `utils/logger/trace_context_handler.go` | 新規作成 |
| pre-processor | `utils/logger/config.go` | TraceContextHandler適用 |
| search-indexer | `logger/trace_context_handler.go` | 新規作成 |
| search-indexer | `logger/logger.go` | TraceContextHandler適用 |
| auth-hub | `utils/logger/trace_context_handler.go` | 新規作成 |
| auth-hub | `utils/logger/logger.go` | TraceContextHandler適用 |
| rask-log-aggregator | `domain/otel_log.rs` | SpanEvent/SpanLink構造体追加 |
| rask-log-aggregator | `otlp/converter.rs` | ネスト形式への変換追加 |
| rask-log-aggregator | `log_exporter/clickhouse_exporter.rs` | ネストカラム書き込み対応 |
| ClickHouse | `migrations/010_alter_otel_traces_nested_events.sql` | マイグレーション追加 |

### アーキテクチャ

```
┌─────────────────┐    ┌──────────────────────┐
│   Go Service    │    │   TraceContextHandler │
│ (alt-backend等) │───▶│   ┌───────────────┐  │
└─────────────────┘    │   │ JSONHandler   │  │───▶ stdout (trace_id付き)
                       │   └───────────────┘  │
                       │   ┌───────────────┐  │
                       │   │ OTelHandler   │  │───▶ OTLP (trace_id付き)
                       │   └───────────────┘  │
                       └──────────────────────┘

┌─────────────────────┐    ┌─────────────────┐
│ rask-log-aggregator │───▶│   ClickHouse    │
│ (OTLP receiver)     │    │ ┌─────────────┐ │
└─────────────────────┘    │ │ otel_traces │ │
                           │ │ - Events    │ │ (String - 後方互換)
                           │ │ - Events.*  │ │ (Array - Grafana用)
                           │ └─────────────┘ │
                           └─────────────────┘
```

### PROS

1. **後方互換性維持**: 既存のEventsカラム（String型）は維持
2. **Grafana完全対応**: ネストされたカラムでトレース詳細表示が正常動作
3. **全Goサービス統一**: 同一のTraceContextHandler実装を共有
4. **テスト完備**: 6つのテストケースでTraceContextHandlerの動作を検証

### CONS, TRADEOFF

1. **ストレージ増加**: Events/Linksが2形式で保存される（String + Array）
2. **コード重複**: 各サービスに同一のTraceContextHandlerをコピー（共有ライブラリ化は将来課題）
3. **マイグレーション必要**: 既存のClickHouseテーブルへのALTER TABLE実行が必要

## APPENDIX

### 検証方法

```bash
# 1. ログにtrace_idが含まれることを確認
docker compose logs alt-backend --tail=10 | jq 'select(.trace_id != null)'

# 2. ClickHouseでネストカラムを確認
docker compose exec clickhouse clickhouse-client \
  --query "DESCRIBE TABLE otel_traces" | grep -E "Events\.|Links\."

# 3. Grafanaでトレース詳細表示を確認
# http://localhost:3001 → Explore → ClickHouse → Traces
```

### 関連リソース

- [Grafana ClickHouse Datasource - Span Events & Links](https://github.com/grafana/clickhouse-datasource/issues/1262)
- [ClickHouse OTel Schema](https://clickhouse.com/docs/observability/integrating-opentelemetry)
- [Go slog with OpenTelemetry](https://pkg.go.dev/go.opentelemetry.io/contrib/bridges/otelslog)
