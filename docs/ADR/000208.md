# RAG Orchestrator 空レスポンス修正と TTFT 高速化

## ADR's STATUS

Accepted (実装完了・コンテナ再ビルド・ヘルスチェック確認済み)

## CONTEXT

### 問題1: 空レスポンス / 見出しだけのレスポンス

RAG Orchestrator の回答生成で、Markdown 見出しだけの外枠が返る、または空の answer フィールドが返るケースが発生していた。

**根本原因**: システムプロンプトが 8B モデルに対して過大な要求を課していた。5セクション合計 2300 文字以上を要求するプロンプトと `num_ctx: 8192` の組み合わせにより、コンテキストチャンク投入後の出力トークン余剰が不足。モデルは JSON 構造（見出し）を忠実に生成するが、各セクション内容を埋める前にトークン上限に到達していた。

### 問題2: TTFT (Time To First Token) 50秒超

検索パイプライン（Query Expansion → Tag Search → Embedding → Vector Search → BM25 → Reranking）が逐次実行されていたため、各フェーズのレイテンシが累積していた。Reranker のタイムアウトが 300 秒と過大に設定されている点も問題だった。

## DECISION MAKING

### 方針

2つのトラックに分けて対応する。

- **Track A**: 空レスポンスの根本原因対策（プロンプト軽量化・コンテキストウィンドウ拡大・バリデーション強化）
- **Track B**: TTFT 短縮（パイプライン並列化・タイムアウト最適化・接続プール導入）

### Track A: 空レスポンス修正

#### A-1. プロンプト軽量化 [P0]

システムプロンプトを大幅に簡潔化した。

- セクション数: 5 → 3（概要・詳細・まとめ）
- 最低文字数要件を削除（2000文字以上→制約なし）
- プロンプト全体のトークン数: ~800 → ~400
- JSON 出力例を 1 行に圧縮

#### A-2. コンテキストウィンドウ拡大 [P0]

`num_ctx` を 8192 → 16384 に拡大した。Modelfile と Go コード (API リクエスト時の上書き値) の両方を変更。8B q5_k_s 量子化モデルのメモリ使用量 (~6GB) + 16k KV キャッシュ (~1.5GB) = ~7.5GB で、16GB RAM の枠内に収まる。

#### A-3. 空 answer の明示的拒否 [P0]

OutputValidator に空 answer チェックを追加。`answer == "" && fallback == false` の場合にエラーを返し、呼び出し元でフォールバック処理に移行させる。

#### A-4. コンテキストチャンク数の動的制限 [P1]

`buildPrompt` 内で推定トークン数を計算し、`num_ctx` の入力枠（~10000 トークン）を超えないようチャンクを動的に削減する。日本語は ~3文字/トークンで概算。

#### A-5. ストリーム切断時の Done フラグ欠落対応 [P1]

`ChatStream` でストリームが done フラグなしで終了した際、受信データが 50 バイト未満の場合のみエラーを送信する。データ十分な場合は既存データで処理を継続。

#### A-6. Fallback 理由の構造化 [P2]

`FallbackCategory` 型を導入し、フォールバックの原因を 4 カテゴリに分類:

| カテゴリ | 意味 |
|---------|------|
| `retrieval_empty` | 検索結果なし |
| `generation_failed` | LLM 生成エラー |
| `validation_failed` | JSON 解析失敗 |
| `llm_fallback` | LLM 自身が fallback 判定 |

### Track B: TTFT 高速化

#### B-1. 検索フェーズの並列化 [P0]

`golang.org/x/sync/errgroup` を使い、逐次だった検索パイプラインを 3 段階並列化に変更した。

```
Stage 1 (並列):
  goroutine A: Query Expansion
  goroutine B: Tag Search (Meilisearch)
  goroutine C: Original Query Embedding
→ 最長レイテンシに収束

Stage 2 (並列):
  goroutine D: Expanded Queries Embedding
  goroutine E: BM25 Search
  goroutine F: Original Vector Search
→ 最長レイテンシに収束

Stage 3:
  Expanded Vector Search (並列)
  → RRF Fusion → Reranking
```

各 goroutine の失敗ポリシー:
- Original Query Embedding / Vector Search の失敗は fatal（即座にエラー返却）
- Query Expansion / Tag Search / BM25 / Expanded Embedding の失敗は non-fatal（スキップして続行）

#### B-2. Rerank タイムアウト短縮 [P0]

デフォルトの Rerank タイムアウトを 300 秒 → 10 秒に短縮。10 チャンクのリランキングは通常 2-5 秒で完了し、タイムアウト時は既存のベクトルスコアフォールバックが動作する。

#### B-3. HTTP 接続プール [P0]

共有 `http.Transport` を全外部サービスクライアントに注入する `httpclient.NewPooledClient` を新設。VPN 経由の TCP ハンドシェイクオーバーヘッドを、Keep-Alive 接続の再利用で削減する。

| パラメータ | 値 |
|----------|-----|
| `MaxIdleConns` | 20 |
| `MaxIdleConnsPerHost` | 10 |
| `IdleConnTimeout` | 120s |

#### B-4. ストリーミング Progress イベント [P1]

`StreamEventKindProgress` を新設し、検索フェーズ中にクライアントへ進捗を通知する。`"searching"` → `"generating"` の順でイベントを送信。

## RESULTS, EFFECTS

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `rag-orchestrator/internal/usecase/prompt_builder.go` | システムプロンプト簡潔化 (5→3 セクション、文字数制約削除) |
| `knowledge-augur/Modelfile.swallow-8b-rag` | `num_ctx` 8192 → 16384 |
| `rag-orchestrator/internal/adapter/rag_augur/ollama_generator.go` | `num_ctx` 上書き値変更、ストリーム Done 欠落対応 |
| `rag-orchestrator/internal/usecase/output_validator.go` | 空 answer 拒否チェック追加 |
| `rag-orchestrator/internal/usecase/answer_with_rag_usecase.go` | 動的チャンク制限、FallbackCategory 導入 |
| `rag-orchestrator/internal/usecase/retrieve_context_usecase.go` | errgroup による 3 段階並列パイプライン |
| `rag-orchestrator/internal/usecase/rag_answer_types.go` | `StreamEventKindProgress`、`FallbackCategory` 型追加 |
| `rag-orchestrator/internal/usecase/rag_answer_stream.go` | Progress イベント送信追加 |
| `rag-orchestrator/internal/infra/config/config.go` | Rerank デフォルトタイムアウト 30 → 10 秒 |
| `rag-orchestrator/internal/infra/httpclient/pool.go` | 共有接続プール (新規) |
| `rag-orchestrator/internal/adapter/rag_augur/ollama_embedder.go` | HTTP クライアント注入対応 |
| `rag-orchestrator/internal/adapter/rag_augur/reranker_client.go` | HTTP クライアント注入対応 |
| `rag-orchestrator/internal/adapter/rag_augur/query_expander_client.go` | HTTP クライアント注入対応 |
| `rag-orchestrator/cmd/server/main.go` | 接続プール注入のワイヤリング |
| `compose/rag.yaml` | `RERANK_TIMEOUT` 300 → 10 |
| `rag-orchestrator/internal/usecase/output_validator_test.go` | 空 answer 拒否テスト 3 件追加 |
| `rag-orchestrator/internal/usecase/answer_with_rag_usecase_test.go` | プロンプトマッチャー修正、FallbackCategory アサーション追加 |
| `rag-orchestrator/internal/usecase/retrieve_context_usecase_test.go` | 並列パイプライン対応のモック修正 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `go test ./...` | PASS (全パッケージ) |
| コンテナビルド (`--no-cache`) | 成功 |
| ヘルスチェック (`/healthz`) | `{"status":"ok"}` |
| レディネスチェック (`/readyz`) | `{"status":"ready"}` |
| 起動ログ: reranker_enabled | 確認 |
| 起動ログ: hybrid_search_enabled | 確認 |

### 期待効果

| 指標 | 修正前 | 修正後 (期待値) |
|------|--------|---------------|
| 空レスポンス率 | 高頻度 | プロンプト軽量化 + num_ctx 拡大で大幅低減 |
| TTFT (検索フェーズ) | 20-40秒 (逐次) | ~10秒 (並列化) |
| Rerank タイムアウト | 最大 300秒 | 最大 10秒 (フォールバック付き) |
| VPN 接続オーバーヘッド | 5-20ms/リクエスト | Keep-Alive で初回以降 ~0ms |

### PROS

- **空レスポンスの根本解決**: プロンプト軽量化とコンテキストウィンドウ拡大の組み合わせにより、8B モデルが実際に内容を生成できる出力トークン余剰を確保
- **段階的フォールバック**: 空 answer バリデーション → LLM fallback → retrieval fallback の多層防御
- **TTFT 大幅短縮**: 逐次パイプラインの並列化で最長レイテンシに収束する設計
- **非破壊的失敗ポリシー**: Query Expansion や BM25 の失敗は non-fatal とし、Original Query のみでも回答可能
- **可観測性向上**: FallbackCategory による原因分類、Progress イベントによるクライアント進捗通知

### CONS, TRADEOFF

- **Modelfile 変更には手動操作が必要**: `num_ctx` 変更後に `ollama create swallow-8b-rag -f Modelfile.swallow-8b-rag` の実行が必要
- **メモリ使用量増加**: `num_ctx` 拡大により KV キャッシュが ~1.5GB 増加（16GB RAM 環境では問題なし）
- **プロンプト簡潔化によるセクション削減**: 5 セクションから 3 セクションへの削減で、回答の網羅性がやや低下する可能性があるが、空レスポンスよりは有用な回答を優先

## APPENDIX

### Modelfile 再作成手順

`num_ctx` 変更後、リモート LLM ホスト上で以下を実行する:

```bash
ollama create swallow-8b-rag -f Modelfile.swallow-8b-rag
```

### TTFT 計測方法

```bash
time curl -N -s -X POST http://localhost:9010/v1/rag/answer/stream \
  -H "Content-Type: application/json" \
  -d '{"query": "テストクエリ"}' 2>&1 | grep -m1 '"delta"'
```

### 並列パイプライン設計図

```
[Stage 1] ─── Query Expansion ──────────┐
           ├── Tag Search ───────────────┤ Wait
           └── Original Embedding ───────┘
                                         │
[Stage 2] ─── Expanded Embedding ────────┐
           ├── BM25 Search ──────────────┤ Wait
           └── Original Vector Search ───┘
                                         │
[Stage 3] ─── Expanded Vector Search (並列) → RRF Fusion → Reranking
```
