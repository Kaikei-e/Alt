# Recap Job 手動トリガー機能

## ADR'S STATUS

Accepted

## CONTEXT

### 背景

ADR-109で実装したRecap Job Status Dashboardは監視機能のみを提供していた。運用上、以下のニーズが発生した:

1. スケジューラーを待たずに即座にジョブを開始したい
2. テスト目的でジョブを手動実行したい
3. 障害復旧後に手動でジョブを再開したい

### 要件

1. **手動トリガー**: ダッシュボードUIからジョブを開始できる
2. **重複防止**: 既にジョブが実行中の場合はトリガーを無効化
3. **フィードバック**: 成功/エラーメッセージを表示
4. **自動リフレッシュ**: トリガー後にダッシュボードを自動更新

## DECISION MAKING

### 決定

既存の `/v1/generate/recaps/7days` エンドポイントを活用し、フロントエンドにトリガーボタンを追加する。

### 1. 既存APIの活用

recap-workerには既に手動トリガー用のAPIが存在していた:

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `/v1/generate/recaps/7days` | POST | 7日間のRecapジョブをトリガー |

リクエストボディ:
```json
{
  "genres": ["ai", "security"]  // オプション。省略時は全ジャンル
}
```

レスポンス:
```json
{
  "job_id": "uuid",
  "genres": ["ai", "security", ...],
  "status": "accepted"
}
```

### 2. フロントエンドAPIプロキシ

SvelteKitのサーバーサイドルートを追加:

| パス | 説明 |
|------|------|
| `src/routes/api/v1/generate/recaps/7days/+server.ts` | POSTリクエストをrecap-workerに転送 |

### 3. UIコンポーネント

ダッシュボードページに「Start Job」ボタンを追加:

- **ボタン状態**:
  - 通常: 緑色背景、ロケットアイコン
  - 実行中: 「Starting...」表示、パルスアニメーション
  - 無効: ジョブ実行中は半透明化

- **フィードバック**:
  - 成功時: 緑色バナーで「Job xxx... started with N genres」を5秒間表示
  - エラー時: 赤色バナーでエラーメッセージを表示

### 設計根拠

1. **既存API活用**: 新規エンドポイント作成より保守コスト低減
2. **重複防止**: `hasRunningJob` フラグでUIレベルで制御
3. **1秒遅延リフレッシュ**: ジョブ登録完了を待ってから表示更新

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 種別 | 内容 |
|----------|------|------|
| `alt-frontend-sv/src/lib/api/client/dashboard.ts` | 変更 | `triggerRecapJob()` 関数追加 |
| `alt-frontend-sv/src/routes/api/v1/generate/recaps/7days/+server.ts` | 新規 | APIプロキシルート |
| `alt-frontend-sv/src/routes/desktop/recap/job-status/+page.svelte` | 変更 | トリガーボタンUI追加 |

### PROS

1. **即時実行**: スケジューラーを待たずにジョブ開始可能
2. **運用効率化**: 手動でのAPI呼び出しが不要に
3. **視覚的フィードバック**: 成功/エラー状態が明確

### CONS, TRADEOFF

1. **認証なし**: 現状はダッシュボードアクセス可能な全ユーザーがトリガー可能
2. **ジャンル指定不可**: UIでは全ジャンル実行のみ（API直接呼び出しで指定可能）
3. **レート制限なし**: 連続トリガーの制限は未実装

## APPENDIX

### 使用方法

1. `/sv/desktop/recap/job-status` にアクセス
2. 右上の「Start Job」ボタンをクリック
3. 成功メッセージが表示され、ジョブがバックグラウンドで開始

### 関連ADR

- ADR-109: Recap Job Status Dashboard 実装

### 関連コード

| ファイル | 関数/クラス |
|----------|-------------|
| `recap-worker/recap-worker/src/api/generate.rs` | `trigger_7days()` |
| `alt-frontend-sv/src/lib/api/client/dashboard.ts` | `triggerRecapJob()` |

### CSS修正

Time Windowセレクターのボタンスタイリングも修正:

- **問題**: CSS変数 `--alt-primary` が適用されず白背景に白文字になるケース
- **解決**: フォールバック値 `#2f4f4f` を追加
  ```css
  background: var(--alt-primary, #2f4f4f); color: #ffffff;
  ```
