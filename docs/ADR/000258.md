# ADR-000258: フィードソース除外フィルタの (app)/feeds ページへの移植

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000256 でフィードソース除外フィルタを導入し、ADR-000257 で `listSubscriptions` のツリーシェイクバグを修正した。しかし、ユーザーが実際にアクセスする `/sv/feeds` ページでは依然として除外フィルタが機能しない問題が継続していた。

### 原因分析

`hooks.server.ts` が `/sv/desktop/feeds` から `/sv/feeds` への 301 リダイレクトを発行しているため、ユーザーが実際にアクセスするのは `(app)/feeds/+page.svelte` である。

ADR-000256 の実装は `desktop/feeds/+page.svelte` にのみ配線されており、`(app)/feeds/+page.svelte` には以下が欠落していた:

| 欠落項目 | 影響 |
|---------|------|
| `listSubscriptionsClient` の import と `onMount` での呼び出し | `feedSources` が空配列のまま、`ListSubscriptions` RPC が発行されない |
| `feedSources` state | `FeedFilters` に渡す購読ソース一覧が存在しない |
| `excludedFeedLinkId` の filters state | フィルタ変更時に除外 ID が保持されない |
| `FeedFilters` への `feedSources` / `excludedFeedLinkId` props | オートコンプリートに候補が表示されない |
| `FeedGrid` への `excludedFeedLinkId` prop | 除外条件がサーバーリクエストに含まれない |

**結果**: `FeedSourceExcludeFilter` コンポーネント自体は `FeedFilters` 経由で描画されるものの、`sources` prop が空配列のため、何を入力してもマッチせず、除外フィルタは完全に無効だった。

### なぜ見落としたか

- `desktop/feeds/+page.svelte` と `(app)/feeds/+page.svelte` の 2 つのページコンポーネントが同じ機能を提供しており、リダイレクト構成との関係が明確でなかった
- 開発中は `/sv/desktop/feeds` に直接アクセスして動作確認していたため、リダイレクト経由のアクセスパスで検証していなかった

## 意思決定

### 修正方針: (app)/feeds/+page.svelte に desktop/feeds/+page.svelte と同等の配線を追加

`desktop/feeds/+page.svelte` の実装をリファレンスとして、`(app)/feeds/+page.svelte` に不足している除外フィルタの配線を追加する。

既存の `FeedFilters`, `FeedGrid`, `FeedSourceExcludeFilter` コンポーネントや API クライアント層は変更不要。ADR-256 / ADR-257 で正しく実装済みであり、ページコンポーネントからの配線のみが欠落していた。

### 変更内容

**1. import 追加**

```typescript
import { updateFeedReadStatusClient, listSubscriptionsClient } from "$lib/api/client/feeds";
import type { ConnectFeedSource } from "$lib/connect/feeds";
import { onMount } from "svelte";
```

**2. state 拡張**

```typescript
let filters = $state({
    unreadOnly: false,
    sortBy: "date_desc",
    excludedFeedLinkId: null as string | null,
});
let feedSources = $state<ConnectFeedSource[]>([]);
```

**3. onMount でフィードソースをロード**

```typescript
onMount(async () => {
    try {
        feedSources = await listSubscriptionsClient();
    } catch (e) {
        console.error("Failed to load feed sources:", e);
    }
});
```

**4. handleFilterChange の型を拡張**

```typescript
function handleFilterChange(newFilters: {
    unreadOnly: boolean;
    sortBy: string;
    excludedFeedLinkId: string | null;
}) {
    filters = newFilters;
}
```

**5. テンプレート: FeedFilters / FeedGrid に props 追加**

```svelte
<FeedFilters
    unreadOnly={filters.unreadOnly}
    sortBy={filters.sortBy}
    excludedFeedLinkId={filters.excludedFeedLinkId}
    {feedSources}
    onFilterChange={handleFilterChange}
/>

<FeedGrid
    onSelectFeed={handleSelectFeed}
    unreadOnly={filters.unreadOnly}
    sortBy={filters.sortBy}
    excludedFeedLinkId={filters.excludedFeedLinkId}
    onReady={handleFeedGridReady}
/>
```

### 変更しなかったもの

| ファイル | 理由 |
|---------|------|
| `FeedFilters.svelte` | ADR-256 で `feedSources`, `excludedFeedLinkId` props を既にサポート済み |
| `FeedGrid.svelte` | ADR-256 で `excludedFeedLinkId` prop と `$effect` によるリロード制御を実装済み |
| `FeedSourceExcludeFilter.svelte` | 変更不要 |
| `$lib/api/client/feeds.ts` | ADR-257 で修正済み |
| `$lib/connect/feeds/listing.ts` | ADR-256 で対応済み |
| バックエンド全体 | ADR-256 で対応済み |

## 結果・影響

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/src/routes/(app)/feeds/+page.svelte` | 除外フィルタの配線を追加（import, state, onMount, props） |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `bun run check` (TypeScript/Svelte 型検査) | 0 errors, 0 warnings (5431 files) |
| `bun test -- FeedSourceExcludeFilter.spec.ts` | 10/10 パス |
| コンテナ再ビルド (`alt-frontend-sv`) | healthy |
| ヘルスチェック (`/api/health`) | 200 OK |

### PROS

- 1 ファイルのみの変更で、ユーザーが実際にアクセスするページで除外フィルタが正しく動作するようになった
- 既存コンポーネント・API 層は一切変更不要。ADR-256 / ADR-257 の設計が正しかったことを確認
- `desktop/feeds/+page.svelte` と `(app)/feeds/+page.svelte` のフィルタ機能が一致し、どちらのルートからアクセスしても同じ体験を提供

### CONS, TRADEOFF

- `desktop/feeds/+page.svelte` と `(app)/feeds/+page.svelte` に類似コードが存在する二重管理状態が継続している。将来的にルート統合またはレイアウト共通化を検討すべき
- モバイルビュー (`FeedsClient`) には除外フィルタを配線していない（デスクトップのみの機能）

### 影響範囲

- **alt-frontend-sv**: `(app)/feeds/+page.svelte` のみ。他のページ・コンポーネントへの影響なし
- **バックエンド**: 変更なし
- **他サービス**: 変更なし

### 今後の推奨事項

1. **ルート統合の検討**: `desktop/feeds/+page.svelte` と `(app)/feeds/+page.svelte` の二重管理を解消するため、共通ロジックの抽出またはルート統合を検討
2. **E2E テスト追加**: リダイレクト経由のアクセスパス (`/sv/feeds`) で除外フィルタが動作することを E2E テストで保証

## 関連 ADR

- ADR-000256: フィードソース除外フィルタ (Feeds ページ)
- ADR-000257: FeedSourceExcludeFilter の listSubscriptions リクエスト未送信バグ修正
