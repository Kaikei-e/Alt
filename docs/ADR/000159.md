# pre-processorのGetFeedIDにおけるErrNoRows処理の改善

## ステータス

承認済み（2026-01-29）

## 背景

pre-processorサービスのログに以下のエラーが繰り返し出力されていた：

```
ERROR pre-processor Failed to get feed ID no rows in result set
```

### 原因分析

`driver/db_feeds.go`の`GetFeedID`関数が`pgx.ErrNoRows`を他のDBエラーと区別していなかった。

**コードフロー：**
```
ArticleSyncService.SyncArticles()
  → articleRepo.FetchInoreaderArticles()  # feed_url を取得
  → articleRepo.UpsertArticles()
    → driver.GetFeedID(article.FeedURL)   # feeds.link で検索
    → ERROR: no rows in result set        # 一致するレコードなし
```

一部の購読フィードはfeedsテーブルに登録されていないため、「フィードが見つからない」は想定される動作である。しかし、ERRORレベルでログ出力されていたため、実際のDBエラーと区別できなかった。

### 既存コードとの比較

同じcodebase内の`GetArticleByID`（`db_articles.go:251`）は正しく`pgx.ErrNoRows`をハンドリングしていた：

```go
if err == pgx.ErrNoRows {
    return nil, nil // Not found
}
```

## 決定事項

### アプローチ

`GetFeedID`を修正し、`pgx.ErrNoRows`を区別する「Graceful Not Found」パターンを採用。

### 実装内容

1. **`driver/db_feeds.go`**
   - nil dbチェックを追加
   - `pgx.ErrNoRows`の場合は`("", nil)`を返す
   - 実際のDBエラーの場合のみERRORログを出力

```go
if errors.Is(err, pgx.ErrNoRows) {
    // Feed not found - return empty string without error
    return "", nil
}
```

2. **`repository/article_repository.go`**
   - `UpsertArticles`: 空feedIDの場合はWARNログを出力し、記事をスキップ
   - `Create`: 空feedIDの場合はエラーを返す（記事作成には有効なfeed IDが必須）

### エラーハンドリング戦略

| 状況 | 戻り値 | ログレベル | 動作 |
|-----|-------|----------|-----|
| フィードが見つからない | `("", nil)` | WARN（呼び出し元） | 記事をスキップ |
| 実際のDBエラー | `("", err)` | ERROR | エラーを伝播 |
| nil db | `("", err)` | なし | エラーを返す |

## 結果・影響

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `driver/db_feeds.go` | `GetFeedID`に`pgx.ErrNoRows`チェックとnil dbチェック追加 |
| `driver/db_feeds_test.go` | 新規作成、nil dbテスト追加 |
| `repository/article_repository.go` | `Create`と`UpsertArticles`で空feedIDチェック追加 |

### メリット

- **ノイズ削減**: 想定される「フィード未登録」状態がERRORログとして出力されなくなる
- **可観測性向上**: 実際のDBエラーとnot foundを区別できる
- **一貫性**: 他のdriver関数（`GetArticleByID`等）と同じエラーハンドリングパターンを適用

### デメリット・トレードオフ

- **呼び出し元の責任**: 空文字列チェックを呼び出し元で行う必要がある
- **サイレントスキップ**: フィードが見つからない記事はWARNログのみでスキップされる

## 付録

### 動作確認

```bash
# コンテナ再ビルド・起動
docker compose -f compose/compose.yaml -p alt up -d --build pre-processor

# 修正前: ERRORレベル
# ERROR pre-processor Failed to get feed ID no rows in result set

# 修正後: WARNレベル
# WARN feed not found, skipping article feedURL=... articleURL=...

# ERRORメッセージが出ないことを確認
docker compose -f compose/compose.yaml -p alt logs pre-processor | grep -i "error.*feed"
```

### テスト実行

```bash
cd pre-processor/app && go test ./driver/... ./repository/...
```

### 関連ADR

- ADR-158: pre-processorの記事upsert時UUID空文字列エラーの修正
