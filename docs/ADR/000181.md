# tag-generator KeyBERT日本語スコアリング修正

## ADR's STATUS

Accepted (実装完了)

## CONTEXT

### 問題点

ADR-176で導入した日本語KeyBERTスコアリング機能が、本番環境で100%失敗していることが判明した。

**症状:**
```
Japanese KeyBERT scoring completed candidates_count=30 result_count=0
Primary extraction yielded no tags, invoking fallback
No tags could be extracted
```

**影響:**
- 日本語記事のタグ抽出が完全に失敗（tag_count=0）
- フォールバック処理も同じ問題で失敗
- 英語記事は正常に動作（KeyBERTがcandidatesパラメータを使用しないため）

### 根本原因

sklearn の `CountVectorizer` と KeyBERT の相互作用に起因するバグ。

```
CountVectorizer のデフォルト: lowercase=True
  ↓
入力テキスト: "GitHubでコードを管理" → "githubでコードを管理" (小文字化)
  ↓
candidates リスト: ["GitHub", "AWS", "API"] → そのまま維持（大文字）
  ↓
マッチング: "GitHub" vs "github" → 不一致 → result_count=0
```

KeyBERT の `extract_keywords()` メソッドは、`candidates` パラメータ使用時に内部で CountVectorizer を使って候補とテキストをマッチングする。CountVectorizer のデフォルト設定 `lowercase=True` により、テキストは小文字化されるが candidates リストはそのまま保持されるため、大文字を含む候補（技術用語に多い）がマッチしない。

### 参考資料

- [KeyBERT CountVectorizer Guide](https://maartengr.github.io/KeyBERT/guides/countvectorizer.html)
- [KeyBERT FAQ - Multilingual Support](https://maartengr.github.io/KeyBERT/faq.html)
- [sklearn CountVectorizer Documentation](https://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.CountVectorizer.html)

## DECISION MAKING

### 解決策

KeyBERT の `extract_keywords()` 呼び出し時に、カスタム CountVectorizer を `lowercase=False` で渡す。

```python
from sklearn.feature_extraction.text import CountVectorizer

vectorizer = CountVectorizer(
    lowercase=False,  # 大文字を保持してマッチング
    token_pattern=r"(?u)\b\w+\b",  # Unicode対応トークン化
)

keywords = keybert.extract_keywords(
    text,
    candidates=candidates,
    vectorizer=vectorizer,  # カスタムvectorizer
)
```

### 代替案（不採用）

**案: candidates を小文字変換**
```python
candidates_lower = [c.lower() for c in candidates]
```

**不採用理由:**
- 結果を元のケースにマッピングし直す必要がある
- 技術用語の正式表記（GitHub, AWS, TensorFlow）が失われる
- 追加のロジックで複雑性が増す

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `tag_extractor/extract.py` | `_score_japanese_candidates_with_keybert` にカスタムvectorizer追加 |
| `tag_extractor/hybrid_extractor.py` | `_score_with_keybert` に同様の修正 |

### 新規テストファイル

| ファイル | テスト数 | 内容 |
|---------|---------|------|
| `tests/unit/test_keybert_japanese_scoring.py` | 6 | vectorizer設定と大文字候補スコアリングのテスト |

### 追加テスト (既存ファイル)

| ファイル | 追加テスト数 | 内容 |
|---------|-------------|------|
| `tests/unit/test_hybrid_extractor.py` | 3 | HybridExtractor のvectorizer設定テスト |

### 修正後の動作確認

**修正前:**
```
Japanese KeyBERT scoring completed candidates_count=30 result_count=0
No tags could be extracted
```

**修正後:**
```
Japanese KeyBERT scoring completed candidates_count=30 result_count=10
Extraction successful keywords=['ChromeOS', 'GitHub', ...]
tag_count=10
```

### PROS

1. **最小限の変更**: 2ファイルの1メソッドずつのみ修正
2. **後方互換**: 既存API/設定に影響なし
3. **技術用語保持**: GitHub, AWS, TensorFlow 等の正式表記を維持
4. **TDDプロセス**: 失敗テストを先に作成し、修正後にパス確認

### CONS, TRADEOFF

1. **sklearn依存の明示化**: CountVectorizer を直接インポート
2. **わずかなオーバーヘッド**: vectorizerインスタンス生成（無視できるレベル）

## APPENDIX

### TDD実装フロー

```
1. テスト作成 (RED)
   └─ test_uppercase_candidates_are_scored: FAILED
   └─ test_vectorizer_has_lowercase_false: FAILED

2. 実装修正 (GREEN)
   └─ extract.py: vectorizer追加
   └─ hybrid_extractor.py: vectorizer追加
   └─ 全テスト: PASSED

3. リファクタリング (REFACTOR)
   └─ ruff format/check 適用
   └─ noqa コメント追加（S106誤検知対策）
```

### 修正コード

```python
# tag_extractor/extract.py:616-650
def _score_japanese_candidates_with_keybert(
    self, text: str, candidates: list[str], freq_counter: Counter[str]
) -> tuple[list[str], dict[str, float]]:
    if self._keybert is None:
        raise RuntimeError("KeyBERT not initialized")

    # CRITICAL FIX (ADR-176): Use custom CountVectorizer with lowercase=False
    from sklearn.feature_extraction.text import CountVectorizer

    vectorizer = CountVectorizer(
        lowercase=False,
        token_pattern=r"(?u)\b\w+\b",
    )

    keywords = self._keybert.extract_keywords(
        text,
        candidates=candidates,
        top_n=min(len(candidates), self.config.top_keywords * 2),
        use_mmr=self.config.use_mmr,
        diversity=self.config.japanese_mmr_diversity,
        vectorizer=vectorizer,
    )
    # ... 後続処理
```

### 関連ADR

- ADR-176: tag-generator 日本語タグ生成品質改善（本ADRはその実装中に発見されたバグの修正）
