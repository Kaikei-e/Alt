# rask-log-forwarder Rust 2024 Edition Pedantic Lint リファクタリング

## ADR'S STATUS

Accepted

## CONTEXT

### 背景

rask-log-forwarderは超高性能ログフォワーディングサイドカー（>4GB/s SIMD JSON パース）として稼働しているが、Rust 2024 Edition準拠とClippy pedantic lintsへの対応が未完了であった。

初期状態:
- **Clippy pedantic警告**: 378件
- **主要な警告カテゴリ**:
  - `missing_errors_doc`: 104件
  - `must_use_candidate`: 92件
  - `unused_async`: 17件
  - `needless_raw_string_hashes`: 14件
  - `cast_*`系: 約30件
  - `unused_self`: 13件
  - `redundant_closure`: 11件

### 要件

1. **TDD-First**: 既存テスト(367件)が通過し続けること
2. **ビルド成功**: `cargo build`がエラーなく完了
3. **警告削減**: 不要な警告を修正または適切に許可
4. **後方互換性維持**: 公開APIを変更しない

## DECISION MAKING

### 決定

6フェーズの段階的リファクタリングを実施する。各フェーズでビルド・テストを検証。

### Phase 1: 基盤整備（低リスク・高影響）

**機械的に修正可能な警告を解消:**

1. **数値リテラルセパレーター追加**
   - `100000` → `100_000` (config.rs, application_initializer.rs)
   - `123456789` → `123_456_789` (テストコード)

2. **Raw stringハッシュ削除**
   - `r#"..."#` → `r"..."` (引用符を含まないパターン)
   - build.rsの生成コードも修正

3. **format_push_string修正**
   - `push_str(&format!(...))` → `writeln!(...)` (build.rs)

### Phase 2: 構文改善（中リスク）

1. **redundant_else修正**
   - `if { return; } else { ... }` → `if { return; } ...`

2. **redundant_closure修正**
   - `.map(|s| s.to_string())` → `.map(str::to_string)`
   - `.map(|s| s.len())` → `.map(String::len)`

### Phase 3: 型安全性向上

**cast_possible_truncation対応:**

安全なキャストには`#[allow]`を追加し、理由をコメント:

```rust
// Safety: initialization time won't exceed u64::MAX milliseconds
#[allow(clippy::cast_possible_truncation)]
let time_ms = (elapsed.as_micros() / 1000) as u64;
```

### Phase 4: クレートレベルリント設定

lib.rsに以下の許可を追加:

```rust
#![allow(
    clippy::must_use_candidate,     // 内部関数には不要
    clippy::missing_errors_doc,     // 内部APIにはドキュメント不要
    clippy::cast_precision_loss,    // メトリクス計算には許容
    clippy::unused_async,           // API一貫性のために維持
    clippy::unused_self,            // 将来の拡張性のために維持
    clippy::match_same_arms,        // コードの明確性のため
    clippy::doc_markdown,           // 内部APIには不要
    clippy::module_name_repetitions // 型名の明確性のため
)]
```

### Phase 5: map_unwrap_or パターン改善

```rust
// Before
.map(|m| m.as_str()).unwrap_or("")

// After
.map_or("", |m| m.as_str())
// または
.is_some_and(|mode| mode.starts_with("service:"))
```

### Phase 6: 残存警告の分類と対応

残存警告(63件)は以下に分類:
- 意図的な設計決定（許可済み）
- 将来の改善候補（低優先度）

### 設計根拠

1. **クレートレベル許可**: 内部APIの90%以上に同じ許可が必要なため、個別より効率的
2. **選択的`#[must_use]`**: 重要な公開APIのみに適用
3. **async維持**: API一貫性と将来の拡張性を優先

## RESULTS, EFFECTS

### 警告削減結果

| メトリック | Before | After | 削減率 |
|-----------|--------|-------|--------|
| Clippy pedantic警告 | 378件 | 63件 | 83% |
| ビルド時警告 | 8件 | 0件 | 100% |
| テスト | 367 pass | 367 pass | 維持 |

### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `src/lib.rs` | クレートレベルリント設定追加 |
| `build.rs` | raw string削除、format_push_string修正 |
| `src/app/config.rs` | 数値リテラルセパレーター |
| `src/app/application_initializer.rs` | キャスト許可追加 |
| `src/app/docker.rs` | is_some_and使用 |
| `src/app/mod.rs` | #[must_use]追加 |
| `src/buffer/batch.rs` | redundant_closure修正 |
| `src/buffer/lockfree.rs` | キャスト許可追加 |
| `src/parser/registry.rs` | map_or使用 |
| `src/parser/services.rs` | map_or使用、キャスト許可 |
| `src/parser/regex_*.rs` | raw string削除 |
| `src/reliability/mod.rs` | redundant_else修正 |
| `src/reliability/metrics.rs` | キャスト許可追加 |
| `src/reliability/retry.rs` | キャスト許可追加 |
| `src/sender/metrics.rs` | キャスト許可追加 |
| `src/collector/discovery.rs` | redundant_closure修正 |

### PROS

1. **コード品質向上**: Rust 2024 Editionベストプラクティス準拠
2. **可読性向上**: 数値リテラルセパレーター、簡潔なパターン
3. **保守性向上**: 明確なリント許可理由のドキュメント化
4. **型安全性**: キャスト箇所に安全性コメント追加
5. **将来の拡張性**: async/self引数を維持

### CONS, TRADEOFF

1. **許可リスト**: 8つのクレートレベル許可（コメントで理由明記）
2. **残存警告**: 63件（意図的な設計決定として許容）
3. **リファクタリングコスト**: 約15ファイルの修正

## APPENDIX

### 検証コマンド

```bash
cargo clean
cargo build
cargo test
cargo clippy -- -W clippy::pedantic 2>&1 | grep -c "^warning:"  # 目標: <100
```

### リント許可の根拠

| リント | 許可理由 |
|--------|----------|
| `must_use_candidate` | 内部関数の90%以上が対象、個別対応は非効率 |
| `missing_errors_doc` | 内部APIのエラー詳細はコード参照で十分 |
| `cast_precision_loss` | メトリクス計算では厳密な精度不要 |
| `unused_async` | 将来の非同期化に備えたAPI設計 |
| `unused_self` | メソッドチェーン対応、テスト容易性 |
| `match_same_arms` | 将来の分岐追加を想定した明示的分岐 |
| `doc_markdown` | 内部コードには過度な制約 |
| `module_name_repetitions` | 型名の明確性を優先 |

### 今後の改善候補

- `unnecessary_wraps`: 4件 - 戻り値型の見直し検討
- `single_char_pattern`: 4件 - char定数への変換
- `needless_pass_by_value`: 5件 - 参照渡しへの変更検討
