# rask-log-aggregator TDD-First リファクタリング

## ADR'S STATUS

Accepted

## CONTEXT

### 背景

rask-log-aggregatorは高性能ログ集約サービスとして稼働しているが、コード品質とRust 2024 Editionベストプラクティスへの準拠に改善の余地があった。

主な課題:
1. **リント設定の不足**: `#![warn(rust_2018_idioms)]`のみで、厳格な警告管理がなかった
2. **エラー型の混在**: `anyhow::Error`と`thiserror::Error`が混在し、型安全性が低下
3. **設定値の検証不足**: ポート番号やホスト名の検証がなく、起動時エラーが不明確
4. **DiskCleanerの永続ループ**: graceful shutdown機構がなく、アプリケーション終了時に適切に停止しない

### 要件

1. **cargo check/clippyで警告ゼロ**: `#![deny(warnings)]`を有効化しても通過すること
2. **TDD-First開発**: すべての変更は先にテストを書いてから実装
3. **後方互換性維持**: 既存のAPIや動作を変更しない
4. **コードフォーマット準拠**: `cargo fmt`で差分が出ないこと

## DECISION MAKING

### 決定

5フェーズのTDD-Firstリファクタリングを実施する。

### Phase 1: リント・エディション衛生

**lib.rsの設定変更:**

```rust
#![deny(warnings)]
#![deny(rust_2018_idioms)]
#![warn(clippy::pedantic)]
#![allow(clippy::module_name_repetitions)]
#![allow(clippy::missing_errors_doc)]
#![allow(clippy::doc_markdown)]
```

`clippy::pedantic`を有効化しつつ、ドキュメント関連の過度に厳格なリントは許可。

### Phase 2: エラー型統合

**AggregatorError拡張:**

| バリアント | 用途 |
|-----------|------|
| `Config(String)` | 設定読み込みエラー |
| `Bind { address, source }` | ソケットバインドエラー |
| `Server(std::io::Error)` | サーバーエラー |
| `ClickHouse(String)` | ClickHouseクライアントエラー |
| `ProtoDecode(String)` | Protobufデコードエラー |
| `Export(String)` | エクスポートエラー |

`From`トレイト実装により、`clickhouse::error::Error`と`prost::DecodeError`からの自動変換を提供。

**LogExporter traitの変更:**

```rust
// Before
fn export_batch(&self, logs: Vec<EnrichedLogEntry>)
    -> Pin<Box<dyn Future<Output = Result<(), anyhow::Error>> + Send + '_>>;

// After
fn export_batch(&self, logs: Vec<EnrichedLogEntry>)
    -> Pin<Box<dyn Future<Output = Result<(), AggregatorError>> + Send + '_>>;
```

### Phase 3: 設定値検証

**Settings::validate()メソッド追加:**

```rust
impl Settings {
    pub fn validate(&self) -> Result<(), AggregatorError> {
        validate_host(&self.clickhouse_host)?;
        validate_port(self.clickhouse_port)?;
        Ok(())
    }
}
```

- ホスト: 空文字列・空白のみを拒否
- ポート: 0を拒否（1-65535のみ許可）

### Phase 4: DiskCleaner graceful shutdown

**CancellationTokenパターン導入:**

```rust
pub fn spawn(self, cancel_token: CancellationToken) -> JoinHandle<()> {
    tokio::spawn(async move { self.run(cancel_token).await })
}

async fn run(self, cancel_token: CancellationToken) {
    loop {
        tokio::select! {
            () = cancel_token.cancelled() => break,
            () = sleep(self.interval) => {
                self.perform_cleanup().await.ok();
            }
        }
    }
}
```

`tokio-util`クレートの`CancellationToken`を使用し、`tokio::select!`でシャットダウンシグナルを監視。

### Phase 5: Clone最適化分析

converter.rsの`resource_attrs.clone()`等を分析した結果、各`OTelLog`/`OTelTrace`構造体が属性の所有権を持つ必要があるため、**クローンは必要**と判断。`Arc`や`Cow`への変更はシリアライズを複雑化するため採用しない。

### 設計根拠

1. **pedantic lints有効化**: 潜在的なバグを早期発見、コード品質向上
2. **thiserror統一**: 型安全なエラーハンドリング、`?`演算子との親和性
3. **CancellationToken採用**: `tokio-util`の標準パターン、複数タスク間での共有が容易

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 種別 | 内容 |
|----------|------|------|
| `src/lib.rs` | 変更 | リント設定追加 |
| `src/error.rs` | 変更 | エラーバリアント追加、Fromトレイト実装、テスト追加 |
| `src/config.rs` | 変更 | validate()メソッド、検証関数、テスト追加 |
| `src/log_exporter/mod.rs` | 変更 | トレイト戻り値型変更、disk_cleanerモジュールエクスポート |
| `src/log_exporter/clickhouse_exporter.rs` | 変更 | AggregatorError使用 |
| `src/log_exporter/json_file_exporter.rs` | 変更 | AggregatorError使用 |
| `src/log_exporter/disk_cleaner.rs` | 変更 | CancellationToken対応、テスト追加 |
| `src/healthcheck.rs` | 変更 | format args修正 |
| `tests/handler_test.rs` | 変更 | MockExporter更新 |
| `Cargo.toml` | 変更 | tokio-util依存追加 |

### テストカバレッジ

| モジュール | テスト数 |
|-----------|---------|
| `error::tests` | 6 |
| `config::tests` | 8 |
| `disk_cleaner::tests` | 4 |
| 合計追加テスト | 18 |

### PROS

1. **コード品質向上**: clippy pedanticによる静的解析の強化
2. **型安全性向上**: anyhowからthiserrorへの統一でエラー型が明確化
3. **早期エラー検出**: 設定値検証により起動時に問題を発見
4. **graceful shutdown**: リソースリークやデータ損失のリスク低減
5. **テスト充実**: TDD-Firstによりリグレッション防止

### CONS, TRADEOFF

1. **依存追加**: `tokio-util`クレートの追加（ただし軽量）
2. **API変更**: `LogExporter::export_batch`の戻り値型変更（内部APIのため影響小）
3. **dead_code allow**: 一部未使用コードに`#[allow(dead_code)]`が必要

## APPENDIX

### 検証コマンド

```bash
# 全検証を実行
cargo check --all-targets
cargo clippy --all-targets -- -D warnings
cargo fmt --check
cargo test
```

### 依存関係

| クレート | バージョン | 用途 |
|---------|-----------|------|
| `tokio-util` | 0.7 | CancellationToken |
| `thiserror` | 2.0 | カスタムエラー型 |

### 関連コード

| ファイル | 関数/構造体 |
|----------|-------------|
| `src/error.rs` | `AggregatorError` |
| `src/config.rs` | `Settings::validate()` |
| `src/log_exporter/disk_cleaner.rs` | `DiskCleaner::spawn()` |
