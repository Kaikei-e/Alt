# ADR 98/99 ビジネスコンテキストロギングの全サービス展開

## ステータス

採択（Accepted）

## コンテキスト

### 背景

ADR 98（ClickHouseログ基盤の包括的改善）およびADR 99（マルチ言語サービスにおけるビジネスコンテキストロギングの実装）で定義されたロギング標準を、全マイクロサービスに展開する必要があった。

### 課題

| 課題 | 詳細 |
|------|------|
| 部分的な適合 | 一部サービスのみがADR 98/99に適合、残りは未実装 |
| 言語・フレームワークの多様性 | Go, Python, Rust, TypeScript/Denoの4言語に対応が必要 |
| 既存コードベースへの影響 | 各サービスの既存ロギング基盤を尊重しつつ拡張 |

### 実装前の状態

#### Go サービス

| サービス | ContextLogger | alt.*キー | 状態 |
|---------|---------------|-----------|------|
| alt-backend | 実装済 | 実装済 | 適合 |
| pre-processor | 実装済 | 実装済 | 適合 |
| rag-orchestrator | 実装済 | 実装済 | 適合 |
| search-indexer | 未実装 | 未実装 | 要対応 |
| auth-hub | 未実装 | 未実装 | 要対応 |
| mq-hub | 未実装 | 未実装 | 要対応 |

#### Python サービス

| サービス | BusinessContextFilter | alt.*キー | 状態 |
|---------|----------------------|-----------|------|
| tag-generator | 実装済 (structlog) | 実装済 | 適合 |
| news-creator | 実装済 (contextvars) | 実装済 | 適合 |
| recap-subworker | 未実装 | 未実装 | 要対応 |

#### Rust サービス

| サービス | StructuredLogLayer | OTel | 状態 |
|---------|-------------------|------|------|
| recap-worker | 実装済 | 部分的 | 要改善 |
| rask-log-aggregator | N/A (レシーバー) | N/A | 適合 |
| rask-log-forwarder | N/A (フォワーダー) | N/A | 適合 |

#### TypeScript/Deno サービス

| サービス | 構造化ログ | alt.*キー | 状態 |
|---------|-----------|-----------|------|
| alt-frontend | 未実装 | 未実装 | 要対応 |
| alt-perf | 実装済 | 未実装 | 要対応 |
| auth-token-manager | 実装済 | 未実装 | 要対応 |

## 決定

ADR 99で定義された言語別パターンを全未対応サービスに展開する。

### Go サービス: search-indexer, auth-hub, mq-hub

ADR 99のContext-Based Loggerパターンを適用。

```go
package logger

import (
    "context"
    "log/slog"
)

type ContextKey string

const (
    FeedIDKey          ContextKey = "alt.feed.id"
    ArticleIDKey       ContextKey = "alt.article.id"
    JobIDKey           ContextKey = "alt.job.id"
    ProcessingStageKey ContextKey = "alt.processing.stage"
    AIPipelineKey      ContextKey = "alt.ai.pipeline"
)

type ContextLogger struct {
    logger *slog.Logger
}

func (cl *ContextLogger) WithContext(ctx context.Context) *slog.Logger {
    logger := cl.logger
    for _, key := range []ContextKey{
        FeedIDKey, ArticleIDKey, JobIDKey,
        ProcessingStageKey, AIPipelineKey,
    } {
        if v := ctx.Value(key); v != nil {
            logger = logger.With(string(key), v)
        }
    }
    return logger
}

func WithArticleID(ctx context.Context, id string) context.Context {
    return context.WithValue(ctx, ArticleIDKey, id)
}
```

### Python サービス: recap-subworker

既存のstructlog基盤にビジネスコンテキストプロセッサーを追加。

```python
from structlog.typing import EventDict, WrappedLogger

def add_business_context(
    _logger: WrappedLogger,
    _method_name: str,
    event_dict: EventDict,
) -> EventDict:
    """Rename keys to OpenTelemetry semantic conventions."""
    key_mapping = {
        "job_id": "alt.job.id",
        "article_id": "alt.article.id",
        "feed_id": "alt.feed.id",
        "processing_stage": "alt.processing.stage",
    }
    for old_key, new_key in key_mapping.items():
        if old_key in event_dict:
            event_dict[new_key] = event_dict.pop(old_key)

    event_dict["alt.ai.pipeline"] = "recap-classification"
    return event_dict
```

### Rust サービス: recap-worker

OpenTelemetryクレートのバージョン互換性問題を解決。

```toml
# 修正前: バージョン不整合
opentelemetry = "0.31"
tracing-opentelemetry = "0.31"  # requires opentelemetry 0.30

# 修正後: 互換性のあるバージョン
opentelemetry = { version = "0.30", features = ["trace"] }
opentelemetry_sdk = { version = "0.30", features = ["rt-tokio"] }
opentelemetry-otlp = { version = "0.30", features = ["grpc-tonic"] }
tracing-opentelemetry = "0.31"
```

### TypeScript/Deno サービス

#### alt-frontend: Next.js用構造化ロガー

ブラウザ・サーバー両環境で動作する構造化ロガーを実装。

```typescript
type LogLevel = "debug" | "info" | "warn" | "error";

interface LogEntry {
  timestamp: string;
  level: LogLevel;
  message: string;
  "alt.feed.id"?: string;
  "alt.article.id"?: string;
  "alt.job.id"?: string;
  "alt.processing.stage"?: string;
  "alt.ai.pipeline"?: string;
  [key: string]: unknown;
}

class Logger {
  private context: Partial<LogEntry> = {};

  withFeedId(feedId: string): Logger {
    const logger = new Logger();
    logger.context = { ...this.context, "alt.feed.id": feedId };
    return logger;
  }

  info(message: string, data?: Record<string, unknown>): void {
    this.log("info", message, data);
  }

  private log(level: LogLevel, message: string, data?: Record<string, unknown>): void {
    const entry: LogEntry = {
      timestamp: new Date().toISOString(),
      level,
      message,
      ...this.context,
      ...data,
    };

    if (typeof window === "undefined") {
      console.log(JSON.stringify(entry));
    } else {
      console[level](message, entry);
    }
  }
}
```

#### alt-perf, auth-token-manager: ビジネスコンテキスト追加

既存の構造化ロガーにADR 98/99準拠のキーを追加。

```typescript
interface BusinessContext {
  feedId?: string;
  articleId?: string;
  jobId?: string;
  processingStage?: string;
  aiPipeline?: string;
}

let businessContext: BusinessContext = {};

export function setFeedId(feedId: string): void {
  businessContext.feedId = feedId;
}

function log(level: LogLevel, message: string, data?: Record<string, unknown>): void {
  const logEntry: Record<string, unknown> = {
    timestamp: new Date().toISOString(),
    level,
    msg: message,
    "service.name": SERVICE_NAME,
    // ADR 98/99 business context keys
    ...(businessContext.feedId && { "alt.feed.id": businessContext.feedId }),
    ...(businessContext.articleId && { "alt.article.id": businessContext.articleId }),
    ...(businessContext.jobId && { "alt.job.id": businessContext.jobId }),
    ...(businessContext.processingStage && { "alt.processing.stage": businessContext.processingStage }),
    ...(businessContext.aiPipeline && { "alt.ai.pipeline": businessContext.aiPipeline }),
    ...data,
  };
  console.log(JSON.stringify(logEntry));
}
```

## 結果

### 変更ファイル一覧

#### 新規作成

| ファイル | 言語 | 目的 |
|---------|------|------|
| `search-indexer/app/logger/context_logger.go` | Go | ContextLogger実装 |
| `search-indexer/app/logger/context_logger_test.go` | Go | 単体テスト |
| `auth-hub/utils/logger/context_logger.go` | Go | ContextLogger実装 |
| `auth-hub/utils/logger/context_logger_test.go` | Go | 単体テスト |
| `mq-hub/app/utils/logger/logger.go` | Go | ロガー初期化 |
| `mq-hub/app/utils/logger/context_logger.go` | Go | ContextLogger実装 |
| `mq-hub/app/utils/logger/logger_test.go` | Go | 単体テスト |
| `alt-frontend/src/lib/logger.ts` | TypeScript | 構造化ロガー |
| `alt-frontend/src/lib/logger.test.ts` | TypeScript | 単体テスト |

#### 修正

| ファイル | 変更内容 |
|---------|---------|
| `recap-subworker/recap_subworker/infra/logging.py` | `add_business_context`プロセッサー追加 |
| `recap-worker/recap-worker/Cargo.toml` | OpenTelemetryバージョン修正 (0.31→0.30) |
| `recap-worker/recap-worker/src/observability/tracing.rs` | OTel初期化有効化 |
| `alt-perf/src/utils/logger.ts` | `alt.*`キー追加 |
| `auth-token-manager/src/utils/logger.ts` | `alt.*`キー追加 |

### 実装後の状態

| 言語 | サービス数 | 適合数 | 適合率 |
|------|-----------|--------|--------|
| Go | 6 | 6 | 100% |
| Python | 3 | 3 | 100% |
| Rust | 3 | 3 | 100% |
| TypeScript/Deno | 3 | 3 | 100% |
| **合計** | **15** | **15** | **100%** |

### インフラ確認

| コンポーネント | 状態 | ファイル |
|---------------|------|---------|
| ClickHouseマイグレーション | 適用済 | `clickhouse/migrations/008_*.sql`, `009_*.sql` |
| Grafanaダッシュボード | 作成済 | `observability/grafana/dashboards/ai-pipeline-health.json` |
| アラートルール | 作成済 | `observability/alerts/ai-pipeline-rules.yaml` |

### 検証クエリ

```sql
-- ビジネスコンテキスト付与率の確認
SELECT
    ServiceName,
    count() AS total,
    countIf(LogAttributes['alt.article.id'] != '') AS with_article_id,
    countIf(LogAttributes['alt.job.id'] != '') AS with_job_id,
    countIf(LogAttributes['alt.ai.pipeline'] != '') AS with_pipeline
FROM otel_logs
WHERE Timestamp > now() - INTERVAL 1 HOUR
GROUP BY ServiceName
ORDER BY total DESC;
```

### トレードオフ

| PROS | CONS |
|------|------|
| 全15サービスで統一されたログ形式 | 各サービスに追加コードが必要 |
| ClickHouseでの横断的クエリが可能 | 開発者はコンテキスト設定を意識する必要あり |
| TDD手法により全変更にテストが付随 | Rustのバージョン制約による依存関係の複雑化 |
| OpenTelemetry互換の`alt.*`プレフィックス | カスタム属性のため外部ツールとの互換性は限定的 |

## 実装日

2026-01-15

## 関連

- [ADR 98: ClickHouse ログ基盤の包括的改善](./000098.md)
- [ADR 99: マルチ言語サービスにおける ADR 98 ビジネスコンテキストロギングの実装](./000099.md)
- [OpenTelemetry Semantic Conventions](https://opentelemetry.io/docs/concepts/semantic-conventions/)
