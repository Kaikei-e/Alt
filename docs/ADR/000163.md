# Evening Pulse UI Enhancement: 代表記事・エンティティ表示

## ステータス

承認済み（2026-01-31）

## 背景

### 課題

Evening Pulseのトピックカードが「Moderate impact news. Covered by 1 source.」のような汎用的なテキストのみを表示しており、ユーザーがトピックの内容を把握できない状態だった。

ユーザーが求める情報：
- このトピックは何についてなのか
- どのようなニュースソースが報じているのか
- 具体的な記事見出しは何か

### 要件

1. 代表記事（トップ3の見出し + ソース名）の表示
2. 主要エンティティ（人名・組織名など）のタグ表示
3. ソース名一覧の表示
4. デスクトップ・モバイル両対応

## 決定事項

### フルスタック実装

Proto → Rust Worker → Go Backend → TypeScript Schema → Svelte UIの全レイヤーを更新。

### スキーマ設計

#### Proto Schema (`proto/alt/recap/v2/recap.proto`)

```protobuf
message RepresentativeArticle {
  string article_id = 1;
  string title = 2;
  string source_url = 3;
  string source_name = 4;
  string published_at = 5;
}

message PulseTopic {
  // ... 既存フィールド ...
  repeated RepresentativeArticle representative_articles = 12;
  repeated string top_entities = 13;
  repeated string source_names = 14;
}
```

#### Rust Types (`recap-worker`)

```rust
pub struct RepresentativeArticle {
    pub article_id: String,
    pub title: String,
    pub source_url: String,
    pub source_name: String,
    pub published_at: String,
}

pub struct PulseTopic {
    // ... 既存フィールド ...
    #[serde(default)]
    pub representative_articles: Vec<RepresentativeArticle>,
    #[serde(default)]
    pub top_entities: Vec<String>,
    #[serde(default)]
    pub source_names: Vec<String>,
}
```

### ソース名抽出ロジック

URLからソース名を抽出する関数を実装：

```rust
fn extract_source_name(url: &str) -> String {
    // "https://www.reuters.com/..." -> "Reuters"
    reqwest::Url::parse(url)
        .ok()
        .and_then(|u| u.host_str().map(String::from))
        .map(|host| {
            let host = host.strip_prefix("www.").unwrap_or(&host);
            let parts: Vec<&str> = host.split('.').collect();
            if parts.len() >= 2 {
                // Capitalize first letter
                let name = parts[0];
                let mut chars: Vec<char> = name.chars().collect();
                if let Some(first) = chars.first_mut() {
                    *first = first.to_ascii_uppercase();
                }
                chars.into_iter().collect()
            } else {
                host.to_string()
            }
        })
        .unwrap_or_else(|| "Unknown".to_string())
}
```

### UI設計

#### デスクトップカード

```
[Role Badge]                    [timeAgo]
Title
[Entity] [Entity] [Entity]     ← rounded badges
- "Headline 1" - Reuters       ← representative articles
- "Headline 2" - BBC
[Rationale with confidence]
[8 articles] [5 sources] [Reuters, BBC, +3 more]
```

#### モバイルカード（コンパクト）

- タイトル + トップ3エンティティ
- 最初の1件のヘッドライン + ソース名
- 記事数・ソース数

#### モバイルシート（展開時）

- 全エンティティ一覧
- 全代表記事リスト（クリック可能なリンク付き）
- 全ソース名一覧
- 選定理由（rationale）

## 結果・影響

### 変更ファイル

| レイヤー | ファイル | 変更内容 |
|---------|---------|----------|
| Proto | `proto/alt/recap/v2/recap.proto` | RepresentativeArticle追加、PulseTopic拡張 |
| Rust | `recap-worker/src/pipeline/pulse/types.rs` | 新型定義 |
| Rust | `recap-worker/src/pipeline/pulse/stage.rs` | 代表記事・ソース名抽出 |
| Rust | `recap-worker/src/pipeline/pulse/selection.rs` | フィールドコピー |
| Rust | `recap-worker/src/api/pulse.rs` | APIレスポンス拡張 |
| Go | `alt-backend/app/domain/evening_pulse.go` | ドメイン型追加 |
| Go | `alt-backend/app/connect/v2/recap/handler.go` | Proto変換 |
| TS | `alt-frontend-sv/src/lib/schema/evening_pulse.ts` | 型定義 |
| TS | `alt-frontend-sv/src/lib/connect/evening_pulse.ts` | Proto変換 |
| Svelte | `DesktopPulseCard.svelte` | UI実装 |
| Svelte | `MobilePulseCard.svelte` | コンパクトUI |
| Svelte | `MobilePulseTopicSheet.svelte` | 展開UI |

### 後方互換性

- `#[serde(default)]`属性により、既存データでも新フィールドは空配列として扱われる
- UIは条件付きレンダリング（`{#if topic.representativeArticles?.length > 0}`）で対応
- API responseは追加フィールドのみ、既存フィールドへの変更なし

### テスト結果

```
Rust: 97 tests passed (pipeline::pulse)
Go:   ok  alt/connect/v2/recap
TS:   svelte-check found 0 errors
```

## 利点

### ユーザー体験の向上

- トピックの内容が一目で把握可能
- ニュースソースの信頼性を判断可能
- 興味のある記事へ直接アクセス可能

### 技術的メリット

- 全レイヤーで型安全
- 後方互換性維持
- 既存テストへの影響なし

## トレードオフ

### データ量の増加

- 各トピックに最大3件の代表記事情報が追加
- ペイロードサイズ: 約500-1000バイト/トピック増加
- 3トピックで最大3KB程度の増加

### 処理オーバーヘッド

- クラスター処理時に代表記事選択のロジック追加
- URL解析によるソース名抽出
- 影響は軽微（クラスター処理全体の1%未満）

## 関連ADR

- ADR-161: Evening Pulse v4.0 実装
- ADR-162: Evening Pulse スキーマ増分マイグレーション
