# ADR-000218: pre-processor-sidecar 管理API認証のフェイルクローズ化と権限判定の厳格化

## STATUS

Accepted（実装完了・テスト通過・関連コンテナ再ビルド/再起動確認済み）

## CONTEXT

`pre-processor-sidecar` の管理API認証では、以下のCRITICALリスクがあった。

1. 公開鍵が初期化できない場合でも、署名検証なしのフォールバック検証に進む経路が存在した。
2. 管理者権限判定が広く、同一namespaceや開発向け例外により過剰に許可される可能性があった。

特に、認証初期化失敗時に「可能な範囲で通す」挙動が残ると、運用ミス時に管理APIの防御境界が弱くなる。  
そのため、管理操作に関わる認証は「失敗時は拒否（fail-closed）」へ統一する必要があった。

## DECISION MAKING

以下の方針で修正した。

1. トークン検証をフェイルクローズ化
2. 管理者権限判定を明示的allowlist中心へ変更
3. 回帰防止テストを追加

### 修正方針 1: 署名検証不可時は即時拒否

- 公開鍵未初期化時に `ValidateKubernetesServiceAccountToken` がエラーを返すよう変更。
- 署名なしでクレームだけ読む `validateTokenBasic` 経路を削除。
- 必須クレーム（subject/namespace/service account）と subject整合性（`system:serviceaccount:<namespace>:<name>`）を必須化。

### 修正方針 2: 管理者判定を最小権限化

- `HasAdminPermissions` で以下を必須化。
  - `namespace/name/subject` 欠落時は拒否
  - トークンnamespaceと実行namespaceの一致
  - `subject` と `namespace/name` の整合性
- デフォルト許可対象は限定的なServiceAccountのみ。
- 追加許可は環境変数allowlist（`PRE_PROCESSOR_ADMIN_SERVICE_ACCOUNTS`, `PRE_PROCESSOR_ADMIN_SUBJECTS`）で明示的に付与。

### 修正方針 3: 初期化失敗時メッセージの明確化

- 初期化失敗ログを「fallbackで継続」から「管理認証を拒否する」意図に合わせた内容へ更新。

## RESULTS

### 変更ファイル

| ファイル | 変更内容 |
|---|---|
| `pre-processor-sidecar/app/security/kubernetes_auth.go` | 署名検証不可時の拒否、基本検証フォールバック削除、subject整合性チェック追加、管理者判定ロジックの厳格化、allowlist導入 |
| `pre-processor-sidecar/app/security/kubernetes_auth_test.go` | CRITICALシナリオを含むユニットテストを新規追加 |

### テスト結果

| 実行コマンド | 結果 |
|---|---|
| `cd pre-processor-sidecar/app && go test ./security` | `ok` |

### コンテナ検証

| 検証 | 結果 |
|---|---|
| `docker compose -f compose/compose.yaml build pre-processor-sidecar` | 成功 |
| `docker compose -f compose/compose.yaml up -d pre-processor-sidecar` | 成功 |
| `docker compose -f compose/compose.yaml ps pre-processor-sidecar` | `Up ... (healthy)` を確認 |
| `docker compose -f compose/compose.yaml logs --tail=120 pre-processor-sidecar` | 起動完了ログを確認（異常終了なし） |

## PROS

1. 認証初期化や鍵ロードに失敗した場合でも、管理認証を通さないため防御境界が明確。
2. 署名なし検証経路を排除し、JWT検証の前提を一貫化できた。
3. 権限付与が暗黙条件から明示allowlistへ移行し、最小権限に寄せられた。
4. テスト追加により、今回のCRITICAL修正の回帰検知が可能になった。

## CONS, TRADEOFF

1. KubernetesのServiceAccountファイル（CA/namespace）が無い環境では、管理認証は拒否される。  
   ローカルComposeなどで管理APIを使う場合は、想定した認証設定が必要。
2. 従来の緩い許可条件に依存していた運用では、allowlist設定の追加作業が必要になる。

## APPENDIX

### 追加した主なテスト観点

- 公開鍵未初期化時の検証拒否
- 暗黙namespace許可の拒否
- `default` ServiceAccountの拒否
- 他namespaceの管理ServiceAccount拒否
- 明示許可された管理ServiceAccountの許可
- 環境変数allowlistでの許可拡張

