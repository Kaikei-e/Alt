# ADR-000221: Desktop検索 Infinite Scroll の "Loading more..." 永続表示バグ修正

## STATUS

Accepted（実装完了・テスト通過・コンテナ再ビルド/再起動確認済み）

## CONTEXT

Desktop版 `/sv/feeds/search` で2回目以降のページ読み込み時、"Loading more..." スピナーが消えず永続表示されるバグが発生していた。

### 根本原因

3つの問題が組み合わさりバグを引き起こしていた。

**問題1: エラー時に `hasMore` がリセットされない**

`loadMore()` 内で `result.error` の場合に早期 return していたが、`hasMore = true` のまま残るため IntersectionObserver が再発火し、同じエラーが繰り返される無限ループが発生していた。

```typescript
// 修正前: hasMore が true のまま残る
if (result.error) return;
```

**問題2: `disabled: isLoadingMore` toggle による observer 再作成の副作用**

`isLoadingMore` の変化により Svelte action の `update()` が毎回発火し、observer の disconnect → recreate サイクルが1回の `loadMore` につき2回発生していた。この過程で observer callback の `finally` ブロックが新しい observer と干渉する可能性があった。

**問題3: 保守的すぎるタイミング設定**

- `LOAD_COOLDOWN_MS = 200` のクールダウンタイマーは問題2の対症療法として追加されたもので、根本原因の解消により不要
- `setTimeout(100)` による re-observe delay は `requestAnimationFrame` (~16ms) で十分

### 副次的な問題

Connect-RPC プロキシの `console.log` が毎リクエスト3回出力されており、ログノイズとなっていた。

## DECISION MAKING

根本原因を解消する方針で修正を行った。対症療法的なクールダウンは除去。

### 修正1: エラー時の `hasMore` リセット

エラー発生時に `hasMore = false` を設定し、observer の再発火による無限ループを防止する。

### 修正2: `disabled` toggle の削除

`use:infiniteScroll` から `disabled: isLoadingMore` を除去。observer 再作成サイクルの根本原因を排除した。`loadMore()` 内の `isLoadingMore` ガードと action 内部の `unobserve/re-observe` で重複呼び出しは防止される。

### 修正3: クールダウン削除

修正2により observer 連鎖発火の根本原因が解消されたため、`lastLoadTime` / `LOAD_COOLDOWN_MS` による対症療法的なクールダウンを削除。

### 修正4: re-observe delay の短縮

`setTimeout(100)` を `requestAnimationFrame` (~16ms) に変更。DOM 更新の反映を待つ目的にはフレーム同期で十分。

### 修正5: プロキシの debug log 削除

`console.log` 3箇所を削除。エラーログ（`console.error`）は維持。

## RESULTS

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/src/routes/desktop/feeds/search/+page.svelte` | エラー時 `hasMore` リセット、`disabled` 削除、クールダウン削除 |
| `alt-frontend-sv/src/lib/actions/infinite-scroll.ts` | `setTimeout(100)` → `requestAnimationFrame` |
| `alt-frontend-sv/src/routes/api/v2/[...path]/+server.ts` | `console.log` 3箇所削除 |

### テスト結果

| 実行コマンド | 結果 |
|---|---|
| `vitest run src/lib/actions/infinite-scroll.test.ts` | 7 tests passed (4ms) |

### コンテナ検証

| 検証 | 結果 |
|---|---|
| `docker compose build alt-frontend-sv` | 成功 |
| `docker compose up -d alt-frontend-sv` | 成功 |
| `curl http://localhost:3000/api/health` | `{"status":"ok"}` |

## PROS

1. 根本原因の解消により対症療法（クールダウン）が不要になり、コードが簡潔になった
2. observer 再作成サイクルの排除により、1回の `loadMore` あたりの IntersectionObserver 操作が2回削減
3. re-observe delay の短縮（100ms → ~16ms）でページ送りのレイテンシが改善
4. プロキシの不要なログ削除によりログノイズが減少

## CONS, TRADEOFF

1. エラー時に `hasMore = false` とするため、一時的なネットワークエラーでもページネーションが停止する。再検索が必要になるが、ユーザー体験としては無限ループよりも安全な方向に倒している
2. `disabled` toggle の削除により、observer は `isLoadingMore` 中もアクティブなままとなるが、`loadMore()` 冒頭のガード条件で実質的に二重実行は防止される

## APPENDIX

- 前提: ADR-000219（クールダウン追加と検索クライアント改善）、ADR-000220（レイテンシ改善の初期対応）
- 本 ADR は ADR-000220 で残された observer 再作成コストの改善を含む
