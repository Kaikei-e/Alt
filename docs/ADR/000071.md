# altctl logging スタックの依存関係修正

## ステータス

採択（Accepted）

## コンテキスト

`altctl up` コマンドで複数スタックを起動する際、明示的に指定していないスタックが自動的に起動され、スタック全体の起動に失敗する問題が発生した。

### 問題の再現

```bash
altctl up ai auth base db logging rag recap workers
```

上記コマンド実行時、`core` スタックを指定していないにも関わらず、`alt-frontend-sv` コンテナが起動され、そのヘルスチェック失敗により全体が起動できなかった。

### 根本原因

`altctl/internal/stack/registry.go` において、`logging` スタックの依存関係が過剰に定義されていた：

```go
{
    Name:        "logging",
    Description: "Logging infrastructure (rask log forwarders)",
    ComposeFile: "logging.yaml",
    Services:    []string{"rask-log-aggregator", "nginx-logs", ...},
    DependsOn:   []string{"base", "db", "core", "workers", "ai"},  // 問題の箇所
}
```

`logging` スタックが `core` に依存しているため、依存関係解決時に `core` スタック全体（`nginx`, `alt-frontend`, `alt-frontend-sv`, `alt-backend`）が暗黙的に追加されていた。

## 決定

`logging` スタックの依存関係を最小限に修正する。

### 変更内容

**変更前:**
```go
DependsOn: []string{"base", "db", "core", "workers", "ai"},
```

**変更後:**
```go
DependsOn: []string{"base", "db"},
```

### 理由

1. **logging スタックの責務**: ログフォワーダーは各サービスのコンテナログを収集・転送するのみで、アプリケーションロジックに依存しない
2. **明示的な起動**: `core`, `workers`, `ai` が必要な場合、ユーザーがコマンドで明示的に指定する
3. **依存解決の原則**: 暗黙的な依存は最小限にし、ユーザーの意図を尊重する

## 結果

### 変更されたファイル

| ファイル | 変更内容 |
|---------|---------|
| `altctl/internal/stack/registry.go` | `logging` スタックの `DependsOn` を `["base", "db"]` に変更 |

### 依存グラフの変化

**変更前:**
```
logging → core → (nginx, alt-frontend, alt-frontend-sv, alt-backend)
        → workers
        → ai
```

**変更後:**
```
logging → base
        → db
```

### メリット

1. **予測可能な動作**: 指定したスタックのみが起動される
2. **起動時間短縮**: 不要なコンテナが起動されない
3. **障害の局所化**: 無関係なサービスのヘルスチェック失敗に影響されない

### トレードオフ

1. **明示的な指定が必要**: ログ収集対象のスタックをユーザーが意識して起動する必要がある（ただし、これは本来の期待動作）

## 検証

```bash
# ビルド
cd altctl && go build -o altctl .

# テスト
go test ./...
# 結果: ok github.com/alt-project/altctl/internal/stack

# 依存グラフ確認
./altctl list --deps
# 結果: logging が base → db のみに依存していることを確認
```

## 実装日

2026-01-10

## 関連

- altctl スタック管理の設計については `altctl/CLAUDE.md` を参照
