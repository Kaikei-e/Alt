# ADR-000214: 要約遅延問題の解消 - トークン予算フォールバックと非再試行エラー分類

## STATUS

Accepted（実装完了・コンテナ再ビルド・ヘルスチェック確認済み）

## CONTEXT

### 背景

news-creator の要約処理において、特定の長文記事がコンテキストウィンドウ閾値の境界付近に位置することで、LLM が退化出力（空白・ホワイトスペースのみ）を繰り返し生成する問題が発生していた。

### 根本原因: コンテキストウィンドウ閾値のギャップ

コンテンツ長 ~20,000 文字の記事が以下のギャップに嵌まっていた:

1. `hierarchical_single_article_threshold`（20,000 chars）の境界線上 → 階層的要約に入らない
2. 通常パスで prompt_tokens ~5,500 + num_predict 1,200 = **~6,700 tokens → 8,192 の 82%**
3. モデルがコンテキスト 80% 超で退化 → 空白のみ出力
4. 各試行 77〜242 秒の GPU 時間浪費 → HTTP 500 → 上流がリトライ → 無限ループ

### カスケード障害

セマフォ独占 → 他の要約リクエストが最大 457 秒待機 → キュー満杯 → バースト的な 500 エラー

### 定量的影響（直近ログ 2000 行）

| 指標 | 値 |
|------|-----|
| ERROR ログ | 58 件 |
| QueueFullError（キュー満杯バースト） | 42 件 |
| 空白応答エラー | 13 件 |
| BE→RT 昇格（長時間待機） | 44 件 |
| 成功した要約 | 30 件 |

正常な記事（prompt_tokens 1,300〜3,900）は 9〜27 秒、30〜49 tok/s で健全に完了していた。

## DECISION MAKING

### 方針

2 つの施策を組み合わせて解消する:

1. **P1: トークン予算ベースの階層的要約フォールバック** — モデル退化が起こる前に検知し、安全なパスへルーティング
2. **P0: 空白応答時の HTTP 422 レスポンス** — 退化が起きた場合でも、即座に非再試行エラーとして扱い dead_letter へ移動

### P1: トークン予算チェック

プロンプト構築後に `estimated_prompt_tokens + summary_num_predict` を計算し、コンテキストウィンドウの 75% を超過する場合は階層的要約（Map-Reduce）にフォールバックする。

```
total_token_budget = estimated_prompt_tokens + summary_num_predict
budget_limit = context_window * 75 / 100

if total_token_budget > budget_limit:
    → hierarchical summarization
```

計算根拠:
- 75% of 8,192 = 6,144 tokens（budget_limit）
- 20,000 chars content → prompt ~5,250 tokens + predict 1,000 = 6,250 → **超過** → hierarchical
- 15,000 chars content → prompt ~4,000 + 1,000 = 5,000 → 範囲内 → 通常パス

閾値は `HIERARCHICAL_TOKEN_BUDGET_PERCENT` 環境変数で調整可能（デフォルト 75）。

### P0: 非再試行エラー分類

LLM が連続して空白出力を返した場合:
1. news-creator が HTTP 422 を返す（従来は 502）
2. pre-processor が 422 を `ErrContentNotProcessable` として認識
3. 即座に `dead_letter` へ移動（リトライループを回避）

## RESULTS

### news-creator 変更

| ファイル | 変更内容 |
|---------|---------|
| `config/config.py` | `HIERARCHICAL_TOKEN_BUDGET_PERCENT` パラメータ追加（デフォルト 75） |
| `usecase/summarize_usecase.py` | プロンプト構築後にトークン予算チェックを挿入。超過時は `_generate_hierarchical_summary` へフォールバック |
| `handler/summarize_handler.py` | `RuntimeError` の分岐処理: "empty/whitespace summary" → HTTP 422、その他 → HTTP 502（既存動作維持） |
| `tests/usecase/test_summarize_usecase.py` | 4 テスト追加: 予算超過フォールバック、予算内通常パス、文字数閾値後方互換、閾値設定可能 |
| `tests/handler/test_summarize_handler.py` | 2 テスト追加: 空白応答 → 422、その他エラー → 502 |

### pre-processor 変更

| ファイル | 変更内容 |
|---------|---------|
| `domain/errors.go` | `ErrContentNotProcessable` sentinel error 追加 |
| `driver/summarizer_api.go` | HTTP 422 → `ErrContentNotProcessable` マッピング（同期・ストリーミング両パス） |
| `repository/external_api_repository.go` | `ErrContentNotProcessable` の伝播 |
| `service/summarize_queue_worker.go` | `ErrContentNotProcessable` / `ErrContentTooShort` 受信時に即座に `dead_letter` へ移動（リトライスキップ） |

### テスト結果

| テスト | 結果 |
|--------|------|
| `news-creator pytest` | 214 passed |
| `pre-processor go test ./domain/... ./driver/... ./service/... ./repository/...` | 全パッケージ PASS |

### コンテナ検証

| 検証 | 結果 |
|------|------|
| `docker compose build news-creator pre-processor` | 成功 |
| news-creator ヘルスチェック (`/health`) | 200 OK (healthy) |
| pre-processor ヘルスチェック (`/api/v1/health`) | 200 OK (healthy) |

## PROS

1. **予防的**: トークン予算チェックにより、モデル退化が起こる前に安全なパスへルーティング。GPU 時間の浪費を防止
2. **後方互換**: 文字数閾値（`hierarchical_single_article_threshold`）が先にチェックされるため、既存動作に影響なし
3. **設定可能**: `HIERARCHICAL_TOKEN_BUDGET_PERCENT` 環境変数で閾値を調整可能
4. **カスケード障害の防止**: 非再試行エラーにより即座に dead_letter 化。セマフォ独占とキュー満杯バーストを解消
5. **TDD 準拠**: 全変更にテストが先行

## CONS, TRADEOFF

1. **トークン推定の精度**: `prompt_length // 4` による推定は粗い。日本語テキスト（1 文字 ≈ 1〜2 トークン）では過小評価の可能性がある。実運用で閾値の調整が必要になる場合がある
2. **階層的要約の品質**: Map-Reduce による要約は通常パスと比べて情報の欠落が起こりうる。ただし空白応答よりは確実に有用
3. **dead_letter の手動対応**: 即座に dead_letter 化されたジョブは、コンテンツ側の修正や閾値調整後に手動で再キューイングが必要

## APPENDIX

### 期待される効果

- `QueueFullError` の激減（毒入り記事によるセマフォ独占の解消）
- 空白応答エラーの即時 dead_letter 化（リトライループの排除）
- 正常記事の要約レイテンシ改善（キュー待機時間の短縮）

### モニタリング項目

```
# P1 効果: hierarchical フォールバックの発火
grep "Token budget exceeded" news-creator logs

# P0 効果: 422 レスポンス
grep "422" news-creator logs
grep "non-retryable summarization error" pre-processor logs
```
