# ADR-000297: フロントエンド progress イベントのフォールスルー修正 — "searchinggenerating" 混入の解消

## ADR's STATUS

Accepted（ADR-000295の後続修正）

## CONTEXT

ADR-289〜295でRAGストリーミングパイプライン全体（nginx → BFF → rag-orchestrator）の修正が完了し、ストリーミング自体は正常に稼働するようになった。しかし、ユーザーの回答テキストの先頭に `searchinggenerating` という文字列が必ず付与される問題が発生していた。

### 調査結果

rag-orchestratorは回答生成前に `progress` イベント（`"searching"`, `"generating"` のステータス文字列）をストリームに送信している。これらはUIの進捗表示用であり、回答テキストの一部ではない。

バックエンド（rag-orchestrator → alt-backend → BFF）はこれらのイベントを正しく `event.kind = "progress"` として送信しており、問題はなかった。

### 根本原因: `augur.ts` の条件式の short-circuit

`alt-frontend-sv/src/lib/connect/augur.ts` のストリームイベント処理において、progress イベントのフィルタ条件に問題があった。

```typescript
if (event.kind === "progress" && onProgress && payload.case === "delta" && payload.value) {
    onProgress(payload.value);
    continue;  // ← onProgress が falsy だと到達しない
}
```

progress イベントは delta payload をキャリアとして再利用する設計のため、`payload.case === "delta"` は true になる。しかし `onProgress` コールバックが未提供（`undefined`）の場合、`&&` 演算子の short-circuit 評価により `continue` に到達せず、イベントがそのまま下流の `switch (payload.case)` にフォールスルーしていた。

```
switch (payload.case) {
    case "delta":
        accumulatedText += payload.value;  // ← "searching", "generating" が連結される
```

Desktop（`AugurChat.svelte`）と Mobile（`ChatWindow.svelte`）の両方で `onProgress` を渡しておらず、全ユーザーが影響を受けていた。

## DECISION MAKING

`onProgress` の有無に関わらず、progress イベントを常にスキップするようフィルタ条件を分離する。

```typescript
// Before
if (event.kind === "progress" && onProgress && payload.case === "delta" && payload.value) {
    onProgress(payload.value);
    continue;
}

// After
if (event.kind === "progress") {
    if (onProgress && payload.case === "delta" && payload.value) {
        onProgress(payload.value);
    }
    continue;  // 常に実行 — delta 処理へのフォールスルーを防止
}
```

### 他の選択肢を採用しなかった理由

- **コンポーネント側に `onProgress` を渡す修正**: 各コンポーネントへの変更が必要で、今後新たなコンポーネントが `onProgress` を渡し忘れると同じバグが再発する。防御的に augur.ts 側で根本解決すべき。
- **バックエンド側で progress イベントの payload 形式を変更**: 動作中の他レイヤーに不要な変更が波及する。

## RESULTS, EFFECTS

### PROS

- **1ファイル・3行の変更**: `augur.ts` のみの最小限の修正で根本原因を解消
- **防御的設計**: `onProgress` の提供有無に依存せず、progress イベントが回答テキストに混入しない構造
- **既存動作の維持**: `onProgress` コールバックが提供されている場合の呼び出しは従来通り動作

### CONS, TRADEOFF

- なし（純粋なバグ修正であり、トレードオフは発生しない）

## APPENDIX

### 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/src/lib/connect/augur.ts` | progress イベントフィルタの条件分離、`continue` の無条件実行化 |

### 関連ADR

- ADR-000289: nginx `proxy_buffering off` + progress イベント導入
- ADR-000292: Augur ストリーミング30秒タイムアウト修正
- ADR-000293: ハートビートをLLMストリーミングフェーズに拡張
- ADR-000295: BFF ストリーミングバイパス修正
