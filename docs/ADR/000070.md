# Nginx 監視基盤の構築と HTTP ログ正規化

## ステータス

採択（Accepted）

## コンテキスト

Grafana で Nginx のステータスやログを認識させる必要があった。調査の結果、以下の問題が発見された：

### 1. スキーマ不一致（致命的）

rask-log-forwarder は HTTP フィールド（method, path, status_code 等）を送信していたが、rask-log-aggregator の `EnrichedLogEntry` にこれらのフィールドが存在せず、データが無視されていた。

### 2. ClickHouse スキーマの設計問題

HTTP 専用カラムがなく、汎用的な `logs` テーブルのみ。詳細なクエリが困難。

### 3. パーサーのハードコード

rask-log-forwarder の `UniversalParser` は、パーサーとサービス名マッピングが `match` 文でハードコードされており、拡張性がなかった。

### 4. Prometheus メトリクスの欠如

nginx-exporter が未導入で、リアルタイムの接続数やリクエストレートが取得できなかった。

## 決定

### 1. ServiceParserRegistry によるプラグインアーキテクチャ

パーサーを動的に登録・マッピングできるレジストリを導入：

```rust
pub struct ServiceParserRegistry {
    parsers: HashMap<String, Arc<dyn ServiceParser>>,
    service_mappings: HashMap<String, String>,
    detection_order: Vec<String>,
}

pub trait ServiceParser: Send + Sync {
    fn service_type(&self) -> &str;
    fn parse_log(&self, log: &str) -> Result<ParsedLogEntry, ParseError>;
    fn detection_priority(&self) -> u8 { 50 }
    fn can_parse(&self, log: &str) -> bool;
}
```

環境変数 `SERVICE_PARSER_MAPPINGS` からマッピングをロード可能。

### 2. ClickHouse Materialized View パターン

ClickHouse のベストプラクティスに従い、正規化されたスキーマを採用：

```
[rask-log-aggregator]
        ↓ INSERT
   [logs テーブル] (fields Map に HTTP データを格納)
        ↓ (Materialized View トリガー)
   [http_logs テーブル] ← HTTP リクエストのみ自動抽出
```

**http_logs テーブル設計**:
- `log_id UUID` - 主キー
- `method LowCardinality(String)` - HTTP メソッド
- `path String` - リクエストパス
- `status_code UInt16` - ステータスコード
- `response_size UInt64` - レスポンスサイズ
- `ip_address String` - クライアント IP
- `user_agent String` - User-Agent

ORDER BY は `(service_name, status_code, timestamp)` でカーディナリティ昇順。

### 3. nginx-exporter + Prometheus の導入

nginx stub_status エンドポイントを公開し、Prometheus でスクレイプ：

```yaml
nginx-exporter:
  image: nginx/nginx-prometheus-exporter:1.4
  command:
    - --nginx.scrape-uri=http://nginx:8080/nginx_status

prometheus:
  image: prom/prometheus:v3.1.0
  volumes:
    - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
```

### 4. エラーハンドリングの改善

rask-log-aggregator の aggregate ハンドラーがエクスポート失敗時も 200 OK を返していた問題を修正：

```rust
match exporter.export_batch(logs).await {
    Ok(()) => (StatusCode::OK, "OK"),
    Err(e) => {
        error!("Failed to export logs to ClickHouse: {e}");
        (StatusCode::INTERNAL_SERVER_ERROR, "Export failed")
    }
}
```

## 結果

### 変更されたファイル

| カテゴリ | ファイル | 変更内容 |
|---------|---------|---------|
| **rask-log-forwarder** | | |
| | `src/parser/registry.rs` | 新規: ServiceParserRegistry |
| | `src/parser/services.rs` | `can_parse()`, `detection_priority()` 追加 |
| | `src/parser/universal.rs` | registry ベースにリファクタリング |
| | `src/parser/mod.rs` | registry エクスポート |
| **rask-log-aggregator** | | |
| | `src/domain/mod.rs` | HTTP フィールド追加 |
| | `src/log_exporter/clickhouse_exporter.rs` | fields Map への HTTP フィールド格納 |
| | `src/main.rs` | エラーハンドリング改善 |
| | `tests/clickhouse_exporter_test.rs` | HTTP フィールドテスト追加 |
| **ClickHouse** | | |
| | `migrations/002_create_http_logs_table.sql` | 新規: http_logs テーブル |
| | `migrations/003_create_http_logs_mv.sql` | 新規: Materialized View |
| **Nginx** | | |
| | `nginx/conf.d/status.conf` | 新規: stub_status エンドポイント |
| **Observability** | | |
| | `compose/core.yaml` | nginx に 8080 ポート追加 |
| | `compose/observability.yaml` | nginx-exporter, prometheus 追加 |
| | `observability/prometheus/prometheus.yml` | 新規: scrape 設定 |
| | `observability/grafana/provisioning/datasources/prometheus.yaml` | 新規 |
| | `observability/grafana/dashboards/nginx-logs.json` | 新規: ログダッシュボード |
| | `observability/grafana/dashboards/nginx-metrics.json` | 新規: メトリクスダッシュボード |

### メリット

1. **拡張性向上**: 新しいパーサーを `register_parser()` で動的に追加可能
2. **HTTP ログの可視化**: ステータスコード分布、トップパス、エラー一覧をダッシュボードで確認
3. **リアルタイムメトリクス**: Prometheus 経由で接続数、リクエストレートを監視
4. **スキーマ正規化**: `logs` テーブルを汚さず、HTTP 専用テーブルで効率的なクエリ

### トレードオフ

1. **ストレージ増加**: Materialized View により http_logs にもデータが保存される（TTL 2 日で軽減）
2. **設定複雑化**: 複数コンポーネント（nginx-exporter, Prometheus）の追加

## 検証

### テスト実行

```bash
# rask-log-forwarder
cd rask-log-forwarder/app && cargo test
# 結果: 95 tests passed

# rask-log-aggregator
cd rask-log-aggregator/app && cargo test
# 結果: 12 tests passed
```

### Docker Compose 検証

```bash
docker compose -f compose/observability.yaml config --quiet
# 結果: Config validation passed
```

## 実装日

2026-01-10

## 関連

- [ClickHouse Schema Design for Observability](https://clickhouse.com/docs/use-cases/observability/schema-design)
- [Materialized Views in ClickHouse](https://clickhouse.com/docs/en/guides/developer/cascading-materialized-views)
- [nginx-prometheus-exporter](https://github.com/nginxinc/nginx-prometheus-exporter)
