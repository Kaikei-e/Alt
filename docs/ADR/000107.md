# 大規模ジャンルのサブジャンル分割閾値調整

## ADR'S STATUS

Accepted

## CONTEXT

### 背景

7日間リキャップパイプラインでは、記事数が多いジャンル（例: software_dev）を複数のサブジャンルに分割する機能が実装されている。これにより、大規模なジャンルでもクラスタリングと要約の品質を維持できる。

### 問題

1. **閾値が高すぎる**: デフォルト閾値（200記事）では実際のデータで分割が発生しない
2. **UIに表示されない**: サブジャンル分割が発動しないため、フロントエンドに分割結果が表示されない
3. **統計的妥当性**: 分割後の各サブジャンルに十分な記事数を確保する必要がある

### データ分析

最新ジョブの記事数分布:
| ジャンル | 記事数 |
|---------|--------|
| software_dev | 176 |
| music_audio | 40 |
| culture_arts | 38 |
| その他 | 3-20 |

## DECISION MAKING

### 決定

サブジャンル分割の閾値を統計的に有意な値（35記事）に設定する。

#### 設定値

| 環境変数 | 値 | 説明 |
|----------|------|------|
| `RECAP_SUBGENRE_MAX_DOCS_PER_GENRE` | 35 | 分割トリガー閾値 |
| `RECAP_SUBGENRE_TARGET_DOCS_PER_SUBGENRE` | 12 | サブジャンルあたり目標記事数 |
| `RECAP_SUBGENRE_MAX_K` | 10 | 最大サブジャンル数 |

#### 設計根拠

1. **閾値 35**: 30-40の範囲で統計的に有意なサンプルサイズ
2. **目標 12**: 35 ÷ 12 ≈ 3 サブジャンル（適度な分割粒度）
3. **最大 10**: 過度な分割を防止

### 分割アルゴリズム

```
1. ジャンルの記事数 > MAX_DOCS_PER_GENRE の場合に分割を実行
2. 分割数 k = ceil(記事数 / TARGET_DOCS_PER_SUBGENRE)
3. k = min(k, MAX_K) で上限を適用
4. K-means クラスタリングで k 個のサブジャンルに分割
5. 命名規則: {genre}_{001}, {genre}_{002}, ...
```

### 前提条件

- **エンベディングサービス必須**: K-meansクラスタリングに埋め込みベクトルが必要
- `SummarySelectStage.embedding_service` が利用可能であること

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 種別 | 内容 |
|----------|------|------|
| `.env` | 設定追加 | サブジャンル閾値の環境変数 |

### 期待される動作

閾値35の場合:
| ジャンル | 記事数 | 分割数 | 結果 |
|---------|--------|--------|------|
| software_dev | 176 | 15 (→10) | software_dev_001 〜 software_dev_010 |
| music_audio | 40 | 4 | music_audio_001 〜 music_audio_004 |
| culture_arts | 38 | 4 | culture_arts_001 〜 culture_arts_004 |
| その他 (<35) | - | - | 分割なし |

### PROS

1. **品質向上**: 大規模ジャンルの要約品質が向上
2. **UIの充実**: サブジャンルごとに詳細な要約を表示可能
3. **設定可能**: 環境変数で閾値調整が容易

### CONS, TRADEOFF

1. **処理時間増加**: サブジャンル数に応じてクラスタリング・要約の処理時間が増加
2. **エンベディング依存**: エンベディングサービスが停止していると分割不可
3. **LLMコスト増**: サブジャンルごとに要約生成が必要

## APPENDIX

### 関連コード

| ファイル | 関数 | 行番号 |
|----------|------|--------|
| `recap-worker/recap-worker/src/pipeline/select.rs` | `subcluster_large_genres()` | 182-277 |
| `recap-worker/recap-worker/src/config.rs` | `load_subworker_config()` | 835-848 |

### 参考

- [K-means クラスタリング](https://en.wikipedia.org/wiki/K-means_clustering)
- 統計的サンプルサイズ: n ≥ 30 が一般的な目安
