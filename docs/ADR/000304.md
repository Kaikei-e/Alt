# ADR-000304: TTS 日本語テキストの読み飛ばし問題を `split_pattern` で修正

## ADR's STATUS

Accepted

## CONTEXT

Kokoro-82M による日本語 TTS で、長い文章を読み上げる際に文の途中で発話が途切れ、後続の文に飛ぶ問題が発生していた。

### 根本原因

Kokoro の `KPipeline` はデフォルトの `split_pattern` が `r'\n+'`（改行のみ）であり、日本語の句読点（`。！？`）では分割しない。そのため改行を含まない段落がそのまま1セグメントとして処理される。

内部的には400文字ごとにチャンク分割されるが、そのチャンク境界検出パターンが `r'([.!?]+)'`（ASCII 句読点のみ）で日本語句読点を認識しない。結果として400文字チャンクから800-1200音素が生成され、Kokoro の上限である510音素で切り捨てられてテキストが欠落する。

### ベストプラクティス

Kokoro-FastAPI の知見によれば、音声品質の最適範囲は100-200音素（"goldilocks range"）。文境界で分割し、各チャンクを250音素以下に保つことが推奨される。日本語の1文は通常40-80文字（80-240音素）であるため、`。！？` で分割すれば自然にこの範囲に収まる。

## DECISION MAKING

### 方針: `split_pattern` に日本語句読点を追加

`KPipeline.__call__()` の `split_pattern` 引数に日本語文境界のパターンを渡す。

### 設計判断

| 項目 | 決定 | 理由 |
|------|------|------|
| 分割パターン | `r"(?<=[。！？\n])"` | 後読み（lookbehind）で句読点をセグメントに残し、韻律（prosody）に影響する情報を保持 |
| 対象句読点 | `。！？\n` | 日本語の文末記号。`、` は文内の読点なので対象外 |
| 適用範囲 | `_synthesize_sync` + `synthesize_stream` の両方 | 一括合成・ストリーミング合成の両パスで一貫した動作を保証 |
| 定数化 | `JAPANESE_SPLIT_PATTERN` | 再利用性と意図の明示化 |

### 他の選択肢を採用しなかった理由

- **Kokoro のソースコードを直接修正**: アップストリームのパッケージに依存しており、バージョンアップ時に修正が失われる
- **テキストの前処理で改行を挿入**: 句読点ごとに `\n` を挿入してデフォルトの `split_pattern` に合わせる方法。テキストの改変が必要になり、改行が音素化に影響する可能性がある
- **`max_phoneme_length` の引き上げ**: 切り捨て上限を上げても、長いセグメントの音声品質が低下する問題は解決しない

## RESULTS, EFFECTS

### PROS

- 日本語テキストが文境界で自然に分割され、全文が欠落なく読み上げられる
- 各セグメントが80-240音素となり、Kokoro の品質最適範囲（100-200音素）に収まる
- 変更は `pipeline.py` の1ファイル・3行のみで、影響範囲が最小
- `KPipeline` の公開 API（`split_pattern` 引数）を利用しており、アップストリームとの互換性を維持

### CONS, TRADEOFF

- `。！？` のみを文境界として扱うため、`…` や `―` で終わる文は分割されない（実用上は稀）
- ASCII の `.!?` では分割されない。現状は日本語専用サービスのため問題ないが、多言語対応時にはパターン拡張が必要

## APPENDIX

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `tts-speaker/tts_speaker/core/pipeline.py` | `JAPANESE_SPLIT_PATTERN` 定数追加、`_synthesize_sync` と `synthesize_stream` で `split_pattern` 引数を渡す |
| 2 | `tts-speaker/tests/unit/test_pipeline_split.py` | 新規テスト: regex の分割動作7件 + KPipeline への引数伝搬2件 |

### 検証結果

- ユニットテスト: 全9件パス（`pytest tests/unit/test_pipeline_split.py`）
- 既存テスト: 全件パス（`pytest tests/unit/`）
- コンテナ再ビルド・起動: 正常（AIX マシン）
- ヘルスチェック: `{"status":"ok","model":"kokoro-82m","lang":"ja","device":"cpu"}`
