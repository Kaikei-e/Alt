# ADR-000272: OGP 画像プロキシ — バックエンド取得・圧縮・キャッシュ

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000267〜271 で OGP 画像表示を実装したが、フロントエンドが外部サーバーから直接 `<img src={ogImageUrl}>` で画像を取得する方式であった。この方式には以下の問題がある:

1. **セキュリティ**: ユーザーのブラウザが任意の外部サーバーに直接接続し、トラッキング・プライバシーリスクが発生する
2. **パフォーマンス**: 外部サーバーの応答速度に依存し、OGP 画像 (通常 1200x630) がそのまま配信されるためサイズ未最適化
3. **信頼性**: 外部画像が削除・変更されると表示不能になる

### 目的

バックエンドで画像を取得→リサイズ・JPEG 圧縮→PostgreSQL キャッシュし、HMAC 署名付きプロキシ URL で配信する。Connect-RPC でバッチプリフェッチを制御する。

### アーキテクチャ概要

```
REST (ブラウザ <img> 互換)          Connect-RPC (オーケストレーション)
GET /v1/images/proxy/:sig/:url     BatchPrefetchImages(article_ids[])
        ↓                                    ↓
   ImageProxyUsecase ←←←←←←←←←←←←←←←←←←←←←←┘
        ↓
   ┌─ CachePort (PostgreSQL image_proxy_cache)
   │   → ヒット: 圧縮済みデータ返却
   │   → ミス:
   │       ├─ DynamicDomainPort → 購読ドメイン + CDN 許可リスト確認
   │       ├─ ImageFetchPort (既存 SSRF 保護) → 画像取得
   │       ├─ ImageProcessingPort → リサイズ(600px) + JPEG 圧縮(q80)
   │       └─ CachePort → 保存 (TTL 12h)
   └─ レスポンス: Cache-Control: public, max-age=43200
```

## 意思決定

### REST + Connect-RPC ハイブリッド

- **REST**: `<img>` タグ互換。ブラウザ HTTP キャッシュ・CDN 対応。HMAC 署名が認可トークンとして機能するため認証不要
- **Connect-RPC**: バッチプリフェッチの構造化リクエスト。既存 `ArticleService` の RPC 拡張として統合

### JPEG 圧縮 (WebP 不採用)

当初 `chai2010/webp` による WebP エンコードを計画したが、同ライブラリは CGo (C libwebp) に依存する。alt-backend の Dockerfile は `CGO_ENABLED=0` でビルドし distroless イメージを使用しているため、CGo 依存の導入はビルドパイプライン全体に影響する。

pure Go の `image/jpeg` + `golang.org/x/image/draw` (CatmullRom リサイズ) を採用した。JPEG q80 でも OGP サムネイル用途では十分な品質で、バイナリサイズ・ビルド複雑性の増加を回避できる。

### HMAC URL 署名

オープンプロキシ化を防止するため、プロキシ URL に HMAC-SHA256 署名を付与する。

URL 構造: `GET /v1/images/proxy/{hex32-hmac}/{base64url-encoded-url}`

署名生成はバックエンド側で行い、`FetchArticleContent` RPC レスポンスの `og_image_proxy_url` フィールドとしてフロントエンドに返却する。フロントエンドは署名を知る必要がない。

### 動的ドメインホワイトリスト

プロキシ対象ドメインを以下の 3 層で制御する:

1. **静的 CDN ドメイン**: `img.youtube.com`, `i.imgur.com`, `pbs.twimg.com` 等の主要 CDN
2. **CDN サフィックス**: `cloudfront.net`, `cloudinary.com`, `imgix.net` 等のサフィックスマッチ
3. **購読フィードドメイン**: `ListFeedLinkDomains()` による動的リスト (5 分インメモリキャッシュ)

### PostgreSQL BYTEA キャッシュ

`image_proxy_cache` テーブルに圧縮済み画像バイナリを保存する。TTL 12 時間で自動期限切れ。サイズ上限 1MB の CHECK 制約付き。ETag ベースの条件付きリクエスト (304 Not Modified) に対応。

### 不採用案

| 不採用案 | 理由 |
|---------|------|
| WebP エンコード (`chai2010/webp`) | CGo 依存が `CGO_ENABLED=0` ビルドと非互換 |
| Redis / ファイルシステムキャッシュ | 既存インフラは PostgreSQL のみ。新しいインフラ依存の追加は運用負荷増 |
| CDN プロキシ (Cloudflare Images 等) | 外部サービス依存。セルフホスト要件に合わない |
| フロントエンドでの画像リサイズ | ブラウザ負荷増大。元画像の転送量削減にならない |

## 結果・影響

### セキュリティ層

| 層 | 保護 | 実装 |
|---|---|---|
| HMAC 署名 | オープンプロキシ防止 | 新規 |
| 動的ドメインホワイトリスト | 購読フィード + CDN のみ許可 | 新規 |
| SSRF 4 層バリデーション | プライベート IP / メタデータ / DNS rebinding / リダイレクト | 既存再利用 |
| Content-Type 検証 | `image/*` のみ | 既存再利用 |
| サイズ制限 | 取得 5MB、圧縮後 1MB 上限 | 既存 + 新規 |
| レート制限 | 外部ドメイン 5 秒間隔 | 既存再利用 |

### 変更ファイル一覧

#### バックエンド (新規作成)

| ファイル | 内容 |
|---------|------|
| `migrations-atlas/.../create_image_proxy_cache.sql` | `image_proxy_cache` テーブル + インデックス |
| `app/domain/image_proxy.go` | ドメインモデル (`ImageProxyResult`, `ImageProxyCacheEntry`, 定数) |
| `app/port/image_proxy_port/image_proxy_port.go` | ポートインターフェース (`CachePort`, `ProcessingPort`, `SignerPort`) |
| `app/port/image_proxy_port/dynamic_domain_port.go` | `DynamicDomainPort` インターフェース |
| `app/driver/alt_db/image_proxy_cache_driver.go` | PostgreSQL ドライバ (UPSERT, 期限切れクリーンアップ) |
| `app/gateway/image_proxy_gateway/cache_gateway.go` | キャッシュゲートウェイ |
| `app/gateway/image_proxy_gateway/processing_gateway.go` | 画像処理ゲートウェイ (pure Go: `golang.org/x/image/draw` + `image/jpeg`) |
| `app/gateway/image_proxy_gateway/dynamic_domain_gateway.go` | 動的ドメインホワイトリストゲートウェイ |
| `app/utils/image_proxy/signer.go` | HMAC-SHA256 URL 署名ユーティリティ |
| `app/usecase/image_proxy_usecase/image_proxy_usecase.go` | ユースケース (`ProxyImage`, `GenerateProxyURL`, `BatchGenerateProxyURLs`, `WarmCache`) |
| `app/rest/image_proxy_handlers.go` | REST ハンドラ (`GET /v1/images/proxy/:sig/:url`) |

#### バックエンド (修正)

| ファイル | 変更内容 |
|---------|---------|
| `app/config/config.go` | `ImageProxyConfig` 構造体追加 |
| `app/di/container.go` | `ImageProxyUsecase` の DI ワイヤリング |
| `app/rest/routes.go` | 画像プロキシルート登録 + DoS 保護ホワイトリスト |
| `app/connect/v2/articles/handler.go` | `FetchArticleContent` に `og_image_proxy_url` 追加、`BatchPrefetchImages` RPC 実装 |
| `app/driver/alt_db/article_head_driver.go` | `FetchOgImageURLsByArticleIDs` バッチクエリ追加 |

#### Proto

| ファイル | 変更内容 |
|---------|---------|
| `proto/alt/articles/v2/articles.proto` | `FetchArticleContentResponse.og_image_proxy_url` フィールド追加、`BatchPrefetchImages` RPC + メッセージ定義 |

#### フロントエンド (修正)

| ファイル | 変更内容 |
|---------|---------|
| `src/lib/connect/articles.ts` | `ogImageProxyUrl` フィールド追加、`batchPrefetchImages()` 関数追加 |
| `src/lib/api/client/articles.ts` | `og_image_proxy_url` フィールド追加、`batchPrefetchImagesClient()` 関数追加 |
| `src/lib/api/client/index.ts` | `batchPrefetchImagesClient` 再エクスポート |
| `src/lib/utils/articlePrefetcher.ts` | プロキシ URL 優先使用、`seedCache` の `ogImageProxyUrl` パラメータ追加 |
| `src/lib/components/mobile/feeds/swipe/SwipeFeedScreen.svelte` | バッチプリフェッチ統合、Visual Preview モード先読み数 10 に増加 |
| `src/lib/components/desktop/feeds/FeedDetailModal.svelte` | 型整合性修正 |

### テスト結果

| テストスイート | 結果 |
|--------------|------|
| HMAC 署名 (`utils/image_proxy`) | 6/6 PASS |
| 画像処理ゲートウェイ (`gateway/image_proxy_gateway`) | 7/7 PASS |
| ユースケース (`usecase/image_proxy_usecase`) | 7/7 PASS |
| バックエンド全体 (`go build ./...`) | 成功 |
| フロントエンド型チェック (`svelte-check`) | 0 エラー, 0 警告 |

### PROS

- **プライバシー保護**: ユーザーのブラウザが外部画像サーバーに直接接続しなくなる
- **パフォーマンス向上**: 1200x630 の OGP 画像を 600px 幅 JPEG に圧縮し転送量を大幅削減
- **キャッシュ効率**: PostgreSQL キャッシュ (TTL 12h) + ブラウザ HTTP キャッシュ (Cache-Control + ETag) の 2 層キャッシュ
- **バッチプリフェッチ**: `BatchPrefetchImages` RPC で複数記事の画像を一括ウォーム。Visual Preview モードのスムーズな表示を実現
- **既存 SSRF 保護の再利用**: 画像取得に既存の 4 層 SSRF バリデーションをそのまま活用
- **CGo 不要**: pure Go ライブラリのみ使用し、既存の `CGO_ENABLED=0` ビルドパイプラインと完全互換
- **最小限のフロントエンド変更**: `ArticlePrefetcher` がプロキシ URL をキャッシュに保存するだけで、`VisualPreviewCard` 等の UI コンポーネントは変更不要

### CONS, TRADEOFF

- **PostgreSQL ストレージ負荷**: 画像バイナリを BYTEA で保存するため、DB サイズが増加する。定期的な `CleanupExpiredImageProxyCache` ジョブが必要
- **JPEG 品質**: WebP と比較して同品質での圧縮率が劣る。ただし OGP サムネイル (600px 幅) 用途では実用上の差は小さい
- **初回リクエスト遅延**: キャッシュミス時は外部画像取得 + 圧縮が発生するため、初回表示は直接取得より遅い可能性がある。`WarmCache` による非同期ウォームで緩和

## 付録

### 依存ライブラリ (Go)

| ライブラリ | 用途 | CGo |
|-----------|------|-----|
| `golang.org/x/image/draw` | CatmullRom リサイズ (準標準ライブラリ) | 不要 |
| `image/jpeg` (標準ライブラリ) | JPEG エンコード | 不要 |

### 再利用した既存コンポーネント

| コンポーネント | 用途 |
|---|---|
| `ImageFetchGateway` (SSRF 保護付き) | 外部画像取得 |
| `HostRateLimiter` | 外部ドメインへのレート制限 |
| `ListFeedLinkDomains` ドライバ | 購読ドメイン一覧取得 |
| `ArticlePrefetcher` | フロントエンドプロキシ URL キャッシュ管理 |

### ADR-000267〜271 からの関連

| 項目 | ADR-000268/269 | ADR-000270 | ADR-000272 (本 ADR) |
|------|---------------|-----------|---------------------|
| 画像取得 | フロントエンドが直接外部取得 | 同左 | バックエンドプロキシ経由 |
| 画像サイズ | 元サイズのまま | 同左 | 600px 幅 JPEG 圧縮 |
| キャッシュ | フロントエンドのみ (ogImageCache) | 同左 (MAX_CACHE_SIZE 10) | + PostgreSQL サーバーキャッシュ (12h) + ブラウザ HTTP キャッシュ |
| セキュリティ | 外部直接接続 | 同左 | HMAC 署名 + ドメインホワイトリスト + SSRF 保護 |
