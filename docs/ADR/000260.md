# ADR-000260: フィード除外フィルタ — excludeClause ヘルパー関数への DRY リファクタリング

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000256 でフィードソース除外フィルタを導入した。バックエンドの `fetch_feed_driver.go` では、除外対象の `feed_link_id` を受け取り `NOT EXISTS` + `split_part` によるドメインフォールバックで除外する SQL 句を構築している。

この実装に対し、セキュリティと PostgreSQL パフォーマンスのベストプラクティスに則っているかレビューを実施した。

### レビュー結果

#### セキュリティ: 問題なし

| 観点 | 評価 | 根拠 |
|------|------|------|
| SQL インジェクション | 安全 | ユーザー入力（UUID）は pgx のパラメータバインド（`$N`）経由。`fmt.Sprintf` は `%d`（整数）のみでプレースホルダ番号を生成しており、ユーザー値は含まない |
| `split_part` 操作対象 | 安全 | DB 内のデータ（`f.link`, `fl.url`）のみに適用。ユーザー入力を直接 SQL 文字列関数に渡していない |
| `fmt.Sprintf("$%d", ...)` パターン | 安全 | `%d` で計算済み整数を埋め込むのみ。実際のリスクはゼロ |

#### PostgreSQL パフォーマンス: 良好

| 観点 | 評価 | 根拠 |
|------|------|------|
| `NOT EXISTS` パターン | 最適 | PostgreSQL は anti-semi-join に変換。`NOT IN` と違い NULL で誤動作しない |
| PK サブクエリ | O(1) | `fl.id = $N` は PK ルックアップ。最大 1 行返却 |
| `split_part` コスト | 軽微 | `feed_link_id IS NULL` の行にのみ適用。LIMIT 付きページネーションで実行されるため実害なし |
| 相関サブクエリ | 許容範囲 | 内側テーブルが最大 1 行なので nested loop でも O(1) |

#### コード品質: 改善余地あり

同一の excludeClause 構築ロジックが `fetch_feed_driver.go` 内の **4 箇所にコピペ**されていた:

- `FetchUnreadFeedsListCursor` の cursor == nil 分岐
- `FetchUnreadFeedsListCursor` の cursor != nil 分岐
- `FetchAllFeedsListCursor` の cursor == nil 分岐
- `FetchAllFeedsListCursor` の cursor != nil 分岐

これは DRY 原則違反であり、将来の修正漏れリスクがある。

## 意思決定

### 修正方針: プライベートヘルパー関数への抽出

`fetch_feed_driver.go` 内に `buildExcludeClause` ヘルパー関数を追加し、4 箇所の重複を解消する。

```go
// buildExcludeClause builds a NOT EXISTS clause that excludes feeds matching
// the given feed_link_id, with domain-based fallback for feeds without feed_link_id.
func buildExcludeClause(args []any, excludeFeedLinkID *uuid.UUID) (string, []any) {
	if excludeFeedLinkID == nil {
		return "", args
	}
	clause := fmt.Sprintf(`AND NOT EXISTS (
		SELECT 1 FROM feed_links fl
		WHERE fl.id = $%d
		AND (
			f.feed_link_id = fl.id
			OR (
				f.feed_link_id IS NULL
				AND split_part(split_part(f.link, '://', 2), '/', 1)
				  = split_part(split_part(fl.url, '://', 2), '/', 1)
			)
		)
	)`, len(args)+1)
	args = append(args, *excludeFeedLinkID)
	return clause, args
}
```

設計上のポイント:

- **nil ガード内蔵**: `excludeFeedLinkID == nil` の場合は空文字列を返し、呼び出し側の `if` 分岐が不要
- **args を受け取り返す**: プレースホルダ番号 (`$N`) が既存 args の長さに基づいて動的に決定されるため、args スライスを入出力する設計が必須
- **パッケージプライベート**: Driver 層内部の実装詳細であり、外部に公開しない

### 呼び出し側の変更パターン

```go
// Before (4 箇所に重複):
excludeClause := ""
if excludeFeedLinkID != nil {
    excludeClause = fmt.Sprintf(`AND NOT EXISTS (...)`, len(args)+1)
    args = append(args, *excludeFeedLinkID)
}

// After:
var excludeClause string
excludeClause, args = buildExcludeClause(args, excludeFeedLinkID)
```

### 変更しなかったもの

| 対象 | 理由 |
|------|------|
| SQL クエリ本体 | 生成される SQL はバイト単位で同一。挙動変更なし |
| ポート層 / ゲートウェイ層 / ユースケース層 | Driver 層内部のリファクタリングのため上位レイヤーへの影響なし |
| テストコード | 既存テストが同一インターフェースでパスすることで正しさを担保 |

## 結果・影響

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/driver/alt_db/fetch_feed_driver.go` | `buildExcludeClause` ヘルパー関数を追加。4 箇所のインライン構築を呼び出しに置換 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `go vet ./driver/alt_db/... ./usecase/fetch_feed_usecase/... ./gateway/fetch_feed_gateway/...` | パス |
| `go build ./...` | パス |
| `go test ./usecase/fetch_feed_usecase/...` | 全テストパス |
| `go test ./gateway/fetch_feed_gateway/...` | 全テストパス |
| コンテナ再ビルド (`alt-backend`) | ビルド成功、起動正常 |
| ヘルスチェック (`/v1/health`) | `{"database":"connected","status":"healthy"}` |

### PROS

- 4 箇所の重複コードを 1 箇所に集約。将来の除外ロジック変更時に修正漏れリスクを排除
- nil ガード内蔵により、呼び出し側のコードが簡潔化（`if` 分岐の削除）
- 生成 SQL は完全に同一であり、挙動変更のリスクがゼロ

### CONS, TRADEOFF

- ヘルパー関数の `args` 入出力パターンは Go では一般的でない。ただし、pgx のプレースホルダ番号が args の長さに依存する以上、この設計は避けられない
- `split_part` によるドメインマッチングは `www.example.com` と `example.com` を区別する。現状 RSS フィード URL は通常統一されているため実害はないが、エッジケースとして認識しておく

### 影響範囲

- **alt-backend**: `fetch_feed_driver.go` のみ。Clean Architecture の最下層（Driver）の変更であり、上位レイヤーへの影響なし
- **alt-frontend-sv**: 変更なし
- **他サービス**: 変更なし

## 関連 ADR

- ADR-000256: フィードソース除外フィルタ (Feeds ページ)
- ADR-000257: FeedSourceExcludeFilter の listSubscriptions リクエスト未送信バグ修正
- ADR-000258: フィードソース除外フィルタの (app)/feeds ページへの移植
- ADR-000259: ListSubscriptions 500 エラー修正 (subscription_driver.go SQL カラム不整合)
