# Desktop Feed Details Modal でのキャッシュキー不一致によるコンテンツ表示バグ修正

## ステータス

採択（Accepted）

## コンテキスト

### 問題

デスクトップ版フィード一覧ページ（`/desktop/feeds`）の詳細モーダルにおいて、以前読み込まれた記事のコンテンツ（Full Article 部分）が表示され、現在選択中のフィードと一致しないバグが発生していた。

### 再現条件

- 矢印ナビゲーションでフィードを切り替えた時
- Mark as Read 後に自動で次のフィードに移動した時
- 別のフィードカードをクリックした時

いずれの操作でも、Full Article セクションに古い記事の内容が残る現象が発生。

### 技術的背景

フロントエンドではパフォーマンス最適化のため、記事コンテンツのプリフェッチとキャッシュ機構（`ArticlePrefetcher`）を実装している。

フィード URL は2種類存在する：
- `link`: オリジナル URL（UTM パラメータ等を含む）
- `normalizedUrl`: トラッキングパラメータを除去した正規化 URL

## 決定

### 根本原因

キャッシュキーとフィード変更検出で異なる URL を使用していたことが原因。

| コンポーネント | 使用していた URL | 役割 |
|---------------|-----------------|------|
| `FeedDetailModal.svelte` | `normalizedUrl` | フィード変更検出 |
| `articlePrefetcher.ts` | `link` | キャッシュキー |

この不一致により、`normalizedUrl` が同一だが `link` が異なるフィード間でキャッシュの誤ヒットが発生。

例：
```
Feed A: link="https://example.com/article?utm=123", normalizedUrl="https://example.com/article"
Feed B: link="https://example.com/article?utm=456", normalizedUrl="https://example.com/article"
```

フィード変更検出は `normalizedUrl` で判断するため「変更なし」と誤認。

### 修正方針

**すべてのキャッシュキーと API 呼び出しを `normalizedUrl` に統一**

```typescript
// Before
const cachedContent = articlePrefetcher.getCachedContent(feed.link);
const response = await getFeedContentOnTheFlyClient(feed.link);

// After
const cachedContent = articlePrefetcher.getCachedContent(feed.normalizedUrl);
const response = await getFeedContentOnTheFlyClient(feed.normalizedUrl);
```

## 結果

### 修正ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/lib/utils/articlePrefetcher.ts` | `prefetchContent()` のキャッシュキーを `normalizedUrl` に変更 |
| `src/lib/components/desktop/feeds/FeedDetailModal.svelte` | キャッシュアクセス・API 呼び出しを `normalizedUrl` に統一 |
| `src/lib/components/mobile/feeds/swipe/SwipeFeedScreen.svelte` | 初回読み込み時のキャッシュキーを `normalizedUrl` に変更 |
| `src/lib/components/mobile/feeds/swipe/SwipeFeedCard.svelte` | キャッシュアクセス・API 呼び出しを `normalizedUrl` に統一 |

### メリット

1. **一貫性**: キャッシュキーが単一の URL 形式（`normalizedUrl`）に統一
2. **キャッシュ効率**: トラッキングパラメータ違いによる重複キャッシュを防止
3. **バグ解消**: フィード切り替え時のコンテンツ不一致が解消

### トレードオフ

1. **モバイル版への影響**: `SwipeFeedScreen` および `SwipeFeedCard` も同様に修正が必要（実施済み）
2. **バックエンド互換性**: API が `normalizedUrl` を正しく処理できる前提

### 検討した代替案

| 代替案 | 却下理由 |
|--------|----------|
| リセット条件を `link` と `normalizedUrl` 両方チェック | キャッシュキーの不一致は解消されない |
| フィード変更時にキャッシュ全クリア | パフォーマンス低下、プリフェッチの意味がなくなる |

## 実装

### 実装日: 2026-01-09

### 検証

```bash
# 型チェック
pnpm check

# ユニットテスト
pnpm test
```

- 型チェック: エラーなし
- ユニットテスト: 103 テストすべてパス（`articlePrefetcher.spec.ts` 含む）

### 手動検証項目

1. フィードカードクリック → 正しい記事が表示される
2. 矢印ナビゲーション → 記事が正しく切り替わる
3. Mark as Read 後 → 次の記事が正しく表示される
4. DevTools Network タブ → 正しい URL で API 呼び出しが行われる

## 関連

- Svelte 5 の `$effect` によるリアクティビティ
- URL 正規化（`normalizeUrl` ユーティリティ）
- プリフェッチ戦略とキャッシュ管理
