# mq-hub 運用性・スケーラビリティ改善

## ADR's STATUS

Accepted

## CONTEXT

mq-hubはRedis Streamsを使用したイベントブローカーサービスで、Producer側からのイベント発行を集中管理する。既存実装のレビューにより、以下の運用面での課題が特定された：

1. **Graceful Shutdown未実装**: デプロイ時にインフライトリクエストが失われる可能性
2. **メトリクス未実装**: 障害検知・パフォーマンス分析が困難
3. **コネクションプール未設定**: 高負荷時のスケーラビリティ問題
4. **バッチサイズ制限なし**: メモリ枯渇のリスク
5. **警告ログ不足**: 不正なストリームキー使用の検知困難
6. **ハンドラー層テスト不足**: カバレッジ不足

## DECISION MAKING

### Phase 1: 高優先度（運用安定性）

#### 1.1 Graceful Shutdown実装

```go
// main.go - シグナルハンドリング追加
sigCh := make(chan os.Signal, 1)
signal.Notify(sigCh, syscall.SIGTERM, syscall.SIGINT)

select {
case sig := <-sigCh:
    slog.InfoContext(ctx, "received shutdown signal", "signal", sig.String())
case err := <-serverErr:
    // handle startup error
}

shutdownCtx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
defer cancel()
srv.Shutdown(shutdownCtx)
```

- SIGTERM/SIGINT受信時に30秒のグレースフル期間を設ける
- インフライトリクエストの完了を待機

#### 1.2 Redisコネクションプール設定

```go
// driver/redis_driver.go
type RedisDriverOptions struct {
    PoolSize int
}

func NewRedisDriverWithURLAndOptions(url string, opts *RedisDriverOptions) (*RedisDriver, error)
```

- `REDIS_POOL_SIZE`環境変数で設定可能（デフォルト: 10）
- 高負荷時の接続枯渇を防止

### Phase 2: 中優先度（観測可能性・安全性）

#### 2.1 Prometheusメトリクス

```go
// metrics/metrics.go
mqhub_publish_total           // 発行イベント数（stream, status別）
mqhub_publish_duration_seconds // 発行レイテンシ（ヒストグラム）
mqhub_batch_size              // バッチサイズ分布
mqhub_errors_total            // エラー数（operation, error_type別）
mqhub_redis_connection_status // Redis接続状態（1=connected, 0=disconnected）
```

- `/metrics`エンドポイント追加
- Prometheus client_golangライブラリ使用

#### 2.2 Gateway警告ログ

```go
// gateway/stream_gateway.go
if !stream.IsValid() {
    slog.WarnContext(ctx, "publishing to unknown stream key",
        "stream", stream.String(),
    )
}
```

- 未定義のストリームキー使用を検知可能に
- 動作は許可（後方互換性維持）

#### 2.3 バッチサイズ制限

```go
// usecase/publish_usecase.go
var ErrBatchTooLarge = errors.New("batch size exceeds maximum allowed")

type PublishUsecaseOptions struct {
    MaxBatchSize int
}
```

- `MAX_BATCH_SIZE`環境変数で設定可能（デフォルト: 1000）
- 制限超過時は`ErrBatchTooLarge`エラーを返却

### Phase 3: テスト強化

- `connect/v1/mqhub/handler_test.go`追加
- 全RPCメソッドのユニットテスト
- Proto⇔Domain変換のテスト

## RESULTS, EFFECTS

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `main.go` | Graceful shutdown, /metricsエンドポイント, バッチサイズ設定 |
| `config/config.go` | `RedisPoolSize`, `MaxBatchSize`設定追加 |
| `driver/redis_driver.go` | `RedisDriverOptions`, コネクションプール対応 |
| `gateway/stream_gateway.go` | 警告ログ追加 |
| `usecase/publish_usecase.go` | メトリクス記録, バッチサイズ検証, Options対応 |
| `usecase/publish_usecase_test.go` | バッチサイズ制限テスト追加 |
| `metrics/metrics.go` | 新規作成 |
| `connect/v1/mqhub/handler_test.go` | 新規作成 |

### 新規環境変数

| 変数名 | デフォルト | 説明 |
|--------|-----------|------|
| `REDIS_POOL_SIZE` | 10 | Redisコネクションプールサイズ |
| `MAX_BATCH_SIZE` | 1000 | バッチ発行の最大イベント数 |

### 新規エンドポイント

| パス | 用途 |
|------|------|
| `/metrics` | Prometheus形式メトリクス |

### PROS

1. **運用安定性向上**: デプロイ時のメッセージロス防止
2. **観測可能性向上**: メトリクスによる監視・アラート設定が可能
3. **スケーラビリティ向上**: コネクションプール設定で高負荷対応
4. **安全性向上**: バッチサイズ制限でメモリ枯渇防止
5. **デバッグ容易性**: 警告ログで設定ミス検知
6. **テストカバレッジ向上**: ハンドラー層テスト追加

### CONS, TRADEOFF

1. **依存追加**: Prometheusクライアントライブラリ追加
2. **若干のオーバーヘッド**: メトリクス記録による微小なレイテンシ増加
3. **設定項目増加**: 環境変数が2つ増加

## APPENDIX

### 検証コマンド

```bash
# ヘルスチェック
curl http://localhost:9500/health

# メトリクス確認
curl http://localhost:9500/metrics | grep mqhub

# テスト実行
cd mq-hub/app && go test ./...
```

### 参考資料

- [Microservice Architecture Best Practices: Messaging Queues - DZone](https://dzone.com/articles/microservice-architecture-best-practices-messaging)
- [Queue Messaging in Microservices - CloudAMQP](https://www.cloudamqp.com/blog/microservices-and-message-queues-part-1-understanding-message-queues.html)
- [Message Broker Pattern for Microservices - Redis](https://redis.io/solutions/message-broker-pattern-for-microservices-interservice-communication/)
- [Clean Architecture in Go - Three Dots Labs](https://threedots.tech/post/introducing-clean-architecture/)
