# MarkAsRead API 404エラー修正 - URL正規化のゼロトラスト実装

## ADR's STATUS

**承認済み（Accepted）** - 2026年1月3日

## CONTEXT

### 問題

`MarkAsRead` APIが「feed not found」(404)を返す問題が発生。

```
POST https://example.com/sv/api/v2/alt.feeds.v2.FeedService/MarkAsRead 404 (Not Found)
ConnectError: [not_found] feed not found: https://example.com/articles/ux-quiz
```

### 根本原因

URLの不一致によるマッチング失敗：

| 項目 | URL |
|------|-----|
| DB保存 | `https://example.com/articles/hogehoge/?utm_source=rssfeed&utm_campaign=rss-syndication` |
| API送信 | `https://example.com/articles/hogehoge` |

RSSフィードから取得した記事URLにはUTMパラメータが含まれているが、
フロントエンドは正規化済み（UTM除去済み）URLを送信するため、
完全一致検索でマッチしない。

### 既存実装の問題

`user_reading_status_driver.go` では3パターン検索を試みていた：

```go
// 旧実装: 3パターンで検索
getFeedQuery := `SELECT id FROM feeds WHERE link = $1 OR link = $2 OR link = $3 LIMIT 1`
err = r.pool.QueryRow(ctx, getFeedQuery, normalizedURL, originalURL, withSlashURL).Scan(&feedID)
```

しかし、DB側のURLにUTMパラメータが含まれているため、どのパターンもマッチしなかった。

## DECISION

**ゼロトラスト**アプローチを採用し、保存時・参照時・比較時すべてでURLを正規化してから完全一致検索を行う。

### 変更内容

#### 1. 保存時の正規化

`feeds_gateway.go` でフィード登録時にURLを正規化：

```go
// Zero-trust: Normalize URL to remove tracking parameters (UTM, etc.)
normalizedLink, err := utils.NormalizeURL(feedItem.Link)
if err != nil {
    logger.Logger.Warn("Failed to normalize feed link, using original",
        "link", feedItem.Link, "error", err)
    normalizedLink = feedItem.Link
}

feedModel := &models.Feed{
    Link: normalizedLink,  // 正規化済みURLを保存
    // ...
}
```

#### 2. 比較時の正規化（簡素化）

`user_reading_status_driver.go` で検索ロジックを簡素化：

```go
// 旧: 3パターン検索
getFeedQuery := `SELECT id FROM feeds WHERE link = $1 OR link = $2 OR link = $3 LIMIT 1`

// 新: 正規化URL完全一致のみ
getFeedQuery := `SELECT id FROM feeds WHERE link = $1 LIMIT 1`
err = r.pool.QueryRow(ctx, getFeedQuery, normalizedURL).Scan(&feedID)
```

#### 3. 既存データの正規化（ワンショットスクリプト）

`scripts/normalize_feed_urls.go` を作成：

- 既存の全フィードURLを正規化
- 重複URLの検出と統合（古いエントリを保持）
- `read_status` の外部キー整合性を維持

### URL正規化ルール

`utils.NormalizeURL()` で以下を処理：

| 処理 | 例 |
|------|-----|
| UTMパラメータ除去 | `utm_source`, `utm_medium`, `utm_campaign`, `utm_term`, `utm_content`, `utm_id` |
| その他トラッキング除去 | `fbclid`, `gclid`, `mc_eid`, `msclkid` |
| フラグメント除去 | `#section1` |
| 末尾スラッシュ除去 | `/article/` → `/article` |
| パーセントエンコーディング正規化 | `%e3%81%82` → `%E3%81%82` |

## RESULTS

### テスト結果

```
ok  alt/gateway/register_feed_gateway
ok  alt/driver/alt_db
ok  alt/utils
```

すべてのテストがパス。

### 期待される改善

| 指標 | Before | After |
|------|--------|-------|
| MarkAsRead成功率 | 一部失敗 | 100% |
| 検索クエリ複雑度 | 3パターンOR | 単一完全一致 |
| インデックス効率 | 低（OR検索） | 高（完全一致） |

### 後方互換性

- 新規フィードは正規化URLで保存される
- 既存フィードはワンショットスクリプトで正規化が必要
- フロントエンドの変更は不要

## 変更ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `alt-backend/app/gateway/register_feed_gateway/feeds_gateway.go` | `NormalizeURL()` 呼び出し追加 |
| `alt-backend/app/driver/alt_db/user_reading_status_driver.go` | 検索ロジック簡素化 |
| `scripts/normalize_feed_urls.go` | 既存データ正規化スクリプト（新規） |

## 適用手順

1. コードデプロイ
2. ワンショットスクリプト実行：
   ```bash
   DB_PASSWORD=xxx DB_HOST=localhost go run scripts/normalize_feed_urls.go
   ```

## RELATED

- 関連Issue: MarkAsRead 404エラー
- 関連ファイル: `alt-backend/app/utils/url_normalizer.go` - URL正規化関数
