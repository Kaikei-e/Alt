# Mock Server モジュール分割とMSW対応

## ステータス

採択（Accepted）

## コンテキスト

### 問題

ADR-061で導入した `mock-server.ts` は以下の課題があった：

1. **モノリシック構造**: 約800行の単一ファイルで保守性が低い
2. **Deprecation Warning**: Node.js の `url.parse()` が非推奨
3. **型安全性なし**: レスポンスデータがハードコード、型定義なし
4. **テスト統合困難**: MSW（Mock Service Worker）との統合ができていない

### 背景

- E2Eテスト用モックサーバーは `http.createServer` で実装済み
- フロントエンド開発（`dev:mock`）と E2E テストで同じモックを共有
- MSW はテスト業界のベストプラクティスとして広く採用されている

### 要件

1. モジュール分割による保守性向上
2. `url.parse()` の廃止（WHATWG URL API への移行）
3. 型安全なモックデータ定義
4. MSW との統合（将来のテスト改善に向けて）
5. 既存の `dev:mock` スクリプト互換性維持

## 決定

### アーキテクチャ: MSWハンドラ定義 + http.createServerラッパー

```
┌──────────────────────────────────────────────────────┐
│                    handlers/                         │
│   モジュール化されたハンドラ定義（型安全、再利用可能）   │
└──────────────────────────────────────────────────────┘
              │                        │
              ▼                        ▼
┌─────────────────────┐    ┌─────────────────────────┐
│   http.createServer │    │   MSW setupServer       │
│   (dev:mock用)      │    │   (E2Eテスト用)         │
│   ポート4001-4003    │    │   同一プロセス内         │
└─────────────────────┘    └─────────────────────────┘
```

### 1. ディレクトリ構造

```
tests/e2e/infra/
├── mock-server.ts              # エントリーポイント（http.createServerラッパー）
├── msw-server.ts               # MSW setupServer（E2Eテスト用）
├── msw-handlers.ts             # MSWハンドラ定義
├── handlers/
│   ├── index.ts                # 全ハンドラのexport
│   ├── kratos.ts               # Kratos認証ハンドラ
│   ├── authhub.ts              # AuthHubハンドラ
│   └── backend.ts              # Backendハンドラ（REST + Connect-RPC）
├── data/
│   ├── feeds.ts                # フィードモックデータ
│   ├── session.ts              # セッション/認証データ
│   └── recap.ts                # Recapモックデータ
└── types/
    └── index.ts                # 型定義
```

### 2. url.parse() から WHATWG URL API への移行

Before:
```typescript
import url from "url";
const parsedUrl = url.parse(req.url!, true);
const path = parsedUrl.pathname;
const query = parsedUrl.query.flow;
```

After:
```typescript
const url = new URL(req.url!, `http://${req.headers.host}`);
const path = url.pathname;
const query = url.searchParams.get("flow");
```

### 3. 型定義

`types/index.ts` で以下の型を定義：

- `KratosSession`, `KratosFlow` - 認証フロー
- `Feed`, `FeedsResponse` - REST v1 フィード
- `ConnectFeed`, `ConnectFeedsResponse` - Connect-RPC v2 フィード
- `RecapGenre`, `RecapResponse` - Recap

### 4. MSW統合

```typescript
// msw-server.ts - テスト用
import { setupServer } from "msw/node";
import { handlers } from "./msw-handlers";

export const server = setupServer(...handlers);

// 使用例（テストファイル内）
import { server } from './msw-server'
import { beforeAll, afterEach, afterAll } from 'vitest'

beforeAll(() => server.listen({ onUnhandledRequest: 'warn' }))
afterEach(() => server.resetHandlers())
afterAll(() => server.close())
```

### 5. package.json 依存関係追加

```json
{
  "devDependencies": {
    "msw": "^2.12.7"
  }
}
```

## 使用方法

### Option A: 開発環境（従来通り）

```bash
cd alt-frontend-sv
bun run dev:mock
# http://localhost:5173/sv/
```

### Option B: MSWをテストで使用

```typescript
// tests/example.test.ts
import { server } from '../e2e/infra/msw-server'
import { http, HttpResponse } from 'msw'
import { beforeAll, afterEach, afterAll, test, expect } from 'vitest'

beforeAll(() => server.listen())
afterEach(() => server.resetHandlers())
afterAll(() => server.close())

test('カスタムレスポンスをテスト', () => {
  // 特定のテスト用にハンドラを上書き
  server.use(
    http.get('*/v1/feeds/count/unreads', () =>
      HttpResponse.json({ count: 100 })
    )
  )
  // ...テストコード
})
```

## 結果

### メリット

1. **保守性向上**: 12ファイルに分割、各ファイル100-200行
2. **Deprecation解消**: `url.parse()` 警告が消失
3. **型安全**: TypeScript型定義でコンパイル時エラー検出
4. **テスト柔軟性**: MSWで個別テストのモック上書きが可能
5. **再利用性**: モックデータを複数箇所で共有可能

### トレードオフ

1. **ファイル数増加**: 1ファイル → 12ファイル（ただし各ファイルは小さい）
2. **MSW学習コスト**: MSW APIの理解が必要
3. **二重実装**: http.createServer版とMSW版の両方を維持

### 改善指標

| 項目 | Before | After |
|------|--------|-------|
| ファイル数 | 1 | 12 |
| 最大ファイル行数 | 793行 | 約200行 |
| Deprecation Warning | あり | なし |
| 型カバレッジ | 0% | 100% |
| MSW対応 | なし | あり |

## 実装

### 実装日: 2026-01-08

### 修正ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `package.json` | msw 依存関係追加 |
| `tests/e2e/infra/mock-server.ts` | リファクタリング（ハンドラ分離） |
| `tests/e2e/infra/msw-server.ts` | 新規: MSW setupServer |
| `tests/e2e/infra/msw-handlers.ts` | 新規: MSWハンドラ定義 |
| `tests/e2e/infra/handlers/index.ts` | 新規: ハンドラ集約 |
| `tests/e2e/infra/handlers/kratos.ts` | 新規: Kratosハンドラ |
| `tests/e2e/infra/handlers/authhub.ts` | 新規: AuthHubハンドラ |
| `tests/e2e/infra/handlers/backend.ts` | 新規: Backendハンドラ |
| `tests/e2e/infra/data/feeds.ts` | 新規: フィードデータ |
| `tests/e2e/infra/data/session.ts` | 新規: セッションデータ |
| `tests/e2e/infra/data/recap.ts` | 新規: Recapデータ |
| `tests/e2e/infra/types/index.ts` | 新規: 型定義 |

## 関連ADR

- ADR-061: フロントエンド専用開発環境（frontend-dev スタック）

## 参考

- [MSW Best Practices (TypeScript)](https://mswjs.io/docs/best-practices/typescript/)
- [MSW Node.js Integration](https://mswjs.io/docs/integrations/node)
- [MSW in SvelteKit for Local Development](https://flaming.codes/posts/msw-in-sveltekit-for-local-development)
- [Node.js Testing Best Practices](https://github.com/goldbergyoni/nodejs-testing-best-practices)
- [Playwright MCP Server](https://github.com/microsoft/playwright-mcp)
