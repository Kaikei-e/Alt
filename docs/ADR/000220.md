# ADR-000220: Desktop検索UIの追加feed表示レイテンシ改善

## STATUS

Accepted（実装完了・テスト通過・コンテナ再ビルド/再起動確認済み）

## CONTEXT

Desktop版 `/sv/feeds/search` でページ追加読み込み（infinite scroll）が遅かった。コンテナログを分析した結果、バックエンド処理は高速（Meilisearch ~60-120ms + DB lookup ~3ms = 約200ms/ページ）であり、ボトルネックはフロントエンド側の制御フローにあることを特定した。

### 計測結果（改善前）

| offset | バックエンド処理 | ページ間ギャップ |
|--------|---------------|---------------|
| 0 | ~127ms | — |
| 20 | ~71ms | **3.5秒** |
| 40 | ~81ms | **3.3秒** |
| 60 | ~64ms | **3.5秒** |

ページ間ギャップの内訳:

1. **500ms クールダウン**: ADR-000219 で追加された連鎖発火防止用タイマーが保守的すぎた
2. **100ms re-observe delay**: `infiniteScroll` action の finally ブロック内のタイムアウト
3. **Observer再作成コスト**: `isLoadingMore` の toggle により `update()` → `setupObserver()` が発火し、observer の disconnect → new → observe サイクルが発生
4. **rootMargin "200px"**: 20件追加後にグリッドが伸びて sentinel が範囲外に移動するケースあり

## DECISION MAKING

2つの改善を実施した。

### 改善 1: クールダウンを 500ms → 200ms に短縮

`+page.svelte` の `LOAD_COOLDOWN_MS` を 500ms から 200ms に変更した。

200ms で十分な理由:
- IntersectionObserver の `isSettingUp` ガードと `disabled` チェックが既に二重防御として機能しており、連鎖発火はこれらで防止される
- クールダウンはあくまで追加のセーフティネットであり、200ms あれば observer の再セットアップサイクル（~100ms）を十分にカバーできる

### 改善 2: 正規表現の事前コンパイル（バックエンド）

`sanitizeDescription` 関数内で毎回 `regexp.MustCompile` を呼んでいたものを、パッケージレベル変数に移動した。

検索結果が20件返されるたびに20回コンパイルされていたため、パッケージレベル変数への移動で不要な再コンパイルを排除した。レイテンシへの影響は微小だが、Go のベストプラクティスに沿った修正。

## RESULTS

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/src/routes/desktop/feeds/search/+page.svelte` | `LOAD_COOLDOWN_MS` を 500 → 200 に変更 |
| `alt-backend/app/connect/v2/feeds/helpers.go` | `regexp.MustCompile` をパッケージレベル変数 `spaceCollapseRe` に移動 |

### テスト結果

| 実行コマンド | 結果 |
|---|---|
| `cd alt-backend/app && go test ./connect/v2/feeds/...` | ok (0.019s) |

### コンテナ検証

| 検証 | 結果 |
|---|---|
| `docker compose build alt-backend alt-frontend-sv` | 成功 |
| `docker compose up -d alt-backend alt-frontend-sv` | 成功 |
| `curl http://localhost:9000/v1/health` | `{"status":"healthy"}` |
| `curl http://localhost:3000/api/health` | `{"status":"ok"}` |

### 期待効果

- クールダウン短縮により、1サイクルあたり約300ms短縮
- ページ間ギャップが ~3.5秒 → ~1秒以下に改善される見込み

## PROS

1. 変更が最小限（2ファイル、各1箇所）であり、リグレッションリスクが低い
2. 既存の二重防御（`isSettingUp` + `disabled`）を活かしつつ、クールダウンのみ調整する保守的なアプローチ
3. バックエンドの正規表現事前コンパイルは Go の標準的なベストプラクティスに準拠

## CONS, TRADEOFF

1. クールダウン 200ms は経験的な値であり、極端に高レイテンシなネットワーク環境ではさらなる調整が必要になる可能性がある
2. observer 再作成コスト（要因3）や rootMargin の最適化（要因4）は今回のスコープ外とした。これらは追加の改善余地として残る

## APPENDIX

- 関連: ADR-000219（本 ADR の前提となるクールダウン追加と検索クライアント改善）
- フロントエンドの遅延要因分析には `docker compose logs` によるタイムスタンプ比較を使用
