# ADR-000211: Feeds ページ フィルタ/ソートツールバーの機能実装

## STATUS

Accepted（実装完了・コンテナ再ビルド・ヘルスチェック確認済み）

## CONTEXT

### 背景

Desktop `/sv/feeds` ページにはフィルタツールバー（"Unread Only" チェックボックス、"Sort By" ドロップダウン）が存在し、UI コンポーネント (`FeedFilters.svelte`) はイベントを正しく発火していた。しかし `FeedGrid.svelte` が `unreadOnly` と `sortBy` プロパティを完全に無視しており、常に未読フィードのみをサーバーデフォルト順で取得していた。

### 課題

1. **GetAllFeeds RPC の不在**: Connect-RPC に「全フィードを取得する」エンドポイントが存在しなかった。`GetUnreadFeeds` は既読フィードを `read_status` テーブルで除外するため、"Unread Only" を解除しても全フィードを表示する手段がなかった。
2. **フィルタ連動の未実装**: `FeedGrid` は `unreadOnly` の値に関わらず常に `getFeedsWithCursorClient()` (未読のみ) を呼び出していた。
3. **ソート機能の未実装**: ソートドロップダウンの選択値が `FeedGrid` に渡されても、表示順に反映されなかった。

### ソート方針

サーバーサイドソートは `created_at DESC` 固定のカーソルベースページネーションに依存しており、タイトルソートの追加には SQL・カーソル・複数レイヤーへの変更が必要。コスト対効果を考慮し、**クライアントサイドソート**を採用した。読み込み済みデータに対してのみソートが適用されるため、ページネーション境界をまたぐ完全なソートではないが、表示中のデータに対しては正確に動作する。

## DECISION MAKING

### 方針

1. Proto に `GetAllFeeds` RPC を追加し、既読/未読を問わず全フィードを返すエンドポイントを新設
2. Backend handler を既存の `FetchFeedsListCursorUsecase` を活用して実装
3. Frontend で `unreadOnly` の値に応じて適切な API を呼び分け、`sortBy` に応じてクライアントサイドソートを適用

### DB レイヤーの修正

既存の `FetchFeedsListCursor` gateway メソッドが、名前に反して `FetchUnreadFeedsListCursor` (未読のみ) を呼び出していた問題を発見。新規に `FetchAllFeedsListCursor` DB メソッドを追加し、gateway を修正した。

## RESULTS

### 変更ファイル一覧

#### Proto (1 file)

| ファイル | 変更内容 |
|---------|---------|
| `proto/alt/feeds/v2/feeds.proto` | `GetAllFeedsRequest`, `GetAllFeedsResponse` メッセージ追加、`GetAllFeeds` RPC 追加 |

#### Backend (4 files)

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/driver/alt_db/fetch_feed_driver.go` | `FetchAllFeedsListCursor()` 追加。`read_status` フィルタなしで全フィードをカーソルページネーション取得 |
| `alt-backend/app/gateway/fetch_feed_gateway/feeds_gateway.go` | `FetchFeedsListCursor()` が `FetchAllFeedsListCursor` を呼ぶよう修正、`ArticleID` マッピング追加 |
| `alt-backend/app/connect/v2/feeds/handler.go` | `GetAllFeeds` handler 追加。`GetReadFeeds` と同パターン |
| `alt-backend/app/connect/v2/feeds/handler_test.go` | `TestGetAllFeeds_RequiresAuth`, `TestGetAllFeedsResponse_Construction` 追加 |

#### Frontend (3 files)

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/src/lib/connect/feeds.ts` | `getAllFeeds()` Connect-RPC クライアント関数追加 |
| `alt-frontend-sv/src/lib/api/client/feeds.ts` | `getAllFeedsWithCursorClient()` API クライアント関数追加 |
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedGrid.svelte` | フィルタ/ソート連動の実装 (後述) |

#### 自動生成ファイル (buf-generate)

| ファイル | 生成元 |
|---------|--------|
| `alt-backend/app/gen/proto/alt/feeds/v2/feeds.pb.go` | proto |
| `alt-backend/app/gen/proto/alt/feeds/v2/feedsv2connect/feeds.connect.go` | proto |
| `alt-frontend-sv/src/lib/gen/alt/feeds/v2/feeds_pb.ts` | proto |
| `alt-butterfly-facade/internal/gen/proto/alt/feeds/v2/feeds.pb.go` | proto |
| `alt-butterfly-facade/internal/gen/proto/alt/feeds/v2/feedsv2connect/feeds.connect.go` | proto |
| `rag-orchestrator/internal/gen/proto/alt/feeds/v2/feeds.pb.go` | proto |
| `rag-orchestrator/internal/gen/proto/alt/feeds/v2/feedsv2connect/feeds.connect.go` | proto |

### FeedGrid.svelte の変更詳細

| 機能 | 実装 |
|------|------|
| データ取得の分岐 | `unreadOnly === true` → `getFeedsWithCursorClient()`、`false` → `getAllFeedsWithCursorClient()` |
| クライアントサイドソート | `sortFeeds()` ヘルパー関数で `date_desc` / `date_asc` / `title_asc` / `title_desc` に対応。`$derived` で `visibleFeeds` に自動適用 |
| フィルタ変更時のリセット | `$effect` で `unreadOnly` の変更を検知し、`feeds`, `nextCursor`, `hasNextPage`, `removedUrls` をリセットしてサーバーから再取得 |
| ソート変更時の挙動 | サーバー再取得なし。`$derived` の `sortFeeds()` がリアクティブに再計算 |
| `fetchReplacementFeed` | `unreadOnly` の値に応じて正しい API を使用 |

### 再利用した既存コンポーネント（変更なし）

| ファイル | 再利用内容 |
|---------|-----------|
| `alt-backend/app/connect/v2/feeds/helpers.go` | `convertFeedsToProto()`, `deriveNextCursor()` |
| `alt-backend/app/di/container.go` | `FetchFeedsListCursorUsecase` (line 116) |
| `alt-backend/app/usecase/fetch_feed_usecase/feeds_list_cursor_usecase.go` | 全フィードカーソル取得ユースケース |
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedFilters.svelte` | フィルタ UI コンポーネント |
| `alt-frontend-sv/src/routes/(app)/feeds/+page.svelte` | フィルタ値を FeedGrid に渡すページコンポーネント |
| `alt-butterfly-facade/` | 透過プロキシ。新規 unary RPC は catch-all handler で自動ルーティング |

## VERIFICATION

### 自動検証

| 検証 | 結果 |
|------|------|
| `go test ./connect/v2/feeds/... -v` | 32 tests PASS |
| `npx svelte-check --threshold error` | 0 errors, 0 warnings |
| `bun run build` | 成功 (40s) |

### コンテナ検証

| 検証 | 結果 |
|------|------|
| `docker compose build alt-backend alt-frontend-sv alt-butterfly-facade` | 成功 |
| Backend ヘルスチェック (`/v1/health`) | `{"database":"connected","status":"healthy"}` |
| Frontend ヘルスチェック (`/api/health`) | `{"status":"ok"}` |
| `GetAllFeeds` エンドポイント (backend 直接) | CSRF エラー返却 (ルーティング成功) |
| `GetAllFeeds` エンドポイント (facade 経由) | 401 Unauthorized (プロキシ透過確認) |

## PROS

1. **既存パターンの踏襲**: `GetReadFeeds` / `GetFavoriteFeeds` と同一パターンで `GetAllFeeds` を実装。コードの一貫性を維持
2. **最小限の変更**: 既存の `FetchFeedsListCursorUsecase` と DI 配線を再利用し、新規ユースケースの追加なし
3. **非破壊的**: 既存の `GetUnreadFeeds` エンドポイントやモバイルのフィード表示に影響なし
4. **Gateway のバグ修正**: `FetchFeedsListCursor` が未読フィードのみ返していた名前と挙動の不整合を修正

## CONS

1. **クライアントサイドソートの制約**: ページネーション境界をまたぐソートは不完全。例: "Title A-Z" でソートしても、次ページのフィードは前ページのフィードより先にアルファベット順で来る可能性がある
2. **ソート変更時のサーバー再取得なし**: `date_asc` ソートで最古のフィードを見たい場合、まず `date_desc` で複数ページ分を読み込む必要がある。サーバーサイドソートの追加で改善可能
3. **`feeds` テーブルに `user_id` 非依存**: 全フィードは全ユーザーで共有。`GetAllFeeds` はテナント分離なしに全フィードを返す（既存の `FetchFeedsList` と同じ設計）
