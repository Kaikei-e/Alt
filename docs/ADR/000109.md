# Recap Job Status Dashboard 実装

## ADR'S STATUS

Accepted

## CONTEXT

### 背景

Recapパイプラインのジョブ状態を監視するダッシュボードが存在せず、ジョブの進捗状況やエラーの把握が困難だった。運用者は手動でデータベースを確認する必要があり、障害対応が遅れる原因となっていた。

### 要件

1. **リアルタイム監視**: 実行中ジョブのパイプラインステージ進捗を視覚化
2. **ジャンル別進捗**: 各ジャンルのクラスタリング/要約処理状況を表示
3. **統計情報**: 成功率、平均処理時間、失敗数などのKPIを提供
4. **ユーザー単位追跡**: 将来的にユーザー単位でジョブをトリガー・追跡可能にする拡張性

## DECISION MAKING

### 決定

Grafanaライクなカード形式のダッシュボードを新規実装する。

### 1. データベーススキーマ拡張

ユーザー単位のジョブ追跡を可能にするため、以下のカラムを追加。

| テーブル | カラム | 型 | 説明 |
|----------|--------|-----|------|
| `recap_jobs` | `user_id` | UUID | ジョブをトリガーしたユーザー（NULLはシステムジョブ） |
| `recap_jobs` | `trigger_source` | TEXT | `system` または `user` |
| `recap_job_articles` | `feed_id` | UUID | 記事の所属フィード |
| `recap_job_articles` | `original_user_id` | UUID | フィードを購読しているユーザー |

### 2. バックエンドAPI（REST）

Connect-RPCストリーミングも定義したが、初期実装はRESTポーリング方式を採用。

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `/v1/dashboard/job-progress` | GET | 総合的なジョブ進捗情報 |
| `/v1/dashboard/job-stats` | GET | 24時間統計情報 |

### 3. フロントエンドコンポーネント

| コンポーネント | 説明 |
|---------------|------|
| `MetricCard` | 成功率、平均時間などの指標カード |
| `PipelineProgress` | 8段階パイプライン進捗バー |
| `GenreProgressList` | ジャンル別処理状況 |
| `ActiveJobCard` | 実行中ジョブの詳細 |
| `JobHistoryTable` | 過去ジョブ一覧 |
| `StatusBadge` | ステータス表示バッジ |

### 4. パイプラインステージ

8段階のパイプラインステージを定義:

```
Fetch → Preprocess → Dedup → Genre → Select → Evidence → Dispatch → Persist
```

### 設計根拠

1. **RESTポーリング採用**: 初期実装の複雑さを抑制。Connect-RPCストリーミングは将来対応
2. **5秒ポーリング間隔**: リアルタイム性とサーバー負荷のバランス
3. **ユーザーIDカラム追加**: 将来のユーザー単位ジョブトリガー機能への拡張を考慮

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 種別 | 内容 |
|----------|------|------|
| `recap-migration-atlas/migrations/20260116000000_add_user_id_to_recap_jobs.sql` | 新規 | スキーマ変更 |
| `recap-worker/recap-worker/src/store/dao/types.rs` | 変更 | `TriggerSource`, `GenreStatus`, `PipelineStage`追加 |
| `recap-worker/recap-worker/src/store/dao/job_status.rs` | 新規 | ジョブステータス用DAO |
| `recap-worker/recap-worker/src/store/models.rs` | 変更 | ダッシュボード用モデル追加 |
| `recap-worker/recap-worker/src/api/dashboard.rs` | 変更 | 新規エンドポイント追加 |
| `proto/alt/recap/v2/job_status.proto` | 新規 | Connect-RPCサービス定義 |
| `alt-frontend-sv/src/lib/schema/dashboard.ts` | 変更 | TypeScript型定義追加 |
| `alt-frontend-sv/src/lib/api/client/dashboard.ts` | 変更 | APIクライアント関数追加 |
| `alt-frontend-sv/src/lib/hooks/useJobProgress.svelte.ts` | 新規 | ポーリングフック |
| `alt-frontend-sv/src/lib/components/desktop/recap/job-status/` | 新規 | UIコンポーネント群 |
| `alt-frontend-sv/src/routes/desktop/recap/job-status/+page.svelte` | 新規 | ダッシュボードページ |
| `alt-frontend-sv/src/lib/components/desktop/layout/Sidebar.svelte` | 変更 | ナビゲーション追加 |

### PROS

1. **可観測性向上**: ジョブ状態をリアルタイムで把握可能
2. **障害対応迅速化**: 失敗ジョブを即座に特定
3. **運用効率化**: 手動DB確認が不要に
4. **拡張性**: ユーザー単位ジョブ機能への基盤整備

### CONS, TRADEOFF

1. **ポーリング負荷**: 5秒間隔のAPIコールによるサーバー負荷
2. **リアルタイム性の限界**: SSE/WebSocketに比べて遅延が発生
3. **スキーマ変更**: 既存テーブルへのカラム追加が必要

## APPENDIX

### アクセスパス

```
/sv/desktop/recap/job-status
```

### 環境変数

| 変数 | デフォルト | 説明 |
|------|-----------|------|
| `RECAP_WORKER_BASE_URL` | `http://recap-worker:9005` | フロントエンドからのAPIプロキシ先 |

### 関連コード

| ファイル | 関数/クラス |
|----------|-------------|
| `recap-worker/recap-worker/src/api/dashboard.rs` | `get_job_progress()` |
| `recap-worker/recap-worker/src/store/dao/job_status.rs` | `JobStatusDao` |
| `alt-frontend-sv/src/lib/hooks/useJobProgress.svelte.ts` | `useJobProgress()` |
