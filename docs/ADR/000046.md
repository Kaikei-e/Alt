# recap-subworker Docker ビルドの最適化

## ADR's STATUS

**承認済み（Accepted）** - 2026年1月

## CONTEXT

`altctl up --build recap --timeout 30m` の実行に異常な時間がかかっていた。

### 問題の原因

1. **recap-subworker に `.dockerignore` が存在しない**
   - ビルドコンテキストとして 15GB 全体が送信されていた

2. **Dockerfile のレイヤーキャッシュが無効化される構造**
   - ソースコードを依存関係インストール前にコピーしていた
   - ソースコード変更のたびに依存関係も再インストール

### 定量的な影響

| 項目 | サイズ |
|------|--------|
| recap-subworker ディレクトリ全体 | 15GB |
| `.venv/` (仮想環境) | 8.4GB |
| `learning_machine/artifacts/` (学習済みモデル) | 5.4GB |
| `learning_machine/data/` (学習データ) | 134MB |

### 問題のある Dockerfile 構造

```dockerfile
# 依存関係ファイルとソースコードを同時にコピー
COPY pyproject.toml README.md ./
COPY recap_subworker ./recap_subworker  # ← ソースコード変更でキャッシュ無効

# 依存関係をインストール（毎回再実行される）
RUN uv sync --no-dev
```

## DECISION MAKING

### 1. `.dockerignore` の新規作成

不要なファイル・ディレクトリを除外：

```dockerignore
# Python 仮想環境 (8.4GB)
.venv/

# 学習アーティファクト (5.5GB)
recap_subworker/learning_machine/artifacts/
recap_subworker/learning_machine/data/
*.safetensors

# 開発用ファイル
tests/
scripts/
__pycache__/
.pytest_cache/
```

### 2. Dockerfile のレイヤーキャッシュ最適化

依存関係ファイルとソースコードのコピー順序を変更：

```dockerfile
# 【修正後】依存関係ファイルのみを先にコピー
COPY pyproject.toml uv.lock README.md ./

# 依存関係をインストール（ソースコード変更時はキャッシュ使用）
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-dev

# アプリケーションコードをコピー（依存関係インストール後）
COPY recap_subworker ./recap_subworker
```

### 修正ファイル

| ファイル | 変更内容 |
|----------|----------|
| `recap-subworker/.dockerignore` | 新規作成 |
| `recap-subworker/Dockerfile.recap-subworker` | COPY 順序修正 |

## RESULTS, EFFECTS

### 期待される改善

| 項目 | 改善前 | 改善後 |
|------|--------|--------|
| ビルドコンテキスト | 15GB | ~1GB |
| ソースコード変更時のビルド | 10分+ | ~1分 |
| 依存関係変更時のビルド | 10分+ | 5分程度 |

### PROS

1. **ビルド時間の大幅短縮**
   - ビルドコンテキスト送信時間: 93%削減
   - レイヤーキャッシュによる依存関係インストールスキップ

2. **開発体験の向上**
   - ソースコード変更時の高速なイテレーション
   - タイムアウトエラーの回避

3. **CI/CD パイプラインの効率化**
   - ビルド時間短縮によるリソース節約

### CONS, TRADEOFF

1. **`.dockerignore` のメンテナンス**
   - 新しい大きなファイル・ディレクトリが追加された場合、更新が必要

2. **学習アーティファクトの除外**
   - `learning_machine/artifacts/` はイメージに含まれない
   - 本番環境では volume マウントまたは別途配布が必要

## APPENDIX

### Docker レイヤーキャッシュのベストプラクティス

1. **命令の順序が重要**
   - 変更頻度の低いものを先に、高いものを後に
   - 依存関係ファイル → インストール → ソースコード

2. **`.dockerignore` の活用**
   - ビルドコンテキストを最小化
   - 不要なファイルの除外でビルド高速化

3. **BuildKit cache mount の活用**
   - パッケージマネージャーのキャッシュを永続化
   - `--mount=type=cache,target=/root/.cache/uv`

### 参考資料

- [Docker Layer Caching Best Practices](https://docs.docker.com/build/cache/optimize/)
- [Multi-stage Builds Optimization](https://pythonspeed.com/articles/faster-multi-stage-builds/)
- [Docker Build Best Practices](https://docs.docker.com/build/building/best-practices/)
