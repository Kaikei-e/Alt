# ADR-000252: フィード収集のレートリミット二重待機修正と pre-processor デッドコード削除

## ステータス

承認済み

## コンテキスト

### 背景

alt-backend の `CollectMultipleFeeds` はフィード URL ごとに以下の 2 ステップを実行する。

1. `validateFeedURL` — HEAD リクエストで URL の到達性を確認
2. `fp.ParseURL` — GET リクエストで RSS フィードを取得・パース

各ステップの前に `HostRateLimiter.WaitForHost` を呼び出しており、同一ドメインに対して **2 回のレートリミット待機** が発生していた。

### 問題

`ExternalAPIInterval` のデフォルトが 5 秒のため、同一ドメインのフィードごとに意図せず **10 秒** の待機が発生していた。

```
validateFeedURL:
  WaitForHost (5s) → HEAD リクエスト
CollectMultipleFeeds:
  WaitForHost (5s) → ParseURL (GET リクエスト)
合計: 10 秒/フィード/ドメイン
```

マナーとして 10 秒間隔は妥当だが、二重待機という実装上のバグは修正すべきである。

### pre-processor のデッドコード

pre-processor の `FetchArticle` はコンプライアンス上の理由で無効化されており、`nil, nil` を返すスタブになっている。このスタブに紐づくレートリミット関連コード（`DomainRateLimiter`、`RateLimitedHTTPClient`、`CircuitBreaker`、`AdaptiveLimiter`）がプロダクションコードから参照されないまま残存していた。

## 意思決定

### 変更 1: alt-backend — 二重待機修正 + デフォルト間隔を 10s に変更

`validateFeedURL` からレートリミッタのパラメータと待機ブロックを除去し、`CollectMultipleFeeds` 内の `ParseURL` 直前の待機のみを残す。同時に `ExternalAPIInterval` のデフォルト値を 5 秒から 10 秒に変更することで、意図した 10 秒間隔を単一の待機で実現する。

```
変更前: WaitForHost(5s) → HEAD → WaitForHost(5s) → GET (合計 10s、二重待機)
変更後: HEAD → WaitForHost(10s) → GET (合計 10s、単一待機)
```

**HEAD リクエストのレートリミットを外す根拠:**

- HEAD リクエストは軽量であり、サーバ負荷は低い
- `ParseURL` (GET) の直前で 10 秒の待機が入るため、同一ドメインへの実質的なリクエスト間隔は維持される
- `CollectSingleFeed` は独自の `WaitForHost` を持ち、この変更の影響を受けない

### 変更 2: pre-processor — デッドコード削除

無効化された `FetchArticle` スタブに紐づくレートリミット関連コードを削除する。

**削除対象（8 ファイル）:**

| ファイル | 理由 |
|---------|------|
| `utils/domain_rate_limiter.go` (+test) | `articleFetcherService` のみが参照し、`FetchArticle` は無効スタブ |
| `utils/rate_limiter.go` (+test) | `RateLimitedHTTPClient`、プロダクションコードから未参照 |
| `utils/circuit_breaker.go` (+test) | `rate_limiter.go` のみが参照（連鎖削除） |
| `ratelimit/adaptive_limiter.go` (+test) | 実装済みだがパッケージ外から未参照・未統合 |

**修正対象:**

| ファイル | 変更 |
|---------|------|
| `service/article_fetcher.go` | `rateLimiter` フィールド削除、3 つのコンストラクタから `NewDomainRateLimiter` 呼び出し削除、未使用 import 削除 |

**保持するもの:**

- `config.RateLimitConfig` — Config struct の一部であり、環境変数のロード・バリデーションが依存
- `FetchArticle` / `ProcessFeeds` スタブ — インターフェース契約の一部

### 検討した代替案

| 案 | 不採用理由 |
|---|---|
| デフォルト値は 5s のまま、二重待機だけ除去 | 対外 API への礼儀として 10 秒間隔を維持したい |
| `validateFeedURL` 側のみに待機を残す | GET（ParseURL）の方がサーバ負荷が高く、GET 直前でのゲートが適切 |
| pre-processor のデッドコードを残す | 未使用コードはメンテナンスコストとなり、リファクタリングの障害になる |
| `config.RateLimitConfig` も削除する | Config のロード・バリデーション・環境変数ハンドリングへの波及が大きく、別途対応すべき |

## 結果・影響

### 変更ファイル一覧

| サービス | ファイル | 変更内容 |
|---------|---------|---------|
| alt-backend | `app/config/config.go` | `ExternalAPIInterval` デフォルト: `"5s"` → `"10s"` |
| alt-backend | `app/config/config_test.go` | テスト期待値: `5 * time.Second` → `10 * time.Second` |
| alt-backend | `app/job/feed_collector.go` | `validateFeedURL` のシグネチャから `rateLimiter` パラメータ削除、レートリミット待機ブロック削除、呼び出し元を更新 |
| pre-processor | `app/service/article_fetcher.go` | `rateLimiter` フィールドと 3 箇所のコンストラクタ初期化を削除、未使用 import 削除 |
| pre-processor | 8 ファイル削除 | `domain_rate_limiter`, `rate_limiter`, `circuit_breaker`, `adaptive_limiter` (各 +test)、`ratelimit/` ディレクトリ |

### テスト結果

- `alt-backend`: `go test ./...` — 全パッケージ PASS、`go build ./...` — 成功
- `pre-processor`: `go test ./...` — 全パッケージ PASS、`go build ./...` — 成功
- コンテナ再ビルド・再起動後、両サービスともヘルスチェック正常

### 期待される動作変化

- 同一ドメインのフィード収集間隔が 10 秒で維持される（変更前と実質同じ）
- `validateFeedURL` でのレートリミット待機ログ（`"Applying rate limiting for feed URL validation"`）が出力されなくなる
- 既存の環境変数 `RATE_LIMIT_EXTERNAL_API_INTERVAL` によるオーバーライドは引き続き有効

### 影響範囲

- **`CollectSingleFeed`**: 独自の `WaitForHost` を持ち、影響なし
- **`FetchArticleGateway`**: 独立したレートリミッタで影響なし
- **pre-processor の要約パイプライン**: `FetchArticle` は無効スタブのままで動作に変更なし
- **環境変数 `RATE_LIMIT_EXTERNAL_API_INTERVAL`**: 明示的に設定している場合、デフォルト変更の影響なし

## 関連 ADR

- ADR-000251: 要約バッチと品質チェッカーの無限ループ解消
