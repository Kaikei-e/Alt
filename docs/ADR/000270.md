# ADR-000270: ArticlePrefetcher キャッシュ逐出によるOGPサムネイル消失の修正

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000268/269 で Visual Preview モードを実装し、`ArticlePrefetcher` の `ogImageCache` を介して OGP サムネイル画像を管理する構成とした。バックエンド側は正常動作（`article_heads` テーブルに正しい OGP 画像 URL が保存済み、エラーログなし）していたが、**OGP サムネイルが一瞬表示された後にフォールバック（グラデーション）に切り替わる**現象が発生した。

### 根本原因

`ArticlePrefetcher` の `MAX_CACHE_SIZE = 5` に対し、Visual Preview モードでは `prefetchAhead = 5`（`SwipeFeedScreen.svelte`）。アクティブフィード + 先読み 5 件 = 6 エントリがキャッシュに入ろうとするが、5 件を超えた時点で最古のエントリ（= アクティブフィード）が逐出され、OGP 画像が消失していた。

```
T=0:      loadMore() → 最初のフィードの記事をバックグラウンド取得開始
T=~200ms: 記事取得完了 → ogImageCache に保存 → 画像表示
T=500ms~: triggerPrefetch → feeds[1]〜feeds[5] を順次先読み開始
T=~3s:    feeds[5] 先読み完了 → contentCache.size = 6 > MAX_CACHE_SIZE(5)
          → feeds[0] の contentCache と ogImageCache を逐出
          → onOgImageFetched() → ogImageVersion++
          → currentOgImage 再評価 → getCachedOgImage(feeds[0]) = null
          → 画像消失、フォールバックグラデーション表示
```

### 副次的問題

1. `SwipeFeedScreen.svelte` で `(articlePrefetcher as any)` を使い private キャッシュを直接操作していた（型安全性の欠如、eviction 不整合リスク）
2. その直接操作の eviction が `contentCache` のみ削除し、`ogImageCache` を削除しない不整合

## 意思決定

### 方針

1. `MAX_CACHE_SIZE` を `5` → `10` に増加し、`prefetchAhead` の最大値 (5) + アクティブフィード + 安全マージンでキャッシュ逐出を回避する
2. `seedCache()` public メソッドを追加し、外部からの型安全なキャッシュ投入を可能にする
3. `evictOldEntries()` private メソッドに逐出ロジックを統一し、`contentCache` と `ogImageCache` の不整合を防ぐ

### 不採用案

| 不採用案 | 理由 |
|---------|------|
| LRU キャッシュに置き換え | アクティブフィードを特別扱いする必要があり実装が複雑になる。`MAX_CACHE_SIZE` の増加で十分 |
| `prefetchAhead` を 4 以下に制限 | UX 劣化。先読み数を減らすと Visual Preview モードのスムーズさが失われる |
| キャッシュ逐出時にアクティブフィードをスキップ | `ArticlePrefetcher` が `activeIndex` を知る必要があり、関心の分離が崩れる |

### 変更詳細

#### 変更 1: MAX_CACHE_SIZE の増加

`articlePrefetcher.ts` の `MAX_CACHE_SIZE` を `5` → `10` に変更。

#### 変更 2: seedCache メソッドの追加

`ArticlePrefetcher` に public メソッド `seedCache` を追加。外部から API レスポンスをキャッシュに投入するための型安全なインターフェース。

```typescript
public seedCache(
    feedUrl: string,
    content: string,
    articleId: string,
    ogImageUrl: string | null,
): void {
    this.contentCache.set(feedUrl, content);
    this.articleIdCache.set(feedUrl, articleId);
    this.ogImageCache.set(feedUrl, ogImageUrl);
    this.onOgImageFetched?.();
    this.evictOldEntries();
}
```

#### 変更 3: evictOldEntries の統一

`prefetchContent` 内のインライン逐出コードと `seedCache` の両方から `evictOldEntries()` を呼び出し、`contentCache` と `ogImageCache` を常に整合的に逐出する。

```typescript
private evictOldEntries(): void {
    while (this.contentCache.size > MAX_CACHE_SIZE) {
        const oldestKey = this.contentCache.keys().next().value;
        if (oldestKey !== undefined) {
            this.contentCache.delete(oldestKey);
            this.ogImageCache.delete(oldestKey);
        }
    }
}
```

#### 変更 4: SwipeFeedScreen の private キャッシュ操作の排除

`loadMore` 内の `(articlePrefetcher as any).contentCache` 等の直接操作を `articlePrefetcher.seedCache()` 呼び出しに置換。

## 結果・影響

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/src/lib/utils/articlePrefetcher.ts` | `MAX_CACHE_SIZE` 5→10、`seedCache()` 追加、`evictOldEntries()` 抽出・統一 |
| `alt-frontend-sv/src/lib/utils/articlePrefetcher.spec.ts` | `seedCache` テスト 3 件 + キャッシュ逐出回帰テスト 1 件追加 |
| `alt-frontend-sv/src/lib/components/mobile/feeds/swipe/SwipeFeedScreen.svelte` | `(articlePrefetcher as any)` ハック → `seedCache()` に置換 |

### テスト結果

| テストスイート | 結果 |
|--------------|------|
| Frontend prefetcher (`vitest run articlePrefetcher.spec.ts`) | 16/16 PASS |
| 型チェック (`svelte-check`) | 0 エラー, 0 警告 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| コンテナ再ビルド (`alt-frontend-sv`) | ビルド成功 |
| Frontend ヘルスチェック (`localhost:3000/api/health`) | 200 OK |
| コンテナステータス | healthy |

### PROS

- **OGP サムネイルが安定表示される**: 先読み完了後もアクティブフィードのキャッシュが逐出されない
- **型安全性の向上**: `as any` キャストを排除し、public API 経由でキャッシュ操作
- **キャッシュ整合性の保証**: `evictOldEntries()` により `contentCache` と `ogImageCache` が常に同期して逐出される
- **最小限の変更**: 定数変更 + メソッド 2 つの追加で根本原因を解決

### CONS, TRADEOFF

- **キャッシュメモリ使用量の微増**: `MAX_CACHE_SIZE` を 5 → 10 に増加したため、最大保持エントリ数が倍増。ただし記事コンテンツは HTML 文字列のみで、画像バイナリは保持しないため影響は軽微
- **`articleIdCache` は `evictOldEntries` で逐出されない**: `contentCache` と `ogImageCache` のみ逐出対象。`articleIdCache` は ID 文字列のみでメモリ影響が無視できるため、現時点では許容

## 付録

### ADR-000268/269 からの関連

| 項目 | ADR-000268 | ADR-000269 | ADR-000270 (本 ADR) |
|------|-----------|-----------|---------------------|
| 課題 | フロントエンド regex 抽出の廃止 | ogImageCache の非リアクティブ性 | キャッシュ逐出によるサムネイル消失 |
| MAX_CACHE_SIZE | 5（既存） | 変更なし | 5 → 10 |
| キャッシュ操作 | private のみ | `as any` で直接操作を導入 | `seedCache()` public API に統一 |
| 逐出ロジック | `contentCache` のみ削除 | 変更なし | `evictOldEntries()` で統一（contentCache + ogImageCache） |
