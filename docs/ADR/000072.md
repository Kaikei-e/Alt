# 統一ロギング基盤の導入 (OpenTelemetry準拠)

## ステータス

採択（Accepted）

## コンテキスト

ポリグロット（Go, Python, Rust, Deno）マイクロサービス環境において、以下の課題が存在した：

1. **分散トレーシングなし**: サービス間のリクエスト追跡が不可能
2. **ログフォーマット不統一**: `msg` vs `message`、フィールド名がサービス毎にバラバラ
3. **コンテキスト伝播なし**: W3C Trace Context未対応
4. **ログレベル環境変数不統一**: `LOG_LEVEL`, `TAG_LOG_LEVEL` 等が混在

### 検討した選択肢

| 選択肢 | 概要 | 採否 |
|--------|------|------|
| A案: OTel Collector導入 | 標準的なOTel Collector (otelcol) をデプロイ | 不採用 |
| B案: rask-log-* 拡張 | 既存のRust製ログ基盤にOTLPレシーバーを追加 | **採用** |

### B案採用の理由

- 既存のSIMD最適化パーサー（>4GB/s）を維持
- Docker Compose環境ではOTel Collectorは過剰
- 既にRust開発リソースがあり、メンテナンス可能
- OTLPレシーバー追加は軽微な変更

## 決定

OpenTelemetry標準に準拠した統一ログ・トレース基盤を構築する。

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│ アプリケーション層 (OTel SDK導入)                           │
├─────────────────────────────────────────────────────────────┤
│ Go Services      Python Services   Rust Services    Deno   │
│ ├─ slog+OTel     ├─ structlog+OTel ├─ tracing+JSON  └─ JSON│
│ └─ otelecho      └─ FastAPI計装    └─ (stdout)       logger│
└───────────────────────────┬─────────────────────────────────┘
                            │
         ┌──────────────────┴──────────────────┐
         │ OTLP (HTTP:4318)                    │
         ▼                                     ▼
┌─────────────────────┐    ┌──────────────────────────────────┐
│ rask-log-aggregator │    │ Docker Containers (stdout/stderr)│
│ ├─ /v1/logs (OTLP)  │    └───────────────┬──────────────────┘
│ ├─ /v1/traces (OTLP)│                    │ Docker JSON logs
│ └─ /v1/aggregate    │    ┌───────────────┘
│    (legacy NDJSON)  │    ▼
└─────────┬───────────┘    ┌─────────────────────┐
          │                │ rask-log-forwarder  │
          │                │ (SIMD parsing)      │
          │                └─────────┬───────────┘
          └──────────┬───────────────┘
                     ▼
            ┌──────────────┐
            │ ClickHouse   │
            │ ├─ otel_logs │
            │ └─ otel_traces│
            └──────────────┘
                     │
                     ▼
            ┌──────────────┐
            │ Grafana      │
            │ (dashboards) │
            └──────────────┘
```

### 統一ログスキーマ (OTel Log Data Model準拠)

```json
{
  "Timestamp": "2025-01-10T12:00:00.000000000Z",
  "SeverityText": "INFO",
  "SeverityNumber": 9,
  "Body": "Request processed",
  "Resource": {
    "service.name": "example-service",
    "service.version": "1.0.0",
    "deployment.environment": "production"
  },
  "TraceId": "abc123def456...",
  "SpanId": "789xyz..."
}
```

### 統一環境変数

| 変数名 | 説明 | デフォルト |
|--------|------|-----------|
| `OTEL_ENABLED` | OTel有効化 | `true` |
| `OTEL_SERVICE_NAME` | サービス識別子 | 各サービス名 |
| `OTEL_EXPORTER_OTLP_ENDPOINT` | OTLPエンドポイント | `http://localhost:4318` |
| `DEPLOYMENT_ENV` | デプロイ環境 | `development` |
| `SERVICE_VERSION` | サービスバージョン | `0.0.0` |

## 結果

### 変更されたファイル

| カテゴリ | ファイル | 変更内容 |
|----------|---------|---------|
| ClickHouse | `clickhouse/migrations/004_create_otel_logs.sql` | OTel準拠ログテーブル |
| ClickHouse | `clickhouse/migrations/005_create_otel_traces.sql` | トレーステーブル |
| ClickHouse | `clickhouse/migrations/006_create_otel_http_mv.sql` | HTTPログ用MV |
| Go | `*/utils/otel/provider.go` | OTelプロバイダー初期化 |
| Go | `*/utils/logger/*_handler.go` | slog + OTelハンドラー |
| Python | `tag-generator/app/tag_generator/otel.py` | OTelプロバイダー |
| Python | `news-creator/app/news_creator/otel.py` | OTelプロバイダー + FastAPI計装 |
| Rust | `rask-log-aggregator/app/src/otlp/*` | OTLPレシーバー実装 |
| Rust | `*/Cargo.toml` | `tracing-subscriber` JSON feature追加 |
| Deno | `*/src/utils/logger.ts` | OTelセマンティック属性追加 |
| Grafana | `observability/grafana/dashboards/otel-overview.json` | ログ概要ダッシュボード |
| Grafana | `observability/grafana/dashboards/trace-explorer.json` | トレース検索ダッシュボード |

### メリット

1. **分散トレーシング**: `trace_id`によるサービス間リクエスト追跡が可能
2. **フォーマット統一**: OTel Log Data Modelに準拠した一貫性のあるログ
3. **既存資産活用**: rask-log-*のSIMD最適化を維持
4. **段階的移行**: レガシーエンドポイント（`/v1/aggregate`）との互換性維持
5. **可観測性向上**: Grafanaでのtrace_id検索、サービス間依存関係可視化

### トレードオフ

1. **SDK導入コスト**: 各言語でOTel SDKの依存関係が増加
2. **学習コスト**: OTelの概念（Resource, Span, TraceContext等）の理解が必要
3. **オーバーヘッド**: OTelエクスポート処理による微小なレイテンシ増加（バッチ処理で軽減）

## 検証計画

1. **単体テスト**: 各サービスでログ出力にtrace_id/span_idが含まれることを確認
2. **統合テスト**: リクエストがサービスを跨いでもtrace_idが伝播することを確認
3. **E2Eテスト**: Grafanaでtrace_idクエリ → 関連ログ・トレース全取得

## 実装日

2026-01-10

## 関連

- [OpenTelemetry Logs](https://opentelemetry.io/docs/concepts/signals/logs/)
- [OpenTelemetry Log Data Model](https://opentelemetry.io/docs/specs/otel/logs/data-model/)
- [ClickHouse OpenTelemetry Integration](https://clickhouse.com/docs/observability/integrating-opentelemetry)
