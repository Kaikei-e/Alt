# search-indexer の Redis Streams Consumer 統合

## ステータス

採択（Accepted）

## コンテキスト

### 背景

Alt プラットフォームでは、イベント駆動アーキテクチャを採用し、サービス間の非同期通信を実現している。理想のアーキテクチャは以下の通り：

```
alt-backend → mq-hub → Redis Streams → workers (pre-processor, search-indexer, tag-generator)
```

mq-hub は Connect-RPC ベースのイベントブローカーで、Redis Streams を使用してイベントを配信する。

### 問題点

search-indexer が Redis Streams を使用せず、データベースポーリング方式（5 分間隔）で動作していた。

| コンポーネント | 期待される状態 | 実際の状態 |
|---------------|--------------|-----------|
| pre-processor | Redis Streams Consumer | Redis Streams Consumer |
| tag-generator | Redis Streams Consumer | Redis Streams Consumer |
| search-indexer | Redis Streams Consumer | DB ポーリング（5 分間隔） |

この結果、記事が作成されてから検索インデックスに反映されるまで最大 5 分の遅延が発生していた。

## 決定

search-indexer に Redis Streams Consumer を追加し、イベント駆動でリアルタイムにインデックスを更新する。

### アーキテクチャ

```
┌─────────────┐     ┌─────────┐     ┌───────────────┐     ┌────────────────┐
│ alt-backend │ ──► │ mq-hub  │ ──► │ Redis Streams │ ──► │ search-indexer │
└─────────────┘     └─────────┘     └───────────────┘     └────────────────┘
                                           │
                                           ├──► pre-processor
                                           └──► tag-generator
```

### 実装方針

1. **Consumer パッケージの新規作成**: pre-processor の実装パターンを参考に、search-indexer 用の Consumer を実装
2. **デュアルモード維持**: 既存のバックフィル処理（Phase 1）は維持し、Consumer は追加のインデックス更新手段として機能
3. **Consumer Group**: `search-indexer-group` として独立したグループで消費

## 結果

### 変更ファイル

| コンポーネント | ファイル | 変更内容 |
|--------------|---------|---------|
| search-indexer | `consumer/config.go` | 新規: Consumer 設定 |
| search-indexer | `consumer/redis_consumer.go` | 新規: Redis Streams Consumer 実装 |
| search-indexer | `consumer/event_handler.go` | 新規: イベントハンドラー |
| search-indexer | `port/article_repository.go` | `GetArticleByID` メソッド追加 |
| search-indexer | `gateway/article_repository_gateway.go` | `GetArticleByID` 実装 |
| search-indexer | `driver/database_driver.go` | `GetArticleByID` SQL クエリ実装 |
| search-indexer | `usecase/index_articles.go` | `ExecuteSingleArticle` メソッド追加 |
| search-indexer | `main.go` | Consumer 起動ロジック追加 |
| compose | `workers.yaml` | Redis Streams 環境変数追加 |

### 新規 Consumer の設定

| 環境変数 | 値 | 説明 |
|---------|-----|------|
| `REDIS_STREAMS_URL` | `redis://redis-streams:6379` | Redis 接続 URL |
| `CONSUMER_ENABLED` | `true` | Consumer 有効化 |
| `CONSUMER_GROUP` | `search-indexer-group` | Consumer グループ名 |
| `CONSUMER_NAME` | `search-indexer-1` | Consumer インスタンス名 |

### イベントフロー

```
1. ArticleCreated イベント発行
2. Redis Streams (alt:events:articles) にエンキュー
3. search-indexer Consumer が XREADGROUP で取得
4. ExecuteSingleArticle で単一記事をインデックス
5. XACK でイベント処理完了を通知
```

### メリット

1. **リアルタイム更新**: 記事作成から検索可能になるまでの遅延が数秒に短縮
2. **一貫したアーキテクチャ**: 全 worker が同一のイベント駆動パターンを採用
3. **スケーラビリティ**: Consumer Group により水平スケーリングが可能
4. **耐障害性**: at-least-once 配信により、Consumer 障害時も再処理可能

### 考慮事項

| 項目 | 対策 |
|------|------|
| イベント重複配信 | Meilisearch の upsert 操作により冪等性を確保 |
| Consumer 障害 | バックフィル処理（Phase 1/2）がフォールバックとして機能 |
| メッセージ順序 | 単一記事の更新は順序依存なし |

### 動作確認

```bash
# Consumer Group の確認
redis-cli XINFO GROUPS alt:events:articles

# 出力例
name: search-indexer-group
consumers: 1
pending: 0
```

## 実装日

2026-01-14

## 関連

- ADR 000045: mq-hub イベントブローカーの導入
- ADR 000052: Redis Streams によるイベント配信
- [Redis Streams Documentation](https://redis.io/docs/data-types/streams/)
