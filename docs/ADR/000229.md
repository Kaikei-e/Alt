# ADR-000229: フロントエンド検索の article_id 欠落による重複キー問題の修正

## STATUS

Accepted（実装完了・コンテナデプロイ・動作確認済み）

## CONTEXT

ADR-228 でバックエンド側の `FeedItem.Id` に `ArticleID`（記事ごとに一意）を設定する修正を行ったが、ブラウザコンソールに依然として Svelte reconcile エラーが発生していた:

```
TypeError: Cannot read properties of undefined (reading 'prev')
RangeError: Invalid array length
```

### 根本原因

ADR-228 のバックエンド修正は正しく動作しているが、**フロントエンドの `searchFeedsClient` がレスポンスから `article_id` を捨てていた**ため、`sanitizeFeed` でフォールバックの `link`（フィードソース URL）が `id` として使われ、重複キーが再発していた。

**データフロー（修正前）:**

```
Backend Proto FeedItem.Id = ArticleID（一意）
    ↓
Connect-RPC → ConnectFeedItem.articleId = proto.articleId（一意）
    ↓
searchFeedsClient  ← ★ article_id をマッピングしていない
    SearchFeedItem = { title, description, link, published, author }
    ↓
sanitizeFeed → id = rawFeed.link（フィードソース URL = 重複する）
    ↓
{#each feeds as feed (feed.id)}  → 重複キーで reconcile 破綻
```

### 影響範囲

| ページ | API 関数 | 問題 |
|--------|---------|------|
| `/(app)/feeds/search` | `searchFeedsClient` | `id` が `link` にフォールバック（重複） |
| モバイル検索（`SearchResults.svelte`） | `searchFeedsClient` | `{#each}` キーが `link \|\| title`（重複可能） |
| `/desktop/feeds/search` | `searchFeedsDesktopClient` | `connectFeedToRenderFeed` 経由で `id` に `ArticleID` が設定済み → **問題なし** |

デスクトップ検索は `connectFeedToRenderFeed` を使用しており、`item.id`（= Proto の `Id` = `ArticleID`）がそのまま渡されるため影響なし。問題は `searchFeedsClient` のみ。

## DECISION MAKING

### 3 箇所の修正でフロントエンド全パスの重複キーを解消

バックエンドはすでに正しい `ArticleID` を返しているため、フロントエンド側のデータ伝搬を修正する。

**方針:**

1. `searchFeedsClient` で `article_id` を保持する
2. `sanitizeFeed` で `article_id` を `id` として優先使用する
3. モバイル検索の `{#each}` キーを一意化する

### 代替案: `searchFeedsClient` を廃止して `searchFeedsDesktopClient` に統一

デスクトップ検索用の `searchFeedsDesktopClient` は `connectFeedToRenderFeed` を使用しており、この問題が発生しない。しかし、`SearchFeedItem` と `RenderFeed` は型が異なり、モバイル検索ページの `transformFeedSearchResult` 等の既存処理に影響が出るため、最小限の修正を優先した。

## RESULTS

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/src/lib/api/client/feeds.ts` | `searchFeedsClient` のマッピングに `article_id` を追加 |
| `alt-frontend-sv/src/lib/domain/feed/sanitize.ts` | `sanitizeFeed` で `article_id` を `id` に優先使用 |
| `alt-frontend-sv/src/lib/components/mobile/search/SearchResults.svelte` | `{#each}` キーを `article_id` 優先に変更 |
| `alt-frontend-sv/src/lib/domain/feed/sanitize.test.ts` | `article_id` → `id` のテスト 3 件追加 |

### searchFeedsClient の変更

```typescript
// Before: article_id をマッピングしていない
const results: SearchFeedItem[] = response.data.map((item) => ({
    title: item.title,
    description: item.description,
    link: item.link,
    published: item.published,
    author: item.author ? { name: item.author } : undefined,
}));

// After: article_id を追加
const results: SearchFeedItem[] = response.data.map((item) => ({
    title: item.title,
    description: item.description,
    link: item.link,
    published: item.published,
    author: item.author ? { name: item.author } : undefined,
    article_id: item.articleId,
}));
```

`SearchFeedItem` は `BackendFeedItem` を extends しており、`BackendFeedItem` に `article_id?: string` が既に定義されているため型変更は不要。

### sanitizeFeed の変更

```typescript
// Before: 常に link を id として使用
return {
    id: rawFeed.link || "",
    ...
};

// After: article_id があればそれを優先
return {
    id: rawFeed.article_id || rawFeed.link || "",
    ...
};
```

### モバイル検索の {#each} キー変更

```svelte
<!-- Before: link は重複しうる -->
{#each results as result (result.link || result.title)}

<!-- After: article_id を優先、フォールバックに index で一意化 -->
{#each results as result, i (result.article_id || `${result.link}-${i}`)}
```

### テスト追加

`sanitize.test.ts` に 3 件のテストを追加:

| テスト | 検証内容 |
|-------|---------|
| `uses article_id as id when present` | `article_id` がある場合にそれが `id` になること |
| `falls back to link when article_id is missing` | `article_id` がない場合に `link` にフォールバック |
| `falls back to empty string when both are missing` | 両方ない場合に空文字にフォールバック |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `sanitize.test.ts`（10 件） | 全件 PASS |
| `domain/feed` + `utils/feed` テスト（46 件） | 全件 PASS |
| `alt-frontend-sv` コンテナ再ビルド・起動 | 正常 (`healthy`) |
| ヘルスチェック (`/api/health`) | 200 OK |

## PROS

1. **全検索パスでクラッシュ解消**: デスクトップ・レスポンシブ・モバイルの全検索ページで重複キーが発生しなくなる
2. **最小限の変更**: 3 ファイルの修正で、既存の型定義・データフローを活用
3. **既存動作に影響なし**: `article_id` がない場合は従来通り `link` にフォールバックするため、検索以外のフィード一覧に影響なし
4. **テストカバレッジ向上**: `sanitizeFeed` の `id` 割り当てロジックにテストが追加された

## CONS, TRADEOFF

1. **`id` の形式が不統一**: 検索結果では `article_id`（UUID）、通常のフィード一覧では `link`（URL）が `id` として使用される。現状はキーとしてのみ使用しているため問題ないが、`id` の形式に依存する処理を追加する場合は注意が必要
2. **モバイル検索のフォールバック**: `article_id` がない場合に `${link}-${index}` をキーとするため、リスト途中への挿入時に再レンダリングが発生する可能性がある。ただし検索結果は append-only であるため実用上の問題はない

## APPENDIX

### ADR-228 との関係

ADR-228 はバックエンド（Go）側の修正で、Proto レスポンスに一意な `ArticleID` を含めるようにした。本 ADR-229 はその補完として、フロントエンド（SvelteKit）側で `ArticleID` が正しくデータフロー全体を通じて伝搬されるようにした。

```
ADR-228: Backend で ArticleID を Proto.Id に設定 ✓
ADR-229: Frontend で article_id を searchFeedsClient → sanitizeFeed → {#each} キーまで伝搬 ✓
```

両方の修正により、検索結果の重複 ID 問題がバックエンドからフロントエンドまで一貫して解消された。
