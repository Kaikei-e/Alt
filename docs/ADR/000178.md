# LLM推論キューのStarvation対策: 保証帯域と優先度プロモーション

## ADR's STATUS

Accepted

## CONTEXT

### 問題点

バッチ処理（Recap Summary生成）がLLM推論キューでstarvation（飢餓状態）に陥り、30分のタイムアウトで失敗する事象が発生した。

| 症状 | 原因 |
|------|------|
| バッチリクエストが4時間以上待機 | LOW PRIORITY (BE) リクエストがHIGH PRIORITY (RT) に優先され続けた |
| 全47ジャンルで失敗 | 4チャンクすべてが30分間隔でタイムアウト |
| キューサイズ常時40-49 | リアルタイム要約リクエストが連続で流入 |

### 根本原因

既存のHybrid RT/BEスケジューリングには以下の制限があった:

1. **Agingメカニズムの閾値が緩すぎる**: 60秒経過後に優先度がわずかに上昇するのみ
2. **BE保証帯域がない**: RTリクエストが連続すると、BEは永久に待機させられる
3. **優先度プロモーションがない**: 長時間待機してもBEはBEのまま

```
Timeline (実際の失敗ケース):
04:00  Job開始
04:09  クラスタリング完了、バッチサマリー生成開始
04:39  chunk_idx=0 タイムアウト (30分)
05:09  chunk_idx=1 タイムアウト (30分)
05:39  chunk_idx=2 タイムアウト (30分)
06:09  chunk_idx=3 タイムアウト (30分) → ジョブ失敗
```

### 業界標準のアプローチ

LLMスケジューリングの研究・実践から以下が推奨される:

| アプローチ | 参考文献 |
|-----------|---------|
| Aging (優先度エイジング) | [Wikipedia: Aging (scheduling)](https://en.wikipedia.org/wiki/Aging_(scheduling)) |
| Guaranteed Bandwidth | [HuggingFace: Efficient Request Queueing](https://huggingface.co/blog/tngtech/llm-performance-request-queueing) |
| Priority Promotion | [GeeksforGeeks: Starvation and Aging](https://www.geeksforgeeks.org/operating-systems/starvation-and-aging-in-operating-systems/) |

## DECISION MAKING

### 実装アプローチ

2つのメカニズムを`HybridPrioritySemaphore`に追加:

#### 1. 保証帯域 (Guaranteed Bandwidth)

RTリクエストがN回連続でリリースされた場合、次はBEリクエストを強制的に処理する。

```
RT:BE比率 = 5:1 (デフォルト)
→ 5回のRTリリース後、BEが1回保証される
→ 最悪ケース: BE待機時間 = 5 × 平均RT処理時間
```

#### 2. 優先度プロモーション (Priority Promotion)

BEリクエストが閾値時間を超えて待機した場合、RTキューに昇格させる。

```
promotion_threshold = 600秒 (10分)
→ 10分待機後、BEはRT優先度で処理される
→ 30分タイムアウト前に確実に処理開始
```

### キュー動作の変更

```
Before:
┌─────────┐     ┌─────────┐
│ RT Queue│ >>> │ BE Queue│  (RTが常に優先)
└─────────┘     └─────────┘

After:
┌─────────┐     ┌─────────┐
│ RT Queue│ <── │ BE Queue│  (10分後にBEが昇格)
└─────────┘  ↑  └─────────┘
             │
     5回連続RTリリース後はBE優先
```

### 新しいパラメータ

| パラメータ | デフォルト | 説明 |
|-----------|-----------|------|
| `priority_promotion_threshold_seconds` | 600.0 | BE→RT昇格閾値 |
| `guaranteed_be_ratio` | 5 | N回RT後にBE保証 (0で無効) |

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `news-creator/app/news_creator/gateway/hybrid_priority_semaphore.py` | 保証帯域・優先度プロモーション実装 |
| `news-creator/app/news_creator/config/config.py` | 新パラメータ追加 |
| `news-creator/app/news_creator/gateway/ollama_gateway.py` | 新パラメータを渡すよう更新 |
| `news-creator/app/tests/gateway/test_hybrid_priority_semaphore.py` | 新機能のテスト追加 |
| `news-creator/app/tests/gateway/test_ollama_gateway.py` | モック設定更新 |

### 主要な実装

#### 1. QueuedRequestのソート順改善

同優先度でのFIFO順序を保証するため、`enqueue_time`をソートキーに追加:

```python
@dataclass(order=True)
class QueuedRequest:
    priority_score: float  # Lower = higher priority
    enqueue_time: float    # Used for FIFO ordering within same priority
    future: asyncio.Future = field(compare=False)
    is_high_priority: bool = field(compare=False)
```

#### 2. 優先度スコア計算の強化

```python
def _compute_priority_score(self, high_priority: bool, enqueue_time: float) -> float:
    base_score = 0.0 if high_priority else 1.0

    if not high_priority:
        wait_time = time.monotonic() - enqueue_time

        # Priority promotion: BE becomes RT-like after promotion threshold
        if wait_time > self._priority_promotion_threshold:
            return 0.0  # RT level

        # Standard aging: gradually reduce score
        if wait_time > self._aging_threshold:
            aging_factor = (wait_time - self._aging_threshold) * self._aging_boost / 60.0
            base_score = max(0.1, base_score - aging_factor)

    return base_score
```

#### 3. 保証帯域の実装

```python
def release(self, was_high_priority: bool = False) -> None:
    # Check guaranteed bandwidth
    force_be = False
    if self._guaranteed_be_ratio > 0 and self._be_queue:
        if was_high_priority:
            self._consecutive_rt_releases += 1
            if self._consecutive_rt_releases >= self._guaranteed_be_ratio:
                force_be = True  # Force BE processing

    if force_be:
        # Process BE first, reset counter
        self._consecutive_rt_releases = 0
        # ... wake BE waiter
```

#### 4. 優先度プロモーション (BE→RTキュー移動)

```python
def _apply_aging(self) -> None:
    for request in self._be_queue:
        wait_time = current_time - request.enqueue_time

        if wait_time > self._priority_promotion_threshold:
            # Promote to RT queue
            request.priority_score = 0.0
            request.is_high_priority = True
            heapq.heappush(self._rt_queue, request)
        else:
            # Apply normal aging
            heapq.heappush(new_be_queue, request)
```

### 設定例

```bash
# 環境変数での設定
SCHEDULING_PRIORITY_PROMOTION_THRESHOLD_SECONDS=600  # 10分後にBE→RT昇格
SCHEDULING_GUARANTEED_BE_RATIO=5                      # 5:1 RT:BE比率
```

### PROS

1. **Starvation解消**: BEリクエストは最悪でも10分以内にRT優先度に昇格
2. **保証帯域**: RTが連続しても20%はBEに割り当てられる
3. **タイムアウト回避**: 30分タイムアウト前に確実に処理開始
4. **後方互換**: デフォルト値で既存動作に影響なし

### CONS, TRADEOFF

1. **RTレイテンシ微増**: 5リクエストに1回はBEが割り込む可能性
2. **設定の複雑化**: 新パラメータの理解が必要
3. **昇格後の優先度**: 昇格したBEは元のBEより優先される（FIFO順）

## APPENDIX

### テスト追加

11件の新しいテストを追加:

- `TestGuaranteedBandwidth` (5件): 保証帯域の動作検証
- `TestEnhancedAging` (6件): 優先度プロモーションの動作検証

### 動作確認ログ

```json
{
  "msg": "HybridPrioritySemaphore initialized",
  "total_slots": 2,
  "rt_reserved": 1,
  "be_slots": 1,
  "aging_threshold": 60.0,
  "priority_promotion_threshold": 600.0,
  "guaranteed_be_ratio": 5,
  "preemption_enabled": true
}
```

### 期待される改善効果

| メトリクス | Before | After |
|-----------|--------|-------|
| BE最大待機時間 | 数時間 (無制限) | 10分 (上限) |
| バッチ処理成功率 | 0% (タイムアウト) | ~100% |
| RT平均レイテンシ | 変化なし | +数ms (保証帯域分) |

### 関連ADR

- ADR-166: Recap Summary Hierarchical Summarization
- ADR-167: Hybrid RT/BE Priority Semaphore
