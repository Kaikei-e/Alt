# alt-frontend-sv Connect-RPC クライアント移行

## ステータス

**採択・実装完了（Accepted & Implemented）** - 2025年12月31日

## コンテキスト

### 背景

ADR-000030〜000032でバックエンド側のConnect-RPC実装が完了したが、フロントエンド（alt-frontend-sv）のクライアント層はREST APIを経由してバックエンドと通信していた。これにより以下の問題が発生していた：

1. **二重プロキシ**: クライアント → SvelteKit API Routes → バックエンドREST → 内部処理
2. **型安全性の欠如**: REST APIのレスポンス型は手動定義が必要
3. **メンテナンスコスト**: REST proxyルートとConnect-RPCハンドラの両方を維持

### 対象スコープ

| 領域 | 含む | 除外 |
|------|------|------|
| Feeds | 未読/既読フィード、統計、検索、既読マーク | - |
| Articles | コンテンツ取得、アーカイブ | 要約取得（REST維持） |
| RSS | フィード登録/削除/一覧、お気に入り登録 | - |
| Dashboard/Recap | - | 全て除外 |
| Streaming | 文書化のみ | 完全移行は別途 |

## 意思決定

### 決定1: クライアント関数の直接移行

**検討した代替案:**

| パターン | メリット | デメリット |
|----------|----------|------------|
| Feature Flagで切り替え | 段階的ロールアウト可能 | コード複雑化、両実装の維持 |
| **直接移行（採用）** | シンプル、メンテナンス容易 | ロールバックにはリデプロイ必要 |
| TanStack Query統合 | リアクティブ状態管理 | 大規模リファクタリング必要 |

**採用理由:**
- バックエンドConnect-RPCは既にプロダクション稼働中で安定
- クライアント関数のシグネチャを維持することで、コンポーネント変更不要
- Feature Flagは将来の新機能導入時に活用（基盤は構築済み）

### 決定2: 動的インポートパターン

```typescript
export async function updateFeedReadStatusClient(feedUrl: string): Promise<void> {
  const transport = createClientTransport();
  const { markAsRead } = await import("$lib/connect/feeds");
  await markAsRead(transport, feedUrl);
}
```

**設計判断:**
- 動的インポートでバンドルサイズ最適化
- 既存の関数シグネチャを維持（コンポーネント変更不要）
- Transport作成は関数内で完結（テスタビリティ向上）

### 決定3: MarkAsRead RPCの追加

既存のREST `/v1/feeds/read` に対応するConnect-RPCが存在しなかったため、新規追加：

```protobuf
// proto/alt/feeds/v2/feeds.proto
message MarkAsReadRequest {
  string feed_url = 1;
}

message MarkAsReadResponse {
  string message = 1;
}

service FeedService {
  // ... existing RPCs ...
  rpc MarkAsRead(MarkAsReadRequest) returns (MarkAsReadResponse);
}
```

### 決定4: Streaming移行の段階的アプローチ

**現状:**
- `streamSummarizeArticleClient`: REST SSE → `ReadableStreamDefaultReader<Uint8Array>`
- Connect-RPC版: コールバックベースAPI（`onChunk`, `onComplete`）

**決定:**
- 既存のRESTストリーミングは維持（コンポーネントが`ReadableStreamDefaultReader`を期待）
- Connect-RPC版は新規コード・将来のリファクタリング用に利用可能
- 完全移行は別ADRでコンポーネントリファクタリングと合わせて実施

### 決定5: TanStack Query基盤の先行構築

将来のリアクティブ状態管理に備え、基盤のみ構築：

```
src/lib/queries/
├── keys.ts      # クエリキー定義
├── feeds.ts     # Feed queries/mutations
├── articles.ts  # Article queries/mutations
├── rss.ts       # RSS queries/mutations
└── index.ts     # Re-exports
```

**特徴:**
- Svelte 5のrunesと互換（`createQuery(() => ({...}))`パターン）
- Optimistic updatesパターンを実装済み
- コンポーネントが準備でき次第、段階的に導入可能

## 結果・効果

### PROS

1. **通信経路の簡素化**
   - Before: Component → SvelteKit API Route → Backend REST → Handler
   - After: Component → Connect-RPC Proxy → Backend Connect-RPC → Handler

2. **型安全性の向上**
   - Protobuf定義から生成された型を使用
   - ランタイムエラーの削減

3. **保守性の向上**
   - REST proxyルートの削減候補が明確化
   - 単一のAPI実装（Connect-RPC）に集約可能

4. **後方互換性の維持**
   - クライアント関数のシグネチャ維持
   - コンポーネント変更なしで移行完了

### CONS / TRADEOFF

1. **REST proxyルートの残存**
   - 削除には別途作業が必要
   - 一時的に両方の実装が共存

2. **Streaming未完全移行**
   - コンポーネントリファクタリングが必要
   - インターフェース変更（Reader → Callback）

3. **TanStack Query未統合**
   - 基盤のみ構築、コンポーネント統合は別途

## 付録

### 移行されたクライアント関数一覧

| ファイル | 関数 | 移行先Connect-RPC |
|----------|------|-------------------|
| `feeds.ts` | `updateFeedReadStatusClient` | `FeedService.MarkAsRead` |
| `feeds.ts` | `getFeedStatsClient` | `FeedService.GetFeedStats` |
| `feeds.ts` | `getDetailedFeedStatsClient` | `FeedService.GetDetailedFeedStats` |
| `feeds.ts` | `getUnreadCountClient` | `FeedService.GetUnreadCount` |
| `articles.ts` | `getFeedContentOnTheFlyClient` | `ArticleService.FetchArticleContent` |
| `articles.ts` | `archiveContentClient` | `ArticleService.ArchiveArticle` |
| `articles.ts` | `registerFavoriteFeedClient` | `RSSService.RegisterFavoriteFeed` |
| `feedLinks.ts` | `listFeedLinksClient` | `RSSService.ListRSSFeedLinks` |
| `feedLinks.ts` | `registerRssFeedClient` | `RSSService.RegisterRSSFeed` |
| `feedLinks.ts` | `deleteFeedLinkClient` | `RSSService.DeleteRSSFeedLink` |

### 削除可能なREST Proxyルート

以下のルートはクライアントがConnect-RPCを使用するため、削除候補：

```
routes/api/v1/feeds/read/+server.ts
routes/api/v1/feeds/stats/+server.ts
routes/api/v1/feeds/stats/detailed/+server.ts
routes/api/v1/feeds/count/unreads/+server.ts
routes/api/v1/feeds/register/favorite/+server.ts
routes/api/v1/articles/content/+server.ts
routes/api/v1/articles/archive/+server.ts
routes/api/v1/rss-feed-link/list/+server.ts
routes/api/v1/rss-feed-link/register/+server.ts
routes/api/v1/rss-feed-link/[id]/+server.ts
```

### Feature Flag設計

```typescript
// src/lib/features/flags.ts
export type FeatureFlag =
  | "use_connect_feeds"
  | "use_connect_articles"
  | "use_connect_rss";

// 優先順位: localStorage > 環境変数 > デフォルト値
export function isFeatureEnabled(flag: FeatureFlag): boolean;
```

### 関連ADR

- ADR-000030: Connect-RPC Phase 2-3（Feed List / Search）
- ADR-000032: Connect-RPC Phase 4-6（Articles / RSS / Streaming）
