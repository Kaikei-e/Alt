# pre-processor ログノイズ削減とバグ修正

## ADR ステータス

承認済み — 2026-02-28

## 背景

pre-processor コンテナのログを定量分析した結果、以下の問題が判明した。

**ログノイズ:**

| 問題 | 影響 |
|------|------|
| ヘルスチェック (`/api/v1/health`) が全リクエストログに出力される | INFO ログの約 51.8% を占有 |
| 空キューポーリング (`count=0`) が 10 秒間隔で INFO 出力 | 22 分間で約 130 行のノイズ |
| "quality check completed" / "summarization completed" が Handler 層と Service 層で二重出力 | 各バッチにつき同一内容のログが 2 行ずつ |
| テキスト抽出でサイズが増加した場合に reduction_ratio が負の値で表示 | ログの可読性低下 |

**バグ:**

| 問題 | 影響 |
|------|------|
| スコアパーサーの正規表現が閉じタグ `</score>` を必須としているが、Ollama の stop シーケンスにより閉じタグが出力されない | プライマリ正規表現が常に不一致、毎回フォールバックパーサーが使用される |
| バッチ要約パスにタイムアウト記事の失敗トラッキングがない | 大容量記事がタイムアウト → カーソルリセット → 再取得の無限リトライループ |

## 意思決定

7 つの修正を優先度順に実施した。

### Fix 1: ヘルスチェックログの除外

Echo `RequestLoggerWithConfig` に `Skipper` を追加し、`/health` および `/api/v1/health` パスをリクエストログから除外した。カスタム `LoggingMiddleware` には既にスキップ処理があったが、Echo 組み込みの RequestLogger は別ミドルウェアのため影響していなかった。

| ファイル | 変更内容 |
|----------|---------|
| `bootstrap/server.go` | `Skipper` 関数を追加 |

### Fix 2: 空キューポーリングのログレベル変更

`GetPendingJobs` で取得件数が 0 の場合、ログレベルを INFO から DEBUG に変更した。件数が 1 以上の場合は従来通り INFO で出力する。

| ファイル | 変更内容 |
|----------|---------|
| `repository/summarize_job_repository.go` | `count=0` 時のログレベルを DEBUG に変更 |

### Fix 3: スコアパーサーの正規表現修正

Ollama の `stop` シーケンスに `</score>` が含まれているため、モデルは閉じタグを出力する前に生成を停止する。応答は常に `<score>9` のような形式となり、`<score>(\d+)</score>` がマッチしない。閉じタグをオプション（`(?:</score>)?`）に変更した。

| ファイル | 変更内容 |
|----------|---------|
| `quality-checker/quality_judger.go` | 正規表現を `<score>(\d+)(?:</score>)?` に変更 |
| `quality-checker/quality_judger_test.go` | 閉じタグなしケースのテスト追加 |

### Fix 4 & 5: 二重ログ出力の修正

Handler 層 (`job_handler.go`) と Service 層 (`quality_checker.go`, `article_summarizer.go`) がそれぞれ同一内容のバッチ完了ログを出力していた。Service 層を権威的ソースとし、Handler 層のログ出力を削除した。Handler 層はカーソルリセットのみを担当する。

| ファイル | 変更内容 |
|----------|---------|
| `handler/job_handler.go` | `processSummarizationBatch` と `processQualityCheckBatch` からバッチ完了ログを削除 |

### Fix 6: タイムアウト記事の無限リトライ防止

バッチ要約パスにインメモリ失敗トラッカーを追加した。キューワーカーパスには `max_retries=3` の仕組みが DB レベルで存在するが、バッチパスにはなかった。

- `articleSummarizerService` 構造体に `failureTracker` フィールドを追加
- 記事ごとの失敗回数と最終失敗時刻を記録
- 閾値: 3 回失敗で 1 時間ブロックリスト入り
- ブロック期間経過後に自動解除

| ファイル | 変更内容 |
|----------|---------|
| `service/article_summarizer.go` | `articleFailure` 型、`isBlocked` / `recordFailure` メソッド追加。`SummarizeArticles` ループ内でブロックチェック |
| `service/article_summarizer_test.go` | 3 回失敗後のスキップテスト追加 |

### Fix 7: テキスト抽出のサイズ増加ログ改善

HTML エンティティの UTF-8 デコードやプレーンテキストコンテンツの場合に `reduction_ratio` が負の値になるケースに対応した。負の場合は専用のログメッセージ（`size_increase_ratio`）を出力するよう分岐を追加した。同期・ストリーミング両パスに適用。

| ファイル | 変更内容 |
|----------|---------|
| `driver/summarizer_api.go` | `ArticleSummarizerAPIClient` と `StreamArticleSummarizerAPIClient` 両方に負の ratio 分岐を追加 |

### 変更対象ファイル一覧

| ファイル | Fix |
|----------|-----|
| `pre-processor/app/bootstrap/server.go` | Fix 1 |
| `pre-processor/app/repository/summarize_job_repository.go` | Fix 2 |
| `pre-processor/app/quality-checker/quality_judger.go` | Fix 3 |
| `pre-processor/app/quality-checker/quality_judger_test.go` | Fix 3 |
| `pre-processor/app/handler/job_handler.go` | Fix 4, 5 |
| `pre-processor/app/service/article_summarizer.go` | Fix 6 |
| `pre-processor/app/service/article_summarizer_test.go` | Fix 6 |
| `pre-processor/app/driver/summarizer_api.go` | Fix 7 |

### 検証結果

| 検証項目 | 結果 |
|----------|------|
| `go test ./...` | 全パッケージ PASS |
| コンテナ再ビルド・起動 | 正常起動、マイグレーション適用済み |
| ヘルスチェック `/api/v1/health` | レスポンス正常、ログ出力なし |

## 結果・影響

### 利点

- ヘルスチェックログ除外により INFO ログ量が約 50% 削減される
- 空キューポーリングが DEBUG レベルに移行し、通常運用時のノイズが大幅に減少する
- スコアパーサーが Ollama の実際の出力形式に一致し、フォールバックパーサーへの不要な遷移がなくなる
- バッチ完了ログが各バッチにつき 1 行（Service 層のみ）に統一される
- タイムアウトする大容量記事が 3 回失敗後に 1 時間ブロックされ、無限リトライループが解消される
- テキスト抽出ログがサイズ増加ケースを正確に表現する

### 欠点・トレードオフ

- 失敗トラッカーはインメモリのため、コンテナ再起動でリセットされる。永続化が必要な場合は DB ベースのトラッキングへの移行を検討する
- ブロック期間（1 時間）はハードコードされている。運用状況に応じて設定可能にすることを将来検討する

## 付録

- Clean Architecture のログ出力ルール: 同一イベントのログは最も近いレイヤー（Service 層）で出力し、上位レイヤー（Handler 層）では重複させない
- Ollama の `stop` シーケンスはトークン生成を即座に停止するため、stop に含まれる文字列自体はレスポンスに含まれない
- `failureBlockDuration` (1 時間) は、要約 API のタイムアウト (10 分) × 3 回リトライ = 30 分の倍数として設定。バッチジョブ間隔 (5 分) に対して十分な冷却期間を確保する
