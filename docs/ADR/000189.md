# altctl: Docker Compose 実行時の .env 読み込み不具合修正

## ADR's STATUS

Accepted (実装完了)

## CONTEXT

### 問題 (Issue #133)

第三者が `altctl up` を実行した際、`.env` の変数が Docker Compose に渡されず、全サービスが空の DB 設定で起動する問題が報告された。

### 根本原因

`altctl` は Docker Compose を呼び出す際、compose ファイルを **絶対パスの `-f` フラグ** で渡している:

```
docker compose -f /path/to/Alt/compose/base.yaml -f /path/to/Alt/compose/core.yaml up -d
```

Docker Compose V2 は `-f` が指定された場合、**最初の `-f` ファイルの親ディレクトリ** をプロジェクトディレクトリとして使う。そのため:

- プロジェクトディレクトリ = `compose/`
- `.env` の検索先 = `compose/.env` (存在しない)
- 実際の `.env` = プロジェクトルート直下

結果として `${POSTGRES_DB}`, `${DB_HOST}` 等の変数展開がすべて空文字列になり、サービスが正常に起動しない。

### 開発者環境で再現しなかった理由

`compose/.env -> ../.env` のシンボリックリンクがローカルで作成されていたが:

1. `.gitignore` に含まれており、clone した環境には存在しない
2. Windows + WSL ではシンボリックリンクが正常に動作しない場合がある

## DECISION MAKING

### 修正方針

`--env-file` フラグでプロジェクトルートの `.env` を明示的に指定する。

Docker Compose の `--env-file` は compose ファイル中の `${VAR}` 変数展開に使われるフラグであり、compose ファイル内の `env_file:` ディレクティブ (コンテナ内の環境変数用) とは独立して機能する。

### 修正内容: `altctl/internal/compose/client.go`

`buildFileArgs` メソッドに `--env-file` の付与ロジックを追加:

```go
func (c *Client) buildFileArgs(files []string) []string {
    var args []string

    envFile := filepath.Join(c.projectDir, ".env")
    if _, err := os.Stat(envFile); err == nil {
        args = append(args, "--env-file", envFile)
    }

    for _, file := range files {
        if !filepath.IsAbs(file) {
            file = filepath.Join(c.composeDir, file)
        }
        args = append(args, "-f", file)
    }
    return args
}
```

- `os.Stat` で `.env` の存在チェックを行い、ない場合は Docker Compose のデフォルト検索にフォールバック
- `--env-file` は `-f` フラグよりも前に配置

### 影響範囲

`buildFileArgs` は `Up`, `Down`, `Build`, `PS`, `Config` の全コマンドで使われるため、すべてのサブコマンドで一貫して `.env` が読み込まれる。

## RESULTS, EFFECTS

### 変更ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `altctl/internal/compose/client.go` | `import` に `"os"` 追加、`buildFileArgs` に `--env-file` ロジック追加 |
| `altctl/internal/compose/client_test.go` | **新規**: `buildFileArgs` のユニットテスト 3 件 |

### テスト

| テスト名 | 検証内容 |
|----------|----------|
| `TestBuildFileArgs_WithEnvFile` | `.env` 存在時に `--env-file` が `-f` より前に付与されること |
| `TestBuildFileArgs_WithoutEnvFile` | `.env` 不在時は `--env-file` が付与されないこと |
| `TestBuildFileArgs_EmptyFiles` | compose ファイル指定なしでも `--env-file` が正しく付与されること |

### 動作確認

```
$ ./altctl up db --dry-run
[dry-run] docker compose --env-file /path/to/Alt/.env -f /path/to/Alt/compose/base.yaml -f /path/to/Alt/compose/db.yaml up -d --timeout 300
```

- `go test ./...`: 全パッケージ通過
- `altctl up db`: WARN なし、全コンテナ正常起動
- ヘルスチェック正常

### PROS

1. **clone 直後から動作**: シンボリックリンクや手動設定なしで `.env` が読み込まれる
2. **クロスプラットフォーム対応**: Windows + WSL 環境でもシンボリックリンクに依存しない
3. **フォールバック**: `.env` が存在しない場合は Docker Compose のデフォルト動作を維持
4. **全コマンド一貫**: `up`, `down`, `build`, `ps`, `config` すべてで同じ挙動

### CONS, TRADEOFF

1. **明示的指定の優先**: `--env-file` を指定すると Docker Compose のデフォルト `.env` 検索が無効化されるが、そもそもデフォルト検索が `compose/` ディレクトリを見てしまうのが問題の原因であるため、実質的にデメリットはない

## APPENDIX

### Docker Compose V2 の `.env` 解決順序

| 条件 | `.env` の検索先 |
|------|----------------|
| `-f` なし | カレントディレクトリ |
| `-f path/to/file.yaml` あり | 最初の `-f` ファイルの親ディレクトリ |
| `--env-file path/.env` あり | 指定されたパス (最優先) |

### 関連

- Issue #133: altctl up で .env が読み込まれない
- ADR-000187: alt-backend 基盤品質・ジョブシステム・パフォーマンス改善
