# ADR-000241: Shared Database アンチパターンの解消 — alt-backend を唯一のデータオーナーに

## STATUS

Accepted（実装完了）

## CONTEXT

alt-db (PostgreSQL) に対して複数のサービスが直接接続する「Shared Database」アンチパターンが存在していた。

### 問題の構造

```
alt-db (PostgreSQL)
  ← alt-backend      (オーナー: articles, feeds, users, tags, ...)
  ← search-indexer    (直接 READ: articles, feeds)
  ← tag-generator     (直接 READ/WRITE: articles, feed_tags, article_tags)
  ← pre-processor     (直接 READ/WRITE: articles, feeds, article_summaries)
  ← pre-processor-sidecar (自身のテーブル: inoreader_subscriptions 等)
```

### 問題点

1. **スキーマ変更の連鎖影響** — alt-backend のテーブル変更が他サービスのクエリを破壊しうる
2. **責務の曖昧さ** — データの整合性を誰が保証するのか不明確
3. **スケーリングの制約** — 全サービスが単一 DB に依存し、コネクション数がボトルネック
4. **テストの複雑化** — 各サービスのテストに実 DB が必要

### 対象外

- **pre-processor-sidecar**: 調査の結果、自身のテーブル (`inoreader_subscriptions`, `inoreader_articles`, `sync_state`) のみ使用しており、alt-backend 管理テーブルへの直接アクセスなし。Shared Database アンチパターンに該当しないため対象外。

## DECISION MAKING

### 方針

**alt-backend を唯一のデータオーナーとし、他サービスは Connect-RPC (Internal API) 経由でデータにアクセスする。**

### Connect-RPC を選択した理由

| 選択肢 | 評価 |
|--------|------|
| REST API | シンプルだが型安全性が低い |
| gRPC | HTTP/2 必須、ロードバランサ設定が複雑 |
| **Connect-RPC** | HTTP/1.1 + JSON 互換、既存 Echo サーバーに共存可能、Proto 定義で型安全 |
| メッセージキュー | 非同期のみ。同期 READ 操作には不向き |

Connect-RPC は alt-backend で既に公開 API に採用済みで、チームに知見がある点も決め手となった。

### 段階的移行戦略

サービスごとに Phase を分け、各 Phase で「API モード」と「Legacy DB モード」を環境変数で切り替え可能にした。移行確認後に Legacy パスを削除する。

| Phase | サービス | 言語 | DB 操作 |
|-------|---------|------|---------|
| 0 | (Proto 定義 + alt-backend handler stub) | Go | — |
| 1 | search-indexer | Go | READ only |
| 2 | pre-processor | Go | READ + WRITE |
| 3 | tag-generator | Python | READ + WRITE |
| 4 | クリーンアップ | — | DB ユーザー削除 |

## RESULTS

### Phase 0: Internal API 基盤

Proto 定義 (`proto/services/backend/v1/backend_internal.proto`) に 14 RPC を定義。

```protobuf
service BackendInternalService {
  // Phase 1: search-indexer 用
  rpc GetArticle(GetArticleRequest) returns (GetArticleResponse);
  rpc ListArticles(ListArticlesRequest) returns (ListArticlesResponse);
  rpc GetFeed(GetFeedRequest) returns (GetFeedResponse);
  rpc ListFeeds(ListFeedsRequest) returns (ListFeedsResponse);
  rpc GetArticleSummary(GetArticleSummaryRequest) returns (GetArticleSummaryResponse);

  // Phase 2: pre-processor 用
  rpc CheckArticleExists(CheckArticleExistsRequest) returns (CheckArticleExistsResponse);
  rpc CreateArticle(CreateArticleRequest) returns (CreateArticleResponse);
  rpc SaveArticleSummary(SaveArticleSummaryRequest) returns (SaveArticleSummaryResponse);
  rpc GetArticleContent(GetArticleContentRequest) returns (GetArticleContentResponse);
  rpc GetFeedID(GetFeedIDRequest) returns (GetFeedIDResponse);
  rpc ListFeedURLs(ListFeedURLsRequest) returns (ListFeedURLsResponse);

  // Phase 3: tag-generator 用
  rpc UpsertArticleTags(UpsertArticleTagsRequest) returns (UpsertArticleTagsResponse);
  rpc BatchUpsertArticleTags(BatchUpsertArticleTagsRequest) returns (BatchUpsertArticleTagsResponse);
  rpc ListUntaggedArticles(ListUntaggedArticlesRequest) returns (ListUntaggedArticlesResponse);
}
```

alt-backend 側のアーキテクチャ:

```
Handler (connect/v2/internal/handler.go)
  → Port interface (port/internal_*_port/)
    → Gateway (gateway/internal_article_gateway/)
      → Driver (driver/alt_db/*_driver.go)
```

HandlerOption パターン (`WithPhase2Ports`, `WithPhase3Ports`) で、Phase ごとに Port を段階的に注入。

### Phase 1: search-indexer の DB 依存排除

| 変更 | 内容 |
|------|------|
| `search-indexer/app/driver/backend_api/` | Connect-RPC クライアント (Go) |
| `search-indexer/app/bootstrap/drivers.go` | `BACKEND_API_URL` による API/DB モード切替 |
| `search-indexer/app/consumer/event_handler.go` | Fat Events 対応（イベントペイロードに記事データ含有） |
| `compose/workers.yaml` | `BACKEND_API_URL` 追加、DB 環境変数削除 |

### Phase 2: pre-processor の DB 依存排除

alt-backend のテーブル（articles, feeds, article_summaries）への直接アクセスを API 経由に変更。pre-processor 自身の job queue テーブルは引き続き DB 接続を維持。

| 変更 | 内容 |
|------|------|
| `alt-backend/app/driver/alt_db/check_article_exists_driver.go` | 新規 Driver |
| `alt-backend/app/driver/alt_db/create_article_driver.go` | 新規 Driver |
| `alt-backend/app/driver/alt_db/get_article_content_driver.go` | 新規 Driver |
| `alt-backend/app/driver/alt_db/list_feed_urls_driver.go` | 新規 Driver (カーソルベースページネーション) |
| `alt-backend/app/port/internal_feed_port/port.go` | Feed 操作の Port interface |
| `alt-backend/app/gateway/internal_article_gateway/gateway.go` | Phase 2 Gateway メソッド追加 |
| `alt-backend/app/connect/v2/internal/handler.go` | Phase 2 RPC 実装 |
| `pre-processor/app/driver/backend_api/client.go` | Connect-RPC クライアント基盤 |
| `pre-processor/app/driver/backend_api/article_driver.go` | ArticleRepository (API) |
| `pre-processor/app/driver/backend_api/feed_driver.go` | FeedRepository (API) |
| `pre-processor/app/driver/backend_api/summary_driver.go` | SummaryRepository (API) |
| `pre-processor/app/bootstrap/wire.go` | API/DB モード切替 + `readSecret()` ヘルパー |
| `compose/ai.yaml` | `BACKEND_API_URL` + `SERVICE_TOKEN_FILE` 追加 |

### Phase 3: tag-generator の DB 依存排除

Python サービスのため、Connect-RPC を `httpx` HTTP クライアントで直接呼び出す（Connect protocol は HTTP/1.1 + JSON で動作）。

| 変更 | 内容 |
|------|------|
| `alt-backend/app/driver/alt_db/upsert_article_tags_driver.go` | 新規 Driver (トランザクション内で feed_tags + article_tags upsert) |
| `alt-backend/app/driver/alt_db/list_untagged_articles_driver.go` | 新規 Driver |
| `alt-backend/app/port/internal_tag_port/port.go` | Tag 操作の Port interface |
| `alt-backend/app/gateway/internal_article_gateway/gateway.go` | Phase 3 Gateway メソッド追加 |
| `alt-backend/app/connect/v2/internal/handler.go` | Phase 3 RPC 実装 |
| `tag-generator/app/tag_generator/driver/backend_api_client.py` | Connect protocol HTTP クライアント (`httpx`) |
| `tag-generator/app/tag_generator/driver/backend_api_article_fetcher.py` | ArticleFetcherPort (API) |
| `tag-generator/app/tag_generator/driver/backend_api_tag_inserter.py` | TagInserterPort (API) |
| `tag-generator/app/tag_generator/service.py` | API/DB モード自動検出 + `_NullDatabaseManager` |
| `tag-generator/app/pyproject.toml` | `httpx` 依存追加 |
| `compose/workers.yaml` | DB 環境変数削除、`BACKEND_API_URL` 追加 |

### Phase 4: クリーンアップ

| 変更 | 内容 |
|------|------|
| `compose/db.yaml` | `SEARCH_INDEXER_DB_USER/PASSWORD`, `DB_TAG_GENERATOR_USER/PASSWORD` 環境変数削除 |
| `compose/db.yaml` | 対応する secrets 定義削除 |

### 移行後のアーキテクチャ

```
alt-db (PostgreSQL)
  ← alt-backend          (唯一のオーナー)
  ← pre-processor         (自身の job queue テーブルのみ)
  ← pre-processor-sidecar (自身のテーブルのみ)

alt-backend (Connect-RPC Internal API :9101)
  ← search-indexer    (API 経由 + Redis Streams Fat Events)
  ← tag-generator     (API 経由: httpx)
  ← pre-processor     (API 経由: Connect-RPC Go client)
```

### 認証方式

サービス間通信には共有シークレット方式を採用:

- Docker Secrets で `service_secret` を各サービスに配布
- `X-Service-Token` ヘッダーで認証
- alt-backend の `service_auth_interceptor` ミドルウェアで検証

### 動作確認結果

全サービスが API モードで正常に起動・動作することを確認:

```
search-indexer:  "Using backend API driver" url=http://alt-backend:9101
tag-generator:   "Using backend API mode for article/tag operations"
pre-processor:   "Using backend API driver for article/feed/summary repos" url=http://alt-backend:9101
```

## PROS

1. **データオーナーシップの明確化** — alt-backend がスキーマとデータ整合性を一元管理
2. **スキーマ変更の影響範囲縮小** — テーブル変更は alt-backend の Internal API の後方互換性のみ保証すればよい
3. **DB コネクション数の削減** — 3 サービス分の DB 接続が不要に
4. **段階的移行** — 環境変数による API/DB モード切替で、サービスごとにロールバック可能
5. **Clean Architecture の恩恵** — Port interface が同一のため、Gateway/Driver 層のみの差替えで移行完了
6. **言語非依存** — Connect protocol (HTTP/1.1 + JSON) により、Go (search-indexer, pre-processor) と Python (tag-generator) の両方から利用可能

## CONS, TRADEOFF

1. **レイテンシ増加** — DB 直接アクセスに比べて RPC 往復のオーバーヘッドが追加される。バッチ API (`BatchUpsertArticleTags`, `ListArticles`) で緩和
2. **alt-backend の SPOF 化** — 全サービスが alt-backend に依存するため、alt-backend 障害時の影響が拡大する。ヘルスチェックと再起動ポリシーで対応
3. **pre-processor の部分的 DB 依存残存** — job queue テーブルは引き続き DB 接続が必要。完全な分離には専用 DB または別途 API 化が必要
4. **Internal API の保守コスト** — 14 RPC の Proto 定義・Handler・Driver の保守が必要

## APPENDIX

### 環境変数による API モード切替

各サービスは `BACKEND_API_URL` 環境変数の有無で動作モードを自動判定する:

```
BACKEND_API_URL=http://alt-backend:9101  → API モード
(未設定)                                  → Legacy DB モード
```

### Connect protocol の HTTP 呼び出し (Python)

Python サービス (tag-generator) では Proto コード生成を使わず、Connect protocol の JSON エンコーディングを `httpx` で直接呼び出す:

```
POST /services.backend.v1.BackendInternalService/UpsertArticleTags
Content-Type: application/json
X-Service-Token: <shared-secret>

{"articleId": "...", "feedId": "...", "tags": [{"name": "...", "confidence": 0.8}]}
```

### HandlerOption パターン

alt-backend の Internal API Handler は機能オプションパターンで Phase ごとに Port を注入する:

```go
internalHandler := internalhandler.NewHandler(
    gw, gw, gw, gw, gw,       // Phase 1 Ports
    logger,
    internalhandler.WithPhase2Ports(gw, gw, gw, gw, gw, gw),
    internalhandler.WithPhase3Ports(gw, gw, gw),
)
```
