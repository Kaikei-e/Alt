# ADR-000262: Swipe モード向け Filter & Sort Bottom Sheet

## ステータス

承認済み

## コンテキスト

### 背景

Swipe モード (`/(app)/feeds/swipe`) にはフィード一覧のフィルタリング機能が存在しなかった。通常の Feeds ページには ADR-000261 で `MobileFeedExcludeFilter` (Filter Chip + Bottom Sheet) が実装済みだが、Swipe モードは独立した `SwipeFeedScreen` コンポーネントで構成されており、フィルタ UI が接続されていなかった。

多数のソースを購読しているユーザーが、Swipe ブラウジング中に特定ソースを一時除外したいニーズに対応する。

### 前提条件

- Connect-RPC API の `excludeFeedLinkId` パラメータは ADR-000256 で実装済み
- `getFeedsWithCursorClient()` は既に第 3 引数として `excludeFeedLinkId` を受け付ける
- `filterSources()` / `extractDomain()` は ADR-000261 で `feed-source-filter.ts` に共有ユーティリティとして抽出済み
- バックエンド変更は不要。フロントエンドの Swipe モード UI 追加のみ

## 意思決定

### UX パターン: Fixed Trigger Button + Modal Bottom Sheet

Swipe モードは全画面カード UI のため、通常の Feeds ページで使用している inline Filter Chip パターンは適用できない。NN/G のモバイル UX リサーチおよび Material Design 3 のガイドラインに基づき、**Fixed Trigger Button + Modal Bottom Sheet** パターンを採用した。

| 選択 | 不採用案 | 理由 |
|------|---------|------|
| Fixed trigger button (左下) | ヘッダーバー内配置 | Swipe モードにはヘッダーがない。FloatingMenu (右下) とのミラー配置で thumb zone 内に収まる |
| Modal bottom sheet | Fullscreen dialog | フィルタ適用は短いタスク。70vh 制限で背景コンテキストを維持 |
| Sort + Filter 統合シート | タブ分離 | フィルタ項目が少ない (Sort 2 択 + Exclude 1 件) ため、1 シートに統合が最適 |
| Sort の "Oldest first" は disabled | Sort 全機能実装 | バックエンド API が `ORDER BY created_at DESC` ハードコード。UI は先行実装し、バックエンド対応は別 PR で行う |

### トリガーボタンのデザイン

FloatingMenu (右下) と対称に左下に配置。同一の glass morphism スタイル (`h-12 w-12 rounded-full border-2 backdrop-blur-md`) を適用。

- アイコン: `SlidersHorizontal` (lucide)
- フィルタ active 時: 右上にドットバッジ (`bg-[var(--alt-primary)]`)
- `aria-label="Filter and sort"` でアクセシビリティ対応

### Bottom Sheet の構成

1. **Sort セクション**: "Newest first" (active, 選択時チェックマーク) / "Oldest first" (disabled + "Coming soon")
2. **Exclude Source セクション**: 検索入力 (Search アイコン付き) + スクロール可能なソースリスト、または active 除外チップ (Ban アイコン + ドメイン + X)
3. **Close ボタン**: swipe-down に頼らないアクセシビリティ対応

### SwipeFeedScreen への統合

`SwipeFeedScreen.svelte` に以下の state を追加:

```typescript
let excludedSourceId = $state<string | null>(null);
let feedSources = $state<ConnectFeedSource[]>([]);
let sortOrder = $state<"newest" | "oldest">("newest");
```

- `onMount` で `listSubscriptionsClient()` を呼び出し、フィードソース一覧をロード
- `getFeedsWithCursorClient()` の 2 箇所の呼び出しに `excludedSourceId` を透過的に渡す
- `resetAndReload()` で feeds / activeIndex / cursor をリセットし、`loadMore()` を再実行

## 結果・影響

### 変更ファイル一覧

**新規作成:**

| ファイル | 目的 |
|---------|------|
| `.../swipe/SwipeFilterSortSheet.svelte` | Swipe モード用フィルタ・ソート Bottom Sheet コンポーネント |
| `.../swipe/SwipeFilterSortSheet.spec.ts` | データフィルタ・ソートロジックテスト (16 cases) |

**変更:**

| ファイル | 変更内容 |
|---------|---------|
| `.../swipe/SwipeFeedScreen.svelte` | `excludedSourceId` / `feedSources` / `sortOrder` state 追加、`listSubscriptionsClient` で onMount ソースロード、`getFeedsWithCursorClient` に excludedSourceId 透過、`resetAndReload` ハンドラ、`SwipeFilterSortSheet` テンプレート統合 |

### 再利用した既存コード

| モジュール | 用途 |
|-----------|------|
| `$lib/utils/feed-source-filter.ts` | `filterSources()`, `extractDomain()` |
| `$lib/components/ui/sheet/*` | Bottom Sheet UI コンポーネント一式 |
| `$lib/api/client` → `listSubscriptionsClient` | フィードソース一覧取得 |
| `$lib/api/client` → `getFeedsWithCursorClient` | 既存の `excludeFeedLinkId` 第 3 引数 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `bun test` (SwipeFilterSortSheet.spec.ts) | 16 テスト全パス |
| `bun run check` (svelte-check) | 0 エラー、0 警告 |
| コンテナ再ビルド (`alt-frontend-sv`) | ビルド成功 |
| コンテナ起動 | `healthy` ステータス確認 |
| ヘルスチェック (`/api/health`) | HTTP 200 |

### PROS

- Swipe モードでもソース除外フィルタが利用可能になり、多ソース購読時の Swipe 体験が向上
- FloatingMenu とのミラー配置による直感的な thumb zone 操作
- 既存の共有ユーティリティ (`feed-source-filter.ts`) と API クライアントをそのまま再利用。新規ロジック追加は最小限
- Sort UI を先行実装することで、バックエンド対応後に即座に有効化可能
- 44px+ タッチターゲット、`aria-label`、Close ボタンによるアクセシビリティ対応

### CONS, TRADEOFF

- Sort の "Oldest first" は現時点で disabled。バックエンドの `ORDER BY` 拡張が別 PR で必要
- v1 は ADR-000261 と同様に単一ソース除外のみ。複数ソース除外は将来の拡張
- フィードソース一覧は `onMount` で全件取得。ソース数が大幅に増加した場合は遅延ロードの検討が必要
- Fixed trigger button が画面左下に常駐するため、コンテンツ領域を若干圧迫する

### 影響範囲

- **alt-frontend-sv**: Swipe モード (`/(app)/feeds/swipe`) に UI 追加。通常の Feeds ページ・デスクトップビューは影響なし
- **alt-backend**: 変更なし
- **他サービス**: 変更なし

## 関連 ADR

- ADR-000256: フィードソース除外フィルタ (Connect-RPC API + デスクトップ UI)
- ADR-000258: フィードソース除外フィルタの (app)/feeds ページへの移植
- ADR-000260: フィード除外フィルタ — excludeClause ヘルパー関数への DRY リファクタリング
- ADR-000261: モバイル向けフィードソース除外フィルタ (Filter Chip + Bottom Sheet)
