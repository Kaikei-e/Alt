# Dispatch ステージ進捗表示の total_genres 修正

## ADR's STATUS

Accepted

## CONTEXT

### 背景

Recap Job Status ページの Dispatch ステージ進捗表示において、以下の問題があった:

- 進捗が "69/30" のように表示される
- 分子（69）は実際の処理ユニット数（サブジャンル含む）
- 分母（30）は設定ファイルのベースジャンル数（固定値）

### 原因

`dashboard.rs` で `total_genres` を設定ファイルから取得していた:

```rust
let total_genres = config.recap_genres().len();  // = 30 (固定)
```

しかし、K-means クラスタリングによるサブジャンル分割が発生すると、実際の処理ユニット数は増加する:

- 例: `software_dev` → `software_dev_001`, `software_dev_002`, ...
- 各サブジャンルは `recap_subworker_runs` テーブルに個別に記録される
- `succeeded_count` は実際の DB 行数をカウントするため、30 を超える

## DECISION MAKING

### 決定

`genre_progress.len()` を使用して、実際の処理ユニット数を total として表示する。

### 技術的詳細

**ヘルパー関数の追加**

```rust
/// Calculate total genres for sub-stage progress.
/// Uses actual genre progress count when available (includes subgenres),
/// falls back to config count during evidence stage when no progress yet.
pub(crate) fn calculate_total_genres(
    genre_progress_len: usize,
    config_genres_len: usize
) -> usize {
    if genre_progress_len == 0 {
        config_genres_len
    } else {
        genre_progress_len
    }
}
```

**build_active_job_info での使用**

```rust
let total_genres = calculate_total_genres(
    genre_progress.len(),
    config.recap_genres().len()
);
```

### 設計判断の理由

1. **Evidence ステージ対応**: Evidence 実行中は `genre_progress` が空のため、設定値にフォールバック
2. **テスト容易性**: 純粋関数として抽出し、ユニットテストを容易に
3. **後方互換性**: API レスポンス構造の変更なし

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 種別 | 内容 |
|----------|------|------|
| `recap-worker/src/api/dashboard.rs` | 変更 | `calculate_total_genres()` 関数追加、`total_genres` 計算ロジック修正 |

### UI 表示変更

**Before**:
```
[◉ Dispatch (69/30)]
```

**After**:
```
[◉ Dispatch (45/69)]  # 一部完了時
[◉ Dispatch (69/69)]  # 全完了時
```

### PROS

1. **正確な進捗表示**: 分母と分子が同じ基準（実際の処理ユニット数）で計算される
2. **直感的な UI**: ユーザーが進捗を正確に把握可能
3. **テスト済み**: ユニットテストで動作を保証

### CONS, TRADEOFF

1. **Evidence ステージ**: `genre_progress` が空の間は設定値を使用するため、サブジャンル分割後の正確な total は Dispatch 開始後まで不明

## APPENDIX

### テスト

```bash
cd recap-worker/recap-worker && cargo test dashboard
```

**追加されたテストケース**:

```rust
#[test]
fn test_calculate_total_genres_uses_genre_progress_count_when_available() {
    assert_eq!(calculate_total_genres(69, 30), 69);
    assert_eq!(calculate_total_genres(45, 30), 45);
}

#[test]
fn test_calculate_total_genres_falls_back_to_config_when_no_progress() {
    assert_eq!(calculate_total_genres(0, 30), 30);
}
```

### 関連 ADR

- ADR-117: Dispatch ステージのサブ進捗追跡改善
- ADR-118: Evidence ステージの進捗追跡と Classification フィルタリング
