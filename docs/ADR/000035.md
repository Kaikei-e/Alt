# Connect-RPC Streaming 完全移行

## ステータス

**採択・実装完了（Accepted & Implemented）** - 2025年12月31日

## コンテキスト

### 背景

ADR-000034でConnect-RPCクライアント移行が完了したが、Streamingエンドポイントは「完全移行は別途」として保留されていた。具体的には以下のエンドポイントがREST SSEのままだった：

| エンドポイント | 用途 |
|---------------|------|
| `/v1/feeds/summarize/stream` | 記事要約ストリーミング |
| `/sse/v1/rag/answer` | Augur RAGチャット |

### 課題

1. **インターフェース不一致**: REST SSEは`ReadableStreamDefaultReader`、Connect-RPCはコールバックベース
2. **二重実装**: 同一機能がREST/Connect-RPC両方に存在
3. **Augur未実装**: バックエンドにAugur用Connect-RPCハンドラが存在しなかった

## 意思決定

### 決定1: アダプターパターンによるストリーミング移行

既存コンポーネントの`createStreamingRenderer`を活かすため、Connect-RPCコールバックを橋渡しするアダプターを導入：

```typescript
// streamingAdapter.ts
export function streamSummarizeWithAbortAdapter(
  transport: Transport,
  options: StreamSummarizeAdapterOptions,
  updateState: (text: string) => void,
  rendererOptions?: StreamingRendererOptions,
  onComplete?: (result) => void,
  onError?: (error: Error) => void,
): AbortController
```

**設計判断:**
- タイプライター効果を維持（既存UXを損なわない）
- キャッシュ応答の即時レンダリング対応
- AbortControllerによるキャンセル機能

### 決定2: Augur Service新規追加

RAGチャット用のConnect-RPCサービスを新規定義：

```protobuf
// proto/alt/augur/v2/augur.proto
service AugurService {
  rpc StreamChat(StreamChatRequest) returns (stream StreamChatEvent);
  rpc RetrieveContext(RetrieveContextRequest) returns (RetrieveContextResponse);
}

message StreamChatEvent {
  string kind = 1;  // "delta", "meta", "done", "fallback", "error"
  oneof payload {
    string delta = 2;
    MetaPayload meta = 3;
    DonePayload done = 4;
    string fallback_code = 5;
    string error_message = 6;
  }
}
```

**設計判断:**
- `oneof`による型安全なイベント分岐
- `meta`イベントでCitationsをサニタイズ（ChunkText, ChunkID, Debug除去）
- 将来の非ストリーミング用途に`RetrieveContext` Unary RPCを追加

### 決定3: REST SSEフォールバック維持

**検討した代替案:**

| パターン | メリット | デメリット |
|----------|----------|------------|
| REST SSE削除 | コード簡素化 | ロールバック不可 |
| **REST SSE維持（採用）** | フォールバック可能 | 一時的に両実装共存 |

**採用理由:**
- Connect-RPCストリーミングの本番安定性が未検証
- 問題発生時にフロントエンド変更のみでREST SSEに戻せる

### 決定4: Transportモジュール分離

ブラウザコードから`$env/dynamic/private`のインポートを防ぐため、transportを分離：

```
src/lib/connect/
├── transport-client.ts  # ブラウザ用（/api/v2プロキシ経由）
├── transport-server.ts  # サーバー用（内部URL直接通信）
└── transport.ts         # 後方互換（非推奨）
```

**設計判断:**
- `index.ts`からはクライアント用のみエクスポート
- サーバーコードは`transport-server.ts`を明示的にインポート
- バンドルエラーを防ぎつつ後方互換性を維持

## 結果・効果

### PROS

1. **統一されたストリーミングAPI**
   - 全ストリーミングエンドポイントがConnect-RPC経由
   - 型安全なイベントハンドリング

2. **Augurの正式サポート**
   - Proto定義による契約明確化
   - サニタイズ処理の集約（バックエンドで一元管理）

3. **バンドル安全性**
   - クライアント/サーバーの明確な分離
   - ビルドエラーの防止

### CONS / TRADEOFF

1. **一時的な複雑性**
   - REST SSEとConnect-RPCの両実装が共存
   - 将来的にREST SSEを削除予定

2. **アダプター層の追加**
   - `streamingAdapter.ts`による間接層
   - 直接Connect-RPC利用より若干のオーバーヘッド

## 付録

### 変更ファイル一覧

| カテゴリ | ファイル |
|---------|---------|
| Proto | `proto/alt/augur/v2/augur.proto` |
| Backend | `connect/v2/augur/handler.go`, `connect/v2/server.go` |
| Frontend Client | `connect/augur.ts`, `connect/streamingAdapter.ts` |
| Frontend Transport | `connect/transport-client.ts`, `connect/transport-server.ts` |
| Components | `AugurChat.svelte`, `FeedDetailModal.svelte`, `FeedDetails.svelte`, `SwipeFeedCard.svelte` |

### 削除可能なREST SSEルート（フォールバック終了後）

```
routes/api/v1/feeds/summarize/stream/+server.ts
routes/api/v1/augur/chat/+server.ts
```

### 関連ADR

- ADR-000032: Connect-RPC Phase 4-6（Streaming文書化）
- ADR-000034: Connect-RPCクライアント移行（本ADRの前提）

