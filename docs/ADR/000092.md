# tag-generator Dockerビルド高速化

## ADR's STATUS

Accepted

## CONTEXT

tag-generatorサービスのDockerビルドが遅く、開発イテレーションに影響していた。
主な原因は以下の通り：

1. ソースコード変更時に依存関係レイヤーが無効化されていた
2. unidic辞書ダウンロード（約500MB）が毎回実行されていた
3. 依存関係インストールとプロジェクトインストールが分離されていなかった

## DECISION MAKING

uvの公式ベストプラクティスに従い、Dockerfileを最適化した。

### 1. `--no-install-project` パターンの適用

```dockerfile
# 依存関係のみを先にインストール（プロジェクト本体は除く）
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked --no-dev --no-install-project

# ソースコードをコピー
COPY app/ .

# プロジェクトをインストール（依存関係はキャッシュ済み）
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install --system -e .
```

これにより、ソースコード変更時でも依存関係レイヤーはキャッシュされる。

### 2. unidic辞書ダウンロードへのキャッシュマウント追加

```dockerfile
RUN --mount=type=cache,target=/root/.cache/unidic \
    UNIDIC_DOWNLOAD_DIR=/root/.cache/unidic python -m unidic download || \
    python -m unidic download
```

### 3. レイヤー順序の最適化

変更頻度の低い順に処理を配置：
1. pyproject.toml, uv.lock コピー
2. PyTorch（CPU版）インストール
3. ML依存関係インストール
4. unidic辞書ダウンロード
5. プロジェクト依存関係同期（`--no-install-project`）
6. ソースコードコピー
7. プロジェクトインストール
8. モデルプリロード
9. 検証

## RESULTS, EFFECTS

### PROS

- **リビルド時間の短縮**: ソースコード変更時、依存関係レイヤーがキャッシュされる
- **辞書ダウンロードの効率化**: unidic辞書がキャッシュされ、再ダウンロード不要
- **保守性向上**: Dockerfileの構造が明確になり、各ステージの役割が分かりやすい
- **uvベストプラクティス準拠**: 公式推奨パターンに従った実装

### CONS, TRADEOFF

- **初回ビルド時間は変わらない**: キャッシュが効くのは2回目以降
- **キャッシュ容量の消費**: BuildKitキャッシュがディスクを消費する

## APPENDIX

### 参考資料

- [Using uv in Docker - Astral公式](https://docs.astral.sh/uv/guides/integration/docker/)
- [Using uv with PyTorch](https://docs.astral.sh/uv/guides/integration/pytorch/)
- [Docker cache optimization](https://docs.docker.com/build/cache/optimize/)

### 変更ファイル

- `tag-generator/Dockerfile.tag-generator`
