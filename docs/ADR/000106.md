# Ollama 埋め込み API の入力長制限

## ADR'S STATUS

Accepted

## CONTEXT

### 背景

recap-subworker では Ollama の `/api/embed` エンドポイントを使用して文の埋め込みベクトルを計算している。一部のジャンル（music_audio, software_dev）で処理が失敗していた。

### 問題

1. **コンテキスト長超過**: 長いテキストを埋め込みAPIに送信すると `input length exceeds the context length` エラー
2. **エラーハンドリング不足**: 入力長の検証なしでAPIを呼び出していた
3. **ジャンル固有の失敗**: 特定ジャンルで長文記事が多く、失敗率が高い

### エラーメッセージ

```
Ollama API error: 400 - {"error":"the input length exceeds the context length"}
```

## DECISION MAKING

### 決定

埋め込みAPI呼び出し前に入力テキストを最大長で切り詰める。

#### 実装詳細

```python
class OllamaRemoteAdapter:
    # 埋め込みモデルのコンテキスト長に基づく安全な上限
    # 8K トークン × ~4 chars/token = ~32K chars
    # 安全マージンを考慮して 8K chars に設定
    MAX_INPUT_CHARS = 8000

    def _truncate_texts(self, texts: list[str]) -> list[str]:
        """長すぎるテキストを切り詰める"""
        truncated = []
        for text in texts:
            if len(text) > self.MAX_INPUT_CHARS:
                logger.debug(
                    "Truncating long text for embedding",
                    original_length=len(text),
                    truncated_length=self.MAX_INPUT_CHARS,
                )
                truncated.append(text[:self.MAX_INPUT_CHARS])
            else:
                truncated.append(text)
        return truncated

    def _get_embeddings(self, texts: list[str]) -> list[list[float]]:
        # 切り詰め処理を追加
        texts = self._truncate_texts(texts)
        # ... API呼び出し
```

#### 設計判断

| 項目 | 選定 | 理由 |
|------|------|------|
| 切り詰め位置 | API呼び出し直前 | 最小限の変更で確実にエラーを防止 |
| 最大長 | 8000 chars | 多くの埋め込みモデルの8Kトークン制限に対応 |
| 切り詰め方法 | 先頭から保持 | 記事の重要情報は冒頭に集中する傾向 |

#### 代替案の検討

| 方法 | 利点 | 欠点 |
|------|------|------|
| **先頭切り詰め（採用）** | シンプル、冒頭の重要情報を保持 | 末尾情報が欠落 |
| 文分割 + 平均埋め込み | 全文の意味を保持 | 計算コスト増、実装複雑 |
| 要約してから埋め込み | 情報圧縮 | LLM呼び出しが必要、遅延増大 |
| エラー時スキップ | 実装不要 | 対象文がクラスタリングから除外 |

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 種別 | 内容 |
|----------|------|------|
| `recap-subworker/recap_subworker/services/embedder.py` | 修正 | `_truncate_texts()` 追加、API呼び出し前に適用 |

### 効果

- Ollama API のコンテキスト長超過エラーを防止
- 失敗していたジャンル（music_audio, software_dev）が処理可能に
- 既存のクラスタリング品質への影響は最小限（8000文字は十分な長さ）

### PROS

1. **シンプル**: 最小限のコード変更
2. **安全**: API呼び出し前に確実に制限
3. **透過的**: 呼び出し側のコード変更不要
4. **ログ出力**: 切り詰め発生時にデバッグログを出力

### CONS, TRADEOFF

1. **情報欠落**: 8000文字を超える部分は埋め込みに反映されない
2. **固定値**: モデルごとの最適値ではなく保守的な固定値を使用
3. **文境界無視**: 文の途中で切り詰める可能性がある

## APPENDIX

### 埋め込みモデルのコンテキスト長

| モデル | コンテキスト長 |
|--------|---------------|
| mxbai-embed-large | 512 tokens |
| nomic-embed-text | 8192 tokens |
| all-minilm | 256 tokens |
| bge-m3 | 8192 tokens |

### 参考

- [Ollama Embedding API](https://github.com/ollama/ollama/blob/main/docs/api.md#generate-embeddings)
