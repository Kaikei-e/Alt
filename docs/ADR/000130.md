# rask-log-aggregator: otel_traces INSERT時のカラム競合エラー修正

## ADR's STATUS

Accepted

## CONTEXT

### 背景

rask-log-aggregatorからClickHouseのotel_tracesテーブルへのトレースINSERT時に以下のエラーが発生:

```
"Cannot add column Events: column with this name already exists. (ILLEGAL_COLUMN)"
```

### 根本原因

`OTelTraceRow` 構造体に以下の2種類のフィールドが共存していた:

1. **JSON文字列カラム**: `Events` (String), `Links` (String)
2. **ネスト配列カラム**: `Events.Timestamp` (Array), `Events.Name` (Array), etc.

```rust
pub struct OTelTraceRow {
    // JSON文字列 (問題の原因)
    #[serde(rename = "Events")]
    pub events: String,
    #[serde(rename = "Links")]
    pub links: String,

    // ネスト配列 (Grafana用)
    #[serde(rename = "Events.Timestamp")]
    pub events_timestamp: Vec<i64>,
    #[serde(rename = "Events.Name")]
    pub events_name: Vec<String>,
    // ...
}
```

clickhouse crateがRowBinaryフォーマットでINSERTする際、`Events` と `Events.*` の両方があると、ClickHouseが `Events` をNested型として再解釈しようとし、カラム名の競合エラーが発生。

### 影響

- トレースデータがClickHouseに保存されない
- Grafana Trace Explorerでトレースが表示されない

## DECISION MAKING

### 解決方針

JSON文字列カラム (`Events`, `Links`) を削除し、ネスト配列カラムのみを使用する。

**理由:**
1. Grafana ClickHouse datasourceはネスト配列カラム (`Events.Timestamp` 等) を使用
2. JSON文字列カラムは冗長であり、競合の原因
3. ネスト配列の方がクエリ効率が良い

### 代替案

1. **カラム名を変更** (`Events` → `EventsJson`): 既存データとの互換性問題、Grafanaクエリ修正が必要
2. **別テーブルに分離**: 複雑性が大幅に増加
3. **ClickHouseのNested型を使用**: clickhouse crateのサポートが不完全

選択した方針はGrafana互換性を維持しつつ、最小限の変更で済む。

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `rask-log-aggregator/app/src/log_exporter/clickhouse_exporter.rs` | `events`, `links` String フィールド削除 |
| `rask-log-aggregator/app/src/domain/otel_log.rs` | `OTelTrace` から `events`, `links` フィールド削除 |
| `rask-log-aggregator/app/src/otlp/converter.rs` | JSON シリアライズ処理削除 |
| `clickhouse/migrations/012_drop_events_links_string.sql` | DDLマイグレーション追加 |

### 修正後の構造体

```rust
pub struct OTelTraceRow {
    // ... 基本フィールド ...

    // ネスト配列のみ (Grafana互換)
    #[serde(rename = "Events.Timestamp")]
    pub events_timestamp: Vec<i64>,
    #[serde(rename = "Events.Name")]
    pub events_name: Vec<String>,
    #[serde(rename = "Events.Attributes")]
    pub events_attributes: Vec<Vec<(String, String)>>,
    // Links も同様
}
```

### PROS

1. **エラー解消**: カラム競合が発生しない
2. **Grafana互換性維持**: ネスト配列カラムはそのまま
3. **データ効率向上**: 冗長なJSON文字列を削除
4. **クエリ性能**: 配列カラムへの直接アクセスが可能

### CONS, TRADEOFF

1. **後方互換性**: JSON文字列を直接参照するクエリがあれば修正が必要
2. **マイグレーション**: 本番環境でDDL実行が必要

## APPENDIX

### マイグレーションSQL

```sql
-- clickhouse/migrations/012_drop_events_links_string.sql
ALTER TABLE otel_traces DROP COLUMN IF EXISTS Events;
ALTER TABLE otel_traces DROP COLUMN IF EXISTS Links;
```

### 検証方法

```bash
# 1. テスト実行
cd rask-log-aggregator/app && cargo test

# 2. コンテナビルド・再起動
docker compose -f compose/compose.yaml -p alt build rask-log-aggregator
docker compose -f compose/compose.yaml -p alt up -d rask-log-aggregator

# 3. トレースINSERT確認
docker compose logs rask-log-aggregator --tail=20 | grep -i trace

# 4. ClickHouseでデータ確認
docker compose exec clickhouse clickhouse-client \
  --database rask_logs \
  -q "SELECT count() FROM otel_traces WHERE Timestamp > now() - INTERVAL 5 MINUTE"
```

### 参考資料

- [ClickHouse Nested Data Structures](https://clickhouse.com/docs/en/sql-reference/data-types/nested-data-structures/nested)
- [clickhouse-rs RowBinary Format](https://github.com/ClickHouse/clickhouse-rs)
- [Grafana ClickHouse Plugin - Traces](https://grafana.com/docs/plugins/grafana-clickhouse-datasource/latest/)

### 関連ADR

- ADR-129: OTLP HTTP専用ポート (4318) の追加
- ADR-128: trace_id/span_id消失バグの修正
