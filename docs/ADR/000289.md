# Augur ストリーミングの "missing EndStreamResponse" エラー修正

## ADR ステータス

承認済み — 2026-02-28

## 背景

Augur（RAG チャット機能）でユーザーが質問を送信した際、`Error: [unknown] missing EndStreamResponse. Please try again.` が散発的に発生していた。

### リクエスト経路

```
Browser (Connect protocol)
  → Cloudflare Tunnel
  → nginx (proxy_buffering ON)
  → SvelteKit proxy (+server.ts)
  → alt-backend Connect handler (パススルー)
  → rag-orchestrator Connect handler
  → 外部 LLM (HTTP streaming)
```

### ログ分析

エラー発生時のタイムラインを追跡した結果、リクエスト開始からエラーまでちょうど約 30 秒であることが判明した。

| 時刻 | サービス | イベント |
|------|---------|--------|
| +0s | rag-orchestrator | `starting augur stream chat` |
| +0s | rag-orchestrator | `thinking` イベント（空文字、約 100 バイト）を送信 |
| +0s | rag-orchestrator | `progress: "searching"` イベントを送信しようとするが **handler で未処理のため破棄** |
| +3s | rag-orchestrator | `query_expansion_failed`（3s タイムアウト） |
| +30s | rag-orchestrator | `retrieval_completed`（約 30 秒） |
| +30s | alt-backend | `context canceled` エラー |

### 根本原因

**原因 1: nginx のバッファリングがストリームイベントの即時配信を阻害**

`/sv/api/` の location ブロックで `proxy_buffering on` + `proxy_buffer_size 16k` が設定されていた。Connect-RPC ストリーミングの初期イベント（`thinking` 空文字、約 100 バイト）は 16KB バッファを埋めるには小さすぎるため、nginx はバッファが十分に溜まるまでクライアントへの送信を保留する。結果として Cloudflare Tunnel が origin からのレスポンスなしと判断し、idle timeout（約 30 秒）でコネクションを切断していた。

**原因 2: progress イベントの未転送**

usecase 層は検索・生成フェーズで `StreamEventKindProgress`（"searching", "generating"）イベントを送信するが、Connect handler の `convertStreamEvent` にマッピングがなく、`unknown stream event kind` 警告を出して破棄していた。これにより `buildPrompt` 処理中の約 30 秒間、`thinking` 1 イベント以外何もクライアントに送信されない沈黙状態が発生していた。

## 意思決定

2 つの修正を実施した。

### Fix 1: nginx に Connect-RPC ストリーミング専用 location を追加

既存の `/sv/api/` location（`proxy_buffering on`）の前に、ストリーミング RPC に一致する正規表現 location を追加した。

```nginx
location ~ ^/sv/api/v2/alt\.(augur|morning_letter)\.v2\..+/Stream {
    gzip off;
    proxy_buffering off;
    proxy_cache off;
    # ...
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
}
```

| 設定 | 値 | 理由 |
|------|-----|------|
| `proxy_buffering` | off | ストリームイベントを即座にクライアントへ送信 |
| `proxy_cache` | off | キャッシュによる遅延を排除 |
| `gzip` | off | Connect-RPC は独自のエンコーディングを使用 |
| `proxy_read_timeout` | 600s | LLM 生成に最大 10 分を許容 |

正規表現パターン `^/sv/api/v2/alt\.(augur|morning_letter)\.v2\..+/Stream` は Connect-RPC の `ServerStream` メソッドの URL パスに一致する。非ストリーミング RPC（`RetrieveContext` 等）は従来通り `/sv/api/` location でバッファリングされる。

| ファイル | 変更内容 |
|----------|---------|
| `nginx/conf.d/default.conf` | ストリーミング専用 location ブロック追加 |

### Fix 2: progress イベントのハンドラーマッピング追加

rag-orchestrator の `convertStreamEvent` に `StreamEventKindProgress` case を追加した。proto の `StreamChatEvent` は `oneof payload` に `progress` フィールドを持たないため、`delta` フィールドをキャリアとして再利用し、`kind: "progress"` でイベント種別を区別する。

```go
case usecase.StreamEventKindProgress:
    progress, ok := event.Payload.(string)
    if !ok {
        return nil, true
    }
    return &augurv2.StreamChatEvent{
        Kind: "progress",
        Payload: &augurv2.StreamChatEvent_Delta{
            Delta: sanitizeUTF8(progress),
        },
    }, true
```

alt-backend の `StreamChat` はイベントをそのまま転送するパススルー実装のため変更不要。

フロントエンド (`augur.ts`) では、`event.kind === "progress"` を `payload.case` の switch 前にチェックし、`onProgress` コールバックに転送する。

| ファイル | 変更内容 |
|----------|---------|
| `rag-orchestrator/.../connect/augur/handler.go` | `StreamEventKindProgress` case 追加 |
| `rag-orchestrator/.../connect/augur/convert_stream_event_test.go` | progress イベントのテスト追加 |
| `alt-frontend-sv/src/lib/connect/augur.ts` | `onProgress` コールバック追加、`kind === "progress"` ハンドリング |

### 検証結果

| 検証項目 | 結果 |
|----------|------|
| `go test ./internal/adapter/connect/augur/...` | 全テスト PASS |
| `bun run check`（フロントエンド型チェック） | 新規エラーなし |
| `nginx -t`（設定検証） | syntax ok |
| コンテナ再ビルド・再起動 | 正常起動 |
| `unknown stream event kind` 警告 | 再起動後 0 件 |

## 結果・影響

### 利点

- `proxy_buffering off` により、ストリームイベントが nginx で保留されず即座にクライアントへ配信される。Cloudflare Tunnel の idle timeout による切断が解消される
- progress イベント（"searching", "generating"）がクライアントに到達するため、検索・生成処理中の約 30 秒間にもデータが流れ続け、コネクションが維持される
- 非ストリーミング RPC は引き続きバッファリングされるため、通常 API のパフォーマンスに影響しない
- フロントエンドで `onProgress` コールバックを利用すれば、将来的に「検索中...」「生成中...」等のステータス表示を実装できる

### 欠点・トレードオフ

- proto の `oneof payload` に `progress` 専用フィールドを追加していないため、`delta` フィールドを `kind` で区別する設計となっている。proto 変更を最小限にする判断だが、将来フィールド追加が妥当かは継続検討する
- Cloudflare Tunnel の idle timeout の正確な値は Cloudflare ダッシュボードの設定に依存する。今回の修正はイベントの即時配信により idle 状態自体を解消するアプローチであり、timeout 値の直接的な制御ではない

## 付録

- nginx の `location` ディレクティブの優先順位: 正規表現 location (`~`) は prefix location (`/sv/api/`) より先に評価されるが、定義順で最初にマッチしたものが使用される。そのため `/sv/api/` の前に配置した
- Connect-RPC の `ServerStream` メソッドは URL パスに `/MethodName` を含む。例: `/alt.augur.v2.AugurService/StreamChat`
- `proxy_buffering off` は nginx がレスポンスボディをバッファリングせず、受信次第クライアントに送信する設定。小さなイベントが多数発生するストリーミングに適する
