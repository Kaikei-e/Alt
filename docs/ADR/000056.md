# スワイプビューで404記事を既読にできない問題の修正

## ステータス

採択（Accepted）

## コンテキスト

### 問題

スワイプビューで記事をスワイプしても、リロード後に同じ記事が再度表示される問題が発生していた。

### 背景

- 外部サイトの記事が404になることは想定内（記事削除、URL変更など）
- 404記事でもユーザーは「スワイプしたら二度と表示されない」ことを期待する
- RSSフィードから取得した記事は `feeds` テーブルに存在するが、記事コンテンツの取得に失敗すると `articles` テーブルには保存されない

### 調査結果

バックエンドのログを確認したところ、以下のパターンが見られた：

```
ERROR: Failed to fetch article content: unexpected status code 404
INFO:  feed marked as read: https://example.com/article/123
```

一見、既読マークが成功しているように見えるが、フロントエンドで問題があった。

### 根本原因

**フロントエンド (`SwipeFeedScreen.svelte`)**:

```javascript
// 問題のあったコード
const canMarkAsRead = !!activeFeed.articleId;

if (canMarkAsRead) {
    await updateFeedReadStatusClient(currentLink);
} else {
    console.log("Skipping mark as read - article not in database:", currentLink);
}
```

1. 404記事は `articleId` が `null`（`articles` テーブルに保存されていない）
2. `articleId` がないと既読APIが呼ばれない
3. バックエンドは `feed_id` ベースで既読マークが可能（`articleId` は不要）
4. フィードは `feeds` テーブルに存在する（RSSから取得済み）ため、既読にできる

### バックエンドの動作

`MarkAsRead` API は `article_url` を受け取り、`feed_id` で既読をマークする：

```go
func (h *Handler) MarkAsRead(...) {
    // article_url から feed_id を検索
    if err := h.container.ArticlesReadingStatusUsecase.Execute(ctx, *articleURL); err != nil {
        if errors.Is(err, domain.ErrFeedNotFound) {
            return nil, connect.NewError(connect.CodeNotFound, ...)
        }
    }
    // feed_id ベースで既読マーク（articleId は不要）
}
```

## 決定

### 1. `articleId` チェックを削除

フロントエンドで `articleId` の有無に関わらず、常に既読APIを呼ぶ。

**Before**:
```javascript
const canMarkAsRead = !!activeFeed.articleId;
if (canMarkAsRead) {
    await updateFeedReadStatusClient(currentLink);
}
```

**After**:
```javascript
// Backend uses feed_id (not article_id), so this works even for 404 articles
try {
    await updateFeedReadStatusClient(currentLink);
} catch (err) {
    console.warn("Failed to mark as read:", currentLink, err);
}
```

### 2. UI表示の統一

**Before**:
```html
{#if feed.articleId}
  Swipe to mark as read
{:else}
  <span class="text-amber-600">⚠ Article not saved - swipe to skip</span>
{/if}
```

**After**:
```html
Swipe to mark as read
```

### 3. TDDによる実装

E2Eテストを先に作成し、RED → GREEN のサイクルで実装：

```typescript
test("swipe marks feed as read even without articleId (404 article)", async ({ page }) => {
    // articleId なしのモックデータを使用
    await page.route(CONNECT_RPC_PATHS.getUnreadFeeds, (route) =>
        fulfillJson(route, CONNECT_FEEDS_WITHOUT_ARTICLE_ID),
    );
    // 404エラーをシミュレート
    await page.route(CONNECT_RPC_PATHS.fetchArticleContent, (route) =>
        fulfillError(route, "Article not found", 404),
    );

    // markAsRead API が呼ばれることを確認
    let markAsReadCalled = false;
    await page.route(CONNECT_RPC_PATHS.markAsRead, (route) => {
        markAsReadCalled = true;
        return fulfillJson(route, CONNECT_MARK_AS_READ_RESPONSE);
    });

    // スワイプ操作
    // ...

    // 検証
    await expect.poll(() => markAsReadCalled).toBe(true);
});
```

## 結果

### メリット

1. **ユーザー体験の向上**: 404記事でもスワイプすれば二度と表示されない
2. **一貫性**: 記事の保存状態に関わらず同じ操作で同じ結果
3. **テストカバレッジ**: E2Eテストで404記事のケースをカバー

### トレードオフ

1. **エラーハンドリング**: `feed_id` が見つからない場合は404エラーが返されるが、ログに記録して処理を継続
2. **UI情報の減少**: ユーザーに「記事が保存されていない」という情報を表示しなくなった

## 実装

### 実装日: 2026-01-07

### 修正ファイル一覧

| カテゴリ | ファイル | 変更内容 |
|---------|---------|---------|
| コンポーネント | `src/lib/components/mobile/feeds/swipe/SwipeFeedScreen.svelte` | `articleId` チェック削除、常に既読APIを呼ぶ |
| コンポーネント | `src/lib/components/mobile/feeds/swipe/SwipeFeedCard.svelte` | UI表示の条件分岐削除 |
| E2Eテスト | `tests/e2e/mobile/feeds/swipe.spec.ts` | 404記事での既読マークテスト追加 |

### テスト結果

```
✓ swipe page renders swipe card and action footer
✓ swipe marks feed as read even without articleId (404 article)

4 passed (18.5s)
```

## 関連ADR

なし

## 参考

- バックエンド実装: `alt-backend/app/connect/v2/feeds/handler.go` (MarkAsRead)
