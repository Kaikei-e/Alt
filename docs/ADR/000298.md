# ADR-000298: buf lint CI をオールグリーンにする — module-level excludes と ignore_only による段階的適合

## ADR's STATUS

Accepted

## CONTEXT

`buf lint` の CI ジョブが `clients/` ディレクトリと `services/` ディレクトリ間の protobuf パッケージ名重複により失敗していた。

### 問題の構造

`proto/` 配下には以下の2種類のディレクトリが存在する:

- `services/` — サービス間通信用の内部 proto 定義（正規のソース）
- `clients/` — `buf generate` で生成されたクライアントコード用の proto コピー

両ディレクトリ内の proto ファイルが同一の protobuf パッケージ名（例: `package services.backend.v1`）を使用しているため、buf module（`path: .`）がシンボルの重複定義として検出していた。

### 暫定対処

CI ワークフローおよび Makefile で `--exclude-path clients` CLI フラグを付与し、lint・breaking チェック時に `clients/` を除外していた。

### 暫定対処の問題点

buf v2 では、恒久的なディレクトリ除外は `buf.yaml` の module 設定に `excludes` を記述するのが推奨される方法である。CLI フラグはアドホックな用途向けであり、CI と Makefile の両方で同じフラグを維持する必要があるため、設定の散在と保守コストの増加を招いていた。

## DECISION MAKING

`buf.yaml` の module 設定に `excludes` を追加し、CLI フラグによるワークアラウンドを撤去する。

```yaml
# proto/buf.yaml
version: v2
modules:
  - path: .
    name: buf.build/alt/proto
    excludes:
      - clients
```

この設定により、`buf lint` および `buf breaking` はモジュールレベルで `clients/` を自動的に除外する。`buf generate` は独自の `buf.gen.*.yaml` で入力を指定するため影響を受けない。

### 他の選択肢を採用しなかった理由

- **CLI フラグの維持（現状維持）**: 設定が CI・Makefile・開発者のローカル実行の3箇所に散在し、いずれかで漏れるとエラーが再発する
- **`clients/` を別モジュールとして定義**: `clients/` は生成コード用のコピーであり、独立したモジュールとして管理する意味がない
- **`clients/` 内の proto ファイルのパッケージ名を変更**: 生成コードとの整合性が崩れ、クライアント側のインポートパスに影響が出る

## RESULTS, EFFECTS

### PROS

- **設定の一元化**: 除外ルールが `buf.yaml` に集約され、CI・Makefile・ローカル実行のすべてで一貫して適用される
- **buf v2 の推奨パターン準拠**: `excludes` はモジュールレベルの恒久的除外として設計された機能であり、意図が明確
- **保守コストの低減**: 新しい buf コマンドの追加時にフラグの付与漏れを心配する必要がない

### CONS, TRADEOFF

- なし（既存の動作を維持したまま設定方法を正規化しただけであり、機能的な変更はない）

## APPENDIX

### 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `proto/buf.yaml` | module 設定に `excludes: [clients]` を追加 |
| `.github/workflows/proto-contract.yaml` | `--exclude-path clients` フラグを撤去 |
| `Makefile` | `buf-lint`・`buf-breaking` ターゲットから `--exclude-path clients` フラグを撤去 |

### 検証結果

`cd proto && buf lint` を実行し、duplicate symbol エラーが解消されていることを確認済み。

## Phase 2: RPC naming convention 違反の根本解決（型名リネーム）

### 問題

`excludes` の追加で duplicate symbol エラーは解消されたが、CI はまだ失敗していた。原因は既存 proto ファイルにおける RPC naming convention 違反（STANDARD ルールセット）3件:

| ルール | 対象ファイル数 | 内容 |
|--------|-------------|------|
| `RPC_RESPONSE_STANDARD_NAME` | 8 | レスポンス型名が `{RPC名}Response` の命名規約に不一致 |
| `RPC_REQUEST_STANDARD_NAME` | 4 | リクエスト型名が `{RPC名}Request` の命名規約に不一致 |
| `RPC_REQUEST_RESPONSE_UNIQUE` | 2 | 複数 RPC で同一リクエスト/レスポンス型を共有 |

### 判断

当初は `ignore_only` による暫定抑制を採用したが、根本的な解決として proto メッセージ型名を STANDARD 準拠にリネームする方針に変更した。`ignore_only` は撤去し、全 proto ファイルが STANDARD ルールを完全に満たす状態とした。

### リネーム内容

| proto ファイル | 旧名 | 新名 | RPC |
|---------------|------|------|-----|
| `alt/articles/v2/articles.proto` | `ArticleTagEvent` | `StreamArticleTagsResponse` | StreamArticleTags |
| `alt/augur/v2/augur.proto` | `StreamChatEvent` | `StreamChatResponse` | StreamChat |
| `alt/morning_letter/v2/morning_letter.proto` | `StreamChatEvent` | `StreamChatResponse` | StreamChat |
| `alt/preprocessor/v2/preprocessor.proto` | `SummarizeQueueRequest/Response` | `QueueSummarizeRequest/Response` | QueueSummarize |
| `alt/preprocessor/v2/preprocessor.proto` | `SummarizeStatusRequest/Response` | `GetSummarizeStatusRequest/Response` | GetSummarizeStatus |
| `alt/recap/v2/job_status.proto` | `JobProgressEvent` (shared) | `StreamJobProgressResponse` + `GetJobProgressResponse` | StreamJobProgress / GetJobProgress |
| `alt/tts/v1/tts.proto` | (shared `SynthesizeRequest/Response`) | 新規 `SynthesizeStreamRequest/Response` | SynthesizeStream |
| `services/mqhub/v1/mqhub.proto` | `StreamInfoRequest/Response` | `GetStreamInfoRequest/Response` | GetStreamInfo |
| `services/mqhub/v1/mqhub.proto` | `GenerateTagsRequest/Response` | `GenerateTagsForArticleRequest/Response` | GenerateTagsForArticle |

`services/preprocessor/v2` および `clients/` 配下の同等定義も同様にリネーム。

### buf.yaml（最終形）

```yaml
version: v2
modules:
  - path: .
    name: buf.build/alt/proto
    excludes:
      - clients
lint:
  use:
    - STANDARD
breaking:
  use:
    - FILE
```

`ignore_only` は不要となり撤去。

### 検証結果

`cd proto && buf lint` が exit code 0 で完了し、出力なしを確認済み。
