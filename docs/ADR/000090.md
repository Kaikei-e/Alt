# RAG 検索における Re-ranking と Hybrid Search の導入

## ステータス

採択（Accepted）

## コンテキスト

### 背景

Morning Letter 機能では RAG（Retrieval-Augmented Generation）パイプラインを使用して、最新ニュースからトピックを抽出している。既存の実装では純粋なベクトル検索のみを使用していた。

### 研究根拠

学術研究およびベストプラクティスに基づき、以下の改善が期待される：

| 手法 | 期待効果 | 出典 |
|------|---------|------|
| Cross-encoder Re-ranking | NDCG@10 +15-30% 向上 | Pinecone, ZeroEntropy |
| Hybrid Search (BM25+Vector) | 検索品質 +48% 向上 | EMNLP 2024, IBM Research |
| RRF Fusion | 堅牢なスコア融合 | Weaviate, LlamaIndex |

### 問題点

1. 純粋なベクトル検索は意味的類似性に依存し、キーワード完全一致が重要なケースで精度が低下
2. 初期検索スコアのみで上位 N 件を選択すると、関連性の低いチャンクが含まれる可能性

## 決定

### 1. Cross-encoder Re-ranking の導入

50 件の候補から Cross-encoder モデルで再スコアリングし、上位 10 件を選択する。

**モデル選定**:
- `BAAI/bge-reranker-v2-m3`: 多言語対応、568M パラメータ、約 150ms
- フォールバック: `cross-encoder/ms-marco-MiniLM-L-6-v2`（英語、高速）

### 2. Hybrid Search（BM25 + Vector）の導入

Meilisearch（BM25）と pgvector（密ベクトル検索）の結果を RRF で融合する。

**パラメータ**:
- Alpha: 0.3（EMNLP 2024 推奨、BM25 寄り）
- RRF K: 60.0（標準値）

### アーキテクチャ

```
Query
  │
  ▼
1. Query Expansion (既存)
  │
  ▼
2. Parallel Search
  ├─ Vector Search (pgvector, 50件)
  └─ BM25 Search (Meilisearch, 50件) ← NEW
  │
  ▼
3. RRF Fusion ← NEW
  │
  ▼
4. Re-ranking (Cross-encoder) ← NEW
  │
  ▼
5. Quota 適用 (5+5=10件)
  │
  ▼
6. Temporal Boost (Morning Letter)
  │
  ▼
7. LLM Generation
```

## 結果

### 変更ファイル

#### rag-orchestrator

| ファイル | 変更内容 |
|---------|---------|
| `internal/domain/reranker.go` | 新規: Reranker ポート定義 |
| `internal/domain/search_client.go` | BM25Searcher ポート追加 |
| `internal/usecase/retrieval_config.go` | RerankingConfig, HybridSearchConfig 追加 |
| `internal/usecase/retrieve_context_usecase.go` | Re-rank/Hybrid 統合、fuseHybridResults 追加 |
| `internal/adapter/rag_augur/reranker_client.go` | 新規: RerankerClient HTTP 実装 |
| `internal/adapter/rag_http/search_indexer_client.go` | SearchBM25 メソッド追加 |
| `internal/infra/config/config.go` | 環境変数追加 |
| `cmd/server/main.go` | DI 配線追加 |

#### news-creator

| ファイル | 変更内容 |
|---------|---------|
| `news_creator/domain/models.py` | RerankRequest/Response 追加 |
| `news_creator/usecase/rerank_usecase.py` | 新規: CrossEncoder 実装 |
| `news_creator/handler/rerank_handler.py` | 新規: /v1/rerank エンドポイント |
| `main.py` | ルーター登録 |
| `pyproject.toml` | sentence-transformers 依存追加 |

### 環境変数

| 変数名 | デフォルト値 | 説明 |
|--------|------------|------|
| `RERANK_ENABLED` | `true` | Re-ranking 有効化 |
| `RERANK_URL` | `http://news-creator:11434` | Reranker エンドポイント |
| `RERANK_MODEL` | `bge-reranker-v2-m3` | Cross-encoder モデル |
| `RERANK_TOP_K` | `10` | Re-rank 後の上位件数 |
| `RERANK_TIMEOUT` | `30` | タイムアウト（秒） |
| `HYBRID_SEARCH_ENABLED` | `true` | Hybrid Search 有効化 |
| `HYBRID_ALPHA` | `0.3` | BM25/Vector 重み（0.0=BM25, 1.0=Vector） |
| `HYBRID_BM25_LIMIT` | `50` | BM25 取得件数 |

### エラーハンドリング

| シナリオ | 動作 |
|---------|------|
| Re-ranker タイムアウト | 警告ログ、元スコアで継続 |
| Re-ranker 5xx | エラーログ、元スコアで継続 |
| BM25 検索失敗 | 警告ログ、Vector 検索のみで継続 |

### 観測性

```go
u.logger.Info("retrieval_completed",
    slog.Bool("reranking_enabled", ...),
    slog.Bool("hybrid_enabled", ...),
    slog.Int64("rerank_duration_ms", ...),
    slog.Int64("bm25_duration_ms", ...),
    slog.Int("vector_candidates", ...),
    slog.Int("bm25_candidates", ...),
    slog.Int("post_rerank_count", ...),
)
```

### A/B テスト設計

| グループ | 設定 | 評価指標 |
|---------|------|---------|
| Control | 両方無効 | baseline |
| Test A | Re-rank 有効のみ | NDCG@10, レイテンシ |
| Test B | Hybrid 有効のみ | 検索カバレッジ |
| Test C | 両方有効 | 総合品質 |

## 実装日

2026-01-14

## 関連

- [Searching for Best Practices in RAG (EMNLP 2024)](https://arxiv.org/html/2407.01219v1)
- [Pinecone: Rerankers and Two-Stage Retrieval](https://www.pinecone.io/learn/series/rag/rerankers/)
- [Weaviate: Hybrid Search Explained](https://weaviate.io/blog/hybrid-search-explained)
- [LlamaIndex: Alpha Tuning in Hybrid Search](https://www.llamaindex.ai/blog/llamaindex-enhancing-retrieval-performance-with-alpha-tuning-in-hybrid-search-in-rag-135d0c9b8a00)
