# altctl: Docker Composeスタックオーケストレーションツールの導入

## ステータス

**採択・実装完了（Accepted & Implemented）** - 2025年12月31日

## コンテキスト

### 背景

Altプロジェクトは複数のマイクロサービスで構成される AI 強化 RSS ナレッジプラットフォームである。サービス数の増加に伴い、Docker Compose を直接操作する運用の複雑さが増大していた。

### 課題

1. **サービス数の増加**
   - 8以上のマイクロサービス（frontend, backend, db, auth-hub, search-indexer, tag-generator, news-creator等）
   - 複数のDocker Composeファイル（base.yaml, プロファイル別）
   - サービス間の依存関係が複雑化

2. **開発者体験（DX）の低下**
   - 毎回長いDocker Composeコマンドを入力
   - プロファイルとサービスの組み合わせを覚える必要
   - 依存サービスの起動順序を手動で管理

3. **オンボーディングの障壁**
   - 新規開発者がサービス構成を理解するのに時間がかかる
   - どのサービスを起動すべきか判断が困難

### 制約

- 既存の`compose.yaml`およびMakefileとの共存が必要
- Kubernetesへの将来的な移行可能性を考慮
- Go 1.24+環境での開発（既存バックエンドと技術スタック統一）

## 意思決定

### 決定1: スタックベースの抽象化

**検討した代替案:**

| アプローチ | メリット | デメリット |
|----------|----------|------------|
| シェルスクリプト群 | 実装が簡単、追加依存なし | 保守性低下、クロスプラットフォーム対応が困難 |
| **Go CLIツール（採用）** | 型安全、テスト可能、拡張性高い | 初期実装コスト、バイナリ配布が必要 |
| Python CLIツール | 実装が容易 | ランタイム依存、既存Go技術スタックと不整合 |
| docker-compose alias | 最小限の変更 | 複雑な依存解決が困難 |

**採用理由:**
- 既存のGo技術スタック（alt-backend, search-indexer等）との統一
- Cobra/Viperによる堅牢なCLI実装パターン
- 将来的なKubernetes対応への拡張性

### 決定2: 8つの論理スタック定義

サービスを論理的なスタックにグループ化:

| スタック | サービス | 依存スタック | 備考 |
|---------|---------|-------------|------|
| `base` | (共有リソース) | - | ネットワーク、ボリューム、シークレット |
| `db` | postgres, meilisearch, clickhouse | base | データストア群 |
| `auth` | kratos, kratos-db, auth-hub | db | 認証基盤 |
| `core` | nginx, frontend, backend, migrations | db, auth | コアアプリケーション |
| `workers` | pre-processor-sidecar, search-indexer, tag-generator, auth-token-manager | db, core | バックグラウンドワーカー |
| `ai` | news-creator, pre-processor | db, core | GPU必須、オプショナル |
| `recap` | recap-worker, recap-subworker | db, core | オプショナル |
| `logging` | rask-log-forwarder | db | オプショナル |
| `rag` | rag-orchestrator | db, core | オプショナル |

**設計判断:**
- 依存関係はトポロジカルソートで自動解決
- オプショナルスタック（ai, recap, logging, rag）は明示的に起動
- デフォルトスタック: `[db, auth, core, workers]`

### 決定3: 設定ファイルによるカスタマイズ

`.altctl.yaml`による柔軟な設定:

```yaml
project:
  root: "/path/to/Alt"
  docker_context: "default"

compose:
  dir: "compose"
  base_file: "base.yaml"

defaults:
  stacks: [db, auth, core, workers]

stacks:
  ai:
    requires_gpu: true
    startup_timeout: 600s

logging:
  level: "info"
  format: "text"

output:
  colors: true
  progress: true
```

**設計判断:**
- Viperによる設定ファイル + 環境変数のマージ
- プロジェクトルートの自動検出（`compose.yaml`の存在で判定）
- スタック別のカスタム設定（GPU要件、タイムアウト）

### 決定4: コマンド体系

```
altctl
├── up <stacks...>      # スタック起動（依存自動解決）
├── down <stacks...>    # スタック停止（依存元も停止）
├── status [stacks...]  # サービス状態表示
├── list                # スタック一覧
├── logs <stack>        # ログストリーミング
├── build [stacks...]   # イメージビルド
├── config              # 設定表示
├── completion          # シェル補完生成
└── version             # バージョン表示
```

**グローバルフラグ:**
- `--config`: 設定ファイルパス
- `--verbose`: デバッグ出力
- `--dry-run`: 実行せずコマンド表示
- `--project-dir`: プロジェクトルート指定

## 結果・影響

### 実装内容

#### ディレクトリ構造

```
altctl/
├── main.go                    # エントリポイント
├── cmd/                       # Cobraコマンド群
│   ├── root.go               # ルートコマンド、グローバル初期化
│   ├── up.go                 # スタック起動
│   ├── down.go               # スタック停止
│   ├── status.go             # ステータス表示
│   ├── list.go               # スタック一覧
│   ├── logs.go               # ログ表示
│   ├── build.go              # イメージビルド
│   ├── config.go             # 設定表示
│   ├── completion.go         # シェル補完
│   └── version.go            # バージョン表示
├── internal/
│   ├── config/config.go      # Viper設定管理
│   ├── stack/
│   │   ├── stack.go          # Stack構造体定義
│   │   ├── registry.go       # スタックレジストリ
│   │   └── dependency.go     # 依存解決（トポロジカルソート）
│   ├── compose/
│   │   ├── client.go         # Docker Composeクライアント
│   │   └── executor.go       # コマンド実行
│   └── output/
│       ├── printer.go        # ターミナル出力
│       └── table.go          # テーブル表示
├── go.mod / go.sum           # 依存関係
└── Makefile                  # ビルドターゲット
```

#### 依存ライブラリ

| ライブラリ | バージョン | 用途 |
|-----------|-----------|------|
| github.com/spf13/cobra | v1.8.1 | CLIフレームワーク |
| github.com/spf13/viper | v1.19.0 | 設定管理 |
| github.com/fatih/color | v1.18.0 | ターミナル色付け |
| github.com/olekukonko/tablewriter | v0.0.5 | テーブル表示 |

#### コミット履歴

| コミット | 日時 | 内容 |
|---------|------|------|
| `9db9bf8f` | 2025-12-31 02:16:01 | altctl CLIツールの初期実装（CLAUDE.md） |
| `a84626ef` | 2025-12-31 02:14:26 | Viperによる設定管理機能追加 |
| `72f1d89e` | 2025-12-31 02:16:21 | Makefile追加（ビルド、テスト、インストール） |
| `5acca956` | 2025-12-31 02:17:04 | go.mod/go.sum/main.go初期化 |
| `9eff4a68` | 2025-12-31 02:19:11 | .altctl.yaml設定ファイル追加 |

### 使用例

**基本的な起動:**

```bash
# デフォルトスタック（db, auth, core, workers）を起動
altctl up

# 特定スタックを起動（依存関係も自動起動）
altctl up core  # db, auth も自動起動される

# AIスタックを追加起動
altctl up ai
```

**ステータス確認:**

```bash
# 全スタックのステータス
altctl status

# 依存関係グラフの表示
altctl list --deps
```

**停止:**

```bash
# 特定スタックを停止（依存元も停止）
altctl down core  # workers も停止される

# 全停止（ボリューム保持）
altctl down

# 全停止（ボリューム削除）
altctl down --volumes
```

### PROS

1. **開発者体験の向上**
   - 短く直感的なコマンド体系
   - 依存関係の自動解決で起動順序を意識不要
   - カラー出力とテーブル表示による可視性向上

2. **オンボーディングの改善**
   - `altctl list --deps` でサービス構成を一覧
   - スタック単位の理解で複雑さを抽象化
   - 設定ファイルでプロジェクト固有の設定を文書化

3. **保守性**
   - Go言語による型安全な実装
   - 単体テスト可能な構造
   - 既存Makefileとの共存

4. **拡張性**
   - 新スタックの追加が容易（registry.goを編集）
   - Kubernetes対応への発展可能性
   - プラグイン機構の追加余地

### CONS, TRADEOFF

1. **追加ツールの学習コスト**
   - 開発者がaltctl固有のコマンドを覚える必要
   - Docker Composeの直接知識も並行して必要

2. **保守負担**
   - サービス追加時にaltctl側も更新必要
   - Go依存関係のアップデート管理

3. **バイナリ配布**
   - 開発者がビルドまたはダウンロードが必要
   - クロスプラットフォームビルドの維持

4. **抽象化のオーバーヘッド**
   - Docker Compose直接操作に比べ一層追加
   - 複雑なデバッグ時は結局Docker Composeを直接操作

## 付録

### 関連ファイル

| ファイル | 説明 |
|----------|------|
| `altctl/` | altctl CLIツールのソースコード |
| `altctl/CLAUDE.md` | altctlプロジェクト固有のガイドライン |
| `.altctl.yaml` | プロジェクトルートの設定ファイル |
| `compose.yaml` | Docker Compose定義（altctlがラップ） |
| `Makefile` | 既存のMakeターゲット（altctlと共存） |

### Makefileターゲット

```makefile
make build           # ローカルビルド
make build-linux     # Linux amd64向けクロスコンパイル
make build-darwin    # macOS arm64向けクロスコンパイル
make install         # GOPATH/binへインストール
make test            # テスト実行
make lint            # golangci-lint実行
make completion-bash # Bash補完スクリプト生成
```

### 今後の拡張可能性

- **Kubernetes対応**: `altctl k8s up` のようなサブコマンド追加
- **ヘルスチェック統合**: サービス起動後の自動ヘルスチェック
- **プロファイル管理**: 開発/本番等の環境プロファイル
- **プラグイン機構**: カスタムコマンドの追加

### 参考資料

- [Docker Compose CLI Reference](https://docs.docker.com/compose/reference/)
- [Cobra CLI Framework](https://github.com/spf13/cobra)
- [Viper Configuration](https://github.com/spf13/viper)

---

**作成日:** 2025年12月31日
