# pre-processor 品質判定における重複LLM呼び出しの排除

## ステータス

**承認済み（Accepted）** - 2026年1月

## コンテキスト

### 背景

pre-processor サービスの品質判定機能において、ログ分析の結果、同一プロンプトに対する重複したLLM呼び出しが発生していることが判明した。

### 問題のある処理フロー（修正前）

```
JudgeArticleQuality()
    │
    ├── scoreSummaryWithRetry() ← 1回目のLLM呼び出し
    │       └── /api/generate (num_predict=60)
    │
    └── if 低スコア
            │
            └── RemoveLowScoreSummary()
                    │
                    └── scoreSummaryWithRetry() ← 2回目のLLM呼び出し（同一プロンプト）
                            └── /api/generate (num_predict=60)
```

### 定量的な影響

ログ分析から以下のパターンを確認：

| エンドポイント | 呼び出し回数 | `num_predict` | 備考 |
|---------------|-------------|---------------|------|
| `/api/v1/summarize` | 40 | 1200 | 要約生成（正常） |
| `/api/generate` | 80 | 60 | 品質判定（約半数が重複） |

各品質判定呼び出しのコスト：
- Prefill 処理: 約0.6-1.0秒（GPU時間）
- トークン処理: 1500-3500 tokens/回

## 意思決定

### 決定: RemoveLowScoreSummary のシグネチャ変更によるスコア再利用

#### 修正内容

1. **関数シグネチャの変更**

```go
// Before
func RemoveLowScoreSummary(ctx context.Context, dbPool *pgxpool.Pool,
    articleWithSummary *driver.ArticleWithSummary) error

// After
func RemoveLowScoreSummary(ctx context.Context, dbPool *pgxpool.Pool,
    articleWithSummary *driver.ArticleWithSummary, score *Score) error
```

2. **呼び出し元の修正**

```go
// JudgeArticleQuality 内
if score.Overall < lowScoreThreshold {
    return RemoveLowScoreSummary(ctx, dbPool, articleWithSummary, score)
}
```

3. **RemoveLowScoreSummary 内の重複スコアリング削除**
   - `scoreSummaryWithRetry()` 呼び出しを削除
   - 呼び出し元から渡されたスコアを直接使用

### 修正後のフロー

```
JudgeArticleQuality()
    │
    ├── scoreSummaryWithRetry() ← 1回のみのLLM呼び出し
    │       └── /api/generate (num_predict=60)
    │
    └── if 低スコア
            │
            └── RemoveLowScoreSummary(score) ← スコアを引数で受け取り
                    │
                    └── DB削除処理（LLM呼び出しなし）
```

### 修正ファイル

| ファイル | 変更内容 |
|----------|----------|
| `pre-processor/app/quality-checker/quality_judger.go` | `RemoveLowScoreSummary` シグネチャ変更、重複呼び出し削除 |
| `pre-processor/app/quality-checker/quality_judger_test.go` | テストケース更新 |

## 結果

### PROS

1. **GPU時間の節約**
   - 低品質記事ごとに約1秒のprefill処理を削減
   - 重複LLM呼び出しの完全排除

2. **スループット向上**
   - 同時実行可能なリクエスト数が実質的に向上
   - Ollamaセマフォの占有時間短縮

3. **レイテンシ改善**
   - 低品質記事の処理時間が約1秒短縮
   - エンドツーエンドの応答時間改善

4. **コードの明確化**
   - 責任分離の改善（スコアリングは `JudgeArticleQuality` の責務）
   - `RemoveLowScoreSummary` は削除処理に専念

### CONS, TRADEOFF

1. **API変更**
   - `RemoveLowScoreSummary` の公開シグネチャが変更
   - 外部呼び出し元がある場合は更新が必要（現状は内部使用のみ）

2. **テストの更新**
   - 既存テストケースの修正が必要

## 付録

### パフォーマンス比較

| メトリクス | 修正前 | 修正後 | 改善率 |
|-----------|--------|--------|--------|
| LLM呼び出し/低品質記事 | 2回 | 1回 | 50%削減 |
| GPU時間/低品質記事 | ~2秒 | ~1秒 | 50%削減 |
| `/api/generate` 総呼び出し | 80回 | 40回 | 50%削減 |

### 関連ADR

- [ADR-0043: LLM Summary サービス パフォーマンス評価](./000043.md)
