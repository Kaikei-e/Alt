# ADR-000225: RSS フィード HTML エンティティ表示バグの修正

## STATUS

Accepted（実装完了・コンテナデプロイ・動作確認済み）

## CONTEXT

RSS フィードの記事タイトルや説明文に含まれる HTML エンティティ（`&#39;`, `&amp;`, `&quot;` 等）が、デコードされずそのまま表示されていた。

### 発生していた表示例

| 表示されていた文字列 | 期待される表示 |
|---------------------|---------------|
| `Here&#39;s what we&#39;re reading` | Here's what we're reading |
| `A &amp; B` | A & B |
| `&quot;Hello&quot;` | "Hello" |

### 原因分析

パイプライン全体で HTML エンティティデコードが欠落していた:

1. **バックエンド**: `bluemonday.StrictPolicy().Sanitize()` は HTML タグを除去するが、HTML エンティティはエスケープされた状態のまま残す
2. **フロントエンド**: `sanitizeContent()` および `generateExcerptFromDescription()` にもデコード処理がなかった

### 制約

- XSS を含むセキュリティリスクを生じさせないこと
- SSR（SvelteKit サーバーサイドレンダリング）環境で動作すること
- 追加の外部ライブラリを必要としないこと

## DECISION MAKING

### バックエンド: `html.UnescapeString()` の適用位置

Go 標準ライブラリの `html.UnescapeString()` を `bluemonday.Sanitize()` の **後** に適用する。

この順序がセキュアである理由:

1. `bluemonday.StrictPolicy()` が全ての HTML タグを除去する
2. タグ除去済みのプレーンテキストに対してエンティティデコードを行うため、`<script>` タグの復活などの XSS リスクがない
3. [bluemonday Issue #74](https://github.com/microcosm-cc/bluemonday/issues/74) でも推奨されているパターンである

### フロントエンド: 防御的な二重デコード

バックエンドでのデコードが主たる対策だが、フロントエンドにも防御的にデコード処理を追加した。理由:

- **`DOMParser` を使わない**: SSR 環境では `DOMParser` が利用不可
- **`he` ライブラリを使わない**: 既知のエンティティ 7 種の regex 置換で十分。追加依存は過剰
- **`{@html}` を使わない**: XSS リスクがあるため、テキストは `{text}` で表示し Svelte の自動エスケープに委ねる

### デコード対象エンティティ

| エンティティ | デコード後 |
|-------------|-----------|
| `&amp;` | `&` |
| `&lt;` | `<` |
| `&gt;` | `>` |
| `&quot;` | `"` |
| `&#39;` / `&#039;` | `'` |
| `&apos;` | `'` |
| `&#x27;` | `'` |

Go 側の `html.UnescapeString()` は上記を含む全 HTML エンティティをデコードする。フロントエンド側は RSS フィードで頻出するエンティティに限定した regex ベースのデコードとした。

## RESULTS

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/connect/v2/feeds/helpers.go` | `sanitizeDescription()` に `html.UnescapeString()` を追加 |
| `alt-backend/app/connect/v2/feeds/helpers_test.go` | 新規: HTML エンティティデコードのテスト 6 ケース |
| `alt-frontend-sv/src/lib/domain/feed/sanitize.ts` | `decodeHtmlEntities()` を追加、`sanitizeContent()` 内で適用 |
| `alt-frontend-sv/src/lib/domain/feed/sanitize.test.ts` | 新規: エンティティデコードのテスト 7 ケース |
| `alt-frontend-sv/src/lib/utils/feed.ts` | `generateExcerptFromDescription()` に `decodeHtmlEntities()` を適用 |
| `alt-frontend-sv/src/lib/utils/feed.test.ts` | エンティティデコードのテスト 3 ケースを追加 |

### バックエンド変更パターン

```go
import "html"

func sanitizeDescription(rawHTML string) string {
    if rawHTML == "" {
        return ""
    }
    p := bluemonday.StrictPolicy()
    text := p.Sanitize(rawHTML)
    text = html.UnescapeString(text) // 追加: エンティティデコード
    text = strings.TrimSpace(text)
    text = spaceCollapseRe.ReplaceAllString(text, " ")
    return text
}
```

### フロントエンド変更パターン

```typescript
export function decodeHtmlEntities(text: string): string {
    return text
        .replace(/&amp;/g, "&")
        .replace(/&lt;/g, "<")
        .replace(/&gt;/g, ">")
        .replace(/&quot;/g, '"')
        .replace(/&#0?39;/g, "'")
        .replace(/&apos;/g, "'")
        .replace(/&#x27;/g, "'");
}
```

`sanitizeContent()` および `generateExcerptFromDescription()` 内のタグ除去後に呼び出す。

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| バックエンド Go テスト (`go test ./connect/v2/feeds/`) | 全 PASS |
| フロントエンド テスト (`bun test`) | 43/43 PASS |
| `alt-backend` コンテナ再ビルド・起動 | 正常 (`healthy`) |
| `alt-frontend-sv` コンテナ再ビルド・起動 | 正常 (`ok`) |
| `GET /v1/health` | `{"status":"healthy"}` |
| `GET /api/health` | `{"status":"ok"}` |

## PROS

1. **セキュア**: bluemonday によるタグ除去後のデコードであり、XSS リスクなし
2. **高パフォーマンス**: バックエンドで 1 回デコードすれば全フロントエンドコンポーネントに反映。追加ライブラリ不要
3. **防御的多層**: バックエンド（Go 標準ライブラリ）とフロントエンド（regex）の二重デコードにより、一方の処理が欠落しても表示が壊れない
4. **SSR 互換**: フロントエンド側は `DOMParser` に依存せず、SSR 環境でも動作する

## CONS, TRADEOFF

1. フロントエンド側の regex ベースデコードは対象エンティティが限定的である。RSS フィードで使われない稀なエンティティ（例: `&euro;`）はフロントエンド側ではデコードされない（バックエンド側ではデコードされる）
2. バックエンドとフロントエンドの二重デコードにより、既にデコード済みのテキストに対して不要な regex 処理が走る。ただしパフォーマンス影響は無視できるレベル

## APPENDIX

- `html.UnescapeString()` は Go 標準ライブラリ `html` パッケージに含まれる。全 HTML5 Named Character References に対応
- bluemonday の `StrictPolicy()` は全ての HTML タグを除去するが、エンティティはエスケープ済みのまま返す仕様。これは bluemonday の設計意図（出力を HTML コンテキストで安全に使えるようにする）に基づく
- 関連 Issue: [bluemonday #74](https://github.com/microcosm-cc/bluemonday/issues/74) — `Sanitize()` 後に `html.UnescapeString()` を適用するパターンが議論されている
