# Feature Model導入によるスタック依存関係の改善

## ステータス

採択（Accepted）

## コンテキスト

### 問題

ADR 000057で検討されたように、`altctl up core`を実行した際に検索機能が動作しない問題が発生していた。これは`core`スタックと`workers`スタックが構造的には独立しているが、検索機能は両方を必要とするという「機能的依存関係」の問題だった。

### 背景

- 既存の`DependsOn`は構造的依存（起動順序）のみを管理
- ユーザーは`altctl up core`で完全な機能を期待するが、実際には検索が動作しない
- エラーメッセージが不明瞭で、原因特定が困難

### 調査結果

Web検索でのベストプラクティス調査により、以下の知見を得た：

1. **rustls over OpenSSL**: ビルドのポータビリティ向上（Dockerビルド失敗の根本原因）
2. **Feature Bundles**: 機能単位でのスタックグルーピング
3. **Health-based Dependencies**: サービス健全性に基づく依存管理

## 決定

### 1. ビルド依存関係の修正

`rask-log-forwarder`のCargo.tomlを修正し、`reqwest`のTLSバックエンドを`native-tls`（OpenSSL）から`rustls`に変更：

```toml
# BEFORE
reqwest = { version = "0.12.20", features = ["json", "gzip"] }

# AFTER
reqwest = { version = "0.12.20", default-features = false, features = ["json", "gzip", "rustls-tls"] }
```

これによりOpenSSL依存が排除され、slim Dockerイメージでもビルド可能になった。

### 2. Feature Model導入

`Stack`構造体に機能的依存関係を表現する属性を追加：

```go
type Feature string

const (
    FeatureSearch   Feature = "search"
    FeatureAI       Feature = "ai"
    FeatureRecap    Feature = "recap"
    FeatureRAG      Feature = "rag"
    FeatureLogging  Feature = "logging"
    FeatureAuth     Feature = "auth"
    FeatureDatabase Feature = "database"
)

type Stack struct {
    // ... 既存フィールド ...
    Provides         []Feature // このスタックが提供する機能
    RequiresFeatures []Feature // このスタックが必要とする機能
}
```

### 3. スタック-Feature マッピング

| Stack | Provides | RequiresFeatures |
|-------|----------|------------------|
| db | database | - |
| auth | auth | - |
| core | - | search |
| workers | search | - |
| ai | ai | - |
| recap | recap | - |
| logging | logging | - |
| rag | rag | - |

### 4. CLI警告の実装

`altctl up`実行時に不足している機能を警告：

```
$ altctl up core

Feature Warnings
  Stack 'core' requires feature 'search' which is not available.
  Suggestion: Also start: workers

To include suggested stacks, run:
  altctl up core workers

Starting Stacks
  • base: Shared resources (secrets, networks, volumes)
  • db: Database services (PostgreSQL 17, Meilisearch, ClickHouse)
  • auth: Authentication services (Kratos, auth-hub)
  • core: Core application services (nginx, frontend, backend)
```

## 結果

### メリット

1. **明確な依存関係**: 機能的依存関係が明示的にコード化
2. **ユーザーガイダンス**: 不足スタックを具体的に提案
3. **ビルド安定性**: OpenSSL依存を排除し、ポータブルなビルド
4. **拡張性**: 新機能追加時にFeatureを追加するだけ
5. **テスト可能**: TDDでFeatureResolver実装済み

### トレードオフ

1. **複雑性増加**: Stack構造体に新しいフィールド追加
2. **メンテナンス**: 新スタック追加時にFeatureメタデータも必要

## 実装

### 実装日: 2026-01-07

### 修正ファイル一覧

| カテゴリ | ファイル | 変更内容 |
|---------|---------|---------|
| Rust | `rask-log-forwarder/app/Cargo.toml` | reqwestをrustls-tlsに変更 |
| Stack Model | `altctl/internal/stack/stack.go` | Provides, RequiresFeatures属性追加 |
| Feature | `altctl/internal/stack/feature.go` | 新規: Feature型とFeatureResolver |
| Feature Test | `altctl/internal/stack/feature_test.go` | 新規: Unit tests |
| Registry | `altctl/internal/stack/registry.go` | 各スタックにFeatureメタデータ追加 |
| CLI | `altctl/cmd/up.go` | Feature警告とサジェスション表示 |

### テスト結果

**altctl Unit Tests**:
```
=== RUN   TestCheckMissingFeatures_CoreWithoutWorkers
--- PASS: TestCheckMissingFeatures_CoreWithoutWorkers (0.00s)
=== RUN   TestCheckMissingFeatures_CoreWithWorkers
--- PASS: TestCheckMissingFeatures_CoreWithWorkers (0.00s)
=== RUN   TestSuggestAdditionalStacks
--- PASS: TestSuggestAdditionalStacks (0.00s)
=== RUN   TestCheckMissingFeatures_NoWarningsForCompleteStack
--- PASS: TestCheckMissingFeatures_NoWarningsForCompleteStack (0.00s)
=== RUN   TestFindFeatureProviders
--- PASS: TestFindFeatureProviders (0.00s)
=== RUN   TestProvidesFeature
--- PASS: TestProvidesFeature (0.00s)
PASS
```

**Rust Build**:
```
cargo build --release
Finished `release` profile [optimized] target(s) in 46.08s
```

## 関連ADR

- [ADR 000057: 検索機能のエラーハンドリング改善とスタック依存関係の明確化](./000057.md)

## 参考

- [Containerization Best Practices for Rust 2025](https://markaicode.com/containerization-best-practices-2025/)
- [Docker Compose Best Practices 2025](https://toxigon.com/docker-compose-best-practices-2025)
- [Docker Compose Health Checks Guide](https://monkey.work/blog/2025-12-26-docker-compose-health-checks-guide/)
- スタック定義: `altctl/internal/stack/registry.go`
- Feature解決: `altctl/internal/stack/feature.go`
