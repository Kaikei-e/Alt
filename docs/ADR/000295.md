# ADR-000295: BFFストリーミングバイパス — io.ReadAll全バッファリングと30秒デッドラインの修正

## ADR's STATUS

Accepted（ADR-000292/293の後続修正）

## CONTEXT

ADR-289/292/293でnginx設定の最適化とrag-orchestratorへのハートビート機構を導入したが、フロントエンドで依然として `Error: [unknown] missing EndStreamResponse` が発生し続けていた。

### 調査結果

nginxアクセスログで全てのStreamChatリクエストが `rt=30.004` と一致しており、アプリケーション内のタイムアウト設定（300s〜600s）とは合致しない30秒で一律切断されていた。

rag-orchestratorのハートビートは正常に発行されているにも関わらず、クライアントに到達していないことから、**rag-orchestratorとフロントエンドの間の中間レイヤー**に問題があると特定。

### 根本原因: alt-butterfly-facade (BFF) の2つのバグ

#### バグ1: `io.ReadAll()` による全バッファリング

`BFFHandler.executeRequest()` がストリーミングレスポンスに対しても `io.ReadAll(resp.Body)` を呼び出し、**全レスポンスボディをメモリにバッファリング**してから転送していた。ハートビートやデルタイベントがリアルタイムでクライアントに届かなかった。

```
rag-orchestrator → alt-backend → BFF(io.ReadAll で全バッファ) →×→ SvelteKit → nginx
                                   ↑ ここで止まる
```

`ProxyHandler` にはすでに適切な `streamResponse()` （チャンクごとにFlush）が実装されていたが、BFF機能（キャッシュ・重複排除・サーキットブレーカー）が有効な場合は `BFFHandler` が使われ、このストリーミングパスが迂回されていた。

#### バグ2: 30秒コンテキストデッドライン

`BFFHandler.applyConnectTimeout()` および `ProxyHandler.applyConnectTimeout()` がストリーミングリクエストにも `defaultTimeout=30s` を適用していた。`Connect-Timeout-Ms` ヘッダーがクライアントから送られない場合、30秒でcontextがキャンセルされる。

#### 結果

1. BFFがストリーミングデータを全バッファリング（クライアントにデータが届かない）
2. 30秒後にコンテキストデッドラインが発火
3. `io.ReadAll` が `context deadline exceeded` で終了
4. BFFがSvelteKitに502を返す
5. Connect-esが `missing EndStreamResponse` を報告

## DECISION MAKING

### 1. BFFHandler: ストリーミングリクエストのProxyHandlerデリゲート

`BFFHandler.ServeHTTP` の先頭で `isStreamingProcedure()` を判定し、ストリーミングリクエストの場合は `ProxyHandler.ServeHTTP` に直接デリゲートする。

```go
func (h *BFFHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {
    if isStreamingProcedure(r.URL.Path) {
        h.proxyHandler.ServeHTTP(w, r)
        return
    }
    // ... 既存のBFF処理（キャッシュ・重複排除・サーキットブレーカー）
}
```

ストリーミングレスポンスはキャッシュ不可能かつ冪等でないため、BFF機能（キャッシュ・重複排除・サーキットブレーカー）をバイパスしても機能的な損失はない。

### 2. ProxyHandler: ストリーミング専用タイムアウト

`ProxyHandler` に `streamingTimeout` フィールドを追加し、`applyConnectTimeout()` でストリーミングリクエストの場合に使用する。

```go
func (h *ProxyHandler) applyConnectTimeout(r *http.Request) (*http.Request, context.CancelFunc) {
    timeout := h.defaultTimeout
    if isStreamingProcedure(r.URL.Path) {
        timeout = h.streamingTimeout  // 5分
    }
    // Connect-Timeout-Msヘッダーによるオーバーライドも可能
    // ...
}
```

### 3. BackendClient: StreamingTimeout getter

`BackendClient` に `StreamingTimeout()` メソッドを追加し、BFFHandlerからProxyHandler構築時にストリーミングタイムアウトを渡せるようにした。

## RESULTS, EFFECTS

### 修正後のデータフロー

```
StreamChat → BFFHandler.ServeHTTP
  → isStreamingProcedure? YES
  → ProxyHandler.ServeHTTP
    → applyConnectTimeout (5分, streamingTimeout)
    → streamResponse (チャンクごとにFlush)
    → クライアントにリアルタイムでイベント到達
```

### PROS

- **ストリーミングのリアルタイム配信**: `ProxyHandler.streamResponse()` によるチャンクごとのFlushで、ハートビート・デルタイベントが即座にクライアントに到達
- **30秒タイムアウト解消**: ストリーミングリクエストに5分のタイムアウトが適用され、LLMの長時間生成にも対応
- **最小限の変更**: 既存の `streamResponse()` 機構を再利用し、ルーティング変更のみで修正
- **BFF機能への影響なし**: ストリーミングレスポンスはキャッシュ・重複排除の対象外のため、バイパスによる機能損失がない
- **TDDで品質担保**: 4件のテストを追加（ストリーミングデリゲーション検証2件、タイムアウト検証2件）

### CONS, TRADEOFF

- **ストリーミングのサーキットブレーカー非適用**: ストリーミングリクエストがBFF機能を完全にバイパスするため、サーキットブレーカーの障害検出対象外となる（ストリーミングの特性上、別の監視手段が適切）
- **エラー正規化の非適用**: ストリーミングリクエストのエラーはBFFのエラー正規化を通らず、ProxyHandlerの素の502応答となる（Connect-RPCストリーミングのエラー形式と整合的）

## APPENDIX

### 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `alt-butterfly-facade/internal/client/backend_client.go` | `StreamingTimeout()` getter追加 |
| `alt-butterfly-facade/internal/handler/proxy_handler.go` | `streamingTimeout` フィールド追加、`applyConnectTimeout()` でストリーミング判定 |
| `alt-butterfly-facade/internal/handler/bff_handler.go` | `ServeHTTP` 先頭でストリーミングリクエストをProxyHandlerにデリゲート |
| `alt-butterfly-facade/internal/server/server.go` | `NewProxyHandler` 呼び出しに `streamingTimeout` パラメータ追加 |

### テスト

| テスト名 | 検証内容 |
|---------|---------|
| `TestBFFHandler_ServeHTTP_StreamingDelegatesToProxyHandler` | ストリーミングリクエストがProxyHandler経由でチャンク配信され、X-Cacheヘッダーが付与されないこと |
| `TestBFFHandler_ServeHTTP_UnaryStillUsesBFFFeatures` | Unaryリクエストが従来通りBFF機能を通過し、X-Cache: MISSが付与されること |
| `TestProxyHandler_ApplyConnectTimeout_StreamingUsesStreamingTimeout` | ストリーミングリクエストに5分のタイムアウトが適用されること |
| `TestProxyHandler_ApplyConnectTimeout_UnaryUsesDefaultTimeout` | Unaryリクエストに30秒のデフォルトタイムアウトが適用されること |

### 関連ADR

- ADR-000289: nginx `proxy_buffering off` + progressイベント導入
- ADR-000292: Augurストリーミング30秒タイムアウト修正（ハートビート導入）
- ADR-000293: ハートビートをLLMストリーミングフェーズに拡張
