# ADR-000303: フィード登録時のユーザー自動購読と購読フィルターの修正

## ADR's STATUS

Accepted

## CONTEXT

フィード一覧画面でその日に取得されたフィードが1件も表示されない問題が発生していた。

### 原因

フィード取得SQLに以下のフィルターが適用されている。

```sql
AND (f.feed_link_id IN (SELECT feed_link_id FROM user_feed_subscriptions WHERE user_id = $N)
     OR f.feed_link_id IS NULL)
```

このフィルターは「ユーザーが購読している `feed_link` に紐づくフィード、または `feed_link_id` が NULL のフィード」のみを返す設計である。

問題は2つの条件が重なって発生した:

1. **`user_feed_subscriptions` テーブルが空**: フィード登録（`RegisterRSSFeedLink`）時に `feed_links` テーブルへの INSERT は行われるが、ユーザーの購読レコード（`user_feed_subscriptions`）が作成されていなかった
2. **`feed_link_id` の充填が進行**: `RegisterSingleFeed`/`RegisterMultipleFeeds` の COALESCE upsert により、フィードの `feed_link_id` が徐々に埋まっていた。直近のフィードは100% `feed_link_id` が非NULLのため、サブクエリの結果が空集合となり全件除外された

古いフィード（`feed_link_id` が NULL）は `OR f.feed_link_id IS NULL` 条件で表示されていたため、問題の発覚が遅れた。

## DECISION MAKING

### 方針: フィード登録時にユーザーを自動購読する

フィード登録のGateway層で、`feed_links` への登録成功後にユーザーを自動購読する処理を追加する。

### 設計判断

| 項目 | 決定 | 理由 |
|------|------|------|
| 実装レイヤー | Gateway | `alt_db` リポジトリへのアクセスが既にあり、追加の依存注入が不要 |
| エラーハンドリング | ベストエフォート（ログのみ） | 購読の失敗でフィード登録自体を失敗させるべきではない |
| ユーザーコンテキスト取得 | `domain.GetUserFromContext(ctx)` | Connect-RPC ハンドラ経由で認証済みコンテキストが渡される |
| 重複防止 | `ON CONFLICT DO NOTHING` | 既存の `InsertSubscription` が冪等性を保証 |
| 既存データの修正 | 一回限りの手動SQL | マイグレーションではなくデータ修正として実行 |

### 処理フロー

```
RegisterRSSFeedLink (Gateway)
  ├─ URL バリデーション
  ├─ RSS フィード取得・パース
  ├─ feed_links テーブルへ INSERT
  └─ autoSubscribeUser (新規追加)
       ├─ コンテキストからユーザーID取得
       ├─ URL から feed_link_id を解決
       └─ user_feed_subscriptions へ INSERT (ON CONFLICT DO NOTHING)
```

### 他の選択肢を採用しなかった理由

- **Usecase層での実装**: `RegisterFeedsUsecase` は既に `feedLinkIDResolver` で `feed_link_id` を解決しているが、新たに購読ポートの追加・DI変更・コンストラクタ変更が必要になり変更範囲が大きい
- **Driver層での実装**: `RegisterRSSFeedLink` のトランザクション内で購読INSERTを行う方法。ただし購読ロジックはビジネスロジックであり、Driver層の責務を超える
- **SQLフィルターの変更（購読フィルター自体を削除）**: 購読管理UIが既に存在し、将来的にユーザーごとのフィード選択が必要。フィルター自体は正しい設計

## RESULTS, EFFECTS

### PROS

- **即座に効果**: 既存ユーザーのバックフィル後、全フィードが正常に表示される
- **将来のフィード登録でも自動適用**: 新規フィード登録時に自動購読されるため、同じ問題が再発しない
- **変更範囲が最小**: Gateway層の1ファイルのみ変更。ポート・ユースケース・DIへの変更なし
- **既存の購読管理UIとの整合性**: ユーザーは設定画面から個別に購読解除可能

### CONS, TRADEOFF

- Gateway層がユーザーコンテキスト（`domain.GetUserFromContext`）に依存するが、これは認証済みリクエストのみで呼ばれるため実用上問題ない
- 自動購読のため、ユーザーが登録した全フィードが表示される。「登録はするが購読しない」ユースケースには設定画面での手動解除が必要

## APPENDIX

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `alt-backend/app/gateway/register_feed_gateway/single_feed_link_gateway.go` | `autoSubscribeUser` メソッド追加、`RegisterRSSFeedLink` から呼び出し |

### 既存データのバックフィルSQL

```sql
INSERT INTO user_feed_subscriptions (user_id, feed_link_id)
SELECT u.user_id, fl.id
FROM (SELECT DISTINCT user_id FROM read_status) u
CROSS JOIN feed_links fl
ON CONFLICT DO NOTHING;
```

### 検証結果

- バックフィル前: `user_feed_subscriptions` = 0行、当日フィード表示 = 0件
- バックフィル後: `user_feed_subscriptions` = 75行、当日フィード表示 = 349件
- 既存テスト: 全件パス（`ok alt/gateway/register_feed_gateway`）
- ヘルスチェック: `{"database":"connected","status":"healthy"}`

### 関連 ADR

- ADR-000299: `GetFeedIDByURL` のクエリ対象変更
- ADR-000300: `feed_links.id` と `feeds.id` の混同修正
- ADR-000301: `GetFeedIDByURL` の二重用途バグ修正
- ADR-000302: `articles` テーブルへの `published_at` カラム追加
