# ADR-000299: alt-backend 既存バグ4件の修正 — NULL FeedID・重複サブクエリ・テーブル参照誤り・Prometheus 404

## ADR's STATUS

Accepted

## CONTEXT

ADR-000298（proto 型リネーム）の適用後に alt-backend のランタイムログを調査した結果、proto リネーム起因のエラーは 0 件であった。しかし、以下の既存バグ 4 件が継続的にエラーログを発生させていた。

### 1. BatchUpsertArticleTags — 空文字 UUID エラー（Critical）

`list_untagged_articles_driver.go` が `COALESCE(a.feed_id::text, '')` を使用しており、`feed_id` が NULL の記事に対して空文字列 `""` が返される。この空文字列が `upsert_article_tags_driver.go` の `$1::uuid` に渡され、PostgreSQL が UUID パースに失敗する。約 2 分ごとに繰り返し発生。

### 2. ResetFeedLinkFailures — サブクエリ複数行エラー（High）

`feed_link_availability_driver.go` の `WHERE feed_link_id = (SELECT id FROM feed_links WHERE url = $1)` で、`feed_links` テーブルに同一 URL が複数行存在するケースでサブクエリが複数行を返し、PostgreSQL エラー `SQLSTATE 21000` が発生。

### 3. GetFeedID — テーブル参照誤り（Medium）

`feed_url_to_id_driver.go` が `feeds` テーブルの `link` カラムを参照していたが、RSS フィード URL は `feed_links` テーブルの `url` カラムに格納されている。`feeds.link` にはフィードのウェブサイト URL が入っており、RSS URL（例: `/rss` サフィックス付き）とは一致しない。起動直後の feed collection 時に大量の `no rows in result set` エラーが発生。

### 4. /metrics 404（Low）

Prometheus が alt-backend の `/metrics` エンドポイントをスクレイプしていたが、alt-backend には Prometheus メトリクスハンドラが存在しない。15 秒ごとに 404 エラーがログに記録されていた。

## DECISION MAKING

### 1. FeedID の nullable 化とフィルタリング

`InternalUntaggedArticle.FeedID` および `UntaggedArticle.FeedID` の型を `string` から `*string` に変更し、SQL クエリから `COALESCE` を除去して NULL をそのまま Go 側に伝搬する。`BatchUpsertArticleTags` では FeedID が空の記事をトランザクション開始前にフィルタリングし、有効なタグのみを処理する。

**他の選択肢を採用しなかった理由:**

- **DB 側で NULL 行を WHERE 除外**: タグ付けされるべき記事がリストから漏れ、タグ付けの進捗カウントが不正確になる
- **空文字列を特殊な UUID に変換**: データの意味が曖昧になり、feed_tags テーブルに不正なレコードが混入する

### 2. サブクエリの `=` → `IN` 変更

`ResetFeedLinkFailures` と `DisableFeedLink` の WHERE 句を `= (SELECT ...)` から `IN (SELECT ...)` に変更し、同一 URL の重複行が存在する場合にも正常に動作するようにする。

**他の選択肢を採用しなかった理由:**

- **重複行の削除**: 重複の発生原因を調査してからクリーンアップすべきであり、即座に削除するとデータ損失のリスクがある
- **LIMIT 1 の追加**: 意図しない行のみが更新される可能性がある

### 3. クエリ対象テーブルの修正

`GetFeedIDByURL` のクエリを `SELECT id FROM feeds WHERE link = $1` から `SELECT id FROM feed_links WHERE url = $1` に変更。

### 4. Prometheus scrape 設定の除外

alt-backend には Prometheus クライアントライブラリが導入されておらず、メトリクスエンドポイントが存在しない。ダミーの `/metrics` ハンドラを追加するのではなく、`prometheus.yml` から alt-backend の scrape 設定を削除する。

**他の選択肢を採用しなかった理由:**

- **空の /metrics ハンドラ追加**: Prometheus が空レスポンスをスクレイプし続けるため、無駄なリソース消費が発生する
- **Prometheus クライアントの導入**: 有用だが、この修正のスコープを超える。今後の改善として別途対応する

## RESULTS, EFFECTS

### PROS

- **Critical エラーの解消**: 約 2 分間隔で発生していた UUID パースエラーが解消され、タグ付けパイプラインが正常に動作する
- **データ整合性の向上**: feed_links テーブルに重複 URL がある場合でも feed availability の更新が正常に処理される
- **feed collection の安定化**: GetFeedID が正しいテーブルを参照するようになり、起動直後のエラーログが解消される
- **ログの S/N 比改善**: 15 秒ごとの `/metrics` 404 エラーが解消され、実際の問題の検出が容易になる

### CONS, TRADEOFF

- `UntaggedArticle.FeedID` が `*string` に変更されたため、この型を参照する既存コードでポインタの nil チェックが必要になる（Connect ハンドラで対応済み）
- Prometheus による alt-backend のメトリクス収集が無効化される。alt-backend のメトリクス可視化が必要な場合は、別途 Prometheus クライアントの導入を検討する

## APPENDIX

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `alt-backend/app/driver/alt_db/list_untagged_articles_driver.go` | `FeedID` を `*string` に変更、`COALESCE` 除去 |
| 2 | `alt-backend/app/port/internal_tag_port/port.go` | `UntaggedArticle.FeedID` を `*string` に変更 |
| 3 | `alt-backend/app/connect/v2/internal/handler.go` | `*string` → proto `string` の安全なデリファレンス |
| 4 | `alt-backend/app/driver/alt_db/upsert_article_tags_driver.go` | 空 FeedID のフィルタリング追加 |
| 5 | `alt-backend/app/driver/alt_db/feed_link_availability_driver.go` | `=` → `IN` に変更（2 箇所） |
| 6 | `alt-backend/app/driver/alt_db/feed_url_to_id_driver.go` | `feeds` → `feed_links` テーブルに変更 |
| 7 | `observability/prometheus/prometheus.yml` | alt-backend scrape 設定を削除 |

### テストファイル

| ファイル | テスト内容 |
|---------|---------|
| `list_untagged_articles_driver_test.go` | NULL FeedID の伝搬、正常な FeedID の伝搬、空結果 |
| `upsert_article_tags_driver_test.go` | 空 FeedID のスキップ、全件空 FeedID、空入力、空タグ |
| `feed_link_availability_driver_test.go` | 重複 URL での ResetFeedLinkFailures・DisableFeedLink |
| `feed_url_to_id_driver_test.go` | feed_links テーブルからの取得、未検出ケース、nil pool |

### 検証結果

- `go test ./...`: 修正対象パッケージ全件 PASS（`alt/rest` の既存 FAIL は無関係）
- コンテナ再ビルド・起動後、修正対象の 4 エラーの発生件数: **0 件**

### Fix #3 リグレッション修正: GetFeedIDByURL が feed_links.id を返していた問題

Fix #3 で `feeds.link` → `feed_links.url` にテーブル参照を変更した際、`SELECT id FROM feed_links WHERE url = $1` としたため、返却値が `feed_links.id`（feed_link_id）になっていた。呼び出し元は `feeds.id`（feed_id）を期待しており、`articles.feed_id` への INSERT 時に FK 違反が発生する。

**修正**: JOIN クエリに変更し、`feed_links` で RSS URL を検索 → `feeds.feed_link_id` FK 経由で正しい `feeds.id` を返すようにした。

```sql
-- Before (リグレッション)
SELECT id FROM feed_links WHERE url = $1

-- After (修正後)
SELECT f.id FROM feeds f INNER JOIN feed_links fl ON f.feed_link_id = fl.id WHERE fl.url = $1
```

| ファイル | 変更内容 |
|---------|---------|
| `feed_url_to_id_driver.go` | JOIN クエリに変更 |
| `feed_url_to_id_driver_test.go` | モック期待値を JOIN クエリに更新 |
| `save_article_driver_test.go` | 内部呼び出しのモックを JOIN クエリに更新 |
