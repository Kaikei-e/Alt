# システムユーザー取得をauth-hub経由に変更

## ステータス

採択（Accepted）

## コンテキスト

バックグラウンドジョブ（記事同期など）の実行時に、内部サービス間通信でシステムユーザーIDが必要となる。従来、alt-backendが直接ローカルDBの`users`テーブルからユーザーIDを取得していたが、ユーザー管理はOry Kratosに一元化されているため、このテーブルは空であった。

### 問題の症状

```
pre-processor: failed to get system user id
pre-processor: article sync failed
```

### 根本原因

1. **ユーザー管理の分離**: ユーザーはKratosで管理されており、alt-backendのDBには存在しない
2. **直接DB参照の失敗**: `SELECT id FROM users LIMIT 1` がErrNoRowsを返す
3. **アーキテクチャ不整合**: alt-backendがKratosの詳細を知る必要がある設計になっていた

## 決定

### BFF/Aggregatorパターンの適用

auth-hubをIdentity-Aware Proxy (IAP) として活用し、Kratosへのアクセスを抽象化する。

```
変更前:
pre-processor → alt-backend → (DB users table - 空)

変更後:
pre-processor → alt-backend → auth-hub → Kratos Admin API
```

### 1. auth-hubに内部エンドポイントを追加

```go
// GET /internal/system-user
type SystemUserResponse struct {
    UserID string `json:"user_id"`
}
```

auth-hubがKratos Admin APIを呼び出し、最初のIdentity IDを返却する。

### 2. alt-backendの設定をauth-hub向けに変更

```go
// 変更前
type KratosConfig struct {
    AdminURL string `env:"KRATOS_ADMIN_URL"`
}

// 変更後
type AuthHubConfig struct {
    URL string `env:"AUTH_HUB_URL"`
}
```

### 3. alt-backendのクライアントをauth-hub呼び出しに変更

```go
// auth-hubの/internal/system-userを呼び出す
func (c *authHubClientImpl) GetFirstIdentityID(ctx context.Context) (string, error) {
    url := fmt.Sprintf("%s/internal/system-user", c.authHubURL)
    // HTTP GET request
}
```

### 検討した代替案

| 選択肢 | 概要 | 採否 |
|--------|------|------|
| A案: auth-hub経由 (BFFパターン) | auth-hubがKratosを抽象化 | **採用** |
| B案: alt-backendからKratos直接呼び出し | alt-backendにKratos Admin API呼び出しを追加 | 不採用 |
| C案: 環境変数でシステムユーザーID指定 | SYSTEM_USER_IDを事前設定 | 不採用 |
| D案: ユーザー同期 (CQRS) | KratosからDBへのイベント同期 | 不採用 |

### A案採用の理由

1. **関心の分離**: alt-backendはKratosという実装詳細を知らなくて済む
2. **既存依存の活用**: alt-backendは既にauth-hubへの依存がある
3. **認証の一元化**: auth-hubがIdentity Provider層を集約
4. **変更の最小化**: pre-processorの変更不要（既存の`/v1/internal/system-user`呼び出しを維持）

### B案不採用の理由

- alt-backendがKratosの詳細（Admin API URL、レスポンス形式）に依存する
- 認証関連の責務がauth-hubとalt-backendに分散する

### C案不採用の理由

- 運用負荷: ユーザーID変更時に環境変数の更新が必要
- アグリゲーターパターンに反する

### D案不採用の理由

- 過剰な複雑性: イベントハンドラー、DBスキーマの大規模変更が必要
- 現時点では不要なリアルタイム同期

## 結果

### 変更されたファイル

| ファイル | 変更内容 |
|---------|---------|
| `auth-hub/config/config.go` | KratosAdminURL追加 |
| `auth-hub/client/kratos_client.go` | GetFirstIdentityID メソッド追加 |
| `auth-hub/handler/internal_handler.go` | 新規作成 |
| `auth-hub/main.go` | 内部エンドポイント登録 |
| `alt-backend/app/config/config.go` | KratosConfig → AuthHubConfig |
| `alt-backend/app/driver/kratos_client/client.go` | auth-hub呼び出しに変更 |
| `alt-backend/app/di/container.go` | AuthHub URL使用に変更 |
| `compose/core.yaml` | AUTH_HUB_URL環境変数追加 |
| `compose/auth.yaml` | KRATOS_ADMIN_URL環境変数追加 |

### 通信フロー

```
pre-processor
    ↓ HTTP GET /v1/internal/system-user
alt-backend
    ↓ HTTP GET /internal/system-user
auth-hub
    ↓ HTTP GET /admin/identities?page_size=1
Kratos Admin API
    ↓
    [{"id": "user-uuid-..."}]
```

### メリット

1. **責務の明確化**: auth-hubがIdentity Provider層を完全に抽象化
2. **疎結合**: alt-backendはKratosの存在を知らない
3. **テスト容易性**: auth-hubをモックするだけでalt-backendのテストが可能
4. **将来の拡張性**: Identity Providerの変更がauth-hub内で完結

### トレードオフ

1. **レイテンシ増加**: 1ホップ追加（auth-hub経由）
2. **依存チェーン**: auth-hubの可用性がシステムユーザー取得に影響

## 検証計画

```bash
# 1. スタック再起動
make down && make up

# 2. auth-hubエンドポイント確認
curl -s http://localhost:8888/internal/system-user | jq

# 3. alt-backend経由で確認
curl -s http://localhost:9000/v1/internal/system-user | jq

# 4. pre-processorログ確認（エラー解消）
docker logs alt-pre-processor-1 --tail 50 | grep -E "system user|article sync"
```

## 実装日

2026-01-12

## 関連

- [BFF Pattern - Sam Newman](https://samnewman.io/patterns/architectural/bff/)
- [Azure Backends for Frontends](https://learn.microsoft.com/en-us/azure/architecture/patterns/backends-for-frontends)
- [Ory Kratos Admin API](https://www.ory.sh/docs/kratos/reference/api)
