# Connect-RPC をデフォルト通信プロトコルとして採用

## ステータス

採択（Accepted）

## コンテキスト

ADR-067 で内部サービス間通信の Connect-RPC 移行計画を策定し、フィーチャーフラグ（`USE_CONNECT_RPC`）による段階的移行を予定していた。

しかし、以下の理由からフィーチャーフラグを廃止し、Connect-RPC をデフォルトとすることを決定した：

1. **環境変数の増加を避ける**: 運用上の複雑さを軽減
2. **シンプルな移行**: 二重実装の保守コストを削減
3. **テスト完了**: Connect-RPC 実装のテストが完了し、安定性を確認

## 決定

### 変更内容

1. **フィーチャーフラグの削除**
   - `USE_CONNECT_RPC` 環境変数を廃止
   - `ConnectRPCConfig` 構造体を削除

2. **Connect-RPC をデフォルト化**
   - alt-backend → search-indexer 通信: Connect-RPC (port 9301)
   - REST ドライバーへのフォールバックなし

3. **設定の簡素化**
   ```go
   type SearchIndexerConfig struct {
       ConnectURL string `env:"SEARCH_INDEXER_CONNECT_URL" default:"http://search-indexer:9301"`
   }
   ```

### 通信フロー

```
alt-frontend-sv ──Connect-RPC──> alt-backend
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
            search-indexer                   pre-processor
            (Connect: 9301)                  (Connect: 9202)
```

### DI コンテナの変更

```go
// Before (ADR-067)
var searchIndexerDriver search_indexer_port.SearchIndexerPort
if cfg.ConnectRPC.Enabled {
    searchIndexerDriver = search_indexer_connect.NewConnectSearchIndexerDriver(cfg.SearchIndexer.ConnectURL)
} else {
    searchIndexerDriver = search_indexer.NewHTTPSearchIndexerDriver()
}

// After (ADR-068)
searchIndexerDriver := search_indexer_connect.NewConnectSearchIndexerDriver(cfg.SearchIndexer.ConnectURL)
```

## 結果

### 削除されたコード

| ファイル | 削除内容 |
|---------|---------|
| `config/config.go` | `ConnectRPCConfig` 構造体、`SearchIndexerConfig.URL` フィールド |
| `di/container.go` | フィーチャーフラグ分岐、REST ドライバーのインポート |

### 残存するコード（後方互換性）

| コンポーネント | 説明 |
|---------------|------|
| REST サーバー (search-indexer:9300) | 外部ツールやデバッグ用に維持 |
| REST サーバー (pre-processor:9200) | 外部ツールやデバッグ用に維持 |
| REST ドライバー実装 | 将来の削除候補として残存 |

### メリット

1. **シンプルな設定**: 環境変数が減少
2. **保守性向上**: 条件分岐が削減
3. **一貫性**: 全ての内部通信が Connect-RPC に統一

### トレードオフ

1. **ロールバック**: REST への即座の切り戻しには再ビルドが必要
2. **REST ドライバー**: 使用されないコードが残存（将来削除予定）

## 実装

### 実装日

2026-01-10

### デプロイ手順

```bash
# ビルド
docker compose -f compose/compose.yaml build alt-backend search-indexer pre-processor

# デプロイ
docker compose -f compose/compose.yaml up -d alt-backend search-indexer pre-processor
```

### 検証

```bash
# サービス状態確認
docker compose ps alt-backend search-indexer pre-processor

# Connect-RPC エンドポイント確認
curl -s http://localhost:9301/health  # search-indexer Connect-RPC
curl -s http://localhost:9202/health  # pre-processor Connect-RPC
```

## 関連

- ADR-067: 内部サービス間通信の Connect-RPC 移行（計画）
- ADR-023: Connect-RPC 採用（フロントエンド ↔ バックエンド）
