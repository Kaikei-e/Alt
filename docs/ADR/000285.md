# tag-generator Docker 内 DNS 解決失敗の修正

## ADR ステータス

承認済み — 2026-02-28

## 背景

tag-generator コンテナが起動後16時間にわたり189サイクル連続で失敗し、記事処理数が0件だった。

**観測された症状:**

| レイヤー | 証拠 |
|---------|------|
| tag-generator | `ConnectError: [unavailable] error sending request for url (http://alt-backend:9000/...)` |
| pyqwest (Rust HTTP) | `dns error: failed to lookup address information: Name does not resolve` |
| cursor_manager | `AttributeError: 'NoneType' object has no attribute 'cursor'`（API モードでの二次エラー） |

tag-generator は Connect-RPC クライアントを介して alt-backend と通信するが、その HTTP 層で使用される pyqwest（Rust 製 HTTP クライアント）のビルトイン DNS リゾルバが Docker の内部 DNS（127.0.0.11）を参照できず、`alt-backend` のようなコンテナ名を解決できなかった。

**根本原因:** pyqwest はデフォルトで独自の DNS リゾルバ（trust-dns）を使用する。このリゾルバは `/etc/resolv.conf` を参照せず、Docker が提供する組み込み DNS サーバーを利用しないため、Docker Compose ネットワーク内のサービス名を解決できない。

加えて、DNS 失敗で API モードに入れない場合でも、`CursorManager.get_newest_article_cursor_position()` が `_NullDatabaseManager`（API モード用ダミー）から `None` を受け取って `cursor()` を呼び出し、`AttributeError` で二重障害していた。

## 意思決定

### 修正1: システム DNS リゾルバの強制使用

pyqwest の `SyncHTTPTransport(use_system_dns=True)` を使用して、`/etc/resolv.conf` 経由のシステム DNS リゾルバを強制する。これにより Docker の内部 DNS（127.0.0.11）が利用され、コンテナ名が正しく解決される。

### 変更対象ファイル

| ファイル | 変更内容 |
|----------|---------|
| `tag-generator/app/tag_generator/driver/connect_client_factory.py` | `SyncHTTPTransport(use_system_dns=True)` で作成した `SyncClient` を `BackendInternalServiceClientSync` に渡すよう変更 |
| `tag-generator/app/tag_generator/cursor_manager.py` | `get_newest_article_cursor_position()` 内で `conn is None` を早期チェックし、DB 問い合わせをスキップしてフォールバックカーソルを返すよう変更 |

### 修正2: API モードでのカーソル初期化エラー解消

`_NullDatabaseManager.get_connection()` が `yield None` を返す場合、DB クエリを試みず即座にフォールバックカーソル（現在時刻 + max UUID）を返す。これにより API モード起動時の `AttributeError` が解消される。

### 検証

| 検証項目 | 結果 |
|----------|------|
| `uv run pytest tests/unit/driver/test_connect_client_factory.py -v` | 全7テスト PASSED |
| `uv run pytest tests/unit/ -v` | 全383テスト PASSED |
| コンテナ再ビルド・再起動後のログ | DNS エラー消失、記事処理が正常に開始 |

## 結果・影響

### 利点

- Docker Compose 環境でのサービス間通信が正常に動作するようになった
- pyqwest のデフォルト DNS リゾルバに依存しないため、Docker・Kubernetes 等のコンテナオーケストレーション環境全般で堅牢に動作する
- API モード（`_NullDatabaseManager`）での起動が `AttributeError` で中断されなくなった
- 既存テストに変更なしで全てパス — 後方互換性を維持

### 欠点・トレードオフ

- `use_system_dns=True` はシステムの DNS リゾルバ（libc の `getaddrinfo`）を使用するため、trust-dns と比較して非同期 DNS ルックアップの恩恵を受けない。tag-generator のワークロード（バッチ処理、秒単位の推論時間）では DNS 解決のレイテンシは無視できる水準であり、実運用上の影響はない。

## 付録

- pyqwest `use_system_dns` オプション: Rust の `reqwest` クレートにおける `trust_dns(false)` に対応し、DNS 解決をシステムのネイティブリゾルバに委譲する
- Docker 内部 DNS: Docker デーモンは各コンテナの `/etc/resolv.conf` に `nameserver 127.0.0.11` を設定し、コンテナ名・サービス名の解決を提供する
