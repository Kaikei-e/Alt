# alt-perf パフォーマンス計測機能の堅牢化

## ステータス

採択（Accepted）

## コンテキスト

### 問題

alt-perf（Deno + Astral ベースのパフォーマンス計測 CLI）には以下の課題があった：

1. **計測の信頼性不足**: 単一計測では外れ値の影響を受けやすく、再現性に乏しい
2. **エラー耐性の欠如**: ネットワーク一時障害やブラウザタイムアウトで即座に失敗
3. **デバッグ困難**: 失敗時の原因特定が困難（スクリーンショット等なし）
4. **テスト未整備**: TDD 要件に対し、ユニットテストが未実装
5. **条件シミュレーション不可**: 低速ネットワーク環境の再現ができない

### 背景

パフォーマンス計測のベストプラクティス（2025）：

- **Core Web Vitals**: LCP < 2.5s, INP < 200ms, CLS < 0.1
- **統計的信頼性**: 複数回計測と信頼区間の算出
- **フィールド/ラボデータの区別**: 実環境とテスト環境の違いを考慮
- **リトライ戦略**: 一時的障害に対するスマートリトライ

## 決定

### 6フェーズでの段階的改善

| Phase | 内容 | 新規ファイル |
|-------|------|-------------|
| 1 | テストインフラ構築（TDD First） | 3 テストファイル |
| 2 | リトライ機構 | `src/retry/retry-policy.ts` |
| 3 | 統計分析モジュール | `src/measurement/statistics.ts` |
| 4 | デバッグ機能 | `src/debugging/*.ts` |
| 5 | ネットワークシミュレーション | `src/browser/network-conditions.ts` |
| 6 | 設定・レポート拡張 | 既存ファイル修正 |

### 主要設計

#### 1. リトライ機構

```typescript
interface RetryPolicy {
  maxAttempts: number;        // デフォルト: 3
  baseDelayMs: number;        // デフォルト: 1000
  backoffMultiplier: number;  // デフォルト: 2
  retryableErrors: string[];  // TimeoutError, NetworkError 等
}
```

- Exponential backoff with jitter
- 再試行可能なエラータイプのフィルタリング
- Circuit breaker パターン（将来拡張用）

#### 2. 統計分析

```typescript
interface StatisticalSummary {
  mean: number;
  median: number;
  stdDev: number;
  p95: number;
  p99: number;
  confidenceInterval: { lower: number; upper: number; level: number };
  outliers: number[];
  isStable: boolean;  // CV < 15%
}
```

- Welford のアルゴリズムによる数値安定性
- IQR 法による外れ値検出
- t 分布を用いた小サンプル信頼区間

#### 3. 複数回計測

```typescript
interface MultiRunConfig {
  runs: number;          // デフォルト: 5
  warmupRuns: number;    // デフォルト: 1
  cooldownMs: number;    // デフォルト: 2000
  discardOutliers: boolean;
}
```

#### 4. ネットワーク条件プリセット

| プリセット | Download | Latency |
|-----------|----------|---------|
| fast-3g | 1.5 Mbps | 100ms |
| slow-3g | 780 Kbps | 400ms |
| 4g | 12 Mbps | 50ms |
| offline | 0 | - |

Chrome DevTools Protocol (CDP) 経由で実装。

## 結果

### メリット

1. **信頼性向上**: 複数回計測と統計分析により、外れ値に左右されない安定した結果
2. **エラー耐性**: 一時的障害からの自動回復、失敗時のスクリーンショット取得
3. **再現性**: ネットワーク条件のシミュレーションにより、低速環境の問題を事前検出
4. **TDD 準拠**: 71 テストケースでコア機能をカバー
5. **拡張性**: 設定ベースで動作をカスタマイズ可能

### トレードオフ

1. **実行時間増加**: 5回計測 + warmup + cooldown で単一計測より約6倍
2. **複雑性増加**: 新規モジュール12ファイル追加
3. **CDP 依存**: 一部機能は Chrome DevTools Protocol に依存

### 代替案の検討

| 代替案 | 却下理由 |
|--------|----------|
| Lighthouse 直接利用 | Deno 環境での統合困難 |
| Playwright 採用 | Astral で十分、依存増加回避 |
| 外部統計ライブラリ | 軽量実装で十分、Deno 互換性優先 |

## 実装

### 実装日: 2026-01-09

### 新規ファイル

```
src/
  retry/
    retry-policy.ts          # リトライ戦略
  measurement/
    statistics.ts            # 統計計算
    multi-run-collector.ts   # 複数回計測
  debugging/
    screenshot.ts            # スクリーンショット
    trace.ts                 # パフォーマンストレース
    artifact-manager.ts      # アーティファクト管理
  browser/
    network-conditions.ts    # ネットワーク条件
    cache-controller.ts      # キャッシュ制御
tests/
  unit/
    statistics_test.ts       # 26 テストケース
    retry_policy_test.ts     # 17 テストケース
    vitals_test.ts           # 28 テストケース
```

### 修正ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/config/schema.ts` | RetryConfig, MultiRunConfig, DebugConfig 等追加 |
| `src/report/types.ts` | StatisticalMetrics, RetryInfo, ReliabilityMetrics 追加 |
| `src/measurement/vitals.ts` | getRating 関数のエクスポート |
| `deno.json` | @std/testing 依存追加 |

### 検証コマンド

```bash
# 型チェック
deno task check

# ユニットテスト実行
deno task test:unit

# リント
deno task lint
```

## 関連

- [Core Web Vitals](https://web.dev/vitals/)
- [Chrome DevTools Protocol](https://chromedevtools.github.io/devtools-protocol/)
- [Astral - Deno Browser Automation](https://jsr.io/@astral/astral)
- [Deno Testing](https://docs.deno.com/runtime/fundamentals/testing/)
