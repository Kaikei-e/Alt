# ADR-000294: テスト基盤・DX改善の5フェーズ包括実装

## ADR's STATUS

Accepted

## CONTEXT

Altプラットフォームの品質保証基盤と開発者体験（DX）に以下の課題があった：

1. **デプロイの手動性**: サービス更新のたびに手動でgit pull → build → compose upが必要
2. **開発環境のフィードバック遅延**: ソースコード変更時にコンテナ手動再起動が必要
3. **E2Eテストの不足**: Page Objectが限定的で、統合テスト・ビジュアルリグレッションテストが未整備
4. **Contract Testingの欠如**: フロントエンド-バックエンド間のAPIスキーマ整合性が手動確認のみ
5. **CI/CDパイプラインの未最適化**: パフォーマンステストやDBマイグレーション検証のCI化が未実施

これらを5フェーズに分割して段階的に実装する方針を決定した。

## DECISION MAKING

### Phase 1: Auto Deploy（自動デプロイシステム）

ランタイムマシンでのデプロイを自動化するsystemdベースのポーリングシステムを導入。

- `deploy-system/deploy-local.sh`: git fetch → diff検出 → `git pull --ff-only` → `altctl up --build` → smoke test の自動フロー
- `deploy-system/smoke-test.sh`: Backend/Frontend/Meilisearchの3エンドポイントヘルスチェック
- `deploy-system/systemd/alt-deploy.timer`: 5分間隔のsystemdタイマーポーリング
- `deploy-system/install.sh`: systemdユニットのインストーラ
- `deploy-system/README.md`: 運用手順ドキュメント

### Phase 2: Dev Environment（開発環境改善）

Docker Compose `develop.watch` によるホットリロード環境と開発効率化ツールを追加。

- `compose/dev.yaml`: alt-frontend-svに`action: sync`（srcディレクトリ同期）、alt-backendに`action: rebuild`（自動リビルド）を設定
- `alt-frontend-sv/package.json`: `dev:remote`（リモートアクセス用devサーバー）、`test:e2e:integration`、`test:coverage`スクリプト追加
- `Makefile`: `rust-clean`ターゲット追加（Rust全サービスのtarget/一括クリーン）
- `alt-frontend-sv/Dockerfile`: `--link`フラグ除去によるビルド互換性修正

### Phase 3: E2E Test拡充

Page Object Modelの拡充、統合テスト基盤、ビジュアルリグレッションテストを導入。

**新規Page Object（Desktop）:**
- `DesktopSearchPage.ts`, `DesktopSettingsPage.ts`, `DesktopSystemLoaderPage.ts`

**新規Page Object（Mobile）:**
- `MobileFeedsPage.ts`, `MobileRecapPage.ts`, `MobileStatsPage.ts`

**統合テスト基盤:**
- `tests/e2e/integration/feeds.spec.ts`, `search.spec.ts`: 実バックエンド接続の統合E2Eテスト
- `tests/e2e/integration/global-setup.ts`, `global-teardown.ts`: 統合テスト用のセットアップ/クリーンアップ
- `tests/e2e/fixtures/factories/sessionFactory.ts`: 認証モックデータのFactory

**ビジュアルリグレッション:**
- `tests/e2e/visual/desktop-feeds.visual.spec.ts`, `mobile-swipe.visual.spec.ts`

**Playwright設定拡張:**
- `playwright.config.ts`: `integration`プロジェクト（実バックエンド接続）と`visual-regression`プロジェクトを追加

### Phase 4: Contract Testing

フロントエンド-バックエンド間のAPIスキーマ整合性を自動検証する仕組みを導入。

**フロントエンド側:**
- `alt-frontend-sv/src/lib/schema/api-responses.ts`: REST APIレスポンスのTypeScript型定義
- `alt-frontend-sv/src/test/contracts/`: 4つのContract Test（article, feed, recap, rest-v1）
- `alt-frontend-sv/src/test/msw-setup.ts`: MSW（Mock Service Worker）セットアップ
- `alt-frontend-sv/vitest.config.ts`: V8カバレッジ設定追加（lines: 60%, branches: 50%, functions: 55%）

**バックエンド側:**
- `alt-backend/app/integration_tests/connect_contract_test.go`: Connect-RPCのContract Testスケルトン

**CI:**
- `.github/workflows/proto-contract.yaml`: Buf lint + breaking change検出 + Contract Conformanceテスト

### Phase 5: CI/DX最適化

パフォーマンステスト・DBマイグレーション検証のCI化。

- `.github/workflows/performance-smoke.yaml`: K6による週次パフォーマンススモークテスト（p95 < 500ms, エラー率 < 1%）
- `.github/workflows/recap-db-atlas.yaml`: Atlas DBマイグレーションのCI検証（checksum検証 + dry-run）
- `.github/workflows/alt-frontend-sv.yml`: 既存フロントエンドCIの最適化
- `altctl/internal/output/hints.go`: CLIヒント追加

## RESULTS, EFFECTS

### PROS

- **デプロイ自動化**: git pushからサービス更新まで完全自動（5分ポーリング + smoke test検証）
- **開発フィードバック高速化**: `docker compose watch`でソース変更→即座にコンテナ反映（フロントエンドはsync、バックエンドはrebuild）
- **テスト網羅性向上**: Page Object 6件追加、統合テスト2件、ビジュアルリグレッション2件、Contract Test 4件
- **APIスキーマ安全性**: proto変更時にCIでbreaking change検出 + Contract Testで型整合性保証
- **パフォーマンス監視**: K6週次テストでレイテンシ劣化の早期検知
- **DBマイグレーション安全性**: AtlasマイグレーションのCI検証でdry-run実行

### CONS, TRADEOFF

- **ポーリングベースのデプロイ**: Webhookベースに比べて最大5分のデプロイ遅延がある（許容範囲と判断）
- **CI実行時間の増加**: 3つのワークフロー追加により全体のCI実行時間が増加（ただし`paths`フィルタで関連ファイル変更時のみ発火）
- **カバレッジ閾値の段階的設定**: 初期閾値を保守的に設定（lines: 60%）し、段階的に引き上げ予定
- **systemdサービスのパス固定**: `alt-deploy.service`にワーキングディレクトリがハードコードされている（テンプレート変数化で対応）

## APPENDIX

### 変更対象ファイル

| カテゴリ | ファイル | 変更内容 |
|---------|---------|---------|
| Auto Deploy | `deploy-system/deploy-local.sh` | メインデプロイスクリプト |
| Auto Deploy | `deploy-system/smoke-test.sh` | ヘルスチェックスクリプト |
| Auto Deploy | `deploy-system/systemd/alt-deploy.{service,timer}` | systemdユニット |
| Auto Deploy | `deploy-system/install.sh` | インストーラ |
| Dev Env | `compose/dev.yaml` | Docker Compose watch設定 |
| Dev Env | `Makefile` | rust-cleanターゲット |
| Dev Env | `alt-frontend-sv/Dockerfile` | --linkフラグ除去 |
| Dev Env | `alt-frontend-sv/package.json` | 新規スクリプト3件 |
| E2E | `alt-frontend-sv/tests/e2e/pages/**` | Page Object 6件追加 |
| E2E | `alt-frontend-sv/tests/e2e/integration/**` | 統合テスト基盤 |
| E2E | `alt-frontend-sv/tests/e2e/visual/**` | ビジュアルリグレッション |
| E2E | `alt-frontend-sv/tests/e2e/fixtures/factories/**` | テストデータFactory |
| E2E | `alt-frontend-sv/playwright.config.ts` | 新プロジェクト2件追加 |
| Contract | `alt-frontend-sv/src/lib/schema/api-responses.ts` | API型定義 |
| Contract | `alt-frontend-sv/src/test/contracts/*.test.ts` | Contract Test 4件 |
| Contract | `alt-frontend-sv/src/test/msw-setup.ts` | MSWセットアップ |
| Contract | `alt-frontend-sv/vitest.config.ts` | カバレッジ設定 |
| Contract | `alt-backend/app/integration_tests/connect_contract_test.go` | Go側Contract Test |
| CI | `.github/workflows/performance-smoke.yaml` | K6パフォーマンステスト |
| CI | `.github/workflows/proto-contract.yaml` | Proto Contract検証 |
| CI | `.github/workflows/recap-db-atlas.yaml` | Atlasマイグレーション検証 |
| CI | `.github/workflows/alt-frontend-sv.yml` | フロントエンドCI最適化 |

### 関連ADR

- ADR-000289: nginx proxy_buffering off + progressイベント導入
- ADR-000292: Augurストリーミング30秒タイムアウト修正（ハートビート導入）
- ADR-000293: ハートビートをLLMストリーミングフェーズに拡張
