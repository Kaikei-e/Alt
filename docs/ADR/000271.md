# ADR-000271: alt-frontend-sv Docker ビルド最適化

## ステータス

承認済み

## コンテキスト

alt-frontend-sv (SvelteKit + Bun) の Docker ビルドパイプラインに以下の非効率があった:

1. **全 node_modules がランタイムイメージにコピー**: runner ステージが builder から node_modules 全体 (~1.5GB、devDependencies 含む) をコピーしていた。`@sveltejs/adapter-node` は `dependencies` のみを外部化するため、テストフレームワークやリンター等の devDependencies は本番イメージで不要
2. **BuildKit キャッシュマウント未使用**: `bun install` が毎回全パッケージをネットワークからダウンロード。`bun.lock` に変更がなくてもキャッシュが効かず、コールド・ウォームともにビルドが遅い
3. **visualizer プラグインが常時実行**: `rollup-plugin-visualizer` が全 `vite build` で動作し、Docker ビルドでは破棄される 2MB の `stats.html` を生成していた
4. **.dockerignore が不十分**: テストファイル、Playwright 設定、エディタ設定、レガシーの `pnpm-lock.yaml` (140KB) がビルドコンテキストに含まれていた
5. **ベースイメージ未固定**: `oven/bun:1-alpine` はリビルド時に意図せずバージョンが変わる可能性があった

Vite 設定自体は既に最適化済み (OXC minifier, esnext target, native plugins)。

## 意思決定

### prod-deps ステージによるマルチステージビルド分離

`bun install --frozen-lockfile --production` を実行する `prod-deps` ステージを新設。runner ステージは builder ではなく prod-deps から `node_modules` をコピーすることで、devDependencies を完全に除外する。

BuildKit は `deps` (ビルド用全依存) と `prod-deps` (ランタイム用本番依存) を並行実行するため、ステージ追加による壁時間の増加はゼロ。

### BuildKit キャッシュマウント

`deps` と `prod-deps` の両ステージに `--mount=type=cache,id=bun-alt-frontend-sv,target=/root/.bun/install/cache` を追加。Bun のパッケージキャッシュがビルド間で永続化され、lockfile 未変更時のインストールが大幅に高速化される。

BuildKit フロントエンド機能を有効化するため `# syntax=docker/dockerfile:1` ヘッダーを追加。

### visualizer プラグインの条件化

`vite.config.ts` を変更し、`ANALYZE=true` 環境変数が設定されている場合のみ `rollup-plugin-visualizer` を有効化。`package.json` の `build:analyze` スクリプトにこの変数を追加。通常ビルド (Docker 含む) では `stats.html` が生成されなくなった。

### .dockerignore 拡充

以下を除外対象に追加:
- `tests/`, `playwright.config.ts`, `playwright-report/`, `test-results/`
- `CLAUDE.md`
- `*.log`, `stats.html`
- `pnpm-lock.yaml` (レガシー)
- `.vscode/`

### レガシー pnpm-lock.yaml の削除

Bun への完全移行済みのため、リポジトリから `pnpm-lock.yaml` を削除。

### Bun バージョン固定

`oven/bun:1-alpine` から `oven/bun:1.3.10-alpine` に固定し、再現可能なビルドを保証。

### その他の最適化

- runner レイヤーに `COPY --link` を使用しキャッシュ再利用を改善
- builder ステージに `NODE_ENV=production` を設定し tree-shaking を最適化
- `RUN bun run prepare && bun run build` を 1 コマンドに統合しレイヤー数を削減

### 不採用案

| 不採用案 | 理由 |
|---------|------|
| Bun の代わりに Node.js alpine | Bun がプロジェクトのランタイム。切替は複雑性が増す |
| Distroless ベースイメージ | Bun は distroless をサポートしていない。alpine で十分軽量 |
| node_modules なしで build/ のみコピー | adapter-node はランタイムで `dependencies` を外部参照するため node_modules が必要 |

## 結果・影響

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `docker compose build alt-frontend-sv` | 成功 |
| コンテナヘルスチェック (`/sv/health`) | HTTP 200 |
| コンテナステータス | healthy |

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/Dockerfile` | 全面書き換え: BuildKit syntax, prod-deps ステージ, キャッシュマウント, COPY --link, バージョン固定 |
| `alt-frontend-sv/vite.config.ts` | visualizer を `ANALYZE=true` 時のみ有効化 |
| `alt-frontend-sv/package.json` | `build:analyze` スクリプトに `ANALYZE=true` を追加 |
| `alt-frontend-sv/.dockerignore` | テスト, ドキュメント, ログ, レガシー lockfile, エディタ設定を除外 |
| `alt-frontend-sv/pnpm-lock.yaml` | **削除** |

### PROS

- **イメージサイズ約 85% 削減**: ~1.6GB → 244MB (devDependencies 除外による)
- **ウォームリビルド高速化**: BuildKit キャッシュマウントにより `bun.lock` 未変更時の `bun install` が即座に完了
- **ビルド時間短縮**: visualizer が通常ビルドで実行されなくなり、ビルドあたり約 2 秒短縮
- **ビルドコンテキスト約 40% 縮小**: テスト・エディタ・レガシーファイルの除外
- **再現可能なビルド**: Bun バージョン固定により意図しないバージョンドリフトを防止
- **後方互換性**: 全変更が後方互換。`bun run build:analyze` で従来通り `stats.html` を生成可能

### CONS, TRADEOFF

- **インストールステージが 2 つ**: `deps` と `prod-deps` の並存。ただし BuildKit が並行実行するため壁時間は増加しない
- **Bun バージョン固定のメンテナンスコスト**: 新バージョン取り込みに手動更新が必要。ビルド再現性とのトレードオフ
- **BuildKit 依存**: `# syntax=docker/dockerfile:1` と `--mount=type=cache` は BuildKit が必要。Docker 23.0+ および Docker Desktop ではデフォルトで有効

## 付録

### Dockerfile ステージ依存グラフ

```
base (oven/bun:1.3.10-alpine)
 ├── deps        ──→ builder ──→ runner
 └── prod-deps   ─────────────→ runner
```

`deps` と `prod-deps` は並行実行。`builder` は `deps` に依存。`runner` は `builder` と `prod-deps` の両方からコピー。
