# 未対応サービスへのOTel準拠ロガー導入

## ADR's STATUS

Accepted

## CONTEXT

### 背景

ADR-98で定義されたOpenTelemetry準拠のログ基盤において、一部サービスがOTel対応されていなかった。

### 対応済みサービス（既存）

| サービス | 言語 | 状態 |
|---------|------|------|
| alt-backend | Go | OTel有効（MultiHandler） |
| pre-processor | Go | OTel有効（MultiHandler） |
| search-indexer | Go | OTel有効（MultiHandler） |
| auth-hub | Go | OTel有効（MultiHandler） |
| tag-generator | Python | LoggingInstrumentor有効 |
| news-creator | Python | LoggingInstrumentor有効 |

### 未対応サービス

| サービス | 言語 | 問題 | 優先度 |
|---------|------|------|--------|
| rag-orchestrator | Go | 基本JSONハンドラーのみ | HIGH |
| recap-subworker | Python | structlog（OTelなし） | HIGH |
| recap-evaluator | Python | structlog（OTelなし）、ADR 98未準拠 | MEDIUM |
| auth-token-manager | Deno | OTel互換JSON出力のみ | MEDIUM |
| alt-perf | Deno | OTel互換JSON出力のみ | LOW |

## DECISION MAKING

### 実装パターン

#### Go サービス（rag-orchestrator）

既存の `search-indexer` / `auth-hub` パターンを踏襲:

```go
// internal/infra/otel/provider.go
type Config struct {
    ServiceName    string
    ServiceVersion string
    Environment    string
    OTLPEndpoint   string
    Enabled        bool
}

func InitProvider(ctx context.Context, cfg Config) (ShutdownFunc, error)
```

```go
// internal/infra/logger/logger.go
type MultiHandler struct {
    handlers []slog.Handler  // [JSONHandler, OTelHandler]
}

func NewWithOTel(enableOTel bool) *slog.Logger
```

#### Python サービス（recap-subworker, recap-evaluator）

既存の `tag-generator` / `news-creator` パターンを踏襲:

```python
# infra/otel.py
class OTelConfig:
    service_name: str
    otlp_endpoint: str
    enabled: bool

def init_otel_provider(config: OTelConfig) -> Callable[[], None]
```

```python
# infra/logging.py
from opentelemetry.instrumentation.logging import LoggingInstrumentor

def configure_logging(level: str) -> None:
    init_otel_provider(otel_config)
    LoggingInstrumentor().instrument(set_logging_format=False)
```

#### Deno サービス（auth-token-manager, alt-perf）

npm パッケージを利用した OTLP エクスポート:

```typescript
// src/utils/otel.ts
import { logs } from "@opentelemetry/api-logs";
import { LoggerProvider, BatchLogRecordProcessor } from "@opentelemetry/sdk-logs";
import { OTLPLogExporter } from "@opentelemetry/exporter-logs-otlp-http";

export function initOTelProvider(config?: OTelConfig): () => void
export function emitOTelLog(level: string, message: string, attributes: Record<string, string | number | boolean>): void
```

### 環境変数（共通）

```bash
OTEL_SERVICE_NAME=<service-name>
OTEL_EXPORTER_OTLP_ENDPOINT=http://rask-log-aggregator:4318
OTEL_ENABLED=true
DEPLOYMENT_ENV=development
```

### ADR 98 ビジネスコンテキスト

すべてのサービスで以下の属性を出力:

| 属性キー | 用途 |
|---------|------|
| `alt.feed.id` | フィード追跡 |
| `alt.article.id` | 記事追跡 |
| `alt.job.id` | ジョブ追跡 |
| `alt.processing.stage` | 処理段階 |
| `alt.ai.pipeline` | AIパイプライン識別 |

## RESULTS, EFFECTS

### 変更ファイル

#### rag-orchestrator (Go)

| ファイル | 変更内容 |
|---------|---------|
| `internal/infra/otel/provider.go` | 新規作成：OTelプロバイダー |
| `internal/infra/logger/logger.go` | OTelHandler, MultiHandler追加 |
| `cmd/server/main.go` | OTel初期化呼び出し追加 |
| `go.mod` | OTel依存関係追加 |

#### recap-subworker (Python)

| ファイル | 変更内容 |
|---------|---------|
| `recap_subworker/infra/otel.py` | 新規作成：OTelプロバイダー |
| `recap_subworker/infra/logging.py` | LoggingInstrumentor統合 |
| `pyproject.toml` | OTel依存関係追加 |

#### recap-evaluator (Python)

| ファイル | 変更内容 |
|---------|---------|
| `src/recap_evaluator/utils/otel.py` | 新規作成：OTelプロバイダー |
| `src/recap_evaluator/utils/logging.py` | LoggingInstrumentor統合、ADR 98コンテキスト追加 |
| `src/recap_evaluator/main.py` | FastAPI計装追加 |
| `pyproject.toml` | OTel依存関係追加 |

#### auth-token-manager (Deno)

| ファイル | 変更内容 |
|---------|---------|
| `src/utils/otel.ts` | 新規作成：OTLPログエクスポーター |
| `src/utils/logger.ts` | OTelログ出力統合 |
| `main.ts` | シャットダウンハンドラ追加 |
| `deno.json` | OTel npm依存関係追加 |

#### alt-perf (Deno)

| ファイル | 変更内容 |
|---------|---------|
| `src/utils/otel.ts` | 新規作成：OTLPログエクスポーター |
| `src/utils/logger.ts` | OTelログ出力統合（オプトイン） |
| `deno.json` | OTel npm依存関係追加 |

### 依存関係

#### Go

```
go.opentelemetry.io/otel v1.33.0
go.opentelemetry.io/otel/exporters/otlp/otlplog/otlploghttp v0.9.0
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.33.0
go.opentelemetry.io/otel/log v0.9.0
go.opentelemetry.io/otel/sdk/log v0.9.0
```

#### Python

```
opentelemetry-sdk>=1.29.0
opentelemetry-exporter-otlp-proto-http>=1.29.0
opentelemetry-instrumentation-logging>=0.50b0
```

#### Deno

```json
"@opentelemetry/api-logs": "npm:@opentelemetry/api-logs@0.57.0"
"@opentelemetry/sdk-logs": "npm:@opentelemetry/sdk-logs@0.57.0"
"@opentelemetry/exporter-logs-otlp-http": "npm:@opentelemetry/exporter-logs-otlp-http@0.57.0"
```

### PROS

1. **統一されたログ基盤**: 全サービスがOTLP経由でログを送信
2. **分散トレーシング**: TraceId/SpanIdがログに自動付与
3. **ビジネスコンテキスト**: ADR 98準拠の `alt.*` 属性が全サービスで利用可能
4. **一元的な可観測性**: ClickHouse + Grafanaで全サービスのログを分析可能

### CONS, TRADEOFF

1. **依存関係の増加**: 各サービスにOTel SDKが追加される
2. **Deno npm互換性**: プロトコルバッファのビルドスクリプト警告が出る（動作には影響なし）
3. **alt-perfはオプトイン**: CLIツールのためデフォルトでOTel無効（`OTEL_ENABLED=true`で有効化）

## APPENDIX

### 検証方法

```bash
# サービス再ビルド・再起動
docker compose -f compose/compose.yaml -p alt build <service>
docker compose -f compose/compose.yaml -p alt up -d <service>

# ClickHouseで確認
SELECT TraceId, SpanId, ServiceName, Body
FROM otel_logs
WHERE ServiceName = '<service-name>'
  AND TraceId != '00000000000000000000000000000000'
ORDER BY Timestamp DESC
LIMIT 10
```

### 関連ADR

- ADR-98: ClickHouseログ基盤の包括的改善
- ADR-99: ログのビジネスコンテキスト追加（`alt.*`属性定義）

### 参考資料

- [OpenTelemetry Logs](https://opentelemetry.io/docs/concepts/signals/logs/)
- [OpenTelemetry Python Logging Instrumentation](https://opentelemetry-python-contrib.readthedocs.io/en/latest/instrumentation/logging/logging.html)
- [Go slog with OpenTelemetry](https://pkg.go.dev/go.opentelemetry.io/otel/log)
