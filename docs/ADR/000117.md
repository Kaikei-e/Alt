# Dispatch ステージのサブ進捗追跡改善

## ADR'S STATUS

Accepted

## CONTEXT

### 背景

Recap Job Status ページの Pipeline Progress 表示において、Dispatch ステージが長時間（クラスタリング + 要約生成）実行されるにもかかわらず、進捗状況が不明瞭であった。

現状の問題点:
1. Dispatch ステージは複数ジャンルを処理するため、完了まで数分かかる
2. ユーザーには単に「Dispatch 実行中」としか表示されない
3. 処理がハングしているのか、正常に進行中なのか判別できない

### 既存アーキテクチャ

```
Frontend (polling 5秒) → GET /api/v1/dashboard/job-progress
                       ↓
recap-worker API → recap_jobs, recap_subworker_runs テーブル
                       ↓
Response: ActiveJobInfo { current_stage, stages_completed, genre_progress }
```

`recap_subworker_runs` テーブルは既にジャンルごとの進捗を追跡していた（status: running/succeeded/failed, cluster_count）が、API レスポンスで活用されていなかった。

## DECISION MAKING

### 決定

1. **新規テーブル不要**: 既存の `recap_subworker_runs` データを活用
2. **API レスポンス拡張**: `SubStageProgress` 構造体を追加
3. **last_stage タイミングバグ修正**: ステージ実行中の正確な検出ロジック実装

### 技術的詳細

**last_stage のタイミング問題**

`last_stage` はステージ**完了後**に更新されるため、Dispatch 実行中は `last_stage = "evidence"` のまま。これにより `if job.last_stage == "dispatch"` が false になる問題があった。

**解決策**: ジャンル進捗データの有無で判定

```rust
fn is_dispatch_running(last_stage: Option<&str>, has_genre_progress: bool) -> bool {
    last_stage == Some("dispatch")
        || (last_stage == Some("evidence") && has_genre_progress)
}
```

**SubStageProgress 構造体**

```rust
pub struct SubStageProgress {
    pub phase: String,           // "clustering" | "summarization"
    pub total_genres: usize,     // 設定されたジャンル総数
    pub completed_genres: usize, // 完了したジャンル数
}
```

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 種別 | 内容 |
|----------|------|------|
| `recap-worker/src/api/dashboard.rs` | 変更 | `is_dispatch_running()` 関数追加、検出ロジック修正 |
| `recap-worker/src/store/models.rs` | 既存 | `SubStageProgress` 構造体（既に実装済み） |
| `alt-frontend-sv/src/lib/schema/dashboard.ts` | 既存 | TypeScript 型定義（既に実装済み） |
| `alt-frontend-sv/src/lib/components/.../PipelineProgress.svelte` | 既存 | UI 表示（既に実装済み） |

### 実装内容

1. **バックエンド**: Dispatch 実行中の正確な検出と `sub_stage_progress` 計算
2. **フロントエンド**: `(完了数/総数)` 形式の進捗表示

**UI 表示例**:
```
[✓ Fetch] — [✓ Preprocess] — [✓ Evidence] — [◉ Dispatch (5/20)] — [ Persist]
```

### テスト

```rust
#[test]
fn test_is_dispatch_running_when_last_stage_is_evidence_with_genre_progress() {
    // last_stage が "evidence" でもジャンル進捗があれば dispatch 実行中と判定
    assert!(is_dispatch_running(Some("evidence"), true));
}
```

### PROS

1. **可視性向上**: ユーザーは処理の進行状況をリアルタイムで確認可能
2. **既存インフラ活用**: 新規テーブル・マイグレーション不要
3. **後方互換性**: `sub_stage_progress` は null 許容のため既存クライアントに影響なし
4. **OTel 準拠ログ**: 既存の `alt.processing.*` 属性でデバッグ・監視が容易

### CONS, TRADEOFF

1. **ポーリング依存**: 5秒間隔のため、短時間ジョブでは更新が追いつかない可能性

## APPENDIX

### 検証手順

```bash
# ビルドと起動
docker compose -f compose/compose.yaml -p alt build recap-worker
docker compose -f compose/compose.yaml -p alt up -d recap-worker

# テスト実行
cd recap-worker/recap-worker && cargo test dashboard::tests

# ログ確認（OTel 属性）
docker compose -f compose/compose.yaml -p alt logs recap-worker -f | grep alt.processing
```

### OTel ログ属性

| 属性 | 説明 |
|------|------|
| `alt.processing.stage` | パイプラインステージ（dispatch） |
| `alt.processing.phase` | フェーズ（clustering/summarization） |
| `alt.processing.genre` | 処理中のジャンル名 |
| `alt.processing.progress.current` | 完了数 |
| `alt.processing.progress.total` | 総数 |

### 関連ADR

- ADR-109: Recap Job Status Dashboard 実装
- ADR-115: Recap Job Status ページのトリガーソース表示強化
- ADR-116: Start Job ボタン無効化の修正
