# pre-processor 7フェーズ段階的リファクタリング

## ADR's STATUS

Accepted (実装完了)

## CONTEXT

### 問題点

pre-processor は RSS フィード処理・記事要約を担う Go マイクロサービス。有機的な成長により以下の技術的負債が蓄積:

| # | 分類 | 問題 |
|---|------|------|
| 1 | 構造的問題 | `main.go` が約 400 行の God Function - 全 DI とサーバー起動が 1 関数に集中 |
| 2 | 構造的問題 | `handler/` に HTTP ハンドラとバックグラウンドジョブが混在 |
| 3 | 重複 | 要約ロジックが REST / ConnectRPC / QueueWorker の 3 箇所で重複 |
| 4 | デッドコード | 無効化されたフィード処理関連で約 1,890 行のデッドコード |
| 5 | パフォーマンス | バッチ処理が逐次実行 (並行処理なし) |
| 6 | レイヤー違反 | `quality_checker` が `*pgxpool.Pool` を直接受け取る |
| 7 | モデル分散 | `models/` と `domain/` にドメインモデルが散在 |

### 方針

7 フェーズの段階的リファクタリングで、各フェーズ後にデプロイ可能な状態を維持。Clean Architecture (Handler → Usecase → Port → Gateway → Driver) に準拠。

## DECISION MAKING

### Phase 1: デッドコード削除

約 1,890 行の不要コードを除去:

| ファイル | アクション |
|---------|-----------|
| `service/feed_processor_enhanced.go` | 全削除 (327 行) |
| `handlers/pagination.go` | 全削除 (191 行, レガシーパッケージ) |
| `service/proxy_metrics.go` | 全削除 (672 行, 無効化されたフェッチのみ使用) |
| `service/feed_processor.go` | インターフェーススタブのみに簡略化 |
| `service/article_fetcher.go` | ValidateURL + SSRF 防御のみ残存 |
| `handler/job_handler.go` | フィード処理ループを削除 |
| `main.go` | feedProcessorService 初期化を削除 |

### Phase 2: ドメインモデル統合

`models/` パッケージを `domain/` に統合:

- `models/article.go` → `domain/article.go`
- `models/article_summary.go` → `domain/article.go` (同ファイル)
- `models/summarize_job.go` → `domain/job.go`
- 全 import を `models` → `domain` に更新
- `models/` パッケージを削除

結果型の統一:
- `ProcessingResult`, `SummarizationResult`, `QualityResult` の共通フィールドを `domain/result.go` に `BatchResult` として統合
- `domain/cursor.go` にカーソル型を統一

### Phase 3: 要約ユースケース抽出

3 箇所で重複する要約ロジックを `usecase/summarize/` に統一:

```
usecase/summarize/
├── on_demand.go       # 共通要約ロジック (ResolveArticle + Summarize)
└── on_demand_test.go  # ユニットテスト
```

`OnDemandService` が記事取得・HTML 抽出・API 呼び出し・DB 保存の共通フローを実装:

```go
type OnDemandService struct {
    articleRepo repository.ArticleRepository
    summaryRepo repository.SummaryRepository
    apiRepo     repository.ExternalAPIRepository
    logger      *slog.Logger
}
```

REST ハンドラ・ConnectRPC ハンドラ・キューワーカーは薄いラッパーに変更。

### Phase 4: ジョブオーケストレーター抽出

コピペされたジョブループパターンを汎用 `orchestrator/` パッケージに統一:

```
orchestrator/
├── runner.go       # JobRunner + JobGroup
└── runner_test.go  # ユニットテスト
```

**JobRunner**: ticker ベースのジョブ実行基盤。指数バックオフ・ヘルスチェック待機に対応:

```go
type JobConfig struct {
    Name            string
    Interval        time.Duration
    InitialBackoff  time.Duration
    MaxBackoff      time.Duration
    BackoffOnErrors []error
    WaitForHealthy  bool
}
```

**JobGroup**: 複数 JobRunner の登録・起動・停止をまとめて管理。`Add()` で即座に goroutine を起動:

```go
func (g *JobGroup) Add(runner *JobRunner) {
    g.runners = append(g.runners, runner)
    runner.Start(g.ctx)
}
```

不要になった `handler/job_scheduler.go` を削除。

### Phase 5: bootstrap 分解

約 400 行の `main.go` を構造化された `bootstrap/` パッケージに分解:

```
bootstrap/
├── wire.go       # DI 構築 (BuildDependencies)
├── server.go     # HTTP + ConnectRPC サーバー組み立て
└── lifecycle.go  # シグナルハンドリング、graceful shutdown、ジョブ起動
```

`main.go` は約 60 行の薄いエントリポイントに縮小:

```go
func main() {
    if healthcheck { healthcheck.Run(); return }
    if err := bootstrap.Run(context.Background()); err != nil { log.Fatal(err) }
}
```

`SummarizeServiceAdapter` を `package main` から `consumer/summarize_adapter.go` に移動。

### Phase 6: レイヤー違反修正 + QA 改善

**レイヤー違反修正**:
- `service/quality_checker.go` から nil チェックガードを削除 (テストで適切なモックを使用)
- `service/article_summarizer.go` から nil チェックガードを削除

**重複プレースホルダー解消**:
- `ErrContentTooShort` / `ErrContentTooLong` の重複処理パターンを `placeholderMessage()` と `savePlaceholder()` に統合

**テスト品質改善**:
- nil リポジトリを渡すテストを適切なスタブ/モックに置換
- 不要なテストケースを削除

### Phase 7: パイプライン並行処理

I/O バウンドのバッチ処理を並行化する汎用パイプライン基盤を `orchestrator/pipeline.go` に実装:

```
orchestrator/
├── pipeline.go       # RunStage[In, Out] 汎用パイプライン
└── pipeline_test.go  # ユニットテスト (6 ケース)
```

Go generics によるセマフォベースの bounded concurrency:

```go
type Stage[In, Out any] struct {
    Name        string
    Concurrency int
    Process     func(ctx context.Context, input In) (Out, error)
}

func RunStage[In, Out any](ctx context.Context, stage Stage[In, Out], inputs []In) []Result[Out]
```

- 入力順序を保持したまま並行処理
- `context.Context` によるキャンセル伝播
- セマフォで並行数を制限 (news-creator の処理能力に基づく)
- レースコンディションなし (`go test -race` 通過)

## RESULTS, EFFECTS

### 変更ファイル一覧

| 操作 | ファイル/パッケージ | Phase | 変更内容 |
|------|-------------------|-------|---------|
| 削除 | `service/feed_processor_enhanced.go` | 1 | デッドコード 327 行削除 |
| 削除 | `handlers/` パッケージ | 1 | レガシーパッケージ全削除 |
| 削除 | `service/proxy_metrics.go` | 1 | デッドコード 672 行削除 |
| 削除 | `handler/job_scheduler.go` | 4 | 未使用のジョブスケジューラー |
| 削除 | `models/` パッケージ | 2 | domain/ に統合 |
| 削除 | `summarize_service_adapter.go` (main) | 5 | consumer/ に移動 |
| 修正 | `service/feed_processor.go` | 1 | スタブのみに簡略化 |
| 修正 | `service/article_fetcher.go` | 1 | 無効化コード削除 |
| 修正 | `service/article_summarizer.go` | 6 | nil ガード削除 + プレースホルダー統合 |
| 修正 | `service/quality_checker.go` | 6 | nil ガード削除 + レイヤー整理 |
| 修正 | `handler/job_handler.go` | 1,4 | フィードループ削除 + orchestrator 移行 |
| 修正 | `handler/interfaces.go` | 4 | JobScheduler インターフェース削除 |
| 修正 | `handler/summarize_handler.go` | 3 | OnDemandService に委譲 |
| 修正 | `connect/v2/preprocessor/handler.go` | 3 | OnDemandService に委譲 |
| 修正 | `main.go` | 1,4,5 | 約 400 行 → 約 60 行に縮小 |
| 修正 | `domain/` | 2 | models/ からの統合 + result.go + cursor.go |
| 修正 | `test/mocks/handler_mocks.go` | 4 | MockJobScheduler 削除 |
| 修正 | 全 import パス | 2 | `models` → `domain` |
| 新規 | `usecase/summarize/on_demand.go` | 3 | 共通要約ロジック |
| 新規 | `usecase/summarize/on_demand_test.go` | 3 | ユニットテスト |
| 新規 | `orchestrator/runner.go` | 4 | JobRunner + JobGroup |
| 新規 | `orchestrator/runner_test.go` | 4 | ユニットテスト |
| 新規 | `orchestrator/pipeline.go` | 7 | 汎用並行パイプライン |
| 新規 | `orchestrator/pipeline_test.go` | 7 | ユニットテスト (6 ケース) |
| 新規 | `bootstrap/wire.go` | 5 | DI 構築 |
| 新規 | `bootstrap/server.go` | 5 | HTTP + ConnectRPC サーバー |
| 新規 | `bootstrap/lifecycle.go` | 5 | シグナル処理 + graceful shutdown |
| 新規 | `consumer/summarize_adapter.go` | 5 | Redis Consumer アダプター |

### テスト結果

全 CI チェック通過:

| チェック | 結果 |
|---------|------|
| `gofmt` | PASS |
| `go vet ./...` | PASS |
| `golangci-lint run` | PASS (0 issues) |
| `go test ./...` | PASS (全パッケージ) |
| `go test -race ./...` | PASS (レースコンディションなし) |

### 動作確認

- Docker ビルド: `docker compose build pre-processor` → 成功
- コンテナ起動: `docker compose up -d pre-processor` → 成功
- ヘルスチェック: `curl http://localhost:9200/api/v1/health` → `{"status":"healthy"}`

### PROS

1. **コード量削減**: デッドコード約 1,890 行削除、main.go を約 400 → 60 行に縮小
2. **重複排除**: 3 箇所の要約ロジックを 1 つの `OnDemandService` に統一
3. **関心の分離**: bootstrap (DI/サーバー/ライフサイクル)、orchestrator (ジョブ実行)、usecase (ビジネスロジック) を明確に分離
4. **テスタビリティ向上**: nil リポジトリではなく適切なモック/スタブによるテスト
5. **ドメインモデル統一**: `models/` と `domain/` の二重管理を解消
6. **並行処理基盤**: generics ベースの `RunStage` でバッチ処理の並行化が容易に
7. **ジョブ管理の統一**: 4 つのコピペジョブループを宣言的な `JobRunner` / `JobGroup` に統一
8. **CI 品質**: gofmt / go vet / golangci-lint / go test 全パスの状態を維持

### CONS, TRADEOFF

1. **パッケージ数の増加**: `orchestrator/`, `usecase/`, `bootstrap/`, `consumer/` の新規パッケージ追加でディレクトリ構造が深くなる。ただし各パッケージの責務は明確
2. **Phase 7 の並行パイプラインは基盤のみ**: `RunStage` を実際のバッチ要約処理に適用するには、呼び出し側の追加変更が必要
3. **bootstrap の学習コスト**: main.go の一覧性が失われ、DI の流れを理解するには `wire.go` → `server.go` → `lifecycle.go` を追う必要がある

## APPENDIX

### フェーズ依存関係

```
Phase 1 (デッドコード削除)
    │
    ▼
Phase 2 (ドメインモデル統合)
    │
    ▼
Phase 3 (要約ユースケース抽出) ──→ Phase 4 (ジョブオーケストレーター)
                                           │
                                           ▼
                                   Phase 5 (bootstrap 分解)
                                           │
                                           ▼
                                   Phase 6 (レイヤー違反修正 + QA)
                                           │
                                           ▼
                                   Phase 7 (パイプライン並行処理)
```

### パッケージ構造 (リファクタリング後)

```
app/
├── main.go                 # 薄いエントリポイント (~60 行)
├── bootstrap/              # DI・サーバー・ライフサイクル
│   ├── wire.go
│   ├── server.go
│   └── lifecycle.go
├── domain/                 # エンティティ・値オブジェクト・エラー
├── repository/             # リポジトリインターフェース + 実装
├── usecase/
│   └── summarize/          # 要約ユースケース
├── handler/                # HTTP ハンドラ + ジョブハンドラ
├── connect/                # ConnectRPC ハンドラ
├── consumer/               # Redis Consumer アダプター
├── orchestrator/           # ジョブ実行基盤 + パイプライン
│   ├── runner.go
│   └── pipeline.go
├── service/                # ビジネスロジック
├── driver/                 # データベースドライバー
└── test/mocks/             # モック
```

### 関連 ADR

- ADR-000188: search-indexer Clean Architecture リファクタリング (同一アーキテクチャパターンの先行実装)
