# ADR-000278: Lighthouse Performance 改善 Phase 2 — SSR 有効化による LCP 最適化

## ステータス

承認済み

## コンテキスト

### ADR-277 の結果と残存課題

ADR-277 で `fetchpriority="high"`, `loading="eager"`, nginx gzip/cache, カラーコントラスト修正を適用したが、Lighthouse 再計測の結果 Performance スコアが改善されなかった。

| カテゴリ | Phase 1 前 | Phase 1 後 |
|---------|-----------|-----------|
| Performance | 75 | 71（悪化） |
| Accessibility | 95 | 95 |
| Best Practices | 77 | 77 |

### 根本原因の特定: LCP Resource Load Delay

Lighthouse の `lcp-breakdown-insight` を分析し、LCP 4.3s の内訳を特定した:

| LCP サブパート | 時間 | 評価 |
|---------------|------|------|
| TTFB | 269ms | OK |
| Resource Load Delay | 7,068ms | 致命的 |
| Resource Load Duration | 167ms | OK |
| Element Render Delay | 348ms | OK |

**7,068ms の Resource Load Delay** は、ブラウザが LCP 画像の URL を知るまでの待ち時間を意味する。`ssr = false` のため、以下のチェーンが発生していた:

```
HTML shell (空) → JS download → JS execute → Connect-RPC API call
→ Feed data 取得 → Article content API call → og_image_url 取得
→ ようやく <img> をレンダリング
```

ADR-277 で適用した `fetchpriority="high"` と `loading="eager"` は正しく動作していたが、**画像 URL が初期 HTML に存在しないため、ブラウザがリソースを発見できない**。これが Phase 1 の修正が効かなかった根本原因。

### Lighthouse スコアリングにおける影響

| メトリクス | 値 | スコア | ウェイト | 寄与 |
|-----------|-----|-------|---------|------|
| FCP | 0.9s | 1.0 | 10% | 10.0% |
| SI | 10.8s | 0.06 | 10% | 0.6% |
| LCP | 4.3s | 0.41 | 25% | 10.25% |
| TBT | 250ms | 0.84 | 30% | 25.2% |
| CLS | 0.001 | 1.0 | 25% | 25.0% |

LCP (25%) + SI (10%) = 35% のウェイトが CSR に起因する低スコアで占められていた。

### カラーコントラスト修正の不足（ADR-277 残存）

ADR-277 で適用した `bg-[rgba(255,255,255,0.15)]` は、Lighthouse が backdrop-blur を無視してボタン単体の色で計算するため、コントラスト比 1.65 で WCAG AA (4.5:1) 未達だった。

## 意思決定

### 1. visual-preview ページの SSR 有効化

web.dev の公式ガイドに基づき SSR を有効化した:

> "Server-side rendering ensures your image resources will be discoverable from the HTML source"
> "Client-side rendering is one of the worst approaches for resource load delay"

SvelteKit のページオプションにより、子ページが親レイアウトの `ssr = false` をオーバーライドできる仕様を利用。

**`+page.server.ts` (新規作成)** — サーバー側データ取得:
- `getFeedsWithCursor()` で Connect-RPC 経由でフィード一覧取得
- `fetchArticleContent()` で初回カードの OGP 画像 URL をサーバー側で取得
- `firstArticleImageUrl`, `firstArticleContent`, `firstArticleId` をページデータとして返却

**`+page.ts`** — SSR オーバーライド:
- `export const ssr = true` で親レイアウトの `ssr = false` を上書き
- クライアント側 load ロジック（`getFeedsWithCursorClient` 等）を削除

既存のサーバー側インフラ（`createServerTransport`, `getFeedsWithCursor`, `fetchArticleContent`）をそのまま利用。新しい API やライブラリの追加は不要。

### 2. LCP 画像の `<link rel="preload">` 追加

`<svelte:head>` に条件付きで preload ヒントを追加:

```html
{#if data.firstArticleImageUrl}
  <link rel="preload" as="image" href={url} fetchpriority="high" />
{/if}
```

SSR 時にこのタグが初期 HTML に含まれるため、ブラウザは JS の実行を待たずに LCP 画像の取得を開始できる。

### 3. SSR データの articlePrefetcher キャッシュ連携

サーバーで取得した記事データをクライアント側の `articlePrefetcher` キャッシュに `seedCache()` で注入。これにより:
- SSR → ハイドレーション後のクライアント側コンポーネントが同じデータを再取得しない
- `SwipeFeedScreen` の `currentOgImage` が SSR 時の `initialOgImageUrl` をフォールバックとして使用

### 4. カラーコントラスト再修正

`bg-[rgba(255,255,255,0.15)]` → `bg-[#4a5568]` (slate-600 相当) に変更。

`#4a5568` 上の白文字: コントラスト比 **7.0:1** (WCAG AA 4.5:1 / AAA 7:1 を達成)。

### 不採用案

| 不採用案 | 理由 |
|---------|------|
| ページ全体の CSR 維持 + `<link rel="preload">` のみ追加 | `ssr = false` では preload タグも初期 HTML に含まれないため効果なし |
| Service Worker によるプリキャッシュ | 初回訪問時には効果がなく、LCP Resource Load Delay の解決にならない |
| 親レイアウト全体を `ssr = true` に変更 | 他ページの TanStack Query / MediaQuery ハイドレーション問題が再発する |

## 結果・影響

### 動作確認

| 確認項目 | 結果 |
|---------|------|
| `bun run build` | 正常完了 |
| alt-frontend-sv コンテナ再ビルド+再起動 | healthy |
| `<title>Visual Preview - Alt</title>` が初期 HTML に存在 | 確認済み (SSR 動作) |
| 認証なしアクセスでエラーなし（空フィード） | HTTP 200 |

### 期待効果

| メトリクス | Phase 1 後 | Phase 2 後 (予測) | 根拠 |
|-----------|-----------|------------------|------|
| LCP | 4.3s | ~1.5-2.0s | Resource Load Delay が ~0ms に |
| SI | 10.8s | ~3.5-5.0s | 初期 HTML にコンテンツ存在 |
| Performance | 71 | 85-92 | LCP + SI で 35% ウェイトが大幅改善 |
| Accessibility | 95 | 向上 | カラーコントラスト 7.0:1 達成 |

### PROS

- 既存のサーバー側インフラ（transport, API client）を再利用。新規依存なし
- SvelteKit の `ssr` オプションのページ単位オーバーライドにより、他ページへの影響がない
- `articlePrefetcher.seedCache()` でサーバーデータとクライアントキャッシュの一貫性を担保
- カラーコントラスト修正は背景画像に依存しない固定色のため、確実に WCAG AA/AAA 準拠

### CONS, TRADEOFF

- サーバー側で `fetchArticleContent` を呼ぶため、TTFB がわずかに増加する可能性がある（記事取得に失敗しても空データでフォールバックし、ページ表示自体はブロックしない）
- `ssr = true` によりサーバー側レンダリングが発生するため、`useViewport` 等のブラウザ依存コードがサーバーで実行される。既存の実装が `browser` ガードを持っているため問題ないが、今後追加するブラウザ依存ロジックには注意が必要
- フッターボタンの `bg-[#4a5568]` は glassmorphism の半透明感を犠牲にしている。デザイン上のトレードオフ

## 付録

### 変更ファイル一覧

| ファイル | 変更 |
|---------|------|
| `.../visual-preview/+page.server.ts` | **新規作成**: サーバー側データ取得 (feeds + first article) |
| `.../visual-preview/+page.ts` | `ssr = true` に変更、クライアント load 削除 |
| `.../visual-preview/+page.svelte` | サーバーデータ利用、`<link rel="preload">` 追加、prefetcher キャッシュ連携 |
| `.../swipe/SwipeFeedScreen.svelte` | `initialOgImageUrl` prop 追加、`currentOgImage` に SSR フォールバック追加 |
| `.../swipe/VisualPreviewCard.svelte` | `bg-[rgba(255,255,255,0.15)]` → `bg-[#4a5568]` (全箇所) |

### 参考資料

- [Optimize LCP - web.dev](https://web.dev/articles/optimize-lcp)
- [LCP Resource Load Delay - DebugBear](https://www.debugbear.com/blog/lcp-resource-load-delay)
- [Lighthouse Performance Scoring - Chrome DevDocs](https://developer.chrome.com/docs/lighthouse/performance/performance-scoring)
- [SvelteKit Page Options](https://svelte.dev/docs/kit/page-options)
