# visual-preview OGP画像非表示バグの修正

## ADR's STATUS

完了

## CONTEXT

visual-previewモード（スワイプUI）でOGP画像が表示されない問題が報告された。
コンテナログの解析およびデータフロー全体のコードトレースにより根本原因を特定した。

### OGP画像の表示チェーン

visual-previewモードでは、以下の優先順位でOGP画像が解決される:

1. `articlePrefetcher`キャッシュ（`batchPrefetchImages` RPC経由で非同期取得）
2. `activeFeed.ogImageProxyUrl`（フィードAPI応答に含まれるHMAC署名付きプロキシURL）
3. `initialOgImageUrl`（SSRフォールバック、最初のカードのみ）

### 発見された問題

クライアントサイドのフィード取得関数 `connectFeedToRenderFeed`（`alt-frontend-sv/src/lib/api/client/feeds.ts`）が、
バックエンドから返される`ogImageProxyUrl`フィールドを`RenderFeed`オブジェクトにマッピングしていなかった。

```typescript
// 修正前: ogImageProxyUrl が欠落
function connectFeedToRenderFeed(item: ConnectFeedItem): RenderFeed {
    return {
        id: item.id,
        title: item.title,
        // ... 他フィールド ...
        excerpt: generateExcerptFromDescription(item.description),
        // ogImageProxyUrl が含まれていない
    };
}
```

### 影響範囲

| ロードパス | ogImageProxyUrl | 状態 |
|-----------|----------------|------|
| SSR初期ロード（最初3件） | `+page.server.ts`で手動追加 | 正常 |
| クライアントサイド loadMore（4件目以降） | `connectFeedToRenderFeed`でドロップ | 全件バグ |

SSR経由のフィード（初期3件）は`+page.server.ts`内で明示的に`ogImageProxyUrl`を付与していたため正常動作していたが、
クライアントサイドの`loadMore()`で取得される4件目以降のフィードでは常に`ogImageProxyUrl`が`undefined`となり、
OGP画像の解決チェーンのステップ2が機能していなかった。

## DECISION MAKING

### データフロー全体の調査

バックエンド → フロントエンドの全レイヤーを調査し、問題箇所を1つに特定した:

1. **DB層**: `feeds.og_image_url`カラムにRSSフィードから抽出した画像URLを格納 → 正常
2. **Gateway層**: `derefString(feed.OgImageURL)`で`*string` → `string`変換 → 正常
3. **Handler層**: `enrichWithProxyURLs()`でHMAC署名付きプロキシURLを生成 → 正常
4. **Proto変換**: `convertFeedsToProto()`で`OgImageProxyURL`をprotoフィールドにマッピング → 正常
5. **フロントエンド サーバーサイド**: `connectFeedToBackendFormat()`で`ogImageProxyUrl`を`og_image_proxy_url`にマッピング → 正常
6. **フロントエンド クライアントサイド**: `connectFeedToRenderFeed()`で`ogImageProxyUrl`が**欠落** → バグ

### 修正内容

`connectFeedToRenderFeed`に`ogImageProxyUrl`フィールドを追加:

```typescript
function connectFeedToRenderFeed(item: ConnectFeedItem): RenderFeed {
    return {
        // ... 既存フィールド ...
        excerpt: generateExcerptFromDescription(item.description),
        ogImageProxyUrl: item.ogImageProxyUrl,
    };
}
```

## RESULTS, EFFECTS

### PROS

- クライアントサイドでロードされるフィード（4件目以降）でOGP画像が正しく表示されるようになった
- SSR/クライアント間のデータモデルの一貫性が確保された
- 修正は1行の追加のみで、リグレッションリスクが極めて低い

### CONS, TRADEOFF

- なし

## APPENDIX

### 関連ファイル

- `alt-frontend-sv/src/lib/api/client/feeds.ts` — 修正対象
- `alt-frontend-sv/src/lib/components/mobile/feeds/swipe/SwipeFeedScreen.svelte` — OGP画像解決ロジック
- `alt-frontend-sv/src/routes/(app)/feeds/swipe/visual-preview/+page.server.ts` — SSR側（正常動作）
- `alt-backend/app/connect/v2/feeds/handler.go` — `enrichWithProxyURLs`（正常動作）

### 型定義の整合性

- `ConnectFeedItem.ogImageProxyUrl?: string` — Connect-RPCレスポンス型（定義済み）
- `RenderFeed.ogImageProxyUrl?: string` — 表示用型（定義済み）
- `connectFeedToRenderFeed` — 上記2型間の変換関数（ここだけ欠落していた）
