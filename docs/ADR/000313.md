# ADR-000313: FetchArticleContent 外部 HTTP エラーの適切なステータスコード変換

## ADR's STATUS

完了

## CONTEXT

ADR-311 の OGP 画像プロキシ修正後、本番環境の HAR ファイル（133 エントリ）を再解析した結果、FetchArticleContent エンドポイントに 1 件の 500 Internal Server Error が検出された。

### 発生していたエラー

| Status | エンドポイント | エラー内容 |
|--------|---------------|-----------|
| **500** | `FetchArticleContent` | 外部サイト（dev.to）が HTTP 404 を返却 → バックエンドが 500 に変換 |

### 根本原因

Gateway 層で外部サイトからの HTTP エラー（404, 403, 429 等）を `fmt.Errorf("unexpected status code %d for %q", ...)` という非型付きエラーで返していた。Usecase 層が `fmt.Errorf("fetch failed: %w", err)` でラップした後、Handler 層では `ComplianceError` でも `DeadlineExceeded` でもないため、すべて `HandleInternalError()` → `CodeInternal`（HTTP 500）に変換されていた。

```
外部サイト → HTTP 404
  ↓
fetch_article_gateway.go → fmt.Errorf("unexpected status code 404 for %q")
  ↓
fetch_article_usecase.go → fmt.Errorf("fetch failed: %w", err)
  ↓
handler.go → ComplianceError でも DeadlineExceeded でもない → HandleInternalError()
  ↓
クライアントに CodeInternal (HTTP 500) が返る ❌
```

外部サイトの 404 はバックエンドの内部エラーではなく、クライアントに正しいセマンティクスで伝えるべき情報である。

## DECISION MAKING

### 方針: 型付きエラーによるレイヤー横断のステータス伝搬

Domain 層に `ExternalHTTPError` 型を導入し、Gateway → Usecase → Handler の各レイヤーを `errors.As()` で型安全に判別する。Go の標準エラーラッピング（`%w`）により、途中の Usecase 層が `fmt.Errorf("fetch failed: %w", err)` でコンテキストを付加しても、Handler 層で元の型を取り出せる。

### レイヤーごとの変更

#### 1. Domain 層: `ExternalHTTPError` 型の追加

```go
type ExternalHTTPError struct {
    StatusCode int
    URL        string
}

func (e *ExternalHTTPError) Error() string {
    return fmt.Sprintf("unexpected status code %d for %q", e.StatusCode, e.URL)
}
```

既存の `ComplianceError` と同じパターンに従う。`StatusCode` と `URL` を保持し、Handler 層でのマッピングに必要な情報を型安全に提供する。

#### 2. Gateway 層: 型付きエラーの返却

```go
// Before
return nil, fmt.Errorf("unexpected status code %d for %q", resp.StatusCode, parsedURL.String())

// After
return nil, &domain.ExternalHTTPError{StatusCode: resp.StatusCode, URL: parsedURL.String()}
```

#### 3. Handler 層: Connect-RPC コードへのマッピング

既存の `ComplianceError` チェックの後、`DeadlineExceeded` チェックの前に追加:

| 外部 HTTP ステータス | Connect-RPC コード | 意味 |
|---------------------|-------------------|------|
| 404, 410 | `CodeNotFound` | 記事が存在しない／削除済み |
| 401, 403 | `CodePermissionDenied` | 外部サイトによるアクセス拒否 |
| 429 | `CodeResourceExhausted` | 外部サイトのレート制限 |
| その他（5xx 等） | `CodeUnavailable` | 外部サイトの一時的な障害 |

マッピングの順序は、より具体的なエラー（ComplianceError）→ 外部 HTTP エラー → タイムアウト → 汎用内部エラーの順とした。

## RESULTS, EFFECTS

### テスト

TDD（RED → GREEN）で実装。

#### Gateway テスト（6 パターン）

| サブテスト | 検証内容 |
|-----------|---------|
| `404 Not Found` | `ExternalHTTPError{StatusCode: 404}` が返る |
| `403 Forbidden` | `ExternalHTTPError{StatusCode: 403}` が返る |
| `410 Gone` | `ExternalHTTPError{StatusCode: 410}` が返る |
| `429 Too Many Requests` | `ExternalHTTPError{StatusCode: 429}` が返る |
| `500 Internal Server Error` | `ExternalHTTPError{StatusCode: 500}` が返る |
| `503 Service Unavailable` | `ExternalHTTPError{StatusCode: 503}` が返る |

#### Handler テスト（5 パターン）

| テスト名 | 検証内容 |
|---------|---------|
| `ExternalHTTPError_404_ReturnsNotFound` | 外部 404 → `CodeNotFound` |
| `ExternalHTTPError_410_ReturnsNotFound` | 外部 410 → `CodeNotFound` |
| `ExternalHTTPError_403_ReturnsPermissionDenied` | 外部 403 → `CodePermissionDenied` |
| `ExternalHTTPError_429_ReturnsResourceExhausted` | 外部 429 → `CodeResourceExhausted` |
| `ExternalHTTPError_500_ReturnsUnavailable` | 外部 500 → `CodeUnavailable` |

Handler テストでは `mockArticleUsecase` を導入し、Usecase 層と同じ `fmt.Errorf("fetch failed: %w", &ExternalHTTPError{...})` ラッピングを再現している。

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `alt-backend/app/domain/errors.go` | `ExternalHTTPError` 型追加 |
| 2 | `alt-backend/app/gateway/fetch_article_gateway/fetch_article_gateway.go` | `fmt.Errorf` → `&domain.ExternalHTTPError{}` |
| 3 | `alt-backend/app/connect/v2/articles/handler.go` | `errors.As` による Connect-RPC コードマッピング追加 |
| 4 | `alt-backend/app/gateway/fetch_article_gateway/fetch_article_gateway_test.go` | 非 2xx ステータスの型付きエラーテスト追加 |
| 5 | `alt-backend/app/connect/v2/articles/handler_test.go` | 5 パターンの Connect-RPC コードマッピングテスト追加 |

### PROS

- 外部サイトの 404/410 がクライアントに `CodeNotFound` として返り、フロントエンドが「記事が見つかりません」と適切に表示できる
- 外部サイトの 429 が `CodeResourceExhausted` として返り、フロントエンドがリトライ戦略を判断できる
- 外部サイトの一時障害（5xx）が `CodeUnavailable` として返り、内部障害（`CodeInternal`）と区別できる
- Go の `errors.As()` による型判別で、Usecase 層のラッピングを貫通して元のエラー情報を取得できる
- 既存の `ComplianceError` パターンに合わせた設計で、コードベースの一貫性を維持

### CONS, TRADEOFF

- `ExternalHTTPError` の StatusCode マッピングはハードコーディングされている。将来的に外部エラーの扱いが増えた場合、マッピングテーブルの拡張が必要
- REST レガシーハンドラー（`rest/article_handlers.go`）には同様のマッピングを追加していない。Connect-RPC v2 への移行完了後に REST ハンドラーは廃止予定のため、意図的に対象外とした

## APPENDIX

### 検証コマンド

```bash
cd alt-backend/app

# 対象パッケージのテスト
go test ./domain/... ./gateway/fetch_article_gateway/... ./connect/v2/articles/... -v

# ビルド確認
go build ./...
```

### 検証結果

- ユニットテスト: `go test ./domain/... ./gateway/fetch_article_gateway/... ./connect/v2/articles/...` 全 PASS
- ビルド: `go build ./...` 成功
- コンテナ再ビルド: `docker compose -f compose/compose.yaml -p alt up -d --build alt-backend` 成功
- ヘルスチェック: `GET /v1/health` → `{"database":"connected","status":"healthy"}`

### HAR 解析で確認された他のエラー（対処不要）

| # | Status | エンドポイント | 原因 | 判断 |
|---|--------|---------------|------|------|
| 76 | **0** (Pending) | `/v1/images/proxy/...` | ブラウザ側キャンセル（スワイプ遷移による再レンダー） | 正常動作 |
| 127 | **0** (WebSocket) | `ws://localhost:8081/` | Chrome 拡張機能のローカル接続 | Alt と無関係 |

### 関連 ADR

- [ADR-311](000311.md): OGP 画像プロキシ 502 エラーおよびレートリミッター連鎖障害の修正
- [ADR-312](000312.md): RegisterFeedsUsecase から mq-hub への ArticleCreated イベント発行
