# tag-generator Clean Architecture リファクタリングとセキュリティ強化

## ADR's STATUS

Accepted (Phase 1-6 実装完了)

## CONTEXT

### 問題点

tag-generator は Python 3.13 / FastAPI ベースの ML タグ抽出マイクロサービス (~5,500 LOC, 348 テスト)。KeyBERT, sentence-transformers, Fugashi を用いて記事からタグを抽出する。運用の中で以下の構造的課題が顕在化:

| # | 分類 | 問題 |
|---|------|------|
| 1 | アーキテクチャ | フラット構造 (`tag_generator/`, `article_fetcher/`, `tag_inserter/`) で Clean Architecture 未適用。プロジェクト規約の `Handler → Usecase → Port → Gateway → Driver` に従っていない |
| 2 | God Object | `BatchProcessor` (670 行) に 7 責務が混在 (フェッチ、処理、トランザクション、カーソル、メモリ管理、バックフィル、再生成) |
| 3 | DI 未導入 | `TagGeneratorService.__init__()` が全依存を直接生成。テスト時のモック差し替えが困難 |
| 4 | sync/async 混在 | メインループは sync、Redis consumer は async。`run_in_executor` のスレッディングハックで橋渡し |
| 5 | 型安全性不足 | `dict[str, Any]` がデータ受け渡しに多用され、ドメインモデルが不在 |
| 6 | セキュリティ | Redis イベントペイロード未検証 (サイズ制限なし)、ログへの機密情報混入リスク |
| 7 | 設定散在 | `os.getenv()` が各ファイルに散在し、設定の一元管理ができていない |

### 方針

6 フェーズをボトムアップ (依存の少ない層から順) に実施。各フェーズで `uv run pytest` 全パス + `uv run ruff check` をゲーティング条件とする。旧コードは薄い再エクスポートラッパーで後方互換を維持し、段階的に移行。

## DECISION MAKING

### Phase 1: ドメインモデルと型安全性

`dict[str, Any]` を frozen dataclass に置換し、型安全なデータ受け渡しを実現。

#### 新規ドメインモデル (`domain/models.py`)

| モデル | 用途 | 主要プロパティ |
|--------|------|---------------|
| `Article` | 記事データ | `id`, `title`, `content`, `created_at`, `feed_id`, `url` |
| `Tag` | 個別タグ | `name`, `confidence` |
| `TagExtractionResult` | 抽出結果 | `tags`, `language`, `inference_ms`, `tag_names`, `is_empty` |
| `BatchResult` | バッチ処理結果 | `total_processed`, `successful`, `failed`, `is_success` |
| `CursorPosition` | ページネーションカーソル | `created_at`, `article_id` |

#### 例外階層 (`domain/errors.py`)

```
TagGeneratorError (base)
├── TagExtractionError
├── ModelLoadError
├── BatchProcessingError
├── DatabaseConnectionError
└── CursorError
```

旧 `exceptions.py` は `domain.errors` からの再エクスポートラッパーとして維持。

### Phase 2: Clean Architecture レイヤー分離

#### ターゲットディレクトリ構造

```
tag_generator/
├── domain/                      # ドメイン層 (依存なし)
│   ├── models.py
│   └── errors.py
├── usecase/                     # ユースケース層
│   ├── extract_tags.py          # 単一記事タグ抽出
│   ├── batch_process.py         # バッチ処理
│   ├── regenerate_tags.py       # 低品質タグ再生成
│   └── handle_stream_event.py   # Redis Stream イベント処理
├── port/                        # ポート層 (Protocol 定義)
│   ├── article_repository.py    # ArticleRepositoryPort
│   ├── tag_repository.py        # TagRepositoryPort
│   ├── tag_extractor.py         # TagExtractorPort
│   ├── event_publisher.py       # EventPublisherPort
│   └── cursor_store.py          # CursorStorePort
├── gateway/                     # ゲートウェイ層 (Port 実装)
│   ├── postgres_article_repo.py
│   ├── postgres_tag_repo.py
│   └── postgres_cursor_store.py
├── handler/                     # ハンドラー層 (外部 I/F)
│   └── event_payload.py         # Pydantic ペイロード検証
└── infra/                       # インフラ層
    ├── config.py                # 全設定一元管理
    ├── database.py              # DB 接続管理 (sync)
    ├── async_database.py        # psycopg3 async 接続管理
    ├── logging_config.py        # 構造化ログ + 機密フィルタ
    └── otel.py                  # OpenTelemetry
```

#### レイヤー間の依存方向

```
handler/ → usecase/ → port/ (Protocol only)
gateway/ implements port/
infra/ は全レイヤーから利用可
```

Port 層は `typing.Protocol` (構造的部分型) で定義。ランタイムオーバーヘッドなしで DI を実現。

#### BatchProcessor 分割

670 行の God Object を 3 ユースケースに分割:

| 新ファイル | 責務 |
|-----------|------|
| `usecase/extract_tags.py` | 単一記事タグ抽出。`TagExtractorPort` に委譲し `TagExtractionResult` を返す |
| `usecase/batch_process.py` | バッチ処理。Forward/Backfill 戦略切替 |
| `usecase/regenerate_tags.py` | 低信頼度タグの再生成 |

#### 後方互換の維持

旧モジュールパス (`tag_generator.config`, `tag_generator.database` 等) は新配置からの再エクスポートラッパーとして維持。既存の import パスがそのまま動作する:

```python
# tag_generator/config.py (旧パス → 新パスへの再エクスポート)
from tag_generator.infra.config import BatchConfig, DatabaseConfig, TagGeneratorConfig, ...
```

### Phase 3: 設定一元化と Python 近代化

散在する `os.getenv()` を pydantic-settings ベースの一元設定に集約。

#### 設定クラス群 (`infra/config.py`)

| クラス | env_prefix | 主要フィールド |
|--------|-----------|---------------|
| `DatabaseConfig` | `DB_` | `host`, `port`, `name`, `sslmode` (デフォルト: `prefer`) |
| `RedisConfig` | `REDIS_` | `streams_url` |
| `OTelEnvConfig` | `OTEL_` | `service_name`, `enabled`, `endpoint` |
| `BatchConfig` | `TAG_` | `batch_limit` (1-1000, デフォルト: 75) |
| `TagGeneratorConfig` | `TAG_` | 全ランタイム設定 (処理間隔、リトライ、ヘルスチェック等) |

#### Python 近代化

- `asyncio.get_event_loop()` → `asyncio.get_running_loop()` (非推奨 API 修正、2 箇所)

### Phase 4: 全面 async 化と psycopg3 導入

#### 依存追加

```toml
"psycopg[binary]>=3.2.0"     # psycopg3 async driver
"psycopg-pool>=3.2.0"        # AsyncConnectionPool
"pytest-asyncio>=0.24.0"     # async テスト
```

既存の `psycopg2-binary` は既存コードパス用に維持。新コードは psycopg3 を使用。

#### AsyncDatabaseManager (`infra/async_database.py`)

```python
class AsyncDatabaseManager:
    async def initialize(self, min_size=2, max_size=10) -> None:
        # psycopg3 AsyncConnectionPool を open
    async def close(self) -> None:
    @property
    def pool(self) -> AsyncConnectionPool:
        # 未初期化時は DatabaseConnectionError を raise
```

DSN 構築は `DatabaseConfig` またはフォールバックとして環境変数から読み取り。パスワードファイル読み取りにも対応。

#### ML 推論の async 対応

ML 推論 (CPU/GPU bound) は `run_in_executor` でスレッドプールにオフロード:

```python
class HandleStreamEventUsecase:
    async def handle_tag_generation_request(self, ...):
        loop = asyncio.get_running_loop()
        result = await loop.run_in_executor(
            self._executor,  # ThreadPoolExecutor(max_workers=4)
            self._extract.execute, article_id, title, content,
        )
```

### Phase 5: QA とテスト強化

#### Property-based テスト (`hypothesis`)

`hypothesis` を導入し、ハンドピックではなく全入力空間に対する不変条件を検証:

| テスト対象 | 検証する不変条件 |
|-----------|----------------|
| `InputSanitizer` | 任意入力で例外を投げない、出力は NFC 正規化済み、制御文字なし |
| `is_valid_japanese_tag` | 1 文字以下は常に無効、16 文字以上は常に無効、数字のみは常に無効 |
| `clean_noun_phrase` | 出力は入力より長くならない、繰り返し適用で収束する |
| `Tag`, `TagExtractionResult` | `tag_names` プロパティは `tags` リストと一致、`is_empty` は空タグ時のみ true |
| `Article` | `from_dict(to_dict())` でラウンドトリップが保存される |
| `BatchResult` | `is_success` は `failed == 0` のときのみ true |

#### conftest.py バグ修正

`builtins.open` のセッションスコープモックが hypothesis の内部ファイルアクセスで `PosixPath` を処理できず `TypeError` / 無限再帰を引き起こしていた。以下 2 点を修正:

1. `str(filepath)` 変換で `PosixPath` 対応
2. `_real_open = builtins.open` でパッチ前の実体を保持し、フォールバック時の再帰を防止

### Phase 6: セキュリティ強化

#### 6-1. 機密情報ログフィルタ

structlog プロセッサーチェーンに `filter_sensitive_data` を追加。以下のキーを含むログフィールドを自動リダクト:

```
password, secret, token, dsn, authorization, api_key
```

大文字小文字を区別しない部分一致で検出。例: `db_password` → `***REDACTED***`, `API_KEY` → `***REDACTED***`

#### 6-2. イベントペイロード検証 (`handler/event_payload.py`)

Redis Stream から受信する `TagGenerationRequested` イベントに Pydantic バリデーションを適用:

| フィールド | 制約 |
|-----------|------|
| `article_id` | 必須、空文字不可、max_length=36 |
| `title` | max_length=2,000 |
| `content` | max_length=100,000 |
| `feed_id` | デフォルト空文字、max_length=36 |

バリデーション失敗時はエラーレスポンスを reply stream に publish し、タグ抽出処理をスキップ。

#### 6-3. バッチサイズハード上限

`BatchConfig.batch_limit` に pydantic バリデーションで `gt=0, le=1000` を設定。1,000 を超えるバッチサイズはアプリケーション起動時に拒否。

#### 6-4. DB SSL デフォルト

`DatabaseConfig.sslmode` のデフォルトを `prefer` に設定。本番環境では環境変数で `require` に上書き可能。

## RESULTS, EFFECTS

### PROS

- **テスト数 348 → 427**: 新規 79 テスト追加。全テスト `uv run pytest` パス (427 passed, 1 pre-existing pyrefly skip)
  - Domain 層: 23 テスト (全モデルの生成・変換・プロパティ)
  - Usecase 層: 10 テスト (extract 4, batch 3, regenerate 3)
  - Async: 7 テスト (handle_stream_event 3, async_database 4)
  - Security: 23 テスト (sensitive filter 12, payload validation 7, batch limits 4)
  - Property-based: 14 テスト (InputSanitizer 4, TagValidator 5, Domain models 5)
  - Stream handler: 1 テスト追加 (invalid payload rejection)
  - Ruff compliance: 修正済み (1 テスト復旧)
- **Clean Architecture 準拠**: プロジェクト標準の `Handler → Usecase → Port → Gateway` パターンを適用。5 つの Port を `typing.Protocol` で定義
- **型安全性向上**: `dict[str, Any]` → frozen dataclass。`TagExtractionResult.from_outcome()` で既存の `TagExtractionOutcome` からの変換を一元化
- **セキュリティ強化**: ログ機密フィルタ (6 キーパターン)、ペイロードサイズ検証 (title 2KB, content 100KB)、バッチ上限 1,000、DB SSL デフォルト `prefer`
- **async 基盤整備**: psycopg3 `AsyncConnectionPool` 導入。ML 推論を `run_in_executor` でイベントループから分離
- **設定一元化**: 5 つの pydantic-settings クラスで環境変数を型安全に管理
- **後方互換維持**: 旧 import パスは再エクスポートラッパーで動作継続。既存 348 テスト全パス
- **バグ発見**: Property-based テストで `clean_noun_phrase` の非冪等性を発見 (連鎖する助詞 `へを` → 1 パスで 1 つのみ除去)。収束テストで振る舞いを明文化
- **conftest.py バグ修正**: hypothesis 導入時に発覚した `builtins.open` モックの `PosixPath` 非対応と無限再帰を修正。全テストに恩恵
- **コンテナ動作確認済み**: Docker Compose リビルド後に healthy 状態で稼働確認

### CONS, TRADEOFF

- **旧コード未削除**: `batch_processor.py` (670 行) および `service.py` は稼働中のコードパスとして残存。新ユースケースは並行実装であり、完全切替は未実施
- **psycopg2 並存**: 既存コードは `psycopg2-binary` を使用。psycopg3 は新しい async パス専用。完全移行は次フェーズ
- **snapshot テスト未導入**: Phase 5 計画の `pytest-regressions` によるタグ抽出結果のスナップショットテストは、ゴールデンデータ整備が必要なため見送り
- **Gateway 層がエイリアス**: `postgres_article_repo.py` 等は既存クラスへのエイリアス (`PostgresArticleRepository = ArticleFetcher`)。真のリポジトリ実装 (async, psycopg3 ベース) は次フェーズ

## APPENDIX

### 実施順序と依存関係

```
Phase 1 (ドメインモデル)         348 → 371 tests
  → Phase 2 (CA レイヤー分離)    371 → 382 tests
    → Phase 3 (設定一元化)       382 tests (変更なし)
      → Phase 4 (async 化)      382 → 389 tests
        → Phase 5 (QA 強化)     389 → 413 tests
        → Phase 6 (セキュリティ)  413 → 427 tests
```

### 新規ファイル一覧

| ファイル | 内容 |
|----------|------|
| `tag_generator/domain/__init__.py` | ドメインパッケージ |
| `tag_generator/domain/models.py` | Article, Tag, TagExtractionResult, BatchResult, CursorPosition |
| `tag_generator/domain/errors.py` | 例外階層 (TagGeneratorError 以下 5 種) |
| `tag_generator/port/article_repository.py` | ArticleRepositoryPort Protocol |
| `tag_generator/port/tag_repository.py` | TagRepositoryPort Protocol |
| `tag_generator/port/tag_extractor.py` | TagExtractorPort Protocol |
| `tag_generator/port/event_publisher.py` | EventPublisherPort Protocol |
| `tag_generator/port/cursor_store.py` | CursorStorePort Protocol |
| `tag_generator/usecase/extract_tags.py` | 単一記事タグ抽出ユースケース |
| `tag_generator/usecase/batch_process.py` | バッチ処理ユースケース |
| `tag_generator/usecase/regenerate_tags.py` | タグ再生成ユースケース |
| `tag_generator/usecase/handle_stream_event.py` | Redis Stream イベント処理 (async) |
| `tag_generator/gateway/postgres_article_repo.py` | ArticleFetcher エイリアス |
| `tag_generator/gateway/postgres_tag_repo.py` | TagInserter エイリアス |
| `tag_generator/gateway/postgres_cursor_store.py` | CursorManager エイリアス |
| `tag_generator/handler/event_payload.py` | TagGenerationRequestPayload (Pydantic) |
| `tag_generator/infra/config.py` | DatabaseConfig, RedisConfig, OTelEnvConfig, BatchConfig |
| `tag_generator/infra/async_database.py` | AsyncDatabaseManager (psycopg3 pool) |
| `tests/unit/domain/test_models.py` | ドメインモデル 23 テスト |
| `tests/unit/usecase/test_extract_tags.py` | ExtractTagsUsecase 4 テスト |
| `tests/unit/usecase/test_batch_process.py` | BatchProcessUsecase 3 テスト |
| `tests/unit/usecase/test_regenerate_tags.py` | RegenerateTagsUsecase 3 テスト |
| `tests/unit/usecase/test_handle_stream_event.py` | HandleStreamEventUsecase 3 async テスト |
| `tests/unit/test_async_database.py` | AsyncDatabaseManager 4 テスト |
| `tests/unit/test_security.py` | セキュリティ 23 テスト (フィルタ, 検証, 上限) |
| `tests/unit/test_property_based.py` | Hypothesis property-based 14 テスト |

### 変更ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `tag_generator/exceptions.py` | `domain.errors` からの再エクスポートラッパーに変更 |
| `tag_generator/config.py` | `infra.config` からの再エクスポートラッパーに変更 |
| `tag_generator/database.py` | `infra.database` からの再エクスポートラッパーに変更 |
| `tag_generator/logging_config.py` | `infra.logging_config` からの再エクスポートラッパーに変更 |
| `tag_generator/otel.py` | `infra.otel` からの再エクスポートラッパーに変更 |
| `tag_generator/infra/logging_config.py` | `filter_sensitive_data` プロセッサー + `add_business_context` 追加 |
| `tag_generator/infra/database.py` | import パスを `domain.errors` 直接参照に変更 |
| `tag_generator/stream_event_handler.py` | `TagGenerationRequestPayload` による検証追加、`asyncio.get_running_loop()` 修正 |
| `tag_generator/service.py` | `TagExtractionResult.from_outcome()` 使用に変更 |
| `tag_generator/ports.py` | ドメインモデル import に更新 |
| `conftest.py` | `builtins.open` モックの PosixPath 対応 + 再帰防止修正 |
| `pyproject.toml` | psycopg3, psycopg-pool, pytest-asyncio, hypothesis 追加。テスト S105 除外追加 |

### 検証結果

```
uv run pytest                       # 427 passed, 1 failed (pre-existing pyrefly)
uv run ruff check                   # All checks passed
uv run ruff format --check          # 100 files already formatted
uv run bandit -r tag_generator/ -ll # No medium+ severity issues
docker compose build tag-generator  # sha256:d8e9f7d1
docker compose up -d tag-generator  # Recreated + Started
curl http://localhost:9400/health   # {"status":"healthy","service":"tag-generator"}
```
