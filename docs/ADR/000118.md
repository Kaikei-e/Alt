# Evidence ステージの進捗追跡と Classification フィルタリング

## ADR'S STATUS

Accepted

## CONTEXT

### 背景

Recap Job Status ページの Pipeline Progress 表示において、以下の問題があった:

1. **"classification" 疑似ジャンルの表示**: Genre Progress 欄に内部処理用の "classification" エントリが表示されていた
2. **Evidence ステージの進捗未表示**: Evidence building フェーズ中に `(n/m)` 形式の進捗が表示されなかった
3. **current_stage の不整合**: `last_stage` がステージ完了後に更新されるため、Evidence 実行中でも `current_stage: "select"` と報告されていた

### 既存アーキテクチャ

```
Frontend (PipelineProgress.svelte) → shouldShowSubStageProgress()
                                   ↓
                          status === "running" && stage === "evidence"
                          && subStageProgress.phase === "evidence_building"
```

フロントエンドは正しく実装されていたが、バックエンドが `current_stage: "select"` を返していたため、`status` が `"pending"` となり進捗が表示されなかった。

## DECISION MAKING

### 決定

1. **Classification フィルタリング**: DAO クエリで `classification` を除外
2. **current_stage の動的導出**: `sub_stage_phase` に基づいて実際の実行ステージを推定
3. **フロントエンド側フィルタも維持**: 防御的にフロントエンドでもフィルタリング

### 技術的詳細

**Classification 除外（DAO レイヤー）**

```sql
SELECT genre, status, cluster_count
FROM recap_subworker_runs
WHERE job_id = $1 AND genre != 'classification'
ORDER BY started_at
```

**current_stage の動的導出**

`last_stage` は完了後に更新されるため、実行中のステージを `sub_stage_phase` から推定する:

```rust
let (current_stage, effective_stage_index) = match sub_stage_phase {
    Some("evidence_building") => (Some("evidence".to_string()), PipelineStage::Evidence.index()),
    Some("clustering") | Some("summarization") => {
        (Some("dispatch".to_string()), PipelineStage::Dispatch.index())
    }
    _ => (job.last_stage.clone(), stage_index),
};
```

**フロントエンド側フィルタ（防御的実装）**

```typescript
export function filterGenreProgress(
  genreProgress: Record<string, GenreProgressInfo>
): Array<[string, GenreProgressInfo]> {
  const entries = Object.entries(genreProgress);
  const hasRealGenres = entries.some(([genre]) => genre !== "classification");

  return entries
    .filter(([genre]) => !hasRealGenres || genre !== "classification")
    .sort(([a], [b]) => a.localeCompare(b));
}
```

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 種別 | 内容 |
|----------|------|------|
| `recap-worker/src/store/dao/job_status.rs` | 変更 | `get_genre_progress()` で classification 除外 |
| `recap-worker/src/api/dashboard.rs` | 変更 | `current_stage` と `stage_index` の動的導出 |
| `alt-frontend-sv/src/lib/utils/genreProgress.ts` | 新規 | `filterGenreProgress()` 関数 |
| `alt-frontend-sv/src/lib/utils/pipelineProgress.ts` | 新規 | `shouldShowSubStageProgress()` 関数 |
| `alt-frontend-sv/src/lib/components/.../GenreProgressList.svelte` | 変更 | filterGenreProgress 適用 |
| `alt-frontend-sv/src/lib/components/.../PipelineProgress.svelte` | 変更 | shouldShowSubStageProgress 適用 |

### API レスポンス変更

**Before**:
```json
{
  "current_stage": "select",
  "stage_index": 4,
  "sub_stage_progress": { "phase": "evidence_building", ... }
}
```

**After**:
```json
{
  "current_stage": "evidence",
  "stage_index": 5,
  "sub_stage_progress": { "phase": "evidence_building", ... }
}
```

### UI 表示例

```
[✓ Fetch] — [✓ Select] — [◉ Evidence (0/30)] — [ Dispatch] — [ Persist]
```

### PROS

1. **正確なステージ表示**: 実行中のステージが正しく "running" 状態で表示される
2. **ユーザー混乱防止**: "classification" のような内部エントリが非表示
3. **多層防御**: バックエンド・フロントエンド両方でフィルタリング
4. **後方互換性維持**: 既存クライアントへの影響なし

### CONS, TRADEOFF

1. **evidence_building の completed_genres**: DB に per-genre 進捗がないため常に 0。実際の進捗は OTel ログで確認可能

## APPENDIX

### 検証手順

```bash
# API レスポンス確認
curl -s "http://localhost:9005/v1/dashboard/job-progress" | \
  jq '{current_stage: .active_job.current_stage, stage_index: .active_job.stage_index, sub_stage_progress: .active_job.sub_stage_progress}'

# classification が除外されていることを確認
curl -s "http://localhost:9005/v1/dashboard/job-progress" | \
  jq '.active_job.genre_progress | keys' | grep classification
# (結果が空であることを確認)

# テスト実行
cd recap-worker/recap-worker && cargo test --lib api::dashboard::tests
cd alt-frontend-sv && bun test src/lib/utils/genreProgress.test.ts src/lib/utils/pipelineProgress.test.ts
```

### 関連 ADR

- ADR-109: Recap Job Status Dashboard 実装
- ADR-117: Dispatch ステージのサブ進捗追跡改善
