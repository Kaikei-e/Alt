# ログパイプラインのTrace Context伝搬完全対応

## ADR's STATUS

Accepted

## CONTEXT

### 背景

GrafanaダッシュボードでTraceId/SpanIdが全てゼロ表示される問題が報告された。ADR-122/123でOTLP経路の問題は修正されたが、Docker stdout→rask-log-forwarder→rask-log-aggregator経路では依然としてtrace contextが失われていた。

### 問題の分析

調査の結果、2つの根本原因が特定された：

**Issue 1: Goサービスのロガー設定不足**

一部のGoサービスでTraceContextHandlerがJSONHandlerをラップしていなかった：

| サービス | 問題 |
|---------|------|
| rag-orchestrator | OTel無効時にJSONHandlerが直接使用 |
| mq-hub | TraceContextHandler未導入 |
| alt-butterfly-facade | ハードコードされたJSONHandler |

**Issue 2: ログパイプラインのtrace_id/span_id未抽出**

```
Go Service (trace_id in JSON)
    ↓
rask-log-forwarder
    ↓ EnrichedLogEntry (trace_id/span_id フィールドなし)
rask-log-aggregator
    ↓ LogRow (TraceId/SpanId カラムなし)
ClickHouse logs table
    ↓ (TraceId/SpanIdカラムなし → Grafanaでゼロ表示)
```

## DECISION MAKING

### Part A: Goサービスの修正

全Goサービスで統一的なTraceContextHandler適用パターンを実装：

```go
// TraceContextHandler wraps JSONHandler to inject trace_id/span_id
type TraceContextHandler struct {
    inner slog.Handler
}

func (h *TraceContextHandler) Handle(ctx context.Context, r slog.Record) error {
    if span := trace.SpanFromContext(ctx); span.SpanContext().IsValid() {
        sc := span.SpanContext()
        r.AddAttrs(
            slog.String("trace_id", sc.TraceID().String()),
            slog.String("span_id", sc.SpanID().String()),
        )
    }
    return h.inner.Handle(ctx, r)
}
```

### Part B: ログパイプラインの修正

rask-log-forwarderとrask-log-aggregatorにtrace_id/span_idフィールドを追加：

```rust
// rask-log-forwarder: EnrichedLogEntry
pub struct EnrichedLogEntry {
    // ... existing fields ...
    pub trace_id: Option<String>,  // 追加
    pub span_id: Option<String>,   // 追加
    pub fields: HashMap<String, String>,
}

// rask-log-aggregator: LogRow
pub struct LogRow {
    // ... existing fields ...
    #[serde(rename = "TraceId")]
    pub trace_id: [u8; 32],  // FixedString(32)
    #[serde(rename = "SpanId")]
    pub span_id: [u8; 16],   // FixedString(16)
    pub fields: Vec<(String, String)>,
}
```

### Part C: ClickHouseスキーマ拡張

```sql
ALTER TABLE logs ADD COLUMN IF NOT EXISTS TraceId FixedString(32) DEFAULT '' AFTER service_group;
ALTER TABLE logs ADD COLUMN IF NOT EXISTS SpanId FixedString(16) DEFAULT '' AFTER TraceId;
```

## RESULTS, EFFECTS

### 変更ファイル一覧

**Go サービス:**

| サービス | ファイル | 変更内容 |
|---------|---------|---------|
| rag-orchestrator | `internal/infra/logger/trace_context_handler.go` | 新規追加 |
| rag-orchestrator | `internal/infra/logger/logger.go` | TraceContextHandler適用 |
| mq-hub | `utils/logger/trace_context_handler.go` | 新規追加 |
| mq-hub | `utils/logger/logger.go` | TraceContextHandler適用 |
| alt-butterfly-facade | `internal/logger/trace_context_handler.go` | 新規追加 |
| alt-butterfly-facade | `internal/logger/logger.go` | 新規追加 |
| alt-butterfly-facade | `main.go` | loggerパッケージ使用 |

**Rust サービス:**

| サービス | ファイル | 変更内容 |
|---------|---------|---------|
| rask-log-forwarder | `parser/universal.rs` | trace_id/span_idフィールド追加 |
| rask-log-forwarder | `app/service.rs` | trace_id/span_id抽出処理 |
| rask-log-aggregator | `domain/mod.rs` | EnrichedLogEntryにフィールド追加 |
| rask-log-aggregator | `log_exporter/clickhouse_exporter.rs` | LogRowにTraceId/SpanId追加 |

**ClickHouse:**

| ファイル | 変更内容 |
|---------|---------|
| `migrations/011_add_trace_context_to_logs.sql` | TraceId/SpanIdカラム追加 |

### データフロー（修正後）

```
Go Service (TraceContextHandler)
    ↓ JSON stdout: {"trace_id":"abc...", "span_id":"def...", ...}
Docker
    ↓
rask-log-forwarder
    ↓ trace_id/span_idをfieldsから抽出→専用フィールドに格納
    ↓ EnrichedLogEntry { trace_id: Some("abc..."), span_id: Some("def..."), ... }
rask-log-aggregator
    ↓ string_to_fixed_bytes変換
    ↓ LogRow { trace_id: [u8; 32], span_id: [u8; 16], ... }
ClickHouse logs table
    ↓ TraceId/SpanIdカラムに保存
Grafana
    → trace_id/span_id表示可能
```

### PROS

1. **完全なtrace context伝搬**: stdout経路でもtrace_id/span_idが保持される
2. **統一アーキテクチャ**: 全GoサービスでTraceContextHandlerパターンを採用
3. **後方互換性**: 既存ログへの影響なし（新カラムはDEFAULT ''）
4. **テスト完備**: 各コンポーネントでtrace context処理のテスト追加

### CONS, TRADEOFF

1. **スキーマ変更**: ClickHouse logsテーブルへのカラム追加が必要
2. **依存関係**: go.opentelemetry.io/otel/traceへの依存追加（mq-hub, alt-butterfly-facade）

## APPENDIX

### 検証手順

```bash
# 1. サービスビルド
docker compose -f compose/compose.yaml -p alt build \
  rask-log-aggregator mq-hub rag-orchestrator alt-butterfly-facade alt-backend-logs

# 2. サービス起動
docker compose -f compose/compose.yaml -p alt up -d \
  rask-log-aggregator mq-hub rag-orchestrator alt-butterfly-facade alt-backend-logs

# 3. ClickHouseマイグレーション適用
docker compose -f compose/compose.yaml -p alt exec clickhouse clickhouse-client \
  --multiquery < clickhouse/migrations/011_add_trace_context_to_logs.sql

# 4. 確認
docker compose -f compose/compose.yaml -p alt exec clickhouse clickhouse-client \
  --query "SELECT TraceId, SpanId, service_name FROM rask_logs.logs ORDER BY timestamp DESC LIMIT 5"
```

### 関連ADR

- ADR-122: Grafana Trace/Log表示問題の修正
- ADR-123: otelslogブリッジのTrace Context属性フォールバック対応
- ADR-124: ログパイプラインのTrace Context伝搬完全対応（本ADRの前身、内容統合）
