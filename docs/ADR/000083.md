# mq-hub: Redis Streams によるイベント駆動アーキテクチャの導入

## ステータス

採択（Accepted）

## コンテキスト

### 現状のアーキテクチャ

```
alt-backend ──(Connect-RPC sync)──> pre-processor
alt-backend ──(Connect-RPC sync)──> search-indexer
tag-generator ──(DB polling)──> PostgreSQL
```

alt-backend がワーカーサービス（pre-processor, search-indexer, tag-generator）を同期的に呼び出し、アグリゲーター的な役割を担っていた。

### 問題点

| 問題 | 影響 |
|------|------|
| 同期的な処理 | レスポンス遅延、障害伝播 |
| 密結合 | ワーカー追加・変更時に alt-backend 修正が必要 |
| スケーラビリティ | ワーカーの水平スケールが困難 |
| ポーリングパターン | tag-generator の DB 負荷、リアルタイム性の欠如 |

## 決定

**mq-hub** サービスを導入し、Redis 8.4 Streams を使ったイベント駆動アーキテクチャに移行する。

### アーキテクチャ

```
alt-backend ──(Connect-RPC)──> mq-hub ──(XADD)──> Redis 8.4 Streams
                                                       │
                         ┌─────────────────────────────┼─────────────────────────────┐
                         ▼                             ▼                             ▼
                  pre-processor                 search-indexer                tag-generator
                  (XREADGROUP)                  (XREADGROUP)                  (XREADGROUP)
```

### 設計方針

| 決定事項 | 選択 | 理由 |
|---------|------|------|
| mq-hub の責務 | Producer のみ | シンプル化、ワーカーは直接 Redis から消費 |
| メッセージブローカー | Redis 8.4 Streams | Consumer Groups、CLAIM option、高スループット |
| プロトコル | Connect-RPC | 既存パターンとの一貫性 |
| 配信保証 | At-least-once | Consumer Groups + ACK |

### Redis 8.4 の活用

```go
// XREADGROUP CLAIM option: idle pending + new messages を1コマンドで消費
result, err := redis.XReadGroup(ctx, &redis.XReadGroupArgs{
    Group:    groupName,
    Consumer: consumerName,
    Streams:  []string{streamKey, ">"},
    Count:    10,
    Block:    5 * time.Second,
})
```

- **CLAIM option**: 障害復旧時の pending message 処理が簡素化
- **Multi-threaded I/O**: `--io-threads 4` で分散クエリ性能向上
- **30% スループット向上**: キャッシングワークロード

### イベント設計

| イベント | Producer | Consumers |
|---------|----------|-----------|
| ArticleCreated | alt-backend | pre-processor, search-indexer, tag-generator |
| SummarizeRequested | alt-backend | pre-processor |
| ArticleSummarized | pre-processor | search-indexer |
| TagsGenerated | tag-generator | search-indexer |

### ストリーム設計

| Stream Key | 用途 |
|------------|------|
| `alt:events:articles` | 記事ライフサイクルイベント |
| `alt:events:summaries` | 要約完了イベント |
| `alt:events:tags` | タグ生成完了イベント |

## 結果

### 新規ファイル構成

```
mq-hub/
├── app/
│   ├── main.go
│   ├── config/config.go
│   ├── connect/v1/mqhub/handler.go
│   ├── domain/
│   │   ├── event.go
│   │   └── stream.go
│   ├── driver/redis_driver.go
│   ├── gateway/stream_gateway.go
│   ├── port/stream_port.go
│   └── usecase/publish_usecase.go
├── Dockerfile
├── CLAUDE.md
└── go.mod

proto/
├── services/mqhub/v1/mqhub.proto
├── clients/mqhub/v1/mqhub.proto
└── buf.gen.mq-hub.yaml
```

### Docker Compose 変更

| ファイル | 変更内容 |
|---------|---------|
| `compose/mq.yaml` | 新規：Redis 8.4 + mq-hub サービス定義 |

### alt-backend 変更

| ファイル | 変更内容 |
|---------|---------|
| `config/config.go` | MQHubConfig 追加 |
| `driver/mqhub_connect/client.go` | mq-hub クライアント |
| `port/event_publisher_port/` | イベント発行ポート |
| `gateway/event_publisher_gateway/` | ゲートウェイ実装 |

### ワーカー変更

| サービス | 変更内容 |
|---------|---------|
| pre-processor | `consumer/` パッケージ追加（Go） |
| search-indexer | `consumer/` パッケージ追加（Go） |
| tag-generator | `stream_consumer.py` 追加（Python） |

### メリット

1. **疎結合**: ワーカーの追加・削除が容易
2. **スケーラビリティ**: Consumer Groups による水平スケール
3. **耐障害性**: メッセージ永続化、リトライ機構
4. **リアルタイム性**: ポーリングからプッシュ型へ
5. **監視性**: Stream の lag、pending 数でボトルネック特定

### トレードオフ

1. **複雑性**: 新規サービス（mq-hub, Redis）の追加
2. **イベンチュアル整合性**: 同期 RPC から非同期へ移行
3. **運用負荷**: Redis Streams の監視・運用

### 設定項目

| 環境変数 | デフォルト | 説明 |
|---------|-----------|------|
| `REDIS_URL` | redis://redis-streams:6379 | Redis 接続 URL |
| `CONNECT_PORT` | 9500 | mq-hub サービスポート |
| `MQHUB_ENABLED` | false | イベント発行の有効化 |
| `CONSUMER_ENABLED` | false | ワーカーのイベント消費有効化 |
| `CONSUMER_GROUP` | \<service\>-group | Consumer Group 名 |

### マイグレーション戦略

| フェーズ | アクション |
|---------|-----------|
| 1 | mq-hub, redis-streams デプロイ（非アクティブ） |
| 2 | ワーカーをデュアルモード化（RPC + Streams） |
| 3 | alt-backend のイベント発行有効化 |
| 4 | メトリクス監視、検証 |
| 5 | レガシー Connect-RPC クライアント削除 |

## テスト

```bash
# mq-hub テスト
cd mq-hub/app && go test ./...

# 起動
docker compose -f compose/mq.yaml up -d

# ヘルスチェック
curl http://localhost:9500/health

# Stream 確認
docker exec redis-streams redis-cli XINFO STREAMS
```

## 実装日

2026-01-13

## 関連

- [Redis Streams Documentation](https://redis.io/docs/latest/develop/data-types/streams/)
- [Redis 8.4 What's New](https://redis.io/docs/latest/develop/whats-new/8-4/)
- [Connect-RPC Go](https://connectrpc.com/docs/go/getting-started/)
- [Event Sourcing with Redis](https://redis.io/blog/use-redis-event-store-communication-microservices/)
