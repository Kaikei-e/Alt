# tag-generator 7 Phase リファクタリング

## ADR's STATUS

Accepted (実装完了)

## CONTEXT

### 問題点

tag-generator は本番稼働中の ML マイクロサービス（Python 3.13 / FastAPI / KeyBERT + Fugashi）で、Clean Architecture の基盤は堅実だが、以下の技術的負債が蓄積していた:

| # | 問題 | 影響 |
|---|------|------|
| 1 | `extract.py` が 920 行の God class | 単一責任原則の違反。日本語・英語の抽出ロジックが混在し、テスト・変更が困難 |
| 2 | `service.py` に 250 行超のレガシー互換レイヤー | `_process_article_batch()` 等の内部 API がテスト経由でのみ使用され、BatchProcessor への委譲が不完全 |
| 3 | `ModelManager` が Singleton パターン | `__new__` オーバーライドによりテスト時のインスタンス差し替えが困難 |
| 4 | 設定が `@dataclass` ベース | 環境変数のバリデーションなし。`__post_init__` で手動パース |
| 5 | Port 層のインターフェース未定義 | BatchProcessor の依存が具象クラスに直結 |
| 6 | 未使用ファイル・レガシー関数の残存 | `extract_with_lazy_loading.py`, `lazy_model_manager.py`, `extract_tags()` 等 |
| 7 | `except Exception` の多用 | 障害分類が不可能。ドメイン例外型がない |

### 方針

7 Phase に分け、各 Phase 完了時に全テスト通過・lint/format チェックを確認しながら段階的に実施。

## DECISION MAKING

### Phase 1: デッドコード削除 & 構造化ログ修正

**未使用ファイルの削除:**
- `tag_extractor/extract_with_lazy_loading.py` — extract.py の非同期重複版
- `tag_extractor/lazy_model_manager.py` — model_manager.py の非同期版

**レガシー互換コードの削除:**
- `extract_tags()` モジュールレベル関数 — 外部参照なし
- `TagExtractor.extract_tags()` メソッド — `extract_tags_with_metrics()` が正規 API

**構造化ログの改善:**
- `batch_processor.py`, `service.py`, `database.py` の全 f-string ログを structlog kwargs 形式に変換
- 例: `logger.info(f"Processing batch of {len(articles)}")` → `logger.info("Processing batch", article_count=len(articles))`

### Phase 2: Pydantic v2 Settings による設定統合

**TagGeneratorConfig: dataclass → pydantic-settings BaseSettings**
- `env_prefix="TAG_"` による環境変数の自動マッピング
- フィールドバリデーション追加（`gt=0`, `le=1000` 等）

**TagExtractionConfig: dataclass → Pydantic BaseModel**
- `tag_extractor/config.py` に抽出・分離
- `__post_init__` → `@model_validator(mode="after")` に変換
- `MAX_TAG_LENGTH` 定数 → `max_tag_length` フィールドに移動

**ModelConfig: dataclass → Pydantic BaseModel**
- 同じく `tag_extractor/config.py` に集約

### Phase 3: Protocol インターフェース定義

`tag_generator/ports.py` に Clean Architecture の Port 層を `typing.Protocol` で定義:

```python
class ArticleFetcherPort(Protocol):
    def fetch_articles(self, conn, ...) -> list[dict[str, Any]]: ...
    def fetch_new_articles(self, conn, ...) -> list[dict[str, Any]]: ...
    def count_untagged_articles(self, conn) -> int: ...
    def fetch_article_by_id(self, conn, article_id) -> dict[str, Any] | None: ...

class TagExtractorPort(Protocol):
    def extract_tags_with_metrics(self, title, content) -> TagExtractionOutcome: ...

class TagInserterPort(Protocol):
    def upsert_tags(self, conn, ...) -> dict[str, Any]: ...
    def batch_upsert_tags_no_commit(self, conn, ...) -> BatchResult: ...
```

`BatchProcessor` の型アノテーションを Protocol に更新（`TYPE_CHECKING` ブロック内）。

### Phase 4: ModelManager DI 化 & Singleton 廃止

**Singleton パターンの除去:**
- `__new__` オーバーライド、クラス変数 `_instance`, `_lock` を削除
- 通常のクラスとしてインスタンス化可能に

**モジュールレベルファクトリに置換:**

```python
_default_instance: ModelManager | None = None
_instance_lock = threading.Lock()

def get_model_manager() -> ModelManager:
    global _default_instance
    if _default_instance is None:
        with _instance_lock:
            if _default_instance is None:
                _default_instance = ModelManager()
    return _default_instance
```

**TagExtractor への DI:**
- `model_manager` パラメータを `__init__` に追加（デフォルト: `get_model_manager()`）
- テスト時にモック注入が容易に

### Phase 5: TagExtractor 分割（extract.py 920 行 → 3 モジュール）

**`tag_extractor/japanese_extractor.py`（新規, 412 行）:**
- `extract_compound_nouns_fugashi()` — 連続名詞チェーンによる複合語抽出
- `extract_compound_japanese_words()` — 混合スクリプト・固有名詞の正規表現パターン
- `extract_keywords_japanese()` — 形態素解析 + KeyBERT セマンティックスコアリング
- `score_japanese_candidates_with_keybert()` — 意味的類似度 60% + 頻度 40% の統合スコア
- `score_candidates_by_frequency()` — 頻度ベースフォールバック
- `make_japanese_analyzer()` — CountVectorizer 用カスタムアナライザ

**`tag_extractor/english_extractor.py`（新規, 192 行）:**
- `extract_keywords_english()` — KeyBERT による単語・フレーズ抽出
- `tokenize_english()` — NLTK トークナイズ
- `get_candidate_tokens()` — フォールバック用候補トークン
- `fallback_english()` — 頻度ベースフォールバック

**`tag_extractor/extract.py`（396 行, 旧 920 行）:**
- サニタイズ → 言語検出 → 適切な extractor へのディスパッチのみ
- 既存テストの patch ターゲット互換性を維持する薄いラッパーメソッドを保持

### Phase 6: service.py レガシー互換レイヤー削除

**削除した属性:**
- `last_processed_created_at`, `last_processed_id` — CursorManager が管理
- `forward_cursor_created_at`, `forward_cursor_id` — 同上
- `backfill_completed` — BatchProcessor が管理

**削除したメソッド:**
- `_create_direct_connection()` — DatabaseManager に委譲済み
- `_get_initial_cursor_position()` — CursorManager に委譲済み
- `_process_article_batch()` — BatchProcessor.process_article_batch に委譲済み
- `_process_articles_as_batch()` — 上記内部で使用
- `_get_forward_cursor_position()`, `_has_existing_tags()` — 互換ラッパー
- `_get_database_connection()` — DatabaseManager.get_connection のラッパー

**保持:**
- `_process_single_article()` — StreamEventHandler が本番利用

`service.py`: 432 行 → 184 行

### Phase 7: ドメイン例外体系化

**`tag_generator/exceptions.py`（新規）:**

```python
class TagGeneratorError(Exception): ...      # 基底例外
class TagExtractionError(TagGeneratorError): ...   # タグ抽出失敗
class ModelLoadError(TagGeneratorError): ...        # ML モデル読込失敗
class BatchProcessingError(TagGeneratorError): ...  # バッチ処理失敗
class DatabaseConnectionError(TagGeneratorError): ...  # DB 接続失敗
class CursorError(TagGeneratorError): ...          # カーソルページネーション異常
```

**適用箇所:**
- `model_manager.py`: `RuntimeError` → `ModelLoadError`、`ImportError` → `ModelLoadError` でラップ
- `batch_processor.py`: バッチ失敗時に `BatchProcessingError` を送出
- `database.py`: ローカル定義の `DatabaseConnectionError` → 共通 exceptions モジュールからインポート
- `database.py`: bare `except` → `except OSError` に修正

## RESULTS, EFFECTS

### 変更ファイル一覧

| カテゴリ | ファイル | 変更内容 |
|----------|----------|----------|
| 削除 | `tag_extractor/extract_with_lazy_loading.py` | 未使用ファイル削除 |
| 削除 | `tag_extractor/lazy_model_manager.py` | 未使用ファイル削除 |
| 新規 | `tag_extractor/config.py` | Pydantic BaseModel 設定クラス |
| 新規 | `tag_extractor/japanese_extractor.py` | 日本語キーワード抽出モジュール |
| 新規 | `tag_extractor/english_extractor.py` | 英語キーワード抽出モジュール |
| 新規 | `tag_generator/ports.py` | Protocol インターフェース |
| 新規 | `tag_generator/exceptions.py` | ドメイン例外階層 |
| 改修 | `tag_extractor/extract.py` | God class → オーケストレーター (920→396 行) |
| 改修 | `tag_extractor/model_manager.py` | Singleton 廃止 → DI + ファクトリ |
| 改修 | `tag_generator/config.py` | dataclass → pydantic-settings BaseSettings |
| 改修 | `tag_generator/service.py` | レガシー互換レイヤー削除 (432→184 行) |
| 改修 | `tag_generator/batch_processor.py` | Protocol 型 + ドメイン例外適用 |
| 改修 | `tag_generator/database.py` | 共通例外・bare except 修正 |
| 改修 | `test_unit.py` | レガシーメソッド参照の削除 |
| 改修 | `tests/unit/test_model_manager.py` | Singleton → ファクトリ API 対応 |
| 改修 | `tests/integration/test_tag_generator_logging.py` | DatabaseManager 直接参照に更新 |

### コード量の変化

| ファイル | Before | After | 削減率 |
|----------|--------|-------|--------|
| `extract.py` | 920 行 | 396 行 | -57% |
| `service.py` | 432 行 | 184 行 | -57% |
| テスト数 | 358 | 348 | -10 (レガシーテスト削除) |

### 動作確認

- `uv run pytest`: 348 テスト全通過
- `uv run ruff check && uv run ruff format --check .`: 全パス
- `docker compose -f compose/compose.yaml -p alt build tag-generator`: ビルド成功
- コンテナ起動後:
  - `GET /health` → `{"status":"healthy","service":"tag-generator"}`
  - バッチ処理サイクルが正常に実行（structlog kwargs 形式のログ出力確認）

### PROS

1. **保守性の向上**: God class を責務別に分割し、各モジュールが単一責任を持つ構造に
2. **テスタビリティ**: DI パターンにより ModelManager のモック注入が容易に。Protocol でインターフェース契約が明示的に
3. **型安全性**: Pydantic v2 によるバリデーション付き設定。Protocol による構造的部分型
4. **運用品質**: structlog kwargs ログにより JSON 構造化ログの精度が向上。ドメイン例外による障害分類
5. **コード量削減**: extract.py -57%, service.py -57%。未使用コード完全除去

### CONS, TRADEOFF

1. **ラッパーメソッドの残存**: extract.py にテスト互換性のための薄いラッパーが残る（既存テストが `tag_extractor.extract.TagExtractor._lazy_load_models` 等を直接 patch するため）
2. **テスト数の純減**: レガシー互換レイヤーのテスト 10 件を削除。同等のロジックは BatchProcessor/CursorManager の既存テストでカバー済み
3. **循環インポートリスク**: `tag_extractor` → `tag_generator.exceptions` の依存方向が Clean Architecture の内→外の原則に反する（`ModelLoadError` のみ）

## APPENDIX

### 依存追加

| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| `pydantic-settings` | >=2.7.0 | BaseSettings による環境変数マッピング |

### Phase 間の依存関係

```
Phase 1 (デッドコード) ─┐
Phase 2 (Pydantic)    ─┤── 独立実施可能
Phase 3 (Protocol)    ─┘
Phase 4 (DI)          ─── Phase 2 に依存
Phase 5 (分割)        ─── Phase 4 に依存
Phase 6 (レガシー)    ─── 独立
Phase 7 (例外)        ─── 独立
```

### 関連 ADR

- ADR-000176: KeyBERT 日本語スコアリング修正（Phase 5 で分割対象となった Japanese extractor の原型）
