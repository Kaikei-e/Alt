# LLM Thinking/Reasoning Display Feature

## ADR's STATUS

Accepted

## CONTEXT

### 背景

RAG チャット機能において、LLM の推論経過（thinking/reasoning）をユーザーに表示する機能がなかった。近年の LLM（Claude Extended Thinking、OpenAI o1 等）では推論過程の可視化が標準的な UX となりつつある。

### 要件

```
┌─────────────────────────────────────────────────────┐
│                  User Query                          │
│              "RSS とは何ですか?"                      │
└────────────────────┬────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────┐
│                    LLM                               │
│         thinking: "まず RSS の定義を確認し..."        │
│         content: "RSS は Really Simple..."          │
└────────────────────┬────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────┐
│              Frontend Display                        │
│         [Thinking...] 推論経過を折りたたみ表示        │
│         [Answer] 最終回答をストリーミング表示          │
└─────────────────────────────────────────────────────┘
```

### 参考にした UI パターン

- **Claude Extended Thinking**: `thinking_delta` イベントで推論をストリーミング
- **OpenAI UI Guidelines**: shimmer エフェクト、折りたたみ可能な UI

## DECISION MAKING

### 設計方針

1. **Proto 拡張**: 既存の `StreamChatEvent` に `thinking_delta` ペイロードを追加
2. **バックエンド分離**: LLM レスポンスの `thinking` と `content` を別々に処理
3. **フロントエンド UI**: 折りたたみ可能な `<details>` 要素で推論を表示

### アーキテクチャ

```
LLM Response
    │
    ├── message.thinking ──▶ StreamEventKindThinking ──▶ thinkingDelta
    │
    └── message.content ───▶ StreamEventKindDelta ─────▶ delta
```

## RESULTS, EFFECTS

### 変更ファイル一覧

| レイヤー | ファイル | 変更内容 |
|----------|----------|----------|
| Proto | `proto/alt/augur/v2/augur.proto` | `thinking_delta` ペイロード追加 (field 7) |
| Domain | `rag-orchestrator/internal/domain/llm_client.go` | `LLMStreamChunk.Thinking` フィールド追加 |
| Usecase | `rag-orchestrator/internal/usecase/rag_answer_types.go` | `StreamEventKindThinking` 定数追加 |
| Adapter | `rag-orchestrator/internal/adapter/rag_augur/ollama_generator.go` | thinking/content 分離抽出 |
| Usecase | `rag-orchestrator/internal/usecase/rag_answer_stream.go` | thinking イベント送出 |
| Handler | `rag-orchestrator/internal/adapter/connect/augur/handler.go` | thinking 変換処理 |
| API Client | `alt-frontend-sv/src/lib/connect/augur.ts` | `onThinking` コールバック追加 |
| Component | `alt-frontend-sv/src/lib/components/desktop/augur/ChatMessage.svelte` | thinking 表示 UI |
| Component | `alt-frontend-sv/src/lib/components/desktop/augur/AugurChat.svelte` | thinking 状態管理 |

### UI 仕様

```svelte
{#if isThinking || thinking}
  <details open={isThinking}>
    <summary>
      {#if isThinking}
        <Loader2 class="animate-spin" /> Thinking...
      {:else}
        <ChevronDown /> View reasoning
      {/if}
    </summary>
    <div class="thinking-content">
      {thinking}
    </div>
  </details>
{/if}
```

- **ストリーミング中**: `<details>` が開いた状態、スピナー表示
- **完了後**: 折りたたまれ、"View reasoning" で展開可能

### PROS

1. **UX 向上**: ユーザーが LLM の思考過程を確認可能
2. **透明性**: 回答の根拠を理解しやすい
3. **後方互換性**: thinking 非対応の LLM でも正常動作（空の thinking）

### CONS, TRADEOFF

1. **追加データ転送**: thinking ストリームで通信量増加
2. **UI 複雑化**: 折りたたみ UI の状態管理が必要

## APPENDIX

### デプロイ手順

```bash
# 1. Proto 再生成
cd proto && buf generate

# 2. rag-orchestrator リビルド・起動
docker compose -f compose/compose.yaml -p alt up -d rag-orchestrator --build

# 3. alt-frontend-sv リビルド・起動
docker compose -f compose/compose.yaml -p alt up -d alt-frontend-sv --build
```

### 検証方法

1. ブラウザで Augur チャットを開く
2. 質問を送信
3. "Thinking..." パネルが表示され、推論経過がストリーミング表示されることを確認
4. 回答完了後、"View reasoning" で推論を確認できることを確認

### Connect-RPC 移行 (2026-01-28 追記)

#### 移行前アーキテクチャ

```
Browser → BFF → alt-backend:9101 (Connect-RPC)
                      ↓ HTTP SSE
              rag-orchestrator:9010
                      ↓ parseSSEEvent()
              Connect-RPC proto response
```

**問題点**:
- SSE パース処理が必要で、新イベント追加のたびに alt-backend 修正が必要
- 型安全性が低い（文字列ベースのイベント解析）

#### 移行後アーキテクチャ

```
Browser → BFF → alt-backend:9101 (Connect-RPC)
                      ↓ Connect-RPC (直接)
              rag-orchestrator:9011
```

**メリット**:
- 型安全な proto メッセージの直接転送
- SSE パース不要（`parseSSEEvent`, `sanitizeMetaPayload`, `parseDonePayload` 関数を削除）
- 新イベント（`thinking_delta` 等）追加時に自動対応

#### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `app/port/rag_stream_port/rag_stream_port.go` | 新規: RAG ストリーミング用ポートインターフェース |
| `app/gateway/rag_connect_gateway/client.go` | 新規: Connect-RPC クライアント |
| `app/connect/v2/augur/handler.go` | SSE パース削除、Connect-RPC 直接呼び出しに変更 |
| `app/di/container.go` | `RagConnectClient` 初期化追加 |
| `app/connect/v2/server.go` | ハンドラーへの依存注入更新 |

#### Clean Architecture 準拠

```
Handler (augur/handler.go)
    ↓ depends on
Port (rag_stream_port.RagStreamPort)
    ↑ implements
Gateway (rag_connect_gateway.Client)
```

### 関連 ADR

- **ADR 093**: Augur チャット引用表示の改善
- **ADR 153**: LLM Modelfile 最適化
