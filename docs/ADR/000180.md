# alt-backend責務分析: マイクロサービスベストプラクティスとの比較

## ADR's STATUS

Accepted

## CONTEXT

alt-backendのサービス責務が肥大化していないか、マイクロサービスのベストプラクティスに沿っているかを評価する必要があった。特にalt-butterfly-facade（BFF）との責務分担が適切かどうかを検証した。

### 現在のサービス責務

#### alt-backend (Core Domain Service)
- **70+ usecases**: すべてのビジネスロジックを実装
- **Feed Management**: フィード取得、登録、検証、検索
- **Article Processing**: 記事取得、全文検索、タグ付け、要約
- **RAG/Knowledge**: コンテキスト検索、チャットインターフェース
- **Recap**: 7日間サマリー、日付範囲記事取得
- **Morning Letter**: パーソナライズ朝刊
- **Scraping Domain**: robots.txt準拠
- **Background Jobs**: 時間毎フィード取得、日次スクレイピングポリシー更新、Outbox Worker
- **Multi-tenancy**: ユーザー/テナント分離
- **Database Access**: PostgreSQL 50+ クエリ操作

#### alt-butterfly-facade (BFF)
- **Transparent Proxy**: alt-backendへの透過的転送
- **JWT Validation**: トークン検証（フロントエンド向け）
- **Response Caching**: 特定エンドポイントのキャッシュ (15-30s TTL)
- **Circuit Breaker**: バックエンド障害時の復元力パターン
- **Request Deduplication**: 重複リクエスト防止
- **Error Normalization**: エラーレスポンスの標準化
- **Aggregation**: 複数クエリの並列取得 (feed_stats, unread_count等)

## DECISION MAKING

### マイクロサービスベストプラクティス調査

#### Sam Newman's BFF Pattern
> Source: [samnewman.io/patterns/architectural/bff](https://samnewman.io/patterns/architectural/bff/)

| 原則 | 説明 |
|------|------|
| **One experience, one BFF** | UIタイプごとにBFFを分離 |
| **BFFの責務** | UI固有の集約・データ変換 |
| **Backendの責務** | ドメイン中心のビジネスロジック |
| **共通化のタイミング** | 同じロジックが3+箇所に出現したとき |
| **Anti-pattern** | BFFに複数UIタイプを混在させる |

#### Microsoft Azure Architecture Center
> Source: [learn.microsoft.com/azure/architecture/patterns/backends-for-frontends](https://learn.microsoft.com/en-us/azure/architecture/patterns/backends-for-frontends)

**BFFを使うべき場面:**
- 異なるインターフェースが**大幅に異なるリクエスト**を行う
- クライアントデバイスに**相反するパフォーマンス要件**がある
- フロントエンドチームが**独立したデプロイ自律性**を必要とする

**BFFを使わないべき場面:**
- 複数インターフェースが**同じまたは類似のリクエスト**を行う
- **単一インターフェース**のみがバックエンドと通信する
- **GraphQL**を使用している（BFFの必要性を排除）

### 評価結果: **程よい (Well-balanced)**

現在のアーキテクチャはベストプラクティスに沿っている。

```
┌─────────────────────────────────────────────────────────────┐
│  Frontend (alt-frontend-sv)                                 │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  BFF (alt-butterfly-facade)                                 │
│  - JWT検証                                                   │
│  - レスポンスキャッシュ                                       │
│  - Circuit Breaker                                          │
│  - リクエスト重複排除                                         │
│  - エラー正規化                                              │
│  - クエリ集約 (4種)                                          │
│  ※ ビジネスロジックは含まない                                 │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  Domain Service (alt-backend)                               │
│  - 全ビジネスロジック (70+ usecases)                          │
│  - データアクセス層                                           │
│  - 外部サービス連携 (pre-processor, recap-worker, etc.)       │
│  - バックグラウンドジョブ                                     │
│  - マルチテナンシー                                           │
└─────────────────────────────────────────────────────────────┘
```

| 観点 | 評価 | 理由 |
|------|------|------|
| **ドメインロジック分離** | ✅ 適切 | alt-backendに全ビジネスロジック集約 |
| **BFF責務** | ✅ 適切 | UI固有の最適化のみ（キャッシュ、集約、復元力） |
| **データアクセス** | ✅ 適切 | DBアクセスはalt-backendに限定 |
| **外部サービス連携** | ✅ 適切 | alt-backendが他サービスと連携 |
| **認証** | ✅ 適切 | Defense in depth（両層で検証） |

### サービス間通信パターン分析

alt-backendが連携しているサービス:

```
alt-backend (Orchestrator)
    │
    ├─→ search-indexer (Connect-RPC) ── Meilisearch検索
    ├─→ rag-orchestrator (REST+Connect-RPC) ── RAG/ナレッジ
    ├─→ mq-hub (Connect-RPC) ── イベント発行
    ├─→ auth-hub/Kratos (REST) ── 認証
    ├─→ pre-processor (REST) ── 記事要約
    └─→ recap-worker (REST) ── レキャップ生成
```

これは**Orchestrationパターン**であり、適切に機能している:

| 観点 | Orchestration | Choreography |
|------|---------------|--------------|
| 制御 | 中央集権（alt-backend） | 分散（各サービスがイベント駆動） |
| フロー可視性 | 高い（コードを見ればわかる） | 低い（イベントチェーンを追跡必要） |
| 単一障害点 | あり（オーケストレーター） | なし |
| 結合度 | 高い（API依存） | 低い（イベント契約のみ） |

## RESULTS, EFFECTS

**決定: alt-backendのサイズは「程よい」- 現状維持**

### PROS

1. **ビジネスロジックの一元管理**: 全ビジネスロジックを一箇所に集約することで、整合性とメンテナンス性を確保
2. **適切なBFF分離**: alt-butterfly-facadeがUI固有の最適化を担当し、ドメインロジックとの分離が明確
3. **過度な分割を回避**: マイクロサービス過多を避け、適切な粒度を維持
4. **運用コストの最適化**: 現在の規模では単一サービスの方が運用コストが低い
5. **ドメイン境界が明確**: 各連携サービスは独立したドメインを持ち、alt-backendは「調整役」として機能

### CONS, TRADEOFF

#### 潜在的リスク

| リスク | 現状 | 影響度 |
|-------|------|-------|
| **単一障害点** | alt-backendダウン = 全機能停止 | 中〜高 |
| **スケーリングボトルネック** | 下流サービス遅延がalt-backendに影響 | 中 |
| **API結合** | 下流サービスAPI変更時にalt-backend修正必要 | 低〜中 |

#### 緩和策（実装済み）

- alt-butterfly-facade: Circuit Breaker実装
- Rate Limiting: 5秒間隔で外部API保護
- Graceful degradation可能（RAG失敗しても基本機能は動作）
- mq-hubによる非同期イベント発行でChoreography要素も導入済み

## APPENDIX

### 監視すべき点

1. **BFFへのビジネスロジック流入**: 集約ロジックがドメイン判断を含み始めたら要注意
2. **alt-backendへのUI固有コード流入**: レスポンス形式がUI要件で変化し始めたら要注意
3. **新UIタイプの出現**: モバイルアプリなど新クライアントが出現した場合、別BFF検討

### 将来の分割候補（現時点では不要）

| 候補サービス | 責務 | 分割トリガー |
|------------|------|------------|
| feed-service | フィード取得・登録 | フィード処理の独立スケーリング要件 |
| article-service | 記事取得・検索 | 検索負荷の独立スケーリング要件 |
| recap-service | 要約・レキャップ | AI処理の独立スケーリング要件 |

### 改善候補（将来検討）

| 改善策 | メリット | デメリット | 推奨度 |
|-------|---------|-----------|-------|
| **Service Mesh導入** | 通信の可観測性、リトライ自動化 | 運用複雑化 | △ |
| **mq-hub経由のChoreography移行** | 疎結合化、復元力向上 | フロー追跡困難 | △ |
| **Sagaパターン導入** | 分散トランザクション対応 | 実装複雑 | × 不要 |

### 参考資料

- [Sam Newman - Backends For Frontends](https://samnewman.io/patterns/architectural/bff/)
- [Microsoft - Backends for Frontends Pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/backends-for-frontends)
- [Teleport - BFF Pattern](https://goteleport.com/learn/cybersecurity-best-practices/backend-for-frontend-bff-pattern/)
- [TSH - Design patterns in microservices](https://tsh.io/blog/design-patterns-in-microservices-api-gateway-bff-and-more/)
