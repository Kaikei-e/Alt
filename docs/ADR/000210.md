# ADR-000210: alt-frontend-sv パスベースルーティングからレスポンシブデザインへの全ルート移行 (Phase 2)

## STATUS

Accepted（実装完了・コンテナ再ビルド・ヘルスチェック・全ルート疎通確認済み）

## CONTEXT

Phase 1 (ADR 対象外) で以下のインフラを構築済み:

- `viewport.svelte.ts` — MediaQuery (768px) によるデバイス判定
- `ResponsiveLayout.svelte` — Sidebar (desktop) / FloatingMenu (mobile) の自動切替
- `(app)` ルートグループ — `ssr=false`, SystemLoader 付きの共通レイアウト
- `/feeds` ルート — 初のレスポンシブ統一ページ

課題: 残り 13 ルートがまだ `/desktop/*` と `/mobile/*` のパスベース分離のまま残っており、以下の問題があった。

1. **URL の二重管理**: 同一機能に Desktop と Mobile で異なる URL が存在
2. **SEO / リンク共有**: デバイス固有 URL を共有するとレイアウト崩れ
3. **ナビゲーション更新漏れ**: Sidebar と FloatingMenu のリンクが別々に管理され不整合が発生しやすい

## DECISION MAKING

### 方針

Phase 1 で確立した `{#if isDesktop} ... {:else} ... {/if}` パターンを全ルートに適用。各ルートは `(app)` グループ配下に統一パスで配置し、既存の Desktop/Mobile コンポーネントをそのままラップする。

### バッチ構成と実装順序

複雑度に応じてバッチ分割し、依存関係の少ないルートから実施:

| Batch | ルート | 複雑度 | 概要 |
|-------|--------|--------|------|
| A | `/augur`, `/recap/morning-letter`, `/feeds/tag-trail`, `/feeds/favorites` | 低 | シンプルラッパー |
| B | `/feeds/search`, `/feeds/viewed` | 中〜高 | 検索・閲覧履歴（Desktop: infinite scroll + modal） |
| C | `/recap/evening-pulse`, `/recap/job-status`, `/recap` | 高〜最高 | Recap 群。`/recap` は 3-day/7-day 統合 |
| D | `/settings/feeds`, `/stats` | 中〜高 | 設定・統計（server load 付き） |
| E | `/feeds/swipe` | 中 | Mobile 専用機能のデスクトップフォールバック |

実施順: **A → B → C1(evening-pulse) → C3(job-status) → D → E → C2(recap 本体)**

### /recap の 3-day / 7-day 統合

Mobile では `/mobile/recap/3days` と `/mobile/recap/7days` が別ルートだったものを、Desktop パターンに合わせて URL クエリパラメータ `?window=7` で切替える方式に統一。デフォルトは 3-day。

### Dashboard (/) の扱い

`(app)/+page.svelte` は root の `+page.svelte`（ランディングページ）と SvelteKit のルートグループ解決で衝突するため、Dashboard の独立ルートは作成せず `/sv/desktop` → `/sv/feeds` へリダイレクト。Sidebar の Dashboard リンクも `/sv/feeds` を指す。今後 Phase 3 で `(app)` 内に専用ダッシュボードを検討可能。

## RESULTS

### 新規作成ファイル (15 files)

```
src/routes/(app)/augur/+page.svelte
src/routes/(app)/recap/morning-letter/+page.svelte
src/routes/(app)/feeds/tag-trail/+page.svelte
src/routes/(app)/feeds/tag-trail/+page.server.ts
src/routes/(app)/feeds/favorites/+page.svelte
src/routes/(app)/feeds/search/+page.svelte
src/routes/(app)/feeds/viewed/+page.svelte
src/routes/(app)/recap/evening-pulse/+page.svelte
src/routes/(app)/recap/+page.svelte
src/routes/(app)/recap/job-status/+page.svelte
src/routes/(app)/settings/feeds/+page.svelte
src/routes/(app)/settings/feeds/+page.server.ts
src/routes/(app)/stats/+page.svelte
src/routes/(app)/feeds/swipe/+page.svelte
src/routes/(app)/feeds/swipe/+page.ts
```

### 編集ファイル (4 files)

| ファイル | 変更内容 |
|---------|---------|
| `hooks.server.ts` | リダイレクトマップ: 2 → 26 エントリ |
| `Sidebar.svelte` | 全 href を統一パスに更新 |
| `FloatingMenu.svelte` | 全 href を統一パスに更新 |
| `navigation.ts` | `desktopNavigation` + `mobileMenuItems` の全パス更新 |

### リダイレクトマップ (26 entries)

`hooks.server.ts` に 301 Permanent Redirect を設定。クエリパラメータ付きリダイレクト (`/sv/mobile/recap/7days` → `/sv/recap?window=7`) も SvelteKit の `redirect()` で問題なく動作確認済み。

### ハードコードされたナビゲーションパスの修正

Evening Pulse 内の `goto()` 呼び出しを統一パスに更新:

- `goto("/sv/desktop/recap")` → `goto("/sv/recap")`
- `goto("/sv/mobile/recap/3days")` → `goto("/sv/recap")`
- `goto("/sv/mobile/recap/3days?cluster=${id}")` → `goto("/sv/recap?cluster=${id}")`

Settings ページの `goto("/sv/mobile/feeds")` → `goto("/sv/feeds")` も修正。

### 未移行ルート

以下は Phase 2 の対象外として `/mobile/` パスに残留:

- `/mobile/feeds/register` — フィード登録
- `/mobile/articles/view` — 記事一覧
- `/mobile/articles/search` — 記事検索

## VERIFICATION

### 自動検証

| 検証 | 結果 |
|------|------|
| `bun run check` | 0 errors, 0 warnings |
| `bun run build` | 成功 (33s) |
| `bunx vitest run --project server` | 24 files, 318 tests PASS |
| `bun run lint` | 新規の error なし (既存 warnings のみ) |
| `bun run format` | 1 file auto-formatted |

### コンテナ検証

| 検証 | 結果 |
|------|------|
| `docker compose build alt-frontend-sv` | 成功 |
| ヘルスチェック `/sv/health` | OK |
| 新パス 12 ルート全疎通 | 全て 200 OK |
| 301 リダイレクト (7 パターン抽出確認) | 全て正しいターゲットに転送 |
| Desktop UI 表示 (`/sv/home`) | 確認済み |

## PROS

1. **単一 URL**: 同一機能に 1 つの URL。デバイスに関わらずリンク共有が可能
2. **非破壊的移行**: 旧パスは 301 リダイレクトで継続動作。ブックマーク・外部リンクが壊れない
3. **コンポーネント再利用**: 既存の Desktop/Mobile コンポーネントをそのままラップ。UI の変更なし
4. **段階的移行**: 未移行ルートは旧パスで引き続き動作。Phase 3 で残りを対応可能
5. **ナビゲーション一元化**: Sidebar, FloatingMenu, navigation.ts の全パスが統一パスを参照

## CONS

1. **旧ルートの残存**: `routes/desktop/` と `routes/mobile/` ディレクトリは Phase 3 まで削除不可
2. **バンドルサイズ**: Desktop/Mobile 両方のコンポーネントが各ページに含まれる（tree-shaking で軽減）
3. **Dashboard 制約**: ルートグループの衝突により `/` にダッシュボードを配置できず `/feeds` にリダイレクト
4. **Register Feed 未移行**: `/mobile/feeds/register` は統一パスへの移行が残っている
