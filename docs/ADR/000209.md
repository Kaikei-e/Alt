# RAG Orchestrator TTFT ボトルネック修正 (計測ベース最適化)

## ADR's STATUS

Accepted (実装完了・コンテナ再ビルド・ヘルスチェック確認済み)

## CONTEXT

### 背景

ADR-208 で空レスポンス修正と TTFT 高速化（パイプライン並列化・タイムアウト最適化・接続プール導入）を実施した。空レスポンス問題は解消し、982 文字の回答生成に成功したが、実計測の結果 TTFT が 76〜93 秒と目標（10 秒）に大幅未達であることが判明した。

### 計測結果

| 指標 | Query 1 | Query 2 |
|------|---------|---------|
| TTFE (最初のイベント) | 7ms | 4ms |
| Retrieval 完了 | 46,844ms | 46,191ms |
| TTFT (最初の delta) | 76,336ms | 92,663ms |
| Total | 131,705ms | 162,502ms |

### ボトルネック分析

ログから以下の 3 大ボトルネックを特定した。

```
Stage 1 (Query Expansion):
  Query Expansion:     36,645ms
    - 到達不能サービスへの接続タイムアウト待ち: 30,000ms
    - Ollama fallback (実処理):               6,645ms
  → 逐次実行のため 30秒 + 7秒 = 37秒

Stage 3 (Reranking):
  Reranking (100 候補): 10,000ms (タイムアウト)
  → Cross-encoder 推論が 100 件で ~9秒、タイムアウト超過

LLM Generation:
  Prompt Processing (prefill): 23-46秒
  → 10 チャンクのコンテキストによる大きなプロンプト
```

## DECISION MAKING

### 方針

計測データに基づき、効果の大きい順に 4 つの修正を行う。全て設定値変更またはロジック変更のみで、新規ファイル追加なし。

### 1. Query Expansion タイムアウト短縮: 30秒 → 3秒 [P0]

**根本原因:** Query Expansion の primary サービスが compose profile 外で未起動の場合、毎回 30 秒のタイムアウト待ちが発生していた。

**修正:**
- compose 環境変数と Go コードのデフォルト値を `30` → `3` に変更
- GPU 推論で稼働している場合は通常 1-2 秒で完了するため、3 秒で十分

### 2. Rerank 候補数削減: 100 → 30 [P0]

**根本原因:** 100 候補の cross-encoder 推論が ~9 秒かかり、Docker ネットワーク経由でタイムアウトを超過していた。

**修正:**
- `maxRerankCandidates` を `100` → `30` に削減
- 30 候補 → ~2.7 秒（900ms/10 件 × 3）で 10 秒タイムアウト枠内に余裕
- 候補は RRF スコアで既にランク付け済みのため、上位 30 件で検索品質への影響は最小限

### 3. Query Expansion の並列実行 [P1]

**根本原因:** `expandQuery()` が primary → fallback を逐次実行していたため、primary タイムアウト後に fallback 開始で合計時間が加算されていた。

**修正:**
- primary (GPU) と fallback (Ollama) を goroutine で並列実行
- 先に成功した方を採用する fan-out パターン
- Stage 1 の所要時間が `primary + fallback` → `max(primary, fallback)` に改善

### 4. コンテキストチャンク数削減: 10 → 7 [P1]

**根本原因:** 10 チャンク × 平均 800 文字 = ~8000 文字のコンテキストにより、LLM の prefill (prompt processing) に 23-46 秒かかっていた。

**修正:**
- `RAG_DEFAULT_MAX_CHUNKS` のデフォルト値を `10` → `7` に変更
- プロンプトサイズ ~30% 削減に比例して prefill 時間が短縮

## RESULTS, EFFECTS

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `compose/rag.yaml` | `QUERY_EXPANSION_TIMEOUT` 30 → 3 |
| `rag-orchestrator/internal/infra/config/config.go` | `QueryExpansionTimeout` デフォルト 30 → 3、`AnswerMaxChunks` デフォルト 10 → 7 |
| `rag-orchestrator/internal/usecase/retrieve_context_usecase.go` | `expandQuery()` を fan-out 並列化、`maxRerankCandidates` 100 → 30 |
| `rag-orchestrator/internal/usecase/retrieve_context_usecase_test.go` | 並列 expandQuery に対応したモック修正 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `go test ./... -count=1` | PASS (全パッケージ) |
| `go test ./... -race` | PASS (データ競合なし) |
| コンテナビルド (`--no-cache`) | 成功 |
| ヘルスチェック (`/healthz`) | `{"status":"ok"}` |
| レディネスチェック (`/readyz`) | `{"status":"ready"}` |
| 起動ログ: reranker_enabled | 確認 |
| 起動ログ: hybrid_search_enabled | 確認 |

### 期待される改善効果

| フェーズ | 修正前 | 修正後 (期待) |
|---------|--------|-------------|
| Stage 1 (Query Expansion) | 36.6秒 | ~7秒 |
| Stage 2 (Embed + Search) | 0.17秒 | 0.17秒 |
| Stage 3 (Reranking) | 10秒 (timeout) | ~3秒 |
| **Retrieval 合計** | **~47秒** | **~10秒** |
| LLM Prefill | ~30秒 | ~20秒 |
| **TTFT** | **~77秒** | **~30秒** |

### PROS

- **計測データに基づく最適化**: ログから特定した 3 大ボトルネックに的を絞った修正で、推測ベースの最適化ではない
- **fan-out パターンによる耐障害性向上**: primary サービス障害時でも fallback が即座に利用可能（逐次タイムアウト待ちなし）
- **既存テスト全件 PASS**: データ競合検出 (`-race`) も含めて問題なし
- **設定値変更のみ**: 新規ファイル追加なし、コードの構造変更は `expandQuery()` のみ

### CONS, TRADEOFF

- **TTFT 10 秒未達**: 今回の修正で ~77 秒 → ~30 秒の改善を見込むが、目標の 10 秒には LLM prefill の高速化（バッチサイズ調整、モデル量子化等）が追加で必要
- **Rerank 候補数削減による検索品質リスク**: 100 → 30 候補への削減で、低ランクだがリランク後に浮上する候補を取りこぼす可能性がある。RRF スコアによる事前ランキングで緩和されるが、品質計測での検証が望ましい
- **並列 expansion の計算コスト**: 両方の展開方式が常に実行されるため、primary が正常稼働時も fallback のリソースを消費する

## APPENDIX

### expandQuery() fan-out パターン

```
expandQuery()
  ├── goroutine: primary (GPU service)  ──┐
  └── goroutine: fallback (Ollama LLM)  ──┤ ch (buffered, cap=2)
                                           │
  for range 2:                             │
    r := <-ch                              │
    if r.err == nil → return r.queries  ←──┘
  return error("all methods failed")
```

### TTFT 計測方法

```bash
python3 -c "
import http.client, json, time
conn = http.client.HTTPConnection('localhost', 9010, timeout=300)
body = json.dumps({'query': 'テストクエリ'})
start = time.perf_counter()
conn.request('POST', '/v1/rag/answer/stream', body,
             {'Content-Type': 'application/json', 'Accept': 'text/event-stream'})
resp = conn.getresponse()
for line in resp:
    decoded = line.decode().strip()
    if 'delta' in decoded:
        print(f'TTFT: {(time.perf_counter()-start)*1000:.0f}ms')
        break
conn.close()
"
```

### 今後の改善候補 (TTFT 10 秒以内への道)

| 施策 | 期待効果 | 難易度 |
|------|---------|--------|
| Ollama prefill バッチサイズ調整 | prefill 20秒 → 10秒 | 低 |
| Ollama expansion の高速化 (小型モデル) | expansion 7秒 → 3秒 | 中 |
| プロンプトキャッシュ (同一システムプロンプト) | prefill 20秒 → 5秒 | 中 |
| Speculative Decoding の導入 | 生成速度 2-3x 向上 | 高 |
