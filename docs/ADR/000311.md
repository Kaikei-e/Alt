# ADR-000311: OGP 画像プロキシ 502 エラーおよびレートリミッター連鎖障害の修正

## ADR's STATUS

完了

## CONTEXT

本番環境の HAR 解析およびコンテナログ突合により、画像プロキシ機能に**3つの根本原因**が特定された。

### 発生していたエラー

| Status | エンドポイント | エラー内容 | 特徴 |
|--------|---------------|-----------|------|
| **502** | `/v1/images/proxy/{hash}` | `decode image: image: unknown format` | 画像フェッチ後 10〜20秒で失敗 |
| **502** | 同上（リトライ） | `rate limit: Wait(n=1) would exceed context deadline` | 即座に失敗（0ms） |

### 根本原因 1: WebP デコーダー未登録

`image.Decode()` は標準ライブラリの JPEG/PNG/GIF のみをサポートしている。画像フェッチ時に `Accept: image/*` を送信するため、CDN が `format=auto` で WebP を返却した場合、デコードに失敗して `image: unknown format` となる。

`golang.org/x/image v0.36.0` は `go.mod` に存在していたが（`draw` パッケージで使用）、`webp` パッケージの side-effect import がなかった。

### 根本原因 2: レートリミッター共有による連鎖障害

画像プロキシが RSS フィード取得と**同一の `HostRateLimiter`（10秒間隔/ホスト）**を共有していた。ブラウザが同一 CDN ホストへの複数画像リクエストをミリ秒単位で送信すると、25秒のコンテキストタイムアウト内に 10秒のレートリミット待機が収まらず、`context deadline exceeded` で即座に 502 を返す連鎖障害が発生していた。

### 根本原因 3: Accept ヘッダーの曖昧さ

`Accept: image/*` は CDN にフォーマット選択を委ねる。デコーダーがサポートしない形式（AVIF、HEIF 等）が返却される可能性があり、防御が不十分だった。

## DECISION MAKING

### 1. WebP デコーダーの side-effect import 追加

`processing_gateway.go` に `_ "golang.org/x/image/webp"` を追加し、`image.Decode()` に WebP デコーダーを登録する。

新規の依存関係追加は不要（`golang.org/x/image` は `draw` パッケージ経由で既に導入済み）。

### 2. Accept ヘッダーの明示化（Defense-in-depth）

```
Before: Accept: image/*
After:  Accept: image/webp, image/jpeg, image/png, image/gif
```

デコーダーがサポートする形式のみを明示的に要求する。WebP を最優先とし、CDN の `format=auto` による予期しない形式の返却を防止する。

### 3. 画像プロキシ専用レートリミッターの導入

Image CDN は高スループットに設計されており、RSS フィード取得用の 10秒間隔を共有すべきではない。専用の `HostRateLimiter`（3秒間隔）を作成し、画像プロキシユースケースに注入する。

```
RSS フィード取得:  HostRateLimiter(10s/host)  ← 従来通り
画像プロキシ:      HostRateLimiter(3s/host)   ← 新規・専用
```

3秒間隔は外部 API への礼儀を保ちつつ、ブラウザからの複数同時リクエストがコンテキストタイムアウト内に完了する最小間隔として選定した。

## RESULTS, EFFECTS

### PROS

- WebP 形式の OGP 画像がデコード・リサイズ・JPEG 変換されて正常に配信される
- 同一 CDN ホストへの複数画像リクエストがレートリミッターのタイムアウトで連鎖的に失敗しなくなる
- RSS フィードの取得レートと画像プロキシのレートが独立し、互いに干渉しない
- Accept ヘッダーの明示化により、デコーダー未対応の形式が返却されるリスクが低減

### CONS, TRADEOFF

- 画像プロキシのレート間隔（3秒）は RSS フィード取得（10秒）より短い。CDN 側の許容範囲内だが、特定ホストへの集中時に制限を受ける可能性はゼロではない
- `Accept` ヘッダーの明示化により、将来 AVIF 等の新形式をサポートする際にはデコーダー追加とヘッダー更新の両方が必要になる

## APPENDIX

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `alt-backend/app/gateway/image_proxy_gateway/processing_gateway.go` | `_ "golang.org/x/image/webp"` import 追加 |
| 2 | `alt-backend/app/gateway/image_proxy_gateway/processing_gateway_test.go` | WebP デコードテスト追加（TDD） |
| 3 | `alt-backend/app/gateway/image_fetch_gateway/image_fetch_gateway.go` | Accept ヘッダーを明示的な形式リストに変更 |
| 4 | `alt-backend/app/di/container.go` | 画像プロキシ専用 `HostRateLimiter(3s)` 作成、DI 注入先を変更 |
| 5 | `alt-backend/app/gateway/image_proxy_gateway/testdata/test.webp` | テスト用 WebP 画像（`golang.org/x/image` テストデータ由来） |

### TDD プロセス

1. **RED**: `TestProcessingGateway_ProcessImage_WebP` を追加 → `decode image: image: unknown format` で失敗
2. **GREEN**: `_ "golang.org/x/image/webp"` import 追加 → テスト通過
3. **全テスト確認**: `go test ./gateway/image_proxy_gateway/... -v` — 全 PASS

### 検証結果

- ユニットテスト: `go test ./gateway/image_proxy_gateway/...` 全 PASS
- ビルド: `go build ./...` 成功
- コンテナ再ビルド: `docker compose up -d --build alt-backend` 成功
- ヘルスチェック: `GET /v1/health` → `{"database":"connected","status":"healthy"}`

### 関連 ADR

- [ADR-307](000307.md): RSS XML からの OGP 画像 URL 抽出とバックグラウンドプリフェッチ
- [ADR-308](000308.md): 画像プロキシのドメイン許可リストにサブドメインマッチングを導入
- [ADR-309](000309.md): visual-preview OGP 画像非表示バグの修正
- [ADR-310](000310.md): OGP 画像即時表示システム — 実装完了まとめ
