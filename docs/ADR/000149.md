# Recap Job ステータス判定ロジックの修正

## ADR's STATUS

Accepted

## CONTEXT

### 背景

7days recap ジョブが `genres_stored=0`（何も保存されていない）にもかかわらず `JobStatus::Completed` としてマークされる問題が発生していた。

```
genres_stored:0, genres_failed:55, genres_skipped:0, genres_no_evidence:5
automatic recap batch completed
```

### 根本原因

#### 直接的な原因

`scheduler/jobs.rs` の `run_job` メソッドで `pipeline.execute()` が `Ok(PersistResult)` を返すと、`PersistResult` の中身をチェックせずに `JobStatus::Completed` にマークしていた。

```rust
match self.pipeline.execute(&context).await {
    Ok(_) => {  // ← PersistResultの中身を見ていない
        self.recap_dao
            .update_job_status_with_history(..., JobStatus::Completed, ...)
```

#### 連鎖的な原因

1. **バッチサマリー API エラー**: 空の `representative_sentences` を持つクラスタが含まれていると 422 エラーが発生
2. **全ジャンル失敗**: すべてのジャンルが失敗
3. **Persist ステージ**: `genres_stored=0` でも `Ok(PersistResult)` を返す

### 検討した選択肢

| 選択肢 | 説明 | 採用 |
|--------|------|------|
| A. Persist ステージでエラーを返す | `genres_stored=0` の場合に `Err` を返す | 不採用: リトライ時の状態管理が複雑化 |
| B. Scheduler で PersistResult を検査 | 結果オブジェクトの内容に基づき判定 | **採用** |
| C. 専用の JobOutcome enum を導入 | 成功/失敗/部分成功を明示的に区別 | **採用** (B と組み合わせ) |

## DECISION MAKING

### 方針

1. **Scheduler レベル**: `PersistResult` の内容を検査し、適切なステータスを設定
2. **Dispatch レベル**: 空の `representative_sentences` を持つクラスタを事前フィルタリング

### ジョブ成功判定ロジック

| genres_stored | genres_failed/skipped | genres_no_evidence | 結果 |
|--------------|----------------------|-------------------|------|
| > 0 | any | any | Completed (部分成功) |
| 0 | > 0 | any | **Failed** (新規) |
| 0 | 0 | > 0 | Completed (記事なしは正当) |
| 0 | 0 | 0 | Completed (空ジョブは正当) |

### TDD テスト

各修正に対してテストを先に書いた (RED -> GREEN)。

| テストファイル | 検証内容 |
|----------------|----------|
| `scheduler/jobs.rs` | 6 テスト: 成功判定ロジック |
| `pipeline/dispatch.rs` | 2 テスト: 空クラスタフィルタリング |

## RESULTS, EFFECTS

### 変更ファイル一覧

#### recap-worker

| ファイル | 変更内容 |
|----------|----------|
| `src/scheduler/jobs.rs` | `JobOutcome` enum 追加、`evaluate_job_outcome()` 関数追加、`run_job()` でステータス判定ロジック修正 |
| `src/pipeline/dispatch.rs` | 空の `representative_sentences` を持つクラスタのフィルタリング追加 |

### 主要な変更点

#### 1. JobOutcome enum の導入

```rust
enum JobOutcome {
    Success,
    Failed(String),
}
```

#### 2. evaluate_job_outcome 関数

`PersistResult` を検査し、`JobOutcome` を返す。ロジックは上記の判定表に従う。

#### 3. 空クラスタのフィルタリング

バッチリクエスト構築時に `representative_sentences` が空のクラスタを除外。全クラスタが空の場合はそのジャンルをエラーとして記録。

### PROS

1. **正確なステータス報告**: 実際に何も生成されなかった場合に `Failed` として記録
2. **デバッグ容易性**: エラー理由がログと DB に記録される
3. **422 エラー予防**: 空クラスタを事前にフィルタリング
4. **部分成功の維持**: 一部のジャンルが成功すれば全体は `Completed`

### CONS, TRADEOFF

1. **ログ量増加**: フィルタリング時に追加のログが出力される
2. **判定ロジックの複雑化**: 単純な `Ok/Err` から内容検査へ

## APPENDIX

### 検証方法

```bash
# ユニットテスト
cd recap-worker/recap-worker
cargo test scheduler::jobs::tests -- --nocapture
cargo test pipeline::dispatch::tests -- --nocapture

# コンテナ再ビルド・再起動
docker compose -f compose/compose.yaml -p alt build recap-worker
docker compose -f compose/compose.yaml -p alt up -d recap-worker

# ログ確認
docker compose -f compose/compose.yaml -p alt logs recap-worker -f
```

### 期待する動作

- `genres_stored=0` かつ `genres_failed > 0` の場合:
  - ログに `"job completed but no genres were stored - marking as failed"` が出力
  - ジョブステータスが `failed` に設定
  - エラー理由が DB に記録

### 関連 ADR

- ADR-113: Recap Job ステータス不整合の修正
- ADR-114: Recap Job ステータス履歴のイミュータブル化
- ADR-109: Recap Job Status Dashboard 実装
