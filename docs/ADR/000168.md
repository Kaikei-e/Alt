# オンザフライタグ生成の実装

## ADR's STATUS

Accepted

## CONTEXT

Tag Trail機能（ADR-167）の導入により、記事閲覧時にタグを即座に表示する必要が生じた。しかし既存のタグ生成はバッチ処理のみであり、以下の課題があった：

1. **タグ未生成問題**: 新規記事はバッチ処理完了までタグが存在しない
2. **ユーザー体験低下**: Tag Trailでタグが表示されない記事が多数存在
3. **リアルタイム性の欠如**: ユーザーのアクションに応じたタグ生成ができない

### 既存アーキテクチャ

```
alt-backend → mq-hub (Connect-RPC) → Redis Streams → tag-generator
                                                      ↓
                                                 バッチ処理（非同期）
```

バッチ処理は`ArticleCreated`イベントをトリガーとして非同期で実行され、結果はDBに保存されるが、リクエスト時に即座に結果を返すことはできなかった。

## DECISION MAKING

### 方針

**Request-Replyパターン**をRedis Streams上に実装し、同期的なタグ生成を可能にする。既存の非同期フローは維持しつつ、オンデマンドでタグ生成を行う経路を追加。

### アーキテクチャ

```
[既存フロー - 非同期バッチ]
alt-backend → mq-hub → Redis Stream (articles) → tag-generator
                                                  ↓
                                             Fire-and-forget

[新規フロー - 同期Request-Reply]
alt-backend ──(Connect-RPC)──> mq-hub ──(XADD)──> Redis Stream
                  │                                    ↓
                  │                              tag-generator
                  │                                    │
                  │                              タグ生成処理
                  │                                    │
                  └───────(XREAD block)───────── Reply Stream ←── (XADD)
```

### 実装詳細

#### Phase 1: Proto定義追加

```protobuf
// proto/clients/mqhub/v1/mqhub.proto
message GenerateTagsRequest {
  string article_id = 1;
  string title = 2;
  string content = 3;
  string feed_id = 4;
  int32 timeout_ms = 5;  // デフォルト: 30000ms
}

message GeneratedTag {
  string id = 1;
  string name = 2;
  float confidence = 3;
}

message GenerateTagsResponse {
  bool success = 1;
  string article_id = 2;
  repeated GeneratedTag tags = 3;
  float inference_ms = 4;
  string error_message = 5;
}

service MQHubService {
  // 同期タグ生成RPC
  rpc GenerateTagsForArticle(GenerateTagsRequest) returns (GenerateTagsResponse);
}
```

#### Phase 2: mq-hub実装 (Go)

**新規イベントタイプ**:
- `TagGenerationRequested`: タグ生成リクエスト
- `TagGenerationCompleted`: タグ生成完了（返信）

**ポート拡張**:
```go
type StreamPort interface {
    // 既存メソッド...

    // ブロッキング読み取り（タイムアウト付き）
    SubscribeWithTimeout(ctx context.Context, stream domain.StreamKey, timeout time.Duration) (*domain.Event, error)

    // 一時ストリーム削除
    DeleteStream(ctx context.Context, stream domain.StreamKey) error
}
```

**ユースケース**:
```go
func (u *GenerateTagsUsecase) GenerateTagsForArticle(
    ctx context.Context, req *GenerateTagsRequest,
) (*GenerateTagsResponse, error) {
    correlationID := uuid.New().String()
    replyStream := "alt:replies:tags:" + correlationID
    defer u.streamPort.DeleteStream(ctx, replyStream)

    // 1. リクエストイベント発行
    event := NewEvent(TagGenerationRequested, payload, metadata{
        "correlation_id": correlationID,
        "reply_to": replyStream,
    })
    u.streamPort.Publish(ctx, articlesStream, event)

    // 2. 返信待機（ブロッキング）
    reply, err := u.streamPort.SubscribeWithTimeout(ctx, replyStream, timeout)

    // 3. 結果パース・返却
    return parseResponse(reply)
}
```

#### Phase 3: tag-generator実装 (Python)

**StreamConsumer拡張**:
```python
async def publish_reply(self, stream_key: str, event_data: dict) -> str:
    """返信ストリームにイベントを発行"""
    fields = {
        "event_id": event_data.get("event_id"),
        "event_type": "TagGenerationCompleted",
        "source": "tag-generator",
        "payload": json.dumps(event_data.get("payload", {})),
    }
    return await self.client.xadd(stream_key, fields, maxlen=1)
```

**イベントハンドラ拡張**:
```python
async def _handle_tag_generation_requested(self, event: Event) -> None:
    reply_to = event.metadata.get("reply_to")
    correlation_id = event.metadata.get("correlation_id")

    # タグ生成（インライン）
    tags, inference_ms = await self._generate_tags_inline(
        article_id, title, content, feed_id
    )

    # 返信発行
    await self._publish_reply(reply_to, correlation_id, {
        "success": True,
        "tags": tags,
        "inference_ms": inference_ms,
    })
```

#### Phase 4: alt-backend統合

**Gatewayでのオンザフライ生成**:
```go
func (g *Gateway) FetchArticleTags(ctx context.Context, articleID string) ([]*domain.FeedTag, error) {
    // 1. DBからタグ取得を試行
    tags, err := g.altDB.FetchArticleTags(ctx, articleID)
    if len(tags) > 0 {
        return tags, nil
    }

    // 2. タグなし → オンザフライ生成
    if !g.config.OnTheFlyEnabled || g.mqhubClient == nil {
        return []*domain.FeedTag{}, nil  // 無効時は空配列
    }

    // 3. 記事コンテンツ取得
    article, _ := g.altDB.FetchArticleByID(ctx, articleID)

    // 4. mq-hub経由でタグ生成
    resp, err := g.mqhubClient.GenerateTagsForArticle(ctx, GenerateTagsRequest{
        ArticleID: articleID,
        Title:     article.Title,
        Content:   article.Content,
        TimeoutMs: g.config.TagGenerationTimeoutMs,
    })

    // 5. 結果返却（エラー時は空配列、リクエスト失敗にしない）
    return convertTags(resp.Tags), nil
}
```

## RESULTS, EFFECTS

### 変更ファイル一覧

| コンポーネント | ファイル | 変更内容 |
|--------------|---------|---------|
| proto | `proto/clients/mqhub/v1/mqhub.proto` | GenerateTags RPC追加 |
| proto | `proto/services/mqhub/v1/mqhub.proto` | GenerateTags RPC追加 |
| mq-hub | `app/domain/event.go` | 新規イベントタイプ追加 |
| mq-hub | `app/port/stream_port.go` | SubscribeWithTimeout, DeleteStream追加 |
| mq-hub | `app/driver/redis_driver.go` | XREAD block, DEL実装 |
| mq-hub | `app/usecase/generate_tags_usecase.go` | 新規ユースケース |
| mq-hub | `app/usecase/generate_tags_usecase_test.go` | テスト追加 |
| mq-hub | `app/connect/v1/mqhub/handler.go` | RPCハンドラ追加 |
| mq-hub | `app/connect/v1/mqhub/handler_test.go` | テスト追加 |
| tag-generator | `tag_generator/stream_consumer.py` | publish_reply追加 |
| tag-generator | `tag_generator/stream_event_handler.py` | TagGenerationRequestedハンドラ追加 |
| tag-generator | `tests/unit/test_stream_event_handler.py` | テスト追加 |
| alt-backend | `driver/mqhub_connect/client.go` | GenerateTagsForArticle追加 |
| alt-backend | `gateway/fetch_article_tags_gateway/gateway.go` | オンザフライ生成ロジック追加 |

### 設定項目

| コンポーネント | 設定 | デフォルト | 説明 |
|--------------|------|-----------|------|
| alt-backend | `OnTheFlyEnabled` | true | オンザフライ生成の有効化 |
| alt-backend | `TagGenerationTimeoutMs` | 30000 | タグ生成タイムアウト（ms） |
| mq-hub | - | - | 追加設定なし |
| tag-generator | - | - | 追加設定なし |

### PROS

1. **即時タグ表示**: DBにタグがなくてもリアルタイムで生成・表示
2. **後方互換性**: 既存の非同期バッチ処理は変更なし
3. **Graceful Degradation**: タグ生成失敗時は空配列を返し、リクエスト全体は失敗しない
4. **一時ストリームクリーンアップ**: 返信ストリームは使用後に自動削除
5. **TDD実装**: 全レイヤーでテストを先行実装

### CONS, TRADEOFF

1. **レイテンシ増加**: オンザフライ生成はML推論を含むため、最大30秒のタイムアウト設定
2. **リソース消費**: 同時リクエスト増加時、tag-generatorの負荷が上昇
3. **一時ストリーム**: 各リクエストで一時的なRedisストリームが作成される

## APPENDIX

### 検証コマンド

```bash
# ヘルスチェック
curl http://localhost:9003/v1/health  # mq-hub
curl http://localhost:8003/health     # tag-generator

# タグ取得（オンザフライ生成を含む）
curl http://localhost:9000/v1/feeds/articles/{article-id}/tags

# テスト実行
cd mq-hub && go test ./...
cd tag-generator/app && uv run pytest -v
cd alt-backend/app && go test ./...
```

### シーケンス図

```
┌─────────────┐     ┌─────────┐     ┌─────────────┐     ┌──────────────┐
│ alt-backend │     │ mq-hub  │     │ Redis Stream│     │tag-generator │
└──────┬──────┘     └────┬────┘     └──────┬──────┘     └──────┬───────┘
       │                 │                  │                   │
       │ GenerateTagsForArticle            │                   │
       │────────────────>│                  │                   │
       │                 │                  │                   │
       │                 │ XADD alt:events:articles             │
       │                 │ (TagGenerationRequested)             │
       │                 │─────────────────>│                   │
       │                 │                  │                   │
       │                 │                  │ XREADGROUP        │
       │                 │                  │<──────────────────│
       │                 │                  │                   │
       │                 │                  │      [ML推論]     │
       │                 │                  │                   │
       │                 │                  │ XADD alt:replies:tags:xxx
       │                 │                  │<──────────────────│
       │                 │                  │                   │
       │                 │ XREAD (blocking) │                   │
       │                 │<─────────────────│                   │
       │                 │                  │                   │
       │                 │ DEL alt:replies:tags:xxx             │
       │                 │─────────────────>│                   │
       │                 │                  │                   │
       │ GenerateTagsResponse              │                   │
       │<────────────────│                  │                   │
       │                 │                  │                   │
```

### Redis Streamsキー設計

| キー | 用途 | TTL |
|-----|------|-----|
| `alt:events:articles` | 記事イベントストリーム（既存） | なし |
| `alt:replies:tags:{correlationID}` | タグ生成返信（一時） | リクエスト完了後削除 |

### 関連ADR

- ADR-167: Tag Trail機能の追加
- ADR-169: Tag Trail記事検索の改善（タグ名検索への変更）
