# ADR-000259: ListSubscriptions 500 エラー修正 (subscription_driver.go SQL カラム不整合)

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000256 でフィードソース除外フィルタを導入し、ADR-000257 でツリーシェイクバグを修正、ADR-000258 で `(app)/feeds/+page.svelte` への配線を完了した。これにより `ListSubscriptions` RPC が正しく発行されるようになったが、バックエンドが 500 Internal Server Error を返却し、フィードソース一覧を取得できない状態が継続していた。

### 原因分析

`subscription_driver.go` の `FetchSubscriptions` メソッドが実行する SQL クエリが、`feed_links` テーブルに存在しない `created_at` カラムを参照していた。

**テーブル定義 (`feed_links`)**:

| カラム | 型 |
|-------|-----|
| `id` | `uuid` (PK) |
| `url` | `text` (UNIQUE) |

マイグレーション `20240101000200_create_feed_links.sql` で定義されたスキーマには `id` と `url` の 2 カラムのみが存在し、`created_at` カラムは追加されていない。

**問題の SQL**:

```sql
SELECT fl.id, fl.url,
       COALESCE(ufs.feed_link_id IS NOT NULL, FALSE) AS is_subscribed,
       fl.created_at  -- feed_links に存在しないカラム
FROM feed_links fl
LEFT JOIN user_feed_subscriptions ufs
    ON ufs.feed_link_id = fl.id AND ufs.user_id = $1
ORDER BY fl.url ASC
```

PostgreSQL が `column "fl.created_at" does not exist` エラーを返し、ドライバ → ゲートウェイ → ユースケース → ハンドラと伝播して 500 レスポンスとなっていた。

### なぜ発生したか

`user_feed_subscriptions` テーブル（`20260211000002` マイグレーションで追加）には `created_at` カラムが存在する。`FetchSubscriptions` の SQL を作成する際に、`created_at` のソーステーブルを誤って `fl` (`feed_links`) と指定してしまった。

## 意思決定

### 修正方針: `ufs.created_at` を COALESCE 付きで参照

`feed_links` にカラムを追加するのではなく、`user_feed_subscriptions.created_at`（購読日時）を使用する。LEFT JOIN のため未購読フィードでは NULL になるので、`COALESCE` で `NOW()` にフォールバックする。

```sql
-- Before:
fl.created_at

-- After:
COALESCE(ufs.created_at, NOW()) AS created_at
```

### 検討した代替案

| 案 | 不採用理由 |
|---|-----------|
| `feed_links` テーブルに `created_at` カラムを追加するマイグレーション | フィードリンク自体の作成日時は業務上不要。不要なスキーマ変更を避ける |
| `created_at` カラムを SELECT から除去し、ドメインモデルからも削除 | `domain.FeedSource.CreatedAt` は他の機能で利用される可能性があり、購読日時として保持する価値がある |
| `NOW()` ではなく固定値（epoch）をフォールバックに使用 | 未購読フィードのソート順に影響するが、現状 `ORDER BY fl.url ASC` のため `created_at` はソートに使用されておらず、`NOW()` で十分 |

### 変更内容

**`subscription_driver.go` L17**:

```go
// Before:
query := `
    SELECT fl.id, fl.url,
           COALESCE(ufs.feed_link_id IS NOT NULL, FALSE) AS is_subscribed,
           fl.created_at
    FROM feed_links fl
    ...
`

// After:
query := `
    SELECT fl.id, fl.url,
           COALESCE(ufs.feed_link_id IS NOT NULL, FALSE) AS is_subscribed,
           COALESCE(ufs.created_at, NOW()) AS created_at
    FROM feed_links fl
    ...
`
```

Go 側の `rows.Scan` は変更不要。`time.Time` 型でスキャンしており、`COALESCE` の結果が `timestamp` を返すため型互換性は維持される。

### 変更しなかったもの

| ファイル | 理由 |
|---------|------|
| `domain/subscription.go` | `FeedSource.Title` フィールドが常に空文字列になる既知の問題があるが、フロントエンドは `url` からドメイン名を抽出して表示しており機能的に問題なし。別 ADR で対応 |
| `subscription_gateway.go` | ゲートウェイ層は変更不要。ドライバからの戻り値をそのまま返却 |
| `subscription_usecase/` | ユースケース層は変更不要 |
| `connect/v2/feeds/handler.go` | ハンドラ層は変更不要 |
| マイグレーションファイル | スキーマ変更なし |

## 結果・影響

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/driver/alt_db/subscription_driver.go` | L17: `fl.created_at` → `COALESCE(ufs.created_at, NOW()) AS created_at` |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `go test ./...` (alt-backend) | パス (既存の `morning_usecase` ビルドエラーは本修正と無関係) |
| コンテナ再ビルド (`alt-backend`) | ビルド成功、起動正常 |
| ヘルスチェック (`/v1/health`) | `{"database":"connected","status":"healthy"}` |

### PROS

- 1 行の SQL 修正のみで 500 エラーを解消
- スキーマ変更（マイグレーション）が不要なため、デプロイリスクが最小限
- `COALESCE` により LEFT JOIN の NULL を安全にハンドリング

### CONS, TRADEOFF

- 未購読フィードの `created_at` が `NOW()` になるため、呼び出しごとに値が変動する。現状はソートキーに使用されていないため実害はないが、将来 `created_at` でソートする場合は再検討が必要
- `Title` フィールドが空文字列のまま返却される問題は未解決（フロントエンド側で URL からドメイン名を表示しているため、現時点では機能的に許容）

### 影響範囲

- **alt-backend**: `subscription_driver.go` のみ。Clean Architecture の最下層（Driver）の変更であり、上位レイヤーへの影響なし
- **alt-frontend-sv**: 変更なし
- **他サービス**: 変更なし

## 関連 ADR

- ADR-000256: フィードソース除外フィルタ (Feeds ページ)
- ADR-000257: FeedSourceExcludeFilter の listSubscriptions リクエスト未送信バグ修正
- ADR-000258: フィードソース除外フィルタの (app)/feeds ページへの移植
