# search-indexer OpenTelemetry メトリクスエクスポーター URL 修正

## ADR's STATUS

Accepted (実装完了・デプロイ済み)

## CONTEXT

### 問題点

search-indexer の OpenTelemetry 初期化時にメトリクスエクスポーターが失敗し、以下のエラーが出力されていた。

```
Failed to initialize OpenTelemetry: failed to init meter provider:
parse "http://http:%2F%2Frask-log-aggregator:4318/v1/metrics": invalid URL escape "%2F"
```

サービス自体は OTel を無効化して正常稼働を継続していたため、可用性への影響はなかったが、メトリクスが収集されない状態が続いていた。

### 根本原因

`initMeterProvider()` でメトリクス HTTP エクスポーターを初期化する際、`otlpmetrichttp.WithEndpoint()` を使用していた。この関数は `host:port` 形式のみを受け付けるが、設定値 `OTEL_EXPORTER_OTLP_ENDPOINT` には `http://rask-log-aggregator:4318` というフルURL が格納されている。

ライブラリ内部で `http://` + `http://rask-log-aggregator:4318` → `http://http://...` が生成され、URL パースに失敗していた。

同ファイル内の trace エクスポーターと log エクスポーターは `WithEndpointURL()` を正しく使用しており、metrics のみ不整合があった。

```go
// trace (正常)
otlptracehttp.WithEndpointURL(cfg.OTLPEndpoint + "/v1/traces")

// log (正常)
otlploghttp.WithEndpointURL(cfg.OTLPEndpoint + "/v1/logs")

// metrics (バグ: WithEndpoint は host:port のみ受付)
otlpmetrichttp.WithEndpoint(cfg.OTLPEndpoint)
```

## DECISION MAKING

### 方針

trace/log エクスポーターと同じ `WithEndpointURL()` に統一する。3 つのエクスポーターすべてが同じパターンを使うことで、一貫性を確保し今後の設定変更時の混乱を防ぐ。

### 修正内容

`search-indexer/app/utils/otel/provider.go` の `initMeterProvider()` を修正。

```go
// Before (バグ)
exporter, err := otlpmetrichttp.New(ctx,
    otlpmetrichttp.WithEndpoint(cfg.OTLPEndpoint),
    otlpmetrichttp.WithInsecure(),
)

// After (修正)
exporter, err := otlpmetrichttp.New(ctx,
    otlpmetrichttp.WithEndpointURL(cfg.OTLPEndpoint+"/v1/metrics"),
    otlpmetrichttp.WithInsecure(),
)
```

`WithEndpointURL()` はフル URL を受け付けるため、`cfg.OTLPEndpoint` をそのまま渡せる。パスに `/v1/metrics` を付与するのは trace (`/v1/traces`) および log (`/v1/logs`) エクスポーターと同じ規約に従っている。

## RESULTS, EFFECTS

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `search-indexer/app/utils/otel/provider.go` | `WithEndpoint` → `WithEndpointURL` に変更、パス `/v1/metrics` を付与 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `go test ./utils/otel/...` | PASS (2 テスト) |
| `go build ./utils/otel/...` | 成功 |
| コンテナビルド | 成功 |
| コンテナ起動 | healthy (起動後数秒以内) |
| ログ確認 | `otel_enabled: true` で起動、`Failed to initialize OpenTelemetry` エラーなし |

### PROS

- **メトリクス収集の復旧**: OTel メトリクスエクスポーターが正常に初期化され、メトリクスが収集可能になった
- **3 エクスポーターの一貫性**: trace / log / metrics すべてが `WithEndpointURL()` を使用する統一パターンになった
- **影響範囲が最小限**: 1 行の変更で修正完了。既存のテスト・動作に影響なし

### CONS, TRADEOFF

- **特になし**: 変更は API の正しい使用法への修正であり、トレードオフは発生しない

## APPENDIX

### OpenTelemetry Go SDK の WithEndpoint vs WithEndpointURL

| 関数 | 期待する入力 | 例 |
|------|-------------|-----|
| `WithEndpoint()` | `host:port` のみ | `rask-log-aggregator:4318` |
| `WithEndpointURL()` | フル URL | `http://rask-log-aggregator:4318/v1/metrics` |

環境変数 `OTEL_EXPORTER_OTLP_ENDPOINT` には標準的にフル URL が設定されるため、`WithEndpointURL()` を使うのが正しいパターン。
