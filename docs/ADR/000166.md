# 3-Day Recap機能の追加

## ADR's STATUS

Accepted

## CONTEXT

既存の7日間Recapパイプラインにおいて、以下の課題が発生していた：

1. **プロンプトサイズ超過**: 7日間分の記事を集約すると、LLMの8Kトークンコンテキスト制限を超過し、プロンプトが切り捨てられる
2. **処理時間の長大化**: 大規模プロンプトの処理に1リクエストあたり3-4分を要し、30ジャンル処理に数時間かかる
3. **ユーザー体験の低下**: 週次レポートとしては問題ないが、日常的なキャッチアップ用途には遅すぎる

ログ分析により、プロンプトサイズと処理時間の相関が確認された：

| プロンプトサイズ | 応答時間 | 切り捨て |
|-----------------|---------|---------|
| ~9300 tokens | 3-4分 | 発生 |
| ~8400 tokens | 2-3分 | 発生 |
| 小規模 | 1-2秒 | なし |

## DECISION MAKING

### 方針

7日間Recapを維持しつつ、**3日間Recap機能を新規追加**する。両機能を別々のユースケースとして提供：

| 機能 | 用途 | 記事数 | 処理時間目標 |
|-----|------|--------|------------|
| 3-Day Recap | 日常キャッチアップ | ~43%削減 | 5-10分 |
| 7-Day Recap | 週次深堀りレビュー | フル | 30-60分 |

### 実装範囲

#### Phase 1: 設定追加 (recap-worker)

```rust
// config.rs - 新規環境変数
recap_3days_window_days: u32,  // デフォルト: 3
```

#### Phase 2: APIエンドポイント追加 (recap-worker)

```rust
// api.rs - 新規ルート
.route("/v1/generate/recaps/3days", post(generate::trigger_3days))
.route("/v1/recaps/3days", get(fetch::get_3days_recap))
```

共通ロジックは `trigger_recap()` と `get_recap_by_window()` として抽出し、コード重複を排除。

#### Phase 3: パイプライン対応

`JobContext` に `window_days` フィールドを追加し、パイプライン全体で window 情報を伝播：

```rust
pub(crate) struct JobContext {
    pub(crate) job_id: Uuid,
    pub(crate) genres: Vec<String>,
    pub(crate) current_stage: Option<String>,
    pub(crate) window_days: u32,  // 新規追加
}
```

#### Phase 4: Proto定義追加

```protobuf
// recap.proto
service RecapService {
  rpc GetSevenDayRecap(GetSevenDayRecapRequest) returns (GetSevenDayRecapResponse);
  rpc GetThreeDayRecap(GetThreeDayRecapRequest) returns (GetThreeDayRecapResponse);  // 新規
  rpc GetEveningPulse(GetEveningPulseRequest) returns (GetEveningPulseResponse);
}
```

#### Phase 5: Backend対応 (alt-backend Go)

- `RecapUsecaseInterface` に `GetThreeDayRecap` メソッド追加
- `RecapGateway` に `getRecapByWindow()` ヘルパー追加
- Connect-RPCハンドラ追加

#### Phase 6: Frontend対応 (alt-frontend-sv SvelteKit)

- Connect クライアント: `getThreeDayRecap()` 関数追加
- モバイル: `/mobile/recap/3days` ページ追加
- デスクトップ: タブ切り替えUI追加（3days/7days）
- ダッシュボード: `trigger3DaysRecapJob()`, `trigger7DaysRecapJob()` 関数追加

#### Phase 7: データベースマイグレーション

```sql
-- recap_jobs, recap_outputs テーブルに window_days カラム追加
ALTER TABLE recap_jobs ADD COLUMN IF NOT EXISTS window_days INTEGER NOT NULL DEFAULT 7;
ALTER TABLE recap_outputs ADD COLUMN IF NOT EXISTS window_days INTEGER NOT NULL DEFAULT 7;
CREATE INDEX IF NOT EXISTS idx_recap_jobs_window_days ON recap_jobs(window_days);
```

## RESULTS, EFFECTS

### 変更ファイル一覧

| コンポーネント | ファイル | 変更内容 |
|--------------|---------|---------|
| recap-worker | `src/config.rs` | `RECAP_3DAYS_WINDOW_DAYS` 設定追加 |
| recap-worker | `src/api.rs` | 3days用ルート追加 |
| recap-worker | `src/api/generate.rs` | `trigger_3days()`, `trigger_recap()` 追加 |
| recap-worker | `src/api/fetch.rs` | `get_3days_recap()`, `get_recap_by_window()` 追加 |
| recap-worker | `src/scheduler/jobs.rs` | `JobContext` に `window_days` 追加 |
| recap-worker | `src/pipeline/fetch.rs` | window_days対応 |
| recap-worker | `src/store/dao/traits/job.rs` | `create_job_with_lock_and_window()` 追加 |
| recap-worker | `src/store/dao/job.rs` | window_days対応実装 |
| proto | `alt/recap/v2/recap.proto` | `GetThreeDayRecap` RPC追加 |
| alt-backend | `connect/v2/recap/handler.go` | `GetThreeDayRecap` ハンドラ追加 |
| alt-backend | `port/recap_port/recap_port.go` | インターフェース拡張 |
| alt-backend | `gateway/recap_gateway/recap_gateway.go` | `getRecapByWindow()` 追加 |
| alt-backend | `usecase/recap_usecase/recap_usecase.go` | `GetThreeDayRecap` 実装 |
| alt-frontend-sv | `src/lib/connect/recap.ts` | `getThreeDayRecap()` 追加 |
| alt-frontend-sv | `src/lib/connect/index.ts` | エクスポート追加 |
| alt-frontend-sv | `src/routes/mobile/recap/3days/+page.svelte` | 新規作成 |
| alt-frontend-sv | `src/routes/desktop/recap/+page.svelte` | タブ切り替えUI追加 |
| alt-frontend-sv | `src/routes/api/v1/generate/recaps/3days/+server.ts` | 新規作成 |
| alt-frontend-sv | `src/lib/api/client/dashboard.ts` | `trigger3DaysRecapJob()` 追加 |
| alt-frontend-sv | `src/lib/components/desktop/layout/PageHeader.svelte` | actions snippet対応 |
| migration | `20260203000000_add_window_days_to_recap_jobs.sql` | 新規作成 |

### 新規環境変数

| 変数名 | デフォルト | 説明 |
|--------|-----------|------|
| `RECAP_3DAYS_WINDOW_DAYS` | 3 | 3日間Recap用のウィンドウ日数 |

### 新規APIエンドポイント

| サービス | パス | 用途 |
|---------|------|------|
| recap-worker | `POST /v1/generate/recaps/3days` | 3日間Recapジョブをトリガー |
| recap-worker | `GET /v1/recaps/3days` | 最新の3日間Recapを取得 |
| alt-backend | `GetThreeDayRecap` (Connect-RPC) | クライアント向け3日間Recap取得 |

### PROS

1. **処理時間短縮**: 記事数削減により、プロンプトサイズが減少し処理が高速化
2. **切り捨て回避**: 8Kトークン制限を超過するケースが大幅減少
3. **ユースケース分離**: 日常利用と週次レビューを適切に分離
4. **後方互換性維持**: 既存の7日間Recapは変更なし
5. **コード再利用**: 共通ロジック抽出により保守性向上

### CONS, TRADEOFF

1. **ストレージ増加**: 3日/7日両方のRecap結果を保存
2. **設定項目増加**: 環境変数が1つ追加
3. **UI複雑化**: タブ切り替えUIの追加（ただし直感的な操作）

## APPENDIX

### 検証コマンド

```bash
# ヘルスチェック
curl http://localhost:9005/health/live

# 3日間Recapトリガー
curl -X POST http://localhost:9005/v1/generate/recaps/3days \
  -H "Content-Type: application/json" \
  -d '{"genres":["tech","ai"]}'

# 3日間Recap取得
curl http://localhost:9005/v1/recaps/3days

# 7日間Recap取得（既存）
curl http://localhost:9005/v1/recaps/7days

# テスト実行
cd recap-worker/recap-worker && cargo test
cd alt-backend/app && go test ./...
cd alt-frontend-sv && bun run check
```

### アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                        Frontend (SvelteKit)                      │
│  ┌──────────────────────┐  ┌──────────────────────┐             │
│  │ /mobile/recap/3days  │  │ /desktop/recap       │             │
│  │                      │  │  [3 Days] [7 Days]   │             │
│  └──────────────────────┘  └──────────────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     alt-backend (Connect-RPC)                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ RecapService.GetThreeDayRecap / GetSevenDayRecap         │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      recap-worker (Rust/Axum)                    │
│  ┌────────────────────────┐  ┌────────────────────────┐         │
│  │ /v1/generate/recaps/3days │ /v1/generate/recaps/7days │      │
│  └────────────────────────┘  └────────────────────────┘         │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Pipeline (window_days aware)                              │   │
│  │ Fetch → Preprocess → Dedup → Genre → Select → Dispatch    │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    recap-db (PostgreSQL)                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ recap_jobs (window_days: 3 | 7)                           │   │
│  │ recap_outputs (window_days: 3 | 7)                        │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 関連ADR

- ADR-XXX: 7日間Recap パイプライン設計（初期実装）
