# Recap Job ステータス履歴のイミュータブル化

## ADR'S STATUS

Accepted

## CONTEXT

### 背景

ADR-113 で対処した「最新のJobが失敗しているのにCompletedになる」バグの根本原因を解消するため、ジョブステータス管理をイミュータブルなイベントソーシングパターンに移行する。

従来の問題点:
1. **UPDATE型のステータス管理**: `recap_jobs.status` が上書き更新され、履歴が残らない
2. **Race condition**: ステータス取得と更新の間でデータが変わる可能性
3. **デバッグ困難**: 状態遷移の過程が追跡できない

### イミュータブルデータモデルの原則

- イベントエンティティは「1つの日時属性のみ」を持つ
- UPDATEを避け、INSERTで状態変更を記録
- 現在の状態は履歴から導出可能

## DECISION MAKING

### 決定

1. **イミュータブル履歴テーブルの追加**: `recap_job_status_history` テーブルを新設
2. **トランザクションによる原子性保証**: 履歴INSERT + ステータスUPDATEを同一トランザクションで実行
3. **フロントエンド統合**: ダッシュボードで履歴を展開表示

### 設計

**テーブル設計**:
```sql
CREATE TABLE recap_job_status_history (
    id BIGSERIAL PRIMARY KEY,
    job_id UUID NOT NULL REFERENCES recap_jobs(job_id) ON DELETE CASCADE,
    status TEXT NOT NULL,
    stage TEXT,
    transitioned_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    reason TEXT,
    actor TEXT DEFAULT 'system',
    CONSTRAINT chk_status_history CHECK (status IN ('pending', 'running', 'completed', 'failed'))
);
```

**アクターの種類**:
- `system`: パイプライン実行による自動遷移
- `scheduler`: スケジューラによる状態変更
- `manual_repair`: 手動修復
- `migration_backfill`: マイグレーションによるバックフィル

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 種別 | 内容 |
|----------|------|------|
| `recap-migration-atlas/migrations/20260118000000_add_job_status_history.sql` | 新規 | 履歴テーブル作成・既存データバックフィル |
| `recap-worker/recap-worker/src/store/dao/types.rs` | 変更 | `StatusTransitionActor`, `JobStatusTransition` 型追加 |
| `recap-worker/recap-worker/src/store/dao/job.rs` | 変更 | `update_job_status_with_history`, `get_status_history` 追加 |
| `recap-worker/recap-worker/src/store/dao/traits/job.rs` | 変更 | トレイト更新 |
| `recap-worker/recap-worker/src/store/models.rs` | 変更 | `StatusTransitionResponse`, `RecentJobSummary.status_history` 追加 |
| `recap-worker/recap-worker/src/api/dashboard.rs` | 変更 | job-progress APIで履歴を返却 |
| `alt-frontend-sv/src/lib/schema/dashboard.ts` | 変更 | `StatusTransition` 型追加 |
| `alt-frontend-sv/src/lib/components/.../StatusTransitionTimeline.svelte` | 新規 | 履歴表示コンポーネント |
| `alt-frontend-sv/src/lib/components/.../JobHistoryTable.svelte` | 変更 | 展開可能な行追加 |

### API変更

**GET /v1/dashboard/job-progress**

`recent_jobs` の各要素に `status_history` フィールドが追加:

```json
{
  "recent_jobs": [
    {
      "job_id": "...",
      "status": "completed",
      "status_history": [
        {
          "id": 1,
          "status": "pending",
          "stage": null,
          "transitioned_at": "2026-01-16T16:54:12Z",
          "reason": null,
          "actor": "system"
        },
        {
          "id": 2,
          "status": "running",
          "stage": "fetch",
          "transitioned_at": "2026-01-16T16:55:00Z",
          "reason": null,
          "actor": "system"
        }
      ]
    }
  ]
}
```

### PROS

1. **完全な監査証跡**: すべてのステータス遷移が記録され、問題発生時の原因特定が容易
2. **原子性の保証**: トランザクションにより履歴とステータスの整合性を保証
3. **後方互換性**: 既存の `recap_jobs.status` はデノーマライズとして維持
4. **可視性向上**: フロントエンドで履歴を確認可能

### CONS, TRADEOFF

1. **ストレージ増加**: 各遷移ごとにレコードが増加（長期的にはパージ戦略が必要）
2. **クエリ複雑化**: 履歴取得のため追加クエリが発生
3. **N+1問題**: 各ジョブの履歴を個別取得（将来的にバッチ取得に最適化可能）

## APPENDIX

### 検証結果

```bash
# テスト結果
cargo test  # 161 tests passed

# DB確認
SELECT COUNT(*) FROM recap_job_status_history;
 total_records
---------------
            92

SELECT status, COUNT(*) FROM recap_job_status_history GROUP BY status;
  status   | count
-----------+-------
 pending   |    46
 completed |    45
 failed    |     1
```

### 関連ADR

- ADR-109: Recap Job Status Dashboard 実装
- ADR-113: Recap Job ステータス不整合の修正

### 今後の検討事項

1. **履歴パージ戦略**: 古い履歴の自動削除またはアーカイブ
2. **バッチ取得最適化**: N+1問題の解消
3. **リアルタイム通知**: WebSocket/SSEによる履歴変更のプッシュ
