# Ollama 0.13.x Docker 環境での CUDA 初期化エラーの解決

## ステータス

採択（Accepted）

## コンテキスト

### 問題の発生

news-creator サービスの要約処理が極端に遅くなった（1リクエストあたり 1〜7分）。

### 症状

コンテナログに以下のエラーが記録されていた：

```
ggml_cuda_init: failed to initialize CUDA: initialization error
```

その結果、モデルの全レイヤーが GPU ではなく CPU にロードされていた：

```
msg="offloaded 0/35 layers to GPU"
msg="model weights" device=CPU size="3.6 GiB"
```

### 矛盾した状況

- ホスト側の `nvidia-smi` は正常（GPU 検出済み）
- コンテナ内の `nvidia-smi` も正常（GPU アクセス可能）
- Ollama は GPU を検出していた（`library=CUDA`, `available="7.5 GiB"`）
- しかし CUDA ランタイム初期化が失敗

### 調査結果

[GitHub Issue #13169](https://github.com/ollama/ollama/issues/13169) によると、Ollama 0.13.x で CUDA ライブラリの選択に問題があることが判明。Ollama が誤ったライブラリ（例: `cuda_jetpack5`）を選択し、互換性のないシステムで CUDA 初期化が失敗するケースが報告されていた。

## 決定

`OLLAMA_LLM_LIBRARY=cuda_v12` 環境変数を設定し、正しい CUDA ライブラリを強制的に選択する。

### 変更内容

`compose/ai.yaml` の news-creator サービスに環境変数を追加：

```yaml
environment:
  # Ollama 0.13.x CUDA ライブラリ選択バグの回避策 (GitHub Issue #13169)
  - OLLAMA_LLM_LIBRARY=cuda_v12
```

## 結果

### 修正前後の比較

| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| CUDA 初期化 | 失敗 | 成功 |
| GPU レイヤーオフロード | 0/35 | 35/35 |
| GPU メモリ使用 | 123MiB | 4619MiB |
| モデル実行デバイス | CPU | GPU (CUDA0) |
| 推論時間 | 1〜7分 | 数秒 |

### 修正後のログ

```
ggml_cuda_init: found 1 CUDA devices:
  Device 0: NVIDIA GeForce RTX 4060, compute capability 8.9, VMM: yes
msg="offloaded 35/35 layers to GPU"
msg="model weights" device=CUDA0 size="3.1 GiB"
```

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `compose/ai.yaml` | `OLLAMA_LLM_LIBRARY=cuda_v12` 環境変数を追加 |

### メリット

1. **性能回復**: GPU による高速推論が復活
2. **最小限の変更**: 環境変数 1 行の追加のみ
3. **後方互換**: Ollama のバージョンダウングレード不要

### 代替案（検討済み）

| 代替案 | 採用しなかった理由 |
|--------|-------------------|
| Ollama 0.12.9 へのダウングレード | 環境変数設定で解決したため不要 |
| Docker デーモン再起動 | 根本原因の解決にならない |

## 実装日

2026-01-13

## 関連

- [Ollama Issue #13169](https://github.com/ollama/ollama/issues/13169): 0.13.0 docker fails with cuda
- [Ollama Issue #11963](https://github.com/ollama/ollama/issues/11963): system not yet initialized
- ADR 000086: Trend Stats API のマルチテナント分離漏れの修正
