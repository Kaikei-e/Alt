# ADR-000281: FeedDetailModal に TTS (読み上げ) ボタンを追加

## ステータス

承認済み

## コンテキスト

### 既存の TTS 基盤

デスクトップ Recap 画面 (`RecapDetail.svelte`) では、ジャンルサマリーの TTS 読み上げ機能が既に稼働している。通信経路は以下の通り:

```
Frontend (useTtsPlayback) → /sv/api/v2 (SvelteKit proxy) → BFF (alt-butterfly-facade) → tts-speaker
```

BFF が JWT 検証と X-Service-Token 注入を担当し、フロントエンドは `useTtsPlayback()` hook を呼ぶだけで TTS が利用可能である。

### FeedDetailModal への TTS 統合の動機

デスクトップ `/sv/feeds` パスの `FeedDetailModal` には AI Summary 生成機能が実装済みだが、生成されたサマリーを読み上げる手段がなかった。TTS 基盤は汎用的に設計されており、テキストを渡すだけで利用できるため、FeedDetailModal への統合は低コストで実現可能であった。

## 意思決定

### 1. 既存の `useTtsPlayback` hook をそのまま再利用

新規の hook や API クライアントは作成せず、`RecapDetail` と同一の `useTtsPlayback()` を使用する。

```typescript
const tts = useTtsPlayback();
```

hook は内部で `createClientTransport()` → `synthesizeSpeechStream()` を呼び出し、BFF 経由で tts-speaker にアクセスする。フロントエンド側の追加設定は不要。

### 2. TTS ボタンの表示条件

AI Summary のライフサイクルに合わせて TTS ボタンの表示を制御する:

| 状態 | TTS ボタン |
|------|-----------|
| Summary 未生成 (`summary === null`) | 非表示 |
| Summary ストリーミング中 (`isSummarizing === true`) | 非表示 |
| Summary 完了後 | 表示 (`Volume2` アイコン) |

ストリーミング中に TTS ボタンを非表示にする理由は、不完全なテキストの読み上げを防止するためである。

### 3. アイコンと状態遷移

`RecapDetail` と一貫したアイコン選択:

| TTS 状態 | アイコン | aria-label |
|----------|---------|------------|
| idle | `Volume2` | "Read aloud" |
| loading | `Loader2` (animate-spin) | "Cancel loading" |
| playing | `Square` | "Stop reading" |

### 4. クリーンアップの 2 箇所追加

TTS 再生中にユーザーがモーダルを閉じたり、矢印キーでフィードを切り替えた場合に、再生を自動停止する必要がある:

- **モーダル閉じ** (`$effect` の `!open` ブロック): `tts.stop()` を既存の abort 処理の前に追加
- **フィード切替** (`$effect` の feed change ブロック): 同様に `tts.stop()` を追加

`RecapDetail` のクリーンアップパターン（`$effect` の return で `tts.stop()` を呼ぶ）と同等の安全性を確保。

### 5. UI レイアウト

AI SUMMARY セクションのヘッダーを `flex justify-between` レイアウトに変更し、右端に TTS ボタンを配置:

```
┌─────────────────────────────────────┐
│ ✨ AI SUMMARY                   🔊  │
│                                     │
│ Summary text here...                │
│                                     │
│ [TTS error message if any]          │
└─────────────────────────────────────┘
```

### 不採用案

| 不採用案 | 理由 |
|---------|------|
| Footer に TTS ボタンを配置 | Summary セクションから離れるため、対象テキストとの関連が不明瞭になる |
| Summary ストリーミング中も TTS ボタンを表示 | 不完全なテキストの読み上げはユーザー体験を損なう。ストリーミング完了後に有効化するのが安全 |
| TTS 専用の新規 hook を作成 | `useTtsPlayback` は汎用設計であり、テキストを渡すだけで動作する。FeedDetailModal 固有のロジックは不要 |

## 結果・影響

### 動作確認

| 確認項目 | 結果 |
|---------|------|
| `vitest run` (server tests, 33 files / 425 tests) | 全パス |
| コンテナ再ビルド+起動 (`alt-frontend-sv`, `alt-butterfly-facade`) | healthy |
| Backend health check | `{"status":"healthy"}` |
| Frontend health check (直接ポート) | `OK` |

### PROS

- 既存の TTS 基盤を再利用しており、新規の API エンドポイントやサービス間通信の追加がゼロ
- `RecapDetail` と同一の hook・アイコン・操作パターンで、UI の一貫性を維持
- モーダル閉じ・フィード切替時の自動停止により、音声リーク (バックグラウンド再生の継続) を防止
- Summary ストリーミング完了後にのみ TTS を有効化するため、不完全読み上げのリスクなし

### CONS, TRADEOFF

- ブラウザコンポーネントテスト (`.svelte.test.ts`) は `VITEST_BROWSER=true` 環境でのみ実行可能。CI で browser test project が有効な場合に限り自動検証される
- TTS のエラーメッセージは Summary セクション内に小さく表示される設計のため、ユーザーが見逃す可能性がある。現状は `RecapDetail` と同じ仕様で統一

## 付録

### 変更ファイル一覧

| ファイル | 変更 |
|---------|------|
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedDetailModal.svelte` | `useTtsPlayback` hook 統合、TTS ボタン UI 追加、モーダル閉じ/フィード切替時のクリーンアップ |
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedDetailModal.svelte.test.ts` | TTS 統合のブラウザコンポーネントテスト (新規) |

### 再利用した既存コード

| モジュール | 役割 |
|-----------|------|
| `useTtsPlayback.svelte.ts` | TTS 再生ライフサイクル管理 (state machine: idle → loading → playing) |
| `synthesizeSpeechStream()` | BFF 経由の server-streaming RPC クライアント |
| `createClientTransport()` | Connect-RPC トランスポート (BFF プロキシ `/sv/api/v2` 向け) |

### TTS 通信経路

```
FeedDetailModal
  └─ useTtsPlayback()
       └─ createClientTransport() → /sv/api/v2 (SvelteKit server proxy)
            └─ alt-butterfly-facade (JWT 検証 + X-Service-Token 注入)
                 └─ tts-speaker (音声合成 + WAV ストリーミング)
```
