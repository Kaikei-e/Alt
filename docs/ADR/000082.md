# BFF（Backend for Frontend）パターンの導入

## ステータス

採択（Accepted）

## コンテキスト

### 現状のアーキテクチャ

```
alt-frontend-sv:4173 → alt-backend:9101 (Connect-RPC)
```

alt-backend は REST API（port 9000）と Connect-RPC（port 9101）の両方を提供しているが、フロントエンド向けの責務（認証トークン処理、リクエスト前処理等）とバックエンド本来の責務（ビジネスロジック、データ永続化）が混在していた。

### 問題点

| 問題 | 影響 |
|------|------|
| 責務の混在 | alt-backend の複雑化、変更影響範囲の拡大 |
| フロントエンド固有の処理 | バックエンドに不要な依存関係 |
| 将来的な拡張性 | キャッシュ、レート制限等の追加が困難 |

## 決定

BFF サービス `alt-butterfly-facade` を導入し、フロントエンド向け通信を一元化する。

### アーキテクチャ

```
alt-frontend-sv:4173 → alt-butterfly-facade:9200 → alt-backend:9101
```

### 設計方針

| 決定事項 | 選択 | 理由 |
|---------|------|------|
| 実装方式 | 透過型 HTTP プロキシ | proto 依存問題の回避、シンプルな実装 |
| プロトコル | HTTP/2 h2c | Connect-RPC ストリーミング対応 |
| 認証 | JWT パススルー | 一度検証後、同一トークンを転送 |
| proto 生成 | 型定義のみ（connect 不使用） | replace ディレクティブ回避 |

### ストリーミング対応

以下のプロシージャはストリーミングとして処理（タイムアウト延長）:

- `/alt.feeds.v2.FeedService/StreamFeedStats`
- `/alt.feeds.v2.FeedService/StreamSummarize`
- `/alt.augur.v2.AugurService/StreamChat`
- `/alt.morning_letter.v2.MorningLetterService/StreamChat`

## 結果

### 新規ファイル構成

```
alt-butterfly-facade/
├── main.go                          # エントリーポイント + healthcheck
├── Dockerfile                       # distroless イメージ
├── CLAUDE.md                        # 開発ガイドライン
├── config/
│   └── config.go                    # 環境変数設定
└── internal/
    ├── client/
    │   └── backend_client.go        # HTTP/2 h2c クライアント
    ├── domain/
    │   └── user_context.go          # BFF 固有の型定義
    ├── handler/
    │   └── proxy_handler.go         # 透過プロキシ
    ├── middleware/
    │   └── auth_interceptor.go      # JWT 検証
    └── server/
        └── server.go                # HTTP サーバー + h2c
```

### Docker Compose 変更

| ファイル | 変更内容 |
|---------|---------|
| `compose/bff.yaml` | 新規：BFF サービス定義 |
| `compose/compose.yaml` | bff.yaml の include 追加 |
| `compose/core.yaml` | BACKEND_CONNECT_URL のデフォルト値変更 |

### buf.gen.yaml 変更

```yaml
# alt-butterfly-facade（型定義のみ、connect 不使用）
- local: protoc-gen-go
  out: ../alt-butterfly-facade/internal/gen/proto
  opt: paths=source_relative
# NOTE: connect-go は透過プロキシのため不使用
```

### メリット

1. **責務分離**: フロントエンド固有の処理を BFF に集約
2. **拡張性**: キャッシュ、レート制限、A/B テストの追加が容易
3. **独立デプロイ**: フロントエンド向け変更が alt-backend に影響しない
4. **セキュリティ**: 認証の二重チェック（BFF + alt-backend）

### トレードオフ

1. **レイテンシ**: 1 ホップ追加（<5ms オーバーヘッド）
2. **運用負荷**: 新規サービスの監視・運用
3. **複雑性**: サービス間通信フローの増加

### 設定項目

| 環境変数 | デフォルト | 説明 |
|---------|-----------|------|
| `BFF_PORT` | 9200 | サービスポート |
| `BACKEND_CONNECT_URL` | http://alt-backend:9101 | バックエンド URL |
| `BFF_REQUEST_TIMEOUT` | 30s | 単発リクエストタイムアウト |
| `BFF_STREAMING_TIMEOUT` | 5m | ストリーミングタイムアウト |

## テスト

```bash
# 全テスト実行
cd alt-butterfly-facade && go test ./...

# 結果
ok  alt-butterfly-facade/config
ok  alt-butterfly-facade/internal/client
ok  alt-butterfly-facade/internal/handler
ok  alt-butterfly-facade/internal/middleware
ok  alt-butterfly-facade/internal/server
```

## 実装日

2026-01-13

## 関連

- [BFF Pattern - Sam Newman](https://samnewman.io/patterns/architectural/bff/)
- [Connect-RPC Documentation](https://connectrpc.com/docs/go/getting-started/)
- [HTTP/2 h2c - Go x/net](https://pkg.go.dev/golang.org/x/net/http2/h2c)
