# URL正規化におけるルートパス末尾スラッシュ処理の統一

## ADR's STATUS

Accepted

## CONTEXT

### 背景

フロントエンドで特定のドメインの記事を既読にマークできない問題が報告された。

### 問題の分析

調査の結果、URL正規化処理における末尾スラッシュの扱いに不整合があることが判明した。

**Issue 1: ルートパスの末尾スラッシュが保持されていた**

既存の`NormalizeURL`関数はルートパス(`/`)を特別扱いし、末尾スラッシュを削除しなかった：

```go
// 変更前の動作
NormalizeURL("https://example.com/")  // → "https://example.com/"
NormalizeURL("https://example.com")   // → "https://example.com"
```

**Issue 2: フロントエンドとバックエンドでの正規化結果の不一致**

```
DB保存時:    https://example.com/  (末尾スラッシュあり)
API検索時:   https://example.com   (末尾スラッシュなし)
結果: レコード不一致 → "Feed not found"
```

**Issue 3: 不正データの混入**

RSSフィード処理において、ホームページURLが記事として取り込まれるケースが存在していた。

## DECISION MAKING

### Part A: URL正規化ロジックの修正

ルートパスを含むすべてのパスで末尾スラッシュを削除するように変更：

```go
// 変更前
if parsedURL.Path != "/" && strings.HasSuffix(parsedURL.Path, "/") {
    parsedURL.Path = strings.TrimRight(parsedURL.Path, "/")
}

// 変更後
if parsedURL.Path == "/" {
    parsedURL.Path = ""
} else if strings.HasSuffix(parsedURL.Path, "/") {
    parsedURL.Path = strings.TrimRight(parsedURL.Path, "/")
}
```

これにより正規化結果が一貫性を持つ：

```go
// 変更後の動作
NormalizeURL("https://example.com/")       // → "https://example.com"
NormalizeURL("https://example.com")        // → "https://example.com"
NormalizeURL("https://example.com/path/")  // → "https://example.com/path"
```

### Part B: 不正データのクリーンアップ

ルートドメインURLのみを持つfeedレコードを削除：

```sql
DELETE FROM feeds WHERE link ~ '^https?://[^/]+/?$';
```

## RESULTS, EFFECTS

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/utils/url_normalizer.go` | ルートパス末尾スラッシュ削除ロジック追加 |
| `alt-backend/app/utils/url_normalizer_test.go` | テストケースの期待値更新 |

### 処理フロー（修正後）

```
フロントエンド
    ↓ canonicalize(): 末尾スラッシュ削除
    ↓ POST /v1/feeds/read { article_url: "https://example.com" }
バックエンド
    ↓ NormalizeURL(): 末尾スラッシュ削除（ルートパス含む）
    ↓ SELECT id FROM feeds WHERE link = "https://example.com"
データベース
    → マッチ成功
```

### PROS

1. **一貫性**: フロントエンド・バックエンド間でURL正規化結果が一致
2. **シンプル**: ルートパスの特別扱いを廃止し、ロジックが単純化
3. **冪等性維持**: 正規化済みURLを再度正規化しても結果が変わらない

### CONS, TRADEOFF

1. **既存データとの整合性**: 末尾スラッシュ付きで保存された既存レコードとのマッチングに影響する可能性
2. **破壊的変更**: `NormalizeURL`の出力が変わるため、依存コードへの影響確認が必要

## APPENDIX

### 検証手順

```bash
# 1. ユニットテスト実行
cd alt-backend/app && go test ./utils/... -v -run "TestNormalizeURL"

# 2. サービスビルド・起動
docker compose -f compose/compose.yaml -p alt build alt-backend
docker compose -f compose/compose.yaml -p alt up -d alt-backend

# 3. ヘルスチェック
curl http://localhost:9000/v1/health
```

### 関連コンポーネント

- `alt-frontend`: `canonicalize()`関数でクライアント側URL正規化
- `alt-backend`: `NormalizeURL()`関数でサーバー側URL正規化
- `feeds`テーブル: `link`カラムに記事URLを保存
- `read_status`テーブル: 既読状態を`feed_id`で管理
