# 記事本文リッチレンダリング改善: サニタイズ済み HTML の保持

## ADR's STATUS

Accepted

## CONTEXT

### 背景

alt-frontend-sv で記事本文をフェッチした際、フロントエンドではプレーンテキストしか表示されていなかった。

```
Backend (fetch_article_usecase.go)
  ↓ ExtractArticleText() → プレーンテキストに変換
Handler (handler.go)
  ↓ html_parser.StripTags() → 全 HTML タグ除去
Frontend
  ↓ {@html article.content} → プレーンテキストがそのまま表示
```

**問題**: 見出し、リスト、コードブロック、リンクなどの構造が全て失われ、可読性が低下していた。

### 検討した選択肢

| 選択肢 | 説明 | 採用 |
|--------|------|------|
| A. HTML→Markdown→HTML | サーバーで Markdown 変換、フロントで再パース | 不採用: 変換ロスが発生 |
| B. サニタイズ済み HTML 保持 | go-readability で抽出、bluemonday でサニタイズ | **採用** |
| C. フロントエンドのみで処理 | 生 HTML をそのままフロントへ | 不採用: XSS リスク大 |

### セキュリティ考慮事項

`{@html}` ディレクティブは XSS の主要な攻撃ベクターであるため、多層防御が必須。

| 攻撃ベクター | 対策 |
|--------------|------|
| `<script>` タグ | bluemonday/DOMPurify で除去 |
| `onclick`, `onerror` 等イベントハンドラ | bluemonday/DOMPurify で除去 |
| `javascript:` URL | AllowURLSchemes で http/https のみ許可 |
| `<img onerror="...">` | **img タグ自体を除去** (後述) |
| `<svg onload="...">` | svg タグを除去 |
| `<iframe>`, `<object>`, `<embed>` | 除去 |

### img タグの除去理由

`<img>` タグは XSS の主要な攻撃ベクターである:

```html
<img src="x" onerror="alert('XSS')">
<img src="data:image/svg+xml,<svg onload='alert(1)'>">
```

参考: [OWASP XSS Filter Evasion Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/XSS_Filter_Evasion_Cheat_Sheet.html)

加えて、Alt では画像をフェッチ・表示しないアーキテクチャのため、img タグを保持する意味がない。セキュリティリスクと実用性の両面から **img タグは完全除去** とした。

## DECISION MAKING

### 方針

1. **Backend**: `ExtractArticleHTML()` 関数を新設し、サニタイズ済み HTML を返却
2. **Handler**: `StripTags()` 呼び出しを削除
3. **Frontend**: `isomorphic-dompurify` による二重サニタイズ (多層防御)

### TDD テスト

各修正に対してテストを先に書いた (RED -> GREEN)。

| テストファイル | 検証内容 |
|----------------|----------|
| `extract_article_html_test.go` | 構造保持、XSS ベクター除去、img 除去 |
| `sanitizeHtml.test.ts` | DOMPurify によるサニタイズ動作確認 |

## RESULTS, EFFECTS

### 変更ファイル一覧

#### Backend (alt-backend)

| ファイル | 変更内容 |
|----------|----------|
| `app/utils/html_parser/cleaner.go` | `ExtractArticleHTML()`, `sanitizeArticleHTML()` 関数追加 |
| `app/utils/html_parser/extract_article_html_test.go` | 新規: 構造保持・XSS 除去のテスト (20 ケース) |
| `app/connect/v2/articles/handler.go` | `StripTags()` 呼び出し削除 |
| `app/usecase/fetch_article_usecase/fetch_article_usecase.go` | `ExtractArticleText` → `ExtractArticleHTML` に変更 |
| `app/usecase/fetch_article_usecase/fetch_article_usecase_test.go` | HTML 出力を期待するよう修正 |

#### Frontend (alt-frontend-sv)

| ファイル | 変更内容 |
|----------|----------|
| `package.json` | `isomorphic-dompurify` 依存追加 |
| `src/lib/utils/sanitizeHtml.ts` | 新規: DOMPurify ラッパー |
| `src/lib/utils/sanitizeHtml.test.ts` | 新規: サニタイズテスト (20 ケース) |
| `src/lib/components/mobile/RenderFeedDetails.svelte` | sanitizeHtml 適用、レスポンシブ CSS 追加 |

### 許可タグ一覧

```
構造: article, section, div, p, span, br
見出し: h1, h2, h3, h4, h5, h6
リスト: ul, ol, li
引用・コード: blockquote, pre, code
装飾: b, strong, i, em, u, s, del, ins, mark, sub, sup
リンク: a (href のみ、javascript: 禁止)
テーブル: table, thead, tbody, tfoot, tr, th, td, caption
その他: hr, figure, figcaption, dl, dt, dd

除外: script, style, img, svg, iframe, object, embed, form, input, textarea, button
```

### PROS

1. **可読性向上**: 見出し、リスト、コードブロック、リンクが正しく表示される
2. **多層防御**: Backend (bluemonday) + Frontend (DOMPurify) の二重サニタイズ
3. **最小変更**: 既存アーキテクチャを維持しつつ、handler の 1 行削除と usecase の関数名変更のみ
4. **レスポンシブ対応**: `clamp()` による可変フォントサイズ

### CONS, TRADEOFF

1. **HTML サイズ増加**: プレーンテキストより若干大きくなる (構造タグ分)
2. **img 非表示**: 画像は表示されない (セキュリティ優先の意図的な設計)

## APPENDIX

### 検証方法

```bash
# Backend テスト
cd alt-backend/app && go test ./utils/html_parser/... -v

# Frontend テスト
cd alt-frontend-sv && bun test src/lib/utils/sanitizeHtml.test.ts

# コンテナ再ビルド・再起動
docker compose -f compose/compose.yaml -p alt build alt-backend alt-frontend-sv
docker compose -f compose/compose.yaml -p alt up -d alt-backend alt-frontend-sv

# ヘルスチェック
curl http://localhost:9000/v1/health
curl http://localhost:3000/api/health
```

### データフロー (修正後)

```
Backend (fetch_article_usecase.go)
  ↓ ExtractArticleHTML() → サニタイズ済み HTML (構造保持)
Handler (handler.go)
  ↓ そのまま返却 (追加処理なし)
Frontend (RenderFeedDetails.svelte)
  ↓ sanitizeHtml() → 二重サニタイズ
  ↓ {@html safeContent} → リッチ表示
```

### セキュリティ参考資料

- [OWASP XSS Filter Evasion Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/XSS_Filter_Evasion_Cheat_Sheet.html)
- [MDN Cross-site scripting (XSS)](https://developer.mozilla.org/en-US/docs/Web/Security/Attacks/XSS)
- [bluemonday](https://github.com/microcosm-cc/bluemonday)
- [DOMPurify](https://github.com/cure53/DOMPurify)
