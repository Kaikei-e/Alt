# ADR-000276: tag-generator の CPU 浪費を 3 層で修正 (1683% → < 1%)

## ステータス

承認済み

## コンテキスト

### 背景

`tag-generator` が **1683% CPU** を消費していた。調査により 3 つの根本原因を特定。

### 根本原因

#### 1. Critical Bug: feed_id 欠落でバッチ upsert が全件失敗

`BatchUpsertArticleTags` RPC が 101 回連続で失敗していた。原因は `ListUntaggedArticles` → Proto → tag-generator の経路で `articles.feed_id` が伝播されず、空文字が UUID カラムに渡されて SQL エラーが発生していたこと。

75 記事分のタグ抽出（CPU ヘビーな embedding 処理）が毎サイクル実行されるが、upsert が 100% 失敗するため結果は全て破棄。60 秒後に同じ 75 記事を再処理するループが形成されていた。

#### 2. PyTorch スレッド爆発

`OMP_NUM_THREADS` 等の環境変数が未設定で、PyTorch / ONNX Runtime が全 CPU コアを使用していた。

#### 3. 英語テキストで KeyBERT 二重呼び出し

`extract_keywords_english()` が `keyphrase_ngram_range=(1,1)` と `(2,3)` で `keybert.extract_keywords()` を 2 回呼び出しており、embedding 計算が 2 倍になっていた。

## 意思決定

### 方針: 3 層の修正を組み合わせて根本解決

単一の修正では不十分。feed_id 修正がなければ無駄な再処理は止まらず、スレッド制限がなければ正常動作時も CPU を過剰消費する。3 つを同時に適用することで相乗効果を得る。

### 変更内容

#### 1. Proto スキーマ拡張 — feed_id フィールド追加

`ArticleWithTags` メッセージに `string feed_id = 7` を追加し、`buf generate` で Go / Python の両コードを再生成。

#### 2. Backend — クエリ・レスポンスに feed_id を追加

| レイヤー | ファイル | 変更 |
|---------|---------|------|
| Driver | `list_untagged_articles_driver.go` | `InternalUntaggedArticle` に `FeedID` フィールド追加。SELECT に `COALESCE(a.feed_id::text, '')` 追加 |
| Port | `internal_tag_port/port.go` | `UntaggedArticle` に `FeedID` フィールド追加 |
| Gateway | `internal_article_gateway/gateway.go` | Driver → Port マッピングに `FeedID` 追加 |
| Handler | `connect/v2/internal/handler.go` | `ListUntaggedArticles` レスポンスの `ArticleWithTags` に `FeedId` 設定 |

#### 3. tag-generator — feed_id 伝播

| ファイル | 変更 |
|---------|------|
| `driver/connect_article_fetcher.py` | `"feed_id": None` → `a.feed_id if a.feed_id else None` に変更 |
| `batch_processor.py` | `process_articles_as_batch` と `process_regeneration_batch` の `article_tags_batch` に `"feed_id": article.get("feed_id", "")` を追加 |

#### 4. PyTorch スレッド制限

`compose/workers.yaml` の tag-generator environment に以下を追加:

```yaml
- OMP_NUM_THREADS=4
- MKL_NUM_THREADS=4
- TORCH_NUM_THREADS=4
- TOKENIZERS_PARALLELISM=false
```

#### 5. KeyBERT 二重呼び出し統合

`english_extractor.py` で 2 回の `keybert.extract_keywords()` を 1 回に統合:

- 修正前: `(1,1)` + `(2,3)` の 2 回呼び出し（embedding 2 回）
- 修正後: `(1,3)` の 1 回呼び出し（embedding 1 回）

統合後のフィルタリングで単語（1-gram）とフレーズ（2-3 gram）を分離して後処理。既存の品質フィルタリングロジックは維持。

### 不採用案

| 不採用案 | 理由 |
|---------|------|
| feed_id をオプショナルにして空文字を許容 | SQL スキーマ上 `feed_id` は UUID 型で NOT NULL。空文字を許容すると他のクエリに影響する |
| tag-generator 側で feed_id を別途取得 | 余計な RPC 呼び出しが増える。Proto 経由で伝播するのが自然 |
| PyTorch スレッドを 1 に制限 | タグ抽出速度が低下しすぎる。4 はバッチ処理速度と CPU 使用率のバランス点 |
| KeyBERT を 1 回呼び出しにせず diversity パラメータで調整 | diversity を上げても embedding 計算は 2 回のまま。根本的にコスト削減にならない |

## 結果・影響

### 動作確認

| 確認項目 | 結果 |
|---------|------|
| alt-backend `go test ./...` | 全 PASS |
| tag-generator `pytest tests/` | 396 件全 PASS |
| コンテナ再ビルド + 再起動 | 正常起動、healthy |
| CPU 使用率 | 1683% → 0.20% |
| BatchUpsertArticleTags エラー | 消失 |

### 期待効果

| 指標 | 修正前 | 修正後 |
|-----|-------|-------|
| CPU 使用率 | 1683% | < 1% |
| BatchUpsert 成功率 | 0% (101 回連続失敗) | ~100% |
| 英語記事の embedding 回数 | 2 回/記事 | 1 回/記事 |
| 無駄な再処理 | 75 記事 × 毎サイクル | 0 |

### PROS

- 3 つの独立した原因を全て修正し、相乗効果で CPU 使用率を 1/8000 以下に削減
- Proto スキーマ変更は後方互換（フィールド追加のみ、既存クライアントに影響なし）
- `COALESCE` で NULL 安全にし、既存データとの互換性を維持
- KeyBERT 統合は既存テストで品質を検証済み

### CONS, TRADEOFF

- `OMP_NUM_THREADS=4` はハードコード。記事量が大幅に増加した場合、スレッド数の調整が必要になる可能性がある
- KeyBERT の `(1,3)` 統合により、単語と 2-3 gram フレーズの diversity 制御が個別にできなくなった（`diversity=0.4` で統一）。品質に問題が出た場合は別途調整が必要
- `COALESCE(a.feed_id::text, '')` は feed_id が NULL の古い記事に対して空文字を返すため、tag-generator 側で `None` に変換して処理をスキップする（既存動作と同じ）

## 付録

### 変更ファイル一覧

| ファイル | 変更 |
|---------|------|
| `proto/services/backend/v1/internal.proto` | `ArticleWithTags` に `feed_id` フィールド追加 |
| `alt-backend/app/gen/proto/...` | `buf generate` で再生成 |
| `tag-generator/app/tag_generator/gen/proto/...` | `buf generate` で再生成 |
| `alt-backend/app/driver/alt_db/list_untagged_articles_driver.go` | `FeedID` フィールド追加、SELECT・Scan 拡張 |
| `alt-backend/app/port/internal_tag_port/port.go` | `UntaggedArticle` に `FeedID` 追加 |
| `alt-backend/app/gateway/internal_article_gateway/gateway.go` | Gateway マッピングに `FeedID` 追加 |
| `alt-backend/app/connect/v2/internal/handler.go` | `ListUntaggedArticles` レスポンスに `FeedId` 設定 |
| `tag-generator/app/tag_generator/driver/connect_article_fetcher.py` | `feed_id` を Proto から伝播 |
| `tag-generator/app/tag_generator/batch_processor.py` | バッチに `feed_id` 追加（2 箇所） |
| `tag-generator/app/tag_extractor/english_extractor.py` | KeyBERT 呼び出しを 2 回→1 回に統合 |
| `compose/workers.yaml` | PyTorch スレッド制限の環境変数追加 |

### 関連 ADR

| ADR | 内容 |
|-----|------|
| ADR-000275 | rag-orchestrator の CPU 浪費修正（同種の問題） |
| ADR-000276 (本 ADR) | tag-generator の CPU 浪費修正 |
