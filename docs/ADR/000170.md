# Tag Trail connect-rpc 完全移行

## ADR's STATUS

Accepted

## CONTEXT

ADR-167〜169で実装したTag Trail機能は、REST API経由で動作していた。しかし、本プロジェクトのアーキテクチャ標準では、フロントエンド-バックエンド間通信にconnect-rpcを使用することが推奨されている。

### 移行前のアーキテクチャ

```
Frontend (TagTrailScreen.svelte)
    ↓ REST API client ($lib/api/client/tagTrail.ts)
    ↓
SvelteKit BFF (+server.ts)
    ↓
alt-backend (REST handlers)
```

### 移行後のアーキテクチャ

```
Frontend (TagTrailScreen.svelte)
    ↓ connect-rpc client ($lib/connect/articles.ts)
    ↓
alt-butterfly-facade (transparent HTTP/2 proxy)
    ↓
alt-backend (connect/v2/articles/handler.go)
```

## DECISION MAKING

### 方針

1. **Proto定義の追加**: 既存の`ArticleService`にTag Trail用RPCを追加
2. **バックエンドハンドラ実装**: 既存usecaseを呼び出すconnect-rpcハンドラを追加
3. **フロントエンドクライアント更新**: connect-rpc関数を追加し、Svelteコンポーネントで使用

### Proto設計

```protobuf
service ArticleService {
  // 既存RPCs...

  // Tag Trail RPCs
  rpc FetchArticlesByTag(FetchArticlesByTagRequest) returns (FetchArticlesByTagResponse);
  rpc FetchArticleTags(FetchArticleTagsRequest) returns (FetchArticleTagsResponse);
  rpc FetchRandomFeed(FetchRandomFeedRequest) returns (FetchRandomFeedResponse);
}
```

### API設計

| RPC | 説明 | 置換対象REST API |
|-----|------|------------------|
| `FetchArticlesByTag` | タグによる記事検索（ID/名前対応） | `GET /v1/articles/by-tag` |
| `FetchArticleTags` | 記事のタグ取得 | `GET /v1/articles/:id/tags` |
| `FetchRandomFeed` | ランダムフィード取得 | `GET /v1/rss-feed-link/random` |

## RESULTS, EFFECTS

### 変更ファイル一覧

| コンポーネント | ファイル | 変更内容 |
|--------------|---------|---------|
| proto | `proto/alt/articles/v2/articles.proto` | Tag Trail RPC定義追加 |
| alt-backend | `connect/v2/articles/handler.go` | 3つのハンドラ実装追加 |
| alt-frontend-sv | `src/lib/connect/articles.ts` | Tag Trail関数追加 |
| alt-frontend-sv | `src/lib/connect/index.ts` | 新規関数・型のエクスポート |
| alt-frontend-sv | `src/lib/components/mobile/tag-trail/TagTrailScreen.svelte` | connect-rpc使用に変更 |

### Proto定義

```protobuf
// FetchArticlesByTagRequest
message FetchArticlesByTagRequest {
  optional string tag_id = 1;    // 後方互換性用
  optional string tag_name = 2;  // 横断検索用（推奨）
  optional string cursor = 3;    // ページネーション
  int32 limit = 4;               // 取得件数
}

// TagTrailArticleItem
message TagTrailArticleItem {
  string id = 1;
  string title = 2;
  string link = 3;
  string published_at = 4;
  string feed_title = 5;
}

// FetchRandomFeedResponse
message FetchRandomFeedResponse {
  string id = 1;
  string url = 2;           // サイトURL
  string title = 3;
  string description = 4;
}
```

### バックエンドハンドラ

```go
// FetchArticlesByTag - タグによる記事検索
func (h *Handler) FetchArticlesByTag(ctx context.Context, req *connect.Request[articlesv2.FetchArticlesByTagRequest]) (*connect.Response[articlesv2.FetchArticlesByTagResponse], error)

// FetchArticleTags - 記事のタグ取得
func (h *Handler) FetchArticleTags(ctx context.Context, req *connect.Request[articlesv2.FetchArticleTagsRequest]) (*connect.Response[articlesv2.FetchArticleTagsResponse], error)

// FetchRandomFeed - ランダムフィード取得
func (h *Handler) FetchRandomFeed(ctx context.Context, req *connect.Request[articlesv2.FetchRandomFeedRequest]) (*connect.Response[articlesv2.FetchRandomFeedResponse], error)
```

### フロントエンドクライアント

```typescript
// Tag Trail関数
export async function fetchArticlesByTag(
  transport: Transport,
  tagName?: string,
  tagId?: string,
  cursor?: string,
  limit?: number,
): Promise<TagTrailArticlesResponse>

export async function fetchArticleTags(
  transport: Transport,
  articleId: string,
): Promise<TagTrailTag[]>

export async function fetchRandomFeed(
  transport: Transport,
): Promise<RandomFeed>
```

### PROS

1. **アーキテクチャ統一**: 他のAPIと同様にconnect-rpc経由で通信
2. **型安全性向上**: Protoから生成された型を使用
3. **HTTP/2対応**: alt-butterfly-facade経由での効率的な通信
4. **既存usecase再利用**: バックエンドロジックの変更不要

### CONS, TRADEOFF

1. **REST APIの残存**: `getFeedTagsByIdClient`は未移行（フィードタグ取得用）
2. **型の互換性調整**: `createdAt`をオプショナルにして既存スキーマと互換性維持

## APPENDIX

### 検証コマンド

```bash
# コンテナ再ビルド・起動
docker compose -f compose/compose.yaml -p alt up -d --build alt-backend alt-butterfly-facade alt-frontend-sv

# ヘルスチェック
curl http://localhost:9000/v1/health
curl http://localhost:3000/api/health

# バックエンドテスト
cd alt-backend/app && go test ./connect/v2/articles/... -v

# フロントエンド型チェック・ビルド
cd alt-frontend-sv && bun run check && bun run build

# ログ確認
docker compose -f compose/compose.yaml -p alt logs alt-backend --since 5m | grep -i "FetchArticlesByTag\|FetchRandomFeed"
```

### シーケンス図

```
┌──────────┐    ┌────────────────┐    ┌───────────┐    ┌───────────┐
│ Frontend │    │ butterfly-facade│    │ alt-backend│    │  Usecase  │
└────┬─────┘    └───────┬────────┘    └─────┬─────┘    └─────┬─────┘
     │                  │                   │                 │
     │ FetchArticlesByTag(tag_name="golang")                  │
     │─────────────────>│                   │                 │
     │                  │                   │                 │
     │                  │ HTTP/2 Proxy      │                 │
     │                  │──────────────────>│                 │
     │                  │                   │                 │
     │                  │                   │ ExecuteByTagName│
     │                  │                   │────────────────>│
     │                  │                   │                 │
     │                  │                   │ []*TagTrailArticle
     │                  │                   │<────────────────│
     │                  │                   │                 │
     │                  │ FetchArticlesByTagResponse          │
     │                  │<──────────────────│                 │
     │                  │                   │                 │
     │ TagTrailArticlesResponse             │                 │
     │<─────────────────│                   │                 │
```

### 関連ADR

- ADR-167: Tag Trail機能の追加
- ADR-168: オンザフライタグ生成実装
- ADR-169: タグ名検索への変更
