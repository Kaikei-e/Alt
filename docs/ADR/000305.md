# ADR-000305: OGP 画像・記事表示の SSR 認証レートリミット問題を修正

## ADR's STATUS

Accepted

## CONTEXT

フロントエンド（SvelteKit SSR）で OGP 画像が表示されない・記事が更新されないという報告があった。バックエンド側は正常に動作しており、問題はフロントエンドの SSR 認証フローに起因していた。

### 根本原因

1ページロードで認証ハブの `/session` エンドポイントを **3回** 呼び出していた:

| 呼び出し元 | 経路 |
|-----------|------|
| `hooks.server.ts` | `validateSession` → `fetchBackendToken`（30秒キャッシュあり）|
| `+page.server.ts` | `getFeedsWithCursor` → `createServerTransport` → `getBackendToken` |
| `+page.server.ts` | `fetchArticleContent` → `createServerTransport` → `getBackendToken` |

`hooks.server.ts` のキャッシュと `+page.server.ts` の `createServerTransport` はトークンを共有しないため、キャッシュの恩恵を受けられなかった。認証ハブのレートリミット（30 req/min, burst 5）に抵触すると 429 が返り、バックエンドへのリクエストが 401 で失敗し SSR が空レスポンスを返す。

さらに SSR 失敗時のクライアントサイドフォールバックが欠如しており、`initialFeeds` が空配列・`initialNextCursor` が null の場合に `hasMore = false` となり、クライアントサイドでのリトライが発火しなかった。

加えて、`BatchPrefetchImages` が `feed.articleId` に依存するが、新規フィードは `articleId` が未設定のため OGP プロキシ画像のプリフェッチが事実上呼ばれない問題もあった。

## DECISION MAKING

### 方針 1: `locals.backendToken` の活用によるトークン共有

`hooks.server.ts` で取得・キャッシュ済みの `locals.backendToken` を `+page.server.ts` で再利用し、認証ハブへの追加呼び出しを排除する。

| 項目 | 決定 | 理由 |
|------|------|------|
| トークン受け渡し | `locals.backendToken` を `+page.server.ts` で参照 | SvelteKit の request-scoped locals が自然な共有メカニズム |
| 新関数 | `createServerTransportWithToken(token)` | 既存の `createServerTransport(cookie)` と分離し、同期的にトランスポートを生成 |
| `getFeedsWithCursor` | 第4引数に `backendToken?` を追加 | 既存の呼び出し元に影響を与えずオプトイン可能 |
| フォールバック | `backendToken` が null の場合は従来の `createServerTransport(cookie)` を使用 | 認証失敗時の後方互換性を維持 |

### 方針 2: SSR 失敗時のクライアントサイドフォールバック

`hasMore` の初期値ロジックを変更し、SSR 失敗時にクライアントサイドで `loadMore()` が発火するようにする。

```
// Before: SSR失敗 → hasMore=false → loadMore()が呼ばれない
hasMore = !!initialNextCursor

// After: initialFeedsが空の場合はhasMore=trueにしてリトライを許可
hasMore = initialFeeds.length > 0 ? !!initialNextCursor : true
```

### 方針 3: `onArticleIdCached` コールバックによる遅延 BatchPrefetch

`ArticlePrefetcher.prefetchContent` で `article_id` が解決された時点でコールバックを発火し、`SwipeFeedScreen` でバッチプリフェッチをトリガーする。

### 他の選択肢を採用しなかった理由

- **認証ハブのレートリミット緩和**: 根本的に不要なリクエストを削減すべきであり、レートリミット引き上げは対症療法
- **`createServerTransport` 内部にキャッシュ追加**: トランスポート関数は cookie を受け取る汎用関数であり、リクエストスコープのキャッシュを持たせるのは責務が不明瞭
- **SSR 側でのリトライ**: SSR でリトライするとレスポンスタイムが増加し、TTFB に悪影響

## RESULTS, EFFECTS

### PROS

- 認証ハブ `/session` の呼び出しがページロードあたり **3回 → 1回** に削減
- レートリミット 429 による SSR 失敗が解消
- SSR 失敗時もクライアントサイドフォールバックにより記事が表示される
- `prefetchContent` で解決された `articleId` を即座にバッチプリフェッチに連携し、OGP プロキシ画像が取得される
- 既存の呼び出し元に対して後方互換性を維持（`backendToken` はオプショナル引数）

### CONS, TRADEOFF

- `getFeedsWithCursor` の引数が増加（4番目のオプショナル引数）。呼び出し元が増えた場合、オプション引数の管理が複雑化する可能性がある
- `onArticleIdCached` コールバックの追加により `ArticlePrefetcher` の API 表面が拡大

## APPENDIX

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `alt-frontend-sv/src/lib/connect/transport-server.ts` | `createServerTransportWithToken(token)` 関数を追加 |
| 2 | `alt-frontend-sv/src/lib/server/feed-api.ts` | `getFeedsWithCursor` に `backendToken` オプショナル引数を追加 |
| 3 | `alt-frontend-sv/src/routes/(app)/feeds/swipe/visual-preview/+page.server.ts` | `locals.backendToken` を使用し、認証ハブ追加呼び出しを排除 |
| 4 | `alt-frontend-sv/src/lib/components/mobile/feeds/swipe/SwipeFeedScreen.svelte` | SSR フォールバック + `onArticleIdCached` によるバッチプリフェッチ連携 |
| 5 | `alt-frontend-sv/src/lib/utils/articlePrefetcher.ts` | `onArticleIdCached` コールバックを追加、`prefetchContent` で発火 |

### 新規テスト

| # | ファイル | テスト内容 |
|---|---------|-----------|
| 1 | `alt-frontend-sv/src/lib/connect/transport-server.test.ts` | `createServerTransportWithToken` がトークンヘッダーを設定すること、同期的に Transport を返すこと（2件）|
| 2 | `alt-frontend-sv/src/lib/utils/articlePrefetcher.test.ts` | `onArticleIdCached` が article_id 解決時に発火すること、article_id 未設定時に発火しないこと、null で解除できること（3件）|

### 検証結果

- ユニットテスト: 全448件パス（`vitest run`）
- コンテナ再ビルド・起動: 正常
- ヘルスチェック: フロントエンド `{"status":"ok"}` / バックエンド `{"status":"healthy"}`
