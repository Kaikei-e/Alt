# Evening Pulse v4.0 実装

## ステータス

承認済み（2026-01-30）

## 背景

### 課題

既存のEvening Pulse機能は、クラスタリング結果をそのまま出力しており、以下の課題があった：

1. **品質の不均一性**: クラスタの品質が一定でなく、低品質なトピックがそのまま出力される
2. **シンジケーション重複**: 通信社経由の同一記事が複数ソースとして表示される
3. **役割の不明確さ**: トピック選択の意図が明確でなく、多様性が保証されない
4. **透明性の欠如**: なぜそのトピックが選ばれたかの説明がない

### 要件

- 3つの異なる視点（NeedToKnow/Trend/Serendipity）からトピックを選出
- クラスタ品質の3段階評価（OK/Caution/NG）
- シンジケーション検出による重複除去
- 選出理由の自動生成

## 決定事項

### アーキテクチャ

パイプラインステージとして実装し、4つのサブモジュールに分割：

```
PulseInput → [QualityEvaluator] → [SyndicationRemover] → [TopicSelector] → [RationaleGenerator] → PulseResult
```

### モジュール構成

| モジュール | 責務 |
|-----------|------|
| `cluster_quality` | クラスタ品質評価（Cohesion/Ambiguity/EntityConsistency） |
| `syndication` | シンジケーション検出・除去（Canonical/Wire/Title） |
| `selection` | ロールベーストピック選択 |
| `rationale` | 選出理由テキスト生成 |

### 品質評価メトリクス

3つのメトリクスを組み合わせて品質を診断：

| メトリクス | 計算方法 | 閾値（デフォルト） |
|-----------|---------|-------------------|
| Cohesion | タイトル間Jaccard類似度の平均 | ≥ 0.3 |
| Ambiguity | 低類似度埋め込みペアの割合 | ≤ 0.5 |
| Entity Consistency | 最頻出エンティティの出現率 | ≥ 0.4 |

診断結果：
- **OK**: 3つすべてが閾値をクリア
- **Caution**: 1つが閾値未達
- **NG**: 2つ以上が閾値未達

### シンジケーション検出（3段階）

1. **Canonical URL**: og:url/canonicalの一致検出
2. **Wire Source**: 通信社ドメイン（Reuters, AP, AFP等）の検出
3. **Title Similarity**: タイトルn-gram類似度（デフォルト無効）

### ロールベース選択

| ロール | 重み配分 | 意図 |
|--------|---------|------|
| NeedToKnow | Impact 50%, Recency 25% | 今知るべき重要ニュース |
| Trend | Burst 50%, Impact 20% | 話題急上昇のトピック |
| Serendipity | Novelty 50%, Recency 20% | 意外な発見 |

### グレースフルデグラデーション

クラスタが不足する場合の段階的フォールバック：

| レベル | 条件 | 動作 |
|--------|------|------|
| 0 | 通常 | OKティアのみ使用 |
| 1 | OK不足 | Cautionティア追加 |
| 2 | まだ不足 | NGティア追加 |
| 4 | 1トピックのみ | Quiet Day Mode |
| 6 | 0トピック | 空結果 |

### ロールアウト制御

`PulseRollout`による段階的リリース：

```rust
pub struct PulseRollout {
    percentage: u8,    // 0-100
    version: PulseVersion,
}
```

job_idのハッシュ値で決定論的にバケット振り分け。

## 結果・影響

### 追加ファイル

| ファイル | 行数 | 内容 |
|---------|-----|------|
| `pipeline/pulse/mod.rs` | - | モジュール定義 |
| `pipeline/pulse/types.rs` | 520+ | 型定義 |
| `pipeline/pulse/config.rs` | 430+ | 設定・ロールアウト |
| `pipeline/pulse/cluster_quality.rs` | 620+ | 品質評価 |
| `pipeline/pulse/syndication.rs` | 570+ | シンジケーション除去 |
| `pipeline/pulse/selection.rs` | 510+ | トピック選択 |
| `pipeline/pulse/rationale.rs` | 330+ | 理由生成 |
| `pipeline/pulse/stage.rs` | 640+ | パイプライン統合 |

### DBスキーマ追加

```sql
-- pulse_generations: 生成実行の記録
-- pulse_cluster_diagnostics: クラスタ品質診断結果
-- pulse_selection_log: トピック選択ログ
```

### テストカバレッジ

87テストケースで主要機能を網羅：
- 品質評価の境界値テスト
- シンジケーション検出パターン
- ロールベース選択の正確性
- フォールバック動作

### メリット

- **品質保証**: 低品質クラスタの自動除外
- **多様性**: 3つの異なる視点の保証
- **透明性**: 選出理由の自動生成
- **運用性**: 環境変数による柔軟な設定
- **段階リリース**: ロールアウト制御による安全なデプロイ

### デメリット・トレードオフ

- **計算コスト**: 品質評価の追加処理
- **設定複雑性**: 閾値チューニングが必要
- **Quiet Day Mode**: 低品質データのみの場合は出力減少

## 付録

### 環境変数

| 変数 | デフォルト | 説明 |
|------|-----------|------|
| `PULSE_ENABLED` | false | 機能有効化 |
| `PULSE_VERSION` | v4 | バージョン指定 |
| `PULSE_ROLLOUT_PERCENT` | 0 | ロールアウト率 |
| `PULSE_MAX_TOPICS` | 3 | 最大トピック数 |
| `PULSE_COHESION_THRESHOLD` | 0.3 | Cohesion閾値 |
| `PULSE_AMBIGUITY_THRESHOLD` | 0.5 | Ambiguity閾値 |

### Rust 2024 Edition対応

以下のclippy lintに準拠：
- `map_unwrap_or` → `map_or`
- `redundant_closure_for_method_calls` → メソッド参照
- `trivially_copy_pass_by_ref` → 値渡し
- `derivable_impls` → `#[derive(Default)]`
- `len_zero` → `is_empty()`

### データベースマイグレーション移行（2026-01-31追記）

レガシーinit SQLファイルからAtlasマイグレーションへの完全移行を実施。

#### 実施内容

| 項目 | 内容 |
|------|------|
| 移行対象 | `recap-worker/recap-db/init/007_evening_pulse.sql` |
| 移行先 | `recap-migration-atlas/migrations/20260131000000_add_evening_pulse_tables.sql` |
| 削除ファイル | `001_base_schema.sql` 〜 `007_evening_pulse.sql`（7ファイル） |

#### Atlas設定の更新

atlas.hclをv0.31+ベストプラクティスに更新：

- **Docker dev-url**: `docker://postgres/18/dev?search_path=public`
- **CI環境追加**: lint強化（destructive, data_depend, naming, MF101）
- **変数化**: `DATABASE_URL`をvariableで管理

#### Dockerfileバージョン固定

```dockerfile
FROM arigaio/atlas:0.31.0-alpine
```

`latest`から特定バージョンにピン留めし、再現性を確保。

#### CI/CDワークフロー

`.github/workflows/recap-db-atlas.yaml`を新規追加：

| Job | 内容 |
|-----|------|
| verify-checksum | atlas.sum整合性検証 |
| dry-run | PostgreSQL 18での適用テスト |

トリガー: `recap-migration-atlas/**`への変更時

#### マイグレーションファイルの変換

レガシーSQLからAtlas形式への変換ポイント：

- `IF NOT EXISTS`句の削除（Atlas管理下では不要）
- `COMMENT ON`ステートメントの保持
- `CREATE OR REPLACE VIEW`の維持

### DAO層とパイプライン統合（2026-01-31追記）

Evening Pulse生成結果の永続化とパイプラインへの統合を実装。

#### 追加テーブルカラム

`pulse_generations`テーブルに`target_date`カラムを追加：

```sql
target_date DATE NOT NULL DEFAULT CURRENT_DATE
```

インデックス追加：
```sql
CREATE INDEX idx_pulse_generations_target_date ON pulse_generations(target_date DESC);
```

#### DAO層の拡張

`PulseDao`トレイトに`save_pulse_generation`メソッドを追加：

| ファイル | 変更内容 |
|---------|---------|
| `store/dao/traits/pulse.rs` | トレイト定義の追加 |
| `store/dao/pulse.rs` | SQL実装（INSERT INTO pulse_generations） |
| `store/dao/compat.rs` | RecapDaoトレイトへの統合 |
| `store/dao/mock.rs` | テスト用モック実装 |
| `store/dao/impls/unified.rs` | UnifiedDao実装 |

メソッドシグネチャ：
```rust
async fn save_pulse_generation(
    &self,
    result: &PulseResult,
    target_date: NaiveDate,
) -> Result<i64>;
```

保存されるデータ：
- `job_id`: 生成元ジョブID
- `target_date`: 対象日付
- `version`: アルゴリズムバージョン（v2/v3/v4）
- `status`: succeeded/failed
- `topics_count`: 生成トピック数
- `result_payload`: 完全な結果JSON

#### パイプライン統合

`PipelineOrchestrator`に以下を追加：

| フィールド | 型 | 説明 |
|-----------|-----|------|
| `pulse_stage` | `Arc<dyn PulseStage>` | Pulseステージ実装 |
| `pulse_rollout` | `PulseRollout` | ロールアウト設定 |

`PipelineBuilder`に追加されたメソッド：
- `with_pulse_stage()`
- `with_pulse_rollout()`

#### 実行フロー

```
Dispatch → [Pulse生成] → Persist
           ↓
    ロールアウト判定
           ↓
    DispatchResult → PulseInput変換
           ↓
    PulseStage.generate()
           ↓
    save_pulse_generation()
```

Dispatchステージ後、Persistステージ前にPulse生成を実行：

1. `PulseRollout.allows(job_id)`でロールアウト判定
2. `DispatchResult`のクラスタリング結果を`PulseInput`に変換
3. `PulseStage.generate()`でトピック選出
4. `save_pulse_generation()`でDB永続化

#### 変換ロジック

`DispatchResult` → `PulseInput`の変換：

```rust
// 各ジャンルのクラスタリング結果からクラスタを抽出
for (genre, genre_result) in dispatched.genre_results {
    if let Some(clustering_response) = genre_result.clustering_response {
        for cluster in clustering_response.clusters {
            // representativesからArticleInputを構築
            // cluster_idをi64に変換
            // labelをジャンル名と組み合わせて設定
        }
    }
}
```

#### エラーハンドリング

Pulse生成の失敗はパイプライン全体をブロックしない：

- ロールアウト対象外: DEBUGログのみ
- 生成失敗: WARNログ、パイプライン続行
- 保存失敗: WARNログ、パイプライン続行

#### テスト

全274テストがパス（既存テスト + Pulse関連87テスト）。

### 関連ADR

- なし
