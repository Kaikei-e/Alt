# ADR-000293: ハートビートをLLMストリーミングフェーズに拡張

## ADR's STATUS

Accepted（ADR-000292の補完）

## CONTEXT

ADR-000292でbuildPrompt（検索+リランキング）フェーズにハートビートを導入したが、`missing EndStreamResponse` エラーが依然として発生していた。

### 調査結果

rag-orchestratorのログを分析したところ、以下の状況が確認された：

- `chunks_received:94`（LLMチャンクは実際に流れていた）
- `rt=30.002`（リクエストがちょうど30秒で切断）

buildPromptフェーズはハートビートで生存していたが、**その後のフェーズ**にハートビートがなかった。

### 根本原因

ADR-000292のハートビートtickerは`buildPrompt`完了時に`Stop()`されており、以下の区間がカバーされていなかった：

1. **ChatStream接続確立待ち**: `ChatStream()`はLLMサーバーへの接続確立でブロックする。モデルロード中やGPU待ち時に数秒〜数十秒かかる可能性がある
2. **LLMストリーミングループ内のチャンク間隔**: thinking（推論）→generation（生成）のフェーズ切り替え時に長い無データ区間が発生する。selectに`heartbeat.C`のcaseがなく、この間ハートビートが送信されなかった

これらの区間でProxy Write Timeout（30秒）に到達し、接続が切断されていた。

## DECISION MAKING

ハートビートtickerのライフサイクルを「buildPromptフェーズのみ」から「ストリーム全体」に拡張する方針を採用。

### 1. heartbeat tickerのライフサイクル拡張

**変更前**: buildPrompt完了時またはctx.Done()時に`heartbeat.Stop()`を呼び出し
**変更後**: `defer heartbeat.Stop()`でストリームgoroutine終了まで維持

これにより、buildPrompt・ChatStream接続・LLMストリーミングの全フェーズでtickerが有効になる。

### 2. ChatStream()のgoroutine化

`ChatStream()`呼び出しをgoroutineで非同期実行し、buildPromptと同じselect+heartbeatパターンを適用。LLMサーバーへの接続確立中もハートビートが流れる。

```go
chatStreamCh := make(chan chatStreamResult, 1)
go func() {
    ch, ech, setupErr := u.llmClient.ChatStream(ctx, messages, maxTokens)
    chatStreamCh <- chatStreamResult{chunkCh: ch, errCh: ech, err: setupErr}
}()

waitChatStream:
for {
    select {
    case <-ctx.Done(): return
    case result := <-chatStreamCh: ...
    case <-heartbeat.C: // ハートビート送信
    }
}
```

### 3. LLMストリーミングselectへのheartbeat case追加

既存のchunk/error/ctxのselectループに`heartbeat.C`のcaseを追加。チャンク間に長い無データ区間があってもハートビートが送信される。

## RESULTS, EFFECTS

### PROS

- **全フェーズのタイムアウト回避**: buildPrompt → ChatStream接続 → LLMストリーミングの全区間でハートビートが有効
- **最小限の変更**: 既存のticker機構を再利用し、ライフサイクルの拡張とselect caseの追加のみ
- **テストカバレッジ**: 3つのフェーズそれぞれに対応するテストケースを用意
- **後方互換性**: 既存のフロントエンド・プロキシ層はADR-000292でハートビートスキップ処理を実装済みのため、追加対応不要

### CONS, TRADEOFF

- **goroutineの追加**: `ChatStream()`呼び出しもgoroutine化したため、goroutine数が1つ増加（影響は軽微）
- **ハートビート送信量の増加**: 全フェーズで送信されるため、1リクエストあたりのハートビートイベント数が増加（数十バイト/イベントのため帯域影響は無視可能）

## APPENDIX

### 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `rag-orchestrator/internal/usecase/rag_answer_stream.go` | heartbeat lifecycle拡張 + ChatStream goroutine化 + LLM select case追加 |
| `rag-orchestrator/internal/usecase/answer_with_rag_usecase_test.go` | LLMフェーズのハートビートテスト2件追加 |

### テスト

| テスト名 | 検証内容 |
|---------|---------|
| `TestStream_HeartbeatDuringSlowBuildPrompt` | 既存: 検索+リランキング中のハートビート発行（ADR-000292） |
| `TestStream_HeartbeatDuringChatStreamSetup` | 新規: ChatStream接続確立中のハートビート発行 |
| `TestStream_HeartbeatDuringLLMStreaming` | 新規: LLMチャンク間の長い無データ区間でのハートビート発行 |
| `TestStream_NoHeartbeatWhenBuildPromptFast` | 既存: 高速完了時にハートビートが不要に発行されないことの確認 |

### 関連ADR

- ADR-000289: nginx `proxy_buffering off` + progressイベント導入
- ADR-000292: buildPromptフェーズへのハートビート導入（本ADRの前段対策）
