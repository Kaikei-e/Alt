# ADR-000267: Visual Preview スワイプモードの実装

## ステータス

承認済み

## コンテキスト

### 背景

Alt のスワイプモード（`/sv/feeds/swipe`）はテキストのみのカード UI で記事を閲覧するが、記事のサムネイル画像は表示されていない。RSS フィードの記事は既にオンザフライで HTML コンテンツを取得しており（`getFeedContentOnTheFlyClient`）、この HTML 内に og:image としてサムネイル情報が含まれている。

### 目的

サムネイル画像付きのカードで記事をブラウズできる「Visual Preview」スワイプモードを追加し、マガジン風の視覚的なブラウジング体験を提供する。モバイルファーストで、既存のデザイン言語に準拠する。

### 制約

- バックエンドのドメインホワイトリストが限定的なため、バックエンドプロキシ経由の画像配信は不採用
- ネイティブ `<img>` タグは CORS 制約を受けないため、任意の HTTPS ソースから直接取得可能
- SSR 環境でも動作する必要があるため、DOMParser は使用せず regex ベースで HTML パース

## 意思決定

### アーキテクチャ

既存の `ArticlePrefetcher` が取得する HTML コンテンツからサムネイル URL を抽出し、2 層キャッシュ（メモリ + localStorage）で管理する設計を採用した。

```
ArticlePrefetcher (既存: HTML取得)
  → onContentFetched コールバック (新規: フック)
    → ThumbnailPrefetcher (新規: 抽出 + キャッシュ)
      → extractThumbnailUrl (新規: 純粋関数)
        → VisualPreviewCard (新規: <img> で直接表示)
          → ブラウザ HTTP キャッシュ (ネイティブ)
```

### サムネイル抽出

OGP 画像（`og:image`）のみを抽出対象とする。`<img>` タグからのフォールバック抽出は行わない。

| ソース | 条件 |
|--------|------|
| `<meta property="og:image">` | HTTPS URL のみ |

OGP 画像が存在しない、または HTTPS でない場合はサムネイルなし（フォールバックグラデーション表示）となる。

### キャッシュ戦略

| 項目 | 値 |
|------|-----|
| キャッシュキー | `alt-thumbnail-cache-v1`（localStorage） |
| TTL | 12 時間 |
| 最大エントリ数 | 500（超過時に古い 100 件を削除） |
| null キャッシュ | 画像なし記事も `null` としてキャッシュ（再スキャン防止） |
| メモリキャッシュ | `Map<string, string \| null>`（localStorage からの復元あり） |
| プリフェッチ範囲 | アクティブカードから 5 件先まで |

### 不採用案

| 不採用案 | 理由 |
|---------|------|
| バックエンド画像プロキシ | ドメインホワイトリストが限定的で任意 RSS ソースに対応不可 |
| DOMParser による HTML パース | SSR 環境で利用不可 |
| 画像データの localStorage キャッシュ | サイズ制限（5MB）を圧迫する。URL のみ保存し、画像データはブラウザ HTTP キャッシュに委譲 |

## 結果・影響

### 新規ファイル

| ファイル | 役割 |
|---------|------|
| `src/lib/utils/thumbnailExtractor.ts` | HTML からサムネイル URL を抽出する純粋関数 |
| `src/lib/utils/thumbnailExtractor.spec.ts` | 抽出ロジックのユニットテスト（20 件） |
| `src/lib/utils/thumbnailPrefetcher.ts` | 2 層キャッシュ + プリフェッチのオーケストレーション |
| `src/lib/utils/thumbnailPrefetcher.spec.ts` | キャッシュ・localStorage・プリフェッチのユニットテスト（17 件） |
| `src/lib/components/mobile/feeds/swipe/VisualPreviewCard.svelte` | サムネイル付きスワイプカードコンポーネント |
| `src/lib/components/mobile/feeds/swipe/VisualPreviewCard.svelte.spec.ts` | コンポーネントテスト（ブラウザ環境） |
| `src/routes/(app)/feeds/swipe/visual-preview/+page.ts` | ルートローダー |
| `src/routes/(app)/feeds/swipe/visual-preview/+page.svelte` | ルートページ（`mode="visual-preview"`） |

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/lib/utils/articlePrefetcher.ts` | `setOnContentFetched` コールバックフックを追加（3 行） |
| `src/lib/components/mobile/feeds/swipe/SwipeFeedScreen.svelte` | `mode` prop 追加、サムネイルプリフェッチャー連携、条件付きカード描画 |
| `src/lib/components/mobile/feeds/swipe/FloatingMenu.svelte` | 「Visual Preview」ナビゲーションエントリ追加 |

### VisualPreviewCard のレイアウト

```
+------------------------------------------+
|           サムネイル画像                    |
|         (object-cover, 35%)               |
|    [グラデーションオーバーレイ]              |
+------------------------------------------+
|  "Swipe to mark as read"                 |
|  [リンクアイコン] 記事タイトル              |
|  公開日                                   |
|  説明文 (line-clamp-3)                    |
|  [Article] [★] [Summary]                 |
+------------------------------------------+
```

- サムネイルあり: `<img>` + シマーローディング + エラー時グラデーションフォールバック
- サムネイルなし: テーマカラーの装飾グラデーション背景

### テスト結果

| テストスイート | 結果 |
|--------------|------|
| サーバーテスト全体（`vitest run --project=server`） | 452 件全件 PASS（35 ファイル） |
| thumbnailExtractor | 20 件 PASS |
| thumbnailPrefetcher | 17 件 PASS |
| 型チェック（`svelte-check`） | 0 エラー、0 警告 |
| Lint（`biome check`） | 新規コード 0 エラー |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| コンテナ再ビルド | ビルド成功 |
| コンテナ起動・ヘルスチェック | healthy |
| `/sv/feeds/swipe/visual-preview` ルート | HTTP 200 |
| `/sv/feeds/swipe` 既存ルート | HTTP 200（影響なし） |

### PROS

- 既存のスワイプモードに影響を与えず、新しいルートとして独立して追加
- HTML コンテンツの取得は既存の `ArticlePrefetcher` を再利用（追加 API コール不要）
- `onContentFetched` コールバックにより疎結合（Visual Preview モード以外ではオーバーヘッドなし）
- localStorage キャッシュにより、ページリロード後もサムネイル URL を即座に利用可能
- `null` キャッシュにより、画像なし記事への無駄な再スキャンを防止
- 純粋関数 `extractThumbnailUrl` は SSR セーフ、単体テスト容易

### CONS, TRADEOFF

- ネイティブ `<img>` タグの使用により、外部画像サーバーの可用性に依存する（画像 CDN ダウン時はフォールバックグラデーション表示）
- regex ベースの HTML パースは、非標準的なマークアップで誤抽出する可能性がある（ただし `og:image` のみを対象としているためリスクは低い）
- `VisualPreviewCard` は `SwipeFeedCard` のコードを複製しているため、共通ロジックの重複がある。将来的に共通部分の抽出を検討可能
- localStorage の 5MB 上限に対し、500 エントリ × URL 文字列で通常 50KB 以下であり問題ないが、極端に長い URL が多い場合は上限に近づく可能性がある

### 影響範囲

- **alt-frontend-sv**: 新規 8 ファイル、変更 3 ファイル
- **alt-backend**: 変更なし
- **他サービス**: 変更なし

## 付録

### データフロー

```
ユーザー操作                alt-frontend-sv
┌──────────┐    ┌──────────────────────────────────────────────┐
│ スワイプ   │    │ SwipeFeedScreen (mode="visual-preview")     │
│          │    │                                              │
│ カード表示 │    │  ArticlePrefetcher                          │
│    ↑     │    │   ├─ fetch HTML ─→ alt-backend (既存)        │
│    │     │    │   └─ onContentFetched callback               │
│    │     │    │        ↓                                     │
│    │     │    │  ThumbnailPrefetcher                         │
│    │     │    │   ├─ extractThumbnailUrl(html)               │
│    │     │    │   ├─ memoryCache.set(url, imageUrl)          │
│    │     │    │   └─ localStorage.setItem(cache)             │
│    │     │    │        ↓                                     │
│    │     │    │  VisualPreviewCard                           │
│    │     │    │   └─ <img src={thumbnailUrl}> ──→ 外部CDN    │
│    │     │    │       (ブラウザHTTPキャッシュ)                  │
└──────────┘    └──────────────────────────────────────────────┘
```

### ルーティング

| パス | モード | コンポーネント |
|------|--------|-------------|
| `/sv/feeds/swipe` | default | SwipeFeedCard |
| `/sv/feeds/swipe/visual-preview` | visual-preview | VisualPreviewCard |
