# auth-token-manager Clean Architecture リファクタリング

## ADR's STATUS

Accepted (Phase 1-5 実装完了)

## CONTEXT

### 問題点

auth-token-manager は Inoreader OAuth2 トークンの自動更新を担う Deno 2.x サービス。運用の中で以下の構造的課題が顕在化:

| # | 分類 | 問題 |
|---|------|------|
| 1 | アーキテクチャ | `main.ts` (697 行) が God File 化。DI・CLI ルーティング・HTTP サーバー・ビジネスロジックが混在 |
| 2 | デッドコード | 廃止されたブラウザ自動化コード (`browser.ts` 622 行, `inoreader.ts` 719 行, `oauth-old.ts` 642 行) が約 2,000 行残存 |
| 3 | Clean Architecture 不在 | プロジェクト標準の `Handler -> Usecase -> Port -> Gateway` パターンが未適用 |
| 4 | テストカバレッジ不足 | ログサニタイズのテストのみで、コアのトークン更新・ヘルスチェック・監視ロジックのテストなし |
| 5 | セキュリティ | `/api/token` エンドポイントが認証なしでトークンメタデータを公開。OAuth callback の CSRF state 検証が不在 |
| 6 | パフォーマンス | `setInterval` の重複実行リスク。`getSecretManager()` が毎回新規インスタンスを生成 |
| 7 | 依存管理 | `deno.land` URL ベースの import map。JSR レジストリ未使用 |

### 方針

5 フェーズに分けて段階的に実施。各フェーズ完了時に `deno test --allow-all` (全テスト通過) + `deno lint` + `deno check main.ts` をゲーティング条件とする。

## DECISION MAKING

### Phase 1: デッドコード削除と deno.json モダナイズ

約 2,000 行のデッドコードを削除:

| 削除ファイル | 行数 | 理由 |
|-------------|------|------|
| `src/auth/browser.ts` | 622 行 | Playwright ブラウザ自動化、完全に未使用 |
| `src/auth/inoreader.ts` | 719 行 | ブラウザ OAuth フロー、完全に未使用 |
| `src/auth/oauth-old.ts` | 642 行 | 旧 InoreaderTokenManager のコピー、完全に未使用 |
| `tests/unit/logger_security_test.ts` | 241 行 | `tests/security/` と重複 |

`deno.json` を `deno.land` URL から JSR レジストリに移行し、tasks セクションを追加:

```json
{
  "tasks": {
    "start": "deno run --allow-net --allow-read --allow-write --allow-env main.ts daemon",
    "test": "deno test --allow-all",
    "lint": "deno lint",
    "check": "deno check main.ts"
  },
  "imports": {
    "@std/log": "jsr:@std/log@^0.224.0",
    "@std/testing/bdd": "jsr:@std/testing@^1.0.0/bdd",
    "@std/testing/mock": "jsr:@std/testing@^1.0.0/mock"
  }
}
```

### Phase 2: Clean Architecture 適用

697 行の `main.ts` を 5 レイヤーに分割:

```
main.ts                          # DI container (95 行)
src/
├── domain/types.ts              # ドメインモデル・型定義
├── port/                        # インターフェース定義
│   ├── secret_manager.ts        # SecretManager interface
│   ├── token_client.ts          # TokenClient interface
│   └── http_client.ts           # HttpClient interface
├── gateway/                     # Port 実装 (外部依存)
│   ├── env_file_secret_manager.ts
│   ├── inoreader_token_client.ts
│   └── fetch_http_client.ts
├── usecase/                     # ビジネスロジック
│   ├── refresh_token.ts         # トークン更新判定 + 実行
│   ├── health_check.ts          # 5 項目ヘルスチェック
│   ├── monitor_token.ts         # 多段アラート (info/warning/critical)
│   └── authorize.ts             # OAuth 認可フロー + CSRF state 管理
├── handler/                     # エントリポイント
│   ├── cli.ts                   # CLI コマンドルーティング
│   ├── oauth_server.ts          # HTTP サーバー (/healthz, /auth, /callback, /api/token)
│   └── daemon.ts                # デーモンループ + graceful shutdown
└── infra/                       # 横断的関心事
    ├── config.ts                # ConfigManager (singleton, キャッシュ付き)
    ├── logger.ts                # StructuredLogger + DataSanitizer
    ├── otel.ts                  # OpenTelemetry provider
    └── retry.ts                 # retryWithBackoff
```

レイヤー間の依存方向:

```
main.ts (DI container)
  ├── handler/ → usecase/ → port/ (interface only)
  └── gateway/ implements port/
      └── infra/ (logger, config, retry)
```

旧ディレクトリ (`src/auth/`, `src/file/`, `src/utils/`) は全て削除し、新構造に移行。

`main.ts` は DI コンテナとして以下のみを担当:

```typescript
const config = ConfigManager.getInstance();
const configOptions = await config.loadConfig();
const credentials = config.getInoreaderCredentials();

const secretManager = new EnvFileSecretManager(configOptions.token_storage_path);
const httpClient = new FetchHttpClient(configOptions.network);
const tokenClient = new InoreaderTokenClient(credentials, httpClient);

const refreshUsecase = new RefreshTokenUsecase(tokenClient, secretManager, httpClient, ...);
const healthUsecase = new HealthCheckUsecase(secretManager);
const monitorUsecase = new MonitorTokenUsecase(secretManager);
const authorizeUsecase = new AuthorizeUsecase(tokenClient, secretManager);

const cli = new CliHandler(refreshUsecase, healthUsecase, monitorUsecase, ...);
await cli.run(Deno.args);
```

### Phase 3: セキュリティ修正

| 修正 | 内容 |
|------|------|
| `/api/token` 認証 | `X-Internal-Auth` ヘッダーによる内部認証。未認証時はトークン有効期限のみ返却 |
| CSRF state 検証 | OAuth callback で `Map<string, { state, createdAt }>` による state 照合。TTL 5 分で自動失効 |
| ログサニタイズ | `console.log` を全て `StructuredLogger` に置換。`DataSanitizer` でトークン値をマスク |
| ファイルパーミッション | `EnvFileSecretManager.updateTokenSecret()` で `Deno.chmod(path, 0o600)` を適用 |
| エラーメッセージ | API レスポンスのエラーテキストをサニタイズして返却 |

### Phase 4: パフォーマンス・信頼性改善

| 改善 | Before | After |
|------|--------|-------|
| デーモンループ | `setInterval` (重複実行リスク) | `while + await delay()` (順次実行保証) |
| インスタンス管理 | 毎回 `getSecretManager()` で新規生成 | DI で 1 回だけ生成、注入 |
| コンフィグ | `loadConfig()` を毎回呼び出し | 初回ロード後キャッシュ |
| シャットダウン | なし | `AbortController` + `SIGINT/SIGTERM` リスナーで graceful shutdown |
| ヘルスチェック | なし | `/healthz` エンドポイント追加 (readiness probe 対応) |

### Phase 5: テスト (TDD)

7 テストファイル、38 テストステップを実装:

| テストファイル | テスト数 | 対象 |
|---------------|---------|------|
| `tests/unit/usecase/refresh_token_test.ts` | 5 | トークン更新ロジック (成功、スキップ、エラー、不正フォーマット) |
| `tests/unit/usecase/health_check_test.ts` | 4 | ヘルスチェック (healthy, unhealthy, degraded, storage error) |
| `tests/unit/usecase/monitor_token_test.ts` | 6 | 多段アラート (info, warning, critical の各条件) |
| `tests/unit/gateway/env_file_secret_manager_test.ts` | 6 | ファイル I/O (読み書き、保全、存在確認、ディレクトリ作成) |
| `tests/unit/gateway/inoreader_token_client_test.ts` | 7 | HTTP 呼び出し (refresh, exchange, エラーハンドリング) |
| `tests/unit/infra/config_test.ts` | 10 | 設定バリデーション (env 変数、デフォルト、キャッシュ) |
| `tests/security/logger_security_test.ts` | 5 | トークンサニタイズ (既存テスト、import パス更新) |

モック戦略: Port インターフェースのインメモリ実装を各テストファイル内に定義。fetch stub は `@std/testing/mock` の `stub` を使用し `finally` ブロックで必ず restore。

OTel `BatchLogRecordProcessor` がタイマーリークを発生させるため、全 `describe()` ブロックに `{ sanitizeResources: false, sanitizeOps: false }` を指定。

### RetryConfig の統合

旧 `retry.ts` と `types.ts` で `RetryConfig` が 2 つ存在し、フィールド名が不一致だった (`initial_delay` vs `base_delay`)。`domain/types.ts` に `base_delay` で統一し、旧 `retry.ts` の `CircuitBreaker` および `retryBatch` (未使用機能) を削除して簡素化。

## RESULTS, EFFECTS

### PROS

- **コード量の大幅削減**: デッドコード約 2,000 行を削除。`main.ts` を 697 行 → 95 行に削減
- **Clean Architecture 準拠**: プロジェクト標準の `Handler -> Usecase -> Port -> Gateway` パターンを適用。各レイヤーの責務が明確に分離
- **テスト可能性の向上**: Port インターフェースによる DI でモックが容易に。38 テストステップで主要ロジックをカバー
- **セキュリティ強化**: `/api/token` の認証追加、CSRF state 検証 (TTL 5 分)、ファイルパーミッション `0o600`、ログサニタイズの徹底
- **信頼性向上**: `setInterval` → 順次ループで重複実行を排除。graceful shutdown でリソースリークを防止
- **JSR 移行**: `deno.land` URL から JSR レジストリに移行し、依存管理を標準化
- **コンテナ動作確認済み**: リビルド後の Docker Compose 環境で daemon モード正常起動、トークン監視ループ・OAuth サーバーの動作を確認

### CONS, TRADEOFF

- **`retry.ts` の簡素化**: `CircuitBreaker` と `retryBatch` を削除。現状使用箇所がないが、将来的に必要になった場合は再実装が必要
- **OTel タイマーリーク**: `BatchLogRecordProcessor` がバックグラウンドタイマーを作成するため、テストで `sanitizeResources: false` を指定する必要がある。Deno の OTel ネイティブサポート成熟時に再検討
- **`InoreaderTokenClient` の fetch stub**: gateway テストで `globalThis.fetch` を stub しているため、並列テスト実行時にグローバル状態の競合リスクがある。テスト数が増えた場合は `HttpClient` インターフェース経由のモックに切り替えを検討

## APPENDIX

### 変更ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `main.ts` | 697 行 → 95 行 (DI コンテナに書き直し) |
| `deno.json` | JSR imports + tasks セクション追加 |
| `src/domain/types.ts` (新規) | 全ドメイン型を統合 |
| `src/port/*.ts` (新規 x3) | SecretManager, TokenClient, HttpClient インターフェース |
| `src/gateway/*.ts` (新規 x3) | EnvFileSecretManager, InoreaderTokenClient, FetchHttpClient |
| `src/usecase/*.ts` (新規 x4) | RefreshToken, HealthCheck, MonitorToken, Authorize |
| `src/handler/*.ts` (新規 x3) | CLI, OAuthServer, Daemon |
| `src/infra/*.ts` (新規 x4) | Config, Logger, OTel, Retry |
| `tests/unit/usecase/*.ts` (新規 x3) | Usecase テスト |
| `tests/unit/gateway/*.ts` (新規 x2) | Gateway テスト |
| `tests/unit/infra/config_test.ts` (新規) | Config テスト |
| `tests/security/logger_security_test.ts` | import パス更新 |
| `CLAUDE.md` | 新アーキテクチャ図に更新 |
| `src/auth/` (削除) | browser.ts, inoreader.ts, oauth-old.ts, oauth.ts, types.ts |
| `src/file/` (削除) | secret-manager-env-file.ts |
| `src/utils/` (削除) | config.ts, logger.ts, otel.ts, retry.ts |
| `tests/unit/logger_security_test.ts` (削除) | tests/security/ と重複 |

### 検証結果

```
deno test --allow-all         # 11 テストスイート, 38 ステップ全パス, 0 失敗
deno check main.ts            # 型チェック通過
deno lint                     # 26 ファイル, lint クリーン
deno fmt --check              # フォーマットチェック通過
docker compose build           # イメージビルド成功
docker compose up -d           # daemon モード正常起動 (OAuth サーバー + トークン監視ループ)
```
