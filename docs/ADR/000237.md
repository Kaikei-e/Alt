# ADR-000237: Favorites フィード一覧の重複キーによる Svelte reconcile クラッシュ修正

## STATUS

Accepted（実装完了・改訂済み）

## CONTEXT

ADR-000235/000236 で実装した Favorites ページ (`/sv/feeds/favorites`) をブラウザで開くと、以下のランタイムエラーが発生した：

```
TypeError: Cannot read properties of undefined (reading 'prev')
    at reconcile (...)
```

これは ADR-000228/000229 で修正した Svelte 5 `{#each}` reconcile の重複キー問題と同一の原因である。

### 根本原因

`FetchFavoriteFeedsListCursor` のデータフローで `ArticleID` が設定されていなかった。

**データフロー（修正前）:**

```
Driver SQL: SELECT f.id, f.title, f.description, f.link, ...  ← article_id なし
    ↓
Gateway: FeedItem { Link: feed.Link }                          ← ArticleID 未設定
    ↓
convertFeedsToProto: Id = feed.Link                            ← フィードソース URL（重複する）
    ↓
Frontend: {#each feeds as feed (feed.id)}                      ← 重複キーで reconcile 破綻
```

同一フィードソースから複数の記事がお気に入り登録されている場合、全て同じ `Link`（フィードソース URL）が `Id` として使用され、Svelte の keyed each が破綻する。

### 他のエンドポイントとの比較

| エンドポイント | article_id サブクエリ | Gateway で ArticleID 設定 |
|---------------|:--------------------:|:------------------------:|
| `FetchUnreadFeedsListCursor` | あり | あり |
| `FetchAllFeedsListCursor` | あり | あり |
| `FetchFavoriteFeedsListCursor` | **なし → あり（修正済み）** | **なし → あり（修正済み）** |

## DECISION MAKING

### 第1版: Driver/Gateway で ArticleID を追加

既存の `FetchUnreadFeedsListCursor` / `FetchAllFeedsListCursor` と同じパターンを適用。

1. **Driver**: SQL に `article_id` サブクエリを追加
2. **Gateway**: `FeedItem` に `ArticleID` を設定

さらに、`ArticleID` が存在しない場合のフォールバックとして `FeedID`（DB の PK）を `domain.FeedItem` に追加した。

### 第2版（改訂）: FeedID を削除し UUID フォールバックに変更

第1版で追加した `FeedID` フィールドは **DB の PK をドメイン層に漏らす設計違反** であった。

フロントエンド調査の結果、proto の `Id` フィールドは **Svelte `{#each}` のキーイング専用** であり、ビジネスロジック（既読マーク、記事取得、要約など）は全て `feed.link` / `feed.normalizedUrl` を使用していることが判明。

つまり `Id` はプレゼンテーション上の関心事であり、ドメインや gateway に属さない。

**決定**: `convertFeedsToProto`（connect/プレゼンテーション層）で UUID をフォールバック生成する。

- `ArticleID` があればそれを使用
- なければ `uuid.New().String()` で一意な ID を生成

### なぜ UUID か

| 選択肢 | 長所 | 短所 |
|--------|------|------|
| **UUID（採用）** | ドメイン/gateway 変更不要、常に一意 | リクエスト毎に ID 変化 |
| FeedID（DB PK） | 安定した ID | DB 詳細がドメインに漏れる |
| Link+index | 安定 | ページネーション跨ぎで衝突リスク |

UUID の非安定性は問題にならない理由：
- `Id` は Svelte keying 専用（ビジネスロジックは `link` を使用）
- カーソルページネーションで同一アイテムが複数ページに出現しない
- リフレッシュ時は全アイテムが再取得されるため、全キーが変わっても UI 上問題なし

## RESULTS

### 第1版の変更（維持）

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/driver/alt_db/fetch_feed_driver.go` | 両クエリ（cursor あり/なし）の SELECT に `article_id` サブクエリ追加、Scan に `&feed.ArticleID` 追加 |
| `alt-backend/app/gateway/fetch_feed_gateway/feeds_gateway.go` | `FetchFavoriteFeedsListCursor` で `feed.ArticleID` を `FeedItem` に設定 |

### 第2版の変更（改訂）

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/domain/rss_feed.go` | `FeedID` フィールドを削除（ドメインから DB PK を除去） |
| `alt-backend/app/gateway/fetch_feed_gateway/feeds_gateway.go` | 4 つの Cursor メソッドから `FeedID: feed.ID` を削除 |
| `alt-backend/app/connect/v2/feeds/helpers.go` | `convertFeedsToProto` の ID ロジックを UUID フォールバックに変更 |
| `alt-backend/app/connect/v2/feeds/helpers_test.go` | UUID フォールバックの一意性テストに更新 |

### ID 決定ロジック（最終版）

```go
// convertFeedsToProto 内
id := uuid.New().String()
if feed.ArticleID != "" {
    id = feed.ArticleID
}
```

## PROS

1. **クラッシュ解消**: Svelte の `reconcile` での `TypeError` が発生しなくなる
2. **一貫性**: 全フィード一覧エンドポイントで `ArticleID` が設定されるようになった
3. **Clean Architecture 準拠**: DB の PK がドメイン層に漏れなくなった
4. **関心の分離**: ID 生成はプレゼンテーション層（connect handler）の責務

## CONS, TRADEOFF

1. **article_id サブクエリのコスト**: 相関サブクエリが追加されるが、他のエンドポイントで既に使用されており、パフォーマンス上の問題は確認されていない
2. **UUID の非安定性**: リクエスト毎に ID が変わるが、Svelte keying 専用のため問題なし

## APPENDIX

- 関連 ADR: [ADR-000228](./000228.md) — 検索結果の重複 ID による Svelte reconcile クラッシュ修正
- 関連 ADR: [ADR-000235](./000235.md) — SwipeFeedCard にお気に入りボタンを追加
- 関連 ADR: [ADR-000236](./000236.md) — SwipeFeedCard お気に入りボタンをアイコンのみに変更
