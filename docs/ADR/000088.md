# Morning Letter の記事取得上限 100 件制限の撤廃

## ステータス

採択（Accepted）

## コンテキスト

### 背景

Morning Letter 機能は、過去 24 時間以内の記事を取得し、RAG（Retrieval Augmented Generation）を用いてトピック抽出・要約を行う機能である。

従来の実装では、以下の 2 つの制約が存在していた：

1. **時間制約**: 過去 24 時間以内の記事のみ対象
2. **件数制約**: 最大 100 件までの記事を取得

### 問題点

100 件の上限制限は、RAG の特性を十分に活かせていなかった。

RAG のベストプラクティスに関する調査結果：

| ベストプラクティス | 説明 |
|------------------|------|
| Long RAG | より長い取得単位を処理し、文脈を保持する手法 |
| コンテキストの豊かさ | リトリーバル効率とのバランスが重要 |
| セマンティックチャンキング | 意味のある単位でコンテキストを保持 |

100 件制限により、多くの記事がある日に重要なコンテンツが欠落する可能性があった。

## 決定

Morning Letter の記事取得において、100 件の上限制限を撤廃し、過去 24 時間という時間制約のみで記事を取得する。

### 変更内容

#### alt-backend

`fetch_recent_articles_driver.go` において、`limit <= 0` の場合は SQL の `LIMIT` 句を適用しないよう変更：

```go
// 変更前: 常に LIMIT を適用
query := `SELECT ... FROM articles ... LIMIT $2`

// 変更後: limit > 0 の場合のみ LIMIT を適用
if limit <= 0 {
    query := `SELECT ... FROM articles ... ORDER BY published_at DESC`
} else {
    query := `SELECT ... FROM articles ... ORDER BY published_at DESC LIMIT $2`
}
```

#### rag-orchestrator

Morning Letter のユースケースおよびハンドラーで、limit 値を `100` から `0`（無制限）に変更：

| ファイル | 変更箇所 |
|---------|---------|
| `internal/usecase/morning_letter_usecase.go` | L105: `limit: 100` → `limit: 0` |
| `internal/adapter/connect/morning_letter/handler.go` | L77: `limit: 100` → `limit: 0` |

## 結果

### 変更ファイル

| コンポーネント | ファイル | 変更内容 |
|--------------|---------|---------|
| alt-backend | `driver/alt_db/fetch_recent_articles_driver.go` | limit <= 0 時の LIMIT 句省略 |
| alt-backend | `driver/alt_db/fetch_recent_articles_driver_test.go` | テストケースの更新 |
| rag-orchestrator | `internal/usecase/morning_letter_usecase.go` | limit を 0 に変更 |
| rag-orchestrator | `internal/usecase/morning_letter_usecase_test.go` | テストケースの更新 |
| rag-orchestrator | `internal/adapter/connect/morning_letter/handler.go` | limit を 0 に変更 |

### メリット

1. **RAG の性能向上**: 完全なコンテキストセットにより、トピック抽出と要約の精度が向上
2. **情報欠落の防止**: 記事数が多い日でも重要なコンテンツを見逃さない
3. **柔軟性の維持**: 将来的に件数制限が必要になった場合、limit > 0 を設定することで制限を再適用可能

### 考慮事項

| 項目 | 対策 |
|------|------|
| メモリ使用量の増加 | 24 時間制約により実質的な上限が存在。通常運用では問題なし |
| レスポンス時間 | RAG の特性上、より多くのコンテキストでも処理時間への影響は限定的 |
| データベース負荷 | 時間ベースのインデックスにより効率的なクエリを維持 |

### 代替案（検討済み）

| 代替案 | 採用しなかった理由 |
|--------|-------------------|
| 上限を 500 件に拡大 | 任意の上限では同様の問題が残る |
| 動的な上限設定 | 実装の複雑化に対してメリットが少ない |

## 実装日

2026-01-13

## 関連

- [The 2025 Guide to Retrieval-Augmented Generation (RAG)](https://www.edenai.co/post/the-2025-guide-to-retrieval-augmented-generation-rag)
- [Enhancing RAG: A Study of Best Practices](https://arxiv.org/abs/2501.07391)
- ADR 000037: Morning Letter 機能の初期設計
- ADR 000054: RAG Orchestrator の導入
