# ADR 000052: URL正規化のゼロトラスト原則の全面適用

## ADR's STATUS

**承認済み（Accepted）** - 2026年1月3日

## CONTEXT

### 背景

ADR-000049で導入したURL正規化のゼロトラスト原則が、一部のコードパスに適用されていないことが判明した。

### 問題

Swipeモードで記事を既読にしても、リロード後に未読として再表示される問題が発生。

```
ERROR: Feed not found
normalizedURL: https://example.com/2026/01/03/article-title
DB内URL: https://example.com/2026/01/03/article-title/  ← 末尾スラッシュあり
```

### 根本原因分析

**1. 正規化が適用されていないコードパス**

| コードパス | 正規化 | 状態 |
|-----------|--------|------|
| `RegisterFeedsGateway.RegisterFeeds()` | あり | ADR-000049で対応済み |
| `HourlyJobRunner()` | **なし** | 未対応 |
| `pre-processor-sidecar` リポジトリ層 | **なし** | 未対応 |

**2. Go標準ライブラリ `net/url` の挙動**

```go
// url.Parse() は末尾スラッシュを保持する（自動削除しない）
parsed, _ := url.Parse("https://example.com/article/")
fmt.Println(parsed.Path)  // 出力: "/article/" (スラッシュ保持)
```

明示的な `strings.TrimRight(path, "/")` が必要。

**3. 重複発生のメカニズム**

```
時刻T1: RSSフィード取得 → https://example.com/article/ を保存
時刻T2: 同記事を再取得 → https://example.com/article を保存（重複）
```

正規化なしで保存されるため、末尾スラッシュの有無で別レコードとして登録された。

## DECISION

**ゼロトラスト原則をすべてのデータ保存経路に適用する。**

### 変更内容

#### 1. HourlyJobRunner への正規化追加

`job_runner.go`:

```go
// Zero-trust: Normalize URL to remove tracking parameters
normalizedLink, err := utils.NormalizeURL(feedItem.Link)
if err != nil {
    logger.Logger.Warn("Failed to normalize feed link, using original",
        "link", feedItem.Link,
        "error", err)
    normalizedLink = feedItem.Link
}
feedModel := models.Feed{
    Link: normalizedLink,
    // ...
}
```

#### 2. pre-processor-sidecar への正規化追加

`utils/url_normalizer.go` を新規作成し、`subscription_repository.go` の以下メソッドに適用:

- `SaveSubscriptions()`
- `UpdateSubscription()`
- `CreateSubscription()`

```go
normalizedURL, err := utils.NormalizeURL(sub.URL)
if err != nil {
    r.logger.Warn("Failed to normalize feed URL, using original",
        "url", sub.URL,
        "error", err)
    normalizedURL = sub.URL
}
```

#### 3. 既存データの正規化（ワンショットスクリプト実行）

```bash
go run scripts/normalize_feed_urls.go
```

## RESULTS

### 重複発生パターンの内訳

| パターン | 説明 | 例 |
|---------|------|-----|
| 末尾スラッシュ | スラッシュの有無 | `/article/` vs `/article` |
| UTMパラメータ | トラッキングパラメータの有無 | `?utm_source=rss` |
| クエリ順序 | パラメータ順序の違い | `?a=1&b=2` vs `?b=2&a=1` |

### テスト結果

```
=== RUN   TestFeedModelURLNormalization
    --- PASS: trailing_slash_should_be_removed
    --- PASS: URL_without_trailing_slash_should_remain_unchanged
    --- PASS: UTM_parameters_should_be_removed
    --- PASS: root_path_should_keep_trailing_slash
=== RUN   TestNormalizeURL (pre-processor-sidecar)
    --- PASS: (9 sub-tests)
PASS
```

### PROS

1. **データ整合性の向上**: 同一記事の重複登録を防止
2. **検索効率の改善**: 正規化済みURLによる完全一致検索が可能
3. **ストレージ効率**: 重複データの削除により約3%のレコード削減

### CONS, TRADEOFF

1. **処理オーバーヘッド**: 保存時にURL正規化処理が追加される（μs単位で影響は軽微）
2. **ワンショット実行が必要**: 既存データには手動でスクリプト実行が必要

## 変更ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `alt-backend/app/job/job_runner.go` | `NormalizeURL()` 呼び出し追加 |
| `alt-backend/app/job/job_runner_test.go` | URL正規化テスト追加（新規） |
| `pre-processor-sidecar/app/utils/url_normalizer.go` | URL正規化関数（新規） |
| `pre-processor-sidecar/app/utils/url_normalizer_test.go` | テスト（新規） |
| `pre-processor-sidecar/app/repository/subscription_repository.go` | 3メソッドに正規化追加 |

## APPENDIX

### URL正規化ルール

```go
var trackingParams = map[string]bool{
    "utm_source":   true,
    "utm_medium":   true,
    "utm_campaign": true,
    "utm_term":     true,
    "utm_content":  true,
    "utm_id":       true,
    "fbclid":       true,
    "gclid":        true,
    "mc_eid":       true,
    "msclkid":      true,
}
```

### 関連ADR

- ADR-000049: MarkAsRead API 404エラー修正 - URL正規化のゼロトラスト実装

### 教訓

1. **ゼロトラスト原則は全経路に適用すべき**: 一部の経路だけ対応すると不整合が発生する
2. **Go `net/url` は末尾スラッシュを保持**: 明示的な削除処理が必要
3. **正規化は保存時に行う**: 参照時の正規化だけでは不十分
