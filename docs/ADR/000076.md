# tag-generator バッチ処理における skipped_articles の扱い修正

## ステータス

採択（Accepted）

## コンテキスト

tag-generator のバッチ処理で以下のエラーが継続的に発生していた：

```
Cycle 24 failed: None. Failed: 0/7 articles. Retrying in 60 seconds...
```

### 症状

- バッチ処理が常に失敗として報告される
- `Failed: 0/7 articles` - 失敗は 0 件なのにサイクル全体が失敗扱い
- 60秒ごとにリトライが繰り返される

### 原因調査

コードパスを追跡した結果、以下の問題が判明：

1. `feed_id` が NULL の記事は `skipped_articles` として処理される
2. `skipped_articles` が `failed_articles` としてカウントされていた
3. 成功判定条件 `successful > 0 or total_processed == 0` で、全記事がスキップされた場合に `success = False` となる

### 処理フロー（修正前）

```
batch_processor.process_article_batch()
  → tag_inserter.batch_upsert_tags_no_commit()
    → feed_id が NULL の記事を skipped_articles に追加
    → skipped_articles を failed_articles にカウント
  → processed_articles = 0, failed_articles = 7
  → success = False（7件全てスキップ）
```

## 決定

### 設計方針

「スキップ」と「失敗」は異なる概念として扱う：

- **スキップ**: 処理対象外（feed_id 欠損など）- 正常系
- **失敗**: 処理を試みたがエラー発生 - 異常系

スキップされた記事があっても、実際の失敗がなければバッチは成功とする。

### 修正内容

#### 1. upsert_tags.py の修正

**変更箇所**: `batch_upsert_tags()` および `batch_upsert_tags_no_commit()`

```python
# 修正前
if skipped_articles:
    results["failed_articles"] += len(skipped_articles)
    logger.warning(...)

# 修正後
if skipped_articles:
    # skipped_articles は failed としてカウントしない
    logger.info(
        "Skipped articles due to missing feed_id",
        count=len(skipped_articles),
    )

# 全記事スキップ時の早期リターンを追加
if not feed_tag_groups:
    return {
        "success": True,
        "processed_articles": 0,
        "failed_articles": 0,
        "message": "All articles skipped due to missing feed_id",
    }
```

#### 2. service.py の成功判定修正

```python
# 修正前
batch_stats["success"] = (
    processing_stats.get("successful", 0) > 0
    or processing_stats.get("total_processed", 0) == 0
)

# 修正後
batch_stats["success"] = (
    processing_stats.get("successful", 0) > 0
    or processing_stats.get("total_processed", 0) == 0
    or processing_stats.get("failed", 0) == 0  # 追加
)
```

## 結果

### 変更されたファイル

| ファイル | 変更内容 |
|---------|---------|
| `tag-generator/app/tag_inserter/upsert_tags.py` | skipped_articles を failed としてカウントしないよう修正 |
| `tag-generator/app/tag_generator/service.py` | 成功判定条件に `failed == 0` を追加 |
| `tag-generator/app/tests/unit/test_batch_upsert_skipped_articles.py` | 新規テスト追加 |

### 修正後の動作

```
Cycle 1 completed successfully. Processed: 7, Successful: 5, Failed: 0
```

- スキップされた記事があってもサイクルは成功として完了
- 実際に失敗した記事のみが `Failed` としてカウントされる

### テストケース

| テスト | 検証内容 |
|-------|---------|
| `test_empty_article_list_returns_success` | 空リストで success = True |
| `test_no_valid_tags_returns_success` | タグなしで success = True |
| `test_skipped_articles_logged_as_info_not_warning` | スキップは INFO レベルでログ |
| `test_skipped_articles_not_added_to_failed_count` | スキップは failed にカウントされない |

## 学んだこと

1. **スキップと失敗の区別**: 処理対象外（スキップ）と処理失敗は別概念として扱うべき
2. **成功条件の設計**: 「何もしなかった」と「失敗した」は異なる結果
3. **ログレベルの適切な使用**: 期待される動作（スキップ）は INFO、問題発生時は WARNING/ERROR

## 実装日

2026-01-10

## 関連

- `tag-generator/app/CLAUDE.md` - TDD ワークフロー
- `docs/tag-generator.md` - サービス詳細仕様
