# rask-log-aggregator Clean Architecture リファクタリング + バッチバッファリング

## ADR's STATUS

Accepted (Phase 1, 2, 3-1, 4-1, 4-2 実装完了)

## CONTEXT

### 問題点

rask-log-aggregator は Rust 2024 Edition / Axum 0.8 / ClickHouse の高性能ログ集約サービス（約 4,000 行、60+ テスト）。15 台の rask-log-forwarder からのレガシー NDJSON と、OTel SDK からの OTLP HTTP/protobuf の 2 系統を受信し、ClickHouse に永続化する。

| # | 分類 | 問題 |
|---|------|------|
| 1 | 責務集中 | `main.rs` に 240 行 (サーバー設定、ハンドラー、トレーシング、シャットダウン) が混在 |
| 2 | 巨大ファイル | `clickhouse_exporter.rs` が 906 行 (Row 型、変換ロジック、エクスポート) |
| 3 | テスト不正確 | `handler_test.rs` が実ハンドラーのコピー（異なる振る舞い）をテスト |
| 4 | 層分離なし | Port (trait) と Adapter (実装) が `log_exporter/` に同居 |
| 5 | バッチ最適化余地 | 各リクエストが即座に ClickHouse inserter を生成・実行 |
| 6 | テストカバレッジ | property-based テスト、ベンチマークなし |

## DECISION MAKING

### Phase 1: テスト安全ネット構築

リファクタリング前にテストを強化し、回帰を即座に検出する体制を整備。

- **共有モック `test_support.rs`**: `LogExporter` + `OTelExporter` の両方を実装する統合 `MockExporter` を `#[cfg(test)]` で作成
- **ゴールデンテスト**: `LogRow`, `OTelLogRow`, `OTelTraceRow` の全フィールドをピン留めするゴールデンテストを追加
- **`otlp` モジュール公開**: `lib.rs` から `pub mod otlp` を公開して統合テストからインポート可能に

### Phase 2: Clean Architecture リファクタリング

6 ステップで段階的に層分離を実施。各ステップ後に全テスト通過を確認。

#### 2-1: handler モジュール抽出 (main.rs → handler/)

`aggregate_handler` と `health_handler` を `main.rs` から `src/handler/` に分離。`handler_test.rs` のハンドラーコピーを削除し、実ハンドラーを import。

#### 2-2: port モジュール作成 (trait 分離)

`LogExporter` trait と `OTelExporter` trait を `src/port/` に移動。`async fn` in traits は dyn-dispatch (`Arc<dyn Trait>`) が必要なため `Pin<Box<dyn Future>>` パターンを維持。

#### 2-3: clickhouse_exporter.rs 4 分割

906 行の単一ファイルを 5 ファイルに分割:

| ファイル | 責務 | 行数 |
|----------|------|------|
| `adapter/clickhouse/mod.rs` | re-exports | ~10 行 |
| `adapter/clickhouse/exporter.rs` | ClickHouseExporter + trait impl | ~120 行 |
| `adapter/clickhouse/row.rs` | LogRow + From<EnrichedLogEntry> | ~100 行 |
| `adapter/clickhouse/otel_row.rs` | OTelLogRow, OTelTraceRow + From impl | ~180 行 |
| `adapter/clickhouse/convert.rs` | string_to_fixed_bytes, hashmap_to_vec | ~30 行 |

#### 2-4: json_file + disk_cleaner を adapter/ 配下に移動

`json_file_exporter.rs` と `disk_cleaner.rs` を `src/adapter/json_file/` に移動。旧モジュールは re-export facade として維持。

#### 2-5: app モジュール作成 (main.rs 簡素化)

`main.rs` を 6 行に簡素化し、`src/app/` に起動ロジックを分離:

```rust
#[tokio::main]
async fn main() -> Result<(), rask::error::AggregatorError> {
    rask::app::run().await
}
```

app モジュール構成: `mod.rs` (run 関数), `state.rs` (AppState), `router.rs` (ルーター構築), `server.rs` (デュアルサーバー + graceful shutdown), `tracing.rs` (subscriber 初期化)

#### 2-6: domain/ サブモジュール分割 + clippy 全修正

`domain/mod.rs` からデータ型を `enriched_log.rs`, `otel.rs` に分離。`lib.rs` 経由で露出した `otlp/converter.rs` の clippy pedantic 警告 12 件を修正 (`#[must_use]`, `implicit_hasher`, `uninlined_format_args`, `cast_possible_truncation`, `cast_sign_loss`, `cast_possible_wrap`, `map_unwrap_or`, `ref_option`)。

### Phase 3-1: チャネルベースバッチバッファリング

各 HTTP リクエストが即座に ClickHouse inserter を生成する方式から、`tokio::sync::mpsc` チャネル経由のバッチ集約方式に変更:

```
HTTP Handler → mpsc::Sender<Vec<Row>> → BatchWriter task → ClickHouse Inserter
```

- **バウンデッドチャネル** (容量 1024) でバックプレッシャー実現
- **3 系統独立チャネル**: logs, otel_logs, otel_traces
- **定期フラッシュ**: 5 秒間隔 + MAX_BATCH_SIZE (5000 行) でのしきい値フラッシュ
- **graceful shutdown**: `CancellationToken` で BatchWriter とサーバーの停止を協調
- **チャネルクローズ時のエラーハンドリング**: `AggregatorError::Export` で伝播

### Phase 4-1: proptest 導入

`proptest` クレートによる property-based テストを 3 モジュールに追加:

| 対象 | プロパティ |
|------|----------|
| `encode_trace_id` | 任意バイト列 → 常に 32 文字の hex 文字列 |
| `encode_span_id` | 任意バイト列 → 常に 16 文字の hex 文字列 |
| `encode_trace_id` (16 bytes) | 正確な 16 バイトでラウンドトリップ |
| `encode_span_id` (8 bytes) | 正確な 8 バイトでラウンドトリップ |
| `string_to_fixed_bytes` | 出力長は常に N, 入力プレフィックスが保持, 残りはゼロパディング |
| `hashmap_to_vec` | 全エントリが保持される |
| `SpanKind::from(i32)` | 任意 i32 でパニックしない, 範囲外は Unspecified |
| `StatusCode::from(i32)` | 任意 i32 でパニックしない, 範囲外は Unset |

### Phase 4-2: criterion ベンチマーク導入

`criterion` クレートによるベンチマークを追加:

| ベンチマーク | バッチサイズ |
|-------------|------------|
| OTLP log pipeline (convert) | 10, 100, 1000 |
| OTLP log pipeline (convert + row) | 10, 100, 1000 |
| OTLP trace pipeline (convert) | 10, 100, 1000 |
| OTLP trace pipeline (convert + row) | 10, 100, 1000 |
| NDJSON pipeline (enriched_to_row) | 10, 100, 1000 |
| string_to_fixed_bytes (trace_id, span_id, empty) | - |

## RESULTS, EFFECTS

### 最終ディレクトリ構造

```
src/
├── main.rs              (~6 行) エントリポイントのみ
├── lib.rs               (~25 行) パブリック API
├── error.rs             (変更なし)
├── config.rs            (変更なし)
├── healthcheck.rs       (変更なし)
├── test_support.rs      (新規, #[cfg(test)])
├── domain/
│   ├── mod.rs
│   ├── enriched_log.rs
│   └── otel.rs
├── port/
│   ├── mod.rs
│   ├── log_exporter.rs
│   └── otel_exporter.rs
├── adapter/
│   ├── mod.rs
│   ├── clickhouse/
│   │   ├── mod.rs
│   │   ├── batch_writer.rs  ← Phase 3-1
│   │   ├── exporter.rs
│   │   ├── row.rs
│   │   ├── otel_row.rs
│   │   └── convert.rs
│   └── json_file/
│       ├── mod.rs
│       ├── exporter.rs
│       └── disk_cleaner.rs
├── handler/
│   ├── mod.rs
│   ├── aggregate.rs
│   └── health.rs
├── otlp/
│   ├── mod.rs
│   ├── receiver.rs
│   └── converter.rs
├── app/
│   ├── mod.rs
│   ├── state.rs
│   ├── router.rs
│   ├── server.rs
│   └── tracing.rs
└── log_exporter/         (後方互換 re-export facade)
    ├── mod.rs
    └── clickhouse_exporter.rs
```

**Clean Architecture レイヤーマッピング**:
```
domain (純粋データ型) ← port (trait) ← adapter (実装)
                                     ← handler (HTTP)
                                     ← otlp (プロトコル)
                                     ← app (配線・起動)
```

### テスト結果

| チェック | 結果 |
|---------|------|
| `cargo test` | PASS (113 テスト, 0 失敗) |
| `cargo clippy -- -D warnings` | PASS (0 warnings) |
| `cargo fmt --check` | PASS |
| `cargo bench --no-run` | PASS (コンパイル成功) |

テスト内訳:
- lib テスト: 98 (うち proptest 12, batch_writer 9)
- 統合テスト: 15 (clickhouse_exporter 5, handler 5, healthcheck 3, logging 2)

### 動作確認

- Docker ビルド: `docker compose build rask-log-aggregator` → 成功
- コンテナ起動: `docker compose up -d rask-log-aggregator` → 成功
- ヘルスチェック: `curl http://localhost:9600/v1/health` → `Healthy`
- BatchWriter 動作: ログで `Flushed batch to ClickHouse` (logs/otel_logs/otel_traces 3 系統) を確認
- OTLP 受信: forwarder からの NDJSON + OTel SDK からの protobuf の両系統でデータ受信・バッチフラッシュ確認

### PROS

1. **責務分離**: `main.rs` を 240 行 → 6 行に削減。各モジュールが単一責務を持つ
2. **Clean Architecture 準拠**: domain ← port ← adapter の依存方向を強制。ビジネスロジックが外部実装に依存しない
3. **テスト品質向上**: ゴールデンテスト + property-based テスト + ベンチマーク基盤。テスト数 60+ → 113
4. **バッチバッファリング**: チャネル経由の非同期バッチ集約により、ClickHouse への書き込み回数を削減。バックプレッシャー機構あり
5. **後方互換性**: `log_exporter/` モジュールを re-export facade として維持。既存 import パスの大半が継続動作
6. **clippy pedantic クリーン**: `#![warn(clippy::pedantic)]` で 0 warnings を維持

### CONS, TRADEOFF

1. **ファイル数増加**: 35 ファイル (リファクタリング前は約 15 ファイル)。ナビゲーションコストは増加するが、各ファイルの責務が明確
2. **re-export facade の残存**: `log_exporter/` がシンラッパーとして残る。将来的に外部依存が解消されれば削除可能
3. **BatchWriter の統合テスト不足**: チャネル動作のユニットテストは完備するが、実 ClickHouse への end-to-end テストは testcontainers 導入待ち
4. **`ClickHouseExporter` が未使用化**: BatchWriter 導入により `exporter.rs` の直接利用パスは app 層からなくなったが、trait impl は統合テスト・将来のフォールバック用に維持

## APPENDIX

### 依存追加

```toml
[dev-dependencies]
proptest = "1.6"
criterion = { version = "0.5", features = ["html_reports"] }
```

### 関連 ADR

- ADR-000192: recap-worker Rust 2024 モダナイゼーション (同一プロジェクト内の Rust サービスにおける段階的改善)
