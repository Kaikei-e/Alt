# alt-frontend-sv 認証フック無限リダイレクトループの修正：パブリックルート処理とURL二重エンコーディング問題

## ステータス

採択（Accepted） - 2025年12月28日

## コンテキスト

2025年12月28日、alt-frontend-svの`/sv/login`ページにおいて、無限リダイレクトループが発生していることが判明した。HARファイル分析とコンテナログ調査により、303リダイレクトが無限に連鎖し、`return_to`パラメータが指数的に増加する深刻な問題が発見された。

### 問題の発見

HARファイルの解析により、以下の問題が判明：

1. **無限リダイレクトループ**
   - `/sv/login` へのアクセスで303リダイレクトが連鎖
   - パターン: `/sv/login?return_to=/sv/login?return_to=/sv/login...`
   - ブラウザが最終的にリダイレクト上限に達してエラー

2. **return_toパラメータの異常増加**
   ```
   リクエスト1: /sv/login?return_to=%2Fsv%2Flogin
   リクエスト2: /sv/login?return_to=%252Fsv%252Flogin
   リクエスト3: /sv/login?return_to=%25252Fsv%25252Flogin
   ...（無限に続く）
   ```

3. **ログに現れる症状**
   ```
   alt-frontend-sv-1  |   errorMessage: "Request failed with status code 401"
   alt-frontend-sv-1  |   errorStatus: 401
   alt-frontend-sv-1  |   pathname: "/sv/login"
   ```

### 技術的背景

#### 根本原因1: パブリックルートでのリダイレクト

**ファイル:** `alt-frontend-sv/src/hooks.server.ts` (175-181行目)

```typescript
// 問題のあったコード
} catch (error) {
    // ...
    // isPublicチェックなしで常にリダイレクト！
    let returnTo: string;
    if (pathname === "/sv" || pathname === "/sv/") {
        returnTo = encodeURIComponent(`${url.origin}/sv/home`);
    } else {
        returnTo = encodeURIComponent(`${pathname}${url.search}`);
    }
    throw redirect(303, `/sv/login?return_to=${returnTo}`);
}
```

**問題点:**
- `/sv/login`は`PUBLIC_ROUTES`（12行目）に定義済み
- しかしセッション検証失敗時に`isPublic`チェックなしでリダイレクト
- 結果: `/sv/login` → `/sv/login?return_to=...` → 無限ループ

#### 根本原因2: URL二重エンコーディング

**ファイル:** `alt-frontend-sv/src/hooks.server.ts` (179行目)

```typescript
// 問題のあったコード
returnTo = encodeURIComponent(`${pathname}${url.search}`);
```

**問題点:**
- `url.search`には既にエンコード済みの`return_to`パラメータが含まれる
  - 例: `?return_to=%2Fsv%2Fhome`
- これを再度`encodeURIComponent`でエンコード
  - `%2Fsv%2Fhome` → `%252Fsv%252Fhome`
- 毎回のリダイレクトでエンコードが重複
  - `%2F` → `%252F` → `%25252F` → `%2525252F` ...

#### サニタイゼーションの失敗

**ファイル:** `alt-frontend-sv/src/routes/auth/login/+page.server.ts` (98-105行目)

```typescript
// サニタイゼーション試行（機能せず）
if (
    cleanUrl.includes("/sv/auth/login") ||
    cleanUrl.includes("/sv/login") ||
    cleanUrl.endsWith("/sv/") ||
    cleanUrl === `${url.origin}/sv`
) {
    cleanUrl = `${url.origin}/sv/home`;
}
```

**問題点:**
- 文字列リテラル検索で`"/sv/login"`を探す
- しかし`return_to`が複数回エンコードされると`%252Fsv%252Flogin`になる
- リテラル検索では検出不可能
- サニタイゼーションをすり抜けてループ継続

### リダイレクトループのフロー

```
1. ユーザーが /sv/login にアクセス
   ↓
2. hooks.server.ts でセッション検証失敗（ログインページなので当然）
   ↓
3. isPublic チェックなしで redirect(303, '/sv/login?return_to=/sv/login')
   ↓
4. ブラウザが /sv/login?return_to=/sv/login にアクセス
   ↓
5. hooks.server.ts が pathname=/sv/login, search=?return_to=/sv/login を取得
   ↓
6. encodeURIComponent(`/sv/login?return_to=/sv/login`)
   → /sv/login?return_to=%252Fsv%252Flogin%253Freturn_to%253D%252Fsv%252Flogin
   ↓
7. redirect(303, '/sv/login?return_to=...')
   ↓
8. 無限ループ
```

## 決定事項

以下の2つの修正を`alt-frontend-sv/src/hooks.server.ts`に適用：

### 修正1: パブリックルートのリダイレクト防止

**変更箇所:** 175-183行目（新規追加）

```typescript
// パブリックルートはリダイレクトせずにそのまま処理
// これにより、/sv/loginなどのパブリックページへの無限リダイレクトループを防ぐ
if (isPublic) {
    return resolveEvent(event, {
        filterSerializedResponseHeaders: (name) => {
            return name === "content-type";
        },
    });
}
```

**理由:**
- `/sv/login`、`/sv/auth/login`などのパブリックページはセッション不要
- セッション検証失敗は正常な動作
- リダイレクトせずにページレンダリングを継続すべき

### 修正2: URL二重エンコーディングの防止

**変更箇所:** 189-191行目（変更）

```typescript
// 変更前:
returnTo = encodeURIComponent(`${pathname}${url.search}`);

// 変更後:
// パス名のみエンコード（クエリパラメータは含めない）
// これにより、すでにエンコード済みのreturn_toパラメータの二重エンコードを防ぐ
returnTo = encodeURIComponent(pathname);
```

**理由:**
- ログインリダイレクト時に元のクエリパラメータを保持する必要性は低い
- パス名のみ保持すれば十分（例: `/sv/home`）
- 二重エンコーディングを完全に回避

## 結果・効果

### 改善点（PROS）

1. **無限リダイレクトループの完全解決**
   - `/sv/login`へ直接アクセスしてもループしない
   - ログインページが正常に表示される

2. **パフォーマンス向上**
   - 不要なリダイレクト連鎖が発生しない
   - サーバー負荷の削減
   - ブラウザのレンダリング遅延解消

3. **セキュリティ向上**
   - リダイレクト攻撃のリスク低減
   - URLパラメータの異常増加を防止

4. **コードの明確化**
   - `isPublic`チェックの明示的な使用
   - パブリックルートの扱いが一貫性を持つ

5. **デバッグ容易性**
   - `return_to`パラメータがシンプルに保たれる
   - ログ解析が容易

### トレードオフ（CONS, TRADEOFF）

1. **クエリパラメータの喪失**
   - 元のページのクエリパラメータ（`?foo=bar`など）は保持されない
   - ログイン後のリダイレクト先はパス名のみ
   - **影響度:** 低
     - Altの現在の実装ではログイン前のクエリパラメータを保持する必要性は低い
     - 主要なユースケース（`/sv/home`、`/sv/mobile/feeds`など）はパスのみで機能する

2. **既存の動作変更**
   - 以前は`/sv/page?param=value`が`/sv/page?param=value`にリダイレクト
   - 修正後は`/sv/page`のみにリダイレクト
   - **影響度:** 低
     - 既存のテストケースで問題なし
     - ユーザー体験に影響なし

3. **パブリックルートの早期リターン**
   - パブリックルートはセッション検証エラー時に早期リターン
   - 他のエラーハンドリングをバイパス
   - **影響度:** なし
     - パブリックルートは本来セッション不要
     - 正しい動作

## 検証

### テストケース

1. ✅ `/sv/login`への直接アクセス
   - 期待: ログインページが表示される
   - 結果: リダイレクトループなしで正常表示

2. ✅ 認証が必要なページへのアクセス（未ログイン）
   - 期待: `/sv/login?return_to=%2Fsv%2Fhome`にリダイレクト
   - 結果: 正常にリダイレクト、ログイン後に元のページへ

3. ✅ パブリックページ（`/sv/auth/login`、`/sv/register`など）
   - 期待: リダイレクトせずに表示
   - 結果: 正常表示

4. ✅ APIエンドポイント（`/sv/api/*`）
   - 期待: 401 JSONエラーを返す（リダイレクトしない）
   - 結果: 既存動作維持

## 関連ファイル

### 変更ファイル
- `alt-frontend-sv/src/hooks.server.ts`
  - 175-183行目: パブリックルートチェック追加
  - 189-191行目: URL二重エンコーディング修正

### 関連ファイル（変更なし）
- `alt-frontend-sv/src/routes/auth/login/+page.server.ts`
  - サニタイゼーションロジック（98-105行目）
  - 今回の修正により、二重エンコード問題が根本解決されたため変更不要

- `alt-frontend/src/middleware.ts`
  - Next.js側の認証ミドルウェア
  - SvelteKit側の修正で問題解決のため変更不要

## 今後の推奨事項

1. **E2Eテストの追加**
   - 無限リダイレクトループの回帰テスト
   - Playwright等でリダイレクト連鎖を検証

2. **モニタリング強化**
   - リダイレクト回数の監視
   - 異常なURL長の検出アラート

3. **ログインフローの統一**
   - Next.js（`alt-frontend`）とSvelteKit（`alt-frontend-sv`）のログイン処理の一貫性確認
   - 両者のリダイレクトロジックの統一を検討

4. **URL長の制限**
   - サーバーサイドで異常に長い`return_to`パラメータを拒否
   - セキュリティ対策の強化

## 付録

### HARファイル分析結果

```
Total entries: 14
URL frequency (top 20):
```

すべて同一URLへの303リダイレクトで、`return_to`パラメータのみが増加していた。

### コンテナログ抜粋

```
alt-frontend-sv-1  |   pathname: "/sv/login"
alt-frontend-sv-1  |   errorType: "AxiosError"
alt-frontend-sv-1  |   errorMessage: "Request failed with status code 401"
alt-frontend-sv-1  |   errorStatus: 401
```

セッション検証が繰り返し失敗し、毎回リダイレクトが発生していた。

### 参考リンク

- SvelteKit Hooks Documentation: https://kit.svelte.dev/docs/hooks
- URL encoding issues: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent
- Redirect loop prevention best practices: https://web.dev/redirect-loops/
