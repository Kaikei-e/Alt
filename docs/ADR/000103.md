# ジャンル分類器の多言語対応と閾値最適化

## ADR'S STATUS

Accepted

## CONTEXT

### 背景

7days Recap のジャンル分類において、日本語と英語で異なる精度特性が観測された。日本語モデルは高 Precision（86.9%）だが低 Recall（32.3%）であり、英語モデルは事実上機能していなかった（F1 = 0.001）。

### 問題

1. **言語別モデル管理の欠如**: 単一のモデルパスで日英両方を処理しようとしていた
2. **保守的すぎる閾値**: 一律 0.6 の閾値により、多くの記事が分類されずに漏れていた
3. **フォールバック動作の不透明性**: 閾値未満の場合に `other` を返していたが、下流処理で判別不能
4. **英語モデル破損**: 全てが `software_dev` に分類される異常動作

### 実装前の状態

| 指標 | 日本語 | 英語 |
|------|--------|------|
| Macro F1 | 0.419 | 0.001 |
| Macro Recall | 0.323 | N/A |
| Accuracy | 0.302 | N/A |

## DECISION MAKING

### 決定

#### 1. 言語別モデルパスの導入

設定に日本語/英語それぞれのモデルパスと閾値ファイルを追加。

```python
# config.py
genre_classifier_model_path_ja: str = Field(
    "data/genre_classifier_ja.joblib",
    description="Path to the trained Japanese genre classifier model",
)
genre_classifier_model_path_en: str = Field(
    "data/genre_classifier_en.joblib",
    description="Path to the trained English genre classifier model",
)
genre_thresholds_path_ja: str = Field(
    "data/genre_thresholds_ja.json",
    description="Path to the Japanese genre thresholds file",
)
genre_thresholds_path_en: str = Field(
    "data/genre_thresholds_en.json",
    description="Path to the English genre thresholds file",
)
```

**設計判断**:
- 環境変数で切り替え可能（`RECAP_GENRE_CLASSIFIER_MODEL_PATH_JA` 等）
- 後方互換性のため `genre_classifier_model_path` も維持（deprecated）

#### 2. フォールバック動作の改善

閾値未満でも最高スコアのジャンルを返却し、`below_threshold` フラグで判別可能に。

```python
# classifier.py
if candidates:
    top_genre = candidates[0]["genre"]
    below_threshold = False
else:
    # Improved fallback: Use highest scoring genre
    idx = int(np.argmax(probs))
    top_genre = classes[idx]
    below_threshold = True

results.append({
    "top_genre": top_genre,
    "confidence": confidence,
    "scores": scores,
    "candidates": final_candidates,
    "below_threshold": below_threshold,  # New flag
})
```

**メリット**:
- 下流処理で閾値未満の結果を明示的に処理可能
- Recall 向上（以前は `other` に落ちていた記事も分類される）
- デバッグ・分析が容易

#### 3. Bayesian 最適化のデフォルト有効化

HDBSCAN パラメータ調整に Optuna TPE サンプラーを使用。

```python
# config.py
use_bayes_opt: bool = Field(
    True,  # Changed from False
    description="Use Optuna (TPE sampler) for Bayesian hyperparameter optimization",
)
```

**選定理由**:
- グリッドサーチより効率的な探索（特に高次元パラメータ空間）
- 複合目標関数: `0.6 × silhouette + 0.4 × DBCV`

#### 4. 評価サービスの言語フィルタリング厳格化

言語フィルタリング時に、該当言語のコンテンツが実際に存在するかを検証。

```python
# evaluation.py
if language == "ja":
    content = item.get("content_ja")
    if content and isinstance(content, str) and content.strip():
        filtered_items.append(item)
```

**理由**:
- 空文字列や None が混入していると評価精度が低下
- `lang` フィールドのみでの判定は不十分

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 種別 | 内容 |
|----------|------|------|
| `recap-subworker/recap_subworker/services/classifier.py` | 修正 | フォールバック改善、`below_threshold` 追加 |
| `recap-subworker/recap_subworker/infra/config.py` | 修正 | 言語別モデルパス、Bayes 最適化デフォルト有効化 |
| `recap-subworker/recap_subworker/services/evaluation.py` | 修正 | 言語フィルタリング厳格化 |

### 効果

- 日本語/英語モデルの独立管理
- Recall 向上（閾値未満の記事も最適ジャンルに分類）
- 下流処理での明示的なハンドリング
- HDBSCAN パラメータ探索の効率化

### PROS

1. **後方互換性**: 既存の設定は deprecated として維持
2. **透明性**: `below_threshold` フラグにより判定根拠が明確
3. **柔軟性**: 環境変数でモデルパスを切り替え可能
4. **効率性**: Bayesian 最適化で探索時間削減

### CONS, TRADEOFF

1. **設定項目増加**: 4 つの新規設定パラメータ
2. **下流変更必要**: `below_threshold` を考慮した処理の追加が必要な場合あり
3. **Optuna 依存**: Bayesian 最適化には Optuna が必要

## APPENDIX

### 参考資料

- [HDBSCAN Parameter Selection](https://hdbscan.readthedocs.io/en/latest/parameter_selection.html)
- [Optuna TPE Sampler](https://optuna.readthedocs.io/en/stable/reference/samplers/generated/optuna.samplers.TPESampler.html)
- [Precision-Recall Tradeoff](https://scikit-learn.org/stable/auto_examples/model_selection/plot_precision_recall.html)
