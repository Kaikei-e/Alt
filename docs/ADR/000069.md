# Rask Stack を Rust 2024 Edition ベストプラクティスに移行

## ステータス

採択（Accepted）

## コンテキスト

rask-log-forwarder と rask-log-aggregator は Rust 2024 Edition を宣言しているが、以下の技術的負債が存在していた：

### rask-log-aggregator の課題

1. **`async_trait` クレートへの依存**: Rust 2024 では native async traits が利用可能
2. **エラーハンドリング不備**: `main.rs` で `.unwrap()` / `.expect()` を多用
3. **同期ファイル I/O**: `JsonFileExporter` が `std::fs` を async コンテキストで使用
4. **ドメイン型の重複**: `EnrichedLogEntry` が複数ファイルで定義
5. **テスト不足**: ハンドラーテストが存在しない

### rask-log-forwarder の課題

1. **未使用依存関係**: `lazy_static`（`OnceLock` 使用済み）、`async-trait`
2. **`async_trait` の部分的使用**: `ServiceDiscoveryTrait` で使用

## 決定

### 1. async_trait → Boxed Futures への移行

dyn 互換性を維持するため、native async traits ではなく boxed futures パターンを採用：

```rust
// Before
#[async_trait]
pub trait LogExporter: Send + Sync {
    async fn export_batch(&self, logs: Vec<EnrichedLogEntry>) -> Result<(), anyhow::Error>;
}

// After
pub trait LogExporter: Send + Sync {
    fn export_batch(
        &self,
        logs: Vec<EnrichedLogEntry>,
    ) -> Pin<Box<dyn Future<Output = Result<(), anyhow::Error>> + Send + '_>>;
}
```

**理由**: `Arc<dyn LogExporter>` として使用するため、`impl Future` は dyn 互換でない。

### 2. エラーハンドリングの改善

`thiserror` を使用したカスタムエラー型を導入：

```rust
#[derive(Error, Debug)]
pub enum AggregatorError {
    #[error("Failed to load configuration: {0}")]
    Config(String),

    #[error("Failed to bind to address {address}: {source}")]
    Bind { address: String, source: std::io::Error },

    #[error("Server error: {0}")]
    Server(#[from] std::io::Error),
}
```

### 3. JsonFileExporter の非同期化

```rust
// Before
use std::fs::{File, OpenOptions};
use std::sync::Mutex;

// After
use tokio::fs::{File, OpenOptions};
use tokio::sync::Mutex;
```

### 4. 依存関係の整理

| サービス | 削除 | 追加 |
|---------|------|------|
| rask-log-aggregator | `async-trait`, `config` | `thiserror`, `axum-test`, `tempfile` |
| rask-log-forwarder | `lazy_static`, `async-trait` | - |

## 結果

### 変更されたファイル

#### rask-log-aggregator

| ファイル | 変更内容 |
|---------|---------|
| `src/error.rs` | 新規作成（カスタムエラー型） |
| `src/main.rs` | Result ベースのエラーハンドリング |
| `src/lib.rs` | `error` モジュール追加、lint 設定 |
| `src/log_exporter/mod.rs` | boxed futures パターン |
| `src/log_exporter/clickhouse_exporter.rs` | `async_trait` 削除 |
| `src/log_exporter/json_file_exporter.rs` | 非同期化、ドメイン型重複解消 |
| `Cargo.toml` | 依存関係整理 |
| `tests/handler_test.rs` | 新規作成（5 テスト） |

#### rask-log-forwarder

| ファイル | 変更内容 |
|---------|---------|
| `src/collector/discovery.rs` | boxed futures パターン |
| `tests/collector/test_service_discovery.rs` | `async_trait` 削除 |
| `Cargo.toml` | 未使用依存関係削除 |

### メリット

1. **依存関係削減**: `async-trait` クレートへの依存を排除
2. **エラーハンドリング改善**: panic を避け、適切なエラー伝播
3. **非同期 I/O**: async コンテキストでのブロッキングを回避
4. **テストカバレッジ向上**: ハンドラーテストを追加

### トレードオフ

1. **ボイラープレート増加**: `Box::pin(async move { ... })` の記述が必要
2. **dead_code 警告**: `JsonFileExporter` は代替実装として残存（`#[allow(dead_code)]`）

## 検証

### テスト実行

```bash
# rask-log-aggregator
cd rask-log-aggregator/app && cargo test
# 結果: 10 tests passed

# rask-log-forwarder
cd rask-log-forwarder/app && cargo test
# 結果: 174 tests passed
```

### Clippy チェック

```bash
cargo clippy -- -D warnings
# 両サービスとも警告なし
```

## 実装日

2026-01-10

## 関連

- [Rust 2024 Edition Guide](https://doc.rust-lang.org/edition-guide/rust-2024/index.html)
- [Announcing Rust 1.85.0 and Rust 2024](https://blog.rust-lang.org/2025/02/20/Rust-1.85.0/)
