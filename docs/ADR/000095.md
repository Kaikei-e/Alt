# Augur機能への Connect-RPC ストリーミングハンドラ追加

## ステータス

採択（Accepted）

## コンテキスト

### 背景

Morning Letter 機能では Connect-RPC を使用したストリーミング API が実装されていた。一方、Augur（Ask Augur Anything）機能は Proto 定義のみが存在し、Connect-RPC ハンドラが未実装だった。

### 既存実装

| 機能 | HTTP API | Connect-RPC |
|------|----------|-------------|
| Morning Letter | `/v1/rag/morning-letter` | `MorningLetterService/StreamChat` |
| Augur | `/v1/rag/answer`, `/v1/rag/answer/stream` | **未実装** |

### 関連 ADR

- ADR 000090: Re-ranking + Hybrid Search 導入
- ADR 000093: LLM 使用ソースのみを返却する修正

## 決定

Augur 機能に Connect-RPC ストリーミングハンドラを追加し、Morning Letter と同様の実装パターンを適用する。

### 実装内容

#### 1. AugurServiceHandler の実装

```go
// Handler implements augurv2connect.AugurServiceHandler
type Handler struct {
    answerUsecase   usecase.AnswerWithRAGUsecase
    retrieveUsecase usecase.RetrieveContextUsecase
    logger          *slog.Logger
}

// StreamChat - ストリーミング RAG チャット
func (h *Handler) StreamChat(ctx, req, stream) error

// RetrieveContext - コンテキスト取得のみ
func (h *Handler) RetrieveContext(ctx, req) (*Response, error)
```

#### 2. ADR 000093 の適用

`StreamEventKindDone` 時に `output.Citations`（LLM が実際に使用したソースのみ）を返却：

```go
case usecase.StreamEventKindDone:
    output, ok := event.Payload.(*usecase.AnswerWithRAGOutput)
    // output.Citations を使用（output.Contexts ではなく）
    citations := h.convertCitationsToProtoCitations(output.Citations)
    return &augurv2.StreamChatEvent{
        Kind: "done",
        Payload: &augurv2.StreamChatEvent_Done{
            Done: &augurv2.DonePayload{
                Answer:    output.Answer,
                Citations: citations,
            },
        },
    }, false
```

### Morning Letter との違い

| 項目 | Morning Letter | Augur |
|------|----------------|-------|
| 時間制約 | `WithinHours` で最近記事に限定 | 制約なし（全記事対象） |
| 記事プリフェッチ | ArticleClient で事前取得 | なし |
| CandidateArticleIDs | 時間窓内の記事 ID を指定 | 指定なし |

## 結果

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `internal/adapter/connect/augur/handler.go` | 新規: AugurServiceHandler 実装 |
| `internal/adapter/connect/augur/handler_test.go` | 新規: ユニットテスト |
| `internal/adapter/connect/server.go` | AugurService 登録追加 |
| `cmd/server/main.go` | DI 配線修正 |

### Connect-RPC エンドポイント

| RPC | パス |
|-----|------|
| StreamChat | `/alt.augur.v2.AugurService/StreamChat` |
| RetrieveContext | `/alt.augur.v2.AugurService/RetrieveContext` |

### ストリーミングイベント

| イベント | 内容 |
|---------|------|
| `delta` | テキストチャンク（逐次送信） |
| `meta` | 検索結果のメタデータ |
| `done` | 完了（回答 + LLM 使用 Citations） |
| `fallback` | フォールバック理由 |
| `error` | エラーメッセージ |

### Hybrid 検索の自動適用

`RetrieveContextUsecase` 経由で以下が自動的に有効：

- BM25 + Vector 検索の RRF 融合（ADR 000090）
- Cross-encoder 再ランキング
- 動的言語配置

## 実装日

2026-01-15

## 関連

- [ADR 000090: Re-ranking + Hybrid Search 導入](000090.md)
- [ADR 000093: LLM 使用ソースのみを返却](000093.md)
- [Connect-RPC Documentation](https://connectrpc.com/docs/)
