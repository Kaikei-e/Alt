# RAG Hybrid Search - 動的言語割り当ての導入

## ADR's STATUS

Accepted

## CONTEXT

RAG Hybrid Searchにおけるソース選択で、日本語5件＋英語5件の固定割り当てが使用されていた。

### 既存の動作

1. Original Query から上位5件を選択（言語フィルタなし）
2. Expanded Query から英語優先で5件を選択:
   - Pass 1: 非日本語（英語）ドキュメントを優先
   - Pass 2: 残りを日本語で補完
3. 合計10件固定

### 問題点

- 英語ソースのスコアが低くても優先的に選択される
- 高スコアの日本語記事が除外される可能性
- ソースの品質よりも言語バランスが優先される

## DECISION MAKING

### 解決策

純粋なスコアベースの動的割り当てを導入。合計10件の枠内で、スコアが高い順に選択する。

### 実装

1. **新しい設定構造体** `LanguageAllocationConfig`
   ```go
   type LanguageAllocationConfig struct {
       Enabled bool  // true: スコア順, false: 英語優先(従来動作)
   }
   ```

2. **環境変数**
   ```
   RAG_DYNAMIC_LANGUAGE_ALLOCATION=true  (デフォルト)
   ```

3. **選択アルゴリズム**
   - 全候補（Original + Expanded）を統合
   - スコア順にソート
   - 上位N件を選択（言語に関係なく）

### 言語分布のログ出力

選択結果の言語分布をログに記録:
```
dynamic_language_allocation_completed
  japanese_count: 7
  english_count: 3
  total_contexts: 10
```

## RESULTS, EFFECTS

### PROS

- **品質向上**: スコアが高い記事が優先的に選択される
- **柔軟性**: 日英比率が結果次第で 0:10 〜 10:0 まで動的に変動
- **可観測性**: ログで言語分布を追跡可能
- **後方互換性**: 環境変数で従来動作に切り替え可能

### CONS, TRADEOFF

- **言語バランスの保証なし**: 特定言語のソースが極端に偏る可能性
  - ただし、これはスコア（関連性）に基づく意図された動作
- **デフォルト動作の変更**: 既存環境で動作が変わる
  - `RAG_DYNAMIC_LANGUAGE_ALLOCATION=false` で従来動作に戻せる

## APPENDIX

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `rag-orchestrator/internal/usecase/retrieval_config.go` | LanguageAllocationConfig追加 |
| `rag-orchestrator/internal/infra/config/config.go` | 環境変数追加 |
| `rag-orchestrator/internal/usecase/retrieve_context_usecase.go` | SelectContextsDynamic関数追加 |
| `rag-orchestrator/cmd/server/main.go` | 設定ワイヤリング |

### 関連する型定義

- `LanguageAllocationConfig`: 言語割り当て設定
- `SelectContextsDynamic()`: スコアベース選択関数
- `isJapanese()`: CJK文字検出による言語判定
