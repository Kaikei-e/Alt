# rask-log-aggregator: OTLP HTTP専用ポート (4318) の追加

## ADR's STATUS

Accepted

## CONTEXT

### 背景

Grafana Trace Explorer (`/d/trace-explorer/otel-trace-explorer`) で "no data" と表示される問題が発生。サービス（alt-backend等）からのOTLPトレースエクスポートが失敗していた。

### エラーログ

```
alt-backend | "traces export: Post \"http://rask-log-aggregator:4318/v1/traces\":
             dial tcp 172.18.0.4:4318: connect: connection refused"
```

### 根本原因

**OTLPエンドポイントのポート不一致:**

1. `rask-log-aggregator` は **port 9600 のみ** でリッスン
2. 環境変数 `OTEL_EXPORTER_OTLP_ENDPOINT` は `http://rask-log-aggregator:4318` を指定
3. サービスはport 4318に接続しようとするが、コンテナ内で誰もリッスンしていない
4. 結果: **connection refused** エラーが継続的に発生

### 既存のアーキテクチャ

```
┌─────────────────────────────────────────┐
│         rask-log-aggregator             │
│                                         │
│   Port 9600 (HTTP)                      │
│   ├─ GET  /v1/health                    │
│   ├─ POST /v1/aggregate                 │
│   ├─ POST /v1/logs   (OTLP)             │
│   └─ POST /v1/traces (OTLP)             │
│                                         │
└─────────────────────────────────────────┘
```

問題: OTLP標準ポート4318でリッスンしていない

## DECISION MAKING

### 解決方針

rask-log-aggregatorに**OTLP HTTP専用サーバー (port 4318)** を追加し、2つのサーバーを並行稼働させる。

### 修正後のアーキテクチャ

```
┌─────────────────────────────────────────┐
│         rask-log-aggregator             │
│                                         │
│   Port 9600 (Main HTTP)                 │
│   ├─ GET  /v1/health                    │
│   └─ POST /v1/aggregate                 │
│                                         │
│   Port 4318 (OTLP HTTP)                 │
│   ├─ POST /v1/logs   (OTLP logs)        │
│   └─ POST /v1/traces (OTLP traces)      │
│                                         │
└─────────────────────────────────────────┘
```

### 実装詳細

**1. config.rs の変更:**

```rust
pub struct Settings {
    // ... existing fields ...
    pub http_port: u16,      // Main HTTP port (default: 9600)
    pub otlp_http_port: u16, // OTLP HTTP port (default: 4318)
}
```

**2. main.rs の変更:**

`tokio_util::sync::CancellationToken` を使用して2つのAxumサーバーを並行稼働。

```rust
// CancellationToken for graceful shutdown coordination
let shutdown_token = CancellationToken::new();

// Spawn OTLP server task (port 4318)
let otlp_shutdown = shutdown_token.child_token();
let otlp_handle = tokio::spawn(async move {
    axum::serve(otlp_listener, otlp_router)
        .with_graceful_shutdown(otlp_shutdown.cancelled_owned())
        .await
});

// Run main server (port 9600)
axum::serve(main_listener, main_app)
    .with_graceful_shutdown(async move {
        shutdown_signal().await;
        main_shutdown.cancel();
    })
    .await?;
```

### 代替案

1. **ポート設定を9600に統一**: OTLP標準仕様から逸脱し、他ツールとの互換性が低下
2. **nginxでリバースプロキシ**: 追加のコンポーネントが必要で複雑性が増す
3. **環境変数でポート変更**: サービス側の設定変更が必要で影響範囲が広い

選択した方針はOTLP標準に準拠しつつ、既存の9600ポートも維持できる。

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `rask-log-aggregator/app/src/config.rs` | `http_port`, `otlp_http_port` フィールド追加 |
| `rask-log-aggregator/app/src/main.rs` | 2サーバー並行稼働、graceful shutdown調整 |

### PROS

1. **OTLP標準準拠**: ポート4318はOTLP HTTP標準ポート
2. **後方互換性維持**: 既存のport 9600エンドポイントは変更なし
3. **設定の柔軟性**: 環境変数でポート変更可能
4. **graceful shutdown**: 両サーバーが協調してシャットダウン
5. **最小限の変更**: 2ファイル、約30行の追加

### CONS, TRADEOFF

1. **2サーバー稼働**: リソース消費が若干増加
2. **複雑性の増加**: shutdown coordinationロジックが必要

## APPENDIX

### 検証方法

```bash
# 1. OTLP HTTPエンドポイント疎通確認
curl -s -X POST http://localhost:4318/v1/traces \
  -H "Content-Type: application/x-protobuf" -d ''

# 2. Main HTTPエンドポイント確認
curl -s http://localhost:9600/v1/health

# 3. サービスログでconnection refusedが解消されたことを確認
docker compose logs alt-backend --tail=20 | grep -i trace
```

### 環境変数

| 変数名 | デフォルト値 | 説明 |
|--------|-------------|------|
| `HTTP_PORT` | 9600 | Main HTTPサーバーポート |
| `OTLP_HTTP_PORT` | 4318 | OTLP HTTPサーバーポート |

### 参考資料

- [Axum Multiple Listeners Discussion](https://github.com/tokio-rs/axum/discussions/2949)
- [OpenTelemetry Protocol Specification](https://opentelemetry.io/docs/specs/otlp/)
- [tokio-util CancellationToken](https://docs.rs/tokio-util/latest/tokio_util/sync/struct.CancellationToken.html)

### 関連ADR

- ADR-127: OTLPエンドポイントポート修正 (9600 → 4318)
- ADR-128: trace_id/span_id消失バグの修正
