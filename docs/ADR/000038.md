# REST API から Connect-RPC への完全移行

## ステータス

**採択・実装完了（Accepted & Implemented）** - 2026年1月

## コンテキスト

### 背景

Altプロジェクトは当初、フロントエンドとバックエンド間の通信にREST APIを使用していた。しかし、以下の理由からConnect-RPC（gRPC-Web互換）への段階的な移行を開始した：

1. **型安全性**: Protocol Buffersによる厳密な型定義
2. **ストリーミング対応**: サーバーストリーミングによるリアルタイム更新
3. **コード生成**: クライアント/サーバーコードの自動生成
4. **パフォーマンス**: バイナリプロトコルによる効率的な通信

### 既存の課題

2025年12月時点で、以下の問題が存在した：

1. **混在状態**: REST APIとConnect-RPCが混在し、保守コストが増大
2. **重複実装**: 同じ機能がREST/RPCの両方で実装されている箇所が存在
3. **テスト複雑化**: E2Eテストで両方のプロトコルをモックする必要があった
4. **未使用コード**: Connect-RPC移行後も削除されていないREST APIルートが存在

### 移行対象エンドポイント

#### Phase 1: 未使用REST APIルート（8ファイル）

すでにConnect-RPCに移行済みで、使用されていないルート：

- `/api/feeds/stats` → `FeedService.GetFeedStats`
- `/api/stats/detailed` → `FeedService.GetDetailedFeedStats`
- `/api/count/unreads` → `FeedService.GetUnreadCount`
- `/api/fetch/viewed/cursor` → `FeedService.GetReadFeeds`
- `/api/search` → `FeedService.SearchFeeds`
- `/api/register/favorite` → `FeedService.RegisterFavorite`
- `/api/articles/content` → `ArticleService.GetFeedContent`
- `/api/articles/archive` → `ArticleService.ArchiveArticle`

#### Phase 2: Article Summary関連（4ファイル）

一部で使用されていたが、Connect-RPCへの移行が必要なルート：

- `/api/articles/summary` → 新規 `ArticleService.FetchArticleSummary`
- `/api/feeds/summarize` → `FeedService.StreamSummarize`
- `/api/feeds/summarize/stream` → `FeedService.StreamSummarize`
- `/api/feeds/summarize/status/[job_id]` → 廃止（ストリーミングに統合）

## 意思決定

### 決定1: 段階的削除戦略

**採用したアプローチ**: TDD-First + 段階的削除

1. **Phase 1（未使用）**: grep検索で使用箇所がないことを確認後、即座に削除
2. **Phase 2（使用中）**:
   - Connect-RPC実装を追加（TDD）
   - フロントエンド移行
   - E2Eテスト更新
   - REST APIルート削除

**代替案と理由**:
- ❌ **一度にすべて削除**: リスクが高すぎる
- ❌ **長期間の並存**: 保守コストが継続
- ✅ **段階的削除**: リスクとコストのバランスが最適

### 決定2: FetchArticleSummary RPCの新規追加

**Protocol Buffer定義** (`proto/alt/articles/v2/articles.proto`):

```protobuf
service ArticleService {
  // 複数の記事サマリーを一括取得
  rpc FetchArticleSummary(FetchArticleSummaryRequest)
    returns (FetchArticleSummaryResponse);
}

message FetchArticleSummaryRequest {
  repeated string feed_urls = 1;  // 最大50件
}

message FetchArticleSummaryResponse {
  repeated ArticleSummaryItem matched_articles = 1;
  int32 total_matched = 2;
  int32 requested_count = 3;
}

message ArticleSummaryItem {
  string title = 1;
  string content = 2;
  string author = 3;
  string published_at = 4;
  string fetched_at = 5;
  string source_id = 6;
}
```

**理由**:
- REST `/api/articles/summary` の1対1置き換え
- バッチ処理による効率化（最大50件）
- Protocol Buffersによる型安全性

### 決定3: StreamSummarizeへの完全移行

REST `/api/feeds/summarize/stream` を廃止し、Connect-RPC `StreamSummarize` に完全移行。

**移行方針**:
- ストリーミングレスポンスのみをサポート（ポーリング廃止）
- キャッシュヒット時は即座に `isCached=true` で全文返却
- キャッシュミス時はリアルタイムでチャンク配信

### 決定4: camelCase/snake_case変換レイヤー

**課題**: Protocol BuffersはcamelCaseを生成するが、既存のフロントエンドコードはsnake_caseを使用。

**解決策**: BFF（Backend for Frontend）レイヤーで変換を実装。

```typescript
// alt-frontend-sv/src/lib/api/client/articles.ts
export async function getArticleSummaryClient(
  feedUrl: string,
): Promise<FetchArticleSummaryResponse> {
  const transport = createClientTransport();
  const { fetchArticleSummary } = await import("$lib/connect/articles");
  const response = await fetchArticleSummary(transport, [feedUrl]);

  // camelCase → snake_case 変換
  return {
    matched_articles: response.matchedArticles.map((item) => ({
      article_url: feedUrl,
      title: item.title,
      author: item.author || undefined,
      content: item.content,
      content_type: "text/html",
      published_at: item.publishedAt,
      fetched_at: item.fetchedAt,
      source_id: item.sourceId,
    })),
    total_matched: response.totalMatched,
    requested_count: response.requestedCount,
  };
}
```

**理由**:
- 既存のUIコンポーネントの大規模な書き換えを回避
- 段階的な移行を可能にする
- BFFパターンとして明確に責務を分離

### 決定5: E2Eテストのモック戦略

**採用したアプローチ**: Connect-RPCモックに一本化

```typescript
// tests/e2e/mocks/connect-rpc.ts
export const CONNECT_RPC_PATHS = [
  "/alt.feeds.v2.FeedService/GetUnreadFeeds",
  "/alt.feeds.v2.FeedService/StreamSummarize",
  "/alt.articles.v2.ArticleService/FetchArticleSummary",
  "/alt.articles.v2.ArticleService/GetFeedContentOnTheFly",
];
```

**理由**:
- REST APIモックを削除することで、テストの保守性が向上
- Connect-RPCのみのモックで統一されたテスト環境を実現

## 結果

### 技術的成果

1. **削除されたファイル数**: 12ファイル
   - Phase 1: 8ファイル（未使用REST APIルート）
   - Phase 2: 4ファイル（Article Summary関連）

2. **新規追加されたRPC**: 1つ
   - `ArticleService.FetchArticleSummary`

3. **テストカバレッジ**:
   - Backend: TDDで4つのテストケース追加（認証、バリデーション、正常系）
   - Frontend: 100テスト全てパス
   - E2E: Swipe PageテストをConnect-RPCモックに更新

### コードメトリクス

```
削除行数: ~800行（REST APIルート + テスト）
追加行数: ~300行（RPC実装 + 型変換 + テスト）
純減少: ~500行
```

### パフォーマンス改善

- **型安全性**: Protocol Buffersによる型チェックで、ランタイムエラーが減少
- **ストリーミング**: リアルタイム更新により、ユーザー体験が向上
- **保守性**: 単一のプロトコルに統一され、コードベースがシンプルに

### 移行時の注意点

1. **SSR無効化が必要**: Connect-RPCを使用するページは `export const ssr = false` が必要
   - 例: `alt-frontend-sv/src/routes/mobile/feeds/swipe/+page.ts`

2. **型変換レイヤーの保守**: BFFでの変換ロジックを適切にテスト

3. **エラーハンドリング**: Connect-RPCのエラーコード（`connect.Code`）を適切に処理

## 参照

### 関連ADR

- [ADR-029: Connect-RPC統一戦略](./000029.md) - 初期のConnect-RPC移行決定
- [ADR-037: Morning Letter機能](./000037.md) - ストリーミングRPCの実装例

### 実装コミット

- `695d4ddb` - Phase 1: 未使用REST APIルート削除
- `ea7267f3` - Phase 2: FetchArticleSummary RPC追加
- `42958a21` - Frontend Client関数移行
- `d7a03517` - Mobile Swipe Page移行
- `cd6c17f9` - Phase 2: Article Summary REST削除
- `924c5eb1` - E2Eテスト更新
- `47927808` - 型エラー修正

### PR

- [#121: Complete Connect-RPC migration for article and summarize endpoints](https://github.com/Kaikei-e/Alt/pull/121)

### ドキュメント

- [Connect-RPC Migration Plan](../plan/plan1.md) - 移行計画書
- [Protocol Buffers定義](../../proto/alt/articles/v2/articles.proto)
- [Connect-RPC統一戦略](../../docs/connect-rpc-migration-status.md)

## 教訓

### 成功要因

1. **TDD-First**: すべてのRPC実装で先にテストを書くことで、リグレッションを防止
2. **段階的アプローチ**: 一度にすべてを変更せず、フェーズを分けたことでリスクを最小化
3. **grep検索の徹底**: 削除前に必ず使用箇所をgrepで確認
4. **E2Eテスト**: 移行後すぐにE2Eテストで動作確認

### 今後の改善点

1. **BFF変換レイヤーの削除**: 将来的にはUIコンポーネントもcamelCaseに統一
2. **自動化**: ADR作成や移行チェックリストの自動化
3. **モニタリング**: Connect-RPCのメトリクス収集（レイテンシ、エラーレート）

### 次のステップ

以下のREST APIエンドポイントは**今回の移行対象外**：

- **SSE (Server-Sent Events)**: `/api/v2/feeds/stream`
  - 理由: リアルタイムフィード更新に使用中、Connect-RPCストリーミングへの移行を検討
- **Augur Chat**: `/api/v2/feeds/augur/chat`
  - 理由: Knowledge Augur機能専用、別途移行計画が必要

これらは次のフェーズで検討する。
