# ADR-000235: SwipeFeedCard にお気に入りボタンを追加

## STATUS

Accepted（実装完了・lint/format エラー 0 件・サーバーテスト 368 件全パス）

## CONTEXT

スワイプ UI（`/sv/feeds/swipe`）の `SwipeFeedCard` コンポーネントには「Article」と「Summary」の 2 つのアクションボタンがあったが、ユーザーがスワイプ画面から直接フィードをお気に入り登録する手段がなかった。お気に入り登録するには別画面（`FeedDetails` モーダル）を開く必要があり、スワイプ操作の流れが中断されていた。

### 問題

1. **操作フローの断絶**: スワイプ UI で気になるフィードを見つけても、お気に入り登録には画面遷移が必要
2. **一貫性の欠如**: `FeedDetails.svelte` にはお気に入りボタンがあるが、スワイプ UI にはない

### 前提：既存インフラの活用

バックエンド API、BFF、API クライアントは既に実装済みであり、フロントエンドの UI 変更のみで対応可能だった。

| レイヤー | 状態 |
|---------|------|
| API クライアント（`registerFavoriteFeedClient`） | 実装済み |
| Connect-RPC（`registerFavoriteFeed`） | 実装済み |
| バックエンドエンドポイント | 実装済み |
| DB テーブル | 実装済み |

### アプローチの選択肢

| 方式 | 利点 | 欠点 |
|------|------|------|
| A. フッターに 3 つ目のボタンを追加（`flex-1` 均等配置） | 既存パターンと一貫。変更が最小限。ユーザーの視線が Footer に集中するスワイプ UI と相性が良い | ボタン幅が狭くなる |
| B. カードヘッダーにアイコンボタンを追加 | フッターのスペースを消費しない | ヘッダーは記事リンクが配置されており、誤タップの可能性が高い |
| C. スワイプ方向にお気に入りアクションを割り当て | ジェスチャー操作で直感的 | 左右スワイプは既に「既読マーク」に使用されており、機能が衝突する |

## DECISION MAKING

**方式 A（フッターに 3 つ目のボタン追加）** を採用した。

**理由:**

1. **既存パターンとの一貫性**: `FeedDetails.svelte`（333-353 行目）の Favorite ボタン実装を参考にし、同じ API クライアント呼び出しパターンを踏襲
2. **変更の最小化**: 2 ファイルの修正のみ。新規ファイル作成なし、バックエンド変更なし
3. **UX リサーチに基づく設計**: アイコン + ラベルの組み合わせ、3 段階の状態遷移（Favorite → Saving... → Favorited）

### 設計

```
Before:
  SwipeFeedCard Footer
    └── [Article] [Summary]

After:
  SwipeFeedCard Footer
    └── [Article] [★ Favorite] [Summary]
                      ↓ click
                  [★ Saving...]  (disabled, API 呼び出し中)
                      ↓ success
                  [★ Favorited]  (disabled, Star 塗りつぶし)
```

### UX 詳細

| 要素 | 設計判断 |
|------|---------|
| アイコン | `Star`（`@lucide/svelte`）— アプリ内で Favorite Feeds メニュー等に使用済み |
| ラベル | アイコン + テキスト（認知しやすい） |
| 配置 | Article / **Favorite** / Summary の中央（[閲覧] [保存] [AI 処理] の論理グルーピング） |
| 視覚フィードバック | 未登録=アウトライン Star → 登録済み=塗りつぶし Star（`fill` 属性でトグル） |
| 状態遷移 | 「Favorite」→「Saving...」→「Favorited」（`disabled` 状態） |
| アクセシビリティ | `aria-label` を状態に応じて動的に変更 |

### データフロー

```
SwipeFeedCard.handleFavorite()
  → registerFavoriteFeedClient(feed.link)     [既存 API クライアント]
    → Connect-RPC registerFavoriteFeed()       [既存 Connect-RPC]
      → POST /v1/feeds/register/favorite       [既存エンドポイント]
```

## RESULTS

### 変更ファイル

| ファイル | 操作 | 変更内容 |
|---------|------|---------|
| `alt-frontend-sv/src/lib/components/mobile/feeds/swipe/SwipeFeedCard.svelte` | 修正 | `Star` import 追加、`registerFavoriteFeedClient` import 追加、`isFavoriting`/`isFavorited` state 追加、`handleFavorite()` 関数追加、フッターに Favorite ボタン HTML 追加 |
| `alt-frontend-sv/src/lib/components/mobile/feeds/swipe/SwipeFeedCard.svelte.spec.ts` | 修正 | `registerFavoriteFeedClient` モック追加、テスト 4 件追加（ボタン描画、初期 enabled 状態、クリック時 API 呼び出し、成功後 Favorited 状態） |

### 変更不要だったファイル

| レイヤー | ファイル |
|---------|---------|
| API クライアント | `$lib/api/client/articles.ts` |
| Connect-RPC | `$lib/connect/rss.ts` |
| バックエンド | Handler / Usecase / Gateway / Driver |
| DB | `favorite_feeds` テーブル |

### 検証結果

```
biome lint:   0 new warnings (既存 78 warnings は変更なし)
biome format: pass
Server tests: 368 passed (29 test files)
Container:    alt-frontend-sv healthy (port 4173)
```

## PROS

1. **操作フローの改善**: スワイプ UI からワンタップでお気に入り登録が可能になり、画面遷移が不要に
2. **変更の最小化**: 既存の API インフラをそのまま活用し、フロントエンド 2 ファイルの修正のみで完結
3. **既存パターンとの一貫性**: `FeedDetails.svelte` と同じ API 呼び出しパターン、同じ Star アイコンを使用
4. **ダブルクリック防止**: `isFavoriting || isFavorited` ガードにより、重複登録を防止
5. **アクセシビリティ**: `aria-label` が状態に応じて動的に変わり、スクリーンリーダーで正しくアナウンスされる

## CONS, TRADEOFF

1. **3 ボタン幅の制約**: モバイルの狭い画面で 3 ボタンを均等配置するため、各ボタンの幅が以前（2 ボタン時）より狭くなる。ただしラベルは短い英単語のため実用上問題なし
2. **お気に入り解除未対応**: 現在の実装はお気に入り「登録」のみ。解除は `/sv/feeds/favorites` ページから行う必要がある。スワイプ UI のカードは次々切り替わるため、トグル操作の需要は低いと判断
3. **既読マーク済みフィードの考慮**: スワイプで既読マークした後にお気に入り登録しようとすると、既にカードが切り替わっている可能性がある。お気に入り登録はスワイプ前に行う想定
