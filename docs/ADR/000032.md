# Connect-RPC Phase 4-6: Articles / RSS Feed Links / Streaming Summarize の移行

## ステータス

**採択・実装完了（Accepted & Implemented）** - 2025年12月31日

## コンテキスト

### 背景

ADR-000030で完了したConnect-RPC Phase 2-3（Feed List / Search）に続き、Phase 4-6として残りのエンドポイントを移行した。

### 対象エンドポイント

| Phase | REST (v1) | Connect-RPC (v2) | 説明 |
|-------|-----------|------------------|------|
| 4 | `GET /v1/articles/fetch/content` | `ArticleService.FetchArticleContent` | 記事コンテンツ取得 |
| 4 | `POST /v1/articles/archive` | `ArticleService.ArchiveArticle` | 記事アーカイブ |
| 4 | `GET /v1/articles/fetch/cursor` | `ArticleService.FetchArticlesCursor` | 記事一覧（カーソル） |
| 5 | `POST /v1/rss-feed-link/register` | `RSSService.RegisterRSSFeed` | RSSフィード登録 |
| 5 | `GET /v1/rss-feed-link/list` | `RSSService.ListRSSFeedLinks` | RSSフィード一覧 |
| 5 | `DELETE /v1/rss-feed-link/:id` | `RSSService.DeleteRSSFeedLink` | RSSフィード削除 |
| 5 | `POST /v1/feeds/register/favorite` | `RSSService.RegisterFavoriteFeed` | お気に入り登録 |
| 6 | `POST /v1/feeds/summarize/stream` (SSE) | `FeedService.StreamSummarize` | ストリーミング要約 |

### 技術的課題

1. **サービス分離の判断**
   - 既存のFeedServiceに追加するか、新規サービスを作成するか
   - ドメイン境界の明確化

2. **SSE → Connect Server Streaming 変換**
   - 既存のSSE実装からServer Streaming RPCへの移行
   - チャンク送信とキャッシュ処理の両立

3. **SSRF保護の一貫性**
   - 複数のURL入力エンドポイントでの保護実装

## 意思決定

### 決定1: サービス分離パターンの採用

**検討した代替案:**

| パターン | メリット | デメリット |
|----------|----------|------------|
| FeedService拡張 | サービス数が増えない | FeedServiceの責務が肥大化 |
| **新規サービス作成（推奨）** | ドメイン境界が明確、独立したテスト | サービス数が増加 |

**採用理由:**
- `ArticleService`: 記事コンテンツのCRUD操作に特化
- `RSSService`: RSSフィードリンクの管理に特化
- FeedServiceにはStreaming Summarizeのみ追加（要約生成はフィードドメインの延長）

### 決定2: ArticleService Proto設計

```protobuf
service ArticleService {
  rpc FetchArticleContent(FetchArticleContentRequest) returns (FetchArticleContentResponse);
  rpc ArchiveArticle(ArchiveArticleRequest) returns (ArchiveArticleResponse);
  rpc FetchArticlesCursor(FetchArticlesCursorRequest) returns (FetchArticlesCursorResponse);
}

message FetchArticleContentResponse {
  string url = 1;
  string content = 2;
  string article_id = 3;
}

message ArticleItem {
  string id = 1;
  string title = 2;
  string url = 3;
  string content = 4;
  string published_at = 5;
  repeated string tags = 6;
}
```

**設計判断:**
- `FetchArticleContent`: URL正規化後の値とarticle_idを返却
- `ArticleItem`: タグ情報を含めてフロントエンドでの表示を最適化
- カーソルページネーション: Phase 2と同様のRFC3339形式

### 決定3: RSSService Proto設計

```protobuf
service RSSService {
  rpc RegisterRSSFeed(RegisterRSSFeedRequest) returns (RegisterRSSFeedResponse);
  rpc ListRSSFeedLinks(ListRSSFeedLinksRequest) returns (ListRSSFeedLinksResponse);
  rpc DeleteRSSFeedLink(DeleteRSSFeedLinkRequest) returns (DeleteRSSFeedLinkResponse);
  rpc RegisterFavoriteFeed(RegisterFavoriteFeedRequest) returns (RegisterFavoriteFeedResponse);
}

message RSSFeedLink {
  string id = 1;   // UUID
  string url = 2;
}
```

**設計判断:**
- シンプルなCRUD操作に特化
- `RegisterFavoriteFeed`をRSSServiceに配置（フィード登録と類似の操作）

### 決定4: StreamSummarize Server Streaming設計

```protobuf
message StreamSummarizeRequest {
  optional string feed_url = 1;
  optional string article_id = 2;
  optional string content = 3;
  optional string title = 4;
}

message StreamSummarizeResponse {
  string chunk = 1;
  bool is_final = 2;
  string article_id = 3;
  bool is_cached = 4;
  optional string full_summary = 5;
}

service FeedService {
  // ... existing RPCs ...
  rpc StreamSummarize(StreamSummarizeRequest) returns (stream StreamSummarizeResponse);
}
```

**SSE → Connect Streaming 変換パターン:**

| SSE | Connect Streaming |
|-----|-------------------|
| `data: chunk\n\n` | `stream.Send({chunk: "...", is_final: false})` |
| キャッシュヒット時の即座送信 | `is_cached: true, full_summary: "..."` |
| 接続終了 | `is_final: true, full_summary: "..."` |

**理由:**
- `is_cached`フラグでキャッシュ応答を明示化
- `full_summary`を最終メッセージに含めることで、クライアントがチャンク再構成不要
- 既存のSSE処理ロジック（キャッシュチェック、pre-processor呼び出し、DB保存）をそのまま活用

### 決定5: SSRF保護の統一

すべてのURL入力ハンドラーで以下を実施:

```go
// 1. URL解析
parsedURL, err := url.Parse(req.Msg.Url)
if err != nil {
    return nil, connect.NewError(connect.CodeInvalidArgument, ...)
}

// 2. SSRF保護（rest.IsAllowedURL使用）
if err := rest.IsAllowedURL(parsedURL); err != nil {
    return nil, connect.NewError(connect.CodeInvalidArgument,
        fmt.Errorf("URL not allowed: %w", err))
}
```

**対象ハンドラー:**
- `ArticleService.FetchArticleContent`
- `ArticleService.ArchiveArticle`
- `RSSService.RegisterRSSFeed`
- `RSSService.RegisterFavoriteFeed`
- `FeedService.StreamSummarize`（feedArticleContent内）

## 結果・影響

### 実装内容

#### 新規Proto定義

**articles.proto:**
```protobuf
syntax = "proto3";
package alt.articles.v2;

service ArticleService {
  rpc FetchArticleContent(FetchArticleContentRequest) returns (FetchArticleContentResponse);
  rpc ArchiveArticle(ArchiveArticleRequest) returns (ArchiveArticleResponse);
  rpc FetchArticlesCursor(FetchArticlesCursorRequest) returns (FetchArticlesCursorResponse);
}
```

**rss.proto:**
```protobuf
syntax = "proto3";
package alt.rss.v2;

service RSSService {
  rpc RegisterRSSFeed(RegisterRSSFeedRequest) returns (RegisterRSSFeedResponse);
  rpc ListRSSFeedLinks(ListRSSFeedLinksRequest) returns (ListRSSFeedLinksResponse);
  rpc DeleteRSSFeedLink(DeleteRSSFeedLinkRequest) returns (DeleteRSSFeedLinkResponse);
  rpc RegisterFavoriteFeed(RegisterFavoriteFeedRequest) returns (RegisterFavoriteFeedResponse);
}
```

**feeds.proto追加:**
```protobuf
message StreamSummarizeRequest { ... }
message StreamSummarizeResponse { ... }

service FeedService {
  // ... existing ...
  rpc StreamSummarize(StreamSummarizeRequest) returns (stream StreamSummarizeResponse);
}
```

#### バックエンドハンドラー

**ArticleService（articles/handler.go）:**
```go
func (h *Handler) FetchArticleContent(ctx, req) (*connect.Response[...], error)
func (h *Handler) ArchiveArticle(ctx, req) (*connect.Response[...], error)
func (h *Handler) FetchArticlesCursor(ctx, req) (*connect.Response[...], error)
```

**RSSService（rss/handler.go）:**
```go
func (h *Handler) RegisterRSSFeed(ctx, req) (*connect.Response[...], error)
func (h *Handler) ListRSSFeedLinks(ctx, req) (*connect.Response[...], error)
func (h *Handler) DeleteRSSFeedLink(ctx, req) (*connect.Response[...], error)
func (h *Handler) RegisterFavoriteFeed(ctx, req) (*connect.Response[...], error)
```

**FeedService（feeds/handler.go追加）:**
```go
func (h *Handler) StreamSummarize(ctx, req, stream) error

// ヘルパーメソッド
func (h *Handler) resolveArticle(ctx, feedURL, articleID, content, title) (string, string, string, error)
func (h *Handler) fetchArticleContent(ctx, urlStr) (string, string, error)
func (h *Handler) streamPreProcessorSummarize(ctx, content, articleID, title) (io.ReadCloser, error)
func (h *Handler) streamAndCapture(ctx, stream, preProcessorStream, articleID) (string, error)
```

#### サービス登録（server.go）

```go
func SetupConnectHandlers(mux *http.ServeMux, container *di.ApplicationComponents, cfg *config.Config, logger *slog.Logger) {
    // Auth interceptor
    authInterceptor := middleware.NewAuthInterceptor(logger, cfg)
    opts := connect.WithInterceptors(authInterceptor.Interceptor())

    // Register Feed service
    feedHandler := feeds.NewHandler(container, cfg, logger)
    feedPath, feedServiceHandler := feedsv2connect.NewFeedServiceHandler(feedHandler, opts)
    mux.Handle(feedPath, feedServiceHandler)

    // Register Article service (Phase 4)
    articleHandler := articles.NewHandler(container, cfg, logger)
    articlePath, articleServiceHandler := articlesv2connect.NewArticleServiceHandler(articleHandler, opts)
    mux.Handle(articlePath, articleServiceHandler)

    // Register RSS service (Phase 5)
    rssHandler := rss.NewHandler(container, cfg, logger)
    rssPath, rssServiceHandler := rssv2connect.NewRSSServiceHandler(rssHandler, opts)
    mux.Handle(rssPath, rssServiceHandler)
}
```

#### フロントエンドクライアント（alt-frontend-sv）

**articles.ts:**
```typescript
export async function fetchArticleContent(transport, url): Promise<FetchArticleContentResult>
export async function archiveArticle(transport, url, title?): Promise<ArchiveArticleResult>
export async function fetchArticlesCursor(transport, cursor?, limit?): Promise<ArticleCursorResponse>
```

**rss.ts:**
```typescript
export async function registerRSSFeed(transport, url): Promise<RegisterRSSFeedResult>
export async function listRSSFeedLinks(transport): Promise<ListRSSFeedLinksResult>
export async function deleteRSSFeedLink(transport, id): Promise<DeleteRSSFeedLinkResult>
export async function registerFavoriteFeed(transport, url): Promise<RegisterFavoriteFeedResult>
```

**feeds.ts追加:**
```typescript
export async function streamSummarize(transport, options, onChunk?, onError?): Promise<StreamSummarizeResult>
export function streamSummarizeWithAbort(transport, options, onChunk, onComplete, onError?): AbortController
```

### テスト

**articles/handler_test.go:**
- `TestFetchArticleContentResponse_Construction`
- `TestArchiveArticleResponse_Construction`
- `TestArticleItem_Construction`
- `TestFetchArticlesCursorResponse_Construction`
- `TestFetchArticleContentRequest_Validation`
- `TestArchiveArticleRequest_Validation`
- `TestConvertArticlesToProto`

**rss/handler_test.go:**
- `TestRegisterRSSFeedResponse_Construction`
- `TestRSSFeedLink_Construction`
- `TestListRSSFeedLinksResponse_Construction`
- `TestDeleteRSSFeedLinkResponse_Construction`
- `TestRegisterFavoriteFeedResponse_Construction`
- `TestRegisterRSSFeedRequest_Validation`
- `TestDeleteRSSFeedLinkRequest_Validation`
- `TestFeedLinkToProto_Conversion`
- `TestUUIDValidation`

**feeds/handler_test.go追加:**
- `TestStreamSummarize_RequiresAuth`
- `TestStreamSummarize_RequiresFeedURLOrArticleID`
- `TestStreamSummarizeResponse_Construction`
- `TestParseSSESummary`

### PROS

1. **完全なConnect-RPC移行**
   - 全REST APIエンドポイントに対応するConnect-RPC実装完了
   - 型安全なAPI利用が可能に

2. **ドメイン境界の明確化**
   - ArticleService: 記事コンテンツ操作
   - RSSService: フィードリンク管理
   - FeedService: フィード統計・検索・要約

3. **SSE → Server Streaming の改善**
   - Connect-RPCのネイティブストリーミング
   - キャッシュ応答の明示的なフラグ
   - AbortController対応のクライアント実装

4. **セキュリティの一貫性**
   - すべてのURL入力でSSRF保護を実施
   - 認証インターセプターの統一適用

### CONS, TRADEOFF

1. **サービス数の増加**
   - 3つのConnect-RPCサービスを運用
   - 各サービスの登録・管理が必要

2. **既存SSEとの並行運用**
   - REST API（SSE）とConnect-RPC（Server Streaming）が併存
   - フロントエンドの段階的切り替えが必要

3. **pre-processor依存**
   - StreamSummarizeはpre-processorサービスへの依存を継続
   - 障害時のエラーハンドリングは既存実装を踏襲

## 付録

### 変更ファイル一覧

**新規作成:**

| ファイル | 説明 |
|----------|------|
| `proto/alt/articles/v2/articles.proto` | ArticleService定義 |
| `proto/alt/rss/v2/rss.proto` | RSSService定義 |
| `alt-backend/app/connect/v2/articles/handler.go` | ArticleServiceハンドラー |
| `alt-backend/app/connect/v2/articles/handler_test.go` | ArticleServiceテスト |
| `alt-backend/app/connect/v2/rss/handler.go` | RSSServiceハンドラー |
| `alt-backend/app/connect/v2/rss/handler_test.go` | RSSServiceテスト |
| `alt-frontend-sv/src/lib/connect/articles.ts` | ArticleServiceクライアント |
| `alt-frontend-sv/src/lib/connect/rss.ts` | RSSServiceクライアント |

**変更:**

| ファイル | 変更内容 |
|----------|----------|
| `proto/alt/feeds/v2/feeds.proto` | StreamSummarize RPC追加 |
| `alt-backend/app/connect/v2/server.go` | ArticleService/RSSService登録 |
| `alt-backend/app/connect/v2/feeds/handler.go` | StreamSummarizeハンドラー追加 |
| `alt-backend/app/connect/v2/feeds/helpers.go` | parseSSESummary追加 |
| `alt-backend/app/connect/v2/feeds/handler_test.go` | Phase 6テスト追加 |
| `alt-frontend-sv/src/lib/connect/feeds.ts` | streamSummarize関数追加 |
| `alt-frontend-sv/src/lib/connect/index.ts` | エクスポート追加 |

**生成:**

| ファイル | 説明 |
|----------|------|
| `alt-backend/app/gen/proto/alt/articles/v2/` | ArticleService Goコード |
| `alt-backend/app/gen/proto/alt/rss/v2/` | RSSService Goコード |
| `alt-backend/app/gen/proto/alt/feeds/v2/` | FeedService Goコード（更新） |
| `alt-frontend-sv/src/lib/gen/alt/articles/v2/` | ArticleService TypeScriptコード |
| `alt-frontend-sv/src/lib/gen/alt/rss/v2/` | RSSService TypeScriptコード |
| `alt-frontend-sv/src/lib/gen/alt/feeds/v2/` | FeedService TypeScriptコード（更新） |

### 移行ロードマップ（最終状態）

| Phase | 対象エンドポイント | 状態 |
|-------|-------------------|------|
| 1 | Feed Stats（3エンドポイント + Streaming） | **完了** |
| 2 | Feed List（カーソルページネーション） | **完了** |
| 3 | Feed Search | **完了** |
| 4 | Articles（content, archive, cursor） | **完了** |
| 5 | RSS Feed Links（CRUD） | **完了** |
| 6 | Streaming Summarize | **完了** |

### 使用例

**記事コンテンツ取得:**
```typescript
import { createServerTransport, fetchArticleContent } from "$lib/connect";

const transport = await createServerTransport(cookies);
const result = await fetchArticleContent(transport, "https://example.com/article");
console.log(result.content, result.articleId);
```

**RSSフィード登録:**
```typescript
import { createClientTransport, registerRSSFeed } from "$lib/connect";

const transport = createClientTransport();
await registerRSSFeed(transport, "https://example.com/feed.xml");
```

**ストリーミング要約:**
```typescript
import { createClientTransport, streamSummarizeWithAbort } from "$lib/connect";

const transport = createClientTransport();
const abortController = streamSummarizeWithAbort(
    transport,
    { feedUrl: "https://example.com/article" },
    (chunk) => {
        // チャンク受信時のUI更新
        if (!chunk.isCached && chunk.chunk) {
            appendToSummary(chunk.chunk);
        }
    },
    (result) => {
        // 完了時
        console.log("Summary:", result.summary);
    },
    (error) => {
        // エラー時
        console.error("Error:", error);
    }
);

// キャンセル
// abortController.abort();
```

### 参考資料

- [ADR-000028: Buf Connect-RPCの導入とREST APIからの段階的移行](./000028.md)
- [ADR-000029: Connect-RPC Server Streaming認証におけるUserContext完全性の確保](./000029.md)
- [ADR-000030: Connect-RPC Phase 2-3: Feed List / Search エンドポイントの移行](./000030.md)
- [Connect-RPC公式ドキュメント](https://connectrpc.com/)
- [Connect-ES 2.0 Migration Guide](https://buf.build/blog/connect-es-v2)

---

**作成日:** 2025年12月31日
