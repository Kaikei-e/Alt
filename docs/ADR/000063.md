# Docker Volume 権限問題の恒久対策（Init Container パターン）

## ステータス

採択（Accepted）

## コンテキスト

### 問題

Distroless ベースの非 root コンテナが Docker named volume に書き込めず、サービスが正常に動作しなかった。

```
Permission denied (os error 13): writefile '/app/secrets/oauth2_token.env'
```

### 原因分析

| 項目 | 値 |
|------|-----|
| コンテナ実行ユーザー | `nonroot:nonroot` (UID 65532) |
| Volume 所有者 | `root:root` (UID 0) |
| 結果 | 書き込み権限エラー |

Docker named volume はデフォルトで `root:root` 所有で作成される。Distroless イメージはセキュリティのため非 root ユーザーで実行されるため、ファイル書き込みが失敗する。

### 背景

- セキュリティベストプラクティスとして非 root 実行を採用
- Distroless イメージにはシェルがなく、コンテナ内で `chown` 実行不可
- Volume はコンテナ間で共有されるため、権限設定が必要

## 決定

### Init Container パターンの採用

Docker Compose で軽量な init サービスを追加し、依存サービス起動前に volume 権限を設定する。

```yaml
services:
  volume-init:
    image: alpine:latest
    volumes:
      - shared_data:/data
    command: ["sh", "-c", "chown -R 65532:65532 /data && chmod 755 /data"]
    restart: "no"

  app-service:
    depends_on:
      volume-init:
        condition: service_completed_successfully
    # ... 既存設定
```

### 設計方針

1. **Alpine Linux 使用**: 軽量（約 5MB）で chown/chmod が利用可能
2. **service_completed_successfully**: init 完了後にのみ依存サービスを起動
3. **restart: "no"**: 一度だけ実行、その後終了
4. **冪等性**: 何度実行しても同じ結果

## 結果

### メリット

1. **セキュリティ維持**: 本番コンテナは引き続き非 root で実行
2. **Dockerfile 変更不要**: 既存イメージをそのまま使用
3. **透過的**: サービス起動時に自動的に権限設定
4. **Kubernetes 互換**: 同パターンは K8s initContainers でも適用可能

### トレードオフ

1. **起動時間**: init コンテナの実行分（約 1 秒）が追加
2. **Alpine 依存**: Alpine イメージの pull が必要（初回のみ）
3. **Compose ファイル肥大化**: サービス定義が増加

### 代替案の検討

| 代替案 | 却下理由 |
|--------|----------|
| Dockerfile で USER root | セキュリティリスク |
| Volume driver オプション | Docker Compose では制限あり |
| Host bind mount | ポータビリティ低下 |
| Root で実行 | セキュリティベストプラクティス違反 |

## 実装

### 実装日: 2026-01-08

### 修正ファイル

| ファイル | 変更内容 |
|---------|---------|
| `compose/workers.yaml` | `oauth-token-init` サービス追加 |
| `compose/workers.yaml` | 関連サービスに `depends_on` 追加 |

### 検証コマンド

```bash
# Volume 権限確認
docker run --rm -v <volume_name>:/data alpine ls -la /data

# Init コンテナログ確認
docker logs <project>-<init-service>-1
```

## 関連

- [Docker: Use volumes](https://docs.docker.com/storage/volumes/)
- [Kubernetes: Init Containers](https://kubernetes.io/docs/concepts/workloads/pods/init-containers/)
- [Distroless Container Images](https://github.com/GoogleContainerTools/distroless)
- [Docker Security Best Practices](https://docs.docker.com/develop/security-best-practices/)
