# Tag Trail記事検索の改善（タグ名検索への変更）

## ADR's STATUS

Accepted

## CONTEXT

ADR-167で実装したTag Trail機能において、タグをクリックしても同じ記事に繰り返しジャンプする問題が発生していた。

### 問題の根本原因

データベース構造に起因する問題：

1. **feed_tagsテーブルの制約**: `(feed_id, tag_name)`でユニーク制約
2. **同一タグ名の複数ID**: 同じタグ名（例: "golang"）でも異なるフィードからは別の`feed_tag_id`が割り当てられる
3. **検索の制限**: 既存APIは`feed_tag_id`で検索するため、1つのフィードの記事しか取得できない

### データベース統計

```
feed_tags: 209,717件のユニークタグ
articles: 21,177件
→ ほぼ1:1の比率（1タグ≒1記事）
```

### 既存API

```
GET /v1/articles/by-tag?tag_id=<feed_tag_id>
```

このAPIは`article_tags.feed_tag_id`で検索するため、特定フィードのタグに紐づく記事のみを返していた。

## DECISION MAKING

### 方針

**タグ名（tag_name）による横断検索**を実装し、全フィードを跨いで同じタグ名を持つ記事を取得可能にする。

### API設計

```
GET /v1/articles/by-tag?tag_name=<タグ名>&tag_id=<feed_tag_id>
```

- `tag_name`が指定された場合: 全フィード横断でそのタグ名を持つ記事を検索
- `tag_id`のみの場合: 従来通りの動作（後方互換性維持）

### 新規SQLクエリ

```sql
SELECT DISTINCT a.id, a.title, a.url, a.created_at, a.feed_id,
       COALESCE(f.title, '') as feed_title
FROM articles a
INNER JOIN article_tags at ON a.id = at.article_id
INNER JOIN feed_tags ft ON at.feed_tag_id = ft.id
LEFT JOIN feeds f ON a.feed_id = f.id
WHERE ft.tag_name = $1
ORDER BY a.created_at DESC, a.id DESC
LIMIT $2
```

`DISTINCT`により、複数のfeed_tag_idから同一記事が重複取得されることを防止。

## RESULTS, EFFECTS

### 変更ファイル一覧

| コンポーネント | ファイル | 変更内容 |
|--------------|---------|---------|
| alt-backend | `driver/alt_db/fetch_articles_by_tag_driver.go` | `FetchArticlesByTagName()`メソッド追加 |
| alt-backend | `port/fetch_articles_by_tag_port/port.go` | `FetchArticlesByTagName`インターフェース追加 |
| alt-backend | `gateway/fetch_articles_by_tag_gateway/gateway.go` | `FetchArticlesByTagName`実装追加 |
| alt-backend | `usecase/fetch_articles_by_tag_usecase/usecase.go` | `ExecuteByTagName()`メソッド追加 |
| alt-backend | `usecase/fetch_articles_by_tag_usecase/usecase_test.go` | `ExecuteByTagName`テスト追加 |
| alt-backend | `rest/article_handlers.go` | `tag_name`パラメータ対応 |
| alt-frontend-sv | `src/lib/api/client/tagTrail.ts` | `tagName`パラメータ追加 |
| alt-frontend-sv | `src/lib/components/mobile/tag-trail/TagTrailScreen.svelte` | タグ名による検索に変更 |

### APIインターフェース変更

| パラメータ | 必須 | 説明 |
|-----------|-----|------|
| `tag_name` | いずれか必須 | タグ名による横断検索（優先） |
| `tag_id` | いずれか必須 | 従来のfeed_tag_idによる検索 |
| `cursor` | 任意 | ページネーションカーソル（RFC3339） |
| `limit` | 任意 | 取得件数（デフォルト20、最大100） |

### PROS

1. **複数記事の取得**: 同じタグ名を持つ記事を全フィード横断で取得可能
2. **後方互換性**: `tag_id`のみでの呼び出しは従来通り動作
3. **既存UI互換**: フロントエンドの変更は最小限（APIパラメータ追加のみ）
4. **TDD実装**: 新規メソッドにはユニットテストを先行実装

### CONS, TRADEOFF

1. **クエリ負荷**: `feed_tags.tag_name`での検索は`feed_tag_id`より若干遅い可能性
2. **インデックス検討**: 大規模データでは`feed_tags(tag_name)`へのインデックス追加を検討

## APPENDIX

### 検証コマンド

```bash
# タグ名による記事検索
curl "http://localhost:9000/v1/articles/by-tag?tag_name=golang"

# 期待: count > 1（複数フィードからの記事）

# ログ確認
docker compose -f compose/compose.yaml -p alt logs alt-backend --since 5m | grep -i "articles by tag"
# 期待: "fetched articles by tag name from database" ... "count":N (N > 1)

# テスト実行
cd alt-backend/app && go test ./usecase/fetch_articles_by_tag_usecase/... -v
```

### シーケンス図

```
┌──────────┐      ┌───────────┐      ┌───────────┐      ┌─────────┐
│ Frontend │      │  Handler  │      │  Usecase  │      │   DB    │
└────┬─────┘      └─────┬─────┘      └─────┬─────┘      └────┬────┘
     │                  │                  │                  │
     │ GET /articles/by-tag?tag_name=golang                   │
     │─────────────────>│                  │                  │
     │                  │                  │                  │
     │                  │ ExecuteByTagName │                  │
     │                  │─────────────────>│                  │
     │                  │                  │                  │
     │                  │                  │ FetchArticlesByTagName
     │                  │                  │─────────────────>│
     │                  │                  │                  │
     │                  │                  │  SELECT DISTINCT │
     │                  │                  │  WHERE ft.tag_name = 'golang'
     │                  │                  │<─────────────────│
     │                  │                  │                  │
     │                  │  []*TagTrailArticle (複数フィード)  │
     │                  │<─────────────────│                  │
     │                  │                  │                  │
     │  JSON Response   │                  │                  │
     │<─────────────────│                  │                  │
     │                  │                  │                  │
```

### 関連ADR

- ADR-167: Tag Trail機能の追加
- ADR-168: オンザフライタグ生成実装
