# ADR-000300: GetFeedIDByURL リグレッション修正 — feed_links.id と feeds.id の混同による FK 違反

## ADR's STATUS

Accepted

## CONTEXT

ADR-000299 Fix #3 で `GetFeedIDByURL` のクエリ対象テーブルを `feeds` から `feed_links` に変更した。変更前のクエリはウェブサイト URL が格納されている `feeds.link` を参照しており、RSS URL での検索が常に失敗していた。

修正後のクエリは以下であった:

```sql
SELECT id FROM feed_links WHERE url = $1
```

このクエリは `feed_links` テーブルから正しく RSS URL を検索できるようになったが、返却される `id` は `feed_links.id`（RSS URL レジストリの PK）であり、呼び出し元が期待する `feeds.id`（フィードメタデータの PK）とは異なる値であった。

### スキーマ上の関係

```
feed_links.id       = feed_link_id（RSS URL レジストリの PK）
feeds.id            = feed_id（フィードメタデータの PK）
feeds.feed_link_id  = feed_links.id への FK
articles.feed_id    = feeds.id への FK
```

### 影響

`GetFeedIDByURL` の返却値は以下の箇所で `feeds.id` として使用される:

- `save_article_driver.go` — `articles.feed_id` に INSERT する際の値
- Connect-RPC `GetFeedID` ハンドラ — pre-processor が `CreateArticle` リクエストの `feed_id` に設定

`feed_links.id` を `articles.feed_id` に INSERT すると、`articles.feed_id → feeds.id` の外部キー制約に違反し、新規記事の保存が失敗する。結果として、RSS フィードから取得した最新記事がデータベースに保存されず、フロントエンドに表示されない状態となっていた。

## DECISION MAKING

`feed_links` テーブルで RSS URL を検索し、`feeds.feed_link_id` FK を経由して `feeds.id` を取得する JOIN クエリに変更する。

```sql
SELECT f.id
FROM feeds f
INNER JOIN feed_links fl ON f.feed_link_id = fl.id
WHERE fl.url = $1
```

### 他の選択肢を採用しなかった理由

- **`feed_links.id` を返して呼び出し元で変換**: 呼び出し元が複数箇所に分散しており、変換ロジックの漏れが発生しやすい。データソース側で正しい値を返すのが Clean Architecture の Driver 層の責務である
- **サブクエリ `(SELECT feed_link_id FROM feeds WHERE ...)`**: 逆方向の参照となり、`feeds` テーブルに該当行がない場合の挙動が異なる。JOIN の方が意図が明確で、実行計画も最適化されやすい

## RESULTS, EFFECTS

### PROS

- **記事保存の正常化**: `articles.feed_id` に正しい `feeds.id` が設定され、FK 制約違反が解消される
- **フィード収集パイプラインの復旧**: RSS フィードから取得した記事が正常にデータベースに保存され、フロントエンドに表示される
- **単一クエリでの解決**: JOIN により 1 回の DB アクセスで正しい `feeds.id` を取得でき、追加のラウンドトリップが不要

### CONS, TRADEOFF

- `feeds` テーブルに対応する行が存在しない `feed_links` レコードがある場合、INNER JOIN により結果が返らなくなる。ただし、`feeds.feed_link_id` は NOT NULL FK であり、正常なデータでは必ず対応する `feeds` 行が存在するため、実運用上の影響はない

## APPENDIX

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `alt-backend/app/driver/alt_db/feed_url_to_id_driver.go` | 単一テーブルクエリを INNER JOIN クエリに変更 |
| 2 | `alt-backend/app/driver/alt_db/feed_url_to_id_driver_test.go` | モック期待値を JOIN クエリに更新 |
| 3 | `alt-backend/app/driver/alt_db/save_article_driver_test.go` | 内部呼び出しのモックを JOIN クエリに更新 |

### 検証結果

- `go test ./driver/alt_db/...`: 全件 PASS（`GetFeedIDByURL` 関連 3 テスト + `SaveArticle` 関連 2 テスト）
- コンテナ再ビルド・起動後、`GetFeedID failed` エラーの発生件数: **0 件**

---

## 追記: GetFeedIDByURL の二重用途バグ修正

### CONTEXT

ADR-000300 の JOIN 修正により `GetFeedIDByURL` は RSS ソース URL（`feed_links.url`）を正しく検索できるようになったが、`SaveArticle` が同じ関数を **記事 URL** で呼び出していることが判明した。

| 呼び出し元 | 渡す URL | 必要なクエリ |
|-----------|---------|------------|
| `save_article_driver.go` (SaveArticle) | 記事 URL (`https://dev.to/some-article`) | `SELECT id FROM feeds WHERE link = $1` |
| `internal_article_gateway.go` (Connect-RPC GetFeedID) | RSS ソース URL (`https://dev.to/feed`) | JOIN (`feed_links.url`) |
| `feed_url_to_id_gateway.go` (FetchFeedTags) | RSS ソース URL | JOIN (`feed_links.url`) |

JOIN クエリは `feed_links.url` を検索するため、記事 URL では一致せず `feed_id = NULL` となっていた。

### DECISION MAKING

`GetFeedIDByArticleURL` を新設し、`SaveArticle` をそちらに切り替える。既存の `GetFeedIDByURL`（JOIN）は RPC 用にそのまま残す。

```sql
-- GetFeedIDByArticleURL: 記事 URL → feeds.link で検索
SELECT id FROM feeds WHERE link = $1

-- GetFeedIDByURL: RSS ソース URL → feed_links.url で検索（変更なし）
SELECT f.id FROM feeds f INNER JOIN feed_links fl ON f.feed_link_id = fl.id WHERE fl.url = $1
```

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `alt-backend/app/driver/alt_db/feed_url_to_id_driver.go` | `GetFeedIDByArticleURL` 追加 |
| 2 | `alt-backend/app/driver/alt_db/save_article_driver.go` | 呼び出し先を `GetFeedIDByArticleURL` に変更 |
| 3 | `alt-backend/app/driver/alt_db/feed_url_to_id_driver_test.go` | `GetFeedIDByArticleURL` 用テスト 3 件追加 |
| 4 | `alt-backend/app/driver/alt_db/save_article_driver_test.go` | モック期待値を `feeds.link` クエリに更新 |
