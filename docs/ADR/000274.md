# ADR-000274: OGP 画像プロキシ — ドメイン許可リストを article_heads から拡張

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000273 で OGP 画像プロキシを有効化したが、実際のリクエストの大半が **403 "domain not allowed"** で失敗していた。

### 調査結果

nginx ログの分析:

| ステータス | 例 | 原因 |
|-----------|-----|------|
| 200 成功 | フィード購読と一致するドメイン、CDN サフィックスマッチ | `feed_links` テーブルまたは静的 CDN リストに該当 |
| 403 失敗 | OGP 画像専用ドメイン | `feed_links` にも CDN リストにも該当せず |

### 根本原因

`DynamicDomainGateway.IsAllowedImageDomain()` は 3 層で判定していた:

1. 静的 CDN ドメイン (exact match)
2. 静的 CDN サフィックス (`cloudfront.net`, `cloudinary.com` 等)
3. `feed_links` テーブルのドメイン（5 分キャッシュ）

問題は、OGP 画像のドメインがフィード購読ドメインと異なるケースが多いこと:

- フィード URL のドメインと OGP 画像のドメインが別サブドメイン/別ドメインになるパターンが一般的
- `feed_links` には購読フィードの URL しか含まれず、OGP 画像ドメインをカバーできない

一方、`article_heads.og_image_url` にはシステムがスクレイピング済みの全 OGP 画像 URL が保存されており、これらのドメインは全て「システムが知っているドメイン」である。

## 意思決定

### `ListFeedLinkDomains` ドライバーを拡張して `article_heads.og_image_url` からもドメインを収集する

HMAC 署名済み URL のみプロキシされるためオープンプロキシにはならないが、defense-in-depth として「システムが知っているドメインのみ許可」というポリシーは維持する。

`article_heads.og_image_url` に存在するドメインは、システムが記事の `<head>` タグから正規にスクレイピングした URL であり、信頼できるソースとして扱える。

### 変更方針

- **ドライバー層のクエリ拡張のみ** — ポート・ゲートウェイ層の変更は不要
- OGP クエリ失敗は非致命的 — `feed_links` のドメインのみで続行
- 既存の `domainMap` へのマージで重複排除

### 変更内容

#### 1. ドライバー拡張 (`feed_link_domains_driver.go`)

既存の `SELECT DISTINCT url FROM feed_links` に加えて、2 つ目のクエリを追加:

```sql
SELECT DISTINCT og_image_url FROM article_heads
WHERE og_image_url IS NOT NULL AND og_image_url <> ''
```

取得した URL を同じ `domainMap` にマージし、既存のドメイン抽出ロジック（`url.Parse` → `Hostname()` → lowercase 正規化）を再利用。

#### 2. テスト追加 (`dynamic_domain_gateway_test.go`)

OGP 画像ドメイン（フィードドメインと異なる）が正しく許可されることを確認するテストケースを追加。

### 不採用案

| 不採用案 | 理由 |
|---------|------|
| 静的 CDN リストに個別ドメインを追加 | スケールしない。新しいフィード追加のたびにコード変更が必要 |
| ドメイン制限を撤廃 | defense-in-depth ポリシーに反する。HMAC 署名はあるが多層防御を維持すべき |
| 別テーブルで OGP ドメインを管理 | 不要な複雑さ。`article_heads` に既にデータがある |
| ポート・ゲートウェイ層に新しいメソッドを追加 | `DomainLister` インターフェースの変更は不要。ドライバー内部でクエリを追加するだけで十分 |

## 結果・影響

### 動作確認

| 確認項目 | 結果 |
|---------|------|
| ドメイン許可リスト件数 | 修正前: ~75 件 (`feed_links` のみ) → 修正後: 79 件 (マージ後) |
| `article_heads` 内の OGP ドメイン数 | 37 ドメイン（`feed_links` の 50 ドメインとマージ） |
| ゲートウェイテスト | 全 PASS（OGP ドメインテスト含む） |
| ビルド | 成功 |
| コンテナ再起動 | healthy |

### PROS

- ドライバー層のクエリ追加のみの最小限の変更
- `DomainLister` インターフェース変更なし — ゲートウェイ・ユースケース層への影響ゼロ
- OGP クエリ失敗時は `feed_links` のみで継続する graceful degradation
- 新しいフィード追加時、記事スクレイピングが完了すれば自動的に OGP ドメインが許可リストに追加される

### CONS, TRADEOFF

- `article_heads` テーブルへの追加クエリが 5 分に 1 回発生（キャッシュ TTL に依存）。`DISTINCT og_image_url` のクエリコストはレコード数に比例するが、現時点では問題ないレベル
- 新規フィード追加直後、記事スクレイピングが完了するまでは OGP 画像ドメインが許可リストに含まれない（最大で記事取得完了 + 5 分キャッシュ TTL の遅延）

## 付録

### 変更ファイル一覧

| ファイル | 変更 |
|---------|------|
| `alt-backend/app/driver/alt_db/feed_link_domains_driver.go` | `article_heads.og_image_url` からもドメイン収集するクエリ追加 |
| `alt-backend/app/gateway/image_proxy_gateway/dynamic_domain_gateway_test.go` | OGP 画像ドメインを含むテストケース追加 |

### 関連 ADR

| ADR | 内容 |
|-----|------|
| ADR-000267〜271 | OGP 画像表示の段階的実装 |
| ADR-000272 | OGP 画像プロキシのバックエンド実装（HMAC 署名・キャッシュ・圧縮） |
| ADR-000273 | プロキシ有効化のための Docker Secret 設定 |
| ADR-000274 (本 ADR) | ドメイン許可リストを `article_heads` から拡張 |
