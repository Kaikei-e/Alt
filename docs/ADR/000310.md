# ADR-000310: OGP 画像即時表示システム — 実装完了まとめ

## ADR's STATUS

完了

## CONTEXT

ADR-307〜309 を通じて OGP 画像即時表示システムを段階的に構築した:

- **ADR-307**: RSS XML からの画像 URL 抽出 + バックグラウンドプリフェッチ（`ogp-image-warmer` ジョブ）
- **ADR-308**: 画像プロキシの動的ドメイン許可にサブドメインマッチングを導入
- **ADR-309**: visual-preview モードで OGP 画像が表示されないバグの修正（`connectFeedToRenderFeed` のフィールド欠落）

これらの実装過程で、以下の追加対応が必要になった:

1. **SSRF バリデータの URL エンコード制限が CDN URL と非互換**: `%2e`（`.`）/ `%2f`（`/`）のブロックにより、CDN の画像パスが拒否される
2. **フロントエンドの認証トークン取得が冗長**: Connect-RPC の server transport 作成時に毎回 auth-hub の `/session` を呼び出していた
3. **内部 API の `GetArticleContentResponse` にユーザー識別子が不足**: 下流サービスでの記事所有者追跡が不可能
4. **`articlePrefetcher` の OGP 画像対応不足**: キャッシュに OGP 画像 URL を保持する仕組みがなかった

## DECISION MAKING

### 1. SSRF バリデータの `%2e`/`%2f` ブロック解除

CDN（Cloudinary, Imgix 等）は画像パスに `%2F` や `%2C` を正当に使用する。`%2e%2e` によるパストラバーサルは Go の `url.Parse` がデコード後に `".."` として検出するため、エンコード段階でのブロックは不要。

**変更後のブロック対象**（危険なパターンのみ）:
- `%00`（null byte）
- `%0a` / `%0d`（改行・復帰）
- `%5c`（バックスラッシュ）

### 2. `createServerTransportWithToken()` の導入

`hooks.server.ts` で取得済みの backend token を直接渡す関数を新設した。これにより server-side rendering 時の auth-hub `/session` 呼び出しを削減する。

```
従来: hooks.server.ts → auth-hub → token取得 → transport作成時に再度 auth-hub → token取得
改善: hooks.server.ts → auth-hub → token取得 → token を transport に直接渡す
```

### 3. `GetArticleContentResponse` への `user_id` 追加

内部 API レスポンスに `user_id` フィールドを追加し、下流サービス（pre-processor 等）での記事所有者追跡を可能にした。

```protobuf
message GetArticleContentResponse {
  string article_id = 1;
  string title = 2;
  string content = 3;
  string url = 4;
  string user_id = 5;  // 追加
}
```

### 4. `articlePrefetcher` の OGP 画像キャッシュ対応

フロントエンドの `articlePrefetcher` に以下を追加:

- `ogImageCache`: OGP 画像 URL を feed URL をキーとしてキャッシュ
- `onOgImageFetched` コールバック: 画像キャッシュ完了時に UI を通知
- `seedCache()` の拡張: `ogImageProxyUrl` を受け取り、プロキシ URL 優先でキャッシュに投入
- キャッシュ容量超過時の OGP 画像エントリ同時削除

### 5. 画像キャッシュ TTL の 24 時間延長

`ImageProxyCacheTTL` を 12 時間から 24 時間に変更（`CacheTTLMin` デフォルト: 1440）。プリフェッチ済み画像がユーザー閲覧前に期限切れになるリスクを低減する。

## RESULTS, EFFECTS

### PROS

- CDN 画像 URL が SSRF バリデータで誤ブロックされなくなった（パストラバーサル防御は維持）
- auth-hub への冗長な `/session` 呼び出しが削減され、SSR のレイテンシが改善
- 下流サービスで記事の所有者を追跡可能になった
- フロントエンドの OGP 画像表示がキャッシュ対応によりスムーズになった
- SSRF 防御は null byte・改行・バックスラッシュのブロック + Go の `url.Parse` によるパストラバーサル検出 + 接続時 IP 検証の多層防御を維持

### CONS, TRADEOFF

- `%2e`/`%2f` のブロック解除により、URL エンコードされたパスを使う攻撃パターンへの表面的な防御層が1つ減る。ただしデコード後の `".."` チェックと接続時 IP 検証で実質的な防御は維持される
- `user_id` の proto フィールド追加により、内部 API の応答サイズが微増する
- `articlePrefetcher` のキャッシュ（`ogImageCache`, `articleIdCache`）によりクライアントサイドのメモリ使用量が微増する（上限 10 エントリで制御）

## APPENDIX

### 変更対象ファイル（ADR-307〜309 で未記載分）

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `alt-backend/app/utils/security/ssrf_validator.go` | `%2e`/`%2f` ブロック解除、危険パターンのみ維持 |
| 2 | `alt-backend/app/utils/security/ssrf_validator_test.go` | CDN URL パターンの許可テスト追加 |
| 3 | `alt-frontend-sv/src/lib/connect/transport-server.ts` | `createServerTransportWithToken()` 新設 |
| 4 | `alt-frontend-sv/src/lib/utils/articlePrefetcher.ts` | OGP 画像キャッシュ、article ID キャッシュ、seedCache 拡張 |
| 5 | `proto/services/backend/v1/internal.proto` | `GetArticleContentResponse` に `user_id` 追加 |
| 6 | `proto/clients/preprocessor-backend/v1/internal.proto` | 同上（クライアント側 proto） |
| 7 | `alt-backend/app/connect/v2/internal/handler.go` | `GetArticleContent` で `UserID` マッピング |
| 8 | `alt-backend/app/connect/v2/internal/handler_test.go` | イベント発行テスト追加 |
| 9 | `alt-backend/app/gateway/image_fetch_gateway/image_fetch_gateway.go` | SSRF バリデータ統合、多層防御 |
| 10 | `alt-backend/app/gateway/image_fetch_gateway/image_fetch_gateway_test.go` | テスト用 localhost 対応 |
| 11 | `alt-backend/app/gateway/internal_article_gateway/gateway.go` | `UserID` フィールドマッピング |
| 12 | `alt-backend/app/port/internal_article_port/port.go` | `ArticleContent` に `UserID` 追加 |
| 13 | `alt-backend/app/config/config.go` | `CacheTTLMin` デフォルト 1440 に変更 |
| 14 | `alt-backend/app/domain/image_proxy.go` | `ImageProxyCacheTTL` 24 時間化 |
| 15 | `alt-frontend-sv/src/lib/connect/transport-server.test.ts` | transport-server テスト（新規） |
| 16 | `alt-frontend-sv/src/lib/utils/articlePrefetcher.test.ts` | articlePrefetcher テスト（新規） |

### proto 生成ファイル更新（自動生成）

| # | ファイル |
|---|---------|
| 1 | `alt-backend/app/gen/proto/alt/feeds/v2/feeds.pb.go` |
| 2 | `alt-backend/app/gen/proto/services/backend/v1/internal.pb.go` |
| 3 | `alt-butterfly-facade/internal/gen/proto/alt/feeds/v2/feeds.pb.go` |
| 4 | `alt-frontend-sv/src/lib/gen/alt/feeds/v2/feeds_pb.ts` |
| 5 | `pre-processor/app/gen/proto/clients/preprocessor-backend/v1/internal.pb.go` |
| 6 | `pre-processor/app/gen/proto/clients/mqhub/v1/mqhub.pb.go` |
| 7 | `pre-processor/app/gen/proto/clients/mqhub/v1/mqhubv1connect/mqhub.connect.go` |
| 8 | `rag-orchestrator/internal/gen/proto/alt/feeds/v2/feeds.pb.go` |
| 9 | `search-indexer/app/gen/proto/clients/backend/v1/internal.pb.go` |

### 関連 ADR

- [ADR-307](000307.md): RSS XML からの OGP 画像 URL 抽出とバックグラウンドプリフェッチ
- [ADR-308](000308.md): 画像プロキシのドメイン許可リストにサブドメインマッチングを導入
- [ADR-309](000309.md): visual-preview OGP 画像非表示バグの修正
