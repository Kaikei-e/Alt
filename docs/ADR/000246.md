# ADR-000246: pre-processor-db 分離 — alt-db 依存の完全解消

## STATUS

Accepted (Phase 1〜4 実装完了、Phase 5 未実施)

## CONTEXT

### 背景

ADR-000241 で「Shared Database アンチパターンの解消」方針を決定し、search-indexer・tag-generator は Connect-RPC 経由へ移行済み。しかし pre-processor は以下 5 テーブルを alt-db 上に直接保持しており、alt-db への依存が残存していた。

| テーブル | 用途 | 書込元 | 読取元 |
|---------|------|--------|--------|
| `inoreader_subscriptions` | Inoreader フィード一覧 | sidecar | pre-processor |
| `inoreader_articles` | Inoreader 生記事 | sidecar | pre-processor |
| `sync_state` | 同期状態/継続トークン | sidecar | sidecar |
| `api_usage_tracking` | API レート制限追跡 | sidecar | sidecar |
| `summarize_job_queue` | 要約ジョブキュー | pre-processor | pre-processor |

さらに quality checker が alt-db の `articles`/`article_summaries` テーブルに `pgxpool.Pool` で直接アクセスしていた。

### 目標

1. pre-processor 専用の `pre-processor-db` を新設し、5 テーブルを完全移行
2. quality checker の alt-db 直接アクセスを Connect-RPC API 化
3. pre-processor の alt-db 依存をゼロにする

## DECISION MAKING

5 フェーズの段階的移行を採用。各フェーズはロールバック可能な設計とし、環境変数の有無でフォールバックできるようにした。

| Phase | 内容 | ロールバック方法 |
|-------|------|----------------|
| 1 | DB インフラ構築 | コンテナ削除 |
| 2 | Dual Pool 接続分離 | `PP_DB_HOST` 環境変数削除 |
| 3 | データ移行 + sidecar 切替 | sidecar の `DB_HOST` を `db` に戻す |
| 4 | quality checker API 化 | (コード変更のため revert) |
| 5 | alt-db クリーンアップ | マイグレーション revert |

### 代替案

| 代替案 | 却下理由 |
|--------|---------|
| alt-db 内でスキーマ分離 | 同一インスタンスではリソース競合・権限管理が不十分 |
| 全テーブルを Connect-RPC 化 | Inoreader テーブルは sidecar も直接書込。API 化はオーバーエンジニアリング |
| BigBang 移行 | ダウンタイムが長く、切り戻しが困難 |

## RESULTS, EFFECTS

### Phase 1: pre-processor-db インフラ構築

recap-migration-atlas パターンを複製し、専用 DB 基盤を構築。

**新規ディレクトリ: `pre-processor-migration-atlas/`**

```
pre-processor-migration-atlas/
  docker/
    Dockerfile                    # arigaio/atlas:0.31.0-alpine ベース
    scripts/
      migrate.sh                  # PP_DB_* 変数で接続、URL エンコード対応
      hash.sh                     # atlas.sum チェックサム生成
  migrations/
    atlas.hcl                     # local/kubernetes/ci env 定義
    schema.hcl                    # 5 テーブルの宣言的スキーマ
    20260215000001_initial.sql    # 5 テーブル統合マイグレーション (全インデックス含む)
```

**統合したマイグレーション元:**
- `20240101003600` (inoreader_subscriptions)
- `20240101003700` + `20240101004200` (inoreader_articles + content 列)
- `20240101003800` + `20251222000001` (sync_state + created_at 列)
- `20240101003900` (api_usage_tracking)
- `20251213000000` (summarize_job_queue)

**Compose 変更:**

| ファイル | 変更内容 |
|---------|---------|
| `compose/ai.yaml` | `pre-processor-db` (postgres:17-alpine, port 5437) + `pre-processor-db-migrator` 追加 |
| `compose/base.yaml` | `pp_db_password` secret + `pre_processor_db_data` volume 追加 |

### Phase 2: pre-processor DB 接続分離 (Dual Pool)

**`driver/ssl_config.go`:**
- `NewDatabaseConfigWithPrefix(prefix string)` を追加。`PP_` prefix で `PP_DB_HOST` 等を読取
- Docker Secrets (`_FILE` suffix) 対応

**`driver/db_connection.go`:**
- `InitPreProcessorDB(ctx) (*pgxpool.Pool, error)` を追加
- MaxConns=10, MinConns=2 の専用プール

**`bootstrap/wire.go`:**
- `PP_DB_HOST` 設定時: `InitPreProcessorDB()` で pre-processor-db に接続
- 未設定時: alt-db にフォールバック (後方互換)
- `BACKEND_API_URL` + `PP_DB_HOST` 両方設定時: alt-db 接続不要

### Phase 3: データ移行 + sidecar 接続先変更

**`scripts/migrate-pre-processor-db.sh`:**
- 5 テーブルを FK 依存順序で pg_dump → import
- シーケンスリセット (`summarize_job_queue_id_seq`)
- 行数整合性検証

**sidecar 変更:**

| ファイル | 変更内容 |
|---------|---------|
| `compose/workers.yaml` | `DB_HOST=pre-processor-db`, `DB_NAME=pre_processor` |
| `pre-processor-sidecar/app/config/config.go` | DB デフォルト値変更 (Host=`pre-processor-db`, Name=`pre_processor`) |

### Phase 4: quality checker の API 移行

quality checker が alt-db の `article_summaries`/`articles` に `pgxpool.Pool` で直接アクセスしていた箇所を Connect-RPC 経由に変更。

#### 4.1 Proto 追加

`BackendInternalService` に 3 RPC を追加 (clients/services 両方):

```protobuf
rpc DeleteArticleSummary(DeleteArticleSummaryRequest) returns (DeleteArticleSummaryResponse);
rpc CheckArticleSummaryExists(CheckArticleSummaryExistsRequest) returns (CheckArticleSummaryExistsResponse);
rpc FindArticlesWithSummaries(FindArticlesWithSummariesRequest) returns (FindArticlesWithSummariesResponse);
```

#### 4.2 alt-backend 実装 (Clean Architecture)

| レイヤー | ファイル | 内容 |
|---------|---------|------|
| Port | `port/internal_article_port/port.go` | Phase 4 インターフェース 3 つ + `ArticleWithSummaryResult` 構造体 |
| Handler | `connect/v2/internal/handler.go` | `WithPhase4Ports` オプション + 3 メソッド実装 |
| Gateway | `gateway/internal_article_gateway/gateway.go` | Phase 4 gateway 3 メソッド |
| Driver | `driver/alt_db/summary_quality_driver.go` | DELETE / EXISTS / keyset pagination クエリ |
| Server | `connect/v2/server.go` | `WithPhase4Ports(gw, gw, gw)` 登録 |

#### 4.3 pre-processor リファクタ

**`quality-checker/quality_judger.go`:**
- `JudgeArticleQuality(ctx, dbPool, article)` → `JudgeArticleQuality(ctx, summaryRepo, articleRepo, article)`
- `RemoveLowScoreSummary(ctx, dbPool, article, score)` → `RemoveLowScoreSummary(ctx, summaryRepo, articleRepo, article, score)`
- 直接 SQL DELETE → `summaryRepo.Delete(ctx, articleID)` に置換
- `driver.GetArticleByID(ctx, dbPool, ...)` → `articleRepo.FindByID(ctx, articleID)` に置換

**`service/quality_checker.go`:**
- `dbPool *pgxpool.Pool` フィールド削除、`articleRepo repository.ArticleRepository` 追加
- コンストラクタ引数変更: `NewQualityCheckerService(summaryRepo, articleRepo, apiRepo, logger)`

**`repository/interfaces.go`:**
- `SummaryRepository.Delete/Exists` のパラメータ名を `summaryID` → `articleID` に変更
- DB 実装の WHERE 句も `article_id = $1` に統一

**`driver/backend_api/summary_driver.go`:**
- `Delete`, `Exists`, `FindArticlesWithSummaries` を Connect-RPC 経由で実装 (以前は "not available via backend API" エラーを返していた)

**`bootstrap/wire.go`:**
- API モード + PP_DB_HOST 設定時: `driver.Init(ctx)` (alt-db 接続) が不要に
- quality checker は `summaryRepo`/`articleRepo` 経由で alt-backend API を利用

### Phase 5: alt-db クリーンアップ (未実施)

以下を予定:
- alt-db から移行済み 5 テーブルの DROP TABLE マイグレーション
- `compose/db.yaml` から pre-processor 関連ユーザー環境変数の削除
- `db/init/01-create-users.sh` から不要ユーザー作成ロジックの削除
- `migrations-atlas/migrations/schema.hcl` から移行済みテーブル定義の削除

### 変更ファイル一覧

| ファイル | Phase | 変更内容 |
|---------|-------|---------|
| `pre-processor-migration-atlas/` (新規) | 1 | Atlas マイグレーション基盤一式 |
| `compose/ai.yaml` | 1,2 | pre-processor-db 定義 + PP_DB_* 環境変数 |
| `compose/base.yaml` | 1 | secret + volume 追加 |
| `pre-processor/app/driver/ssl_config.go` | 2 | `NewDatabaseConfigWithPrefix()` |
| `pre-processor/app/driver/db_connection.go` | 2 | `InitPreProcessorDB()` |
| `pre-processor/app/bootstrap/wire.go` | 2,4 | Dual Pool → alt-db 完全不要化 |
| `scripts/migrate-pre-processor-db.sh` | 3 | データ移行スクリプト |
| `compose/workers.yaml` | 3 | sidecar の接続先変更 |
| `pre-processor-sidecar/app/config/config.go` | 3 | DB デフォルト値変更 |
| `proto/clients/preprocessor-backend/v1/internal.proto` | 4 | 3 RPC 追加 |
| `proto/services/backend/v1/internal.proto` | 4 | 3 RPC 追加 (server 側) |
| `alt-backend/app/port/internal_article_port/port.go` | 4 | Phase 4 ポートインターフェース |
| `alt-backend/app/connect/v2/internal/handler.go` | 4 | Phase 4 ハンドラ + WithPhase4Ports |
| `alt-backend/app/gateway/internal_article_gateway/gateway.go` | 4 | Phase 4 ゲートウェイ |
| `alt-backend/app/driver/alt_db/summary_quality_driver.go` (新規) | 4 | summary quality DB ドライバ |
| `alt-backend/app/connect/v2/server.go` | 4 | WithPhase4Ports 登録 |
| `pre-processor/app/quality-checker/quality_judger.go` | 4 | dbPool → Repository 化 |
| `pre-processor/app/service/quality_checker.go` | 4 | dbPool 依存除去 |
| `pre-processor/app/repository/interfaces.go` | 4 | Delete/Exists パラメータ名変更 |
| `pre-processor/app/repository/summary_repository.go` | 4 | WHERE 句を article_id に統一 |
| `pre-processor/app/driver/backend_api/summary_driver.go` | 4 | Connect-RPC 実装 |
| `pre-processor/app/service_test/quality_checker_test.go` | 4 | テスト更新 |
| `pre-processor/app/quality-checker/quality_judger_test.go` | 4 | テスト更新 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| `go build ./...` (pre-processor) | pass |
| `go build ./...` (alt-backend) | pass |
| `go test ./service_test/...` (quality checker) | 10 tests passed |
| `go test ./quality-checker/...` (quality judger) | 28 tests passed |
| `go test ./driver/alt_db/...` (alt-backend) | pass |
| pre-processor-db テーブル作成 | 5 テーブル + atlas_schema_revisions |
| pre-processor コンテナ起動 | healthy, pre-processor-db に接続 |
| alt-backend コンテナ起動 | healthy |
| pre-processor-sidecar | healthy, pre-processor-db に接続 |

### PROS

1. **Shared Database アンチパターン解消**: pre-processor の alt-db 依存が Phase 4 完了時点でゼロに
2. **独立したスケーリング**: pre-processor-db は pre-processor/sidecar 専用のため、alt-db のリソース競合から解放
3. **段階的移行**: 各 Phase が独立してロールバック可能。環境変数の有無でフォールバック
4. **テスタビリティ向上**: quality checker が `pgxpool.Pool` 直接依存からリポジトリインターフェース依存に変更され、モック可能に
5. **API モードでの alt-db 接続完全不要**: `BACKEND_API_URL` + `PP_DB_HOST` 設定時、`driver.Init()` が呼ばれない

### CONS, TRADEOFF

1. **運用コスト増**: PostgreSQL インスタンスが 1 つ増加 (alt-db, recap-db, pre-processor-db の 3 つ)
2. **データ移行のダウンタイム**: Phase 3 でサービス停止が必要 (数分)
3. **Phase 5 未完了**: alt-db にテーブルが残存。DROP TABLE マイグレーションは別途実施が必要
4. **Connect-RPC オーバーヘッド**: quality checker の Delete/Exists/FindArticlesWithSummaries が DB 直接アクセスからネットワーク経由に変更。レイテンシ微増

## APPENDIX

### Phase 依存関係

```
Phase 1 (DB基盤) → Phase 2 (Dual Pool) → Phase 3 (データ移行)
                                                ↓
                                          Phase 4 (Quality Checker API化)
                                                ↓
                                          Phase 5 (alt-db クリーンアップ)
```

### 関連 ADR

| ADR | 内容 | 関連 |
|-----|------|------|
| 241 | Shared Database アンチパターン解消方針 | 本 ADR の上位方針 |
| 244 | article-sync Phase 1-2 (内部認証 + Inoreader 記事取得) | pre-processor API モードの前提 |
| 245 | UpsertArticles の未登録フィード耐性改善 | pre-processor API モードの前提 |

### pre-processor の DB 接続モード

| 条件 | alt-db | pre-processor-db | 用途 |
|------|--------|-------------------|------|
| `BACKEND_API_URL` 未設定 | 接続 | 接続 (PP_DB_HOST 設定時) | Legacy DB モード |
| `BACKEND_API_URL` + `PP_DB_HOST` | **不要** | 接続 | API モード (推奨) |
| `BACKEND_API_URL` のみ | 接続 | alt-db をフォールバック | API モード (移行中) |
