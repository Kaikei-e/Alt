# pre-processor: 要約リクエストのタイムアウト延長と重複リクエスト防止

## ADR's STATUS

Accepted

## CONTEXT

### 背景

UI からの要約リクエストが異常に遅延（300-400秒待ち）する問題が発生。根本原因の分析により、大きな記事による Map-Reduce リトライループが特定された。

### 問題のメカニズム

```
[大きな記事] → [Map-Reduce: 1リクエスト→4チャンク]
    ↓
[キュー待ち300秒超] → [pre-processor 300秒タイムアウト]
    ↓
[即座にリトライ] → [キューにさらに4リクエスト追加]
    ↓
[キューがさらに増加] → [ループ継続]
```

### 根本原因

| 項目 | 状況 |
|------|------|
| Map-Reduce チャンク数 | 4チャンク/リクエスト |
| pre-processor タイムアウト | 300秒 |
| 実際のキュー待ち時間 | 300-400秒 |
| 結果 | タイムアウト < キュー待ち → 無限リトライ |

タイムアウト（300秒）がキュー待ち時間（300-400秒）より短いため、リクエストがタイムアウトして即座にリトライされ、キューがさらに増加するという悪循環が発生。

## DECISION MAKING

### 採用したアプローチ

2つの対策を組み合わせて実装:

1. **Option A: タイムアウト延長**（即効性）
2. **Option B: 重複リクエスト防止**（恒久対策）

### 修正対象ファイル

| ファイル | 変更内容 |
|----------|----------|
| `pre-processor/app/config/types.go` | タイムアウト延長（300s → 600s） |
| `pre-processor/app/handler/summarize_handler.go` | 重複リクエスト防止ロジック追加 |
| `pre-processor/app/utils/errors/app_context_error.go` | CONFLICT_ERROR (HTTP 409) 追加 |
| `pre-processor/app/handler/summarize_handler_test.go` | 重複防止テスト追加 |

### Option A: タイムアウト延長

```go
// config/types.go
type NewsCreatorConfig struct {
    // Before: default:"300s"
    // After:  default:"600s"
    Timeout time.Duration `json:"timeout" env:"NEWS_CREATOR_TIMEOUT" default:"600s"`
}
```

タイムアウトをキュー待ち時間より長くすることで、リトライループを即座に停止。

### Option B: 重複リクエスト防止

```go
// handler/summarize_handler.go
var processingArticles sync.Map

func (h *SummarizeHandler) HandleSummarize(c echo.Context) error {
    // 既に処理中なら早期リターン（HTTP 409 Conflict）
    if _, loaded := processingArticles.LoadOrStore(req.ArticleID, true); loaded {
        return apperrors.NewConflictContextError(
            "article is already being processed",
            ...
        )
    }
    defer processingArticles.Delete(req.ArticleID)

    // 実際の処理
}
```

同一記事への同時リクエストを検知し、重複を拒否。

## RESULTS, EFFECTS

### 変更内容

#### タイムアウト設定 (config/types.go)

```diff
 type NewsCreatorConfig struct {
     Host    string        `json:"host" env:"NEWS_CREATOR_HOST" default:"http://news-creator:11434"`
     APIPath string        `json:"api_path" env:"NEWS_CREATOR_API_PATH" default:"/api/v1/summarize"`
     Model   string        `json:"model" env:"NEWS_CREATOR_MODEL" default:"gemma3:4b"`
-    Timeout time.Duration `json:"timeout" env:"NEWS_CREATOR_TIMEOUT" default:"300s"`
+    Timeout time.Duration `json:"timeout" env:"NEWS_CREATOR_TIMEOUT" default:"600s"`
 }
```

#### 重複リクエスト防止 (summarize_handler.go)

- `sync.Map` によるインメモリ追跡
- `HandleSummarize` と `HandleStreamSummarize` の両方に適用
- HTTP 409 Conflict で重複リクエストを拒否

#### エラータイプ追加 (app_context_error.go)

```go
// NewConflictContextError creates a conflict error (HTTP 409)
func NewConflictContextError(message, layer, component, operation string, context map[string]interface{}) *AppContextError
```

### 検証結果

- ユニットテスト: 全件パス
- 重複リクエスト防止テスト: パス
- コンテナヘルスチェック: healthy

### PROS

1. **即効性**: タイムアウト延長でリトライループを即座に停止
2. **根本対策**: 重複防止で同一記事の無限リトライを防止
3. **シンプル**: 追加の外部依存なし（sync.Map はメモリ内）
4. **環境変数対応**: `NEWS_CREATOR_TIMEOUT` で調整可能

### CONS, TRADEOFF

1. **インメモリ状態**: コンテナ再起動で追跡状態がリセット（許容範囲）
2. **単一インスタンス前提**: 複数インスタンス時は Redis 等での共有が必要
3. **長いタイムアウト**: 600秒は長いが、キュー待ち時間を考慮すると妥当

## APPENDIX

### デプロイ手順

```bash
# リビルド・再起動
docker compose -f compose/compose.yaml -p alt build pre-processor
docker compose -f compose/compose.yaml -p alt up -d pre-processor

# ログ確認（タイムアウト設定の確認）
docker compose -f compose/compose.yaml -p alt logs pre-processor --tail=20
# "timeout":600000000000 が表示されることを確認
```

### 検証コマンド

```bash
# キュー待ち時間の確認
docker logs news-creator --since 5m 2>&1 | \
  grep -oP 'queue_wait_time_seconds":\s*\K[0-9.]+' | sort -n | tail -5
# 目標: 60秒以下に改善

# 同一記事の重複リクエスト確認
docker logs news-creator --since 10m 2>&1 | \
  grep -oP 'article\.id":\s*"\K[^"]+' | sort | uniq -c | sort -rn | head -5
# 目標: 同一記事の大量リクエストがなくなること
```

### ロールバック手順

```bash
# タイムアウトを元に戻す場合
export NEWS_CREATOR_TIMEOUT=300s
docker compose -f compose/compose.yaml -p alt up -d pre-processor
```

### 将来の改善案

1. **Redis ベースの重複防止**: 複数インスタンス対応
2. **エクスポネンシャルバックオフ**: 503 レスポンス時の段階的リトライ
3. **キュー深度制限**: 一定数以上のリクエストを拒否
