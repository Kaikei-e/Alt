# RT Request Priority Scheduling with Application-Level Preemption

## ステータス

承認済み（2026-02-02）

## 背景

### 課題

news-creatorの`HybridPrioritySemaphore`において、BE（Best-Effort/バッチ）リクエストがLLM生成中に144秒以上スロットを占有し、RT（Real-Time/フロントエンド要約）リクエストが長時間待機する問題が発生していた。

現状の構成：
- 2スロット構成（RT予約1, BE用1）
- OllamaはプリエンプションAPI非対応（FIFOキューのみ）
- BE処理（Recap要約など）は1リクエストあたり60-150秒

### 要件

1. RTリクエストの応答時間を2秒以内に抑える
2. BE処理の飢餓状態を防ぐ
3. 既存APIとの後方互換性を維持

### 研究調査

| 参照 | 内容 |
|------|------|
| [QLLM (2025)](https://arxiv.org/html/2503.09304v1) | エキスパートレベルでのプリエンプション、TTFT大幅削減 |
| [LLM Scheduling Survey](https://www.techrxiv.org/users/994660/articles/1355915) | 優先度キュー、エージング、スロット予約のベストプラクティス |
| [Ollama FAQ](https://docs.ollama.com/faq) | FIFOキューのみ、優先度管理なし |

## 決定事項

### アプローチ選定

| オプション | 評価 | 理由 |
|------------|------|------|
| A. RT予約2スロット | ❌ | BEが完全に飢餓状態、Recap処理不可 |
| **B. アプリレベルプリエンプション** | ✅ | RT即時アクセス、BEグレースフル中断 |
| C. タイムスライス | ❌ | Ollamaはpause/resume非対応 |
| D. 動的スロット再配置 | △ | 単独では144秒ブロック解決せず |

**選択: B. アプリケーションレベルプリエンプション**

### 設計

#### 新規例外・データ構造

```python
class PreemptedException(Exception):
    """Raised when a BE request is preempted for RT priority."""
    pass

@dataclass
class CancellableRequest:
    """Tracks an active request that can be preempted."""
    task_id: str
    cancel_event: asyncio.Event
    start_time: float
    is_high_priority: bool
```

#### プリエンプション機構

```
RTリクエスト到着
    ↓
RTスロット空き？ → Yes → 即時取得
    ↓ No
プリエンプション有効？ → No → キューイング
    ↓ Yes
BE処理中あり？ → No → キューイング
    ↓ Yes
最古BEにキャンセルシグナル送信
    ↓
BEがキャンセルチェックでPreemptedException発生
    ↓
スロット解放 → RTが取得
```

#### キャンセル対応生成

BE（非ストリーミング）リクエストは、生成前後でキャンセルイベントをチェック：

```python
async def _generate_with_cancellation(self, payload, cancel_event, task_id):
    if cancel_event is None:
        return await self.driver.generate(payload)

    if cancel_event.is_set():
        raise PreemptedException(f"Request {task_id} preempted")

    response = await self.driver.generate(payload)
    return response
```

### 設定パラメータ

| 環境変数 | デフォルト | 説明 |
|----------|------------|------|
| `SCHEDULING_PREEMPTION_ENABLED` | `true` | プリエンプション機能の有効/無効 |
| `SCHEDULING_PREEMPTION_WAIT_THRESHOLD_SECONDS` | `2.0` | RTがこの時間以上待機でプリエンプション発動 |

## 結果・影響

### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `gateway/hybrid_priority_semaphore.py` | `PreemptedException`、`CancellableRequest`追加、プリエンプションロジック実装 |
| `gateway/ollama_gateway.py` | キャンセル対応生成、アクティブリクエスト登録/解除 |
| `config/config.py` | プリエンプション設定パラメータ追加 |
| `tests/gateway/test_hybrid_priority_semaphore.py` | プリエンプションテスト12件追加 |
| `tests/config/test_config.py` | 設定テスト4件追加 |

### API互換性

- 外部API変更なし
- 内部例外`PreemptedException`はnews-creator内で処理
- プリエンプトされたBEリクエストは呼び出し元で再試行可能

### テスト結果

```
tests/gateway/test_hybrid_priority_semaphore.py: 34 passed
tests/gateway/test_ollama_gateway.py: 12 passed
tests/config/test_config.py: 21 passed
全体: 178 passed
```

### 動作確認ログ

```json
{
  "msg": "HybridPrioritySemaphore initialized",
  "total_slots": 2,
  "rt_reserved": 1,
  "be_slots": 1,
  "preemption_enabled": true,
  "preemption_wait_threshold": 2.0
}
```

## 利点

### RT応答性の向上

- RTリクエストが最大2秒でスロット取得可能
- フロントエンド要約のユーザー体験改善

### 柔軟な制御

- 環境変数でプリエンプションの有効/無効を切り替え可能
- 閾値の調整でプリエンプション頻度を制御

### 後方互換性

- 既存のエージング機構と共存
- RT/BE優先度キューの動作は維持

## トレードオフ

### BE処理の中断

- プリエンプトされたBE処理は途中結果を破棄
- 再試行が必要な場合、計算リソースが無駄になる可能性

### 複雑性の増加

- キャンセルイベントの管理が追加
- テストケースの増加

### 制約

- Ollamaの生成中は真のプリエンプション不可（生成完了まで待機）
- 長時間の単一生成ではプリエンプション効果が限定的

## ロールアウト計画

1. `SCHEDULING_PREEMPTION_ENABLED=false`でデプロイ
2. ステージング環境で有効化、24時間負荷テスト
3. 本番で有効化（閾値10秒）
4. 監視後、閾値を2秒に調整

## 関連ADR

- ADR-140: Hybrid RT/BE Priority Semaphore
- ADR-139: OLLAMA_NUM_PARALLEL設定の自動同期
