# ADR-000212: 未読/既読フィードの視覚的区別の改善（GetAllFeeds に is_read フィールド追加）

## STATUS

Accepted（実装完了・コンテナ再ビルド・ヘルスチェック確認済み）

## CONTEXT

### 背景

Desktop `/sv/feeds` ページの「全フィード」表示（`unreadOnly=false`）では、未読と既読のフィードが視覚的に区別できなかった。`DesktopFeedCard.svelte` には `isRead` プロパティと `opacity-60` + "Read" バッジの処理が実装済みだったが、**データが一切渡っていなかった**。

### 根本原因

1. Proto の `FeedItem` メッセージに `is_read` フィールドが存在しない
2. `FetchAllFeedsListCursor` DB クエリが `read_status` テーブルを JOIN していない
3. `FeedGrid` が `DesktopFeedCard` に `isRead` を渡していない

### UI/UX の課題

既存の既読表示は `opacity-60` のみで、以下の問題があった:

- 色のみに依存する区別は WCAG アクセシビリティガイドラインに準拠しない
- `opacity` はホバーやインタラクション状態と干渉する
- 既読/未読の区別が視覚的に不十分

## DECISION MAKING

### 方針

全レイヤーを貫通する end-to-end 実装を採用。Proto → DB クエリ → Gateway → Handler → Frontend 型 → コンポーネントまで `is_read` フィールドを追加。

### 既読表示のデザイン選定

業界標準の RSS リーダー UI を調査し、以下の組み合わせアプローチを採用:

| 指標 | 未読フィード | 既読フィード |
|------|------------|------------|
| 左ボーダー | `border-l-[var(--alt-primary)]`（ティール） | `border-l-transparent` |
| タイトルフォントウェイト | `font-semibold` | `font-normal` |
| タイトル色 | `text-[var(--text-primary)]` | `text-[var(--text-muted)]` |
| 背景色 | `bg-white` | `bg-[var(--surface-hover)]` |
| バッジ | なし | Eye アイコン + "Read" テキスト |

### デザイン根拠

- **左ボーダー**: Alt-Paper テーマの `rounded-none` デザインとの親和性が高い
- **フォントウェイト変更**: 色だけに頼らない WCAG 準拠のアプローチ（色＋形状＋テキスト）
- **CSS カスタムプロパティ使用**: `--surface-hover` は全テーマ（Alt-Paper, Vaporwave, Liquid-Beige）で定義済みのため、テーマ変更時も自動追従
- **`opacity-60` 削除**: 個別プロパティで制御することでホバー等との干渉を排除

## RESULTS

### 変更ファイル一覧

#### Proto (1 file)

| ファイル | 変更内容 |
|---------|---------|
| `proto/alt/feeds/v2/feeds.proto` | `FeedItem` に `bool is_read = 9` 追加 |

#### Backend (5 files)

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/driver/models/feed.go` | `Feed` struct に `IsRead bool` フィールド追加 |
| `alt-backend/app/domain/rss_feed.go` | `FeedItem` struct に `IsRead bool` フィールド追加 |
| `alt-backend/app/driver/alt_db/fetch_feed_driver.go` | `FetchAllFeedsListCursor` に `read_status` テーブルの LEFT JOIN 追加。`COALESCE(rs.is_read, FALSE) AS is_read` で NULL 安全に取得 |
| `alt-backend/app/gateway/fetch_feed_gateway/feeds_gateway.go` | `FetchFeedsListCursor` の models → domain マッピングに `IsRead` 追加 |
| `alt-backend/app/connect/v2/feeds/helpers.go` | `convertFeedsToProto` の domain → proto 変換に `IsRead` 追加 |

#### Backend Tests (1 file)

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/connect/v2/feeds/handler_test.go` | `TestConvertFeedsToProto_IsReadField` 追加（read=true/false の両パターン検証） |

#### Frontend (6 files)

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/src/lib/connect/feeds.ts` | `ConnectFeedItem` に `isRead: boolean` 追加、`convertProtoFeed` 更新 |
| `alt-frontend-sv/src/lib/domain/feed/types.ts` | `Feed` 型に `isRead?: boolean` 追加（`RenderFeed` に自動継承） |
| `alt-frontend-sv/src/lib/api/client/feeds.ts` | `connectFeedToRenderFeed` に `isRead` マッピング追加 |
| `alt-frontend-sv/src/lib/components/desktop/feeds/FeedGrid.svelte` | `DesktopFeedCard` に `isRead={feed.isRead ?? false}` を prop 渡し |
| `alt-frontend-sv/src/lib/components/desktop/feeds/DesktopFeedCard.svelte` | 視覚的改善（左ボーダー、フォントウェイト、背景色、opacity 削除） |
| `alt-frontend-sv/src/lib/queries/feeds.test.ts` | テストの mock データに `isRead: false` 追加 |

#### 自動生成ファイル (buf-generate)

| ファイル | 生成元 |
|---------|--------|
| `alt-backend/app/gen/proto/alt/feeds/v2/feeds.pb.go` | proto |
| `alt-backend/app/gen/proto/alt/feeds/v2/feedsv2connect/feeds.connect.go` | proto |
| `alt-frontend-sv/src/lib/gen/alt/feeds/v2/feeds_pb.ts` | proto |
| `alt-butterfly-facade/internal/gen/proto/alt/feeds/v2/feeds.pb.go` | proto |
| `rag-orchestrator/internal/gen/proto/alt/feeds/v2/feeds.pb.go` | proto |

### DB クエリの変更詳細

`FetchAllFeedsListCursor` の SELECT に以下を追加:

```sql
COALESCE(rs.is_read, FALSE) AS is_read
```

JOIN 条件:

```sql
LEFT JOIN read_status rs ON rs.feed_id = f.id AND rs.user_id = $N
```

- `LEFT JOIN` を使用し、`read_status` にレコードがないフィード（未読）は `FALSE` を返す
- `user_id` でフィルタすることで、ユーザーごとの既読状態を正しく取得
- 既存の `FetchUnreadFeedsListCursor`（未読のみ）は変更なし

## VERIFICATION

### 自動検証

| 検証 | 結果 |
|------|------|
| `go test ./connect/v2/feeds/... -v` | 33 tests PASS（+1 新規テスト） |
| `npx svelte-check --threshold error` | 0 errors, 0 warnings |
| `npx vitest run` | 318 tests PASS (24 test files) |
| `bun run build` | 成功 |

### コンテナ検証

| 検証 | 結果 |
|------|------|
| `docker compose build alt-backend alt-frontend-sv` | 成功 |
| `docker compose up -d alt-backend alt-frontend-sv` | 全コンテナ healthy |
| Backend ヘルスチェック (`/v1/health`) | `{"database":"connected","status":"healthy"}` |
| Frontend ヘルスチェック (`/api/health`) | `{"status":"ok"}` |
| `GetAllFeeds` エンドポイント (backend 直接) | CSRF エラー返却（ルーティング成功） |

## PROS

1. **end-to-end の一貫性**: Proto 定義から UI コンポーネントまで単一の `is_read` フィールドで統一
2. **アクセシビリティ向上**: 色＋形状（左ボーダー）＋テキスト（"Read" バッジ）＋フォントウェイトの 4 重指標で WCAG に準拠
3. **テーマ追従**: CSS カスタムプロパティ使用のため、3 テーマ全てで自動的に適切な表示
4. **非破壊的**: `GetUnreadFeeds`（未読のみ）のクエリ・動作に変更なし。モバイル UI にも影響なし
5. **後方互換**: `is_read` は `bool` のデフォルト値 `false` のため、フィールド未設定時も未読として正しく動作

## CONS, TRADEOFF

1. **GetAllFeeds のみ対応**: `is_read` を返すのは `GetAllFeeds` エンドポイントのみ。`GetUnreadFeeds` は既に未読フィルタ済みのため不要、`GetReadFeeds` は全て既読のため不要
2. **LEFT JOIN のパフォーマンス**: `FetchAllFeedsListCursor` に `read_status` テーブルの LEFT JOIN を追加。インデックス（`feed_id`, `user_id`）が適切に設定されていれば影響は軽微
3. **認証必須化**: `FetchAllFeedsListCursor` は従来認証不要だったが、`user_id` が必要になったため認証必須に変更。実際の利用シーンでは認証済みユーザーのみがアクセスするため影響なし
