# rask-log-forwarder: trace_id/span_id消失バグの修正

## ADR's STATUS

Accepted

## CONTEXT

### 背景

ADR-122でGoサービスのstdoutログにtrace_id/span_idを出力する`TraceContextHandler`を実装したが、ClickHouseに保存されるログのTraceId/SpanIdがすべてゼロになる問題が発生した。

```
期待値: TraceId = "0598be529e48c07669c51a855fd1fcd0"
実際:   TraceId = "00000000000000000000000000000000"
```

### ログ収集フロー

```
Go Service (stdout)
    ↓ {"trace_id":"abc123", "span_id":"def456", ...}
Docker (json-file driver)
    ↓
rask-log-forwarder
    ├─ UniversalParser.parse_docker_log()
    │      ↓ EnrichedLogEntry { trace_id: Some("abc123"), ... }
    ├─ main_processing_loop (変換)
    │      ↓ ParsedLogEntry { fields: {...} }  ← trace_id消失！
    └─ send_log_batch()
           ↓ fields.remove("trace_id") → None
rask-log-aggregator
    ↓
ClickHouse (TraceId = 0x00...)
```

### 根本原因

`rask-log-forwarder/app/src/app/service.rs`の`main_processing_loop`で、`EnrichedLogEntry`から`ParsedLogEntry`への変換時にtrace_id/span_idが失われていた。

**問題のコード (修正前):**
```rust
// service.rs:298-316
Ok(enriched_entry) => {
    let parsed_entry = ParsedLogEntry {
        // ...
        fields: enriched_entry.fields,  // trace_id/span_idは含まれない
    };
}
```

**原因の詳細:**

1. `UniversalParser.parse_docker_log()`がJSONログをパースし、trace_id/span_idを`EnrichedLogEntry`の専用フィールドに抽出
2. この時点で`EnrichedLogEntry.fields`からはtrace_id/span_idが削除済み
3. `main_processing_loop`で`ParsedLogEntry`に変換する際、`enriched_entry.fields`のみをコピー
4. `EnrichedLogEntry.trace_id`と`EnrichedLogEntry.span_id`は無視される
5. `send_log_batch()`が`fields.remove("trace_id")`を呼び出すが、常に`None`を返す

## DECISION MAKING

### 修正方針

`EnrichedLogEntry`→`ParsedLogEntry`変換時に、trace_id/span_idをfieldsに戻す。

**修正後のコード:**
```rust
// service.rs:298-324
Ok(enriched_entry) => {
    // Preserve trace_id/span_id by inserting them back into fields
    let mut fields = enriched_entry.fields;
    if let Some(ref trace_id) = enriched_entry.trace_id {
        fields.insert("trace_id".to_string(), trace_id.clone());
    }
    if let Some(ref span_id) = enriched_entry.span_id {
        fields.insert("span_id".to_string(), span_id.clone());
    }

    let parsed_entry = ParsedLogEntry {
        // ...
        fields,
    };
}
```

### 代替案

1. **ParsedLogEntryにtrace_id/span_idフィールドを追加**: 構造体の変更が大きく、影響範囲が広い
2. **send_log_batchでEnrichedLogEntryを直接使用**: バッチ処理ロジックの大幅な変更が必要

選択した方針は最小限の変更で問題を解決できる。

## RESULTS, EFFECTS

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `rask-log-forwarder/app/src/app/service.rs` | trace_id/span_idをfieldsに戻すロジック追加 |
| `rask-log-forwarder/app/tests/**/*.rs` | テストのEnrichedLogEntry初期化にtrace_id/span_id追加 |

### 修正後のデータフロー

```
Go Service (stdout)
    ↓ {"trace_id":"abc123", "span_id":"def456", ...}
Docker
    ↓
rask-log-forwarder
    ├─ UniversalParser.parse_docker_log()
    │      ↓ EnrichedLogEntry { trace_id: Some("abc123"), fields: {...} }
    ├─ main_processing_loop (変換) ← 修正箇所
    │      ↓ ParsedLogEntry { fields: {"trace_id":"abc123", ...} }
    └─ send_log_batch()
           ↓ fields.remove("trace_id") → Some("abc123")
rask-log-aggregator
    ↓
ClickHouse (TraceId = "abc123")
```

### PROS

1. **最小限の変更**: 1ファイル、約10行の追加のみ
2. **既存テストの通過**: ライブラリテスト99件すべてパス
3. **後方互換性維持**: 外部インターフェースに変更なし
4. **即座に効果**: コンテナ再起動後すぐに正常動作

### CONS, TRADEOFF

1. **冗長な処理**: trace_id/span_idが一度抽出され、再度fieldsに戻される
2. **テストファイルの修正**: 15ファイルのテストヘルパー関数を更新

## APPENDIX

### 検証方法

```bash
# 1. サービスのログにtrace_idが含まれることを確認
docker compose logs auth-hub --tail=5 | grep trace_id

# 2. ClickHouseでtrace_idが正しく保存されていることを確認
docker compose exec clickhouse clickhouse-client \
  --query "SELECT TraceId, SpanId, service_name FROM logs WHERE service_name='auth-hub' ORDER BY timestamp DESC LIMIT 5"

# 3. 特定のtrace_idでログを検索
docker compose exec clickhouse clickhouse-client \
  --query "SELECT * FROM logs WHERE TraceId='<trace_id>' LIMIT 10"
```

### 関連ADR

- ADR-122: Grafana Trace/Log表示問題の修正 (TraceContextHandler導入)
