# tag-generator型チェッカー移行 - pyrightからpyreflyへ

## ADR's STATUS

**承認済み（Accepted）** - 2026年1月3日

## CONTEXT

### 背景

tag-generatorのCIでは型チェッカーとしてpyright（Microsoft製、TypeScript実装）を使用していた。
2025年後半、Meta社がRust実装の高速型チェッカー「pyrefly」をオープンソース化し、
Python型チェックの選択肢が広がった。

### pyrightの課題

| 課題 | 詳細 |
|------|------|
| Node.js依存 | pyrightはTypeScript製のため、CIでNode.jsのインストールが必要 |
| セットアップ複雑化 | Pythonプロジェクトに別言語ランタイムが必要 |
| 設定ファイル分離 | `pyrightconfig.json`が`pyproject.toml`と別に必要 |

### pyreflyの特徴

| 特徴 | 詳細 |
|------|------|
| Rust実装 | 95%高速化（Meta社ベンチマーク） |
| Node.js不要 | Pythonパッケージとして`pip install pyrefly`で完結 |
| pyproject.toml統合 | `[tool.pyrefly]`セクションで設定可能 |
| Django/Pydanticサポート | 本プロジェクトで使用するPydanticに対応 |
| Beta安定版 | v0.42+（2025年11月Beta公開）、現在v0.46.3 |

### 検討した代替案

| ツール | 開発元 | 状態 | 判断 |
|--------|--------|------|------|
| pyright維持 | Microsoft | 安定 | Node.js依存を解消したい |
| ty (Astral) | Astral | v0.0.8 | まだ早期、将来的に検討 |
| **pyrefly** | Meta | Beta v0.46 | **採用** |

## DECISION

pyrightからpyreflyへ移行する。

### 変更内容

#### 1. pyproject.toml - 依存関係更新

```toml
# Before
"pyright>=1.1.390",

# After
"pyrefly>=0.42.0",
```

#### 2. pyproject.toml - pyrefly設定追加

```toml
[tool.pyrefly]
project-includes = ["."]
project-excludes = [
    "**/__pycache__",
    "**/.venv",
    "**/build",
    "**/dist",
    "**/*.egg-info",
]
python-version = "3.13"

# Suppress errors for optional ML dependencies (installed separately in Docker)
[tool.pyrefly.errors]
missing-import = false
missing-module-attribute = false
```

**注**: `missing-import`と`missing-module-attribute`を無効化しているのは、
MLパッケージ（numpy, torch, transformers等）がオプショナル依存関係として
Dockerビルド時に別途インストールされるため。

#### 3. pyrightconfig.json - 削除

pyrefly設定は`pyproject.toml`に統合されたため、不要。

#### 4. CIワークフロー更新

`.github/workflows/reusable-test-python.yaml`:

```yaml
# Before
run: uv run pyright .

# After
run: uv run pyrefly check .
```

#### 5. コンプライアンステスト更新

`tests/unit/test_pyright_compliance.py` → `tests/unit/test_pyrefly_compliance.py`:

```python
# Before
result = subprocess.run(
    [sys.executable, "-m", "pyright", "."],
    ...
)

# After
result = subprocess.run(
    [sys.executable, "-m", "pyrefly", "check", "."],
    ...
)
```

### 型エラー修正

移行時に発見された型エラーを修正：

| ファイル | 修正内容 |
|----------|----------|
| `tag_extractor/extract.py:91` | `onnx_model_path`のNoneチェック追加 |
| `tag_extractor/lazy_model_manager.py:56` | `_total_memory_mb`を`float`型に変更 |
| `tag_extractor/lazy_model_manager.py:98` | `freed_memory`を`float`型に変更 |
| `tag_generator/batch_processor.py:314` | 未使用変数`max_empty_fetches`削除 |

## RESULTS

### CIチェック結果

| チェック | 結果 |
|----------|------|
| pytest | 135 passed |
| ruff check | All checks passed |
| ruff format | 41 files formatted |
| pyrefly | 0 errors (11 suppressed) |
| bandit | 実行完了 |

### 期待される改善

| 指標 | Before (pyright) | After (pyrefly) |
|------|------------------|-----------------|
| Node.js依存 | 必要 | 不要 |
| 設定ファイル | 2ファイル | 1ファイル (pyproject.toml) |
| 型チェック速度 | 基準 | 最大95%高速化 |
| CI簡素化 | - | ランタイム削減 |

## 変更ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `tag-generator/app/pyproject.toml` | pyright→pyrefly、設定追加 |
| `tag-generator/app/pyrightconfig.json` | 削除 |
| `.github/workflows/reusable-test-python.yaml` | pyright→pyrefly |
| `tag-generator/app/tests/unit/test_pyrefly_compliance.py` | 新規（test_pyright_compliance.pyから変更） |
| `tag-generator/app/tag_extractor/extract.py` | 型エラー修正 |
| `tag-generator/app/tag_extractor/lazy_model_manager.py` | 型エラー修正 |
| `tag-generator/app/tag_generator/batch_processor.py` | 未使用変数削除 |

## RELATED

- [pyrefly公式](https://pyrefly.org/)
- [pyrefly GitHub](https://github.com/facebook/pyrefly)
- [Meta Engineering Blog - Introducing Pyrefly](https://engineering.fb.com/2025/05/15/developer-tools/introducing-pyrefly-a-new-type-checker-and-ide-experience-for-python/)
- [Python Tooling 2025](https://laredoute.io/2025/10/01/next-level-python-workflow-uv-ruff-pyright-and-pytest-in-action/)
