# フロントエンド専用開発環境（frontend-dev スタック）

## ステータス

採択（Accepted）

## コンテキスト

### 問題

ADR-060で導入した `dev` スタックは実際のバックエンドとDBを使用するため、以下の課題があった：

1. バックエンドのビルドに時間がかかる
2. DBの起動・マイグレーションが必要
3. フロントエンドのUI開発だけなのにフルスタックが必要

### 背景

- `dev` スタック: mock-auth + alt-frontend-sv + alt-backend + db + migrate
- E2Eテスト用の `mock-server.ts` にはバックエンドAPIのモックも実装済み
- フロントエンド開発の多くはモックデータで十分

### 要件

1. バックエンドとDBなしでフロントエンドを起動
2. 既存のE2Eモックサーバーを再利用
3. Docker / ネイティブ両対応
4. HMR対応
5. **リモートアクセス対応**（別マシンからブラウザでアクセス可能）

## 決定

### アーキテクチャ: フルモック方式

```
┌─────────────────────────────────────────────────────┐
│              frontend-dev スタック                   │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────────────────────────────────────┐  │
│  │              mock-auth                        │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────────────┐ │  │
│  │  │ Kratos  │ │ AuthHub │ │ Mock Backend    │ │  │
│  │  │ :4001   │ │ :4002   │ │ :4003           │ │  │
│  │  └─────────┘ └─────────┘ └─────────────────┘ │  │
│  └──────────────────────────────────────────────┘  │
│                         │                          │
│                         ▼                          │
│              ┌──────────────────┐                  │
│              │  alt-frontend-sv │                  │
│              │      :5173       │                  │
│              │   (Vite + HMR)   │                  │
│              └──────────────────┘                  │
│                                                    │
│              DBなし / バックエンドなし               │
└─────────────────────────────────────────────────────┘
```

### 1. frontend-dev スタックを altctl に追加

```go
// altctl/internal/stack/registry.go
{
    Name:        "frontend-dev",
    Description: "Frontend-only development (mock backend, no database)",
    ComposeFile: "frontend-dev.yaml",
    Services:    []string{"mock-auth", "alt-frontend-sv"},
    DependsOn:   []string{}, // 依存なし - 完全スタンドアロン
    Profile:     "frontend-dev",
    Optional:    true,
}
```

### 2. compose/frontend-dev.yaml

| サービス | ポート | 説明 |
|----------|--------|------|
| mock-auth | 4001, 4002, 4003 | Kratos + AuthHub + Backend モック |
| alt-frontend-sv | 5173, 24678 | SvelteKit（HMR対応） |

### 3. ネイティブ開発用スクリプト

```json
// package.json
{
  "scripts": {
    "dev:mock": "concurrently -k -n mock,vite \"bun run mock-server\" \"bun run dev --host\"",
    "mock-server": "bunx tsx tests/e2e/infra/mock-server.ts"
  }
}
```

### 4. 環境変数設定

`.env.development.local` を作成（gitignore済み）:

```env
# ローカル開発（同一マシン）
ORIGIN=http://localhost:5173
KRATOS_INTERNAL_URL=http://localhost:4001
KRATOS_PUBLIC_URL=http://localhost:4001
AUTH_HUB_INTERNAL_URL=http://localhost:4002
BACKEND_BASE_URL=http://localhost:4003
BACKEND_CONNECT_URL=http://localhost:4003
PUBLIC_API_BASE_URL=http://localhost:4003
BACKEND_TOKEN_SECRET=dev-secret-for-local
```

### 5. リモートアクセス対応

別マシン（例: macOS）からLinuxサーバー上の開発環境にアクセスする場合：

```env
# リモートアクセス（サーバーIPを指定）
ORIGIN=http://192.168.1.100:5173
KRATOS_INTERNAL_URL=http://192.168.1.100:4001
KRATOS_PUBLIC_URL=http://192.168.1.100:4001
AUTH_HUB_INTERNAL_URL=http://192.168.1.100:4002
BACKEND_BASE_URL=http://192.168.1.100:4003
BACKEND_CONNECT_URL=http://192.168.1.100:4003
PUBLIC_API_BASE_URL=http://192.168.1.100:4003
```

**重要**: `ORIGIN` を正しく設定しないと、認証リダイレクト時に別のサーバー（本番等）に飛ばされる。

### 6. mock-server.ts の拡張

E2Eテスト用モックサーバーに以下を追加：

1. **ログイン・登録POST処理**: フォーム送信でセッションクッキーを設定
2. **動的ホスト対応**: `req.headers.host` からフォームactionを生成（リモートアクセス対応）
3. **自動起動**: 直接実行時に全サーバーを起動

```typescript
// POST login/registration - セッションクッキー設定
if (req.method === "POST" && path?.startsWith("/self-service/login")) {
    res.writeHead(303, {
        Location: returnTo,
        "Set-Cookie": `ory_kratos_session=e2e-session; Path=/; HttpOnly`,
    });
    res.end();
    return;
}

// 動的ホスト対応（リモートアクセス用）
const host = req.headers.host || `127.0.0.1:${KRATOS_PORT}`;
const kratosBaseUrl = `http://${host}`;
const loginFlow = {
    ui: {
        action: `${kratosBaseUrl}/self-service/login?flow=${flowId}`,
        // ...
    }
};
```

## 使用方法

### Option A: Docker Compose

```bash
docker compose -f compose/frontend-dev.yaml up
# http://localhost:5173/sv/
```

### Option B: ネイティブ（最速）

```bash
cd alt-frontend-sv
bun install
bun run dev:mock
# http://localhost:5173/sv/
```

### Option C: altctl

```bash
altctl up frontend-dev
```

### Option D: リモートアクセス

```bash
# 1. .env.development.local をサーバーIPに設定
# 2. サーバー起動
bun run dev:mock

# 3. 別マシンからアクセス
# http://<server-ip>:5173/sv/
```

## 結果

### メリット

1. **超高速起動**: 2サービスのみ（devスタックは5サービス）
2. **DB不要**: マイグレーション待ち時間なし
3. **バックエンドビルド不要**: Goのコンパイル時間を節約
4. **ネイティブ対応**: Dockerなしでも開発可能
5. **E2Eインフラ再利用**: 既存モックを100%活用
6. **リモートアクセス対応**: 別マシンからブラウザ開発可能

### トレードオフ

1. **モックデータのみ**: 実際のDBデータは使用不可
2. **API網羅性**: モックは主要エンドポイントのみ実装
3. **バックエンド結合テスト不可**: 結合テストは `dev` スタックを使用
4. **リモート設定**: 別マシンからアクセス時は環境変数の再設定が必要

### スタック比較

| 項目 | frontend-dev | dev | core |
|------|--------------|-----|------|
| サービス数 | 2 | 5 | 10+ |
| DB | なし | あり | あり |
| バックエンド | モック | 実際 | 実際 |
| 用途 | UI開発 | 機能開発 | 本番相当 |

## 実装

### 実装日: 2026-01-08

### 修正ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `compose/frontend-dev.yaml` | 新規: フロントエンド専用Compose |
| `altctl/internal/stack/registry.go` | frontend-dev スタック追加 |
| `alt-frontend-sv/package.json` | dev:mock, mock-server スクリプト追加、tsx/concurrently依存追加 |
| `alt-frontend-sv/.env.development.local` | 新規: 開発用環境変数（ORIGIN含む） |
| `alt-frontend-sv/tests/e2e/infra/mock-server.ts` | POST処理追加、動的ホスト対応、自動起動対応 |

### トラブルシューティング

| 問題 | 原因 | 解決策 |
|------|------|--------|
| 認証後に別サーバーへリダイレクト | ORIGIN未設定 | `.env.development.local` に `ORIGIN` を設定 |
| フォーム送信で接続エラー | localhost vs リモートIP | 環境変数をサーバーIPに変更 |
| モックサーバーに接続できない | ファイアウォール | ポート4001-4003を開放 |
| tsx command not found | 依存関係未インストール | `bun install` を実行 |

## 関連ADR

- ADR-060: SvelteKit開発環境の最小構成スタック（altctl up dev）

## 参考

- compose/frontend-dev.yaml
- alt-frontend-sv/tests/e2e/infra/mock-server.ts
- [Dockerizing SvelteKit](https://khromov.se/dockerizing-your-sveltekit-applications-a-practical-guide/)
