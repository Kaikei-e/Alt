# ADR-000268: OGP 画像取得をバックエンド抽出方式へ移行

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000267 で Visual Preview スワイプモードを実装した際、OGP 画像 URL の抽出はフロントエンド側で行っていた。具体的には、`ArticlePrefetcher` が取得した HTML コンテンツを `ThumbnailExtractor`（regex ベース）で解析し、`ThumbnailPrefetcher`（メモリ + localStorage 2 層キャッシュ）で管理する構成だった。

この方式には以下の課題があった:

1. **重複パース**: バックエンドが既に HTML を取得・解析しているにもかかわらず、フロントエンドで再度 regex パースを行っていた
2. **信頼性**: regex ベースの HTML パースは非標準マークアップで誤抽出のリスクがあった
3. **キャッシュの複雑性**: フロントエンド側に localStorage TTL 管理、エントリ上限管理、メモリキャッシュ同期などの責務が集中していた
4. **コード量**: 抽出・キャッシュ・テストで 4 ファイル（`thumbnailExtractor.ts`, `thumbnailPrefetcher.ts` + 各 spec）が必要だった

### 目的

OGP 画像 URL の抽出をバックエンドに移し、API レスポンスの一部として返却することで、フロントエンドのサムネイル関連モジュールを廃止し、アーキテクチャを簡素化する。

## 意思決定

### 方針

バックエンドの記事取得フロー（`FetchCompliantArticle`）内で HTML の `<head>` セクションから `og:image` を抽出し、DB にキャッシュした上で Proto レスポンスに含めて返却する。フロントエンドは既存の `ArticlePrefetcher` の ogImageCache で受け取るだけとする。

### バックエンド変更

#### DB スキーマ

`article_heads` テーブルを新設し、記事ごとのメタデータをキャッシュする。

| カラム | 型 | 説明 |
|--------|-----|------|
| `id` | UUID | 主キー |
| `article_id` | UUID (UNIQUE) | articles テーブルへの外部参照 |
| `head_html` | TEXT | `<head>` セクション全体（将来の拡張用） |
| `og_image_url` | TEXT (NULLABLE) | 抽出済み HTTPS og:image URL |
| `created_at` | TIMESTAMP | TTL 管理用（12 時間保持） |

#### OGP 抽出ロジック

`html_parser` パッケージに 2 つの関数を追加:

- `ExtractHead(html)` — `<head>` セクションを抽出
- `ExtractOgImageURL(html)` — `meta[property="og:image"]` から HTTPS URL のみを抽出（HTTP は拒否）

goquery による DOM パースを使用し、フロントエンド regex 方式より堅牢。

#### Usecase 拡張

`FetchCompliantArticle` の返り値を 3 値から 4 値（`content, articleID, ogImageURL, err`）に拡張。HTML サニタイズ前の生 HTML から `og:image` を抽出し、`article_heads` テーブルへ best-effort で保存する。既存記事の場合はキャッシュから返却。

#### Proto スキーマ

`FetchArticleContentResponse` に `og_image_url` フィールド（field number 4）を追加。

### フロントエンド変更

#### 廃止

| 削除ファイル | 旧責務 |
|-------------|--------|
| `thumbnailExtractor.ts` | HTML から og:image を regex 抽出 |
| `thumbnailExtractor.spec.ts` | 抽出ロジックのテスト |
| `thumbnailPrefetcher.ts` | 2 層キャッシュ + プリフェッチ管理 |
| `thumbnailPrefetcher.spec.ts` | キャッシュのテスト |

#### 置き換え

`ArticlePrefetcher` に `ogImageCache`（`Map<string, string | null>`）を追加。`prefetchContent` 時に API レスポンスの `og_image_url` をそのままキャッシュする。localStorage は不要となった。

`SwipeFeedScreen` の初回ロード（`loadMore` 内の first-load パス）でも `ogImageCache` への書き込みを追加。

`visual-preview/+page.ts` のルートローダーから `og_image_url` と `article_id` を返却し、`+page.svelte` で `ArticlePrefetcher` のキャッシュに初期値をシードする。

### 不採用案

| 不採用案 | 理由 |
|---------|------|
| フロントエンド regex 方式の維持 | 重複パースの無駄、regex の脆弱性、キャッシュの複雑性 |
| バックエンドでの画像プロキシ | ドメインホワイトリストの制約、帯域コスト |
| og:image をバックエンドで取得するがキャッシュしない | 毎回 HTML 再パースのコスト。article_heads テーブルで回避 |

## 結果・影響

### 変更ファイル一覧

#### バックエンド (alt-backend)

| ファイル | 変更内容 |
|---------|---------|
| `utils/html_parser/ogp_extractor.go` | 新規: `ExtractHead`, `ExtractOgImageURL` |
| `utils/html_parser/ogp_extractor_test.go` | 新規: HTTPS/HTTP/missing/empty テスト |
| `domain/article.go` | 新規: `ArticleHead` struct |
| `driver/alt_db/article_head_driver.go` | 新規: Save/Fetch/Cleanup メソッド |
| `usecase/fetch_article_usecase/fetch_article_usecase.go` | 4 値返却、og:image 抽出・保存 |
| `usecase/fetch_article_usecase/fetch_article_usecase_test.go` | mock 更新 |
| `mocks/mock_article_repository.go` | インターフェース拡張 |
| `connect/v2/articles/handler.go` | `OgImageUrl` フィールド返却 |
| `rest/article_handlers.go` | 4 値受け取り（REST では未使用） |

#### Proto

| ファイル | 変更内容 |
|---------|---------|
| `proto/alt/articles/v2/articles.proto` | `og_image_url` フィールド追加 |
| 各サービスの生成コード (.pb.go, _pb.ts) | buf generate による再生成 |

#### DB マイグレーション

| ファイル | 変更内容 |
|---------|---------|
| `migrations-atlas/migrations/20260226000000_create_article_heads_table.sql` | 新規テーブル |

#### フロントエンド (alt-frontend-sv)

| ファイル | 変更内容 |
|---------|---------|
| `lib/utils/articlePrefetcher.ts` | `ogImageCache` 追加、`getCachedOgImage()` |
| `lib/utils/articlePrefetcher.spec.ts` | og_image_url mock 追加、getCachedOgImage テスト追加 |
| `lib/api/client/articles.ts` | `FeedContentOnTheFlyResponse` に `og_image_url` |
| `lib/connect/articles.ts` | `ogImageUrl` マッピング |
| `lib/components/mobile/feeds/swipe/SwipeFeedScreen.svelte` | ogImageCache 書き込み追加 |
| `lib/components/desktop/feeds/FeedDetailModal.svelte` | 型修正（`og_image_url` フィールド追加） |
| `routes/(app)/feeds/swipe/visual-preview/+page.ts` | og_image_url, article_id 返却 |
| `routes/(app)/feeds/swipe/visual-preview/+page.svelte` | キャッシュシード処理 |
| `lib/utils/thumbnailExtractor.ts` | **削除** |
| `lib/utils/thumbnailExtractor.spec.ts` | **削除** |
| `lib/utils/thumbnailPrefetcher.ts` | **削除** |
| `lib/utils/thumbnailPrefetcher.spec.ts` | **削除** |

### データフロー（変更後）

```
alt-backend                              alt-frontend-sv
┌──────────────────────────────┐  Proto  ┌────────────────────────────┐
│ FetchCompliantArticle        │ ──────→ │ ArticlePrefetcher          │
│  ├─ fetch HTML               │         │  ├─ contentCache (既存)    │
│  ├─ ExtractHead(html)        │         │  ├─ articleIdCache (既存)  │
│  ├─ ExtractOgImageURL(html)  │         │  └─ ogImageCache (新規)   │
│  ├─ sanitize → content       │         │       ↓                   │
│  ├─ save article_heads (DB)  │         │ VisualPreviewCard          │
│  └─ return {content,         │         │  └─ <img src={ogImage}>   │
│       articleId, ogImageUrl} │         │                            │
└──────────────────────────────┘         └────────────────────────────┘
```

### テスト結果

| テストスイート | 結果 |
|--------------|------|
| Backend (`go test ./...`) | PASS |
| Frontend (`pnpm test`) | 418 件全件 PASS（33 ファイル） |
| 型チェック (`svelte-check`) | 0 エラー、0 警告 |

### 検証結果

| 検証項目 | 結果 |
|---------|------|
| コンテナ再ビルド | alt-backend, alt-frontend-sv ビルド成功 |
| DB マイグレーション | article_heads テーブル作成成功 |
| Backend ヘルスチェック (`localhost:9000/v1/health`) | healthy |
| `/sv/feeds/swipe/visual-preview` | HTTP 200 |
| `/sv/feeds/swipe` (既存) | HTTP 200（回帰なし） |

### PROS

- **重複パースの解消**: バックエンドが HTML 取得時に一度だけ抽出し、結果を DB キャッシュ + API レスポンスで配信
- **フロントエンドの簡素化**: localStorage 管理、regex パース、2 層キャッシュが不要に。4 ファイル削除
- **信頼性向上**: goquery による DOM パースは regex より堅牢
- **セキュリティ**: HTTPS URL のみ許可のバリデーションをバックエンド側に集約
- **キャッシュの一貫性**: `ArticlePrefetcher` の既存キャッシュライフサイクル（MAX_CACHE_SIZE=5、dismissed cleanup）に統合

### CONS, TRADEOFF

- **API レスポンスサイズ微増**: `og_image_url` フィールド分（通常 100 バイト未満）
- **DB テーブル追加**: `article_heads` テーブルの運用コスト（12 時間 TTL で自動クリーンアップ）
- **REST API 未対応**: Connect-RPC のみ `og_image_url` を返却。REST ハンドラでは値を破棄（現状 REST 側に Visual Preview 相当の機能がないため問題なし）
- **バックエンドへの依存集中**: OGP 抽出ロジックがバックエンドに閉じるため、フロントエンド単独での抽出ができなくなる

## 付録

### ADR-000267 からの差分

| 項目 | ADR-000267 (旧) | ADR-000268 (本 ADR) |
|------|-----------------|---------------------|
| og:image 抽出 | フロントエンド (regex) | バックエンド (goquery) |
| キャッシュ | localStorage + メモリ 2 層 | DB (article_heads) + ArticlePrefetcher メモリ |
| フロントエンドモジュール | thumbnailExtractor + thumbnailPrefetcher | ogImageCache (ArticlePrefetcher 内蔵) |
| API レスポンス | content, article_id | content, article_id, og_image_url |
| 新規フロントエンドファイル | 4 ファイル | 0 ファイル（既存に統合） |
