# alt-perf: E2Eパフォーマンス計測ツールの導入

## ステータス

**採択・実装完了（Accepted & Implemented）** - 2025年12月31日

## コンテキスト

### 背景

Altプラットフォームは複数のフロントエンド（Next.js、SvelteKit）とバックエンドサービスで構成される。本番環境に近い条件でのパフォーマンス計測とボトルネック発見の仕組みが必要だった。

### 課題

1. **Core Web Vitals計測の欠如**
   - LCP、INP、CLSなどの重要指標を継続的に計測する仕組みがない
   - パフォーマンスリグレッションの早期発見が困難

2. **E2E観点での計測不足**
   - Nginx経由の実際のユーザー体験を反映した計測ができていない
   - 認証済みページのパフォーマンス把握が不十分

3. **計測の自動化**
   - 手動でのLighthouse実行に依存
   - CI/CDパイプラインへの統合が困難

### 制約

- Docker Compose環境での動作（altctlスタックとの統合）
- 認証済みページ（Kratos経由）の計測が必須
- 日本語フォントを含むCJK対応

## 意思決定

### 決定1: Deno + Astralによる実装

**検討した代替案:**

| アプローチ | メリット | デメリット |
|----------|----------|------------|
| Lighthouse CI | 標準的、豊富なレポート | Dockerでの実行が複雑、カスタマイズ困難 |
| Playwright Test | 強力なE2E機能 | パフォーマンス特化ではない |
| **Deno + Astral（採用）** | 軽量、TypeScript native、Puppeteer互換 | 新しいツール、事例が少ない |
| Puppeteer直接 | 成熟、事例多い | Node.js依存、設定が煩雑 |

**採用理由:**
- Denoの単一実行ファイル配布とセキュリティモデル
- Astralの軽量なPuppeteer互換API
- TypeScript first での開発体験

### 決定2: Core Web Vitals 2025基準の採用

| 指標 | Good | Needs Improvement | Poor |
|------|------|-------------------|------|
| LCP (Largest Contentful Paint) | < 2.5s | 2.5s - 4.0s | > 4.0s |
| INP (Interaction to Next Paint) | < 200ms | 200ms - 500ms | > 500ms |
| CLS (Cumulative Layout Shift) | < 0.1 | 0.1 - 0.25 | > 0.25 |
| FCP (First Contentful Paint) | < 1.8s | 1.8s - 3.0s | > 3.0s |
| TTFB (Time to First Byte) | < 800ms | 800ms - 1.8s | > 1.8s |

**設計判断:**
- PerformanceObserver APIによるブラウザ内計測
- 各指標に重み付けしたスコア算出（LCP 25%, INP 25%, CLS 25%, FCP 15%, TTFB 10%）

### 決定3: altctlスタックとしての統合

```yaml
# compose/perf.yaml
services:
  alt-perf:
    build: ../alt-perf
    env_file: ../.env
    environment:
      - PERF_BASE_URL=http://nginx
    networks:
      - alt-network
    profiles:
      - perf
```

**設計判断:**
- `-p alt` プロジェクト名でネットワークを共有
- `.env` から `TEST_EMAIL`/`TEST_PASSWORD` を読み込み
- Kratosへの内部URL (`http://nginx/ory`) 経由で認証

### 決定4: 3つのコマンドモード

| コマンド | 用途 |
|---------|------|
| `scan` | 全ルートのWeb Vitals計測 |
| `flow` | ユーザーフロー（ログイン→操作→ログアウト）テスト |
| `load` | 並行リクエストによる負荷テスト |

## 結果・影響

### 実装内容

#### ディレクトリ構造

```
alt-perf/
├── main.ts                    # CLIエントリポイント
├── deno.json                  # Deno設定・依存関係
├── Dockerfile                 # Google Chrome Stable + Deno
├── src/
│   ├── browser/astral.ts      # ブラウザ自動化ラッパー
│   ├── auth/kratos-session.ts # Kratos認証
│   ├── measurement/vitals.ts  # Web Vitals計測
│   ├── commands/              # scan, flow, load実装
│   ├── report/                # CLI/JSONレポーター
│   └── config/                # YAML設定ローダー
└── config/
    ├── routes.yaml            # 計測対象ルート定義
    ├── thresholds.yaml        # 閾値設定
    └── flows.yaml             # ユーザーフロー定義
```

#### 依存ライブラリ

| ライブラリ | バージョン | 用途 |
|-----------|-----------|------|
| @astral/astral | ^0.5.4 | ブラウザ自動化 |
| @std/cli | ^1.0.0 | コマンドライン解析 |
| @std/yaml | ^1.0.0 | 設定ファイル読み込み |

#### Docker設定

- **ベースイメージ:** `denoland/deno:debian-2.4.0`
- **ブラウザ:** Google Chrome Stable（Puppeteer推奨設定）
- **セキュリティ:** `seccomp:unconfined`, `SYS_ADMIN` cap（Chrome sandbox対応）
- **リソース:** 2GB RAM, 2 CPU cores, 2GB shm_size

### 使用例

```bash
# 全ルートスキャン
make perf-scan

# 詳細ログ付き
docker compose -p alt -f compose/base.yaml -f compose/perf.yaml run --rm alt-perf scan -V

# JSON出力
docker compose -p alt -f compose/base.yaml -f compose/perf.yaml run --rm alt-perf scan --json -o reports/scan.json

# モバイルデバイスのみ
docker compose -p alt -f compose/base.yaml -f compose/perf.yaml run --rm alt-perf scan -d mobile-chrome
```

### 出力例

```
=== Alt Performance Report ===

Summary:
  Base URL: http://nginx
  Duration: 118.80s
  Devices: desktop-chrome, mobile-chrome

  Total Routes: 44
  Passed: 41
  Failed: 3
  Score: 80/100

Route Details:
--------------------------------------------------------------------------------
PASS /desktop/home
     Device: desktop-chrome
     LCP: 1842ms   INP: 145ms   CLS: 0.032
     Score: 95/100
--------------------------------------------------------------------------------
```

### PROS

1. **本番相当の計測**
   - Nginx経由でのE2E計測
   - 認証済みページの計測対応
   - 複数デバイスプロファイル

2. **CI/CD統合性**
   - JSON出力でパイプライン統合可能
   - 閾値ベースのPass/Fail判定
   - Docker Compose環境で完結

3. **拡張性**
   - ユーザーフローテスト対応
   - 負荷テスト機能
   - カスタム閾値設定

### CONS, TRADEOFF

1. **Astralの成熟度**
   - Puppeteerに比べドキュメント・事例が少ない
   - Docker環境での調整が必要だった

2. **計測のオーバーヘッド**
   - 44ルート×2デバイス = 約2分の実行時間
   - 高頻度実行には向かない

3. **Chrome依存**
   - Firefox、Safari での計測には対応していない
   - Chromium固有の挙動に依存

## 付録

### 環境変数

| 変数 | 説明 | デフォルト |
|------|------|-----------|
| `PERF_BASE_URL` | 計測対象のベースURL | `http://localhost` |
| `TEST_EMAIL` | 認証用メールアドレス | - |
| `TEST_PASSWORD` | 認証用パスワード | - |
| `CHROME_BIN` | Chromeバイナリパス | `/usr/bin/google-chrome-stable` |

### Makefileターゲット

```makefile
make perf-scan   # E2Eパフォーマンススキャン
make perf-flow   # ユーザーフローテスト
make perf-build  # alt-perfイメージのビルド
```

### 関連ファイル

| ファイル | 説明 |
|----------|------|
| `alt-perf/` | alt-perfツールのソースコード |
| `alt-perf/CLAUDE.md` | 開発ガイドライン |
| `compose/perf.yaml` | Docker Compose定義 |
| `docs/ADR/000031.md` | altctl ADR（スタック統合の基盤） |

### 今後の拡張可能性

- **Lighthouse統合**: 詳細なパフォーマンス監査レポート
- **履歴トラッキング**: 時系列でのパフォーマンス推移記録
- **アラート機能**: 閾値超過時のSlack/Discord通知
- **分散実行**: 複数ワーカーでの並列計測

---

**作成日:** 2025年12月31日
