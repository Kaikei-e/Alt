# recap-evaluator Clean Architecture リファクタリングとセキュリティ強化

## ADR's STATUS

Accepted (Phase 1-6 実装完了)

## CONTEXT

### 問題点

recap-evaluator は Python 3.13 / FastAPI ベースの評価マイクロサービス (~3,400 LOC)。7 日間 RecapJob の品質を 4 次元 (Genre, Cluster, Summary, Pipeline) で多角的に評価する。運用の中で以下の構造的課題が顕在化:

| # | 分類 | 問題 |
|---|------|------|
| 1 | アーキテクチャ | フラットな構造 (`api/`, `infra/`, `evaluators/`) で Clean Architecture 未適用。ルートハンドラーにアラート集約・データ取得・オーケストレーションが混在 |
| 2 | シングルトン氾濫 | 全コンポーネントがモジュールレベルのシングルトン (`db = Database()`, `ollama_client = OllamaClient()` 等)。テスト時の差し替え不可 |
| 3 | セキュリティ | SQL 文字列補間 (`query % days`)、CORS ワイルドカード (`allow_origins=["*"]`)、設定にデフォルトクレデンシャル、入力バリデーション不足 |
| 4 | パフォーマンス | Ollama 逐次呼び出し、N+1 クエリ (ジョブ毎にステージログ・メトリクスを個別取得)、リクエスト毎の httpx クライアント再生成 |
| 5 | God Class | `summary.py` (432 行) が 4 つのサブ評価器をオーケストレーション。重みがハードコード |
| 6 | テスト不足 | 3 ファイルのみ (rouge, bertscore, faithfulness)。API・DB・Usecase・Handler テストなし |
| 7 | スケジューラ不在 | 定期評価の自動実行機構がなく、手動 API 呼び出しのみ |

### 方針

6 フェーズを一括実施し、ボトムアップ (依存の少ない層から順) にビルド。各ステップで `uv run pytest tests/ -v` 全パス + `uv run ruff check` をゲーティング条件とする。旧コード (`api/`, `infra/`, `evaluators/`) は完全移行後に削除。

## DECISION MAKING

### Phase 1: Port 層導入 + DI 基盤

#### ディレクトリ構造

```
src/recap_evaluator/
├── handler/                      # HTTP ハンドラー (thin)
│   ├── evaluation_handler.py     # POST /evaluations/run, etc.
│   ├── metrics_handler.py        # GET /metrics/latest, /metrics/trends
│   ├── health_handler.py         # GET /health
│   └── schemas.py                # Pydantic スキーマ (from_domain() パターン)
├── usecase/                      # ビジネスロジックオーケストレーション
│   ├── run_evaluation.py         # Full/individual 評価ユースケース
│   ├── get_metrics.py            # メトリクス取得ユースケース
│   └── alert_resolver.py         # アラートレベル一元判定
├── port/                         # Protocol (インタフェース)
│   ├── database_port.py          # DB クエリプロトコル
│   ├── llm_port.py               # Ollama/LLM プロトコル
│   ├── recap_worker_port.py      # Recap-Worker API プロトコル
│   └── evaluation_port.py        # 評価器プロトコル
├── gateway/                      # Port 実装
│   ├── postgres_gateway.py       # asyncpg 実装
│   ├── ollama_gateway.py         # Ollama HTTP クライアント
│   └── recap_worker_gateway.py   # Recap-Worker HTTP クライアント
├── evaluator/                    # 評価ロジック (Port に依存)
│   ├── genre_evaluator.py
│   ├── cluster_evaluator.py
│   ├── summary_evaluator.py
│   ├── pipeline_evaluator.py
│   ├── rouge_eval.py             # CPU-bound (stateless)
│   ├── bertscore_eval.py         # CPU-bound (stateless)
│   └── faithfulness_eval.py      # CPU-bound (stateless)
├── scheduler/
│   └── evaluation_scheduler.py   # APScheduler cron ベース定期評価
├── domain/models.py
├── config.py
├── main.py                       # Composition Root + DI 配線
└── utils/
    ├── logging.py
    └── otel.py
```

#### レイヤー間の依存方向

```
main.py (Composition Root / DI container)
  ├── handler/ → usecase/ → port/ (Protocol only)
  ├── gateway/ implements port/
  └── evaluator/ depends on port/
```

Port 層は `typing.Protocol` (構造的部分型) で定義。ランタイムオーバーヘッドなしで DI を実現。

#### Composition Root (main.py lifespan)

FastAPI の `lifespan` コンテキストマネージャで全レイヤーを配線:

```
lifespan:
  Driver層:  asyncpg pool, httpx.AsyncClient (共有)
  Gateway層: PostgresGateway, OllamaGateway, RecapWorkerGateway
  Evaluator層: Genre, Cluster, Summary, Pipeline
  Usecase層: RunEvaluationUsecase, GetMetricsUsecase
  Scheduler: EvaluationScheduler
  → app.state に Usecase を格納 → Handler から参照
```

### Phase 2: セキュリティ修正

#### 2-1. SQL インジェクション修正 (CRITICAL)

`database.py` の文字列補間 (`query % days`) をパラメタライズドクエリに置換:

```sql
-- Before: WHERE kicked_at >= NOW() - INTERVAL '%s days' (文字列補間)
-- After:
WHERE kicked_at >= NOW() - make_interval(days => $1) AND status = $2
```

全クエリでプレースホルダ (`$1`, `$2`, ...) を使用。

#### 2-2. CORS 設定の強化

```python
# Before: allow_origins=["*"]
# After:
allow_origins=settings.cors_allowed_origins  # 環境変数: CORS_ALLOWED_ORIGINS (カンマ区切り)
```

#### 2-3. デフォルトクレデンシャル削除

`recap_db_dsn` を必須設定に変更 (デフォルト値なし)。未設定時はアプリケーション起動を拒否。

#### 2-4. 入力バリデーション強化

| パラメータ | 変更 |
|-----------|------|
| `window_days` | `int = Field(ge=1, le=90)` |
| `limit` | `int = Field(ge=1, le=100)` |
| `sample_per_job` | `int = Field(ge=1, le=20)` |
| `evaluation_id` | `UUID` 型に変更 |

### Phase 3: パフォーマンス最適化

#### 3-1. Ollama 並行処理

逐次処理から `asyncio.gather` + `asyncio.Semaphore` による制御付き並行処理に変更:

```python
class OllamaGateway:
    def __init__(self, client: httpx.AsyncClient, settings: Settings):
        self._client = client  # 共有 HTTP クライアント
        self._semaphore = asyncio.Semaphore(settings.ollama_concurrency)  # デフォルト: 5
```

#### 3-2. N+1 クエリ解消

ジョブ毎の個別クエリ → `ANY($1)` バッチクエリに統合:

| メソッド | Before | After |
|---------|--------|-------|
| `fetch_stage_logs` | N 回 (ジョブ数分) | 1 回 (`fetch_stage_logs_batch`) |
| `fetch_preprocess_metrics` | N 回 | 1 回 (`fetch_preprocess_metrics_batch`) |
| `fetch_evaluation_by_id` | 100 件取得 → Python ループ | `WHERE evaluation_id = $1` 直接検索 |

#### 3-3. HTTP 接続プール統合

リクエスト毎の `httpx.AsyncClient` 生成 → lifespan で 1 つの共有クライアント (接続プール付き) を全 Gateway で利用:

```python
http_client = httpx.AsyncClient(
    timeout=httpx.Timeout(connect=5, read=settings.ollama_timeout, write=10, pool=5),
    limits=httpx.Limits(max_connections=30, max_keepalive_connections=10),
)
```

#### 3-4. メモリ最適化

`fetch_job_articles` で `LEFT(fulltext_html, 500)` に制限し、大量記事取得時のメモリ消費を抑制。

### Phase 4: テスト戦略

テストディレクトリ構造:

```
tests/
├── conftest.py                    # 共通 fixture
├── fixtures/
│   ├── job_data.py                # テスト用ジョブデータファクトリ
│   └── evaluation_data.py         # 評価結果データファクトリ
├── unit/
│   ├── handler/                   # TestClient + mock usecase
│   ├── usecase/                   # mock port → usecase logic
│   ├── evaluator/                 # 評価ロジック単体テスト
│   ├── gateway/                   # mock asyncpg / httpx
│   ├── domain/                    # 純粋ドメインロジック
│   └── scheduler/                 # スケジューラテスト
└── integration/
    └── test_evaluation_flow.py    # Handler → Usecase → mock Gateway E2E
```

### Phase 5: Domain Model 改善

#### to_dict() 廃止

全 Domain dataclass から `to_dict()` メソッドを削除。Handler 層の Pydantic スキーマに `from_domain()` クラスメソッドを定義し、ドメイン→レスポンス変換を一元化:

```python
class SummaryMetricsResponse(BaseModel):
    @classmethod
    def from_domain(cls, m: SummaryMetrics) -> "SummaryMetricsResponse": ...
```

#### 評価重みの外部化

`EvaluatorWeights` で重みを環境変数から設定可能に:

```python
class EvaluatorWeights(BaseModel):
    geval: float = 0.40
    bertscore: float = 0.25
    faithfulness: float = 0.25
    rouge_l: float = 0.10

    @model_validator(mode="after")
    def validate_sum(self) -> "EvaluatorWeights":
        total = self.geval + self.bertscore + self.faithfulness + self.rouge_l
        if abs(total - 1.0) > 0.001:
            raise ValueError(f"Weights must sum to 1.0, got {total}")
        return self
```

#### アラートロジック一元化

3 箇所に分散していたアラート判定を `AlertResolver.resolve()` に統合。

### Phase 6: Scheduler 実装

APScheduler の `AsyncIOScheduler` + `CronTrigger` で日次定期評価を実現:

| 設定 | 環境変数 | デフォルト |
|------|---------|-----------|
| 有効/無効 | `ENABLE_SCHEDULER` | `true` |
| cron 式 | `EVALUATION_SCHEDULE` | `0 6 * * *` |
| 評価期間 | `EVALUATION_WINDOW_DAYS` | `7` |

lifespan 内でスケジューラを start/stop し、アプリケーションライフサイクルと統合。

## RESULTS, EFFECTS

### PROS

- **テスト数 30 → 117**: 新規 87 テスト追加。全テスト `uv run pytest tests/ -v` パス (117 passed, 4 skipped)
  - Handler 層: 7 テスト (evaluation 5, metrics 3)
  - Usecase 層: 13 テスト (run_evaluation 4, get_metrics 4, alert_resolver 5)
  - Evaluator 層: 22 テスト (genre 7, cluster 4, pipeline 6, summary 5)
  - Gateway 層: 19 テスト (postgres 8, ollama 11)
  - Domain 層: 10 テスト
  - Scheduler: 5 テスト
  - Integration: 3 テスト (E2E フロー)
  - 既存 CPU-bound 評価器: 38 テスト (rouge, bertscore, faithfulness 移行)
- **Clean Architecture 準拠**: プロジェクト標準の `Handler → Usecase → Port → Gateway` パターンを適用。Port 層は `typing.Protocol` で依存方向を厳格に制御
- **セキュリティ強化**: SQL インジェクション修正 (パラメタライズドクエリ)、CORS 制限 (設定ベース)、デフォルトクレデンシャル削除、入力バリデーション範囲制限
- **パフォーマンス改善**: Ollama 並行処理 (Semaphore 制御)、N+1 → バッチクエリ (`ANY($1)`)、直接 ID 検索、HTTP 接続プール共有、メモリ最適化
- **DI 完全化**: モジュールレベルシングルトンを全廃。全依存をコンストラクタ注入で解決し、テスト時にモック差し替え可能
- **定期評価の自動化**: APScheduler cron ベースで日次 06:00 JST に自動評価実行
- **旧コード完全削除**: `api/`, `infra/`, `evaluators/`, `services/` を削除。新旧並存なし
- **コンテナ動作確認済み**: Docker Compose リビルド後に healthy 状態で稼働確認

### CONS, TRADEOFF

- **CPU-bound 評価器の lint 未修正**: 移行した `rouge_eval.py`, `bertscore_eval.py`, `faithfulness_eval.py` に ruff 警告 10 件が残存 (変数命名規約、ClassVar アノテーション等)。ロジック変更なしのため今回未修正
- **Ollama/OTel 依存**: G-Eval 評価は Ollama コンテナ起動時のみ有効。OTel トレースエクスポートはコレクター起動時のみ (機能上は影響なし)
- **カバレッジ 74%**: `main.py` (lifespan), `utils/logging.py`, `utils/otel.py` は外部依存が多くユニットテスト対象外。実質的なビジネスロジックのカバレッジは 90%+

## APPENDIX

### 実施順序と依存関係

```
Step 1:  config.py 改修 (セキュリティ + 構造化 + Weights)
Step 2:  domain/models.py 改善 (to_dict() 廃止)
Step 3:  Port 層定義 (4 Protocol)
Step 4:  テスト基盤 (conftest + fixtures)
Step 5:  Gateway 層 (postgres: SQL 修正 + バッチ, ollama: 並行処理, recap-worker)
Step 6:  Evaluator 層 (genre, cluster, pipeline, summary 分割 + DI 化)
Step 7:  Usecase 層 (RunEvaluation, GetMetrics, AlertResolver)
Step 8:  Handler 層 (evaluation, metrics, health + schemas)
Step 9:  Scheduler (APScheduler + cron)
Step 10: main.py Composition Root + CORS 修正
Step 11: Integration test + 旧コード削除
```

### 変更ファイル一覧

#### 新規ファイル

| ファイル | 内容 |
|----------|------|
| `port/database_port.py` | DatabasePort Protocol (fetch_recent_jobs, batch メソッド等) |
| `port/llm_port.py` | LLMPort Protocol (evaluate_summary, evaluate_batch, health_check) |
| `port/recap_worker_port.py` | RecapWorkerPort Protocol |
| `port/evaluation_port.py` | EvaluatorPort Protocol |
| `gateway/postgres_gateway.py` | asyncpg 実装 (パラメタライズドクエリ, バッチ, 直接 ID 検索) |
| `gateway/ollama_gateway.py` | Ollama HTTP 実装 (Semaphore 並行, 共有クライアント) |
| `gateway/recap_worker_gateway.py` | Recap-Worker HTTP 実装 |
| `evaluator/genre_evaluator.py` | ジャンル評価 (DI 化) |
| `evaluator/cluster_evaluator.py` | クラスタ評価 (DI 化) |
| `evaluator/summary_evaluator.py` | 要約評価 (God Class 分割, 重み注入) |
| `evaluator/pipeline_evaluator.py` | パイプライン評価 (バッチクエリ使用) |
| `usecase/run_evaluation.py` | 評価実行ユースケース |
| `usecase/get_metrics.py` | メトリクス取得ユースケース |
| `usecase/alert_resolver.py` | アラートレベル一元判定 |
| `handler/evaluation_handler.py` | 評価 API ハンドラー |
| `handler/metrics_handler.py` | メトリクス API ハンドラー |
| `handler/health_handler.py` | ヘルスチェックハンドラー |
| `handler/schemas.py` | Pydantic スキーマ (from_domain() パターン) |
| `scheduler/evaluation_scheduler.py` | APScheduler cron ベーススケジューラ |
| `tests/conftest.py` | 共通 fixture (mock_db, mock_ollama, mock_settings) |
| `tests/fixtures/job_data.py` | テスト用ジョブデータファクトリ |
| `tests/fixtures/evaluation_data.py` | 評価結果データファクトリ |
| `tests/unit/**` | 全レイヤーのユニットテスト (87 テスト) |
| `tests/integration/test_evaluation_flow.py` | E2E フローテスト |

#### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `config.py` | シングルトン廃止、`recap_db_dsn` 必須化、`EvaluatorWeights` 追加、CORS 設定追加、Scheduler 設定追加 |
| `domain/models.py` | 全 dataclass から `to_dict()` メソッド削除 |
| `main.py` | Composition Root 化 (lifespan DI 配線)、CORS 制限、Scheduler 統合 |
| `utils/logging.py` | シングルトン `settings` 依存を引数渡しに変更 |

#### 削除ファイル

| ディレクトリ | 理由 |
|-------------|------|
| `api/` (routes.py, schemas.py) | `handler/` に移行完了 |
| `infra/` (database.py, ollama.py) | `gateway/` に移行完了 |
| `evaluators/` (genre.py, cluster.py, pipeline.py, summary.py) | `evaluator/` に移行完了 |
| `services/` | 空ディレクトリ |
| `tests/test_evaluators/` | `tests/unit/evaluator/` に移行完了 |

### 検証結果

```
uv run pytest tests/ -v               # 117 passed, 4 skipped, 0 failed
uv run ruff check (新規コード)          # All checks passed
docker compose build recap-evaluator   # イメージビルド成功
docker compose up -d recap-evaluator   # healthy 状態で起動確認
curl http://localhost:8085/health      # {"status":"healthy","service":"recap-evaluator","version":"0.1.0"}
```
