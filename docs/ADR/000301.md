# ADR-000301: GetFeedIDByURL の二重用途バグ修正 — 記事URL と RSS ソースURL の分離

## ADR's STATUS

Accepted

## CONTEXT

ADR-000300 で `GetFeedIDByURL` のクエリを `feed_links` テーブルとの JOIN に変更し、RSS ソース URL での feed ID 取得を正常化した。しかし、この関数は **2 種類の異なる URL** で呼び出されていた。

### 呼び出しパターン

| 呼び出し元 | 渡される URL の種類 | 例 |
|-----------|-------------------|-----|
| `save_article_driver.go` (SaveArticle) | 記事ページ URL | `https://example.com/posts/hello-world` |
| Connect-RPC `GetFeedID` ハンドラ | RSS ソース URL | `https://example.com/feed/rss.xml` |
| `feed_url_to_id_gateway.go` (FetchFeedTags) | RSS ソース URL | `https://example.com/feed/rss.xml` |

### DB スキーマ上の区別

```
feeds.link         = 記事ページ URL（UNIQUE 制約）
feed_links.url     = RSS ソース URL
feeds.feed_link_id → feed_links.id (FK)
articles.feed_id   → feeds.id (FK)
```

ADR-000300 の JOIN クエリは `feed_links.url`（RSS ソース URL）を検索するため、SaveArticle が記事ページ URL を渡した場合は一致する行が存在せず、`feed_id = NULL` で記事が保存されていた。

### 影響

SaveArticle 経由で保存された記事の `feed_id` が NULL となり、フィードとの紐付けが失われていた。

## DECISION MAKING

**`GetFeedIDByArticleURL` を新設**し、SaveArticle をそちらに切り替える。既存の `GetFeedIDByURL`（JOIN クエリ）は RPC 用途にそのまま残す。

```sql
-- GetFeedIDByArticleURL: 記事ページ URL → feeds.link で検索
SELECT id FROM feeds WHERE link = $1

-- GetFeedIDByURL: RSS ソース URL → feed_links.url で検索（変更なし）
SELECT f.id
FROM feeds f
INNER JOIN feed_links fl ON f.feed_link_id = fl.id
WHERE fl.url = $1
```

### 他の選択肢を採用しなかった理由

- **引数にフラグを追加して分岐**: 呼び出し元がどちらの用途か意識する必要があり、バグの温床になる。関数名で意図を明示する方が安全
- **SaveArticle 内でクエリを直接記述**: Driver 層に DB アクセスを集約する Clean Architecture の原則に反する
- **GetFeedIDByURL を元の `feeds.link` クエリに戻す**: RPC 経由の RSS ソース URL 検索が再び壊れる

## RESULTS, EFFECTS

### PROS

- **記事の feed_id 正常化**: SaveArticle 経由の記事が正しい `feeds.id` で保存される
- **関数名による意図の明示**: `GetFeedIDByArticleURL`（記事 URL）と `GetFeedIDByURL`（RSS ソース URL）で用途が明確
- **既存の RPC パスに影響なし**: `GetFeedIDByURL` は変更せず、Connect-RPC と FetchFeedTags は従来どおり動作
- **テストカバレッジ**: 新関数に対して 3 件のユニットテストを追加

### CONS, TRADEOFF

- Driver 層に類似のクエリを持つ関数が 2 つ存在する。ただし、検索対象テーブル・カラムが異なるため、統合するとかえって複雑になる

## APPENDIX

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `alt-backend/app/driver/alt_db/feed_url_to_id_driver.go` | `GetFeedIDByArticleURL` 追加（`feeds.link` で検索） |
| 2 | `alt-backend/app/driver/alt_db/save_article_driver.go` | 呼び出し先を `GetFeedIDByArticleURL` に変更（1 行） |
| 3 | `alt-backend/app/driver/alt_db/feed_url_to_id_driver_test.go` | `GetFeedIDByArticleURL` 用テスト 3 件追加 |
| 4 | `alt-backend/app/driver/alt_db/save_article_driver_test.go` | モック期待値を `feeds.link` クエリに更新 |

### 検証結果

- `go test ./driver/alt_db/... ./rest/...`: 全件 PASS
- コンテナ再ビルド・起動後、ヘルスチェック正常（`{"status":"healthy"}`）

### 関連 ADR

- ADR-000299: `GetFeedIDByURL` のクエリ対象を `feeds.link` → `feed_links.url` に変更
- ADR-000300: `feed_links.id` と `feeds.id` の混同を JOIN で修正

### スコープ外

`pre-processor` の二次パス（`article_driver.go`）で GetFeedID 失敗時にフォールバックに到達しない問題は別 PR で対応する。
