# ADR-000254: alt-frontend-sv E2E テスト無限スクロールループの修正

## ステータス

承認済み

## コンテキスト

### 背景

CI ワークフロー「Alt Frontend SV Tests」（Playwright E2E）で、`tests/e2e/desktop/feeds/index.spec.ts` の 4 テストが失敗していた。ユニットテストは全て通過しており、E2E テストのみの問題であった。

**失敗テスト:**

| 行 | テスト名 |
|----|---------|
| L58 | opens feed detail modal on card click |
| L77 | closes feed detail modal |
| L89 | marks feed as read and navigates to next feed |
| L174 | auto-fetches article content when modal opens |

### 問題の根本原因

原因は 2 つの要素の複合であった。

**原因 1: モックデータの無限スクロールループ**

`CONNECT_FEEDS_RESPONSE` のモックデータが `hasMore: true` を返していたため、Playwright の `page.route()` が同一レスポンスを返し続け、フロントエンドの無限スクロール機構が無限ループに陥っていた。`hasMore: false` を使用するテスト（ナビゲーション系テスト等）は全て成功していた。

```
page.route() → 常に hasMore: true を返却
→ IntersectionObserver が次ページをリクエスト
→ 同じデータが再度返却 → 再リクエスト → 無限ループ
→ DOM の再描画が継続し、モーダルのクリックが不安定化
```

**原因 2: Playwright コンテナバージョンの不一致**

CI の Docker コンテナイメージが `v1.58.0` であったのに対し、`@playwright/test` パッケージは `^1.58.2` に更新されていた。ブラウザバイナリとテストランナーのバージョン不一致が、タイミング依存のテストを不安定にしていた。

## 意思決定

### 修正 1: モックデータのページネーション終了

`CONNECT_FEEDS_RESPONSE` の `hasMore` を `false`、`nextCursor` を空文字列に変更した。

変更前:
```ts
export const CONNECT_FEEDS_RESPONSE = {
  data: [...],
  nextCursor: "next-cursor-123",
  hasMore: true,
};
```

変更後:
```ts
export const CONNECT_FEEDS_RESPONSE = {
  data: [...],
  nextCursor: "",
  hasMore: false,
};
```

`page.route()` は状態を持たず同じレスポンスを返し続けるため、デフォルトのモックデータでは `hasMore: false` が適切である。ページネーション動作を検証するテストでは、テスト内でレスポンスをオーバーライドする方針とする。

### 修正 2: Playwright コンテナバージョンの同期

CI ワークフローのコンテナバージョンを `@playwright/test` パッケージと一致させた。

変更前:
```yaml
container:
  image: mcr.microsoft.com/playwright:v1.58.0-jammy
```

変更後:
```yaml
container:
  image: mcr.microsoft.com/playwright:v1.58.2-jammy
```

### 検討した代替案

| 案 | 不採用理由 |
|---|---|
| `page.route()` にカウンタを追加し 2 回目以降は `hasMore: false` を返す | 全テストファイルの `page.route()` コールバックを変更する必要があり、複雑化する |
| テスト側で `waitForLoadState` や追加の `waitForTimeout` を挿入 | タイミング依存のフレーキーテストの温床になる |
| `CONNECT_FEEDS_RESPONSE` を削除し各テストで個別にモックを定義 | モックデータの重複が増え、保守性が低下する |

## 結果・影響

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `alt-frontend-sv/tests/e2e/fixtures/mockData.ts` | `CONNECT_FEEDS_RESPONSE` の `hasMore` を `false`、`nextCursor` を `""` に変更 |
| `.github/workflows/alt-frontend-sv.yml` | Playwright コンテナを `v1.58.0-jammy` → `v1.58.2-jammy` に更新 |

### テスト結果

- `desktop-chromium` プロジェクト: 21/21 テスト PASS（CI と同一プロジェクト構成）
- 修正前に失敗していた 4 テスト全て PASS を確認
- 他のテストファイル（recap、augur、settings 等）への影響なし
- コンテナ再ビルド・再起動後、ヘルスチェック正常（`/sv/health` → OK）

### PROS

- CI の E2E テストが安定してグリーンになる
- モックデータのデフォルト動作が `page.route()` の特性と整合する
- Playwright のバージョン不一致による潜在的なフレーキーテストが解消される
- 変更が最小限（2 ファイル、実質 3 行）であり、既存テストへの副作用がない

### CONS, TRADEOFF

- `CONNECT_FEEDS_RESPONSE` を使用するテストでは、デフォルトでページネーション動作が検証されなくなる（必要に応じてテスト内でオーバーライドする設計）
- Playwright コンテナのバージョンは今後もパッケージ更新時に手動で同期する必要がある

### 影響範囲

- **E2E テスト**: `tests/e2e/desktop/feeds/index.spec.ts` の安定化が主な影響
- **CI ワークフロー**: コンテナバージョンの更新により、全 E2E テストプロジェクト（auth、desktop-chromium、mobile-chrome）に影響
- **本番コード**: 変更なし（テストインフラのみ）
- **他のモックデータ**: `CONNECT_FEEDS_NAVIGATION_RESPONSE` 等は元々 `hasMore: false` であり影響なし

## 関連 ADR

- ADR-000253: 検索結果のフィード詳細フッターが機能しない問題の修正
