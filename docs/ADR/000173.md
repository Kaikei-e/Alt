# Tag Trail 初期フィードカードのオンザフライタグ生成

## ADR's STATUS

Accepted

## CONTEXT

Tag Trail機能において、初期フィードカードにタグが表示されない問題が発生していた。

### 問題の概要

```
1. ユーザーがTag Trailを開く
2. FetchRandomFeed → ランダムなフィードを取得
3. GET /v1/feeds/{id}/tags → count=0（DBにタグなし）
4. そのフィードの記事がまだバッチ処理されていない
5. オンザフライ生成がトリガーされない
6. 初期フィードカードにタグが表示されない
```

### 調査結果

| コンポーネント | オンザフライ生成 | 状態 |
|--------------|----------------|------|
| `FetchArticleTagsGateway` | あり (ADR-168) | mq-hub連携済み |
| `FetchFeedTagsGateway` | **なし** | DBのみ読み取り |
| `StreamArticleTags` (handler) | **不完全** | 空配列を返すのみ |

`StreamArticleTags`ハンドラーは、usecaseがタグを返さない場合に`EVENT_TYPE_COMPLETED`と空配列を返すのみで、オンザフライ生成をトリガーしていなかった。

```go
// 修正前: タグなし時の処理
// 3. No tags exist - for now, send EVENT_TYPE_COMPLETED with empty tags
// Full streaming tag generation will be implemented in a future phase
h.logger.InfoContext(ctx, "no tags found for article", "articleID", articleID)
return stream.Send(&articlesv2.ArticleTagEvent{
    Tags:      []*articlesv2.ArticleTagItem{},
    EventType: articlesv2.ArticleTagEvent_EVENT_TYPE_COMPLETED,
})
```

## DECISION MAKING

### 方針: DB直接チェック + Gatewayによるオンザフライ生成

`StreamArticleTags`ハンドラーで以下のフローを実装:

1. **DB直接チェック**: `AltDBRepository.FetchArticleTags`でキャッシュ確認
2. **CACHED返却**: DBにタグがあれば`EVENT_TYPE_CACHED`で即時返却
3. **オンザフライ生成**: DBにタグがなければGateway経由でmq-hubに生成リクエスト
4. **COMPLETED返却**: 生成結果を`EVENT_TYPE_COMPLETED`で返却

### イベントタイプの意味

| EventType | 意味 | 用途 |
|-----------|------|------|
| `EVENT_TYPE_CACHED` | DBから取得したタグ | 即時応答、キャッシュヒット |
| `EVENT_TYPE_COMPLETED` | 生成完了（成功/失敗問わず） | オンザフライ生成結果 |
| `EVENT_TYPE_ERROR` | エラー発生 | 致命的エラー時のみ使用 |

### フェイルオープン設計

オンザフライ生成が失敗した場合でも、エラーではなく空配列で`EVENT_TYPE_COMPLETED`を返す。これにより:

- UIは正常に動作を継続
- ユーザー体験を損なわない
- バックエンドの一時的な問題に耐性がある

## RESULTS, EFFECTS

### 実装ファイル

| レイヤー | ファイル | 変更内容 |
|---------|---------|---------|
| Handler | `alt-backend/app/connect/v2/articles/handler.go` | `StreamArticleTags`にオンザフライ生成ロジック追加 |
| DI | `alt-backend/app/di/container.go` | `FetchArticleTagsGateway`フィールド公開 |
| Tests | `alt-backend/app/connect/v2/articles/handler_test.go` | イベントタイプとフェイルオープン動作のテスト追加 |

### StreamArticleTags実装

```go
func (h *Handler) StreamArticleTags(...) error {
    // 1. DB直接チェック（キャッシュ確認）
    if h.container.AltDBRepository != nil {
        cachedTags, err := h.container.AltDBRepository.FetchArticleTags(ctx, articleID)
        if err == nil && len(cachedTags) > 0 {
            // DBにタグあり → CACHED
            return stream.Send(&articlesv2.ArticleTagEvent{
                Tags:      convertTagsToProto(cachedTags),
                EventType: articlesv2.ArticleTagEvent_EVENT_TYPE_CACHED,
            })
        }
    }

    // 2. DBにタグなし → オンザフライ生成
    generatedTags, err := h.container.FetchArticleTagsGateway.FetchArticleTags(ctx, articleID)
    if err != nil {
        // フェイルオープン: エラー時も空配列で返す
        return stream.Send(&articlesv2.ArticleTagEvent{
            Tags:      []*articlesv2.ArticleTagItem{},
            EventType: articlesv2.ArticleTagEvent_EVENT_TYPE_COMPLETED,
            Message:   stringPtr("Tag generation temporarily unavailable"),
        })
    }

    // 3. 生成結果を返却
    return stream.Send(&articlesv2.ArticleTagEvent{
        Tags:      convertTagsToProto(generatedTags),
        EventType: articlesv2.ArticleTagEvent_EVENT_TYPE_COMPLETED,
    })
}
```

### DIコンテナの変更

```go
type ApplicationComponents struct {
    // ... 既存フィールド

    // Gateways exposed for handler use (on-the-fly tag generation)
    FetchArticleTagsGateway *fetch_article_tags_gateway.FetchArticleTagsGateway
}
```

### PROS

1. **即時タグ表示**: 初期フィードカードでもタグが表示される
2. **キャッシュ効率**: 2回目以降はDBから即時取得
3. **フェイルオープン**: mq-hub障害時もUIが動作継続
4. **セマンティクス明確化**: CACHED vs COMPLETED の意味が明確

### CONS, TRADEOFF

1. **初回レイテンシ**: オンザフライ生成時は数秒のレイテンシが発生
2. **DB二重アクセス**: 旧実装ではusecaseがgatewayを呼び、gatewayがDBを呼んでいたため、DB直接チェック追加で冗長に見えるが、CACHED/COMPLETED判別のため必要

## APPENDIX

### 処理フロー図

```
StreamArticleTags
    │
    ├─→ AltDBRepository.FetchArticleTags (DB直接チェック)
    │       │
    │       ├─→ tags found → EVENT_TYPE_CACHED
    │       │
    │       └─→ no tags
    │               │
    │               └─→ FetchArticleTagsGateway.FetchArticleTags
    │                       │
    │                       ├─→ mq-hub GenerateTagsForArticle
    │                       │
    │                       └─→ EVENT_TYPE_COMPLETED (成功/失敗問わず)
    │
    └─→ Gateway nil → EVENT_TYPE_COMPLETED (empty)
```

### 関連ADR

- ADR-167: Tag Trail基本設計
- ADR-168: オンザフライタグ生成（Gateway実装）
- ADR-169: タグ名による横断検索
- ADR-170: Tag Trail connect-rpc移行
- ADR-171: リアルタイムタグ反映 (Server Streaming)
- ADR-172: CJKテキスト対応とフィード解決ロジック改善

### 検証コマンド

```bash
# テスト実行
cd alt-backend/app && go test ./connect/v2/articles/... -v

# コンテナ再ビルド
docker compose -f compose/compose.yaml -p alt up -d --build alt-backend

# ログ確認
docker compose -f compose/compose.yaml -p alt logs alt-backend --since 5m | grep -i "on.the.fly\|generating"
```
