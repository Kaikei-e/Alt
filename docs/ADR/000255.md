# ADR-000255: K6 ロードテスト導入 (alt-perf)

## ステータス

承認済み

## コンテキスト

### 背景

alt-perf の既存 `load` コマンドは Deno の `fetch` ループによる簡易実装であり、以下の制約があった。

| 課題 | 説明 |
|------|------|
| VU モデルなし | 同時ユーザー数の段階的制御ができない |
| シナリオ不足 | smoke/stress/soak/spike といった業界標準パターンがない |
| メトリクス限定 | パーセンタイル（p50/p95/p99）やグループ別計測が困難 |
| 閾値判定なし | CI ゲートとして使えない（pass/fail が自動判定されない） |

Grafana K6 を導入し、alt-backend の API レスポンス速度を計測する業界標準のシナリオベースロードテストを実現する。

### 倫理的制約（多層防御）

外部 API への不正な負荷を防ぐため、3 層の防御を設計した。

| 層 | 仕組み | 目的 |
|---|--------|------|
| 第 1 層: エンドポイント除外 | summarize, images/fetch, augur, rss-feed-link/register 等を対象外 | 外部 API リクエスト発生を根本的に防止 |
| 第 2 層: 10 秒クールダウン | 全シナリオの各イテレーション末尾に `sleep(10)` | 万が一のレート制限フォールバック |
| 第 3 層: ホワイトリスト方式 | `endpoints.js` で対象を明示定義 | コードレビュー必須の追加プロセス |

## 意思決定

### 構成

```
alt-perf/k6/
  docker-entrypoint.sh          # シークレット読み込み + k6 実行
  scenarios/
    smoke.js                     # 1 VU, 1 min — 疎通確認
    load.js                      # ramping-vus 0→10→20→0, 16 min
    stress.js                    # ramping-vus 0→20→50→100→0, 19 min
    soak.js                      # constant-vus 10, 30 min
    spike.js                     # ramping-vus 5→100→5→0, 6 min
  helpers/
    config.js                    # 環境変数読み込み
    auth.js                      # X-Alt-Shared-Secret 認証ヘッダー構築
    endpoints.js                 # テスト対象エンドポイント定義
    checks.js                    # レスポンス検証関数
    metrics.js                   # カスタムメトリクス定義
    summary.js                   # handleSummary (JSON レポート出力)
  config/
    thresholds.js                # シナリオ別閾値定義
  README.md                      # 使い方ドキュメント
```

### シナリオ設計

| シナリオ | Executor | VU 数 | 時間 | 目的 |
|---------|----------|-------|------|------|
| smoke | constant-vus | 1 | 1m | 全エンドポイント疎通確認 |
| load | ramping-vus | 0→10→20→0 | 16m | 通常トラフィックシミュレーション |
| stress | ramping-vus | 0→20→50→100→0 | 19m | 限界負荷探索 |
| soak | constant-vus | 10 | 30m | メモリリーク・接続枯渇検出 |
| spike | ramping-vus | 5→100→5→0 | 6m | 急激な負荷変動への耐性確認 |

### 閾値設計（`thresholds.yaml` と整合）

| シナリオ | p(50) | p(95) | p(99) | エラー率 |
|---------|-------|-------|-------|---------|
| smoke | — | < 300ms | — | < 1% |
| load / soak | < 200ms | < 500ms | < 1000ms | < 1% |
| stress / spike | — | < 1000ms | — | < 5% |

### 認証方式

alt-backend の `AuthMiddleware` フォールバック認証パスを使用。nginx を経由せず `alt-backend:9000` に直接接続し、API レスポンス性能を単体で計測する。

使用ヘッダー:
- `X-Alt-Shared-Secret` — Docker secret から docker-entrypoint.sh で読み込み
- `X-Alt-User-Id` / `X-Alt-Tenant-Id` — 環境変数で指定
- `X-CSRF-Token` — POST エンドポイントでは事前に `/v1/csrf-token` から取得

### テスト対象エンドポイント（ホワイトリスト）

**公開:**
- `GET /v1/health`, `GET /v1/csrf-token`, `GET /v1/dashboard/overview`, `GET /v1/dashboard/metrics`

**認証必須:**
- feeds: `/v1/feeds/fetch/list`, `/fetch/cursor`, `/count/unreads`
- stats: `/v1/feeds/stats`, `/stats/detailed`, `/stats/trends`
- search: `POST /v1/feeds/search`（CSRF トークン必須）
- articles: `/v1/articles/fetch/cursor`, `/by-tag`
- morning-letter: `/v1/morning-letter/updates`

### Docker Compose 統合

`compose/perf.yaml` に `k6` サービスを追加:

```yaml
k6:
  image: grafana/k6:0.55.0
  secrets:
    - auth_shared_secret
  volumes:
    - ../alt-perf/k6:/scripts:ro
    - ../alt-perf/reports:/app/reports
  depends_on:
    alt-backend:
      condition: service_healthy
  entrypoint: ["/scripts/docker-entrypoint.sh"]
  profiles:
    - perf
```

`docker-entrypoint.sh` で `/run/secrets/auth_shared_secret` を環境変数 `K6_AUTH_SECRET` に変換後、`exec k6 "$@"` で K6 を実行する。

### altctl レジストリ更新

perf スタックの Services に `"k6"` を追加: `[]string{"alt-perf", "k6"}`

### 検討した代替案

| 案 | 不採用理由 |
|---|-----------|
| 既存 Deno load コマンドの拡張 | VU モデル・シナリオ制御・閾値判定がないため、根本的な機能不足 |
| Artillery | K6 の方が Go ベースで軽量、Docker 統合が容易、JS シナリオの記述性が高い |
| Locust (Python) | プロジェクトの技術スタック（Go/Deno/Rust）と親和性が低い |
| nginx 経由でテスト | 認証フロー (Kratos) が必要になり、API 単体の性能計測が困難になる |

## 結果・影響

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `alt-perf/k6/helpers/config.js` | 新規: 環境変数読み込み |
| `alt-perf/k6/helpers/auth.js` | 新規: 認証ヘッダー構築 |
| `alt-perf/k6/helpers/endpoints.js` | 新規: ホワイトリストエンドポイント定義 |
| `alt-perf/k6/helpers/checks.js` | 新規: レスポンス検証関数 |
| `alt-perf/k6/helpers/metrics.js` | 新規: カスタムメトリクス |
| `alt-perf/k6/helpers/summary.js` | 新規: JSON レポート出力 |
| `alt-perf/k6/config/thresholds.js` | 新規: シナリオ別閾値 |
| `alt-perf/k6/scenarios/smoke.js` | 新規: スモークテスト |
| `alt-perf/k6/scenarios/load.js` | 新規: ロードテスト |
| `alt-perf/k6/scenarios/stress.js` | 新規: ストレステスト |
| `alt-perf/k6/scenarios/soak.js` | 新規: ソークテスト |
| `alt-perf/k6/scenarios/spike.js` | 新規: スパイクテスト |
| `alt-perf/k6/docker-entrypoint.sh` | 新規: シークレット読み込みスクリプト |
| `alt-perf/k6/README.md` | 新規: K6 使い方ドキュメント |
| `compose/perf.yaml` | k6 サービス追加 |
| `altctl/internal/stack/registry.go` | perf スタックに k6 追加 |
| `alt-perf/CLAUDE.md` | K6 セクション追加 |

### テスト結果

- `altctl`: `go test ./...` 全パス（`internal/stack` 含む）
- K6 smoke テスト: 全エンドポイント HTTP 200 応答確認（`http_req_failed: 0.00%`）
- 認証フロー: `X-Alt-Shared-Secret` による共有シークレット認証が正常動作
- CSRF フロー: `/v1/csrf-token` 取得 → `X-CSRF-Token` ヘッダー送信で `POST /v1/feeds/search` が 200 応答
- JSON レポート: `alt-perf/reports/k6-*.json` に正常出力

### カスタムメトリクス出力例（smoke テスト）

| メトリクス | avg | p(90) | p(95) |
|-----------|-----|-------|-------|
| dashboard_response_time | 1.64ms | 2.55ms | 2.81ms |
| search_response_time | 13.6ms | 19.5ms | 20.6ms |
| articles_response_time | 388ms | 918ms | 1.06s |
| feeds_response_time | 1.59s | 6.32s | 6.77s |

### PROS

- 業界標準のシナリオベースロードテスト（smoke/load/stress/soak/spike）が利用可能になる
- パーセンタイル閾値で CI ゲートとして利用可能（exit code 99 で失敗）
- Docker Compose 統合により、`docker compose run --rm k6 run /scripts/scenarios/smoke.js` で即実行
- 3 層の倫理的防御により、外部 API への意図しない負荷を防止
- 既存の alt-perf（Deno/Astral）と共存し、それぞれの得意分野（Web Vitals vs API ロードテスト）を分担

### CONS, TRADEOFF

- K6 コンテナイメージ（grafana/k6:0.55.0）が追加されるが、軽量（~50MB）
- テストユーザーの UUID を環境変数で指定する必要がある（`K6_TEST_USER_ID`）
- feeds/articles エンドポイントの p(95) が閾値を超過しており、バックエンド側の最適化が別途必要

### 影響範囲

- **alt-backend**: 変更なし（テスト対象として利用されるのみ）
- **compose/perf.yaml**: k6 サービス追加（既存 alt-perf サービスに影響なし）
- **altctl**: perf スタックのサービスリストに k6 追加（依存関係は変更なし）
- **本番環境**: 影響なし（perf プロファイルは明示的起動のみ）

## 関連 ADR

- ADR-000254: alt-frontend-sv E2E テスト無限スクロールループの修正
