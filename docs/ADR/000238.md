# ADR-000238: プレゼンテーション層 UUID 生成による Svelte keying ID のドメイン分離

## STATUS

Accepted（実装完了）

## CONTEXT

ADR-000237 の第1版では、Favorites ページの Svelte reconcile クラッシュ（重複キー問題）を修正するために、DB の主キー `feeds.id` を `domain.FeedItem.FeedID` としてドメイン層に追加した。

しかし、これは Clean Architecture に違反していた：

- **ドメイン層はインフラの詳細を知るべきではない** — DB の主キーはインフラ層（Driver/Gateway）の関心事
- **proto の `Id` フィールドはプレゼンテーション専用** — フロントエンド調査の結果、`Id` は Svelte `{#each}` のキーイングにのみ使用されており、ビジネスロジック（既読管理、記事取得、要約生成）は全て `feed.link` を使用している

つまり、一意な ID の生成はプレゼンテーション層の責務であり、ドメインや Gateway が関与する必要はなかった。

## DECISION MAKING

### 方針

`convertFeedsToProto`（connect ハンドラ / プレゼンテーション層）で UUID をフォールバック生成する。

```go
id := uuid.New().String()
if feed.ArticleID != "" {
    id = feed.ArticleID
}
```

- `ArticleID` がある場合はそれを使用（既存記事との対応が明確）
- ない場合は `uuid.New().String()` で毎回一意な ID を生成

### 代替案の比較

| 選択肢 | 長所 | 短所 |
|--------|------|------|
| **UUID（採用）** | ドメイン/Gateway 変更不要、常に一意 | リクエスト毎に ID が変化 |
| FeedID（DB PK） | 安定した ID | DB の実装詳細がドメインに漏洩 |
| Link+index | 安定 | ページネーション境界で衝突リスク |

### UUID の非安定性が問題にならない理由

1. `Id` は Svelte `{#each}` keying 専用 — ビジネスロジックは `link` を参照
2. カーソルページネーションにより同一アイテムが複数ページに出現しない
3. リフレッシュ時は全アイテムが再取得され、全キーが一斉に更新されるため UI 上の不整合は発生しない

## RESULTS

### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `alt-backend/app/domain/rss_feed.go` | `FeedItem.FeedID` フィールドを削除 |
| `alt-backend/app/gateway/fetch_feed_gateway/feeds_gateway.go` | 4 つの Cursor メソッドから `FeedID: feed.ID` を削除 |
| `alt-backend/app/connect/v2/feeds/helpers.go` | `convertFeedsToProto` の ID ロジックを UUID フォールバックに変更 |
| `alt-backend/app/connect/v2/feeds/helpers_test.go` | UUID フォールバックの一意性テストに更新 |
| `alt-backend/app/connect/v2/feeds/handler_test.go` | UUID フォーマット検証に更新 |
| `docs/ADR/000237.md` | 設計改訂の経緯を追記 |

### アーキテクチャ上の位置づけ

```
Driver (SQL)
  ↓ ArticleID をフェッチ（ADR-000237 で追加済み・維持）
Gateway
  ↓ domain.FeedItem に ArticleID を設定（維持）
  ↓ FeedID は設定しない（削除）
Connect Handler (convertFeedsToProto)
  ↓ ArticleID があればそれを使用
  ↓ なければ uuid.New().String() で一意 ID 生成
Proto Response → Frontend (Svelte {#each} keying)
```

ID 生成の責務がプレゼンテーション層に限定され、ドメインと Gateway は本来のビジネスデータのみを扱う。

## PROS

1. **Clean Architecture 準拠** — DB の主キーがドメイン層から完全に除去された
2. **関心の分離** — ID 生成はプレゼンテーション層の責務として明確化
3. **Gateway の簡素化** — 4 メソッドから不要なフィールド設定が削除された
4. **重複キー問題の完全解消** — UUID により同一 Link の複数アイテムでも常に一意

## CONS, TRADEOFF

1. **ID の非安定性** — リクエスト毎に生成される UUID は異なるが、keying 専用のため実害なし
2. **`uuid` パッケージへの依存** — 同パッケージの `handler.go` で既に使用中のため追加依存なし

## APPENDIX

- 関連 ADR: [ADR-000237](./000237.md) — Favorites 重複キーによる Svelte reconcile クラッシュ修正（本 ADR の前段）
- 関連 ADR: [ADR-000228](./000228.md) — 検索結果の重複 ID による Svelte reconcile クラッシュ修正
