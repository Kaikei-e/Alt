# rask-log-forwarderをOTLP (OpenTelemetry Protocol) 準拠に拡張

## ステータス

承認済み（2026-01-29）

## 背景

rask-log-forwarderはDockerコンテナからログを収集し、rask-log-aggregatorに転送するサイドカーコンポーネントである。従来はNDJSON形式でログを送信していたが、以下の課題があった：

1. **独自形式**: NDJSONは標準的なオブザーバビリティエコシステムと互換性がない
2. **ペイロードサイズ**: JSONテキストは冗長でネットワーク帯域を消費
3. **トレース相関**: OpenTelemetryの標準的なtrace_id/span_idフォーマットとの互換性が不完全

rask-log-aggregatorは既にOTLP HTTP受信エンドポイント（`:4318/v1/logs`）を実装済みであり、forwarder側の対応が必要だった。

## 決定事項

### アプローチ選択

OTLP HTTP（protobuf）を追加し、既存のNDJSONと共存させる設計を採用した。

| アプローチ | 採用 | 理由 |
|-----------|-----|------|
| A. OTLP HTTP追加（共存） | **採用** | 段階的移行が可能、後方互換性を維持 |
| B. OTLP完全置換 | 不採用 | 破壊的変更となる |
| C. OTel Collector導入 | 不採用 | 追加インフラが必要、レイテンシ増加 |

### 実装内容

1. **OTLP シリアライザー** (`src/sender/otlp.rs`)
   - `EnrichedLogEntry` → OTLP `LogRecord` 変換
   - サービス名ごとに `ResourceLogs` をグループ化
   - `opentelemetry-proto` crateを使用したprotobufエンコード

2. **プロトコル設定** (`src/app/config.rs`)
   - `Protocol` enum（`Ndjson` / `Otlp`）を追加
   - 環境変数 `PROTOCOL` および `OTLP_ENDPOINT` で切り替え可能

3. **送信レイヤー** (`src/sender/transmission.rs`)
   - `OtlpBatchTransmitter` を追加
   - Content-Type: `application/x-protobuf`
   - gzip圧縮対応

### データマッピング

| EnrichedLogEntry | OTLP LogRecord |
|------------------|----------------|
| `timestamp` (RFC3339) | `time_unix_nano` (u64) |
| `level` (LogLevel) | `severity_number` (1-24) |
| `message` | `body` (StringValue) |
| `trace_id` (hex) | `trace_id` (16 bytes) |
| `span_id` (hex) | `span_id` (8 bytes) |
| `service_name` | `resource.attributes["service.name"]` |
| `container_id` | `resource.attributes["container.id"]` |
| `method`, `path`, etc. | `attributes` (OTel Semantic Conventions) |

## 結果・影響

### ベンチマーク結果

| 指標 | NDJSON | OTLP | 差分 |
|------|--------|------|------|
| ペイロードサイズ (100エントリ) | 59,780 bytes | 41,620 bytes | **-30.4%** |
| ペイロードサイズ (1000エントリ) | 599,780 bytes | 416,020 bytes | **-30.6%** |
| シリアライズ速度 (100エントリ) | 38 µs | 114 µs | NDJSON 3x 高速 |
| シリアライズ速度 (10000エントリ) | 6.2 ms | 36.8 ms | NDJSON 6x 高速 |

**考察**: OTLPはペイロードサイズを約30%削減するが、シリアライズにはより多くのCPU時間を要する。ネットワーク帯域がボトルネックの環境ではOTLPが有利。

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `Cargo.toml` | `opentelemetry-proto`, `prost`, `hex` 依存追加 |
| `src/sender/otlp.rs` | **新規** OtlpSerializer実装 |
| `src/sender/mod.rs` | otlpモジュール追加・エクスポート |
| `src/sender/serialization.rs` | `SerializationFormat::OTLP` 追加 |
| `src/sender/transmission.rs` | `OtlpBatchTransmitter` 追加 |
| `src/app/config.rs` | `Protocol` enum、`otlp_endpoint` 設定追加 |
| `Dockerfile.rask-log-forwarder` | `--features otlp` ビルドオプション追加 |

### 使用方法

```yaml
# Docker Compose環境変数でOTLPモードを有効化
environment:
  PROTOCOL: "otlp"
  OTLP_ENDPOINT: "http://rask-log-aggregator:4318/v1/logs"
```

```bash
# ローカル実行
PROTOCOL=otlp OTLP_ENDPOINT=http://localhost:4318/v1/logs cargo run --features otlp
```

### メリット

- **標準準拠**: OpenTelemetryエコシステムとの完全互換
- **帯域削減**: protobufにより約30%のペイロード削減
- **トレース相関**: OTel標準のtrace_id/span_idフォーマット
- **後方互換**: 既存のNDJSONモードを維持

### デメリット・トレードオフ

- **CPU使用量増加**: protobufシリアライズはJSONより計算コストが高い
- **依存関係増加**: `opentelemetry-proto` (約2MB) を追加
- **feature flag必須**: OTLPを使用するには `--features otlp` でビルドが必要

## 付録

### 動作確認コマンド

```bash
# OTLPモードでforwarderをビルド・起動
docker compose -f compose/compose.yaml -p alt build nginx-logs
docker compose -f compose/compose.yaml -p alt up -d rask-log-aggregator nginx-logs

# aggregatorでOTLPログを確認
docker compose -f compose/compose.yaml -p alt logs -f rask-log-aggregator | grep OTLP

# ClickHouseでotel_logsテーブルを確認
docker compose -f compose/compose.yaml -p alt exec clickhouse clickhouse-client \
  -q "SELECT count(*) FROM rask_logs.otel_logs"
```

### テスト実行

```bash
# OTLPシリアライズのテスト
cargo test --features otlp test_otlp

# ベンチマーク
cargo bench --features otlp --bench otlp_benchmarks
```

### 関連ADR

- ADR-091: rask-log-aggregatorのOTLP受信機能（aggregator側の実装）
