# ADR-000219: デスクトップ検索UIの「Loading more...」によるカード操作不能の修正

## STATUS

Accepted（実装完了・テスト通過・関連コンテナ再ビルド/再起動確認済み）

## CONTEXT

デスクトップ版 `/sv/feeds/search` でヒット件数が多いクエリで検索すると、「Loading more...」が画面下部に表示され続け、feedカードがクリックできなくなる問題が発生していた。

原因は以下の2つが複合していた。

1. **Infinite scrollの高速連鎖発火**: 検索結果表示直後にsentinel divがviewport内に入り、`loadMore()` → `isLoadingMore` toggle → `infiniteScroll` actionの `update()` → observer再作成 → 即座に再発火のサイクルが発生。各サイクル中のrapidなstate更新（feeds配列更新 + isLoadingMore toggle）でSvelteが `{#each}` blockのpropsを繰り返し再評価し、UIのレスポンスが低下していた。
2. **検索用クライアント関数のデータ欠損**: `searchFeedsClient` が `ConnectFeedItem` から `id`, `tags`, `createdAt`, `isRead`, `articleId` を全て除外していた。`sanitizeFeed` のフォールバックで `id = link` を使用するため、keyed each blockの安定性が低下し、DOMノードの不必要な再利用が発生する可能性があった。

## DECISION MAKING

以下の方針で修正した。

1. デスクトップ専用の検索関数を新設し、データ変換を正規化
2. 検索ページのデータフローを簡素化
3. loadMore にクールダウンを追加
4. Loading indicator / sentinel div に pointer-events-none を追加

### 修正方針 1: デスクトップ専用検索関数の新設

モバイル版の `searchFeedsClient` は複数のコンポーネント（`SearchWindow.svelte`, `SearchResults.svelte`, `(app)/feeds/search/+page.svelte`）で使用されているため変更せず、デスクトップ専用の `searchFeedsDesktopClient` を追加した。

- 既存の `connectFeedToRenderFeed` を使用し、`id`, `createdAt`, `articleId`, `isRead` 等を保持
- `RenderFeed[]` を直接返すことで、呼び出し側での `sanitizeFeed` / `toRenderFeed` 二重変換を不要にした
- 他のフィード取得関数（`getFeedsWithCursorClient`, `getAllFeedsWithCursorClient` 等）と同じ変換パイプラインに統一

### 修正方針 2: データフローの簡素化

検索ページのデータフローを `searchFeedsDesktopClient` → `RenderFeed[]` の直接利用に変更し、中間変換レイヤーを排除した。

### 修正方針 3: loadMore クールダウン

`loadMore` に500msのクールダウンを追加し、IntersectionObserverの連鎖発火を抑制した。observer自体の変更は不要で、呼び出し側のガード条件追加のみで対応した。

### 修正方針 4: pointer-events-none

Loading indicator と sentinel div に `pointer-events-none` を追加し、これらの要素がカードのクリックイベントを奪わないようにした。

## RESULTS

### 変更ファイル

| ファイル | 変更内容 |
|---|---|
| `alt-frontend-sv/src/lib/api/client/feeds.ts` | `searchFeedsDesktopClient` 関数を新規追加。`connectFeedToRenderFeed` を使用して `RenderFeed[]` を直接返す |
| `alt-frontend-sv/src/routes/desktop/feeds/search/+page.svelte` | import を `searchFeedsDesktopClient` に変更、`sanitizeFeed`/`toRenderFeed` 二重変換を削除、loadMore に500msクールダウン追加、loading indicator / sentinel div に `pointer-events-none` 追加 |

### テスト結果

| 実行コマンド | 結果 |
|---|---|
| `cd alt-frontend-sv && bun test src/routes/desktop/feeds/search/page.search.spec.ts` | 17 pass, 0 fail |
| `cd alt-frontend-sv && npx svelte-check --tsconfig ./tsconfig.json` | 0 errors, 0 warnings |

### コンテナ検証

| 検証 | 結果 |
|---|---|
| `docker compose -f compose/compose.yaml -p alt build alt-frontend-sv` | 成功 |
| `docker compose -f compose/compose.yaml -p alt up -d alt-frontend-sv` | 成功 |
| `docker compose -f compose/compose.yaml -p alt ps alt-frontend-sv` | `Up ... (healthy)` を確認 |
| `curl http://localhost:4173/sv/health` | `OK` |

## PROS

1. keyed each block で安定した `id` が使用されるようになり、DOM再利用の不具合が解消された。
2. 500msクールダウンにより、IntersectionObserverの連鎖発火が抑制され、UIレスポンスが改善された。
3. `pointer-events-none` により、Loading indicator表示中もカードがクリック可能になった。
4. デスクトップ版のデータフローが他のフィード取得関数（`getFeedsWithCursorClient` 等）と統一され、保守性が向上した。
5. モバイル版の `searchFeedsClient` は変更していないため、モバイル検索へのリグレッションリスクがない。

## CONS, TRADEOFF

1. `searchFeedsClient` と `searchFeedsDesktopClient` の2つの検索関数が並存する形になった。将来的にモバイル版も `connectFeedToRenderFeed` ベースに統一する場合は、`searchFeedsClient` の置き換えを検討する。
2. クールダウン値（500ms）はヒューリスティックな値であり、極端に低速なネットワーク環境では調整が必要になる可能性がある。
