# ADR-000307: RSS XML からの OGP 画像 URL 抽出とバックグラウンドプリフェッチによる画像表示の即時化

## ADR's STATUS

Accepted

## CONTEXT

フィード一覧画面で OGP 画像が表示されるまでに、以下の多段オンデマンド処理が必要だった:

1. ユーザーがフィードカードを閲覧
2. `FetchArticleContent` RPC で記事ページの HTML を取得
3. HTML から OGP メタタグを抽出
4. `BatchPrefetchImages` RPC で画像をダウンロード・リサイズ・キャッシュ
5. プロキシ URL 経由で画像を表示

この設計には以下の問題があった:

- **表示遅延**: ユーザーがフィードを閲覧するまで画像が準備されず、LCP（Largest Contentful Paint）が遅い
- **レートリミット競合**: フィード収集と OGP 画像取得が同一の `HostRateLimiter` を共有しており、互いにスロットリングされる可能性がある
- **不要な HTTP リクエスト**: RSS XML に画像 URL が含まれているにもかかわらず、別途 HTML を取得して OGP を抽出していた

## DECISION MAKING

### 方針: RSS XML から画像 URL を抽出し、バックグラウンドジョブで事前キャッシュする

| 項目 | 決定 | 理由 |
|------|------|------|
| 画像 URL 取得元 | RSS XML（`<image>`, `<media:thumbnail>`, `<media:content>`, `<enclosure>`） | フィード収集時に追加 HTTP なしで取得可能 |
| 保存先 | `feeds.og_image_url` カラム（新規追加） | フィードと 1:1 で紐づくため自然な配置 |
| プリフェッチ方式 | 独立したバックグラウンドジョブ `ogp-image-warmer`（1時間間隔） | フィード収集のレートリミットと分離 |
| レートリミット | 3つの独立した `HostRateLimiter` に分離 | A: フィード収集（既存）、B: OGP 画像ウォーマー（新規）、C: オンデマンドプロキシ（既存） |
| キャッシュ TTL | 12時間 → 24時間に延長 | プリフェッチ済み画像がユーザー閲覧前に期限切れになるリスクを低減 |
| フォールバック | 既存の `FetchArticleContent` + `BatchPrefetchImages` パスを維持 | RSS に画像がないフィードや、ウォーマー未処理の画像に対応 |

### 他の選択肢を採用しなかった理由

- **フィード収集と同一ジョブ内で画像キャッシュ**: 収集ジョブの実行時間が大幅に増加し、レートリミットも競合する
- **HTML OGP 抽出をバッチ化**: 全記事の HTML を取得する必要があり、外部サーバーへの負荷が高い。RSS XML に含まれる情報を活用する方が効率的
- **CDN による画像キャッシュ**: 自前の画像プロキシに HMAC 署名付き URL を使用しているため、CDN 層の追加は過剰

## RESULTS, EFFECTS

### PROS

- フィード一覧画面で OGP 画像が即座に表示される（追加 HTTP リクエスト不要）
- フィード収集と画像プリフェッチのレートリミットが完全に分離され、互いに影響しない
- RSS XML から画像 URL を抽出するため、記事 HTML の取得が不要（帯域・レイテンシ削減）
- 既存のオンデマンドパスがフォールバックとして機能し、段階的な移行が可能
- キャッシュ TTL 延長（24時間）により、プリフェッチの効果が持続する

### CONS, TRADEOFF

- `feeds` テーブルに `og_image_url` カラムが追加され、ストレージが微増する
- RSS XML に画像が含まれないフィードでは効果がなく、従来のオンデマンドパスに依存する
- ウォーマージョブの間隔（1時間）と収集タイミングによっては、最大1時間のプリフェッチ遅延が発生する
- `image_proxy_cache` の TTL 延長によりキャッシュのストレージ消費が増加する

## APPENDIX

### データフロー

```
RSS XML → gofeed.Item.Image / Enclosures / Extensions["media"]
  → feeds.og_image_url に保存（HTTP 不要、XML から抽出）
  → [ogp-image-warmer ジョブ] image_proxy_cache に画像 BYTEA 保存（24h TTL）
  → フィード一覧レスポンスに og_image_proxy_url を含める
  → フロントエンドは即座に画像表示
```

### 画像 URL 抽出の優先順位

1. `item.Image.URL`（明示的 RSS image 要素）
2. `item.Extensions["media"]["thumbnail"]` / `["content"]`（Media RSS）
3. `item.Enclosures` で `Type` が `image/*` のもの
4. 空文字（画像なし → フォールバックパス）

### 変更対象ファイル

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `migrations-atlas/migrations/20260301000000_add_og_image_url_to_feeds.sql` | `feeds` テーブルに `og_image_url TEXT` カラム追加 |
| 2 | `alt-backend/app/domain/rss_feed.go` | `FeedItem` に `OgImageURL`, `OgImageProxyURL` フィールド追加 |
| 3 | `alt-backend/app/driver/models/feed.go` | `Feed` モデルに `OgImageURL *string` 追加 |
| 4 | `alt-backend/app/job/feed_image_extractor.go` | RSS XML からの画像 URL 抽出ロジック（新規） |
| 5 | `alt-backend/app/job/feed_image_extractor_test.go` | 抽出ロジックのテスト 12 ケース（新規） |
| 6 | `alt-backend/app/job/feed_collector.go` | `ConvertFeedToFeedItem` で `ExtractImageURL` を呼出 |
| 7 | `alt-backend/app/job/job_runner.go` | `feedModels` に `OgImageURL` を追加 |
| 8 | `alt-backend/app/driver/alt_db/register_feeds_driver.go` | INSERT/UPDATE に `og_image_url` カラム追加 |
| 9 | `alt-backend/app/job/ogp_image_warmer.go` | OGP 画像ウォーマージョブ（新規） |
| 10 | `alt-backend/app/job/ogp_image_warmer_test.go` | ウォーマージョブのテスト 5 ケース（新規） |
| 11 | `alt-backend/app/driver/alt_db/ogp_image_driver.go` | `FetchUnwarmedOgImageURLs` クエリ（新規） |
| 12 | `alt-backend/app/main.go` | `ogp-image-warmer` ジョブ登録 |
| 13 | `alt-backend/app/domain/image_proxy.go` | `ImageProxyCacheTTL` を 24 時間に変更 |
| 14 | `alt-backend/app/config/config.go` | デフォルト `CacheTTLMin` を 1440 に変更 |
| 15 | `proto/alt/feeds/v2/feeds.proto` | `FeedItem` に `og_image_url`, `og_image_proxy_url` 追加 |
| 16 | `alt-backend/app/driver/alt_db/fetch_feed_driver.go` | SELECT/Scan に `og_image_url` 追加 |
| 17 | `alt-backend/app/gateway/fetch_feed_gateway/feeds_gateway.go` | ドメイン変換に `OgImageURL` 追加 |
| 18 | `alt-backend/app/connect/v2/feeds/helpers.go` | proto 変換に `OgImageUrl`, `OgImageProxyUrl` 追加 |
| 19 | `alt-backend/app/connect/v2/feeds/handler.go` | `enrichWithProxyURLs` メソッド追加 |
| 20 | `alt-frontend-sv/src/lib/connect/feeds/client.ts` | `ConnectFeedItem` に画像フィールド追加 |
| 21 | `alt-frontend-sv/src/lib/server/feed-api.ts` | `connectFeedToBackendFormat` に `og_image_proxy_url` 追加 |
| 22 | `alt-frontend-sv/src/lib/domain/feed/types.ts` | `RenderFeed`, `BackendFeedItem` に画像フィールド追加 |
| 23 | `alt-frontend-sv/src/routes/(app)/feeds/swipe/visual-preview/+page.server.ts` | `ogImageProxyUrl` マッピング追加 |
| 24 | `alt-frontend-sv/src/lib/components/mobile/feeds/swipe/SwipeFeedScreen.svelte` | `ogImageProxyUrl` をフォールバック候補に追加 |

### テスト

| # | テスト | 結果 |
|---|--------|------|
| 1 | `alt-backend/app/job/feed_image_extractor_test.go`（12 ケース） | PASS |
| 2 | `alt-backend/app/job/ogp_image_warmer_test.go`（5 ケース） | PASS |
| 3 | `alt-backend`: `go test ./...` | 全テスト PASS |
| 4 | `alt-frontend-sv`: `pnpm test`（448 テスト） | 全テスト PASS |

### 検証結果

- マイグレーション適用: `ALTER TABLE feeds ADD COLUMN IF NOT EXISTS og_image_url TEXT` 正常完了
- コンテナ再ビルド・起動: `alt-backend`, `alt-frontend-sv` 共に healthy
- OGP image warmer ジョブ: 登録・実行確認済み（初回は unwarmed images 0件 — 新コードでの収集完了後に効果発揮）
- フィード収集: `og_image_url` 付きで正常動作中
