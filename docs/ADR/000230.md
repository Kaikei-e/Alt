# ADR-000230: Kokoro-82M 日本語 TTS マイクロサービス (tts-speaker) の導入

## STATUS

Accepted（実装完了・ユニットテスト全件 PASS）

## CONTEXT

Evening Pulse v4.0 で日本語ニュースの音声読み上げ機能を実現するため、テキスト音声合成（TTS）サービスが必要になった。

### 要件

- 日本語テキストから自然な音声を生成できること
- 軽量で GPU 不要（CPU 推論で実用速度）であること
- 既存のリモートマシンデプロイパターン（knowledge-augur / knowledge-embedder と同様の `extra_hosts` パターン）を踏襲すること
- 複数の日本語ボイスを選択できること

### モデル選定

Kokoro-82M を採用した。82M パラメータと軽量ながら高品質な日本語音声を生成でき、CPU 推論で実用的な速度が出る。HuggingFace Hub から自動ダウンロード（約 330MB）され、Docker volume にキャッシュされる。

## DECISION MAKING

### アーキテクチャ

リモートマシン上に独立した Compose ファイル (`compose.tts.yaml`) でデプロイし、メインスタックからは `extra_hosts` で名前解決する。knowledge-augur / knowledge-embedder と同一のパターンを踏襲した。

```
[メインサーバー]                          [リモートマシン]
compose/compose.yaml                     compose.augur.yaml (既存)
  news-creator ──extra_hosts──→            knowledge-augur :11435
                                           knowledge-embedder :11436
                 ──extra_hosts──→        compose.tts.yaml (新規)
                                           tts-speaker :9700
```

### 設計方針

- **recap-subworker パターン準拠**: `create_app()` ファクトリ、pydantic-settings、Docker secrets (`SERVICE_SECRET_FILE`)、マルチステージ Dockerfile
- **TDD-first**: 23 件のユニットテストを先に作成し、実装で全件 GREEN に
- **YAGNI**: `extra_hosts` は現時点で news-creator のみに追加。他サービスへの追加は実際のコンシューマー実装時に行う

### 代替案: メインスタック内での実行

メインサーバーの `compose/ai.yaml` に組み込む案もあったが、以下の理由で独立 Compose ファイルを選択:

1. リモートマシンの CPU リソースを活用できる
2. メインスタックの起動時間に影響しない（初回モデルダウンロードに 120 秒以上かかる）
3. 既存の knowledge-augur パターンとの一貫性

## RESULTS

### ディレクトリ構造

```
tts-speaker/
├── CLAUDE.md
├── README.md
├── Dockerfile              # マルチステージ (espeak-ng + PyTorch CPU + 非root ユーザー)
├── .dockerignore
├── pyproject.toml
├── uv.lock
├── tts_speaker/
│   ├── app/
│   │   ├── main.py         # create_app() ファクトリ + lifespan
│   │   └── routers/
│   │       ├── health.py    # GET /health
│   │       ├── synthesize.py # POST /v1/synthesize
│   │       └── voices.py    # GET /v1/voices
│   ├── core/
│   │   └── pipeline.py     # TTSPipeline (KPipeline ラッパー, async executor)
│   └── infra/
│       ├── config.py        # pydantic-settings + SERVICE_SECRET_FILE
│       └── auth.py          # X-Service-Token 検証
└── tests/
    ├── conftest.py          # Mock pipeline, lru_cache cleanup
    ├── unit/                # 23 テスト (モデル不要)
    └── integration/         # 要モデル DL
```

### API エンドポイント

| メソッド | パス | 認証 | 説明 |
|---------|------|------|------|
| `GET` | `/health` | 不要 | サービス状態 + モデルロード状況 |
| `POST` | `/v1/synthesize` | 必要 | テキスト→WAV 変換 (1-5000字, 24kHz float32) |
| `GET` | `/v1/voices` | 必要 | 日本語ボイス一覧 (5件) |

### 利用可能ボイス

| Voice ID | 名前 | 性別 |
|----------|------|------|
| `jf_alpha` | Alpha | 女性 (デフォルト) |
| `jf_gongitsune` | Gongitsune | 女性 |
| `jf_nezumi` | Nezumi | 女性 |
| `jf_tebukuro` | Tebukuro | 女性 |
| `jm_kumo` | Kumo | 男性 |

### synthesize リクエスト例

```json
{
  "text": "本日の重要ニュースをお伝えします。",
  "voice": "jf_alpha",
  "speed": 1.0
}
```

- `text`: 1〜5000 文字（必須）
- `voice`: ボイス ID（省略時はデフォルト）
- `speed`: 0.5〜2.0（省略時はデフォルト）

レスポンスは `audio/wav` バイナリ。

### 変更ファイル一覧

| ファイル | 操作 |
|---------|------|
| `tts-speaker/` (全ファイル) | 新規作成 |
| `compose.tts.yaml` | 新規作成 (リモートマシン用独立 Compose) |
| `.env.template` | TTS 関連変数 4 件追加 |
| `compose/ai.yaml` | news-creator に `extra_hosts` (tts-external) 追加 |
| `docs/services/tts-speaker.md` | 新規作成 |

### Dockerfile 設計

- **ビルドステージ**: `python:3.12-slim` + `uv` (ghcr.io/astral-sh/uv:0.5.14) + `espeak-ng` + PyTorch CPU 版
- **ランタイムステージ**: `python:3.12-slim` + `espeak-ng` + `curl` (healthcheck) + 非root ユーザー (`tts`)
- `OMP_NUM_THREADS=2`: TTS はシングルリクエスト想定、軽度の並列性で高速化
- `start_period=120s`: 初回モデルダウンロード（約 330MB）を考慮
- `HF_HOME=/app/.cache/huggingface`: Docker volume にキャッシュ

### 認証設計

- `X-Service-Token` ヘッダで検証（`/health` は認証不要）
- `SERVICE_SECRET` が空の場合は認証スキップ（開発モード）
- `SERVICE_SECRET_FILE` による Docker secrets パターン対応
- 認証は `app.state.settings` から読み取り、テスト時のモック注入と一貫性を保つ

### テスト結果

```
tests/unit/ — 23 passed in 0.19s
```

| テストファイル | 件数 | カバー範囲 |
|-------------|------|-----------|
| `test_health.py` | 2 | 正常/ローディング中 |
| `test_synthesize.py` | 8 | 成功、パラメータ、バリデーション (空/超過/範囲外)、503、500 |
| `test_voices.py` | 3 | リスト件数、ID 一覧、構造 |
| `test_auth.py` | 6 | トークン必須/不正/正常、dev モード、health 認証不要、voices 認証必須 |
| `test_config.py` | 4 | デフォルト値、環境変数、SECRET_FILE、速度範囲 |

## PROS

1. **軽量 CPU 推論**: 82M パラメータで GPU 不要、リモートマシンの CPU リソースを活用
2. **既存パターン踏襲**: compose.augur.yaml / extra_hosts パターンにより運用手順が統一
3. **TDD**: 23 件のテストで主要パスをカバー、パイプラインのモックで高速テスト
4. **疎結合**: 独立 Compose ファイルでメインスタックに影響なし、段階的なコンシューマー追加が可能

## CONS, TRADEOFF

1. **初回起動の遅さ**: モデルダウンロード（約 330MB）に時間がかかる。Docker volume キャッシュで 2 回目以降は解消
2. **CPU 推論の制約**: GPU 推論と比較すると生成速度は劣る。82M パラメータのため実用的だが、長文テキスト（5000 字近辺）では遅延が目立つ可能性あり
3. **単一言語**: 現時点では日本語 (`lang_code="j"`) のみ対応。多言語対応は将来的に KPipeline の `lang_code` 切り替えで拡張可能
4. **ボイス固定**: 5 件のハードコードされたボイスリスト。Kokoro のボイス追加時には `pipeline.py` の `VOICES` 定数更新が必要
