# Evening Pulse スキーマ増分マイグレーション

## ステータス

承認済み（2026-01-31）

## 背景

### 課題

ADR-161で実装したEvening Pulse v4.0のDBスキーマにおいて、`pulse_generations`テーブルの`target_date`カラムが本番環境で欠落していた。

原因：
1. 初期マイグレーション（`20260131000000_add_evening_pulse_tables.sql`）適用後にスキーマを修正
2. Atlasはマイグレーションファイルの変更を検知するが、既に適用済みのマイグレーションは再実行しない
3. 結果として、新規デプロイ環境と既存環境でスキーマの不整合が発生

### 要件

- 既存環境に`target_date`カラムを追加
- 新規環境では冪等に動作（カラム既存時はスキップ）
- `pulse_latest_generations`ビューに`target_date`を含める
- Atlasの正規フローで管理

## 決定事項

### 増分マイグレーションの作成

新規マイグレーションファイル`20260131000100_add_pulse_target_date.sql`を作成：

```sql
-- 冪等なカラム追加
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'pulse_generations'
        AND column_name = 'target_date'
    ) THEN
        ALTER TABLE pulse_generations
        ADD COLUMN target_date DATE NOT NULL DEFAULT CURRENT_DATE;
    END IF;
END $$;

-- 冪等なインデックス作成
CREATE INDEX IF NOT EXISTS idx_pulse_generations_target_date
    ON pulse_generations (target_date DESC);

-- ビュー再作成（カラム順序変更のためDROP必須）
DROP VIEW IF EXISTS pulse_latest_generations;
CREATE VIEW pulse_latest_generations AS ...;
```

### ビュー再作成の理由

PostgreSQLの制約：
- `CREATE OR REPLACE VIEW`はカラム順序の変更を許可しない
- 既存ビューに新しいカラムを途中に挿入するには`DROP VIEW`が必要

### Atlasベースライン設定

既存環境のハッシュ不整合を解消：

```bash
atlas migrate set 20260131000000 --url "..." --dir file:///migrations
```

これにより：
- 既存のリビジョン記録を正規化
- 新規マイグレーションのみを適用対象に

## 結果・影響

### 追加ファイル

| ファイル | 内容 |
|---------|------|
| `20260131000100_add_pulse_target_date.sql` | 増分マイグレーション |

### スキーマ変更

`pulse_generations`テーブル：
```
+ target_date DATE NOT NULL DEFAULT CURRENT_DATE
+ idx_pulse_generations_target_date (target_date DESC)
```

`pulse_latest_generations`ビュー：
```
+ target_date カラム追加（3番目の位置）
```

### Atlasステータス

```
Migration Status: OK
  -- Current Version: 20260131000100
  -- Executed Files:  24
  -- Pending Files:   0
```

### API動作確認

```bash
curl http://localhost:9005/v1/pulse/latest
# {"error": "No evening pulse found for date today"}
# ← 正常動作（データ未生成時の期待されるレスポンス）
```

## 教訓

### マイグレーション管理のベストプラクティス

1. **適用済みファイルは変更しない**: 既にデプロイされたマイグレーションファイルの変更は避ける
2. **増分マイグレーションで対応**: スキーマ変更は常に新規マイグレーションファイルで行う
3. **冪等性の確保**: `IF NOT EXISTS`、`IF EXISTS`を活用して再実行可能に
4. **ビュー変更の注意点**: カラム順序変更時は`DROP VIEW`が必要

### Atlas運用Tips

- `atlas migrate set`: ベースライン設定でハッシュ不整合を解消
- `atlas migrate status`: 現在の適用状況を確認
- `atlas migrate hash`: チェックサム再生成

## 関連ADR

- ADR-161: Evening Pulse v4.0 実装
