# ADR-000273: OGP 画像プロキシ有効化 — Docker Secret 設定による ImageProxyUsecase 起動

## ステータス

承認済み

## コンテキスト

### 背景

ADR-000272 で OGP 画像プロキシのバックエンド実装（HMAC 署名・キャッシュ・画像圧縮）を完了したが、本番環境でプロキシが一切動作していないことが判明した。ユーザーから「OGP 画像が表示される記事とされない記事がある」という報告を受け、調査を実施した。

### 調査結果

| 項目 | 結果 |
|------|------|
| `IMAGE_PROXY_ENABLED` | 未設定（デフォルト `true`） |
| `IMAGE_PROXY_SECRET` / `IMAGE_PROXY_SECRET_FILE` | **未設定（空）** |
| `ImageProxyUsecase` | **nil**（シークレット未設定のため初期化されない） |
| `image_proxy_cache` テーブル | **0 件**（プロキシ未稼働の証拠） |
| バックエンドログ `image_proxy` | **0 件**（プロキシハンドラ未到達） |
| `GET /v1/images/proxy/*` | **404**（ルート未登録） |

### 根本原因

`ImageProxyUsecase` の初期化条件が以下であるのに対し、シークレットが未設定だった:

```go
if cfg.ImageProxy.Enabled && cfg.ImageProxy.Secret != "" {
    // ImageProxyUsecase を初期化
}
```

`Enabled` はデフォルト `true` だが、`Secret` が空のため条件を満たさず、`ImageProxyUsecase` は nil のまま。結果として:

1. `FetchArticleContent` RPC が `og_image_proxy_url` を空で返却
2. フロントエンドは `og_image_url`（外部サーバー直接 URL）にフォールバック
3. 外部サーバーのhotlink保護・タイムアウト・CORS 制限で一部画像が表示不能

### 画像が表示されない 3 パターン

| パターン | 原因 | 頻度 |
|---------|------|------|
| FetchArticleContent のレートリミット失敗 | 同一ドメイン連続アクセスで 5 秒制限発動、高速スワイプで context キャンセル | 中（23件/2h） |
| 外部画像サーバーの拒否 | hotlink保護・リファラーチェック・CORS で 403/404 | 低〜中 |
| og:image 未設定または http のみ | HTML に og:image なし、または https でないため除外 | 低 |

## 意思決定

### Docker Secret によるシークレット配布

既存の secrets 管理パターン（`compose/base.yaml` での `file:` 定義 + サービスでの `_FILE` 環境変数）に従い、HMAC 署名用シークレットを Docker Secret として配布する。

既存の他のシークレット（`db_password`, `csrf_secret`, `service_secret` 等）と同じパターンを踏襲することで、運用の一貫性を維持する。

### 変更内容

#### 1. シークレットファイル生成

`openssl rand -hex 32` で 32 バイトのランダムシークレットを生成。

#### 2. compose/base.yaml — secrets 定義追加

```yaml
secrets:
  # ... 既存 ...
  image_proxy_secret:
    file: ../secrets/image_proxy_secret.txt
```

#### 3. compose/core.yaml — alt-backend への配布

```yaml
alt-backend:
  environment:
    # ... 既存 ...
    - IMAGE_PROXY_SECRET_FILE=/run/secrets/image_proxy_secret
  secrets:
    # ... 既存 ...
    - image_proxy_secret
```

### 不採用案

| 不採用案 | 理由 |
|---------|------|
| 環境変数に直接設定 (`IMAGE_PROXY_SECRET=xxx`) | Docker Secret パターンからの逸脱。`.env` にシークレットを平文保存するリスク |
| デフォルトシークレットの埋め込み | HMAC 署名の意味がなくなる。オープンプロキシ化リスク |
| プロキシを無効化して外部直接取得を維持 | ADR-000272 で決定済みのセキュリティ・パフォーマンス要件を満たさない |

## 結果・影響

### 動作確認

| 確認項目 | 結果 |
|---------|------|
| alt-backend 起動 | healthy |
| `GET /v1/images/proxy/test/test` | **403**（ルート登録済み、署名不正で正しく拒否） |
| 修正前の同エンドポイント | **404**（ルート未登録 = プロキシ無効） |

### 期待される改善効果

- **プロキシ URL 生成**: `FetchArticleContent` RPC が `og_image_proxy_url` を返却するようになる
- **hotlink 保護回避**: バックエンドが外部画像を取得するため、ブラウザのリファラーチェックを回避
- **キャッシュ活用**: `image_proxy_cache` + ブラウザ HTTP キャッシュ (ETag/Cache-Control) の 2 層キャッシュが機能
- **バッチプリフェッチ**: `BatchPrefetchImages` RPC による先読みキャッシュウォームが有効化

### PROS

- 既存の Docker Secret パターンに完全に従い、運用の一貫性を維持
- コードの変更なし（設定のみ）で ADR-000272 の全機能が有効化
- 変更ファイル 3 つのみの最小限の修正

### CONS, TRADEOFF

- ADR-000272 実装時にシークレット設定が漏れていたことが根本原因。今後の新機能実装時はシークレット設定のチェックリストが必要
- レートリミット失敗（23件/2h）は本修正では解消しない。別途対応が必要

## 付録

### 変更ファイル一覧

| ファイル | 変更 |
|---------|------|
| `secrets/image_proxy_secret.txt` | 新規: HMAC 署名用ランダムシークレット |
| `compose/base.yaml` | secrets 定義に `image_proxy_secret` 追加 |
| `compose/core.yaml` | alt-backend の environment + secrets に追加 |

### 関連 ADR

| ADR | 内容 |
|-----|------|
| ADR-000267〜271 | OGP 画像表示の段階的実装 |
| ADR-000272 | OGP 画像プロキシのバックエンド実装（HMAC 署名・キャッシュ・圧縮） |
| ADR-000273 (本 ADR) | プロキシ有効化のための Docker Secret 設定 |
