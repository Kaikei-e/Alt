# ADR-000248: SaveArticleSummary UUID エラー修正 — `user_id` パススルー

## ステータス

承認済み

## コンテキスト

### 問題

ADR-000247 で要約ポーリングパイプラインを復旧した後、news-creator による要約生成自体は成功していたが、**alt-backend での保存操作がすべて失敗**していた。

```
alt-backend: "Failed to save article summary",
  "error": "ERROR: invalid input syntax for type uuid: \"system\" (SQLSTATE 22P02)"
```

### 根本原因

`SaveArticleSummary` ゲートウェイメソッドが `user_id` パラメータとして文字列 `"system"` をハードコードしていた。

```go
// gateway.go（修正前）
func (g *Gateway) SaveArticleSummary(ctx, articleID, summary, language string) error {
    err := g.repo.SaveArticleSummary(ctx, articleID, "system", "", summary)
}
```

`article_summaries.user_id` カラムは `users.id` を参照する UUID 外部キーである。リテラル文字列 `"system"` は有効な UUID ではないため、INSERT のたびに PostgreSQL の型エラーが発生していた。

### 影響

- ADR-000247 デプロイ後、要約保存操作の 100% が失敗
- 要約パイプラインが GPU リソース（news-creator の推論）を消費するものの、結果が永続化されない
- 要約生成は成功しているにもかかわらず、未要約記事数が減少しない

## 意思決定

### 採用: RPC チェーン全体を通じた `user_id` の伝播

pre-processor は `ListUnsummarizedArticles` レスポンス（ADR-000247 で追加）から各記事の `user_id` を既に受信している。この修正では、`SaveArticleSummaryRequest` proto メッセージを通じてこの値を渡すことで、ハードコードされた値を排除する。

この方式を採用した理由:

1. **データが既に利用可能**: `UnsummarizedArticle.user_id` は articles テーブルから取得済み
2. **スキーママイグレーション不要**: カラムと外部キーは既に存在する
3. **影響範囲が最小限**: `SaveArticleSummary` の呼び出しチェーンのみ変更
4. **型安全性**: 実際の UUID が PostgreSQL のバリデーションを通過する

### 検討した代替案: ゲートウェイ内で user_id を検索

以下の理由で却下:

- 保存操作ごとに追加のデータベースクエリが必要になる
- 呼び出し元が記事自体から正しい `user_id` を既に保持している
- 要約保存パスと articles テーブルの間に不要な結合を生む

## 結果・影響

### 変更概要

**Proto レイヤー**（3 ファイル）:
- `services/backend/v1`、`clients/preprocessor-backend/v1`、`clients/backend/v1` の `SaveArticleSummaryRequest` に `string user_id = 4` を追加

**alt-backend**（5 ファイル）:
- **Port**: `SaveArticleSummaryPort.SaveArticleSummary` に `userID string` パラメータを追加
- **Handler**: `req.Msg.UserId` を抽出し、空でないことをバリデーション（空の場合 `CodeInvalidArgument` を返却）、Port に渡す
- **Gateway**: `userID` パラメータを受け取り、Driver に渡す（ハードコードされた `"system"` を削除）
- **Handler テスト**: `userID` パラメータのモック期待値を更新、`TestSaveArticleSummary_MissingUserID` を追加
- **Mocks**: `MockSaveArticleSummaryPort` を再生成

**pre-processor**（1 ファイル）:
- `SummaryRepository.Create()` が `SaveArticleSummaryRequest` に `summary.UserID` を送信するよう変更

### データフロー（修正後）

```
pre-processor
  ListUnsummarizedArticles → []{article_id, user_id, ...}
  news-creator /api/v1/summarize → 要約テキスト
  SaveArticleSummaryRequest{article_id, user_id, summary, language}
    → alt-backend Handler（user_id が空でないことをバリデーション）
      → Gateway（user_id を Driver に渡す）
        → Driver: INSERT INTO article_summaries(article_id, user_id, ...)
```

### テストカバレッジ

| パッケージ | 変更内容 | フォーカス |
|-----------|---------|-----------|
| `alt-backend/connect/v2/internal` | 1 修正、1 追加 | `TestSaveArticleSummary_Success` のモック更新、`TestSaveArticleSummary_MissingUserID` の追加 |
| `pre-processor/driver/backend_api` | ビルド確認済み | Proto フィールド追加は後方互換 |

### メリット

- 即時修正: デプロイ後、初回から要約が永続化される
- GPU 推論の無駄がなくなる: 生成されたすべての要約が保存される
- バリデーション: 空の `user_id` はハンドラー層で明確なエラーメッセージとともに拒否される
- 後方互換な Proto 変更: フィールド 4 の追加はワイヤー互換

### デメリット・トレードオフ

- pre-processor が `Create()` 呼び出し前に `ArticleSummary` の `UserID` を設定する必要がある。これを省略したコードパスがある場合、ハンドラーが `CodeInvalidArgument` を返す（サイレントな破損ではなくフェイルファスト）
- 孤立データのマイグレーションなし: この修正以前に保存に失敗した要約はそもそも永続化されていないため、クリーンアップは不要

## 付録

### 検証

コンテナのリビルド・再起動後、alt-backend のログで保存成功を確認:

```
alt-backend: "Article summary saved successfully", "article_id":"e099f075-...", "rows_affected":1
alt-backend: "Article summary saved successfully", "article_id":"ab9e58ab-...", "rows_affected":1
alt-backend: "Article summary saved successfully", "article_id":"e41e61dd-...", "rows_affected":1
```

`22P02`（無効な UUID）エラーは発生せず。pre-processor のログにも `"failed to save summary"` メッセージなし。

### 変更ファイル一覧

| ファイル | 操作 |
|---------|------|
| `proto/services/backend/v1/internal.proto` | `user_id` フィールド追加（フィールド 4） |
| `proto/clients/preprocessor-backend/v1/internal.proto` | `user_id` フィールド追加（フィールド 4） |
| `proto/clients/backend/v1/internal.proto` | `user_id` フィールド追加（フィールド 4） |
| `alt-backend/app/port/internal_article_port/port.go` | `userID` パラメータ追加 |
| `alt-backend/app/connect/v2/internal/handler.go` | `userID` 渡し、バリデーション追加 |
| `alt-backend/app/connect/v2/internal/handler_test.go` | 期待値更新、テスト追加 |
| `alt-backend/app/gateway/internal_article_gateway/gateway.go` | ハードコード値を削除 |
| `alt-backend/app/mocks/mock_internal_article_port.go` | 再生成 |
| `pre-processor/app/driver/backend_api/summary_driver.go` | `UserID` を送信 |
| 生成された Proto コード（2 パッケージ） | `buf generate` で再生成 |

### 関連 ADR

- ADR-000246: pre-processor-db 分離 — alt-db 依存の完全排除
- ADR-000247: 要約パイプライン修正（`ListUnsummarizedArticles` RPC）
