apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    kompose.cmd: kompose convert -f compose.yaml --out ./k8s-manifests/
    kompose.version: 1.36.0 (ae2a39403)
  labels:
    io.kompose.service: migrate
    app.kubernetes.io/name: migrate
  name: migrate
spec:
  # Job固有の設定
  backoffLimit: 3  # 失敗時の再試行回数
  activeDeadlineSeconds: 300  # 5分でタイムアウト
  ttlSecondsAfterFinished: 86400  # 24時間後に自動削除
  template:
    metadata:
      annotations:
        kompose.cmd: kompose convert -f compose.yaml --out ./k8s-manifests/
        kompose.version: 1.36.0 (ae2a39403)
      labels:
        io.kompose.service: migrate
        app.kubernetes.io/name: migrate
        app.kubernetes.io/component: migration
        app.kubernetes.io/part-of: alt-platform
    spec:
      containers:
        - env:
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: migrate-secrets
                  key: DB_PASSWORD
            - name: DB_URL
              value: pgx5://alt_db_user:$(DB_PASSWORD)@db.alt-database.svc.cluster.local:5432/alt?sslmode=disable&search_path=public
            - name: MIGRATE_MAX_RETRIES
              value: "12"
            - name: MIGRATE_RETRY_INTERVAL
              value: "5"
          image: migrate:production
          imagePullPolicy: Never
          name: db-migrator
          # マイグレーションの成功・失敗を確実に検出するためのコマンド
          command: ["/bin/sh"]
          args: ["-c", "echo 'Starting migration...' && migrate -path /migrations -database $DB_URL up && echo 'Migration completed successfully' || (echo 'Migration failed' && exit 1)"]
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          volumeMounts:
            - mountPath: /migrations
              name: migrate-cm0
            - mountPath: /etc/postgresql/postgresql.conf
              name: migrate-cm1
              subPath: postgresql.conf
      restartPolicy: Never  # Jobでは Never または OnFailure のみ使用可能
      volumes:
        - configMap:
            name: migrate-cm0
          name: migrate-cm0
        - configMap:
            items:
              - key: postgresql.conf
                path: postgresql.conf
            name: migrate-cm1
          name: migrate-cm1
