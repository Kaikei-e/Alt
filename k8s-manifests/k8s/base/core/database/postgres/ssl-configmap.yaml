apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: postgres
    io.kompose.service: db
  name: postgres-ssl-config
data:
  # PostgreSQL SSL configuration
  postgresql.conf: |
    # Network Configuration
    listen_addresses = '*'
    port = 5432
    max_connections = 100

    # SSL Configuration
    ssl = on
    ssl_cert_file = '/var/lib/postgresql/ssl/server.crt'
    ssl_key_file = '/var/lib/postgresql/ssl/server.key'
    ssl_ca_file = '/var/lib/postgresql/ssl/ca.crt'
    ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
    ssl_prefer_server_ciphers = on
    ssl_min_protocol_version = 'TLSv1.2'
    ssl_max_protocol_version = 'TLSv1.3'

    # Require SSL for all connections
    ssl_renegotiation_limit = 0

    # Log SSL connections
    log_connections = on
    log_disconnections = on
    log_statement = 'all'

    # Performance tuning
    shared_buffers = 256MB
    effective_cache_size = 1GB
    maintenance_work_mem = 64MB
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB
    default_statistics_target = 100
    random_page_cost = 1.1
    effective_io_concurrency = 200
    work_mem = 4MB
    min_wal_size = 1GB
    max_wal_size = 4GB

    # Query statistics
    shared_preload_libraries = 'pg_stat_statements'
    pg_stat_statements.max = 10000
    pg_stat_statements.track_utility = on

  # PostgreSQL client authentication configuration
  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    # Local connections (trust only for localhost)
    local   all             all                                     trust
    host    all             all             127.0.0.1/32            trust
    host    all             all             ::1/128                 trust

    # Kubernetes cluster internal connections (SSL required)
    hostssl all             all             10.0.0.0/8              md5
    hostssl all             all             172.16.0.0/12           md5
    hostssl all             all             192.168.0.0/16          md5

    # Deny all other connections
    host    all             all             0.0.0.0/0               reject