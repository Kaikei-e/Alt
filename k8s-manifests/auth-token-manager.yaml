# Auth Token Manager CronJob for OAuth Token Refresh
apiVersion: v1
kind: ConfigMap
metadata:
  name: auth-token-manager-config
  namespace: alt-processing
data:
  KUBERNETES_NAMESPACE: "alt-processing"
  SECRET_NAME: "pre-processor-sidecar-oauth2-token"
  BROWSER_HEADLESS: "true"
  LOG_LEVEL: "INFO"
  RETRY_MAX_ATTEMPTS: "3"
  NODE_ENV: "production"
---
apiVersion: v1
kind: Secret
metadata:
  name: inoreader-credentials
  namespace: alt-processing
type: Opaque
stringData:
  INOREADER_USERNAME: "your-inoreader-username"
  INOREADER_PASSWORD: "your-inoreader-password"
  INOREADER_CLIENT_ID: "your-client-id"
  INOREADER_CLIENT_SECRET: "your-client-secret"
  INOREADER_REDIRECT_URI: "http://localhost:8080/callback"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: auth-token-manager
  namespace: alt-processing
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: auth-token-manager-role
  namespace: alt-processing
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "create", "update", "patch"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["batch"]
  resources: ["jobs", "cronjobs"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: auth-token-manager-binding
  namespace: alt-processing
subjects:
- kind: ServiceAccount
  name: auth-token-manager
  namespace: alt-processing
roleRef:
  kind: Role
  name: auth-token-manager-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: auth-token-manager
  namespace: alt-processing
  labels:
    app: auth-token-manager
    component: oauth-automation
spec:
  schedule: "0 */6 * * *"  # Every 6 hours
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 1
  suspend: false
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 900  # 15 minutes timeout
      template:
        metadata:
          labels:
            app: auth-token-manager
            component: oauth-automation
        spec:
          serviceAccountName: auth-token-manager
          restartPolicy: Never
          shareProcessNamespace: true  # Required for Playwright browser process management
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
          containers:
          - name: auth-token-manager
            image: auth-token-manager:latest
            imagePullPolicy: IfNotPresent
            command: ["deno", "run", "--allow-all", "main.ts", "refresh"]
            envFrom:
            - configMapRef:
                name: auth-token-manager-config
            - secretRef:
                name: inoreader-credentials
            resources:
              requests:
                memory: "512Mi"  # Increased for Playwright browsers
                cpu: "200m"
              limits:
                memory: "1Gi"    # Increased for Playwright browsers
                cpu: "1000m"
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false  # Playwright needs write access
              runAsNonRoot: true
              runAsUser: 1000
              capabilities:
                drop:
                - ALL
                add:
                - SYS_ADMIN  # Required for Chromium sandbox
            volumeMounts:
            - name: shm-volume
              mountPath: /dev/shm
          volumes:
          - name: shm-volume
            emptyDir:
              medium: Memory
              sizeLimit: 256Mi  # Shared memory for Chromium
          nodeSelector:
            kubernetes.io/os: linux
          tolerations:
          - key: "kubernetes.io/arch"
            operator: "Equal"
            value: "amd64"
            effect: "NoSchedule"
---
# Manual Job for testing
apiVersion: batch/v1
kind: Job
metadata:
  name: auth-token-manager-test
  namespace: alt-processing
  labels:
    app: auth-token-manager
    component: oauth-automation
    type: test
spec:
  backoffLimit: 1
  activeDeadlineSeconds: 600  # 10 minutes timeout
  template:
    metadata:
      labels:
        app: auth-token-manager
        component: oauth-automation
        type: test
    spec:
      serviceAccountName: auth-token-manager
      restartPolicy: Never
      shareProcessNamespace: true  # Required for Playwright browser process management
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
      - name: auth-token-manager
        image: auth-token-manager:latest
        imagePullPolicy: IfNotPresent
        command: ["deno", "run", "--allow-all", "main.ts", "health"]
        envFrom:
        - configMapRef:
            name: auth-token-manager-config
        - secretRef:
            name: inoreader-credentials
        resources:
          requests:
            memory: "256Mi"  # Increased for Playwright
            cpu: "100m"
          limits:
            memory: "512Mi"  # Increased for Playwright
            cpu: "500m"
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
            - ALL
            add:
            - SYS_ADMIN  # Required for Chromium sandbox
        volumeMounts:
        - name: shm-volume
          mountPath: /dev/shm
      volumes:
      - name: shm-volume
        emptyDir:
          medium: Memory
          sizeLimit: 256Mi  # Shared memory for Chromium
      nodeSelector:
        kubernetes.io/os: linux