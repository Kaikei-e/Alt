apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "csr-controller.fullname" . }}-compliance-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "csr-controller.labels" . | nindent 4 }}
    app.kubernetes.io/component: compliance
data:
  compliance-config.yaml: |
    # Compliance Configuration for CSR Controller
    version: "1.0"
    
    # Global compliance settings
    global:
      enabled: true
      reporting_interval: "24h"
      audit_retention: "7y"
      compliance_dashboard: true
      
    # SOC 2 Type II Compliance
    soc2:
      enabled: {{ has "SOC2" .Values.securityPolicyEngine.compliance.standards }}
      version: "2017"
      
      # Trust Services Criteria
      trust_services:
        # Security (Common Criteria)
        security:
          logical_access:
            - control_id: "CC6.1"
              description: "Logical access security measures"
              implementation: "kubernetes_rbac"
              evidence: "rbac_policies"
            
            - control_id: "CC6.2"
              description: "Authentication and authorization"
              implementation: "service_account_tokens"
              evidence: "authentication_logs"
            
            - control_id: "CC6.3"
              description: "System access monitoring"
              implementation: "audit_logging"
              evidence: "access_logs"
          
          system_operations:
            - control_id: "CC7.1"
              description: "System capacity monitoring"
              implementation: "metrics_collection"
              evidence: "performance_metrics"
            
            - control_id: "CC7.2"
              description: "System backup and recovery"
              implementation: "automated_backups"
              evidence: "backup_logs"
        
        # Availability
        availability:
          - control_id: "A1.1"
            description: "System availability commitments"
            implementation: "high_availability_deployment"
            evidence: "uptime_metrics"
          
          - control_id: "A1.2"
            description: "System capacity planning"
            implementation: "autoscaling"
            evidence: "capacity_reports"
        
        # Processing Integrity
        processing_integrity:
          - control_id: "PI1.1"
            description: "Data processing accuracy"
            implementation: "certificate_validation"
            evidence: "validation_logs"
          
          - control_id: "PI1.2"
            description: "Data processing completeness"
            implementation: "end_to_end_tracking"
            evidence: "processing_logs"
        
        # Confidentiality
        confidentiality:
          - control_id: "C1.1"
            description: "Data encryption in transit"
            implementation: "tls_encryption"
            evidence: "encryption_logs"
          
          - control_id: "C1.2"
            description: "Data encryption at rest"
            implementation: "secret_encryption"
            evidence: "encryption_status"
      
      # Automated compliance checks
      automated_checks:
        - name: "access_control_verification"
          frequency: "hourly"
          check_type: "rbac_policy_compliance"
          
        - name: "encryption_validation"
          frequency: "daily"
          check_type: "tls_certificate_validation"
          
        - name: "audit_log_integrity"
          frequency: "daily"
          check_type: "log_integrity_verification"
      
      # Compliance reporting
      reporting:
        frequency: "quarterly"
        format: "soc2_report"
        recipients:
          - "compliance-team@alt.production.local"
          - "audit-team@alt.production.local"
    
    # PCI DSS Compliance
    pci_dss:
      enabled: {{ has "PCI_DSS" .Values.securityPolicyEngine.compliance.standards }}
      version: "4.0"
      
      # PCI DSS Requirements
      requirements:
        # Requirement 1: Install and maintain firewall configuration
        req_1:
          - control_id: "1.1"
            description: "Firewall configuration standards"
            implementation: "network_policies"
            evidence: "network_policy_configs"
          
          - control_id: "1.2"
            description: "Firewall configurations that restrict connections"
            implementation: "ingress_egress_rules"
            evidence: "firewall_rules"
        
        # Requirement 2: Do not use vendor-supplied defaults
        req_2:
          - control_id: "2.1"
            description: "Change vendor-supplied defaults"
            implementation: "custom_configurations"
            evidence: "config_change_logs"
          
          - control_id: "2.2"
            description: "Develop configuration standards"
            implementation: "security_hardening"
            evidence: "hardening_checklist"
        
        # Requirement 3: Protect stored cardholder data
        req_3:
          - control_id: "3.1"
            description: "Keep cardholder data storage to minimum"
            implementation: "data_minimization"
            evidence: "data_inventory"
          
          - control_id: "3.2"
            description: "Do not store sensitive authentication data"
            implementation: "no_sensitive_data_storage"
            evidence: "data_classification"
        
        # Requirement 4: Encrypt transmission of cardholder data
        req_4:
          - control_id: "4.1"
            description: "Use strong cryptography for data transmission"
            implementation: "tls_encryption"
            evidence: "encryption_protocols"
          
          - control_id: "4.2"
            description: "Never send PANs by unprotected email"
            implementation: "secure_communication"
            evidence: "communication_policies"
      
      # Automated compliance checks
      automated_checks:
        - name: "encryption_strength_validation"
          frequency: "daily"
          check_type: "cryptographic_strength"
          
        - name: "access_control_review"
          frequency: "weekly"
          check_type: "privilege_validation"
          
        - name: "vulnerability_scanning"
          frequency: "monthly"
          check_type: "security_vulnerability_scan"
      
      # Quarterly compliance assessment
      assessment:
        frequency: "quarterly"
        scope: "network_segmentation"
        assessor: "qualified_security_assessor"
    
    # FIPS 140-2 Compliance
    fips_140_2:
      enabled: {{ has "FIPS_140_2" .Values.securityPolicyEngine.compliance.standards }}
      level: "Level 2"
      
      # Cryptographic requirements
      cryptographic:
        approved_algorithms:
          - "AES-256"
          - "RSA-2048"
          - "ECDSA-P256"
          - "SHA-256"
          - "HMAC-SHA-256"
        
        forbidden_algorithms:
          - "DES"
          - "3DES"
          - "MD5"
          - "SHA-1"
          - "RC4"
        
        key_management:
          - requirement: "secure_key_generation"
            implementation: "hardware_rng"
            evidence: "entropy_validation"
          
          - requirement: "key_storage_protection"
            implementation: "hsm_integration"
            evidence: "key_storage_audit"
          
          - requirement: "key_destruction"
            implementation: "secure_deletion"
            evidence: "key_lifecycle_logs"
      
      # Physical security requirements
      physical_security:
        - requirement: "tamper_evidence"
          implementation: "sealed_hardware"
          evidence: "physical_inspection"
        
        - requirement: "tamper_response"
          implementation: "automated_zeroization"
          evidence: "tamper_response_logs"
      
      # Automated compliance validation
      validation:
        - name: "algorithm_compliance"
          frequency: "continuous"
          check_type: "cryptographic_validation"
          
        - name: "key_management_audit"
          frequency: "daily"
          check_type: "key_lifecycle_validation"
    
    # ISO 27001 Compliance
    iso_27001:
      enabled: {{ has "ISO_27001" .Values.securityPolicyEngine.compliance.standards }}
      version: "2022"
      
      # Information Security Management System (ISMS)
      isms:
        # A.5 - Information security policies
        a5:
          - control_id: "A.5.1"
            description: "Information security policy"
            implementation: "security_policy_engine"
            evidence: "policy_documents"
        
        # A.6 - Organization of information security
        a6:
          - control_id: "A.6.1"
            description: "Information security roles and responsibilities"
            implementation: "rbac_definitions"
            evidence: "role_assignments"
        
        # A.8 - Asset management
        a8:
          - control_id: "A.8.1"
            description: "Responsibility for assets"
            implementation: "asset_inventory"
            evidence: "asset_register"
          
          - control_id: "A.8.2"
            description: "Information classification"
            implementation: "data_classification"
            evidence: "classification_labels"
        
        # A.9 - Access control
        a9:
          - control_id: "A.9.1"
            description: "Business requirements for access control"
            implementation: "access_control_policy"
            evidence: "access_control_matrix"
          
          - control_id: "A.9.2"
            description: "User access management"
            implementation: "identity_management"
            evidence: "user_access_logs"
        
        # A.10 - Cryptography
        a10:
          - control_id: "A.10.1"
            description: "Cryptographic controls"
            implementation: "cryptographic_standards"
            evidence: "crypto_implementation"
      
      # Risk management
      risk_management:
        risk_assessment:
          frequency: "annually"
          methodology: "iso_27005"
          scope: "certificate_management_system"
        
        risk_treatment:
          - risk_id: "R001"
            description: "CA key compromise"
            treatment: "hsm_protection"
            
          - risk_id: "R002"
            description: "Unauthorized certificate issuance"
            treatment: "multi_factor_authentication"
            
          - risk_id: "R003"
            description: "Certificate misuse"
            treatment: "continuous_monitoring"
      
      # Continuous improvement
      improvement:
        - activity: "internal_audit"
          frequency: "quarterly"
          scope: "security_controls"
        
        - activity: "management_review"
          frequency: "annually"
          scope: "isms_effectiveness"
        
        - activity: "corrective_actions"
          frequency: "as_needed"
          scope: "nonconformities"
    
    # Compliance reporting and monitoring
    reporting:
      # Compliance dashboard
      dashboard:
        enabled: true
        refresh_interval: "5m"
        metrics:
          - "compliance_score"
          - "control_effectiveness"
          - "risk_level"
          - "audit_findings"
      
      # Automated reports
      automated_reports:
        - name: "daily_compliance_summary"
          frequency: "daily"
          recipients: ["compliance-team@alt.production.local"]
          format: "json"
        
        - name: "weekly_control_status"
          frequency: "weekly"
          recipients: ["security-team@alt.production.local"]
          format: "html"
        
        - name: "monthly_executive_summary"
          frequency: "monthly"
          recipients: ["management@alt.production.local"]
          format: "pdf"
        
        - name: "quarterly_audit_report"
          frequency: "quarterly"
          recipients: ["audit-team@alt.production.local"]
          format: "formal_report"
      
      # Evidence collection
      evidence_collection:
        automated: true
        retention_period: "7y"
        encryption: true
        backup: true
        
        evidence_types:
          - "configuration_snapshots"
          - "audit_logs"
          - "access_logs"
          - "security_events"
          - "compliance_assessments"
          - "penetration_test_results"
          - "vulnerability_scans"
    
    # Integration with external systems
    integrations:
      # GRC platforms
      grc_platforms:
        - name: "rsam"
          enabled: false
          endpoint: "https://rsam.alt.production.local"
          
        - name: "servicenow_grc"
          enabled: false
          endpoint: "https://servicenow.alt.production.local"
      
      # Audit systems
      audit_systems:
        - name: "splunk"
          enabled: true
          endpoint: "https://splunk.alt.production.local"
          
        - name: "elastic_security"
          enabled: true
          endpoint: "https://elastic.alt.production.local"
      
      # Risk management systems
      risk_systems:
        - name: "archer"
          enabled: false
          endpoint: "https://archer.alt.production.local"