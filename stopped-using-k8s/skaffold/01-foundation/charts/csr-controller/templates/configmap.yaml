apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "csr-controller.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "csr-controller.labels" . | nindent 4 }}
data:
  config.yaml: |
    signer:
      name: {{ include "csr-controller.signerName" . }}
      certificateValidityPeriod: {{ .Values.csrController.certificateValidityPeriod }}
    
    ca:
      secretName: {{ include "csr-controller.caSecretName" . }}
      certPath: {{ .Values.csrController.ca.certPath }}
      keyPath: {{ .Values.csrController.ca.keyPath }}
    
    approval:
      autoApprove: {{ .Values.csrController.approvalPolicy.autoApprove }}
      allowedDNSPatterns:
        {{- range .Values.csrController.approvalPolicy.allowedDNSPatterns }}
        - {{ . | quote }}
        {{- end }}
      allowedIPAddresses:
        {{- range .Values.csrController.approvalPolicy.allowedIPAddresses }}
        - {{ . | quote }}
        {{- end }}
      allowedUserPatterns:
        {{- range .Values.csrController.approvalPolicy.allowedUserPatterns }}
        - {{ . | quote }}
        {{- end }}
    
    monitoring:
      enabled: {{ .Values.csrController.monitoring.enabled }}
      metricsPort: {{ .Values.csrController.monitoring.metricsPort }}
      healthPort: {{ .Values.csrController.monitoring.healthPort }}
    
    logging:
      level: {{ .Values.logging.level }}
      format: {{ .Values.logging.format }}
    
    # Certificate distribution configuration
    distribution:
      namespaces:
        - "alt-production"
        - "alt-apps"
        - "alt-database"
        - "alt-auth"
        - "alt-ingress"
        - "alt-search"
      
      # ConfigMap for CA bundle distribution
      caBundleConfigMap:
        name: "ca-bundle"
        key: "ca.crt"
      
      # Certificate secret template
      certificateSecretTemplate:
        type: "kubernetes.io/tls"
        labels:
          app.kubernetes.io/component: "ssl-certificate"
          app.kubernetes.io/managed-by: "csr-controller"
          deploy-cli/managed: "true"