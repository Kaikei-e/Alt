{{- if .Values.egress.networkPolicy.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "envoy-proxy.fullname" . }}-external-egress
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "envoy-proxy.labels" . | nindent 4 }}
    app.kubernetes.io/component: network-policy
  annotations:
    description: "HTTPS-only egress policy for envoy-proxy RSS feed access"
    security.policy/purpose: "RSS feed external access via Dynamic Forward Proxy"
    security.policy/principle: "least-privilege"
    rfc1918.protection: "enabled"
spec:
  # Target only envoy-proxy pods for external access
  podSelector:
    matchLabels:
      {{- include "envoy-proxy.selectorLabels" . | nindent 6 }}
  
  policyTypes:
  - Egress
  
  egress:
  # Allow HTTPS (443) and DNS (53) to external internet only
  - ports:
    - protocol: TCP
      port: 443    # HTTPS only - HTTP (80) completely blocked
    - protocol: UDP
      port: 53     # DNS resolution
    - protocol: TCP
      port: 53     # DNS over TCP
    to:
    - ipBlock:
        # Allow all external internet (0.0.0.0/0)
        cidr: 0.0.0.0/0
        except:
        {{- range .Values.egress.networkPolicy.blockedCidrs }}
        - {{ . }}
        {{- end }}
  
  # Allow communication to internal cluster services (DNS, Linkerd)
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  - to:
    - namespaceSelector:
        matchLabels:
          linkerd.io/is-control-plane: "true"
    ports:
    {{- range .Values.egress.networkPolicy.linkerdPorts }}
    - protocol: TCP
      port: {{ . }}
    {{- end }}
{{- end }}