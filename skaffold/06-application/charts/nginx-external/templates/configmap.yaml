{{- if .Values.configMap.create }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "nginx-external.configMapName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "nginx-external.labels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
data:
  nginx.conf: |
    # =========================
    # nginx-external (FULL FIX)
    # =========================

    worker_processes auto;
    worker_rlimit_nofile 65535;
    error_log /var/log/nginx/error.log warn;
    pid /tmp/nginx.pid;

    events {
      worker_connections 2048;
      use epoll;
      multi_accept on;
    }

    http {
      # --- DNS (変数付き proxy_pass 用) ---
      # NOTE: .Values.dns.coredsIP は意図的に踏襲（値が入っている前提）
      resolver {{ .Values.dns.coredsIP | default "10.96.0.10" }} valid=5s ipv6=off;
      resolver_timeout 3s;

      # --- Upgrade/WS と HTTPS 透過ヘッダ（CF対応） ---
      map $http_upgrade $connection_upgrade { default upgrade; '' close; }
      map $http_x_forwarded_proto $xfp { default $http_x_forwarded_proto; '' https; }

      include /etc/nginx/mime.types;
      default_type application/octet-stream;
      sendfile on;
      tcp_nopush on;
      tcp_nodelay on;
      keepalive_timeout 65;
      types_hash_max_size 2048;
      client_max_body_size 20m;
      server_tokens off;

      # --- Real IP (Cloudflare) ---
      # CF-Connecting-IP を信頼
      real_ip_header CF-Connecting-IP;
      real_ip_recursive on;
      # Cloudflare公開レンジ（抜粋）
      set_real_ip_from 103.21.244.0/22;
      set_real_ip_from 103.22.200.0/22;
      set_real_ip_from 104.16.0.0/13;
      set_real_ip_from 104.24.0.0/14;
      set_real_ip_from 108.162.192.0/18;
      set_real_ip_from 172.64.0.0/13;
      set_real_ip_from 173.245.48.0/20;

      # --- アクセスログ（詳細） ---
      log_format external_main '$remote_addr - $remote_user "[$time_local]" "$request" '
                               '$status $body_bytes_sent "$http_referer" '
                               '"$http_user_agent" "$http_x_forwarded_for" '
                               'rt=$request_time upstream="$upstream_addr" '
                               'upstream_status="$upstream_status" '
                               'uct="$upstream_connect_time" '
                               'urt="$upstream_response_time"';
      access_log /var/log/nginx/access.log external_main;

      # --- レート制限（据え置き） ---
      limit_req_zone $binary_remote_addr zone=api_limit:10m rate=1200r/m;
      limit_req_zone $binary_remote_addr zone=general_limit:10m rate=40r/s;
      limit_req_zone $binary_remote_addr zone=feed_register:10m rate=60r/m;
      limit_conn_zone $binary_remote_addr zone=addr:10m;

      # --- Gzip ---
      gzip on; gzip_vary on; gzip_min_length 1024; gzip_proxied any; gzip_comp_level 6;
      gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;

      # ----------------------------------------------------------------
      # id.curionoah.com → Kratos Public（透過プロキシ）
      # ----------------------------------------------------------------
      server {
        listen 80;
        listen [::]:80;
        server_name id.curionoah.com;

        # HSTS は HTTPS 応答でのみ有効。ここ(HTTP)では付与しない（CF 側で付与推奨）。

        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;

        location /external-health {
          access_log off;
          add_header Content-Type "text/plain; charset=utf-8";
          add_header X-Health-Check "kratos-proxy-transparent" always;
          return 200 "Kratos Proxy Health OK\nUpstream: kratos-public.alt-auth.svc.cluster.local:4433\n";
        }

        location / {
          set $kratos_upstream "kratos-public.alt-auth.svc.cluster.local:4433";
          proxy_pass http://$kratos_upstream;

          # 重要: CF→Origin のプロトコルを正しく伝える
          proxy_set_header Host              $host;
          proxy_set_header X-Real-IP         $remote_addr;
          proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $xfp;
          proxy_set_header X-Forwarded-Host  $host;
          proxy_set_header X-Request-ID      $request_id;

          proxy_http_version 1.1;
          proxy_set_header Upgrade           $http_upgrade;
          proxy_set_header Connection        $connection_upgrade;

          proxy_connect_timeout 10s;
          proxy_send_timeout 30s;
          proxy_read_timeout 30s;

          proxy_buffering on;
          proxy_buffer_size 4k;
          proxy_buffers 8 4k;

          add_header X-Kratos-Proxy "nginx-external-transparent" always;
        }
      }

      # ----------------------------------------------------------------
      # curionoah.com（メイン）
      # ----------------------------------------------------------------
      server {
        listen 80;
        listen [::]:80;
        server_name curionoah.com;

        # HSTS は HTTPS 応答でのみ有効（CF 側で付与推奨）
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

        add_header X-Request-ID $request_id always;
        add_header X-Alt-Pod    $hostname   always;
        add_header X-Upstream-Addr   $upstream_addr   always;
        add_header X-Upstream-Status $upstream_status always;

        # ===== Next static (JS/MJS) =====
        location ~ ^/_next/static/.*\.(js|mjs)$ {
          proxy_pass http://alt-frontend.alt-apps.svc.cluster.local:3000;
          proxy_hide_header Content-Type;
          add_header Content-Type "application/javascript; charset=utf-8" always;
          add_header Cache-Control "public, max-age=31536000, immutable" always;

          proxy_set_header Host              $host;
          proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $xfp;
          proxy_http_version 1.1;
          proxy_set_header Upgrade           $http_upgrade;
          proxy_set_header Connection        $connection_upgrade;

          proxy_connect_timeout {{ .Values.nginx.timeouts.proxyConnect }};
          proxy_send_timeout    {{ .Values.nginx.timeouts.proxySend }};
          proxy_read_timeout    {{ .Values.nginx.timeouts.proxyRead }};
        }

        # ===== Next static (CSS) =====
        location ~ ^/_next/static/.*\.css$ {
          proxy_pass http://alt-frontend.alt-apps.svc.cluster.local:3000;
          proxy_hide_header Content-Type;
          add_header Content-Type "text/css; charset=utf-8" always;
          add_header Cache-Control "public, max-age=31536000, immutable" always;

          proxy_set_header Host              $host;
          proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $xfp;
          proxy_http_version 1.1;
          proxy_set_header Upgrade           $http_upgrade;
          proxy_set_header Connection        $connection_upgrade;

          proxy_connect_timeout {{ .Values.nginx.timeouts.proxyConnect }};
          proxy_send_timeout    {{ .Values.nginx.timeouts.proxySend }};
          proxy_read_timeout    {{ .Values.nginx.timeouts.proxyRead }};
        }

        # ===== その他の /_next/static/ =====
        location ^~ /_next/static/ {
          proxy_pass http://alt-frontend.alt-apps.svc.cluster.local:3000;

          proxy_set_header Host              $host;
          proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $xfp;
          proxy_http_version 1.1;
          proxy_set_header Upgrade           $http_upgrade;
          proxy_set_header Connection        $connection_upgrade;

          proxy_connect_timeout {{ .Values.nginx.timeouts.proxyConnect }};
          proxy_send_timeout    {{ .Values.nginx.timeouts.proxySend }};
          proxy_read_timeout    {{ .Values.nginx.timeouts.proxyRead }};
        }

        # ===== Frontend health =====
        location /api/health {
          set $frontend_upstream "alt-frontend.alt-apps.svc.cluster.local:3000";
          proxy_pass http://$frontend_upstream;

          proxy_set_header Host              $host;
          proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $xfp;
          proxy_http_version 1.1;
          proxy_set_header Upgrade           $http_upgrade;
          proxy_set_header Connection        $connection_upgrade;

          proxy_connect_timeout 5s;
          proxy_send_timeout 10s;
          proxy_read_timeout 10s;

          add_header X-Health-Source "alt-frontend" always;
        }

        # ===== CSRF 直通 =====
        location = /api/auth/csrf {
          set $auth_upstream "auth-service.alt-auth.svc.cluster.local:8080";
          proxy_pass http://$auth_upstream/v1/auth/csrf;

          proxy_set_header Host              $host;
          proxy_set_header X-Real-IP         $remote_addr;
          proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $xfp;
          proxy_set_header X-Request-ID      $request_id;

          proxy_set_header X-Internal-Service "nginx-external";
          proxy_set_header X-Service-Route    "csrf-direct";

          proxy_set_header Cookie $http_cookie;
          proxy_pass_header Set-Cookie;

          proxy_http_version 1.1;
          proxy_set_header Upgrade    $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_connect_timeout 10s;
          proxy_send_timeout 30s;
          proxy_read_timeout 30s;

          proxy_buffering on;
          proxy_buffer_size 4k;
          proxy_buffers 8 4k;

          proxy_next_upstream error timeout http_502 http_503 http_504;
          proxy_next_upstream_tries 2;
          proxy_next_upstream_timeout 20s;

          add_header X-Auth-Source "auth-service-direct" always;
          add_header X-CSRF-Fix    "X26-Phase1-Direct-Route" always;
        }

        # ===== 認証系 それ以外（Next へ） =====
        location /api/auth/ {
          set $frontend_upstream "alt-frontend.alt-apps.svc.cluster.local:3000";
          proxy_pass http://$frontend_upstream;

          proxy_set_header Host              $host;
          proxy_set_header X-Real-IP         $remote_addr;
          proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $xfp;
          proxy_set_header X-Request-ID      $request_id;

          proxy_set_header Cookie $http_cookie;
          proxy_pass_header Set-Cookie;

          proxy_http_version 1.1;
          proxy_set_header Upgrade    $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_connect_timeout 10s;
          proxy_send_timeout 30s;
          proxy_read_timeout 30s;

          proxy_buffering on;
          proxy_buffer_size 4k;
          proxy_buffers 8 4k;

          proxy_next_upstream error timeout http_502 http_503 http_504;
          proxy_next_upstream_tries 2;
          proxy_next_upstream_timeout 20s;

          add_header X-Auth-Source "alt-frontend-proxy" always;
        }

        # ===== Backend API (/api → / に正規化) =====
        location /api/ {
          set $backend_upstream "alt-backend.alt-apps.svc.cluster.local:9000";
          set $original_uri $uri;
          rewrite ^/api(.*)$ $1 break;
          proxy_pass http://$backend_upstream;

          proxy_set_header X-Original-URI    $original_uri;
          proxy_set_header X-Forwarded-Prefix "/api";

          proxy_set_header Host              $host;
          proxy_set_header X-Real-IP         $remote_addr;
          proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $xfp;
          proxy_set_header X-Request-ID      $request_id;

          proxy_http_version 1.1;
          proxy_set_header Upgrade    $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          limit_req zone=api_limit burst=300 nodelay;
          limit_conn addr 20;

          proxy_buffering on;
          proxy_buffer_size 8k;
          proxy_buffers 16 8k;
          proxy_busy_buffers_size 16k;

          proxy_connect_timeout 15s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;

          proxy_next_upstream error timeout http_502 http_503 http_504;
          proxy_next_upstream_tries 3;
          proxy_next_upstream_timeout 45s;
        }

        # ===== ルート（Next） =====
        location / {
          proxy_pass http://alt-frontend.alt-apps.svc.cluster.local:3000;

          add_header X-Req-Host $host always;
          add_header X-Srv-Name $server_name always;
          add_header X-Alt-Pod  $hostname always;

          proxy_set_header Host              $host;
          proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $xfp;

          proxy_pass_header Cache-Control;
          proxy_pass_header ETag;

          proxy_http_version 1.1;
          proxy_set_header Upgrade    $http_upgrade;
          proxy_set_header Connection $connection_upgrade;

          proxy_connect_timeout 5s;
          proxy_read_timeout 75s;
          proxy_send_timeout 75s;

          proxy_next_upstream error timeout http_502 http_503 http_504;
          proxy_next_upstream_tries 3;
          proxy_next_upstream_timeout 60s;

          proxy_buffering off;
        }

        # ===== Health =====
        location /external-health {
          access_log off;
          add_header Content-Type "text/plain; charset=utf-8";
          add_header X-Health-Check "external-ultrathink-permanent-fix" always;
          return 200 "OK\n";
        }

        # ===== Block =====
        location ~ /\. { deny all; access_log off; log_not_found off; }
        location ~ /(wp-admin|wp-login|admin|phpmyadmin) { deny all; access_log off; log_not_found off; }
      }

      # ---- 8080 (probe) ----
      server {
        listen 8080 default_server;
        listen [::]:8080 default_server;
        server_name _;
        access_log off;

        location /nginx-health {
          add_header X-Health-Check "nginx-external" always;
          add_header X-Pod-Name "$hostname" always;
          return 200 "nginx-external alive\n";
        }

        location / { add_header Content-Type "text/plain; charset=utf-8"; return 404 "Not Found\n"; }
      }

      # ---- 8888/8889 (egress/proxy) は省略: 本番は閉域推奨 ----
    }

{{- end }}
