{{- if .Values.configMap.create }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "nginx-external.configMapName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "nginx-external.labels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
data:
  nginx.conf: |
    # nginx-external main configuration
    # æ•™è‚²çš„è¨­è¨ˆ: æ˜ç¢ºæ€§ã¨ä¿å®ˆæ€§ã‚’é‡è¦–ã—ãŸæ§‹é€ 

    # ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹è¨­å®š: å¤–éƒ¨ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯å‡¦ç†æœ€é©åŒ–
    worker_processes auto;
    worker_rlimit_nofile 65535;

    # ãƒ­ã‚°è¨­å®š: å•é¡Œè¨ºæ–­ã®ãŸã‚ã®è©³ç´°ãƒ­ã‚°
    error_log /var/log/nginx/error.log warn;
    pid /tmp/nginx.pid;

    # ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†è¨­å®š: é«˜è² è·å¤–éƒ¨ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯å¯¾å¿œ
    events {
        worker_connections 2048;
        use epoll;
        multi_accept on;
    }

    # HTTPã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: ã™ã¹ã¦ã®HTTPè¨­å®šã‚’çµ±æ‹¬
    http {
        # åŸºæœ¬MIMEè¨­å®š: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—èªè­˜ã®ãŸã‚ã®åŸºç›¤
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–è¨­å®š
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        client_max_body_size 20m;
        server_tokens off;

        # Real IPè¨­å®š: ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼èƒŒå¾Œã§ã®æ­£ç¢ºãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIPå–å¾—
        real_ip_header X-Forwarded-For;
        real_ip_recursive on;
        set_real_ip_from 10.0.0.0/8;
        set_real_ip_from 172.16.0.0/12;
        set_real_ip_from 192.168.0.0/16;
        set_real_ip_from 169.254.0.0/16; # AWS metadata service

        # ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç”¨è©³ç´°ãƒ­ã‚°
        log_format external_main '$remote_addr - $remote_user "{{`[$time_local]`}}" "$request" '
                                '$status $body_bytes_sent "$http_referer" '
                                '"$http_user_agent" "$http_x_forwarded_for" '
                                'rt=$request_time upstream="$upstream_addr" '
                                'upstream_status="$upstream_status" '
                                'upstream_connect_time="$upstream_connect_time" '
                                'upstream_response_time="$upstream_response_time"';

        access_log /var/log/nginx/access.log external_main;

        # ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¨­å®š: RSS feed registration optimized
        limit_req_zone $binary_remote_addr zone=api_limit:10m rate=1200r/m;
        limit_req_zone $binary_remote_addr zone=general_limit:10m rate=40r/s;
        limit_req_zone $binary_remote_addr zone=feed_register:10m rate=60r/m;  # Special zone for feed registration
        limit_req_zone $binary_remote_addr zone=proxy_requests:10m rate=30r/m; # Forward proxy rate limiting
        limit_conn_zone $binary_remote_addr zone=addr:10m;

        # Gzipåœ§ç¸®: å¸¯åŸŸå¹…åŠ¹ç‡åŒ–
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types
            text/plain
            text/css
            text/xml
            text/javascript
            application/json
            application/javascript
            application/xml+rss
            application/atom+xml
            image/svg+xml;

        # ğŸš€ æœ€é©åŒ–ã•ã‚ŒãŸç›´æ¥æ¥ç¶šã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ  (2024å¹´ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹)
        upstream alt_frontend {
            # 2024å¹´æ¨å¥¨ï¼šleast_connã§æ¥ç¶šæ•°ãƒ™ãƒ¼ã‚¹è² è·åˆ†æ•£
            least_conn;

            # alt-frontend 3 Pods ã¸ã®ç›´æ¥æ¥ç¶š
            server alt-frontend.alt-apps.svc.cluster.local:3000 weight=1 max_fails=2 fail_timeout=10s;

            # 2024å¹´æ¨å¥¨ï¼škeepalive = ã‚µãƒ¼ãƒãƒ¼æ•° x 2
            keepalive 32;           # æ¥ç¶šãƒ—ãƒ¼ãƒ«æœ€é©åŒ–
            keepalive_requests 200; # ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°å¢—åŠ 
            keepalive_timeout 90s;  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå»¶é•·
        }

        upstream alt_backend {
            # 2024å¹´æ¨å¥¨ï¼šleast_connã§æ¥ç¶šæ•°ãƒ™ãƒ¼ã‚¹è² è·åˆ†æ•£
            least_conn;

            # alt-backend ç›´æ¥æ¥ç¶š
            server alt-backend.alt-apps.svc.cluster.local:9000 weight=1 max_fails=2 fail_timeout=10s;

            # 2024å¹´æ¨å¥¨ï¼škeepaliveæœ€é©åŒ–
            keepalive 32;           # æ¥ç¶šãƒ—ãƒ¼ãƒ«æœ€é©åŒ–
            keepalive_requests 200; # ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°å¢—åŠ 
            keepalive_timeout 90s;  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå»¶é•·
        }

        # ãƒ¡ã‚¤ãƒ³HTTPSã‚µãƒ¼ãƒãƒ¼: å¤–éƒ¨ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯å—ä¿¡
        server {
            # HTTPSçµ‚ç«¯è¨­å®š: TLS 1.2/1.3å¯¾å¿œ
            listen 443 ssl;
            listen "{{`[::]:443`}}" ssl;
            http2 on;
            server_name "curionoah.com";

            # SSLè¨¼æ˜æ›¸è¨­å®š: cert-managerç®¡ç†è¨¼æ˜æ›¸
            ssl_certificate /etc/nginx/ssl/tls.crt;
            ssl_certificate_key /etc/nginx/ssl/tls.key;

            # ç¾ä»£çš„TLSè¨­å®š: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒãƒ©ãƒ³ã‚¹
            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
            ssl_prefer_server_ciphers off;
            ssl_session_cache shared:SSL:10m;
            ssl_session_timeout 1d;
            ssl_session_tickets off;

            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼: åŒ…æ‹¬çš„Webä¿è­·
            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

            # CSPè¨­å®š: XSSæ”»æ’ƒé˜²æ­¢ï¼ˆNext.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
            add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' blob: data: https:; font-src 'self' data:; connect-src 'self' https:; manifest-src 'self'; frame-ancestors 'self';" always;

            # ãƒªã‚¯ã‚¨ã‚¹ãƒˆID: åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°å¯¾å¿œ
            add_header X-Request-ID $request_id always;

            # Next.jsé™çš„ã‚¢ã‚»ãƒƒãƒˆå„ªå…ˆå‡¦ç†
            # æœ€é«˜å„ªå…ˆåº¦ã®prefix matchingã‚’ä½¿ç”¨
            location ^~ /_next/static/ {

                # upstreamçµŒç”±ã§MIME typeå•é¡Œã‚’å®Œå…¨è§£æ±º
                proxy_pass http://alt_frontend;

                # é™çš„ã‚¢ã‚»ãƒƒãƒˆç”¨æœ€é©åŒ–ãƒ˜ãƒƒãƒ€ãƒ¼
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Host $host;
                proxy_set_header X-Forwarded-Port $server_port;
                proxy_set_header X-Request-ID $request_id;

                # HTTPé€šä¿¡è¨­å®š: Linkerd mTLSé€æ˜æš—å·åŒ–
                proxy_http_version 1.1;
                proxy_set_header Connection "";

                # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°æœ€é©åŒ–
                proxy_buffering on;
                proxy_buffer_size 8k;
                proxy_buffers 16 8k;
                proxy_busy_buffers_size 16k;

                # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š: é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ç”¨çŸ­æ™‚é–“è¨­å®š
                proxy_connect_timeout 10s;
                proxy_send_timeout 30s;
                proxy_read_timeout 30s;
            }


            # General APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€šä¿¡å°‚ç”¨
            location /api/ {
                # upstreamçµŒç”±alt-backendæ¥ç¶š
                proxy_pass http://alt_backend;

                # APIç”¨ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Request-ID $request_id;

                # SSLé€šä¿¡è¨­å®š
                proxy_http_version 1.1;
                proxy_set_header Connection "";

                # APIç”¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™: ç·©å’Œã•ã‚ŒãŸåˆ¶å¾¡
                limit_req zone=api_limit burst=30 nodelay;  # Increased from 20
                limit_conn addr 20;  # Increased from 10

                # APIç”¨ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°è¨­å®š
                proxy_buffering on;
                proxy_buffer_size 8k;
                proxy_buffers 16 8k;
                proxy_busy_buffers_size 16k;

                # APIç”¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: RSS feed validationå¯¾å¿œ
                proxy_connect_timeout 30s;
                proxy_send_timeout 120s;
                proxy_read_timeout 120s;

                # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: é«˜å¯ç”¨æ€§ç¢ºä¿
                proxy_next_upstream error timeout http_502 http_503 http_504;
                proxy_next_upstream_tries 3;
                proxy_next_upstream_timeout 45s;
            }

            # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒˆ: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é…ä¿¡
            location / {
                # Cache-Controlé‡è¤‡ãƒ˜ãƒƒãƒ€ãƒ¼é˜²æ­¢
                proxy_hide_header Cache-Control;

                # upstreamçµŒç”±ã§Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é…ä¿¡
                proxy_pass http://alt_frontend;

                # åŸºæœ¬ãƒ—ãƒ­ã‚­ã‚·ãƒ˜ãƒƒãƒ€ãƒ¼
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Host $host;
                proxy_set_header X-Forwarded-Port $server_port;
                proxy_set_header X-Request-ID $request_id;

                # WebSocketå¯¾å¿œãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆNext.jsé–‹ç™ºãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                # SSLé€šä¿¡è¨­å®š
                proxy_http_version 1.1;
                proxy_set_header Connection "";

                # ä¸€èˆ¬ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç”¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™
                limit_req zone=general_limit burst=50 nodelay;

                # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°è¨­å®š
                proxy_buffering off; # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§é‡è¦–
                proxy_redirect off;

                # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆAPIé€šä¿¡å¯¾å¿œï¼‰
                proxy_connect_timeout 30s;
                proxy_send_timeout 120s;
                proxy_read_timeout 120s;

                # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                proxy_intercept_errors off;
                proxy_next_upstream error timeout http_502 http_503 http_504;
                proxy_next_upstream_tries 3;
                proxy_next_upstream_timeout 45s;
            }

            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
            location /external-health {
                access_log off;
                return 200 "External nginx OK - DIRECT CONNECTION MODE\nTimestamp: $time_iso8601\nUpstream: Direct to alt-frontend:3000 + alt-backend:9000\n";
                add_header Content-Type "text/plain; charset=utf-8";
                add_header X-Health-Check "external" always;
            }

            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: æ‚ªæ„ã‚ã‚‹ãƒ‘ã‚¹ã®ãƒ–ãƒ­ãƒƒã‚¯
            location ~ /\. {
                deny all;
                access_log off;
                log_not_found off;
            }

            location ~ /(wp-admin|wp-login|admin|phpmyadmin) {
                deny all;
                access_log off;
                log_not_found off;
            }
        }

        # HTTPã‹ã‚‰HTTPSã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        server {
            listen 80;
            listen "{{`[::]:80`}}";
            server_name "curionoah.com";

            # å…¨HTTPãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®HTTPSåŒ–
            return 301 https://$server_name$request_uri;
        }

        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å°‚ç”¨ã‚µãƒ¼ãƒãƒ¼ï¼ˆãƒãƒ¼ãƒˆ8080ï¼‰
        server {
            listen 8080 default_server;
            listen "{{`[::]:8080`}}" default_server;
            server_name _;

            access_log off;

            # Kubernetesãƒ—ãƒ­ãƒ¼ãƒ–ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
            location /nginx-health {
                return 200 "nginx-external DIRECT CONNECTION healthy\nTimestamp: $time_iso8601\nUpstream Status: Direct to alt-frontend:3000 + alt-backend:9000\n";
                add_header Content-Type "text/plain; charset=utf-8";
                add_header X-Health-Check "nginx-external" always;
                add_header X-Pod-Name "$hostname" always;
            }

            # Prometheus monitoring disabled for stability

            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹
            location / {
                return 404 "Not Found\nThis is nginx-external health check port (DIRECT CONNECTION MODE)\nUse HTTPS on port 443 for application access\n";
                add_header Content-Type "text/plain; charset=utf-8";
            }
        }

        # Forward Proxy Server (Internal Services Only)
        server {
            listen 8888;
            server_name proxy.nginx-external.internal;
            
            # Access control - temporarily allow all for debugging
            # allow 127.0.0.0/8;       # Localhost for testing
            # allow 10.0.0.0/8;        # Pod CIDR
            # allow 172.16.0.0/12;     # Service CIDR  
            # allow 192.168.0.0/16;    # Additional internal networks
            # deny all;

            # Rate limiting for proxy requests
            limit_req zone=proxy_requests burst=20 nodelay;
            limit_conn addr 10;

            # Health check for proxy functionality (must come before catch-all)
            location /proxy-health {
                access_log off;
                return 200 "Forward Proxy OK - Ready to proxy external requests\nTimestamp: $time_iso8601\nAllowed Networks: Internal Pod/Service Networks Only\n";
                add_header Content-Type "text/plain; charset=utf-8";
                add_header X-Health-Check "forward-proxy" always;
                add_header X-Proxy-Server "nginx-external" always;
            }

            # Forward Proxy configuration for external HTTPS access
            location / {
                # DNS resolver for external requests
                resolver 8.8.8.8 8.8.4.4 valid=300s;
                resolver_timeout 30s;

                # Critical: Set correct proxy_pass for forward proxy
                proxy_pass $scheme://$http_host$request_uri;
                
                # Essential headers for forward proxy
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Request-ID $request_id;

                # Extended timeouts for RSS feed fetching
                proxy_connect_timeout 60s;
                proxy_send_timeout 300s;
                proxy_read_timeout 300s;
                send_timeout 300s;

                # HTTP/1.1 with connection reuse
                proxy_http_version 1.1;
                proxy_set_header Connection "";

                # SSL/TLS settings for forward proxy
                proxy_ssl_verify off;
                proxy_ssl_server_name on;
                proxy_ssl_name $http_host;

                # Forward proxy specific settings
                proxy_intercept_errors off;
                proxy_pass_request_headers on;
                proxy_pass_request_body on;

                # Security: Hide server information
                proxy_hide_header X-Powered-By;
                proxy_hide_header Server;

                # Optimized buffering for forward proxy
                proxy_buffering on;
                proxy_buffer_size 16k;
                proxy_buffers 32 16k;
                proxy_busy_buffers_size 64k;
                proxy_temp_file_write_size 64k;

                # Connection handling for different protocols
                proxy_next_upstream error timeout http_502 http_503 http_504;
                proxy_next_upstream_tries 3;
                proxy_next_upstream_timeout 60s;

                # Add proxy identification header
                add_header X-Proxy-Server "nginx-external-forward-proxy" always;
                
                # Enhanced logging for monitoring
                access_log /var/log/nginx/proxy_access.log external_main;
                error_log /var/log/nginx/proxy_error.log warn;
            }

            # Block internal service access via proxy
            location ~ ^/(api|admin|internal|kubernetes)/ {
                deny all;
                return 403 "Forbidden - Internal paths not allowed via proxy";
                add_header Content-Type "text/plain; charset=utf-8";
            }

            # Error pages for proxy
            error_page 502 503 504 /proxy_error.html;
            location = /proxy_error.html {
                internal;
                return 502 "Proxy Error - Unable to reach external destination\nCheck your proxy configuration and network connectivity.\n";
                add_header Content-Type "text/plain; charset=utf-8";
            }
        }

        # ULTRATHINK ROOT FIX: Egress Gateway for RSS Feeds (Zero Trust Architecture)
        server {
            listen 8889;
            server_name egress.nginx-external.internal;
            
            # Access control: Internal services only
            allow 10.0.0.0/8;        # Pod CIDR
            allow 172.16.0.0/12;     # Service CIDR  
            allow 192.168.0.0/16;    # Additional internal networks
            deny all;

            # Rate limiting for RSS egress requests
            limit_req zone=proxy_requests burst=20 nodelay;
            limit_conn addr 10;

            # Security headers for egress gateway
            add_header X-Frame-Options "DENY" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "no-referrer" always;

            # Health check for egress gateway
            location /egress-health {
                access_log off;
                return 200 "RSS Egress Gateway OK - Ready for external RSS feeds\nTimestamp: $time_iso8601\nAllowed Domains: feeds.bbci.co.uk, zenn.dev, github.com\n";
                add_header Content-Type "text/plain; charset=utf-8";
                add_header X-Health-Check "rss-egress-gateway" always;
                add_header X-Proxy-Server "nginx-external-egress" always;
            }

            # Debug location for testing domain extraction
            location ~ ^/rss-proxy-debug/(?<target_scheme>https?)://(?<target_host>[^/]+)(?<target_path>/.*)?$ {
                return 200 "Debug Info:\nTarget Scheme: $target_scheme\nTarget Host: $target_host\nTarget Path: $target_path\nURI: $uri\nArgs: $args\n";
                add_header Content-Type "text/plain; charset=utf-8";
            }

            # RSS Feed Egress Proxy with Domain Whitelist (Zero Trust) - HTTP/HTTPS both supported  
            location ~ ^/rss-proxy/(https?)://([^/]+)(/.*)?$ {
                # Direct capture without named groups - most reliable approach
                set $target_scheme $1;
                set $target_host $2;
                set $target_path $3;
                
                # Handle empty path
                if ($target_path = "") {
                    set $target_path "/";
                }
                
                # SECURITY: Domain whitelist for RSS feeds only
                set $allowed 0;
                if ($target_host ~ "^feeds\.bbci\.co\.uk$") { set $allowed 1; }
                if ($target_host ~ "^zenn\.dev$") { set $allowed 1; }
                if ($target_host ~ "^github\.com$") { set $allowed 1; }
                if ($target_host ~ "^feeds\.feedburner\.com$") { set $allowed 1; }
                if ($target_host ~ "^rss\.cnn\.com$") { set $allowed 1; }
                
                if ($allowed = 0) {
                    return 403 "Domain not allowed in RSS whitelist: $target_host";
                }
                
                # DNS resolver for external requests
                resolver 8.8.8.8 8.8.4.4 valid=300s;
                resolver_timeout 30s;

                # External RSS feed proxy
                proxy_pass $target_scheme://$target_host$target_path;
                
                # Essential headers for RSS fetching
                proxy_set_header Host $target_host;
                proxy_set_header User-Agent "ALT-RSS-Reader/1.0 (+https://curionoah.com)";
                proxy_set_header Accept "application/rss+xml, application/xml, text/xml, */*";
                proxy_set_header Accept-Encoding "gzip, deflate";
                proxy_set_header Connection "close";

                # Extended timeouts for RSS feed fetching
                proxy_connect_timeout 60s;
                proxy_send_timeout 300s;
                proxy_read_timeout 300s;
                send_timeout 300s;

                # HTTP/1.1 settings
                proxy_http_version 1.1;

                # SSL/TLS settings for external HTTPS
                proxy_ssl_verify off;
                proxy_ssl_server_name on;
                proxy_ssl_name $target_host;

                # Response handling
                proxy_redirect off;
                proxy_intercept_errors off;

                # Optimized buffering for RSS content
                proxy_buffering on;
                proxy_buffer_size 32k;
                proxy_buffers 64 32k;
                proxy_busy_buffers_size 128k;
                proxy_temp_file_write_size 128k;

                # Connection handling
                proxy_next_upstream error timeout http_502 http_503 http_504;
                proxy_next_upstream_tries 3;
                proxy_next_upstream_timeout 90s;

                # Add egress identification header
                add_header X-Egress-Gateway "nginx-external-rss-egress" always;
                add_header X-Allowed-Domain "$target_host" always;
                
                # Enhanced logging for audit
                access_log /var/log/nginx/egress_access.log external_main;
                error_log /var/log/nginx/egress_error.log warn;
            }

            # Block non-RSS proxy attempts
            location / {
                return 403 "RSS Egress Gateway - Only /rss-proxy/ paths allowed\nUsage: /rss-proxy/https://feeds.bbci.co.uk/news/rss.xml\n";
                add_header Content-Type "text/plain; charset=utf-8";
            }
        }
    }
{{- end }}

  {{- with .Values.configMap.extraFiles }}
  {{- range $name, $content := . }}
  {{ $name }}: |
    {{- $content | nindent 4 }}
  {{- end }}
  {{- end }}
