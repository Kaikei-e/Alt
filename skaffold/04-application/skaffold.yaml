apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: alt-application
# Default profile optimized for kind local development
build:
  local:
    push: false  # Local development with kind
    useDockerCLI: true
    useBuildkit: true
    concurrency: 0
    tryImportMissing: true
  tagPolicy:
    gitCommit: {}
  artifacts:
    - image: alt-frontend
      context: ../../alt-frontend
      docker:
        dockerfile: Dockerfile.frontend
deploy:
  statusCheckDeadlineSeconds: 600
  helm:
    flags:
      install: ['--wait', '--timeout=300s']
      upgrade: ['--wait', '--timeout=300s']
    releases:
      - name: alt-frontend
        chartPath: charts/alt-frontend
        namespace: alt-apps
        createNamespace: true
        valuesFiles:
          - charts/alt-frontend/values-development.yaml
          - charts/alt-frontend/values.yaml
        setValueTemplates:
          image.repository: "{{.IMAGE_REPO_alt_frontend}}"
          image.tag: "{{.IMAGE_TAG_alt_frontend}}"
        setValues:
          image.pullPolicy: "Never"  # Kind local development
        version: 0.1.0
      - name: nginx
        chartPath: charts/nginx
        namespace: alt-ingress
        createNamespace: true
        valuesFiles:
          - charts/nginx/values.yaml
        version: 0.1.0
      - name: nginx-external
        chartPath: charts/nginx-external
        namespace: alt-ingress
        createNamespace: true
        valuesFiles:
          - charts/nginx-external/values.yaml
          - charts/nginx-external/values-ssl.yaml
        version: 0.1.0
profiles:
  - name: prod
    build:
      local:
        push: false
        useDockerCLI: false
        concurrency: 1
      tagPolicy:
        gitCommit: {}
      artifacts:
        - image: kaikei/alt-frontend
          context: ../../alt-frontend
          docker:
            dockerfile: Dockerfile.frontend
    deploy:
      statusCheckDeadlineSeconds: 600
      helm:
        flags:
          install: ['--wait', '--timeout=600s']
          upgrade: ['--wait', '--timeout=600s']
        releases:
          - name: alt-frontend
            chartPath: charts/alt-frontend
            namespace: alt-apps
            createNamespace: true
            valuesFiles:
              - charts/alt-frontend/values.yaml
              - charts/alt-frontend/values-production.yaml
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_alt_frontend}}"
              image.tag: "{{.IMAGE_TAG_kaikei_alt_frontend}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: nginx
            chartPath: charts/nginx
            namespace: alt-ingress
            createNamespace: true
            valuesFiles:
              - charts/nginx/values.yaml
              - charts/nginx/values-production.yaml
            version: 0.1.0
          - name: nginx-external
            chartPath: charts/nginx-external
            namespace: alt-ingress
            createNamespace: true
            valuesFiles:
              - charts/nginx-external/values.yaml
              - charts/nginx-external/values-production.yaml
            version: 0.1.0
