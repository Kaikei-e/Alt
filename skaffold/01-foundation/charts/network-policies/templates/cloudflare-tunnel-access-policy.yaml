# NetworkPolicy: Cloudflare Tunnel → nginx-external 専用アクセス制御
# セキュリティファースト: cloudflare-tunnelのみがnginx-externalにアクセス可能
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nginx-external-cloudflare-tunnel-only
  namespace: alt-ingress
  labels:
    app.kubernetes.io/name: cloudflare-tunnel-access-policy
    app.kubernetes.io/version: "3.0"
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: alt-foundation
    security.policy/type: defense-in-depth
spec:
  podSelector:
    matchLabels:
      app: nginx-external
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # 1. Cloudflare Tunnel専用アクセス（最高優先度）
  - from:
    - namespaceSelector:
        matchLabels:
          name: alt-operations
    - podSelector:
        matchLabels:
          app: cloudflare-tunnel
    ports:
    - protocol: TCP
      port: 80   # HTTP
    - protocol: TCP
      port: 443  # HTTPS
    - protocol: TCP
      port: 8080 # Health check

  # 2. Linkerd Service Mesh通信（mTLS）
  - from:
    - namespaceSelector:
        matchExpressions:
        - key: linkerd.io/inject
          operator: In
          values: ["enabled"]
      podSelector:
        matchLabels:
          linkerd.io/control-plane-ns: linkerd
    ports:
    - protocol: TCP
      port: 4143  # Linkerd inbound proxy port

  # 3. 運用監視アクセス（Prometheus等）
  - from:
    - namespaceSelector:
        matchLabels:
          name: alt-operations
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: prometheus
    ports:
    - protocol: TCP
      port: 8080  # Health/metrics endpoint

  egress:
  # 1. nginx-internal向け通信（HTTPS）
  - to:
    - namespaceSelector:
        matchLabels:
          name: alt-ingress
    - podSelector:
        matchLabels:
          app: nginx-internal
    ports:
    - protocol: TCP
      port: 8443  # nginx-internal HTTPS

  # 2. DNS解決
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

  # 3. Linkerd Control Plane通信
  - to:
    - namespaceSelector:
        matchLabels:
          name: linkerd
    ports:
    - protocol: TCP
      port: 8443  # linkerd-proxy-injector
    - protocol: TCP
      port: 8080  # linkerd-controller-api
    - protocol: TCP
      port: 9990  # linkerd-proxy-admin
    - protocol: TCP
      port: 4143  # linkerd-proxy outbound

  # 4. cert-manager証明書管理
  - to:
    - namespaceSelector:
        matchLabels:
          name: cert-manager
    ports:
    - protocol: TCP
      port: 9402  # cert-manager webhook

---
# NetworkPolicy: Cloudflare Tunnel Egress制御
# セキュリティファースト: 外部通信はCloudflareのみ許可
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cloudflare-tunnel-egress-control
  namespace: alt-operations
  labels:
    app.kubernetes.io/name: cloudflare-tunnel-egress-policy
    app.kubernetes.io/version: "3.0"
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: alt-foundation
    security.policy/type: defense-in-depth
spec:
  podSelector:
    matchLabels:
      app: cloudflare-tunnel
  policyTypes:
  - Egress
  egress:
  # 1. Cloudflare Edge Server通信（必須）
  - to: []
    ports:
    - protocol: TCP
      port: 443   # HTTPS to Cloudflare Edge
    - protocol: TCP
      port: 80    # HTTP to Cloudflare Edge
    - protocol: TCP
      port: 7844  # Cloudflare Tunnel protocol

  # 2. nginx-external向け内部通信
  - to:
    - namespaceSelector:
        matchLabels:
          name: alt-ingress
    - podSelector:
        matchLabels:
          app: nginx-external
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 8080

  # 3. DNS解決（必須）
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

  # 4. Linkerd Service Mesh通信
  - to:
    - namespaceSelector:
        matchLabels:
          name: linkerd
    ports:
    - protocol: TCP
      port: 8443
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 4143