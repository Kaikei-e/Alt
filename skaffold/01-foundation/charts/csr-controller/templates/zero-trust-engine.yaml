apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "csr-controller.fullname" . }}-zero-trust-engine
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "csr-controller.labels" . | nindent 4 }}
    app.kubernetes.io/component: zero-trust-engine
spec:
  replicas: {{ .Values.zeroTrustEngine.replicas | default 2 }}
  selector:
    matchLabels:
      {{- include "csr-controller.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: zero-trust-engine
  template:
    metadata:
      annotations:
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
      labels:
        {{- include "csr-controller.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: zero-trust-engine
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "csr-controller.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
      - name: zero-trust-engine
        securityContext:
          {{- toYaml .Values.securityContext | nindent 12 }}
        image: "{{ .Values.zeroTrustEngine.image.repository }}:{{ .Values.zeroTrustEngine.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.zeroTrustEngine.image.pullPolicy }}
        env:
        - name: ZERO_TRUST_MODE
          value: {{ .Values.zeroTrustEngine.mode | default "enforce" | quote }}
        - name: IDENTITY_VERIFICATION_ENABLED
          value: {{ .Values.zeroTrustEngine.identityVerification.enabled | default true | quote }}
        - name: WORKLOAD_IDENTITY_REQUIRED
          value: {{ .Values.zeroTrustEngine.workloadIdentity.required | default true | quote }}
        - name: CONTINUOUS_VERIFICATION_ENABLED
          value: {{ .Values.zeroTrustEngine.continuousVerification.enabled | default true | quote }}
        - name: TRUST_SCORE_THRESHOLD
          value: {{ .Values.zeroTrustEngine.trustScore.threshold | default 0.7 | quote }}
        - name: MFA_ENABLED
          value: {{ .Values.zeroTrustEngine.mfa.enabled | default true | quote }}
        - name: BEHAVIORAL_ANALYSIS_ENABLED
          value: {{ .Values.zeroTrustEngine.behavioralAnalysis.enabled | default true | quote }}
        - name: CONTEXT_AWARE_ACCESS_ENABLED
          value: {{ .Values.zeroTrustEngine.contextAwareAccess.enabled | default true | quote }}
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        - name: grpc
          containerPort: 9090
          protocol: TCP
        - name: mfa
          containerPort: 8443
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /healthz
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: http
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
          {{- toYaml .Values.zeroTrustEngine.resources | nindent 12 }}
        volumeMounts:
        - name: zero-trust-config
          mountPath: /etc/zero-trust
          readOnly: true
        - name: identity-policies
          mountPath: /etc/identity-policies
          readOnly: true
        - name: trust-database
          mountPath: /var/lib/trust
        - name: behavioral-models
          mountPath: /var/lib/models
        - name: mfa-config
          mountPath: /etc/mfa
          readOnly: true
        - name: audit-logs
          mountPath: /var/log/zero-trust
      volumes:
      - name: zero-trust-config
        configMap:
          name: {{ include "csr-controller.fullname" . }}-zero-trust-config
      - name: identity-policies
        configMap:
          name: {{ include "csr-controller.fullname" . }}-identity-policies
      - name: trust-database
        persistentVolumeClaim:
          claimName: {{ include "csr-controller.fullname" . }}-trust-database
      - name: behavioral-models
        persistentVolumeClaim:
          claimName: {{ include "csr-controller.fullname" . }}-behavioral-models
      - name: mfa-config
        secret:
          secretName: {{ .Values.zeroTrustEngine.mfa.secretName | default (printf "%s-mfa-config" (include "csr-controller.fullname" .)) }}
      - name: audit-logs
        persistentVolumeClaim:
          claimName: {{ include "csr-controller.fullname" . }}-zero-trust-audit-logs
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "csr-controller.fullname" . }}-zero-trust-engine
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "csr-controller.labels" . | nindent 4 }}
    app.kubernetes.io/component: zero-trust-engine
spec:
  type: {{ .Values.zeroTrustEngine.service.type }}
  ports:
  - port: {{ .Values.zeroTrustEngine.service.port | default 8080 }}
    targetPort: http
    protocol: TCP
    name: http
  - port: {{ .Values.zeroTrustEngine.service.grpcPort | default 9090 }}
    targetPort: grpc
    protocol: TCP
    name: grpc
  - port: {{ .Values.zeroTrustEngine.service.mfaPort | default 8443 }}
    targetPort: mfa
    protocol: TCP
    name: mfa
  selector:
    {{- include "csr-controller.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: zero-trust-engine