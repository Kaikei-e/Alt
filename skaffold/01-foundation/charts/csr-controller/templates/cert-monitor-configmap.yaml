{{- if .Values.csrController.certMonitoring.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "csr-controller.fullname" . }}-cert-monitor-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "csr-controller.labels" . | nindent 4 }}
    app.kubernetes.io/component: cert-monitor
data:
  monitoring.yaml: |
    certificates:
    {{- range .Values.csrController.certMonitoring.certificates }}
      - name: {{ .name }}
        namespace: {{ .namespace }}
        threshold: {{ .threshold | default "720h" }}
        alertChannel: {{ .alertChannel | default "#ops-alerts" }}
        priority: {{ .priority | default "medium" }}
        {{- if .dnsNames }}
        dnsNames:
        {{- range .dnsNames }}
          - {{ . }}
        {{- end }}
        {{- end }}
        {{- if .ipAddresses }}
        ipAddresses:
        {{- range .ipAddresses }}
          - {{ . }}
        {{- end }}
        {{- end }}
    {{- end }}
    
    alerting:
      webhook:
        {{- if .Values.csrController.certMonitoring.alerting.slack.enabled }}
        enabled: true
        url: "${SLACK_WEBHOOK_URL}"
        channel: {{ .Values.csrController.certMonitoring.alerting.slack.channel | default "#ops-alerts" }}
        username: {{ .Values.csrController.certMonitoring.alerting.slack.username | default "cert-monitor" }}
        icon: {{ .Values.csrController.certMonitoring.alerting.slack.icon | default ":lock:" }}
        {{- else }}
        enabled: false
        {{- end }}
      
      email:
        {{- if .Values.csrController.certMonitoring.alerting.email.enabled }}
        enabled: true
        smtp:
          host: "${EMAIL_SMTP_HOST}"
          port: "${EMAIL_SMTP_PORT}"
          username: "${EMAIL_USERNAME}"
          password: "${EMAIL_PASSWORD}"
          tls: {{ .Values.csrController.certMonitoring.alerting.email.tls | default true }}
        from: "${EMAIL_FROM}"
        to:
        {{- range .Values.csrController.certMonitoring.alerting.email.recipients }}
          - {{ . }}
        {{- end }}
        template: |
          Subject: Certificate Expiry Alert - {{ "{{" }}.CertificateName{{ "}}" }}
          
          Certificate Alert Details:
          - Certificate: {{ "{{" }}.CertificateName{{ "}}" }}
          - Namespace: {{ "{{" }}.Namespace{{ "}}" }}
          - Days Until Expiry: {{ "{{" }}.DaysUntilExpiry{{ "}}" }}
          - Expiry Date: {{ "{{" }}.ExpiryDate{{ "}}" }}
          
          Please renew this certificate before it expires.
          
          Generated by Alt RSS Reader Certificate Monitor
        {{- else }}
        enabled: false
        {{- end }}
    
    monitoring:
      interval: {{ .Values.csrController.certMonitoring.interval | default "300" }}
      alertThreshold: {{ .Values.csrController.certMonitoring.alertThreshold | default "720h" }}
      namespaces:
      {{- range .Values.csrController.certMonitoring.namespaces }}
        - {{ . }}
      {{- end }}
      
      metrics:
        enabled: true
        port: {{ .Values.csrController.certMonitoring.metricsPort | default 8080 }}
        path: "/"
        
      health:
        enabled: true
        port: {{ .Values.csrController.certMonitoring.healthPort | default 8081 }}
        path: "/"
    
    logging:
      level: {{ .Values.csrController.certMonitoring.logLevel | default "info" }}
      format: {{ .Values.csrController.certMonitoring.logFormat | default "json" }}
      
  alert-templates: |
    # Slack Alert Template
    slack_template: |
      {
        "text": "üîí Certificate Alert",
        "attachments": [
          {
            "color": "{{ "{{" }} if lt .DaysUntilExpiry 7 {{ "}}" }}danger{{ "{{" }} else if lt .DaysUntilExpiry 30 {{ "}}" }}warning{{ "{{" }} else {{ "}}" }}good{{ "{{" }} end {{ "}}" }}",
            "fields": [
              {
                "title": "Certificate",
                "value": "{{ "{{" }}.CertificateName{{ "}}" }}",
                "short": true
              },
              {
                "title": "Namespace",
                "value": "{{ "{{" }}.Namespace{{ "}}" }}",
                "short": true
              },
              {
                "title": "Days Until Expiry",
                "value": "{{ "{{" }}.DaysUntilExpiry{{ "}}" }}",
                "short": true
              },
              {
                "title": "Expiry Date",
                "value": "{{ "{{" }}.ExpiryDate{{ "}}" }}",
                "short": true
              }
            ],
            "footer": "Alt RSS Reader Certificate Monitor",
            "ts": {{ "{{" }}.Timestamp{{ "}}" }}
          }
        ]
      }
    
    # Email Alert Template
    email_template: |
      Subject: üîí Certificate Expiry Alert - {{ "{{" }}.CertificateName{{ "}}" }}
      
      Dear Operations Team,
      
      This is an automated alert regarding an SSL certificate that is approaching expiry.
      
      Certificate Details:
      ==================
      Certificate Name: {{ "{{" }}.CertificateName{{ "}}" }}
      Namespace: {{ "{{" }}.Namespace{{ "}}" }}
      Days Until Expiry: {{ "{{" }}.DaysUntilExpiry{{ "}}" }}
      Expiry Date: {{ "{{" }}.ExpiryDate{{ "}}" }}
      
      {{ "{{" }} if lt .DaysUntilExpiry 7 {{ "}}" }}
      ‚ö†Ô∏è  URGENT: This certificate expires in less than 7 days!
      {{ "{{" }} else if lt .DaysUntilExpiry 30 {{ "}}" }}
      ‚ö†Ô∏è  WARNING: This certificate expires in less than 30 days.
      {{ "{{" }} else {{ "}}" }}
      ‚ÑπÔ∏è  INFO: This certificate is scheduled for renewal.
      {{ "{{" }} end {{ "}}" }}
      
      Action Required:
      ================
      Please ensure that the certificate is renewed before the expiry date.
      
      The certificate rotation system will automatically attempt to renew this certificate,
      but manual intervention may be required if the automatic process fails.
      
      For assistance, please contact the platform engineering team.
      
      --
      Alt RSS Reader Certificate Monitor
      Generated at: {{ "{{" }}.GeneratedAt{{ "}}" }}
      
  prometheus-rules: |
    # Prometheus alerting rules for certificate monitoring
    groups:
    - name: certificate-alerts
      rules:
      - alert: CertificateExpiring
        expr: cert_days_until_expiry < 30
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Certificate {{ "{{" }} $labels.secret {{ "}}" }} is expiring soon"
          description: "Certificate {{ "{{" }} $labels.secret {{ "}}" }} in namespace {{ "{{" }} $labels.namespace {{ "}}" }} expires in {{ "{{" }} $value {{ "}}" }} days"
      
      - alert: CertificateExpiringSoon
        expr: cert_days_until_expiry < 7
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "Certificate {{ "{{" }} $labels.secret {{ "}}" }} is expiring very soon"
          description: "Certificate {{ "{{" }} $labels.secret {{ "}}" }} in namespace {{ "{{" }} $labels.namespace {{ "}}" }} expires in {{ "{{" }} $value {{ "}}" }} days"
      
      - alert: CertificateExpired
        expr: cert_days_until_expiry < 0
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "Certificate {{ "{{" }} $labels.secret {{ "}}" }} has expired"
          description: "Certificate {{ "{{" }} $labels.secret {{ "}}" }} in namespace {{ "{{" }} $labels.namespace {{ "}}" }} has expired"
      
      - alert: CertificateMonitorDown
        expr: up{job="cert-monitor"} == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Certificate monitor is down"
          description: "The certificate monitoring service is not responding"
{{- end }}