apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: alt-processing
profiles:
  - name: dev
    build:
      local:
        push: false  # INCIDENT 82 FIX: Local cluster対応
        useDockerCLI: true  # INCIDENT 82 FIX: Local build強制
        useBuildkit: true  # INCIDENT 89 FIX: 一貫したimage ID生成でSHA256問題解決
      tagPolicy:
        gitCommit: {}  # INCIDENT 89 FIX: SHA256無効化、03-core-servicesパターン統一
      artifacts:
        - image: kaikei/pre-processor  # INCIDENT 82 FIX: Repository統一
          context: ../../pre-processor
          docker:
            dockerfile: Dockerfile.preprocess
        - image: kaikei/search-indexer  # INCIDENT 82 FIX: Repository統一
          context: ../../search-indexer
          docker:
            dockerfile: Dockerfile.search-indexer
        - image: kaikei/tag-generator  # INCIDENT 82 FIX: Repository統一
          context: ../../tag-generator
          docker:
            dockerfile: Dockerfile.tag-generator
        - image: kaikei/news-creator  # INCIDENT 82 FIX: Repository統一
          context: ../../news-creator
          docker:
            dockerfile: Dockerfile.creator
        - image: kaikei/rask-log-aggregator  # INCIDENT 82 FIX: Repository統一
          context: ../../rask-log-aggregator
          docker:
            dockerfile: Dockerfile.rask-log-aggregator
    deploy:
      helm:
        releases:
          - name: pre-processor
            chartPath: charts/pre-processor
            valuesFiles:
              - charts/pre-processor/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_pre_processor}}"
              image.tag: "{{.IMAGE_TAG_kaikei_pre_processor}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: search-indexer
            chartPath: charts/search-indexer
            valuesFiles:
              - charts/search-indexer/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_search_indexer}}"
              image.tag: "{{.IMAGE_TAG_kaikei_search_indexer}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: tag-generator
            chartPath: charts/tag-generator
            valuesFiles:
              - charts/tag-generator/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_tag_generator}}"
              image.tag: "{{.IMAGE_TAG_kaikei_tag_generator}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: news-creator
            chartPath: charts/news-creator
            valuesFiles:
              - charts/news-creator/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_news_creator}}"
              image.tag: "{{.IMAGE_TAG_kaikei_news_creator}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: rask-log-aggregator
            chartPath: charts/rask-log-aggregator
            valuesFiles:
              - charts/rask-log-aggregator/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_rask_log_aggregator}}"
              image.tag: "{{.IMAGE_TAG_kaikei_rask_log_aggregator}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
  - name: staging
    build:
      tagPolicy:
        gitCommit: {}  # INCIDENT 89 FIX: SHA256無効化、03-core-servicesパターン統一
      artifacts:
        - image: kaikei/pre-processor  # INCIDENT 82 FIX: Repository統一
          context: ../../pre-processor
          docker:
            dockerfile: Dockerfile.preprocess
        - image: kaikei/search-indexer  # INCIDENT 82 FIX: Repository統一
          context: ../../search-indexer
          docker:
            dockerfile: Dockerfile.search-indexer
        - image: kaikei/tag-generator  # INCIDENT 82 FIX: Repository統一
          context: ../../tag-generator
          docker:
            dockerfile: Dockerfile.tag-generator
        - image: kaikei/news-creator  # INCIDENT 82 FIX: Repository統一
          context: ../../news-creator
          docker:
            dockerfile: Dockerfile.creator
        - image: kaikei/rask-log-aggregator  # INCIDENT 82 FIX: Repository統一
          context: ../../rask-log-aggregator
          docker:
            dockerfile: Dockerfile.rask-log-aggregator
    deploy:
      helm:
        releases:
          - name: pre-processor
            chartPath: charts/pre-processor
            valuesFiles:
              - charts/pre-processor/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_pre_processor}}"
              image.tag: "{{.IMAGE_TAG_kaikei_pre_processor}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: search-indexer
            chartPath: charts/search-indexer
            valuesFiles:
              - charts/search-indexer/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_search_indexer}}"
              image.tag: "{{.IMAGE_TAG_kaikei_search_indexer}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: tag-generator
            chartPath: charts/tag-generator
            valuesFiles:
              - charts/tag-generator/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_tag_generator}}"
              image.tag: "{{.IMAGE_TAG_kaikei_tag_generator}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: news-creator
            chartPath: charts/news-creator
            valuesFiles:
              - charts/news-creator/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_news_creator}}"
              image.tag: "{{.IMAGE_TAG_kaikei_news_creator}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: rask-log-aggregator
            chartPath: charts/rask-log-aggregator
            valuesFiles:
              - charts/rask-log-aggregator/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_rask_log_aggregator}}"
              image.tag: "{{.IMAGE_TAG_kaikei_rask_log_aggregator}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
  - name: prod
    build:
      local:
        push: false  # INCIDENT 82 FIX: Local cluster対応
        useDockerCLI: true  # INCIDENT 82 FIX: Local build強制
        useBuildkit: true  # INCIDENT 89 FIX: 一貫したimage ID生成でSHA256問題解決
      tagPolicy:
        gitCommit: {}  # INCIDENT 89 FIX: SHA256無効化、03-core-servicesパターン統一
      artifacts:
        - image: kaikei/pre-processor  # INCIDENT 82 FIX: Repository統一
          context: ../../pre-processor
          docker:
            dockerfile: Dockerfile.preprocess
        - image: kaikei/search-indexer  # INCIDENT 82 FIX: Repository統一
          context: ../../search-indexer
          docker:
            dockerfile: Dockerfile.search-indexer
        - image: kaikei/tag-generator  # INCIDENT 82 FIX: Repository統一
          context: ../../tag-generator
          docker:
            dockerfile: Dockerfile.tag-generator
        - image: kaikei/news-creator  # INCIDENT 82 FIX: Repository統一
          context: ../../news-creator
          docker:
            dockerfile: Dockerfile.creator
        - image: kaikei/rask-log-aggregator  # INCIDENT 82 FIX: Repository統一
          context: ../../rask-log-aggregator
          docker:
            dockerfile: Dockerfile.rask-log-aggregator
    deploy:
      helm:
        releases:
          - name: pre-processor
            chartPath: charts/pre-processor
            valuesFiles:
              - charts/pre-processor/values-production.yaml
              - charts/pre-processor/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_pre_processor}}"
              image.tag: "{{.IMAGE_TAG_kaikei_pre_processor}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: search-indexer
            chartPath: charts/search-indexer
            valuesFiles:
              - charts/search-indexer/values-production.yaml
              - charts/search-indexer/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_search_indexer}}"
              image.tag: "{{.IMAGE_TAG_kaikei_search_indexer}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: tag-generator
            chartPath: charts/tag-generator
            valuesFiles:
              - charts/tag-generator/values-production.yaml
              - charts/tag-generator/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_tag_generator}}"
              image.tag: "{{.IMAGE_TAG_kaikei_tag_generator}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: news-creator
            chartPath: charts/news-creator
            valuesFiles:
              - charts/news-creator/values-production.yaml
              - charts/news-creator/values.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_news_creator}}"
              image.tag: "{{.IMAGE_TAG_kaikei_news_creator}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: rask-log-aggregator
            chartPath: charts/rask-log-aggregator
            valuesFiles:
              - charts/rask-log-aggregator/values-production.yaml
            namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_rask_log_aggregator}}"
              image.tag: "{{.IMAGE_TAG_kaikei_rask_log_aggregator}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
build:
  local:
    push: false  # INCIDENT 82 FIX: Local cluster対応
    useDockerCLI: true  # INCIDENT 82 FIX: Local build強制
    useBuildkit: true  # INCIDENT 89 FIX: 一貫したimage ID生成でSHA256問題解決
    concurrency: 0  # INCIDENT 82 FIX: Build並列性最大化
  tagPolicy:
    gitCommit: {}  # INCIDENT 89 FIX: SHA256無効化、03-core-servicesパターン統一
  artifacts:
    - image: kaikei/pre-processor  # INCIDENT 82 FIX: Repository統一
      context: ../../pre-processor
      docker:
        dockerfile: Dockerfile.preprocess
    - image: kaikei/search-indexer  # INCIDENT 82 FIX: Repository統一
      context: ../../search-indexer
      docker:
        dockerfile: Dockerfile.search-indexer
    - image: kaikei/tag-generator  # INCIDENT 82 FIX: Repository統一
      context: ../../tag-generator
      docker:
        dockerfile: Dockerfile.tag-generator
    - image: kaikei/news-creator  # INCIDENT 82 FIX: Repository統一
      context: ../../news-creator
      docker:
        dockerfile: Dockerfile.creator
    - image: kaikei/rask-log-aggregator  # INCIDENT 82 FIX: Repository統一
      context: ../../rask-log-aggregator
      docker:
        dockerfile: Dockerfile.rask-log-aggregator
deploy:
  statusCheckDeadlineSeconds: 600  # INCIDENT 89 FIX: Deploy timeout延長
  helm:
    flags:
      install: ['--wait', '--timeout=300s']
      upgrade: ['--wait', '--timeout=300s']
    releases:
      - name: pre-processor
        chartPath: charts/pre-processor
        valuesFiles:
          - charts/pre-processor/values-production.yaml
          - charts/pre-processor/values.yaml
        namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
        setValueTemplates:
          image.repository: "{{.IMAGE_REPO_kaikei_pre_processor}}"
          image.tag: "{{.IMAGE_TAG_kaikei_pre_processor}}"
        setValues:
          image.pullPolicy: "IfNotPresent"
        version: 0.1.0
      - name: search-indexer
        chartPath: charts/search-indexer
        valuesFiles:
          - charts/search-indexer/values-production.yaml
          - charts/search-indexer/values.yaml
        namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
        setValueTemplates:
          image.repository: "{{.IMAGE_REPO_kaikei_search_indexer}}"
          image.tag: "{{.IMAGE_TAG_kaikei_search_indexer}}"
        setValues:
          image.pullPolicy: "IfNotPresent"
        version: 0.1.0
      - name: tag-generator
        chartPath: charts/tag-generator
        valuesFiles:
          - charts/tag-generator/values-production.yaml
          - charts/tag-generator/values.yaml
        namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
        setValueTemplates:
          image.repository: "{{.IMAGE_REPO_kaikei_tag_generator}}"
          image.tag: "{{.IMAGE_TAG_kaikei_tag_generator}}"
        setValues:
          image.pullPolicy: "IfNotPresent"
        version: 0.1.0
      - name: news-creator
        chartPath: charts/news-creator
        valuesFiles:
          - charts/news-creator/values-production.yaml
          - charts/news-creator/values.yaml
        namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
        setValueTemplates:
          image.repository: "{{.IMAGE_REPO_kaikei_news_creator}}"
          image.tag: "{{.IMAGE_TAG_kaikei_news_creator}}"
        setValues:
          image.pullPolicy: "IfNotPresent"
        version: 0.1.0
      - name: rask-log-aggregator
        chartPath: charts/rask-log-aggregator
        valuesFiles:
          - charts/rask-log-aggregator/values-production.yaml
        namespace: alt-processing  # INCIDENT 82 FIX: Namespace統一
        setValueTemplates:
          image.repository: "{{.IMAGE_REPO_kaikei_rask_log_aggregator}}"
          image.tag: "{{.IMAGE_TAG_kaikei_rask_log_aggregator}}"
        setValues:
          image.pullPolicy: "IfNotPresent"
        version: 0.1.0