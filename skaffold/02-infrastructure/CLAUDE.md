# レイヤー02: Infrastructure 概要

## 1. 責務

この`02-infrastructure`レイヤーは、Altプロジェクトのステートフルなバックボーンを形成する、永続化層のコンポーネントを管理・デプロイする責務を負います。アプリケーションのコアデータ、ユーザー情報、ログ、検索インデックスなどを格納・管理するデータベースや検索エンジンが対象です。

## 2. 管理コンポーネント

`skaffold.yaml`で定義されている主要なHelmリリースは以下の通りです。これらはすべてステートフルなサービスであり、データの永続性が重要となります。

| Helmリリース名 | Chartパス | Namespace | 説明 |
| :--- | :--- | :--- | :--- |
| `postgres` | `charts/postgres` | `alt-database` | アプリケーションの主要なデータを格納するPostgreSQLデータベース。Atlasによるマイグレーションジョブも含まれます。 |
| `kratos-postgres` | `charts/kratos-postgres` | `alt-auth` | Ory Kratosが使用するID、セッション情報などを格納する専用のPostgreSQLデータベース。 |
| `auth-postgres` | `charts/auth-postgres` | `alt-auth` | カスタム認証サービスが利用するデータを格納するためのPostgreSQLデータベース。 |
| `clickhouse` | `charts/clickhouse` | `alt-analytics` | ログや分析データなど、大量の時系列データを扱うためのカラムナ指向データベース。 |
| `meilisearch` | `charts/meilisearch` | `alt-search` | 高速かつ高度な全文検索機能を提供するための検索エンジン。 |

## 3. プロファイル

- **`dev`**: ローカル開発環境向け。
- **`staging`**: ステージング環境向け。
- **`prod`**: 本番環境向け。

各プロファイルは、主に適用する`values.yaml`を切り替えることで、リソース割り当てやレプリカ数、セキュリティ設定などを各環境に最適化しています。

## 4. ビルドアーティファクト

- **`alt-atlas-migrations`イメージ**: Atlasを利用してデータベーススキーマのマイグレーションを行うためのコンテナイメージをビルドします。このイメージは`postgres`のHelmリリースからJobとして実行されます。

## 5. デプロイ戦略

- **長時間タイムアウト**: ステートフルなサービスの起動やデータ移行には時間がかかる可能性があるため、デプロイのタイムアウトは`9600`秒（160分）と非常に長く設定されています。
- **安全なデプロイフラグ**: `--atomic`, `--wait`, `--wait-for-jobs`, `--cleanup-on-fail`といったHelmのフラグを駆使し、デプロイが失敗した際に中途半端な状態になることを防ぎ、安全で信頼性の高いデプロイを実現します。
- **デプロイフック**: デプロイの前後で`kubectl`コマンドによる診断・検証フックを実行し、StatefulSetやPodの状態を自動的に確認することで、デプロイプロセスの信頼性を高めています。
