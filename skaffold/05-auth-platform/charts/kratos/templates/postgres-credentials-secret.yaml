{{- if and .Values.postgresql.enabled .Values.postgresql.auth.username .Values.postgresql.auth.password }}
{{- $secretName := .Values.postgresql.credentialsSecretName | default (printf "%s-postgres-credentials" (include "kratos.fullname" .)) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "kratos.labels" . | nindent 4 }}
  annotations:
    # 恒久対応: DSN自動生成による一貫性確保
    kratos.alt/dsn-auto-generated: "true"
    kratos.alt/database-host: {{ .Values.postgresql.service.name | quote }}
    kratos.alt/ssl-mode: {{ .Values.postgresql.sslmode | quote }}
type: Opaque
data:
  # PostgreSQL DSN for Kratos database connection - 恒久対応: 設定値から動的生成
  dsn: {{ printf "postgres://%s:%s@%s:%s/%s?sslmode=%s&max_conns=%d&max_idle_conns=%d" 
    .Values.postgresql.auth.username 
    .Values.postgresql.auth.password 
    .Values.postgresql.service.name 
    (.Values.postgresql.service.port | toString)
    .Values.postgresql.auth.database 
    .Values.postgresql.sslmode
    (.Values.database.max_conns | default 20)
    (.Values.database.max_idle_conns | default 4) | b64enc }}
  # 基本認証情報も含める（互換性のため）
  username: {{ .Values.postgresql.auth.username | b64enc }}
  password: {{ .Values.postgresql.auth.password | b64enc }}
  database: {{ .Values.postgresql.auth.database | b64enc }}
{{- end }}