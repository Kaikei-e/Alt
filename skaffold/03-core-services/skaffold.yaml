apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: alt-core-services
profiles:
  - name: dev
    build:
      artifacts:
        - image: kaikei/alt-backend  # INCIDENT 65 FIX: ã‚µãƒ¼ãƒ“ã‚¹å°‚ç”¨repository
          context: ../../alt-backend
          docker:
            dockerfile: Dockerfile.backend
        - image: kaikei/migrate
          context: ../../migrate
          docker:
            dockerfile: Dockerfile.migrate
    deploy:
      helm:
        releases:
          - name: migrate
            chartPath: charts/migrate
            valuesFiles:
              - charts/migrate/values.yaml
            version: 0.1.0
          - name: kratos
            chartPath: charts/kratos
            valuesFiles:
              - charts/kratos/values-ssl.yaml
              - charts/kratos/values.yaml
            version: 0.1.0
          - name: auth-service
            chartPath: charts/auth-service
            valuesFiles:
              - charts/auth-service/values-development.yaml
              - charts/auth-service/values-ssl.yaml
              - charts/auth-service/values.yaml
            setValueTemplates:
              # INCIDENT 82 FIX: REPORT.mdæº–æ‹  - kaikei/alt-authservice â†’ kaikei_alt_authserviceå¤‰æ›
              image.repository: "{{.IMAGE_REPO_kaikei_alt_authservice}}"
              image.tag: "{{.IMAGE_TAG_kaikei_alt_authservice}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: alt-backend
            chartPath: charts/alt-backend
            valuesFiles:
              - charts/alt-backend/values-development.yaml
              - charts/alt-backend/values-ssl.yaml
              - charts/alt-backend/values.yaml
            setValueTemplates:
              # INCIDENT 82 FIX: REPORT.mdæº–æ‹  - kaikei/alt-backend â†’ kaikei_alt_backendå¤‰æ›
              image.repository: "{{.IMAGE_REPO_kaikei_alt_backend}}"
              image.tag: "{{.IMAGE_TAG_kaikei_alt_backend}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: envoy-proxy
            chartPath: charts/envoy-proxy
            namespace: alt-apps
            createNamespace: true
            valuesFiles:
              - charts/envoy-proxy/values.yaml
            version: 0.1.0
  - name: staging
    build:
      artifacts:
        - image: kaikei/alt-backend  # INCIDENT 65 FIX: ã‚µãƒ¼ãƒ“ã‚¹å°‚ç”¨repository
          context: ../../alt-backend
          docker:
            dockerfile: Dockerfile.backend
        - image: kaikei/migrate
          context: ../../migrate
          docker:
            dockerfile: Dockerfile.migrate
    deploy:
      helm:
        releases:
          - name: migrate
            chartPath: charts/migrate
            valuesFiles:
              - charts/migrate/values.yaml
            version: 0.1.0
          - name: kratos
            chartPath: charts/kratos
            valuesFiles:
              - charts/kratos/values-ssl.yaml
              - charts/kratos/values.yaml
            version: 0.1.0
          - name: auth-service
            chartPath: charts/auth-service
            valuesFiles:
              - charts/auth-service/values-staging.yaml
              - charts/auth-service/values-ssl.yaml
              - charts/auth-service/values.yaml
            setValueTemplates:
              # INCIDENT 82 FIX: REPORT.mdæº–æ‹  - kaikei/alt-authservice â†’ kaikei_alt_authserviceå¤‰æ›
              image.repository: "{{.IMAGE_REPO_kaikei_alt_authservice}}"
              image.tag: "{{.IMAGE_TAG_kaikei_alt_authservice}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: alt-backend
            chartPath: charts/alt-backend
            valuesFiles:
              - charts/alt-backend/values-staging.yaml
              - charts/alt-backend/values-ssl.yaml
              - charts/alt-backend/values.yaml
            setValueTemplates:
              # INCIDENT 82 FIX: REPORT.mdæº–æ‹  - kaikei/alt-backend â†’ kaikei_alt_backendå¤‰æ›
              image.repository: "{{.IMAGE_REPO_kaikei_alt_backend}}"
              image.tag: "{{.IMAGE_TAG_kaikei_alt_backend}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: envoy-proxy
            chartPath: charts/envoy-proxy
            namespace: alt-apps
            createNamespace: true
            valuesFiles:
              - charts/envoy-proxy/values.yaml
            version: 0.1.0
  - name: prod
    build:
      local:
        push: false
        useDockerCLI: false
        concurrency: 1
      tagPolicy:
        gitCommit: {}
      artifacts:
        - image: kaikei/alt-backend
          context: ../../alt-backend
          docker:
            dockerfile: Dockerfile.backend
        - image: kaikei/migrate
          context: ../../migrate
          docker:
            dockerfile: Dockerfile.migrate
        - image: kaikei/alt-authservice
          context: ../../auth-service
          docker:
            dockerfile: Dockerfile
    deploy:
      statusCheckDeadlineSeconds: 600
      statusCheck: true
      helm:
        releases:
          - name: migrate
            chartPath: charts/migrate
            namespace: alt-database
            createNamespace: true
            setValues:
              namespaceLabels.name: "alt-database"
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_migrate}}"
              image.tag: "{{.IMAGE_TAG_kaikei_migrate}}"
            valuesFiles:
              - charts/migrate/values-production.yaml
            version: 0.1.0
          - name: kratos
            chartPath: charts/kratos
            namespace: alt-auth
            createNamespace: true
            valuesFiles:
              - charts/kratos/values.yaml
              - charts/kratos/values-production.yaml
            version: 0.1.0
          - name: auth-service
            chartPath: charts/auth-service
            namespace: alt-auth
            createNamespace: true
            valuesFiles:
              - charts/auth-service/values.yaml
              - charts/auth-service/values-ssl.yaml
              - charts/auth-service/values-production.yaml
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_alt_authservice}}"
              image.tag: "{{.IMAGE_TAG_kaikei_alt_authservice}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          - name: alt-backend
            chartPath: charts/alt-backend
            namespace: alt-apps
            createNamespace: true
            valuesFiles:
              - charts/alt-backend/values.yaml
              - charts/alt-backend/values-production.yaml
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_alt_backend}}"
              image.tag: "{{.IMAGE_TAG_kaikei_alt_backend}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
              # Phase 7aæ ¹æœ¬è§£æ±º: Proxy routingçµ±åˆåˆ¶å¾¡
              env.ENVOY_PROXY_ENABLED: "true"
              env.SIDECAR_PROXY_ENABLED: "false"
              env.ENVOY_PROXY_URL: "http://envoy-proxy.alt-apps.svc.cluster.local:8080"
              env.NGINX_PROXY_ENABLED: "false"
            version: 0.1.0
          - name: envoy-proxy
            chartPath: charts/envoy-proxy
            namespace: alt-apps
            createNamespace: true
            valuesFiles:
              - charts/envoy-proxy/values.yaml
            setValues:
              envoy.filterState.enabled: true
              envoy.filterState.httpsOnly: true
              security.httpsOnly: true
            version: 0.1.0
        flags:
          install: ['--atomic', '--wait', '--timeout=600s', '--wait-for-jobs', '--create-namespace']
          upgrade: ['--atomic', '--wait', '--timeout=600s', '--cleanup-on-fail', '--wait-for-jobs', '--force', '--reset-values']
        hooks:
          before:
            - host:
                command: ["echo", "ğŸš€ çµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé–‹å§‹: Phase 7a Filter State optimization"]
            - host:
                command: ["helm", "list", "-A"]
            - host:
                command: ["helm", "lint", "charts/envoy-proxy"]
          after:
            - host:
                command: ["echo", "âœ… çµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†"]
            - host:
                command: ["kubectl", "get", "pods", "-n", "alt-apps", "-l", "app.kubernetes.io/name=envoy-proxy"]
build:
  artifacts:
    - image: kaikei/alt-backend  # INCIDENT 65 FIX: ã‚µãƒ¼ãƒ“ã‚¹å°‚ç”¨repository
      context: ../../alt-backend
      docker:
        dockerfile: Dockerfile.backend
    - image: kaikei/migrate
      context: ../../migrate
      docker:
        dockerfile: Dockerfile.migrate
# WEB SEARCH FIX: kustomize + Helmæ··åœ¨è¨­å®šå‰Šé™¤ (Skaffold Issue #8884å¯¾å¿œ)
# manifests.kustomizeè¨­å®šã‚’å‰Šé™¤ã—ã¦Helmå°‚ç”¨çµ±ä¸€
# Default deploy sectionå‰Šé™¤ - ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥è¨­å®šã®ã¿ä½¿ç”¨