apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "envoy-proxy.fullname" . }}-config
  labels:
    {{- include "envoy-proxy.labels" . | nindent 4 }}
data:
  envoy.yaml: |
    # Envoy Outbound Proxy Configuration
    # RSS Feed専用Dynamic Forward Proxy with Domain Whitelist

    static_resources:
      listeners:
      - name: rss_outbound_listener
        address:
          socket_address:
            address: 0.0.0.0
            port_value: {{ include "envoy-proxy.proxyPort" . }}
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              
              stat_prefix: rss_outbound_proxy
              
              # アクセスログ設定（Envoy 1.35.0対応）
              access_log:
              - name: envoy.access_loggers.stdout
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                  log_format:
                    text_format_source:
                      inline_string: |
                        [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
                        %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT%
                        %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%"
                        "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%"
                        upstream="%UPSTREAM_HOST%" domain="%REQ(X-TARGET-DOMAIN)%"
              
              # HTTPフィルターチェーン
              http_filters:
              # Dynamic Forward Proxy フィルター（Envoy 1.35.0対応）
              - name: envoy.filters.http.dynamic_forward_proxy
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.FilterConfig
                  dns_cache_config:
                    name: dynamic_forward_proxy_cache_config
                    dns_lookup_family: V4_ONLY
                    dns_refresh_rate: {{ .Values.envoy.dns.ttl }}
                    dns_failure_refresh_rate:
                      base_interval: 2s
                      max_interval: 10s
                    host_ttl: 86400s
                    max_hosts: 256
                    # DNS解決時の追加設定
                    dns_query_timeout: 5s
                    dns_min_refresh_rate: 5s
              
              # ルーター（最終フィルター）
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
              
              # ルート設定（Envoy 1.35.0対応）
              route_config:
                name: rss_outbound_route
                virtual_hosts:
                - name: rss_outbound_virtual_host
                  domains: ["*"]
                  routes:
                  # ヘルスチェックエンドポイント
                  - match:
                      path: "/health"
                    direct_response:
                      status: 200
                      body:
                        inline_string: "Envoy RSS Outbound Proxy OK\nVersion: 1.35.0\nAllowed domains: {{ join ", " .Values.envoy.allowedDomains }}\n"
                  
                  - match:
                      path: "/ready"
                    direct_response:
                      status: 200
                      body:
                        inline_string: "Ready"
                  
                  # 許可ドメイン別ルート（Dynamic Forward Proxy対応）
                  {{- range .Values.envoy.allowedDomains }}
                  - match:
                      prefix: "/proxy/https://{{ . }}/"
                    route:
                      cluster: dynamic_forward_proxy_cluster
                      timeout: {{ $.Values.envoy.timeout.response }}
                      prefix_rewrite: "/"
                    typed_per_filter_config:
                      envoy.filters.http.dynamic_forward_proxy:
                        "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.PerRouteConfig
                        host_rewrite_literal: "{{ . }}"
                  - match:
                      prefix: "/proxy/https://{{ . }}"
                    route:
                      cluster: dynamic_forward_proxy_cluster
                      timeout: {{ $.Values.envoy.timeout.response }}
                      regex_rewrite:
                        pattern:
                          regex: "^/proxy/https://{{ . }}(.*)$"
                        substitution: "\\1"
                    typed_per_filter_config:
                      envoy.filters.http.dynamic_forward_proxy:
                        "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.PerRouteConfig
                        host_rewrite_literal: "{{ . }}"
                  - match:
                      prefix: "/proxy/http://{{ . }}/"
                    route:
                      cluster: dynamic_forward_proxy_cluster
                      timeout: {{ $.Values.envoy.timeout.response }}
                      prefix_rewrite: "/"
                    typed_per_filter_config:
                      envoy.filters.http.dynamic_forward_proxy:
                        "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.PerRouteConfig
                        host_rewrite_literal: "{{ . }}"
                  - match:
                      prefix: "/proxy/http://{{ . }}"
                    route:
                      cluster: dynamic_forward_proxy_cluster
                      timeout: {{ $.Values.envoy.timeout.response }}
                      regex_rewrite:
                        pattern:
                          regex: "^/proxy/http://{{ . }}(.*)$"
                        substitution: "\\1"
                    typed_per_filter_config:
                      envoy.filters.http.dynamic_forward_proxy:
                        "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.PerRouteConfig
                        host_rewrite_literal: "{{ . }}"
                  {{- end }}
                  
                  # 不正パスの処理
                  - match:
                      prefix: "/"
                    direct_response:
                      status: 403
                      body:
                        inline_string: "RSS Outbound Proxy - Domain not in whitelist or invalid format\nAllowed domains: {{ join ", " .Values.envoy.allowedDomains }}\nFormat: /proxy/https://domain.com/path"

      # Dynamic Forward Proxyクラスター（Envoy 1.35.0対応 + TLS）
      clusters:
      - name: dynamic_forward_proxy_cluster
        connect_timeout: {{ .Values.envoy.timeout.connect }}
        lb_policy: CLUSTER_PROVIDED
        # TLS transport socket for HTTPS upstream connections (Testing Configuration)
        transport_socket:
          name: envoy.transport_sockets.tls
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
            common_tls_context:
              validation_context:
                # Temporary: Skip certificate verification for testing
                trust_chain_verification: ACCEPT_UNTRUSTED
        cluster_type:
          name: envoy.clusters.dynamic_forward_proxy
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.clusters.dynamic_forward_proxy.v3.ClusterConfig
            dns_cache_config:
              name: dynamic_forward_proxy_cache_config
              dns_lookup_family: V4_ONLY
              dns_refresh_rate: {{ .Values.envoy.dns.ttl }}
              dns_failure_refresh_rate:
                base_interval: 2s
                max_interval: 10s
              host_ttl: 86400s
              max_hosts: 256
              # Envoy 1.35.0 新機能
              dns_query_timeout: 5s
              dns_min_refresh_rate: 5s
        # アップストリーム接続設定
        upstream_connection_options:
          tcp_keepalive:
            keepalive_probes: 3
            keepalive_time: 300
            keepalive_interval: 30
        # 回路ブレーカー設定
        circuit_breakers:
          thresholds:
          - priority: DEFAULT
            max_connections: 256
            max_pending_requests: 256
            max_requests: 1024
            max_retries: 8

    # 管理インターフェース
    admin:
      address:
        socket_address:
          address: 0.0.0.0
          port_value: {{ include "envoy-proxy.adminPort" . }}
      
    # ログ設定
    stats_config:
      stats_tags:
      - tag_name: "proxy_type"
        fixed_value: "rss_outbound"
      - tag_name: "service"
        fixed_value: "envoy-proxy"