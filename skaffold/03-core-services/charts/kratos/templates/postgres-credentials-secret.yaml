{{- if and .Values.postgresql.enabled .Values.postgresql.auth.username .Values.postgresql.auth.password }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "kratos.fullname" . }}-postgres-credentials
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "kratos.labels" . | nindent 4 }}
type: Opaque
data:
  # PostgreSQL DSN for Kratos database connection
  dsn: {{ printf "postgres://%s:%s@%s:%s/%s?sslmode=%s&max_conns=20&max_idle_conns=4" 
    .Values.postgresql.auth.username 
    .Values.postgresql.auth.password 
    .Values.postgresql.service.name 
    (.Values.postgresql.service.port | toString)
    .Values.postgresql.auth.database 
    .Values.postgresql.sslmode | b64enc }}
{{- end }}