# レイヤー04: Core Services 概要

## 1. 責務

この`04-core-services`レイヤーは、Altプロジェクトのビジネスロジックの中核を担う、主要なバックエンドサービス群を管理・デプロイする責務を負います。アプリケーションの頭脳として機能し、クライアントからのリクエスト処理、データ永続化層との連携、外部サービスとの通信制御などを担当します。

## 2. 管理コンポーネント

`skaffold.yaml`で定義されている主要なHelmリリースは以下の通りです。これらはすべて`alt-apps`ネームスペースにデプロイされます。

| Helmリリース名 | Chartパス | 説明 |
| :--- | :--- | :--- |
| `envoy-proxy` | `charts/envoy-proxy` | 外部サービスへのEgress（外向き）通信を一元的に管理・制御するためのEnvoyプロキシ。セキュリティポリシーの適用、トレーシング、メトリクス収集などを中央集権的に行います。 |
| `sidecar-proxy` | `charts/sidecar-proxy` | `alt-backend`の補助的なタスク（特定の外部APIとの通信など）を担う、Go言語で実装された軽量なプロキシ。元々はサイドカーパターンで利用されていましたが、現在は独立したサービスとしてデプロイされています。 |
| `alt-backend` | `charts/alt-backend` | Go言語(Echoフレームワーク)で実装されたメインAPIサーバー。RSSフィード管理、記事の取得・保存、ユーザー設定など、プロジェクトのコアとなるビジネスロジックの大部分を処理します。 |

## 3. プロファイル

- **`prod`**: このレイヤーでは`prod`プロファイルのみが明示的に定義されています。これは、コアサービスが本番環境またはそれに準ずる、安定した構成での稼働を前提としていることを示唆しています。

## 4. ビルドアーティファクト

- **`kaikei/alt-backend`**: `alt-backend`サービスのコンテナイメージ。
- **`kaikei/project-alt/alt-backend-sidecar-proxy`**: `sidecar-proxy`サービスのコンテナイメージ。

## 5. デプロイ戦略と構成の変遷

- **宣言的なプロキシルーティング**: `alt-backend`のデプロイ設定には、`PROXY_STRATEGY: "DISABLED"`や`ENVOY_PROXY_ENABLED: "false"`といった環境変数が含まれています。これは、過去に複数のプロキシ戦略が存在し、現在はより宣言的でシンプルな構成（Envoyへの集約など）へと移行していることを示唆しています。「Phase 7a根本解決」といったコメントからも、アーキテクチャの改善が行われてきた経緯が伺えます。
- **安定したデプロイ**: `--atomic`, `--wait`, `--wait-for-jobs`といったHelmフラグを利用し、デプロイの信頼性と一貫性を高めています。
- **デプロイ後検証**: デプロイの完了後に`kubectl get pods`コマンドを実行するフックが設定されており、デプロイされたコアコンポーネントが正常に起動しているかを即座に確認する仕組みが導入されています。
