apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "envoy-proxy.fullname" . }}-config
  labels:
    {{- include "envoy-proxy.labels" . | nindent 4 }}
data:
  envoy.yaml: |
    # Envoy Outbound Proxy Configuration
    # RSS Feedå°‚ç”¨Dynamic Forward Proxy with Domain Whitelist

    static_resources:
      listeners:
      - name: rss_outbound_listener
        address:
          socket_address:
            address: 0.0.0.0
            port_value: {{ include "envoy-proxy.proxyPort" . }}
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              
              stat_prefix: rss_outbound_proxy
              
              # ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨­å®šï¼ˆEnvoy 1.35.0å¯¾å¿œï¼‰
              access_log:
              - name: envoy.access_loggers.stdout
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                  log_format:
                    text_format_source:
                      inline_string: |
                        [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
                        %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT%
                        %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%"
                        "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%"
                        upstream="%UPSTREAM_HOST%" domain="%REQ(:AUTHORITY)%" target_header="%REQ(X-TARGET-DOMAIN)%" 
                        original_host="%REQ(X-ENVOY-ORIGINAL-HOST)%" filter_state_host="%FILTER_STATE(envoy.upstream.dynamic_host)%"
                        flags="%RESPONSE_FLAGS%" dns_resolution_time="%REQUEST_DURATION%" upstream_connect_time="%REQUEST_DURATION%"
              
              # Header manipulation via route-level configuration (Envoy 1.34.0 compatible)
              
              # HTTPãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒã‚§ãƒ¼ãƒ³ - ã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼ˆã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³é•åå›é¿ï¼‰
              http_filters:
              # Dynamic Forward Proxy with Host Header (ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ)
              - name: envoy.filters.http.dynamic_forward_proxy
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.FilterConfig
                  dns_cache_config:
                    name: dynamic_forward_proxy_cache_config
                    dns_lookup_family: V4_ONLY
                    dns_refresh_rate: {{ .Values.envoy.dns.ttl }}
                    dns_failure_refresh_rate:
                      base_interval: 2s
                      max_interval: 10s
                    host_ttl: 86400s
                    max_hosts: 256
                    dns_query_timeout: 5s
                    dns_min_refresh_rate: 5s
              
              # ãƒ«ãƒ¼ã‚¿ãƒ¼ï¼ˆæœ€çµ‚ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼‰
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
              
              # ãƒ«ãƒ¼ãƒˆè¨­å®šï¼ˆEnvoy 1.35.0å¯¾å¿œï¼‰
              route_config:
                name: rss_outbound_route
                virtual_hosts:
                - name: rss_outbound_virtual_host
                  domains: ["*"]
                  routes:
                  # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
                  - match:
                      path: "/health"
                    direct_response:
                      status: 200
                      body:
                        inline_string: "Envoy RSS Outbound Proxy OK\nVersion: 1.35.0 Filter State Priority Mode\nDynamic Host: Filter State > Host Header\nAllowed domains: {{ join ", " .Values.envoy.allowedDomains }}\nSecurity: HTTP blocked, HTTPS enforced\nFeature: allow_dynamic_host_from_filter_state=true\n"
                  
                  - match:
                      path: "/ready"
                    direct_response:
                      status: 200
                      body:
                        inline_string: "Ready"
                  
                  # HTTPS RSS feeds route with TLS cluster (XPLAN7æ­¢è¡€ç­–)
                  - match:
                      prefix: "/proxy/https://"
                      headers:
                      - name: "X-Target-Domain"
                        present_match: true
                    route:
                      cluster: dynamic_forward_proxy_tls_cluster
                      timeout: {{ .Values.envoy.timeout.response }}
                      # ğŸš‘ XPLAN7æ­¢è¡€ç­–: åŸºæœ¬çš„ãªhostæ›¸æ›ã§DFPè§£æ±ºã‚’æ­£ã™
                      host_rewrite_header: "X-Target-Domain"
                      # Path rewriting: /proxy/https://domain.com/path -> /path
                      regex_rewrite:
                        pattern:
                          google_re2: {}
                          regex: "^/proxy/https://[^/]+(.*)$"
                        substitution: "\\1"
                  
                  # HTTP requests are explicitly blocked (HTTPSã®ã¿è¨±å¯æ–¹é‡)
                  - match:
                      prefix: "/proxy/http://"
                    direct_response:
                      status: 403
                      body:
                        inline_string: "HTTP RSS feeds are not supported for security reasons\nOnly HTTPS is allowed: /proxy/https://domain.com/path\nRequired header: X-Target-Domain\n"
                  
                  # Catch-all for malformed requests (HTTPSã®ã¿è¨±å¯)
                  - match:
                      prefix: "/proxy/"
                    direct_response:
                      status: 400
                      body:
                        inline_string: "Only HTTPS RSS feeds are supported for security\nFormat: /proxy/https://domain.com/path\nRequired header: X-Target-Domain\n"
                  
                  # ä¸æ­£ãƒ‘ã‚¹ã®å‡¦ç† (HTTPSã®ã¿è¨±å¯)
                  - match:
                      prefix: "/"
                    direct_response:
                      status: 403
                      body:
                        inline_string: "RSS Outbound Proxy - HTTPS Only\nSupported format: /proxy/https://domain.com/path\nRequired header: X-Target-Domain\nAllowed domains: {{ join ", " .Values.envoy.allowedDomains }}\nSecurity: HTTP blocked for security reasons\n"

      # Dynamic Forward Proxyã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ï¼ˆHTTPSå°‚ç”¨ - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
      clusters:
      - name: dynamic_forward_proxy_tls_cluster
        connect_timeout: {{ .Values.envoy.timeout.connect }}
        lb_policy: CLUSTER_PROVIDED
        # TLS transport socket for HTTPS upstream connections (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–)
        transport_socket:
          name: envoy.transport_sockets.tls
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
            common_tls_context:
              validation_context:
                # XPLAN7.md: åŸºæœ¬çš„ãªè¨¼æ˜æ›¸æ¤œè¨¼ï¼ˆACCEPT_UNTRUSTEDé™¤å»ï¼‰
                trust_chain_verification: VERIFY_TRUST_CHAIN
              # æœ€ä½TLSãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®š (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–)
              tls_params:
                tls_minimum_protocol_version: TLSv1_2
                tls_maximum_protocol_version: TLSv1_3
            # XPLAN7æ­¢è¡€ç­–: åŸºæœ¬TLSè¨­å®šï¼ˆv1.34äº’æ›ï¼‰
            # SNI is automatically set by Dynamic Forward Proxy based on target host
        cluster_type:
          name: envoy.clusters.dynamic_forward_proxy
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.clusters.dynamic_forward_proxy.v3.ClusterConfig
            dns_cache_config:
              name: dynamic_forward_proxy_cache_config
              dns_lookup_family: V4_ONLY
              dns_refresh_rate: {{ .Values.envoy.dns.ttl }}  
              dns_failure_refresh_rate:
                base_interval: 2s
                max_interval: 10s
              host_ttl: 86400s
              max_hosts: 256
              dns_query_timeout: 5s
              dns_min_refresh_rate: 5s
        # ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ æ¥ç¶šè¨­å®š
        upstream_connection_options:
          tcp_keepalive:
            keepalive_probes: 3
            keepalive_time: 300
            keepalive_interval: 30
        # å›è·¯ãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼è¨­å®š
        circuit_breakers:
          thresholds:
          - priority: DEFAULT
            max_connections: 256
            max_pending_requests: 256
            max_requests: 1024
            max_retries: 8

    # ç®¡ç†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
    admin:
      address:
        socket_address:
          address: 0.0.0.0
          port_value: {{ include "envoy-proxy.adminPort" . }}
      
    # ãƒ­ã‚°è¨­å®š
    stats_config:
      stats_tags:
      - tag_name: "proxy_type"
        fixed_value: "rss_outbound"
      - tag_name: "service"
        fixed_value: "envoy-proxy"