apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "envoy-proxy.fullname" . }}-config
  labels:
    {{- include "envoy-proxy.labels" . | nindent 4 }}
data:
  envoy.yaml: |
    # Envoy Outbound Proxy Configuration
    # RSS Feed専用Dynamic Forward Proxy with Domain Whitelist

    static_resources:
      listeners:
      - name: rss_outbound_listener
        address:
          socket_address:
            address: 0.0.0.0
            port_value: {{ include "envoy-proxy.proxyPort" . }}
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              
              stat_prefix: rss_outbound_proxy
              
              # アクセスログ設定（Envoy 1.35.0対応）
              access_log:
              - name: envoy.access_loggers.stdout
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                  log_format:
                    text_format_source:
                      inline_string: |
                        [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
                        %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT%
                        %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%"
                        "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%"
                        upstream="%UPSTREAM_HOST%" domain="%REQ(:AUTHORITY)%" target_header="%REQ(X-TARGET-DOMAIN)%"
              
              # Header manipulation via route-level configuration (Envoy 1.34.0 compatible)
              
              # HTTPフィルターチェーン - ANALYSIS_REPORT.md Phase 7a優化
              http_filters:
              # Filter State設定によるDNS解決優先順位最適化
              - name: envoy.filters.http.set_filter_state
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.set_filter_state.v3.Config
                  on_request_headers:
                    - object_key: "envoy.upstream.dynamic_host"
                      format_string:
                        text_format_source:
                          inline_string: "%REQ(X-Target-Domain)%"  # プロキシ経由ホスト抽出
                    - object_key: "envoy.upstream.dynamic_port"
                      format_string:
                        text_format_source:
                          inline_string: "443"  # HTTPS専用

              # Dynamic Forward Proxy filter (Filter State優先解決対応)
              - name: envoy.filters.http.dynamic_forward_proxy
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.FilterConfig
                  dns_cache_config:
                    name: dynamic_forward_proxy_cache_config
                    dns_lookup_family: V4_ONLY
                    dns_refresh_rate: {{ .Values.envoy.dns.ttl }}
                    dns_failure_refresh_rate:
                      base_interval: 2s
                      max_interval: 10s
                    host_ttl: 86400s
                    max_hosts: 256
                    dns_query_timeout: 5s
                    dns_min_refresh_rate: 5s
                  # Note: allow_dynamic_host_from_filter_state removed in Envoy 1.35.0
                  # DNS resolution is handled through standard DFP mechanisms
              
              # ルーター（最終フィルター）
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
              
              # ルート設定（Envoy 1.35.0対応）
              route_config:
                name: rss_outbound_route
                virtual_hosts:
                - name: rss_outbound_virtual_host
                  domains: ["*"]
                  routes:
                  # ヘルスチェックエンドポイント
                  - match:
                      path: "/health"
                    direct_response:
                      status: 200
                      body:
                        inline_string: "Envoy RSS Outbound Proxy OK\nVersion: 1.34.0 HTTPS-Only Security Mode\nDynamic Host: Host Rewrite Based\nAllowed domains: {{ join ", " .Values.envoy.allowedDomains }}\nSecurity: HTTP blocked, HTTPS enforced\n"
                  
                  - match:
                      path: "/ready"
                    direct_response:
                      status: 200
                      body:
                        inline_string: "Ready"
                  
                  # HTTPS RSS feeds route with TLS cluster (ANALYSIS_REPORT.md Phase 7a対応)
                  - match:
                      prefix: "/proxy/https://"
                      headers:
                      - name: "X-Target-Domain"
                        present_match: true
                    route:
                      cluster: dynamic_forward_proxy_tls_cluster
                      timeout: {{ .Values.envoy.timeout.response }}
                      # Host rewrite to use X-Target-Domain header value
                      host_rewrite_header: "X-Target-Domain"
                      # Host rewrite configuration (Filter State優先、fallbackとしてHost Rewrite)
                      # Note: typed_per_filter_config removed in Envoy 1.35.0, using host_rewrite_header instead
                      # Path rewriting (proxy-sidecar handles header manipulation)
                      regex_rewrite:
                        pattern:
                          google_re2: {}
                          regex: "^/proxy/https://[^/]+(.*)$"
                        substitution: "\\1"
                  
                  # HTTP requests are explicitly blocked (HTTPSのみ許可方針)
                  - match:
                      prefix: "/proxy/http://"
                    direct_response:
                      status: 403
                      body:
                        inline_string: "HTTP RSS feeds are not supported for security reasons\nOnly HTTPS is allowed: /proxy/https://domain.com/path\nRequired header: X-Target-Domain\n"
                  
                  # Catch-all for malformed requests (HTTPSのみ許可)
                  - match:
                      prefix: "/proxy/"
                    direct_response:
                      status: 400
                      body:
                        inline_string: "Only HTTPS RSS feeds are supported for security\nFormat: /proxy/https://domain.com/path\nRequired header: X-Target-Domain\n"
                  
                  # 不正パスの処理 (HTTPSのみ許可)
                  - match:
                      prefix: "/"
                    direct_response:
                      status: 403
                      body:
                        inline_string: "RSS Outbound Proxy - HTTPS Only\nSupported format: /proxy/https://domain.com/path\nRequired header: X-Target-Domain\nAllowed domains: {{ join ", " .Values.envoy.allowedDomains }}\nSecurity: HTTP blocked for security reasons\n"

      # Dynamic Forward Proxyクラスター（HTTPS専用 - セキュリティ強化）
      clusters:
      - name: dynamic_forward_proxy_tls_cluster
        connect_timeout: {{ .Values.envoy.timeout.connect }}
        lb_policy: CLUSTER_PROVIDED
        # TLS transport socket for HTTPS upstream connections (セキュリティ強化)
        transport_socket:
          name: envoy.transport_sockets.tls
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
            common_tls_context:
              validation_context:
                # デバッグ用: 証明書検証スキップ (本番では適切な証明書設定が必要)
                trust_chain_verification: ACCEPT_UNTRUSTED
              # 最低TLSバージョン設定 (セキュリティ強化)
              tls_params:
                tls_minimum_protocol_version: TLSv1_2
                tls_maximum_protocol_version: TLSv1_3
            # SNI is automatically set by Dynamic Forward Proxy based on target host
        cluster_type:
          name: envoy.clusters.dynamic_forward_proxy
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.clusters.dynamic_forward_proxy.v3.ClusterConfig
            dns_cache_config:
              name: dynamic_forward_proxy_cache_config
              dns_lookup_family: V4_ONLY
              dns_refresh_rate: {{ .Values.envoy.dns.ttl }}  
              dns_failure_refresh_rate:
                base_interval: 2s
                max_interval: 10s
              host_ttl: 86400s
              max_hosts: 256
              dns_query_timeout: 5s
              dns_min_refresh_rate: 5s
        # アップストリーム接続設定
        upstream_connection_options:
          tcp_keepalive:
            keepalive_probes: 3
            keepalive_time: 300
            keepalive_interval: 30
        # 回路ブレーカー設定
        circuit_breakers:
          thresholds:
          - priority: DEFAULT
            max_connections: 256
            max_pending_requests: 256
            max_requests: 1024
            max_retries: 8

    # 管理インターフェース
    admin:
      address:
        socket_address:
          address: 0.0.0.0
          port_value: {{ include "envoy-proxy.adminPort" . }}
      
    # ログ設定
    stats_config:
      stats_tags:
      - tag_name: "proxy_type"
        fixed_value: "rss_outbound"
      - tag_name: "service"
        fixed_value: "envoy-proxy"