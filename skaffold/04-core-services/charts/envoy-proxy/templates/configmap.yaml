apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "envoy-proxy.fullname" . }}-config
  labels:
    {{- include "envoy-proxy.labels" . | nindent 4 }}
data:
  envoy.yaml: |
    # Envoy Outbound Proxy Configuration
    # RSS Feed専用Dynamic Forward Proxy with Domain Whitelist

    static_resources:
      listeners:
      - name: rss_outbound_listener
        address:
          socket_address:
            address: 0.0.0.0
            port_value: {{ include "envoy-proxy.proxyPort" . }}
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              
              stat_prefix: rss_outbound_proxy
              
              # アクセスログ設定（Envoy 1.35.0対応）
              access_log:
              - name: envoy.access_loggers.stdout
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                  log_format:
                    text_format_source:
                      inline_string: |
                        [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
                        %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT%
                        %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%"
                        "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%"
                        upstream="%UPSTREAM_HOST%" domain="%REQ(:AUTHORITY)%" target_header="%REQ(X-TARGET-DOMAIN)%" 
                        original_host="%REQ(X-ENVOY-ORIGINAL-HOST)%" filter_state_host="%FILTER_STATE(envoy.upstream.dynamic_host)%"
                        flags="%RESPONSE_FLAGS%" dns_resolution_time="%REQUEST_DURATION%" upstream_connect_time="%REQUEST_DURATION%"
              
              # Header manipulation via route-level configuration (Envoy 1.34.0 compatible)
              
              # HTTPフィルターチェーン - DNS解決済みプロキシモード
              http_filters:
              # Dynamic Forward Proxy（sidecar-proxyのDNS解決結果使用）
              - name: envoy.filters.http.dynamic_forward_proxy
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.FilterConfig
                  dns_cache_config:
                    name: dynamic_forward_proxy_cache_config
                    dns_lookup_family: V4_ONLY
                    # DNS解決を最小化（sidecar-proxyが既に解決済み）
                    dns_refresh_rate: 3600s
                    host_ttl: 3600s
                    max_hosts: 1024
              
              # ルーター（最終フィルター）
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
              
              # ルート設定（Envoy 1.35.0対応）
              route_config:
                name: rss_outbound_route
                virtual_hosts:
                - name: rss_outbound_virtual_host
                  domains: ["*"]
                  routes:
                  # ヘルスチェックエンドポイント
                  - match:
                      path: "/health"
                    direct_response:
                      status: 200
                      body:
                        inline_string: "Envoy RSS Outbound Proxy OK\nVersion: 1.35.0 Simplified DNS Mode\nDNS Resolution: Handled by sidecar-proxy\nAllowed domains: {{ join ", " .Values.envoy.allowedDomains }}\nSecurity: HTTP blocked, HTTPS enforced\nMode: sidecar-proxy DNS + Envoy TLS proxy\n"
                  
                  - match:
                      path: "/ready"
                    direct_response:
                      status: 200
                      body:
                        inline_string: "Ready"
                  
                  # HTTPS RSS feeds route with simple proxy (sidecar-proxy DNS解決済み)
                  - match:
                      prefix: "/proxy/https://"
                      headers:
                      - name: "X-Target-Domain"
                        present_match: true
                      - name: "X-Resolved-IP"
                        present_match: true
                    route:
                      cluster: dynamic_forward_proxy_cluster
                      timeout: {{ .Values.envoy.timeout.response }}
                      # sidecar-proxyから提供されたホスト名使用
                      host_rewrite_header: "X-Target-Domain"
                      # Simple path rewrite: remove /proxy/https://domain.com prefix
                      prefix_rewrite: "/"
                  
                  # Model download route with persistent connection (sidecar-proxy DNS解決済み)
                  - match:
                      prefix: "/connect/"
                      headers:
                      - name: "X-Target-Domain"
                        present_match: true
                      - name: "X-Resolved-IP"
                        present_match: true
                    route:
                      cluster: dynamic_forward_proxy_cluster
                      timeout: 600s  # 10分: Model download用の長時間接続
                      # sidecar-proxyから提供されたホスト名使用
                      host_rewrite_header: "X-Target-Domain"
                      # Simple path rewrite: default to root path
                      prefix_rewrite: "/"
                  
                  # HTTP requests are explicitly blocked (HTTPSのみ許可方針)
                  - match:
                      prefix: "/proxy/http://"
                    direct_response:
                      status: 403
                      body:
                        inline_string: "HTTP RSS feeds are not supported for security reasons\nOnly HTTPS is allowed: /proxy/https://domain.com/path\nRequired header: X-Target-Domain\n"
                  
                  # Catch-all for malformed requests (HTTPSのみ許可)
                  - match:
                      prefix: "/proxy/"
                    direct_response:
                      status: 400
                      body:
                        inline_string: "Only HTTPS RSS feeds are supported for security\nFormat: /proxy/https://domain.com/path\nRequired header: X-Target-Domain\n"
                  
                  # 不正パスの処理 (HTTPSのみ許可)
                  - match:
                      prefix: "/"
                    direct_response:
                      status: 403
                      body:
                        inline_string: "RSS Outbound Proxy - HTTPS Only\nSupported format: /proxy/https://domain.com/path\nRequired header: X-Target-Domain\nAllowed domains: {{ join ", " .Values.envoy.allowedDomains }}\nSecurity: HTTP blocked for security reasons\n"

      # 動的フォワードプロキシクラスター（sidecar-proxyのDNS解決結果使用）
      clusters:
      - name: dynamic_forward_proxy_cluster
        connect_timeout: {{ .Values.envoy.timeout.connect }}
        lb_policy: CLUSTER_PROVIDED
        # TLS transport socket for HTTPS upstream connections
        transport_socket:
          name: envoy.transport_sockets.tls
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
            common_tls_context:
              validation_context:
                trust_chain_verification: VERIFY_TRUST_CHAIN
              tls_params:
                tls_minimum_protocol_version: TLSv1_2
                tls_maximum_protocol_version: TLSv1_3
        cluster_type:
          name: envoy.clusters.dynamic_forward_proxy
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.clusters.dynamic_forward_proxy.v3.ClusterConfig
            dns_cache_config:
              name: dynamic_forward_proxy_cache_config
              dns_lookup_family: V4_ONLY
              # DNS解決を無効化（sidecar-proxyが既に解決済み）
              dns_refresh_rate: 3600s  # 1時間：事実上無効化
              host_ttl: 3600s
              max_hosts: 1024
        # アップストリーム接続設定
        upstream_connection_options:
          tcp_keepalive:
            keepalive_probes: 3
            keepalive_time: 300
            keepalive_interval: 30
        # 回路ブレーカー設定
        circuit_breakers:
          thresholds:
          - priority: DEFAULT
            max_connections: 256
            max_pending_requests: 256
            max_requests: 1024
            max_retries: 8

    # 管理インターフェース
    admin:
      address:
        socket_address:
          address: 0.0.0.0
          port_value: {{ include "envoy-proxy.adminPort" . }}
      
    # ログ設定
    stats_config:
      stats_tags:
      - tag_name: "proxy_type"
        fixed_value: "rss_outbound"
      - tag_name: "service"
        fixed_value: "envoy-proxy"