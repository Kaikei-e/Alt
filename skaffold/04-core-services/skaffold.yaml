apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: alt-core-services

profiles:
  - name: prod
    build:
      local:
        push: false
        useDockerCLI: false
        concurrency: 1
      tagPolicy:
        gitCommit: {}
      artifacts:
        - image: kaikei/alt-backend
          context: ../../alt-backend
          docker:
            dockerfile: Dockerfile.backend
        - image: kaikei/project-alt/alt-backend-sidecar-proxy
          context: ../../alt-backend/sidecar-proxy
          docker:
            dockerfile: Dockerfile
    deploy:
      statusCheckDeadlineSeconds: 600
      statusCheck: true
      helm:
        releases:
          # Phase 7aæ ¹æœ¬è§£æ±º: Envoy Proxy
          - name: envoy-proxy
            chartPath: charts/envoy-proxy
            namespace: alt-apps
            createNamespace: true
            valuesFiles:
              - charts/envoy-proxy/values.yaml
            setValues:
              # Phase 7a Filter State optimization enabled
              envoy.filterState.enabled: true
              envoy.filterState.httpsOnly: true
              security.httpsOnly: true
            version: 0.1.0
          
          # Independent sidecar-proxy deployment
          - name: sidecar-proxy
            chartPath: charts/sidecar-proxy
            namespace: alt-apps
            createNamespace: true
            valuesFiles:
              - charts/sidecar-proxy/values-production.yaml
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_project_alt_alt_backend_sidecar_proxy}}"
              image.tag: "{{.IMAGE_TAG_kaikei_project_alt_alt_backend_sidecar_proxy}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
            version: 0.1.0
          
          # Phase 7aæ ¹æœ¬è§£æ±º: Alt-backend withå®Œå…¨å®£è¨€çš„Proxy routing
          - name: alt-backend
            chartPath: charts/alt-backend
            namespace: alt-apps
            createNamespace: true
            valuesFiles:
              - charts/alt-backend/values.yaml
              - charts/alt-backend/values-production.yaml
            setValueTemplates:
              image.repository: "{{.IMAGE_REPO_kaikei_alt_backend}}"
              image.tag: "{{.IMAGE_TAG_kaikei_alt_backend}}"
            setValues:
              image.pullPolicy: "IfNotPresent"
              # æ ¹æœ¬è§£æ±º: çµ±ä¸€HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ•ã‚¡ã‚¯ãƒˆãƒªæˆ¦ç•¥è¨­å®šï¼ˆç‹¬ç«‹sidecar-proxyä½¿ç”¨ï¼‰
              env.PROXY_STRATEGY: "SIDECAR"
              env.SIDECAR_PROXY_BASE_URL: "http://sidecar-proxy.alt-apps.svc.cluster.local:8085"
              # Legacy proxyè¨­å®šï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
              env.ENVOY_PROXY_ENABLED: "false"
              env.SIDECAR_PROXY_ENABLED: "false"
              env.ENVOY_PROXY_URL: "http://envoy-proxy.alt-apps.svc.cluster.local:8080"
              env.NGINX_PROXY_ENABLED: "false"
              # Phase 2.2: Update to use independent sidecar-proxy service
              env.SIDECAR_PROXY_URL: "http://sidecar-proxy.alt-apps.svc.cluster.local:8085"
              # ConfigMap checksumå¼·åˆ¶æ›´æ–°
              forceUpdate: true
            version: 0.1.0
        flags:
          install: ['--atomic', '--wait', '--timeout=600s', '--wait-for-jobs', '--create-namespace']
          upgrade: ['--atomic', '--wait', '--timeout=600s', '--cleanup-on-fail', '--wait-for-jobs']
        hooks:
          before:
            - host:
                command: ["echo", "ğŸš€ æ ¹æœ¬è§£æ±º: Core Services ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé–‹å§‹"]
          after:
            - host:
                command: ["echo", "âœ… Core Services ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†"]
            - host:
                command: ["kubectl", "get", "pods", "-n", "alt-apps", "-l", "app.kubernetes.io/name=alt-backend", "-o", "wide"]
            - host:
                command: ["kubectl", "get", "pods", "-n", "alt-apps", "-l", "app.kubernetes.io/name=envoy-proxy", "-o", "wide"]

build:
  artifacts:
    - image: kaikei/alt-backend
      context: ../../alt-backend
      docker:
        dockerfile: Dockerfile.backend
    - image: kaikei/project-alt/alt-backend-sidecar-proxy
      context: ../../alt-backend/sidecar-proxy
      docker:
        dockerfile: Dockerfile