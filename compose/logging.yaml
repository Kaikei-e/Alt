# compose/logging.yaml - Logging infrastructure
# Rask log aggregator and forwarders

include:
  - base.yaml

services:
  rask-log-aggregator:
    build:
      context: ../rask-log-aggregator
      dockerfile: Dockerfile.rask-log-aggregator
    restart: unless-stopped
    ports:
      - "9600:9600"   # HTTP API (既存)
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    networks:
      - alt-network
    tty: true
    labels:
      - rask.group=rask-log-aggregator
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      # ClickHouse接続
      APP_CLICKHOUSE_HOST: clickhouse
      APP_CLICKHOUSE_PORT: 8123
      APP_CLICKHOUSE_USER: ${CLICKHOUSE_USER}
      APP_CLICKHOUSE_PASSWORD_FILE: /run/secrets/clickhouse_password
      APP_CLICKHOUSE_DATABASE: ${CLICKHOUSE_DB}
      # OTLPポート設定
      OTLP_GRPC_PORT: 4317
      OTLP_HTTP_PORT: 4318
      HTTP_PORT: 9600
    secrets:
      - clickhouse_password
    healthcheck:
      test: ["CMD", "/rask-log-aggregator", "healthcheck"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

  nginx-logs:
    build:
      context: ../rask-log-forwarder/app
      dockerfile: Dockerfile.rask-log-forwarder
    networks:
      - alt-network
    depends_on:
      rask-log-aggregator:
        condition: service_healthy
    environment:
      DOCKER_HOST: "unix:///var/run/docker.sock"
      LOG_LEVEL: "info"
      RUST_LOG: "info"
      RASK_ENDPOINT: "http://rask-log-aggregator:9600/v1/aggregate"
      BATCH_SIZE: "1000"
      FLUSH_INTERVAL_MS: "500"
      BUFFER_CAPACITY: "100000"
      TARGET_SERVICE: "${NGINX_TARGET:-nginx}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    group_add:
      - "${DOCKER_GROUP_ID:-984}"
    restart: unless-stopped
    stop_grace_period: 12s

  alt-backend-logs:
    build:
      context: ../rask-log-forwarder/app
      dockerfile: Dockerfile.rask-log-forwarder
    networks:
      - alt-network
    depends_on:
      rask-log-aggregator:
        condition: service_healthy
    environment:
      DOCKER_HOST: "unix:///var/run/docker.sock"
      LOG_LEVEL: "info"
      RUST_LOG: "info"
      RASK_ENDPOINT: "http://rask-log-aggregator:9600/v1/aggregate"
      BATCH_SIZE: "1000"
      FLUSH_INTERVAL_MS: "500"
      BUFFER_CAPACITY: "100000"
      TARGET_SERVICE: "${ALT_BACKEND_TARGET:-alt-backend}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    group_add:
      - "${DOCKER_GROUP_ID:-984}"
    restart: unless-stopped
    stop_grace_period: 12s

  tag-generator-logs:
    build:
      context: ../rask-log-forwarder/app
      dockerfile: Dockerfile.rask-log-forwarder
    networks:
      - alt-network
    depends_on:
      rask-log-aggregator:
        condition: service_healthy
    environment:
      DOCKER_HOST: "unix:///var/run/docker.sock"
      LOG_LEVEL: "info"
      RUST_LOG: "info"
      RASK_ENDPOINT: "http://rask-log-aggregator:9600/v1/aggregate"
      BATCH_SIZE: "1000"
      FLUSH_INTERVAL_MS: "500"
      BUFFER_CAPACITY: "100000"
      TARGET_SERVICE: "tag-generator"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    group_add:
      - "${DOCKER_GROUP_ID:-984}"
    restart: unless-stopped
    stop_grace_period: 12s

  pre-processor-logs:
    build:
      context: ../rask-log-forwarder/app
      dockerfile: Dockerfile.rask-log-forwarder
    networks:
      - alt-network
    depends_on:
      rask-log-aggregator:
        condition: service_healthy
    environment:
      DOCKER_HOST: "unix:///var/run/docker.sock"
      LOG_LEVEL: "info"
      RUST_LOG: "info"
      RASK_ENDPOINT: "http://rask-log-aggregator:9600/v1/aggregate"
      BATCH_SIZE: "1000"
      FLUSH_INTERVAL_MS: "500"
      BUFFER_CAPACITY: "100000"
      TARGET_SERVICE: "pre-processor"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    group_add:
      - "${DOCKER_GROUP_ID:-984}"
    restart: unless-stopped
    stop_grace_period: 12s

  search-indexer-logs:
    build:
      context: ../rask-log-forwarder/app
      dockerfile: Dockerfile.rask-log-forwarder
    networks:
      - alt-network
    depends_on:
      rask-log-aggregator:
        condition: service_healthy
    environment:
      DOCKER_HOST: "unix:///var/run/docker.sock"
      LOG_LEVEL: "info"
      RUST_LOG: "info"
      RASK_ENDPOINT: "http://rask-log-aggregator:9600/v1/aggregate"
      BATCH_SIZE: "1000"
      FLUSH_INTERVAL_MS: "500"
      BUFFER_CAPACITY: "100000"
      TARGET_SERVICE: "search-indexer"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    group_add:
      - "${DOCKER_GROUP_ID:-984}"
    restart: unless-stopped
    stop_grace_period: 12s

  news-creator-logs:
    build:
      context: ../rask-log-forwarder/app
      dockerfile: Dockerfile.rask-log-forwarder
    networks:
      - alt-network
    depends_on:
      rask-log-aggregator:
        condition: service_healthy
    environment:
      DOCKER_HOST: "unix:///var/run/docker.sock"
      LOG_LEVEL: "info"
      RUST_LOG: "info"
      RASK_ENDPOINT: "http://rask-log-aggregator:9600/v1/aggregate"
      BATCH_SIZE: "1000"
      FLUSH_INTERVAL_MS: "500"
      BUFFER_CAPACITY: "100000"
      TARGET_SERVICE: "news-creator"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    group_add:
      - "${DOCKER_GROUP_ID:-984}"
    restart: unless-stopped
    stop_grace_period: 12s

  meilisearch-logs:
    build:
      context: ../rask-log-forwarder/app
      dockerfile: Dockerfile.rask-log-forwarder
    networks:
      - alt-network
    depends_on:
      rask-log-aggregator:
        condition: service_healthy
    environment:
      DOCKER_HOST: "unix:///var/run/docker.sock"
      LOG_LEVEL: "info"
      RUST_LOG: "info"
      RASK_ENDPOINT: "http://rask-log-aggregator:9600/v1/aggregate"
      BATCH_SIZE: "1000"
      FLUSH_INTERVAL_MS: "500"
      BUFFER_CAPACITY: "100000"
      TARGET_SERVICE: "meilisearch"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    restart: unless-stopped
    stop_grace_period: 12s

  db-logs:
    build:
      context: ../rask-log-forwarder/app
      dockerfile: Dockerfile.rask-log-forwarder
    networks:
      - alt-network
    depends_on:
      rask-log-aggregator:
        condition: service_healthy
    environment:
      DOCKER_HOST: "unix:///var/run/docker.sock"
      LOG_LEVEL: "info"
      RUST_LOG: "info"
      RASK_ENDPOINT: "http://rask-log-aggregator:9600/v1/aggregate"
      BATCH_SIZE: "1000"
      FLUSH_INTERVAL_MS: "500"
      BUFFER_CAPACITY: "100000"
      TARGET_SERVICE: "db"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    restart: unless-stopped
    stop_grace_period: 12s
