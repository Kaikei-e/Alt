# compose/perf.yaml - Performance testing service
# alt-perf: E2E performance measurement tool
#
# Usage:
#   altctl up perf
#   docker compose -f compose/base.yaml -f compose/perf.yaml run --rm alt-perf scan

include:
  - base.yaml

services:
  alt-perf:
    build:
      context: ../alt-perf
      dockerfile: Dockerfile
    env_file:
      - ../.env
    environment:
      - PERF_BASE_URL=http://nginx
      # Use Google Chrome Stable (installed via Puppeteer Docker guide)
      - DISPLAY=:99
      - CHROME_BIN=/usr/bin/google-chrome-stable
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable
    volumes:
      - ../alt-perf/reports:/app/reports
      - ../alt-perf/config:/app/config:ro
    shm_size: "2gb"
    tmpfs:
      - /tmp
    networks:
      - alt-network
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2"
    # Security options for Chromium in Docker
    security_opt:
      - seccomp:unconfined
    cap_add:
      - SYS_ADMIN
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # Don't start automatically (run manually)
    profiles:
      - perf

  k6:
    image: grafana/k6:0.55.0
    user: "0:0"
    env_file:
      - ../.env
    environment:
      - K6_BASE_URL=http://alt-backend:9000
      - K6_TEST_USER_ID=${K6_TEST_USER_ID:-}
      - K6_TEST_TENANT_ID=${K6_TEST_TENANT_ID:-}
      - K6_TEST_USER_EMAIL=${K6_TEST_USER_EMAIL:-}
    secrets:
      - auth_shared_secret
    volumes:
      - ../alt-perf/k6:/scripts:ro
      - ../alt-perf/reports:/app/reports
    networks:
      - alt-network
    depends_on:
      alt-backend:
        condition: service_healthy
    entrypoint: ["/scripts/docker-entrypoint.sh"]
    command: ["run", "/scripts/scenarios/smoke.js"]
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "2"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - perf
